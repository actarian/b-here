{"version":3,"sources":["src/js/main.js","../../src/js/environment.served.js","../../src/js/utils/utils.js","../../src/js/environment.js","../../src/js/environment.static.js","../../src/js/access/access-code.component.js","../../src/js/location/location.service.js","../../src/js/label/label.pipe.js","../../src/js/forms/controls.component.js","../../src/js/http/http.service.js","../../src/js/user/user.js","../../src/js/user/user.service.js","../../src/js/access/access.component.js","../../src/js/message/message.service.js","../../src/js/state/state.service.js","../../src/js/emittable/emittable.js","../../src/js/local-storage/local-storage.service.js","../../src/js/stream/stream.service.js","../../src/js/agora/agora.types.js","../../src/js/agora/agora.service.js","../../src/js/agora/agora-chat.component.js","../../src/js/agora/agora-check.component.js","../../src/js/device/device.service.js","../../src/js/agora/agora-checklist.component.js","../../src/js/audio/audio-stream.service.js","../../src/js/agora/agora-device-preview.component.js","../../src/js/agora/agora-device.component.js","../../src/js/agora/agora-link.component.js","../../src/js/agora/agora-login.component.js","../../src/js/agora/agora-name.component.js","../../src/js/agora/agora-stream.component.js","../../src/js/gtm/gtm.service.js","../../src/js/modal/modal.service.js","../../src/js/modal/modal-outlet.component.js","../../src/js/try-in-ar/try-in-ar-modal.component.js","../../src/js/view/view.js","../../src/js/view/view.service.js","../../src/js/world/vr.service.js","../../src/js/agora/agora.component.js","../../src/js/app.component.js","../../src/js/asset/asset.js","../../src/js/asset/asset.pipe.js","../../src/js/control-request/control-request-modal.component.js","../../src/js/drop/drop.directive.js","../../src/js/dropdown/dropdown.directive.js","../../src/js/dropdown/dropdown-item.directive.js","../../src/js/toast/toast.service.js","../../src/js/toast/toast-outlet.component.js","../../src/js/editor/aside/aside.component.js","../../src/js/asset/asset.service.js","../../src/js/editor/editor.service.js","../../src/js/editor/editor.component.js","../../src/js/editor/menu/menu.service.js","../../src/js/drop/drop.service.js","../../src/js/forms/control.component.js","../../src/js/forms/control-asset.component.js","../../src/js/forms/control-menu.component.js","../../src/js/editor/menu/menu-builder.component.js","../../src/js/editor/modals/curved-plane-modal.component.js","../../src/js/editor/modals/item-model-modal.component.js","../../src/js/editor/modals/model-modal.component.js","../../src/js/editor/modals/nav-modal.component.js","../../src/js/editor/modals/panorama-grid-modal.component.js","../../src/js/editor/modals/panorama-modal.component.js","../../src/js/editor/modals/plane-modal.component.js","../../src/js/editor/modals/remove-modal.component.js","../../src/js/editor/update/update-view-item.component.js","../../src/js/editor/update/update-view-tile.component.js","../../src/js/editor/update/update-view.component.js","../../src/js/editor/editor.module.js","../../src/js/flag/flag.pipe.js","../../src/js/upload/upload.service.js","../../src/js/forms/control-assets.component.js","../../src/js/forms/control-checkbox.component.js","../../src/js/keyboard/keyboard.service.js","../../src/js/forms/control-custom-select.component.js","../../src/js/forms/control-link.component.js","../../src/js/forms/control-localized-asset.component.js","../../src/js/forms/control-model.component.js","../../src/js/forms/control-number.component.js","../../src/js/forms/control-password.component.js","../../src/js/forms/control-select.component.js","../../src/js/forms/control-text.component.js","../../src/js/forms/control-textarea.component.js","../../src/js/forms/control-vector.component.js","../../src/js/forms/disabled.directive.js","../../src/js/forms/errors.component.js","../../src/js/forms/input-value.component.js","../../src/js/forms/test.component.js","../../src/js/forms/value.directive.js","../../src/js/html/html.pipe.js","../../src/js/id/id.directive.js","../../src/js/layout/layout.component.js","../../src/js/image/image.service.js","../../src/js/intersection/intersection.service.js","../../src/js/lazy/lazy.cache.js","../../src/js/lazy/lazy.directive.js","../../src/js/modal/modal.component.js","../../src/js/slug/slug.pipe.js","../../src/js/svg/svg-icon.structure.js","../../src/js/try-in-ar/try-in-ar.component.js","../../src/js/upload/upload-item.component.js","../../src/js/video/hls.directive.js","../../src/js/virtual/virtual.item.js","../../src/js/virtual/virtual.structure.js","../../src/js/loader/loader.service.js","../../src/js/world/envmap/envmap.loader.js","../../src/js/world/interactive/freezable.mesh.js","../../src/js/world/interactive/emittable.mesh.js","../../src/js/world/interactive/interactive.js","../../src/js/world/interactive/interactive.mesh.js","../../src/js/world/video-texture.js","../../src/js/world/panorama/panorama.js","../../src/js/rect/rect.js","../../src/js/world/avatar/avatar-element.js","../../src/js/world/camera/camera.js","../../src/js/world/media/media-loader.js","../../src/js/world/media/media-mesh.js","../../src/js/drag/drag.service.js","../../src/js/world/orbit/orbit.js","../../src/js/world/phone/phone.element.js","../../src/js/world/pointer/pointer.element.js","../../src/js/world/webxr/gamepad.js","../../src/js/world/interactive/emittable.js","../../src/js/world/webxr/motion-controllers.module.js","../../src/js/world/webxr/xr-controller-model-factory.js","../../src/js/world/world.component.js","../../src/js/world/model/model.component.js","../../src/js/world/model/model-banner.component.js","../../src/js/world/model/model-editable.component.js","../../src/js/world/model/model-curved-plane.component.js","../../src/js/world/debug.service.js","../../src/js/world/model/model-debug.component.js","../../src/js/world/model/model-grid.component.js","../../src/js/world/model/model-menu.component.js","../../src/js/world/model/model-model.component.js","../../src/js/world/model/model-nav.component.js","../../src/js/world/interactive/interactive.sprite.js","../../src/js/world/interactive/emittable.sprite.js","../../src/js/world/interactive/freezable.sprite.js","../../src/js/world/model/model-panel.component.js","../../src/js/world/model/model-picture.component.js","../../src/js/world/model/model-plane.component.js","../../src/js/world/model/model-progress.component.js","../../src/js/world/model/model-room.component.js","../../src/js/world/model/model-text.component.js","../../src/js/app.module.js","../../src/js/main.js"],"names":["g","f","exports","module","require","define","amd","globalThis","self","rxcomp","form","rxjs","operators","THREE","html2canvas","this","rxcompForm","three","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","args","arguments","apply","err","undefined","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_createClass","Constructor","protoProps","staticProps","prototype","_defineProperty","obj","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","push","_inheritsLoose","subClass","superClass","create","constructor","__proto__","_assertThisInitialized","ReferenceError","hasOwnProperty","call","Utils","merge","source","_this","forEach","Array","isArray","NODE","DEBUG","get","URLSearchParams","window","location","search","BASE_HREF","document","querySelector","getAttribute","HEROKU","host","indexOf","STATIC","port","DEVELOPMENT","split","ENV","PRODUCTION","Environment","_proto","options","url","language","market","assign","getAbsoluteUrl","path","params","origin","replace","getPath","isLocal","href","set","console","log","githubDocs","defaultAppOptions","channelName","flags","production","useProxy","useToken","selfService","guidedTourRequest","editor","ar","menu","attendee","streamer","viewer","smartDevice","maxQuality","heroku","environmentOptions","appKey","editorAssetScreen","chat","logo","background","image","video","colors","menuBackground","menuForeground","menuOverBackground","menuOverForeground","menuBackBackground","menuBackForeground","menuBackOverBackground","menuBackOverForeground","disabledViewTypes","disabledViewItemTypes","assets","worker","index","access","selfServiceTour","guidedTour","accessCode","template","tryInAr","modal","controlRequest","view","panorama","panorama-grid","room-3d","model","viewItem","nav","plane","curved-plane","texture","remove","languages","defaultLanguage","fontFamily","renderOrder","tile","banner","panel","debug","pointer","environment","bhere","_Utils$merge","LocationService","has","keyOrValue","history","pushState","title","toString","deserialize","encoded","decode","serialize","encode","decoded","json","atob","JSON","parse","stringify","btoa","AccessCodeComponent","_Component","onInit","env","link","node","getContext","QRious","element","size","Component","meta","selector","LABELS","browse","cancel","drag_and_drop_images","error_email","error_match","error_required","loading","required","select","select_file","update","upload","waiting_host","editor_image","editor_video","editor_model","editor_publisher_stream","editor_next_attendee_stream","editor_waiting_room","editor_panorama","editor_panorama_grid","editor_room_3d","editor_nav","editor_gltf","editor_plane","editor_curved_plane","editor_texture","labels","LabelPipe","_Pipe","transform","getKeys","_len","_key","map","x","join","Pipe","name","ControlsComponent","getControl","group","formGroup","control","fieldsToFormGroup","fields","FormGroup","reduce","p","c","validators","type","Validators","RequiredTrueValidator","RequiredValidator","EmailValidator","PatternValidator","pattern","FormControl","slice","unshift","id","fieldsToFormControls","inputs","hosts","FormAbstractCollectionDirective","HttpService","http$","method","data","format","response_","from","fetch","headers","Accept","Content-Type","body","response","typedResponse","contentType","text","ok","warn","pipe","catchError","throwError","getError","get$","query","delete$","post$","put$","patch$","status","statusCode","statusMessage","statusText","RoleType","Publisher","Attendee","Streamer","Viewer","SmartDevice","SelfService","User","UserService","setUser","user","user$","next","me$","mapUser","of","switchMap","login$","payload","_this2","tap","logout$","_this3","guidedTour$","_this4","selfServiceTour$","_this5","resolve$","log$","BehaviorSubject","AccessComponent","state","onSelfServiceTourRequest","initRequestForm","pushChanges","navigator","userAgent","test","onSubmit","onGuidedTourRequest","onGuidedTourAccess","first","subscribe","onLogin","initLoginForm","formSubscription","unsubscribe","roles","label","antiforgery","controls","changes$","takeUntil","unsubscribe$","changes","username","password","checkRequest","checkField","testValues","patch","reset","onBack","valid","submitted","touched","isValid","MessageService","message","message$","in","in$","sendBack","remoteId","clientId","out","out$","ReplaySubject","StateService","patchState","state$","getValue","Emittable","events","on","callback","event","off","once","emit","broadcast","callbacks","LocalStorageService","delete","isLocalStorageSupported","localStorage","removeItem","exist","e","cache","setItem","supported","StreamServiceMode","StreamService","orderedRemotes$","combineLatest","remotes$","interval","datas","orderedRemotes","remote","clientInfo","audioLevel","getAudioLevel","peekAudioLevel","Math","max","sort","a","b","role","order","min","distinctUntilChanged","uid","getEditorStreams$","mediaDevices","getUserMedia","mode","media","createElement","setAttribute","appendChild","width","height","stream","srcObject","src","URL","createObjectURL","oncanplay","fakePublisherStream","getId","fakeAttendeeStream","fakeSmartDeviceStream","editorStreams$","play","catch","shareReplay","getEditorScreens$","getDisplayMedia","screen","fakePublisherScreen","fakeAttendeeScreen","editorScreens$","getPublisherStreamId$","publisherStreamId","streams$","getRemoteById","streamId","remotes","find","remoteAdd","remoteRemove","isPlaying","stop","splice","remoteSetClientInfo","editorStreams","editorScreens","local","local$","screen$","peers","peers$","streams","publisherStream","_streams","_streams2","StreamQualities","profile","resolution","frameRate","bitrate","getStreamQuality","lowestQuality","highestQuality","AgoraStatus","MessageType","AgoraEvent","AgoraPeerEvent","_AgoraEvent","AgoraRemoteEvent","_AgoraEvent2","AgoraMuteVideoEvent","_AgoraEvent3","AgoraUnmuteVideoEvent","_AgoraEvent4","AgoraMuteAudioEvent","_AgoraEvent5","AgoraUnmuteAudioEvent","_AgoraEvent6","AgoraVolumeLevelsEvent","_AgoraEvent7","AgoraService","defaultDevices","AGORA","_Emittable","onStreamPublished","bind","onStreamUnpublished","onStreamAdded","onStreamRemoved","onStreamSubscribed","onMuteVideo","onUnmuteVideo","onMuteAudio","onUnmuteAudio","onVolumeIndicator","onPeerConnect","onPeerLeaved","onConnectionStateChange","onTokenPrivilegeWillExpire","onTokenPrivilegeDidExpire","onMessage","devices","videos","audios","quality","membersCount","getSingleton","addStreamDevice","removeStreamDevice","deviceId","kind","audio","devices$","defaultVideos","defaultAudios","getDevices","tempStream","close","device","AgoraRTC","createStream","init","connect$","preferences","connecting","setTimeout","createClient","channelNameLink","getChannelNameLink","rtcToken$","token","membersCount$","channelId","messageClient","getChannelMemberCount","counters","observeMemberCount","unobserveMemberCount","membersCountSubscription","client","Logger","setLogLevel","NONE","codec","clientInit","startProxyServer","setClientRole","onError","AgoraRTM","createInstance","logFilter","LOG_FILTER_OFF","setParameters","match","getUniqueUserId","floor","random","Date","now","channel","connected","rtmToken$","joinMessageChannel","success","autoDetectDevice","createMediaStream","login","createChannel","detectDevices","getVideoOptions","crossOrigin","hls","Hls","attachMedia","Events","MEDIA_ATTACHED","loadSource","MANIFEST_PARSED","captureStream","videoSource","getVideoTracks","cameraId","getAudioOptions","loadLevel","levels","audioSource","getAudioTracks","microphoneId","inputDevices","_this6","streamID","Boolean","all","createLocalStreamWithOptions","_this7","setVideoProfile","setVideoEncoderConfiguration","publishLocalStream","initLocalStream","_this8","publish","screenUid","unpublishLocalStream","unpublish","leaveChannel","_this9","unpublishScreenStream","leaveMessageChannel","leaveClient","leaveScreenClient","_this10","leave","stopProxyServer","_this11","logout","toggleCamera","userMuteVideo","unmuteVideo","cameraMuted","broadcastEvent","muteVideo","toggleAudio","userMuteAudio","unmuteAudio","audioMuted","muteAudio","toggleControl","_this12","sendRemoteControlDismiss","spying","sendRemoteInfoDismiss","sendRemoteControlRequest","toggleSpy","_this13","sendSpyRemoteRequestInfo","newMessageId","_this14","sendMessage","messageId","_this15","sendRemoteRequestPeerInfo","_this16","hosted","locked","sendControlRemoteRequestInfo","_this17","_this18","_this19","navToView","viewId","spyed","getSessionStats","stats","Duration","UserCount","SendBytes","RecvBytes","SendBitrate","RecvBitrate","getSystemStats","BatteryLevel","_this20","send","addOrUpdateChannelAttributes","messages","attributes","date","promise","enableNotificationToChannelMembers","getChannelAttributes","lastUpdateTs","attribute","checkBroadcastMessage","broadcastMessage","container","classList","add","peerAdd","peerRemove","peer","peerId","attr","level","renewToken","toggleScreen","_this21","screenClient","createScreenStream","createScreenClient","screenJoin","_this22","onScreenError","onScreenStreamPublished","onScreenStreamUnpublished","_this23","_this24","setScreenProfile","publishScreenStream","_this25","checkRtcConnection","checkRtcTryJoin","finally","checkRtmConnection","devices_","enumerateDevices","getTracks","track","ChatMessage","clientId_","names","shortName","substr","toUpperCase","getPayload","getCopy","AgoraChatComponent","_proto2","checkTypings","pushMessage","typingBegin","typingEnd","groupedMessages","demo","getFakeList","updateMessages","agora","onView","onChanges","createMessage","randomMessage","onClose","scrollToBottom","scrollView","scrollTop","scrollHeight","removeTyping","recursive","typings","typings_","lastMessage","typing","createRandomMessage","outputs","concat","AgoraCheckComponent","DevicePlatform","DeviceService","getDevicePlatform","vendor","opera","isIOS","isVRHeadset","platform_","platform","TIMEOUT","AgoraChecklistComponent","checklist","errors","busy","shouldCheckDevices","checkBrowser","browser","checkSystemRequirements","checkHttps","checkAudio","checkVideo","checkRtc","checkRtm","skip","https","protocol","audioinput","videoinput","rtc","rtm","onComplete","_","onNext","checked","openHttps","AudioStreamService","addSource","streamOrElement","MediaStream","sources_","context","createMediaStreamSource","clone","createMediaElementSource","removeSource","removeSourceKey","analyser","disconnect","frequency$","fftSize","Uint8Array","connect","frame$","withLatestFrom","_ref","getByteFrequencyData","finalize","volume$","volume","clipped","meter","audioMeterCreate","_ref2","checkClipping","clipLevel","averaging","clipLag","processor","createScriptProcessor","onaudioprocess","audioMeterProcess","audioMeterClip","dispose","audioMeterDispose","clipping","lastClip","destination","buffer","inputBuffer","getChannelData","bufferLength","sum","abs","performance","rms","sqrt","step$","previous","Observable","observer","requestAnimationFrame","startTime","deltaTime","frame","context_","AudioContext","analyser_","createAnalyser","expand","share","AgoraDevicePreviewComponent","initialized_","onLoadedMetadata","preview","addEventListener","hasPreview","bars","fill","bar","onDestroy","removeEventListener","initStream","video_","audio_","ideal","analyzeData","loadingStream_","frequencySubscription","frequency","pow","style","left","opacity","change","AgoraDeviceComponent","isHttps","initForm","videoOptions","audioOptions","onStreamDidChange","onStream","onEnter","enter","AgoraLinkComponent","linkAttendee","linkStreamer","linkViewer","linkSmartDevice","onGenerateMeetingId","$event","timestamp","valueOf","getRoleMeetingId","replaceRoleMeetingId","meetingId","components","padded","getRoleIndex","onInputDidChange","setRoleMeetingId","meetingIdSegments","onCopyToClipBoard","asAccessCode","input","position","top","getAccessCodeUrl","getUrl","focus","setSelectionRange","execCommand","parentNode","removeChild","alert","replaceUrl","shareable","pathname","replaceState","pageTitle","num","s","AgoraLoginComponent","friendlyMessage","firstName","lastName","AgoraNameComponent","AgoraStreamComponent","videoMuted","shouldUseResumeGesture","vrContainer","setMediaStream","mediaStream","videoNode","onToggleSpy","videoMuted_","audioMuted_","streamId_","stream_","player","childElementCount","firstElementChild","div","fit","removeAttribute","vrContainer_","videoNode_","GtmService","dataLayer","push_","ModalEvent","ModalResolveEvent","_ModalEvent","ModalRejectEvent","_ModalEvent2","ModalService","open$","getTemplate$","getNode","modal$","events$","load$","innerHTML","Subject","ModalOutletComponent","modalNode","modal_","compile","TryInARModalComponent","_getContext","parentInstance","openInAR","open","ViewType","WaitingRoom","Panorama","PanoramaGrid","Room3d","Model","ViewItemType","Nav","Plane","CurvedPlane","Texture","View","updateIndices","items","item","mapViewItem","tiles","mapViewTile","originalItems","publisherStreamIndex","attendeeStreamIndex","smartDeviceStream","publisherScreenIndex","attendeeScreenIndex","asset","file","allowedProps","substring","PanoramaView","_View","PanoramaGridView","_View2","mapTiles","flipAxes","invertAxes","folder","index_","index$","selected","navs","axes","indices","Vector2","y","parseInt","updateCurrentItems","getTileIndex","hasTile","getTile","ModelView","_View3","ViewItem","abstract","NavViewItem","_ViewItem","ViewTile","mapView","ViewService","data$","data$_","dataUrl","views","view$","initialViewId","action$_","action","keepOrientation","getWaitingRoom","hostedView$","waitingRoom","hosted$","editorView$","viewById$","viewLike$","liked","likes","setViewLike$","orientation","latitude","longitude","XRStatus","VRService","service_","state_","camera","Vector3","quaternion","Quaternion","scale","array","onSessionStarted","onSessionEnded","status$","session$","currentSession","xr","isSessionSupported","isSecureContext","getService","session","toggleVR","requestSession","optionalFeatures","end","isDisabled","getLabel","updateState","world","renderer","scene","matrixWorld","decompose","z","w","AgoraComponent","vrService","resolveUser","getLinkRole","linkRole","initWithUser","userGuard","userGuardRedirect","setNextStatus","has3D","live","initAgora","viewObserver$","onRemoteNavTo","showLove","chatDirty","onChecked","onLink","onName","sharedMeetingId","fullName","userType","onNavTo","navItem","gridIndex","toggleVolume","volumeMuted","toggleChat","onChatClose","onToggleControl","addLike","skipTimeout","uiClass","AppComponent","EXT_IMAGE","EXT_VIDEO","EXT_MODEL","AssetType","Image","Video","PublisherStream","AttendeeStream","PublisherScreen","AttendeeScreen","SmartDeviceStream","AssetGroupType","ImageOrVideo","ids","STREAM_TYPES","assetIsStream","assetGroupTypeFromItem","assetPayloadFromGroupTypeId","groupTypeId","assetTypeById","Asset","assetTypeFromPath","extension","pop","toLowerCase","fromUrl","segments","mapAsset","MIME_IMAGE","MIME_VIDEO","MIME_MODEL","MIME_STREAM","AssetPipe","RegExp","isVideo","isModel","isStream","ControlRequestModalComponent","onAccept","onReject","DropDirective","_Directive","event$","fromEvent","expression","outputFunction","makeFunction","preventDefault","Directive","DROPDOWN_ID","DropdownDirective","trigger","opened","onClick","onDocumentClick","openDropdown","closeDropdown","addListeners","dropdown$","contains","addDocumentListeners","dropped","removeDocumentListeners","removeListeners","nextId","dropdown","id_","DropdownItemDirective","ToastResolveEvent","_ToastEvent","toast","ToastService","getTime","toast$","duration","ToastOutletComponent","AsideComponent","viewTypes","disabled","viewItemTypes","setSupportedViewTypes","setSupportedViewItemTypes","supportedViewTypes","supportedViewType","supportedViewItemTypes","supportedViewItemType","setMode","viewTypeName","viewItemTypeName","onSelect","onUpdate","onDelete","AssetService","assetCreate$","assetUpdate$","assetDelete$","localizedAssetCreate$","lg","localizedAssetUpdate$","upload$","files","formData","FormData","append","xhr","XMLHttpRequest","readyState","responseText","createOrUpdateAsset$","uploads","createOrUpdateLocalizedAsset$","assetDidChange","current","previousId","previousFile","currentId","currentFile","EditorService","viewIdOptions$","viewCreate$","viewUpdate$","viewDelete$","inferItemCreate$","tileItemCreate$","itemCreate$","inferItemUpdate$","tileItemUpdate$","itemUpdate$","inferItemDelete$","tileItemDelete$","itemDelete$","inferItemUpdateResult$","currentItem","inferItemDeleteResult$","EditorComponent","aside","settings","viewHit","initState","delay","onRemoteControlRequest","onToggleAside","dispatchEvent","Event","onToggleSettings","onViewHit","onViewHitted","viewHitSubscription","onDragEnd","onResizeEnd","onWorldSelect","selectedItem","showPanel","onOpenModal","onAsideSelect","currentTile","onAsideUpdate","onUpdateAsset","onAsideDelete","MENU_UID","MenuService","menu$","getMenu$","menu$_","updateMenu$","createMenuItem$","parentId","updateMenuItem$","deleteMenuItem$","getModelMenu$","mapMenuItems","hidden","typeName","mapMenuItem","active","active$","DropService","drop$","isPlatformBrowser","dataTransfer","EMPTY","change$","asset$","previews","uploads$","read$","reader","FileReader","reader$","blob","result","resize$","resized","readAsDataURL","resize_","img","onload","canvas","ctx","drawImage","toDataURL","onerror","ControlComponent","ControlAssetComponent","_ControlComponent","accept","ControlMenuComponent","_ControlAssetComponen","itemToFormGroup","FormArray","dropdownId","onAddItem","onRemoveItem","onRemoveControl","onLinkItem","onLinkControl","onItemUp","up","onItemDown","down","onUpControl","insert","onDownControl","setView","switchSubjects_","onTextDidChange","hasOption","onDropped","MenuBuilderComponent","menuToControls","controlsToMenu","subitems","pushItem","menuItem","CurvedPlaneModalComponent","Object3D","copy","lookAt","ORIGIN","multiplyScalar","toArray","rotation","radius","arc","ItemModelModalComponent","ModelModalComponent","values","zoom","NavModalComponent","PanoramaGridModalComponent","PanoramaModalComponent","PlaneModalComponent","RemoveModalComponent","onRemove","onCancel","UpdateViewItemComponent","originalItem","hasChromaKeyColor","chromaKeyColor","assetType","doUpdateForm","doUpdateItem","getAssetDidChange","itemHasChromaKeyColor","changesHasChromaKeyColor","removeKey","optional","onAssetTypeDidChange","currentType","getTitle","UpdateViewTileComponent","UpdateViewComponent","doUpdateView","orbit$","auditTime","didChange","usdzDidChange","usdz","gltfDidChange","gltf","factories","pipes","EditorModule","_Module","Module","imports","declarations","FlagPipe","UploadItem","progress","uploading","paused","complete","UploadEvent","UploadStartEvent","_UploadEvent","UploadCompleteEvent","_UploadEvent2","UploadAssetEvent","_UploadEvent3","UploadService","concurrent$","items$","uploadItems","uploadItem$","delayWhen","addItems","newItems","removeAll","dropArea","files$","file$","uploadFile$","resize","ControlAssetsComponent","multiple","hasFiles","service","onUpload","onItemPause","onItemResume","onItemCancel","onItemRemove","items_","uploadCount","completed","ControlCheckboxComponent","KeyboardService","keydown$","keydown$_","keyup$","keyup$_","keys$","keys$_","startWith","key$","key$_","regexp","typing$","typing$_","to","clearTimeout","ControlCustomSelectComponent","word","scrollToWord","children","scrollTo","offsetTop","setOption","isMultiple","Error","_readOnlyError","v","ControlLinkComponent","onInputDidBlur","ControlLocalizedAssetComponent","currentLanguage","setLanguage","locale","localizedAsset","ControlModelComponent","ControlNumberComponent","precision","increment","updateValue","ControlPasswordComponent","ControlSelectComponent","ControlTextComponent","ControlTextareaComponent","ControlVectorComponent","DisabledDirective","ErrorsComponent","InputValueComponent","increment$","parseFloat","NaN","sign","m","race","toFixed","setValue","TestComponent","onTest","onReset","ValueDirective","HtmlPipe","n","String","fromCharCode","unescapes","rx","IdDirective","LayoutComponent","UID","ImageServiceEvent","ImageService","worker_","Worker","isBlob","isCors","postMessage","Blob","takeWhile","IntersectionService","observer_","readySubject_","observerSubject_","IntersectionObserver","entries","intersection$","observe","entry","isIntersecting","unobserve","LazyCache","cache_","LazyDirective","input$","lazy$","lazy","ModalComponent","SlugPipe","SvgIconStructure","_Structure","name_","_element$classList","createElementNS","h","setAttributeNS","rxcompId","replaceChild","Structure","TryInARComponent","missingAr","missingUsdz","missingGltf","getViewId","usdzSrc","getUsdzSrc","getGltfSrc","modelViewerNode","getModelViewerNode","gltfSrc","UploadItemComponent","onPause","pause","onResume","resume","HlsDirective","isSupported","hls_","VirtualItem","$key","$value","count","_Context","even","Context","VirtualMode","VirtualStructure","tokens","getExpressionTokens","virtualFunction","iterable","gutter","reverse","containerWidth","containerHeight","cols","cachedRects","cachedInstances","cacheNodes","update$","visibleItems","updateView","scroll$","updateForward","total","highestHeight","getWidth","getGutter","len","col","bottom","rect","getCol","getHeight","intersect","getLeft","cachedNode","offsetHeight","removeNode","removeIndex","parentContainer","diff","getCols","updateNode","createNode","clonedNode","cloneNode","instance","makeInstance","forItemContext","top1","bottom1","top2","bottom2","getComputedStyle","overflowY","getBoundingClientRect","trim","expressions","virtualExpressions","keyValueMatches","indexExpressions","LOADER_UID","LoaderService","switchLoaders","progress$","getRef","ref","loaded","setProgress","switchAll","subject","round","EnvMapLoader","load","loadPublisherStreamBackground","loadVideoBackground","loadHlslVideoBackground","loadRgbeBackground","loadBackgroundImageService","loadBackground","pmremGenerator","PMREMGenerator","compileEquirectangularShader","progressRef","loader","TextureLoader","setPath","envMap","fromEquirectangular","request","revokeObjectURL","RGBELoader","setDataType","UnsignedByteType","VideoTexture","minFilter","LinearFilter","magFilter","mapping","UVMapping","RGBFormat","needsUpdate","cubeRenderTarget","WebGLCubeRenderTarget","generateMipmaps","fromEquirectangularTexture","onPlaying","HAVE_FUTURE_DATA","onPublisherStreamId","muted","loop","playsInline","muted_","cubeRenderTarget_","texture_","FreezableMesh","geometry","material","BoxBufferGeometry","MeshBasicMaterial","color","_THREE$Mesh","freezed","freezed_","__lookupGetter__","freeze","unfreeze","Mesh","EmittableMesh","_FreezableMesh","Interactive","hittest","raycaster","dirty","lock","hit","intersections","intersectObjects","hash","intersection","uuid","lastIntersectedObject","point","over","depthTest","InteractiveMesh","_EmittableMesh","over_","down_","wrapS","wrapT","anisotropy","isVideoTexture","HAVE_CURRENT_DATA","subscription","tween","SphereBufferGeometry","rotateY","PI","ShaderMaterial","depthWrite","vertexShader","fragmentShader","uniforms","rgbe","mesh","onexit","crossfade","currentAsset","loadVideo","setVideo","Rect","right","intersectRect","r1","r2","fromNode","rect_","getClientRects","boundingRect","setCenter","setSize","center","intersection_","offset","scroll","COLORS","AvatarElement","WebGLRenderer","antialias","alpha","premultipliedAlpha","setClearColor","setPixelRatio","devicePixelRatio","toneMapping","ACESFilmicToneMapping","toneMappingExposure","outputEncoding","sRGBEncoding","domElement","PerspectiveCamera","Scene","light","PointLight","head","addHead","headGeometry_","headGeometry","CanvasTexture","MeshStandardMaterial","chalk","render","tick_","vol","sin","smile","cos","fillStyle","fillRect","beginPath","closePath","moveTo","bezierCurveTo","Camera","fov","aspect","near","far","dolly","_THREE$PerspectiveCam","box","Group","MediaLoaderEvent","MediaLoaderPlayEvent","_MediaLoaderEvent","MediaLoaderPauseEvent","_MediaLoaderEvent2","MediaLoader","toggle","getLoader","loadTexture","isPublisherStream","isAttendeeStream","isSmartDeviceStream","isPublisherScreen","isAttendeeScreen","autoplay","onCanPlay","preload","RepeatWrapping","silent","upEvent","VERTEX_SHADER","FRAGMENT_CHROMA_KEY_SHADER","MediaMesh","getMaterialByItem","_InteractiveMesh","getUniformsByItem","mediaLoader","getMaterial","useChromaKey","transparent","textureA","textureB","resolutionA","resolutionB","overlayColor","Color","overlay","getChromaKeyMaterial","side","DoubleSide","getTypeMatcher","matcher","getStreamId$","matchType","onAppear","videoWidth","videoHeight","isPlayableVideo","createTextureB","onOver","onOut","onToggle","aw","ah","imageSmoothingEnabled","imageSmoothingQuality","br","linkedPlayId","gsap","ease","Power2","easeInOut","onDisappear","playing","overwrite","setPlayingState","updateByItem","disposeMaterial","disposeMediaLoader","disposable","DragPoint","DragEvent","DragDownEvent","_DragEvent","distance","strength","speed","DragMoveEvent","_DragEvent2","DragUpEvent","_DragEvent3","DragService","getPosition","MouseEvent","clientX","clientY","TouchEvent","touches","pageX","pageY","down$","downEvent","button","originalEvent","move$","dismiss$","moveEvent","innerWidth","innerHeight","dismissEvent","stopImmediatePropagation","up$","observe$","OrbitMode","OrbitEvent","OrbitDragEvent","_OrbitEvent","OrbitResizeEvent","_OrbitEvent2","OrbitMoveEvent","_OrbitEvent3","orbitMoveEvent","orbitDragEvent","orbitResizeEvent","OrbitService","mode_","dolly_","zoom_","direction","inertia","Euler","updatePosition","updateTarget","setLongitudeLatitude","getDollyValue","getZoomValue","clampedDolly","clamp","setOrientation","getOrientation","phi","degToRad","theta","Shift","Control","flip","MathUtils","updateProjectionMatrix","walk","heading","normalize","headingTheta","atan2","headingLongitude","radToDeg","differenceLongitude","differenceLatitude","walkComplete","headingLatitude","object3d","acos","setVRCamera","applyQuaternion","R","PhoneStreamElement","setRemote","r","sx","sy","ceil","addStreamTexture","PlaneBufferGeometry","PhoneElement","phone","PointerElement","setPosition","Gamepad","gamepad","buttons","updateButtons","updateAxes","pressed","GamepadButton","axis","GamepadAxis","feedback","actuators","hapticActuators","pulse","_THREE$Vector","Constants","Handedness","LEFT","RIGHT","ComponentState","DEFAULT","TOUCHED","PRESSED","ComponentProperty","BUTTON","X_AXIS","Y_AXIS","STATE","ComponentType","TRIGGER","SQUEEZE","TOUCHPAD","THUMBSTICK","ButtonTouchThreshold","AxisTouchThreshold","VisualResponseProperty","TRANSFORM","VISIBILITY","fetchJsonFile","_fetchJsonFile","regeneratorRuntime","mark","_callee","wrap","_context","prev","sent","abrupt","fetchProfilesList","_fetchProfilesList","_callee2","basePath","profilesList","_context2","_fetchProfile","_callee3","xrInputSource","defaultProfile","getAssetPath","supportedProfilesList","supportedProfile","assetPath","layout","_context3","profiles","some","profileId","profilePath","deprecated","handedness","layouts","defaultComponentValues","xAxis","yAxis","VisualResponse","visualResponseDescription","componentProperty","states","valueNodeName","valueNodeProperty","minNodeName","maxNodeName","updateFromComponent","_normalizeAxes","normalizedXAxis","normalizedYAxis","normalizeAxes","includes","componentId","componentDescription","visualResponses","gamepadIndices","rootNodeName","touchPointNodeName","responseName","visualResponse","updateFromGamepad","gamepadButton","getOwnPropertyDescriptors","defineProperties","_objectSpread2","MotionController","assetUrl","layoutDescription","component","gripSpace","targetRaySpace","XRControllerModel","motionController","addAssetSceneToControllerModel","controllerModel","MotionControllerConstants","touchPointNode","getObjectByName","sphereGeometry","sphere","minNode","maxNode","valueNode","findNodes","traverse","child","isMesh","setEnvironmentMap","updateMatrixWorld","force","visible","slerp","lerpVectors","XRControllerModelFactory","gltfLoader","_assetCache","GLTFLoader","createControllerModel","controller","targetRayMode","fetchProfile","cachedAsset","WorldComponent","error_","waiting","avatars","createScene","animate","orbit","setAnimationLoop","mouse","controllerMatrix_","Matrix4","controllerWorldPosition_","controllerWorldDirection_","cameraGroup","worldRect","cameraRect","offsetWidth","logarithmicDepthBuffer","enabled","insertBefore","Raycaster","setFromCamera","objects","indicator","mainLight","light2","DirectionalLight","AmbientLight","addControllers","addOffCanvasScene","avatar","removeOffCanvasScene","updateOffCanvasScene","view_","requestInfoResult","ready","onViewAssetDidChange","setViewOrientation","isPresenting","controllerGroup","controllers","controllerModelFactory","addController","showPhone","getController","onPress","onRelease","onModelUp","onLeft","onRight","onAxis","onModelDistance","userData","isSelecting","setController","buildController","controllerGrip","getControllerGrip","BufferGeometry","Float32BufferAttribute","LineBasicMaterial","vertexColors","blending","AdditiveBlending","Line","RingBufferGeometry","translate","onModelDown","tempTarget","tempParent","parent","localToWorld","worldToLocal","distanceTo","onTween","updateRaycasterXR","identity","extractRotation","ray","setFromMatrixPosition","applyMatrix4","raycasterHitTest","dragItem","resizeItem","repos","tx","ty","delta","time","tick","raycasterXRHitTest","ticker","angle","tan","updateRaycasterMouse","w2","h2","onMouseDown","raycasterDesktopHitTest","lockedOrXR","onDragMove","onResizeMove","controlEvent$","onMouseMove","onMouseUp","dragEnd","resizeEnd","onMouseWheel","deltaY","wheelDeltaY","Power4","easeOut","onOrientationDidChange","onVRStarted","onVREnded","onVRStateDidChange","onMenuNav","navTo","onMenuToggle","onNavOver","shouldShowPanel","itemId","onNavOut","onNavDown","onObjectDown","onPlayMedia","onPanelDown","onGridMove","onGridNav","control$","setSession","removeMenu","showPointer","GEOMETRY","ModelComponent","getName","getContainer","onCreate","onMount","onDismount","disposeObject","mounth","dismount","roughness","metalness","flatShading","isInteractiveMesh","isInteractiveSprite","isSprite","calculateScaleAndPosition","getScroll","getTween","PANEL_RADIUS","PANORAMA_RADIUS","ModelBannerComponent","_ModelComponent","createBanner","getCanvasTexture","wrapY","repeat","encoding","CylinderBufferGeometry","banners","updateBanner","mount","W","H","F","L","font","measureText","clearRect","textAlign","textBaseline","strokeStyle","lineWidth","lineJoin","miterLimit","strokeText","fillText","title_","ModelEditableComponent","RADIUS","editing","setHelper","showHelper","helper","BoxHelper","updateHelper","setFromObject","editing_","ModelCurvedPlaneComponent","_ModelEditableCompone","getCurvedPanelGeometry","fromArray","radius_","height_","arc_","take","textures","DebugService","setMessage","ModelDebugComponent","FontLoader","getFontLoader","fontLoader","textGroup","debugService","createText","loadFont","message_","setText","getCamera","getWorldDirection","ModelGridComponent","getTexture","getOverTexture","textureOver","getCoords","outerTileSize","row","dx","COLS","dy","ROWS","ci","ri","moveToIndex","addTiles","innerTileSize","rotateX","mapOver","tileMap","showTiles","ix","iy","addHitArea","onGroundOver","onGroundMove","onGroundDown","onGroundOut","ground","coords","move","coords_","previousTile","previousUniforms","currentUniforms","MenuButton","getTextureA","getTextureB","getX","getY","getGrid","G","rows","geometry_","ModelMenuComponent","FRAGMENT_SHADER","BackButton","_MenuButton","_proto3","onDown","buildMenu","groups","menuGroup","addMenu","back","backItem","stagger","grid","amount","removeButtons","removeToggler","addToggler","toggler","loading_","ModelModelComponent","loadGlb","animations","onGlbLoaded","decoderPath","dracoLoader","DRACOLoader","setDecoderPath","setDRACOLoader","glb","progressEvent","parseAnimations","actionIndex","actions","clock","Clock","mixer","AnimationMixer","timeScale","animation","clipAction","setEffectiveTimeScale","setEffectiveWeight","setLoop","LoopRepeat","onClipToggle","halt","dummy","Box3","sub","getCenter","endY","makeInteractive","getDelta","getInteractiveDescriptors","descriptors","interactiveDescriptors","freezableDescriptors","emittableDescriptors","NavModeType","ModelNavComponent","getNavGeometry","navGeometry","getTexturePoint","texturePoint","getTextureMove","textureMove","getTextureInfo","textureInfo","getTitleTexture","getNavMode","isValidText","onCreateSprites","icon","materials","onRemoveSprite","titleMaterial","SpriteMaterial","sizeAttenuation","Sprite","titleTexture","sprite","_THREE$Vector2","InteractiveSprite","_EmittableSprite","EmittableSprite","_FreezableSprite","FreezableSprite","_THREE$Sprite","ModelPanelComponent","viewed","xy","uv","querySelectorAll","offsetLeft","movementX","movementY","relatedTarget","screenX","screenY","imagesLoaded","promises","cors","onLoad","panelTexture","results","useCORS","backgroundColor","ModelPictureComponent","ModelPlaneComponent","LOADING_BANNER","WAITING_BANNER","ModelProgressComponent","visible_","createMesh","show","hide","updateProgress","ModelRoomComponent","loadModel","modelFolder","modelFile","FBXLoader","setHex","radians","lengthComputable","ModelTextComponent","AppModule","CoreModule","FormModule","bootstrap","Browser"],"mappings":"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","file":"docs\\js\\main.min.js","sourcesContent":[null,"\r\nexport const environmentServed = {\r\n\tappKey: '8b0cae93d47a44e48e97e7fd0404be4e',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: true,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: false,\r\n\t\teditorAssetScreen: false,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tchat: false,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t},\r\n\tlogo: null,\r\n\tbackground: {\r\n\t\timage: '/Modules/B-Here/Client/docs/img/background.jpg',\r\n\t\tvideo: '/Modules/B-Here/Client/docs/img/background.mp4',\r\n\t},\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/Modules/B-Here/Client/docs/',\r\n\tworker: '/Modules/B-Here/Client/docs/js/workers/image.service.worker.js',\r\n\tgithubDocs: 'https://raw.githubusercontent.com/actarian/b-here/b-here-ws-new/docs/',\r\n\tlanguage: '/it',\r\n\tmarket: '/it',\r\n\turl: {\r\n\t\tindex: '/',\r\n\t\taccess: '/',\r\n\t\teditor: '/editor',\r\n\t\tselfServiceTour: '/self-service-tour',\r\n\t\tguidedTour: '/guided-tour',\r\n\t\taccessCode: '/access-code',\r\n\t},\r\n\ttemplate: {\r\n\t\ttryInAr: '/template/modules/b-here/try-in-ar.cshtml?viewId=$viewId',\r\n\t\tmodal: {\r\n\t\t\tcontrolRequest: '/template/modules/b-here/control-request-modal.cshtml',\r\n\t\t\ttryInAr: '/template/modules/b-here/try-in-ar-modal.cshtml',\r\n\t\t\tview: {\r\n\t\t\t\t'panorama': '/template/modules/b-here/panorama-modal.cshtml',\r\n\t\t\t\t'panorama-grid': '/template/modules/b-here/panorama-grid-modal.cshtml',\r\n\t\t\t\t'room-3d': '/template/modules/b-here/room-3d-modal.cshtml',\r\n\t\t\t\t'model': '/template/modules/b-here/model-modal.cshtml',\r\n\t\t\t},\r\n\t\t\tviewItem: {\r\n\t\t\t\t'nav': '/template/modules/b-here/nav-modal.cshtml',\r\n\t\t\t\t'plane': '/template/modules/b-here/plane-modal.cshtml',\r\n\t\t\t\t'curved-plane': '/template/modules/b-here/curved-plane-modal.cshtml',\r\n\t\t\t\t'texture': '/template/modules/b-here/texture-modal.cshtml',\r\n\t\t\t\t'model': '/template/modules/b-here/item-model-modal.cshtml',\r\n\t\t\t},\r\n\t\t\tremove: '/template/modules/b-here/remove-modal.cshtml',\r\n\t\t}\r\n\t},\r\n\tlanguages: ['en'],\r\n\tdefaultLanguage: 'en',\r\n};\r\n","\r\nexport class Utils {\r\n\r\n\tstatic merge(target, source) {\r\n\t\tif (typeof source === 'object') {\r\n\t\t\tObject.keys(source).forEach(key => {\r\n\t\t\t\tconst value = source[key];\r\n\t\t\t\tif (typeof value === 'object' && !Array.isArray(value)) {\r\n\t\t\t\t\ttarget[key] = this.merge(target[key], value);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttarget[key] = value;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn target;\r\n\t}\r\n\r\n}\r\n","import { environmentServed } from './environment.served';\r\nimport { environmentStatic } from './environment.static';\r\nimport { Utils } from './utils/utils';\r\n\r\nexport const NODE = (typeof module !== 'undefined' && module.exports);\r\nexport const PARAMS = NODE ? { get: () => { } } : new URLSearchParams(window.location.search);\r\nexport const DEBUG = false || (PARAMS.get('debug') != null);\r\nexport const BASE_HREF = NODE ? null : document.querySelector('base').getAttribute('href');\r\nexport const HEROKU = NODE ? false : (window && window.location.host.indexOf('herokuapp') !== -1);\r\nexport const STATIC = NODE ? false : (HEROKU || (window && (window.location.port === '41789' || window.location.port === '5000' || window.location.port === '6443' || window.location.host === 'actarian.github.io')));\r\nexport const DEVELOPMENT = NODE ? false : (window && ['localhost', '127.0.0.1', '0.0.0.0'].indexOf(window.location.host.split(':')[0]) !== -1);\r\nexport const PRODUCTION = !DEVELOPMENT;\r\nexport const ENV = {\r\n\tSTATIC,\r\n\tDEVELOPMENT,\r\n\tPRODUCTION\r\n};\r\n\r\nexport class Environment {\r\n\r\n\tget STATIC() {\r\n\t\treturn ENV.STATIC;\r\n\t}\r\n\tset STATIC(STATIC) {\r\n\t\tENV.STATIC = (STATIC === true || STATIC === 'true');\r\n\t\tconsole.log('Environment.STATIC.set', ENV.STATIC);\r\n\t}\r\n\r\n\tget href() {\r\n\t\tif (HEROKU) {\r\n\t\t\treturn this.githubDocs;\r\n\t\t} else {\r\n\t\t\treturn BASE_HREF;\r\n\t\t}\r\n\t}\r\n\r\n\tgetAbsoluteUrl(path, params) {\r\n\t\tlet url = `${window.location.origin}${path}`;\r\n\t\t// let url = `${window.location.protocol}//${window.location.host}${path}`;\r\n\t\tObject.keys(params).forEach(key => {\r\n\t\t\turl = url.replace(`$${key}`, params[key]);\r\n\t\t});\r\n\t\treturn url;\r\n\t}\r\n\r\n\tgetPath(path) {\r\n\t\treturn this.isLocal(path) ? (this.href + path) : path;\r\n\t}\r\n\r\n\tisLocal(path) {\r\n\t\treturn path.indexOf('://') === -1;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tif (typeof options.url === 'object') {\r\n\t\t\t\tconst language = options.language || '';\r\n\t\t\t\tconst market = options.market || '';\r\n\t\t\t\tObject.keys(options.url).forEach(key => {\r\n\t\t\t\t\toptions.url[key] = language + market + options.url[key];\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst defaultOptions = {\r\n\tport: 5000,\r\n\tfontFamily: 'GT Walsheim, sans-serif',\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\trenderOrder: {\r\n\t\tpanorama: 0,\r\n\t\tmodel: 10,\r\n\t\tplane: 20,\r\n\t\ttile: 30,\r\n\t\tbanner: 40,\r\n\t\tnav: 50,\r\n\t\tpanel: 60,\r\n\t\tmenu: 70,\r\n\t\tdebug: 80,\r\n\t\tpointer: 90,\r\n\t}\r\n};\r\n\r\nconst defaultAppOptions = {\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: false,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: true,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t\theroku: HEROKU,\r\n\t},\r\n};\r\n\r\nconst environmentOptions = window.STATIC ? environmentStatic : environmentServed;\r\n\r\nlet options = Object.assign(defaultOptions, defaultAppOptions, environmentOptions);\r\noptions = Utils.merge(options, window.bhere);\r\n\r\nexport const environment = new Environment(options);\r\n\r\nconsole.log('environment', environment);\r\n","\r\nexport const environmentStatic = {\r\n\tappKey: '8b0cae93d47a44e48e97e7fd0404be4e',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: false,\r\n\t\tuseProxy: true,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: true,\r\n\t\teditorAssetScreen: true,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tchat: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t},\r\n\tlogo: null,\r\n\tbackground: {\r\n\t\timage: '/b-here/img/background.jpg',\r\n\t\tvideo: '/b-here/img/background.mp4',\r\n\t},\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/b-here/',\r\n\tworker: './js/workers/image.service.worker.js',\r\n\tgithubDocs: 'https://raw.githubusercontent.com/actarian/b-here/b-here-ws-new/docs/',\r\n\tlanguage: '',\r\n\tmarket: '',\r\n\turl: {\r\n\t\tindex: '/',\r\n\t\taccess: '/',\r\n\t\teditor: '/editor',\r\n\t\tselfServiceTour: '/self-service-tour',\r\n\t\tguidedTour: '/guided-tour',\r\n\t\taccessCode: '/access-code',\r\n\t},\r\n\ttemplate: {\r\n\t\ttryInAr: '/try-in-ar.html?viewId=$viewId',\r\n\t\tmodal: {\r\n\t\t\tcontrolRequest: '/control-request-modal.html',\r\n\t\t\ttryInAr: '/try-in-ar-modal.html',\r\n\t\t\tview: {\r\n\t\t\t\t'panorama': '/panorama-modal.html',\r\n\t\t\t\t'panorama-grid': '/panorama-grid-modal.html',\r\n\t\t\t\t'room-3d': '/room-3d-modal.html',\r\n\t\t\t\t'model': '/model-modal.html',\r\n\t\t\t},\r\n\t\t\tviewItem: {\r\n\t\t\t\t'nav': '/nav-modal.html',\r\n\t\t\t\t'plane': '/plane-modal.html',\r\n\t\t\t\t'curved-plane': '/curved-plane-modal.html',\r\n\t\t\t\t'texture': '/texture-modal.html',\r\n\t\t\t\t'model': '/item-model-modal.html',\r\n\t\t\t},\r\n\t\t\tremove: '/remove-modal.html',\r\n\t\t}\r\n\t},\r\n\tlanguages: ['en'],\r\n\tdefaultLanguage: 'en',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\n\r\nexport default class AccessCodeComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tconst link = LocationService.get('link');\r\n\t\tif (!link) {\r\n\t\t\twindow.location.href = `${window.location.origin}${environment.url.guidedTour}`;\r\n\t\t}\r\n\t\tconst url = `${window.location.origin}${environment.url.guidedTour}?link=${link}`;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst qrcode = new QRious({\r\n\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\tvalue: url,\r\n\t\t\tsize: 256\r\n\t\t});\r\n\t}\r\n}\r\n\r\nAccessCodeComponent.meta = {\r\n\tselector: '[access-code-component]',\r\n};\r\n","export default class LocationService {\r\n\r\n\tstatic has(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.has', params);\r\n\t\treturn params.has(key);\r\n\t}\r\n\r\n\tstatic get(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.get', params);\r\n\t\treturn params.get(key);\r\n\t}\r\n\r\n\tstatic set(keyOrValue, value) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams.set(keyOrValue, value);\r\n\t\t} else {\r\n\t\t\tparams.set(keyOrValue, '');\r\n\t\t}\r\n\t\tthis.replace(params);\r\n\t\t// console.log('LocationService.set', params, keyOrValue, value);\r\n\t}\r\n\r\n\tstatic replace(params) {\r\n\t\tif (window.history && window.history.pushState) {\r\n\t\t\tconst title = document.title;\r\n\t\t\tconst url = `${window.location.href.split('?')[0]}?${params.toString()}`;\r\n\t\t\twindow.history.pushState(params.toString(), title, url);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic deserialize(key) {\r\n\t\tconst encoded = this.get('params');\r\n\t\treturn this.decode(key, encoded);\r\n\t}\r\n\r\n\tstatic serialize(keyOrValue, value) {\r\n\t\tconst params = this.deserialize();\r\n\t\tconst encoded = this.encode(keyOrValue, value, params);\r\n\t\tthis.set('params', encoded);\r\n\t}\r\n\r\n\tstatic decode(key, encoded) {\r\n\t\tlet decoded = null;\r\n\t\tif (encoded) {\r\n\t\t\tconst json = window.atob(encoded);\r\n\t\t\tdecoded = JSON.parse(json);\r\n\t\t}\r\n\t\tif (key && decoded) {\r\n\t\t\tdecoded = decoded[key];\r\n\t\t}\r\n\t\treturn decoded || null;\r\n\t}\r\n\r\n\tstatic encode(keyOrValue, value, params) {\r\n\t\tparams = params || {};\r\n\t\tlet encoded = null;\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams[keyOrValue] = value;\r\n\t\t} else {\r\n\t\t\tparams = keyOrValue;\r\n\t\t}\r\n\t\tconst json = JSON.stringify(params);\r\n\t\tencoded = window.btoa(json);\r\n\t\treturn encoded;\r\n\t}\r\n\r\n}\r\n","import { Pipe } from \"rxcomp\";\r\nimport { Utils } from \"../utils/utils\";\r\n\r\nexport const LABELS = Utils.merge({\r\n\tbrowse: 'Browse',\r\n\tcancel: 'Cancel',\r\n\tdrag_and_drop_images: 'Drag And Drop your images here',\r\n\terror_email: 'Invalid email',\r\n\terror_match: 'Fields do not match',\r\n\terror_required: 'Field is required',\r\n\tloading: 'loading',\r\n\tremove: 'Remove',\r\n\trequired: 'Required',\r\n\tselect: 'Select',\r\n\tselect_file: 'Select a file...',\r\n\tupdate: 'Update',\r\n\tupload: 'Upload',\r\n\twaiting_host: 'waiting host',\r\n\t// editor\r\n\teditor_image: 'Image',\r\n\teditor_video: 'Video',\r\n\teditor_model: 'Model',\r\n\teditor_publisher_stream: 'Publisher Stream',\r\n\teditor_next_attendee_stream: 'Next Attendee Stream',\r\n\teditor_waiting_room: 'Waiting Room',\r\n\teditor_panorama: 'Panorama',\r\n\teditor_panorama_grid: 'Panorama Grid',\r\n\teditor_room_3d: 'Room 3D',\r\n\teditor_model: 'Model',\r\n\teditor_nav: 'Nav Tooltip',\r\n\teditor_gltf: 'Gltf Model',\r\n\teditor_plane: 'Plane',\r\n\teditor_curved_plane: 'Curved Plane',\r\n\teditor_texture: 'Texture',\r\n}, window.labels);\r\n\r\nexport default class LabelPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst labels = LABELS;\r\n\t\treturn labels[key] || `#${key}#`;\r\n\t}\r\n\r\n\tstatic getKeys(...keys) {\r\n\t\treturn this.transform(keys.map(x => x.replace('-','_')).join('_'));\r\n\t}\r\n}\r\n\r\nLabelPipe.meta = {\r\n\tname: 'label',\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormAbstractCollectionDirective, FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport LabelPipe from '../label/label.pipe';\r\n\r\nexport default class ControlsComponent extends Component {\r\n\r\n\tget group() {\r\n\t\tif (this.formGroup) {\r\n\t\t\treturn this.formGroup;\r\n\t\t} else {\r\n\t\t\tif (!this.host) {\r\n\t\t\t\tthrow ('missing form collection');\r\n\t\t\t}\r\n\t\t\treturn this.host.control;\r\n\t\t}\r\n\t}\r\n\r\n\tgetControl(name) {\r\n\t\treturn this.group.get(name);\r\n\t}\r\n}\r\n\r\nControlsComponent.meta = {\r\n\tselector: '[controls]',\r\n\tinputs: ['formGroup', 'fields'],\r\n\thosts: { host: FormAbstractCollectionDirective },\r\n\ttemplate: /* html */`\r\n\t\t<div *for=\"let field of fields\">\r\n\t\t\t<div *if=\"['text', 'email', 'url'].indexOf(field.type) !== -1\" control-text [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'select'\" control-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'custom-select'\" control-custom-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'textarea'\" control-textarea [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'checkbox'\" control-checkbox [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<input *if=\"field.type == 'hidden'\" [name]=\"field.name\" [formControl]=\"getControl(field.name)\" value=\"\" type=\"text\" style=\"display:none !important;\" />\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nexport function fieldsToFormControls(fields) {\r\n\tconst controls = fields.reduce((p, c, i) => {\r\n\t\tconst validators = [];\r\n\t\tif (c.required) {\r\n\t\t\tvalidators.push(c.type === 'checkbox' ? Validators.RequiredTrueValidator() : Validators.RequiredValidator());\r\n\t\t}\r\n\t\tif (c.type === 'email') {\r\n\t\t\tvalidators.push(Validators.EmailValidator());\r\n\t\t}\r\n\t\tif (c.type === 'url') {\r\n\t\t\tvalidators.push(Validators.PatternValidator('(https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|www\\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9]+\\.[^\\s]{2,}|www\\.[a-zA-Z0-9]+\\.[^\\s]{2,})'));\r\n\t\t}\r\n\t\tif (c.pattern != null) {\r\n\t\t\tvalidators.push(Validators.PatternValidator(c.pattern));\r\n\t\t}\r\n\t\tp[c.name] = new FormControl((c.value != null ? c.value : null), validators);\r\n\t\tif (c.type === 'select' || c.type === 'custom-select') {\r\n\t\t\tconst options = (c.options || []).slice();\r\n\t\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\t\tp[c.name].options = options;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\treturn controls;\r\n}\r\n\r\nexport function fieldsToFormGroup(fields) {\r\n\treturn new FormGroup(fieldsToFormControls(fields));\r\n}\r\n\r\nexport function patchFields(fields, form) {\r\n\tconst testValues = fields.reduce((p, c, i) => {\r\n\t\tif (c.test) {\r\n\t\t\tp[c.name] = c.test;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\tform.patch(testValues);\r\n}\r\n","import { from, throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nexport class HttpResponse {\r\n\r\n\tget static() {\r\n\t\treturn this.url.indexOf('.json') === this.url.length - 5;\r\n\t}\r\n\r\n\tconstructor(response) {\r\n\t\tthis.data = null;\r\n\t\tif (response) {\r\n\t\t\tthis.url = response.url;\r\n\t\t\tthis.status = response.status;\r\n\t\t\tthis.statusText = response.statusText;\r\n\t\t\tthis.ok = response.ok;\r\n\t\t\tthis.redirected = response.redirected;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default class HttpService {\r\n\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tlet response_ = null;\r\n\t\t// url = this.getUrl(url, format);\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: methods.indexOf(method) !== -1 ? JSON.stringify(data) : undefined\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = response;\r\n\t\t\t// console.log(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\treturn typedResponse;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\t\treturn Promise.reject(data);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} catch(error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve();\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(error);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\t// !!! todo mapping response.data\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tconst body = (data && methods.indexOf(method) !== -1) ? JSON.stringify(data) : undefined;\r\n\t\tconst queryString = (data && methods.indexOf(method) !== -1) ? Object.keys(data).map(function(key) {\r\n\t\t    return key + '=' + encodeURI(data[key]);\r\n\t\t}).join('&') : undefined;\r\n\t\tif (queryString) {\r\n\t\t\turl = `${url}?${queryString}`;\r\n\t\t}\r\n\t\tlet response_ = null;\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: body,\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = new HttpResponse(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && format === 'json' && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else if (format === 'blob') {\r\n\t\t\t\t\ttypedResponse = response.blob();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\tresponse_.data = data;\r\n\t\t\t\t\tif (response.ok) {\r\n\t\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn Promise.reject(response_);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} catch(error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(this.getError(error, response_));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic get$(url, data, format) {\r\n\t\tconst query = this.query(data);\r\n\t\treturn this.http$('GET', `${url}${query}`, undefined, format);\r\n\t}\r\n\r\n\tstatic delete$(url) {\r\n\t\treturn this.http$('DELETE', url);\r\n\t}\r\n\r\n\tstatic post$(url, data) {\r\n\t\treturn this.http$('POST', url, data);\r\n\t}\r\n\r\n\tstatic put$(url, data) {\r\n\t\treturn this.http$('PUT', url, data);\r\n\t}\r\n\r\n\tstatic patch$(url, data) {\r\n\t\treturn this.http$('PATCH', url, data);\r\n\t}\r\n\r\n\tstatic query(data) {\r\n\t\treturn ''; // todo\r\n\t}\r\n\r\n\tstatic getError(object, response) {\r\n\t\tlet error = typeof object === 'object' ? object : {};\r\n\t\tif (!error.status) {\r\n\t\t\terror.status = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusCode) {\r\n\t\t\terror.statusCode = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusMessage) {\r\n\t\t\terror.statusMessage = response ? response.statusText : object;\r\n\t\t}\r\n\t\t// console.log('HttpService.getError', error, object);\r\n\t\treturn error;\r\n\t}\r\n\r\n}\r\n","\r\nexport const RoleType = {\r\n\tPublisher: 'publisher',\r\n\tAttendee: 'attendee',\r\n\tStreamer: 'streamer',\r\n\tViewer: 'viewer',\r\n\tSmartDevice: 'smart-device',\r\n\tSelfService: 'self-service',\r\n};\r\n\r\nexport class User {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n","import { BehaviorSubject, of } from 'rxjs';\r\nimport { catchError, map, switchMap, tap } from 'rxjs/operators';\r\nimport HttpService from '../http/http.service';\r\nimport { User } from './user';\r\n\r\nexport class UserService {\r\n\r\n\tstatic setUser(user) {\r\n\t\tthis.user$.next(user);\r\n\t}\r\n\r\n\tstatic me$() {\r\n\t\treturn HttpService.get$('/api/user/me').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\t// console.log('UserService.me$.error', error);\r\n\t\t\t\tif (error.status === 404 || error.statusCode === 404) {\r\n\t\t\t\t\treturn of(null);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow (error);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tswitchMap(user => {\r\n\t\t\t\tthis.setUser(user);\r\n\t\t\t\treturn this.user$;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic login$(payload) {\r\n\t\treturn HttpService.post$('/api/user/login', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic logout$() {\r\n\t\treturn HttpService.get$('/api/user/logout').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(null)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic guidedTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/guided-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic selfServiceTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/self-service-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic resolve$(payload, status) {\r\n\t\tif (status === 'login') {\r\n\t\t\treturn this.login$(payload);\r\n\t\t}\r\n\t\tif (status === 'guided-tour') {\r\n\t\t\treturn this.guidedTour$(payload);\r\n\t\t}\r\n\t\tif (status === 'self-service-tour') {\r\n\t\t\treturn this.selfServiceTour$(payload);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic log$(payload) {\r\n\t\treturn HttpService.post$('/api/user/log', payload);\r\n\t}\r\n\r\n\t/*\r\n\tstatic retrieve$(payload) {\r\n\t\treturn HttpService.post$('/api/user/retrievepassword', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic register$(payload) {\r\n\t\treturn HttpService.post$('/api/user/register', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic update(payload) {\r\n\t\treturn HttpService.post$('/api/user/updateprofile', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic mapUser(user) {\r\n\t\treturn new User(user);\r\n\t}\r\n\r\n}\r\n\r\nUserService.user$ = new BehaviorSubject(null);\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { environment, STATIC } from '../environment';\r\nimport { fieldsToFormGroup, patchFields } from '../forms/controls.component';\r\nimport { UserService } from '../user/user.service';\r\n\r\nexport default class AccessComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tthis.state = {\r\n\t\t\tstatus: 'access',\r\n\t\t};\r\n\t\t/*\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tconsole.log('AccessComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tonSelfServiceTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'self-service-tour';\r\n\t\tthis.pushChanges();\r\n\t\tif (STATIC && window.navigator.userAgent.indexOf('OculusBrowser') !== -1) {\r\n\t\t\tthis.test();\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tonGuidedTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'guided-tour';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonGuidedTourAccess() {\r\n\t\tUserService.logout$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\twindow.location.href = environment.url.guidedTour;\r\n\t\t});\r\n\t}\r\n\r\n\tonLogin() {\r\n\t\tthis.initLoginForm();\r\n\t\tthis.state.status = 'login';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tinitRequestForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst data = this.data = window.data || {\r\n\t\t\troles: [\r\n\t\t\t\t{ id: 1, name: 'Show room' },\r\n\t\t\t\t{ id: 2, name: 'Architetto' },\r\n\t\t\t\t{ id: 3, name: 'Interior designer' },\r\n\t\t\t\t{ id: 4, name: 'Privato' },\r\n\t\t\t\t{ id: 5, name: 'Altro' }\r\n\t\t\t],\r\n\t\t};\r\n\r\n\t\tconst fields = this.fields = window.fields || [\r\n\t\t\t{ type: 'text', name: 'firstName', label: 'access_first_name', required: true, test: 'Jhon' },\r\n\t\t\t{ type: 'text', name: 'lastName', label: 'access_last_name', required: true, test: 'Appleseed' },\r\n\t\t\t{ type: 'email', name: 'email', label: 'access_email', required: true, test: 'jhonappleseed@gmail.com' },\r\n\t\t\t{ type: 'custom-select', name: 'role', label: 'access_role', required: true, options: window.data.roles, test: window.data.roles[0].id },\r\n\t\t\t{ type: 'checkbox', name: 'privacy', label: 'access_privacy_disclaimer', required: true, test: true },\r\n\t\t];\r\n\r\n\t\tfields.push(\r\n\t\t\t{ type: 'hidden', name: 'checkField', value: '', test: '' },\r\n\t\t\t{ type: 'none', name: 'checkRequest', value: window.antiforgery || '', test: window.antiforgery || '' }\r\n\t\t);\r\n\r\n\t\tconst form = this.form = fieldsToFormGroup(fields);\r\n\t\t/*\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tfirstName: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tlastName: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\temail: new FormControl(null, [Validators.RequiredValidator(), Validators.EmailValidator()]),\r\n\t\t\trole: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tprivacy: new FormControl(null, Validators.RequiredTrueValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\t\t*/\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\t/*\r\n\t\tconst options = data.roles.slice();\r\n\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\tcontrols.role.options = options;\r\n\t\t*/\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\tinitLoginForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tif (this.state.status === 'login') {\r\n\t\t\tthis.form.patch({\r\n\t\t\t\tusername: 'publisher',\r\n\t\t\t\tpassword: 'publisher',\r\n\t\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\t\tcheckField: ''\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tpatchFields(this.fields, this.form);\r\n\t\t\t/*\r\n\t\t\tthis.form.patch({\r\n\t\t\t\tfirstName: 'Jhon',\r\n\t\t\t\tlastName: 'Appleseed',\r\n\t\t\t\temail: 'jhonappleseed@gmail.com',\r\n\t\t\t\trole: this.controls.role.options.find(x => x.id !== null).id,\r\n\t\t\t\tprivacy: true,\r\n\t\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\t\tcheckField: ''\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonBack() {\r\n\t\tthis.state.status = 'access';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tconst status = this.state.status;\r\n\t\t\tUserService.resolve$(payload, status).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('AccessComponent.onSubmit', response);\r\n\t\t\t\tswitch (status) {\r\n\t\t\t\t\tcase 'guided-tour':\r\n\t\t\t\t\t\tthis.state.status = 'guided-tour-success';\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'self-service-tour':\r\n\t\t\t\t\t\twindow.location.href = environment.url.selfServiceTour;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'login':\r\n\t\t\t\t\t\twindow.location.href = environment.url.guidedTour;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n}\r\n\r\nAccessComponent.meta = {\r\n\tselector: '[access-component]',\r\n};\r\n","import { ReplaySubject } from \"rxjs\";\r\n\r\nexport default class MessageService {\r\n\tstatic message$ = new ReplaySubject(1);\r\n\tstatic message(message) {\r\n\t\tthis.message$.next(message);\r\n\t}\r\n\r\n\tstatic in$ = new ReplaySubject(1);\r\n\tstatic in(message) {\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\tstatic send = MessageService.in;\r\n\tstatic sendBack(message) {\r\n\t\tmessage = Object.assign({}, message, { remoteId: message.clientId });\r\n\t\t// console.log('MessageService.sendBack', message);\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\r\n\tstatic out$ = new ReplaySubject(1);\r\n\tstatic out(message) {\r\n\t\tthis.out$.next(message);\r\n\t}\r\n}\r\n","import { BehaviorSubject } from \"rxjs\";\r\n\r\nexport default class StateService {\r\n\tstatic state$ = new BehaviorSubject({});\r\n\tstatic set state(state) {\r\n\t\tthis.state$.next(state);\r\n\t}\r\n\tstatic get state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\tstatic patchState(state) {\r\n\t\tstate = Object.assign({}, this.state, state);\r\n\t\tthis.state = state;\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\tonce(type, callback) {\r\n\t\tconst once = (data) => {\r\n\t\t\tcallback(data);\r\n\t\t\tthis.off(type, once);\r\n\t\t};\r\n\t\tthis.on(type, once);\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\thas(type) {\r\n\t\tconst callbacks = this.events[type];\r\n\t\treturn callbacks && callbacks.length;\r\n\t}\r\n\r\n}\r\n","export default class LocalStorageService {\r\n\r\n\tstatic delete(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\twindow.localStorage.removeItem(name);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic exist(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\treturn window.localStorage[name] !== undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get(name) {\r\n\t\tlet value = null;\r\n\t\tif (this.isLocalStorageSupported() && window.localStorage[name] !== undefined) {\r\n\t\t\ttry {\r\n\t\t\t\tvalue = JSON.parse(window.localStorage[name]);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.get.error parsing', name, e);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic set(name, value) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\ttry {\r\n\t\t\t\tconst cache = [];\r\n\t\t\t\tconst json = JSON.stringify(value, function(key, value) {\r\n\t\t\t\t\tif (typeof value === 'object' && value !== null) {\r\n\t\t\t\t\t\tif (cache.indexOf(value) !== -1) {\r\n\t\t\t\t\t\t\t// Circular reference found, discard key\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcache.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value;\r\n\t\t\t\t});\r\n\t\t\t\twindow.localStorage.setItem(name, json);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.set.error serializing', name, value, e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic isLocalStorageSupported() {\r\n\t\tif (this.supported) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tlet supported = false;\r\n\t\ttry {\r\n\t\t\tsupported = 'localStorage' in window && window.localStorage !== null;\r\n\t\t\tif (supported) {\r\n\t\t\t\twindow.localStorage.setItem('test', '1');\r\n\t\t\t\twindow.localStorage.removeItem('test');\r\n\t\t\t} else {\r\n\t\t\t\tsupported = false;\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tsupported = false;\r\n\t\t}\r\n\t\tthis.supported = supported;\r\n\t\treturn supported;\r\n\t}\r\n}\r\n","import { BehaviorSubject, combineLatest, interval, of } from 'rxjs';\r\nimport { distinctUntilChanged, filter, map, shareReplay, switchMap } from 'rxjs/operators';\r\nimport { RoleType } from '../user/user';\r\n\r\nconst MAX_VISIBLE_STREAMS = 8;\r\n\r\nexport const StreamServiceMode = {\r\n\tClient: 'client',\r\n\tEditor: 'editor',\r\n};\r\n\r\nexport default class StreamService {\r\n\r\n\tstatic mode = StreamServiceMode.Client;\r\n\r\n\tstatic editorStreams$ = new BehaviorSubject(null);\r\n\tstatic set editorStreams(editorStreams) {\r\n\t\tthis.editorStreams$.next(editorStreams);\r\n\t}\r\n\tstatic get editorStreams() {\r\n\t\treturn this.editorStreams$.getValue();\r\n\t}\r\n\r\n\tstatic editorScreens$ = new BehaviorSubject(null);\r\n\tstatic set editorScreens(editorScreens) {\r\n\t\tthis.editorScreens$.next(editorScreens);\r\n\t}\r\n\tstatic get editorScreens() {\r\n\t\treturn this.editorScreens$.getValue();\r\n\t}\r\n\r\n\tstatic local$ = new BehaviorSubject(null);\r\n\tstatic set local(local) {\r\n\t\tthis.local$.next(local);\r\n\t}\r\n\tstatic get local() {\r\n\t\treturn this.local$.getValue();\r\n\t}\r\n\r\n\tstatic screen$ = new BehaviorSubject(null);\r\n\tstatic set screen(screen) {\r\n\t\tthis.screen$.next(screen);\r\n\t}\r\n\tstatic get screen() {\r\n\t\treturn this.screen$.getValue();\r\n\t}\r\n\r\n\tstatic remotes$ = new BehaviorSubject([]);\r\n\tstatic set remotes(remotes) {\r\n\t\tthis.remotes$.next(remotes);\r\n\t}\r\n\tstatic get remotes() {\r\n\t\treturn this.remotes$.getValue();\r\n\t}\r\n\r\n\tstatic peers$ = new BehaviorSubject([]);\r\n\tstatic set peers(peers) {\r\n\t\tthis.peers$.next(peers);\r\n\t}\r\n\tstatic get peers() {\r\n\t\treturn this.peers$.getValue();\r\n\t}\r\n\r\n\tstatic orderedRemotes$() {\r\n\t\treturn combineLatest([StreamService.remotes$, interval(1000)]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst orderedRemotes = [];\r\n\t\t\t\tconst remotes = datas[0];\r\n\t\t\t\tremotes.forEach(remote => {\r\n\t\t\t\t\t// const audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t// console.log('audioLevel', audioLevel, remote);\r\n\t\t\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t\t\tremote.clientInfo.audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t\tremote.clientInfo.peekAudioLevel = Math.max(remote.clientInfo.audioLevel, 0.2);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tif (remote.clientInfo.screenUid !== remote.getId()) {\r\n\t\t\t\t\t\t\torderedRemotes.push(remote);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t}\r\n\t\t\t\t\torderedRemotes.push(remote);\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.sort((a, b) => {\r\n\t\t\t\t\tif (a.clientInfo && b.clientInfo) {\r\n\t\t\t\t\t\tif (a.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\t\treturn -1;\r\n\t\t\t\t\t\t} else if (b.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\t\treturn 1;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// sort on audioLevel or lastOrder\r\n\t\t\t\t\t\t\treturn b.clientInfo.peekAudioLevel - a.clientInfo.peekAudioLevel ||\r\n\t\t\t\t\t\t\t(a.clientInfo.order || 0) - (b.clientInfo.order || 0);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.forEach((remote, i) => {\r\n\t\t\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t\t\tremote.clientInfo.order = i;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// !!! hard limit max visible stream\r\n\t\t\t\torderedRemotes.length = Math.min(orderedRemotes.length, MAX_VISIBLE_STREAMS);\r\n\t\t\t\treturn orderedRemotes;\r\n\t\t\t}),\r\n\t\t\tdistinctUntilChanged((a, b) => {\r\n\t\t\t\treturn a.map(remote => remote.clientInfo ? remote.clientInfo.uid : '').join('|') ===\r\n\t\t\t\tb.map(remote => remote.clientInfo ? remote.clientInfo.uid : '').join('|');\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic streams$ = combineLatest([StreamService.local$, StreamService.screen$, StreamService.remotes$, StreamService.getEditorStreams$(), StreamService.getEditorScreens$()]).pipe(\r\n\t\tmap(data => {\r\n\t\t\tconst local = data[0];\r\n\t\t\tconst screen = data[1];\r\n\t\t\tconst remotes = data[2];\r\n\t\t\tconst editorStreams = data[3];\r\n\t\t\tconst editorScreens = data[4];\r\n\t\t\tlet streams = remotes;\r\n\t\t\tif (local) { // my stream\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(local);\r\n\t\t\t}\r\n\t\t\tif (screen) { // my screen\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(screen);\r\n\t\t\t}\r\n\t\t\tif (editorStreams) { // editor streams\r\n\t\t\t\tstreams.push(...editorStreams);\r\n\t\t\t}\r\n\t\t\tif (editorScreens) { // editor screens\r\n\t\t\t\tstreams.push(...editorScreens);\r\n\t\t\t}\r\n\t\t\t// console.log('StreamService.streams$', streams, local, screen, remotes);\r\n\t\t\treturn streams;\r\n\t\t}),\r\n\t\tshareReplay(1),\r\n\t);\r\n\r\n\tstatic getEditorStreams$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia({\r\n\t\t\t\t\t\tvideo: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeSmartDeviceStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.SmartDevice,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorStreams$.next([fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeSmartDeviceStream]);\r\n\t\t\t\t\t\t\t// StreamService.editorStreams = [fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorStreams$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getEditorScreens$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor-screen');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getDisplayMedia({\r\n\t\t\t\t\t\tscreen: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor-screen_',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor-screen_',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorScreens$.next([fakePublisherScreen, fakeAttendeeScreen]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorScreens$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic get publisherStreamId() {\r\n\t\tconst streams = this.remotes.slice();\r\n\t\tconst local = this.local;\r\n\t\tif (local) {\r\n\t\t\tstreams.unshift(local);\r\n\t\t}\r\n\t\tconst publisherStream = streams.find(x => x.clientInfo && x.clientInfo.role === RoleType.Publisher);\r\n\t\tif (publisherStream) {\r\n\t\t\treturn publisherStream.getId();\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tstatic getPublisherStreamId$() {\r\n\t\tconst publisherStreamId = this.publisherStreamId;\r\n\t\tif (publisherStreamId) {\r\n\t\t\treturn of(publisherStreamId);\r\n\t\t} else {\r\n\t\t\treturn this.streams$.pipe(\r\n\t\t\t\tmap(() => this.publisherStreamId),\r\n\t\t\t\tfilter(x => x),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getRemoteById(streamId) {\r\n\t\t// console.log('StreamService.getRemoteById', streamId);\r\n\t\tconst remotes = StreamService.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\tif (remote) {\r\n\t\t\treturn remote;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remoteAdd(stream) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tremotes.push(stream);\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n\r\n\tstatic remoteRemove(streamId) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\t// console.log('StreamService.remoteRemove', streamId, remote);\r\n\t\tif (remote) {\r\n\t\t\tif (remote.isPlaying()) {\r\n\t\t\t\tremote.stop();\r\n\t\t\t}\r\n\t\t\tremotes.splice(remotes.indexOf(remote), 1);\r\n\t\t\tthis.remotes = remotes;\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tstatic remoteSetClientInfo(remoteId, clientInfo) {\r\n\t\tconst remotes = this.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === remoteId);\r\n\t\tif (remote) {\r\n\t\t\tremote.clientInfo = clientInfo;\r\n\t\t}\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n\r\n}\r\n","import { environment } from '../environment';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport const USE_AUTODETECT = false;\r\nexport const USE_VOLUME_INDICATOR = false;\r\nexport const USE_RTM = true;\r\n\r\nexport const StreamQualities = [{\r\n\t// id: 1,\r\n\t// name: '4K 2160p 3840x2160',\r\n\tprofile: '4K',\r\n\tresolution: {\r\n\t\twidth: 3840,\r\n\t\theight: 2160\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 8910,\r\n\t\tmax: 13500\r\n\t}\r\n}, {\r\n\t// id: 2,\r\n\t// name: 'HD 1440p 2560×1440',\r\n\tprofile: '1440p',\r\n\tresolution: {\r\n\t\twidth: 2560,\r\n\t\theight: 1440\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 4850,\r\n\t\tmax: 7350\r\n\t}\r\n}, {\r\n\t// id: 3,\r\n\t// name: 'HD 1080p 1920x1080',\r\n\tprofile: '1080p',\r\n\tresolution: {\r\n\t\twidth: 1920,\r\n\t\theight: 1080\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 2080,\r\n\t\tmax: 4780\r\n\t}\r\n}, {\r\n\t// id: 4,\r\n\t// name: 'LOW 720p 1280x720',\r\n\tprofile: '720p_3',\r\n\tresolution: {\r\n\t\twidth: 1280,\r\n\t\theight: 720\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 1130,\r\n\t\tmax: 1710\r\n\t}\r\n}, {\r\n\t// id: 5,\r\n\t// name: 'LOWEST 240p 320x240',\r\n\tprofile: '240p_1',\r\n\tresolution: {\r\n\t\twidth: 320,\r\n\t\theight: 240\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 15\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 140,\r\n\t\tmax: 200\r\n\t}\r\n}];\r\n\r\nexport function getStreamQuality(state) {\r\n\tconst lowestQuality = StreamQualities[StreamQualities.length - 1];\r\n\tconst highestQuality = environment.flags.maxQuality ? StreamQualities[0] : StreamQualities[StreamQualities.length - 2];\r\n\treturn (state.role === RoleType.Publisher || state.role === RoleType.SmartDevice) ? highestQuality : lowestQuality;\r\n}\r\n\r\nexport const AgoraStatus = {\r\n\tIdle: 'idle',\r\n\tChecklist: 'checklist',\r\n\tLink: 'link',\r\n\tLogin: 'login',\r\n\tName: 'name',\r\n\tDevice: 'device',\r\n\tShouldConnect: 'should-connect',\r\n\tConnecting: 'connecting',\r\n\tConnected: 'connected',\r\n\tDisconnected: 'disconnected',\r\n};\r\n\r\nexport const MessageType = {\r\n\tAgoraEvent: 'agoraEvent',\r\n\tPing: 'ping',\r\n\tRequestControl: 'requestControl',\r\n\tRequestControlAccepted: 'requestControlAccepted',\r\n\tRequestControlRejected: 'requestControlRejected',\r\n\tRequestControlDismiss: 'requestControlDismiss',\r\n\tRequestControlDismissed: 'requestControlDismissed',\r\n\tRequestPeerInfo: 'requestPeerInfo',\r\n\tRequestPeerInfoResult: 'requestPeerInfoResult',\r\n\tRequestInfo: 'requestInfo',\r\n\tRequestInfoResult: 'requestInfoResult',\r\n\tRequestInfoDismiss: 'requestInfoDismiss',\r\n\tRequestInfoDismissed: 'requestInfoDismissed',\r\n\tRequestInfoRejected: 'requestInfoRejected',\r\n\tSlideChange: 'slideChange',\r\n\tControlInfo: 'controlInfo',\r\n\tAddLike: 'addLike',\r\n\tShowPanel: 'showPanel',\r\n\tPlayMedia: 'playMedia',\r\n\tNavToView: 'navToView',\r\n\tNavToGrid: 'navToGrid',\r\n\tVRStarted: 'vrStarted',\r\n\tVREnded: 'vrEnded',\r\n\tVRState: 'vrState',\r\n\tMenuToggle: 'menuToggle',\r\n\tChatMessage: 'chatMessage',\r\n\tChatTypingBegin: 'chatTypingBegin',\r\n\tChatTypingEnd: 'chatTypingEnd',\r\n};\r\nexport class AgoraEvent {\r\n\tconstructor(options) {\r\n\t\tObject.assign(this, options);\r\n\t}\r\n}\r\nexport class AgoraPeerEvent extends AgoraEvent { }\r\nexport class AgoraRemoteEvent extends AgoraEvent { }\r\nexport class AgoraMuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraMuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraVolumeLevelsEvent extends AgoraEvent { }\r\n","/* global AgoraRTM */\r\n// import AgoraRTM from 'agora-rtm-sdk';\r\nimport { from, interval, of } from 'rxjs';\r\nimport { distinctUntilChanged, map, switchMap } from 'rxjs/operators';\r\nimport Emittable from '../emittable/emittable';\r\nimport { DEBUG, environment } from '../environment';\r\nimport HttpService from '../http/http.service';\r\nimport LocalStorageService from '../local-storage/local-storage.service';\r\n// import LocationService from '../location/location.service';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport { RoleType } from '../user/user';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraPeerEvent, AgoraRemoteEvent, AgoraStatus, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, AgoraVolumeLevelsEvent, getStreamQuality, MessageType, USE_AUTODETECT, USE_RTM, USE_VOLUME_INDICATOR } from './agora.types';\r\n\r\nexport default class AgoraService extends Emittable {\r\n\r\n\tstatic getSingleton(defaultDevices) {\r\n\t\tif (DEBUG) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!this.AGORA) {\r\n\t\t\tthis.AGORA = new AgoraService(defaultDevices);\r\n\t\t}\r\n\t\treturn this.AGORA;\r\n\t}\r\n\r\n\tconstructor(defaultDevices) {\r\n\t\tif (AgoraService.AGORA) {\r\n\t\t\tthrow ('AgoraService is a singleton');\r\n\t\t}\r\n\t\tsuper();\r\n\t\tthis.onStreamPublished = this.onStreamPublished.bind(this);\r\n\t\tthis.onStreamUnpublished = this.onStreamUnpublished.bind(this);\r\n\t\tthis.onStreamAdded = this.onStreamAdded.bind(this);\r\n\t\tthis.onStreamRemoved = this.onStreamRemoved.bind(this);\r\n\t\tthis.onStreamSubscribed = this.onStreamSubscribed.bind(this);\r\n\t\tthis.onMuteVideo = this.onMuteVideo.bind(this);\r\n\t\tthis.onUnmuteVideo = this.onUnmuteVideo.bind(this);\r\n\t\tthis.onMuteAudio = this.onMuteAudio.bind(this);\r\n\t\tthis.onUnmuteAudio = this.onUnmuteAudio.bind(this);\r\n\t\tthis.onVolumeIndicator = this.onVolumeIndicator.bind(this);\r\n\t\tthis.onPeerConnect = this.onPeerConnect.bind(this);\r\n\t\tthis.onPeerLeaved = this.onPeerLeaved.bind(this);\r\n\t\tthis.onConnectionStateChange = this.onConnectionStateChange.bind(this);\r\n\t\tthis.onTokenPrivilegeWillExpire = this.onTokenPrivilegeWillExpire.bind(this);\r\n\t\tthis.onTokenPrivilegeDidExpire = this.onTokenPrivilegeDidExpire.bind(this);\r\n\t\tthis.onMessage = this.onMessage.bind(this);\r\n\t\tconst state = StateService.state;\r\n\t\tStateService.patchState({\r\n\t\t\tdevices: (state.role !== RoleType.Attendee && defaultDevices) ? defaultDevices : { videos: [], audios: [] },\r\n\t\t\tquality: getStreamQuality(state),\r\n\t\t\tmembersCount: 0,\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tgetInitialStatus(role, link, name) {\r\n\t\tif (!link) {\r\n\t\t\treturn AgoraStatus.Link;\r\n\t\t}\r\n\t\tif (!name) {\r\n\t\t\treturn AgoraStatus.Name;\r\n\t\t}\r\n\t\tif (role !== RoleType.Viewer && role !== RoleType.SmartDevice) {\r\n\t\t\treturn AgoraStatus.Device;\r\n\t\t}\r\n\t\treturn AgoraStatus.ShouldConnect;\r\n\t}\r\n\t*/\r\n\r\n\taddStreamDevice(src) {\r\n\t\tthis.removeStreamDevice();\r\n\t\tconst video = {\r\n\t\t\tdeviceId: 'video-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst audio = {\r\n\t\t\tdeviceId: 'audio-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos.push(video);\r\n\t\tdevices.audios.push(audio);\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tremoveStreamDevice() {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos = devices.videos.filter(x => x.kind !== 'videostream');\r\n\t\tdevices.audios = devices.audios.filter(x => x.kind !== 'videostream');\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tdevices$() {\r\n\t\tconst inputs = StateService.state.devices;\r\n\t\tconst defaultVideos = this.defaultVideos = (this.defaultVideos || inputs.videos.slice());\r\n\t\tconst defaultAudios = this.defaultAudios = (this.defaultAudios || inputs.videos.slice());\r\n\t\tinputs.videos = defaultVideos.slice();\r\n\t\tinputs.audios = defaultAudios.slice();\r\n\t\treturn from(new Promise((resolve, reject) => {\r\n\t\t\tconst getDevices = () => {\r\n\t\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t\t// console.log('AgoraRTC.getDevices', devices);\r\n\t\t\t\t\ttempStream.close();\r\n\t\t\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\t\t\tconst device = devices[i];\r\n\t\t\t\t\t\t// console.log('device', device.deviceId);\r\n\t\t\t\t\t\tif (device.kind === 'videoinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.videos.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'camera-' + inputs.videos.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (device.kind === 'audioinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.audios.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'microphone-' + inputs.audios.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (inputs.videos.length > 0 || inputs.audios.length > 0) {\r\n\t\t\t\t\t\tresolve(inputs);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(inputs);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t\t/*\r\n\t\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\t\t// console.log('AgoraRTC.getDevices', devices);\r\n\t\t\t\t\ttempStream.close();\r\n\t\t\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\t\t\tconst device = devices[i];\r\n\t\t\t\t\t\t// console.log('device', device.deviceId);\r\n\t\t\t\t\t\tif (device.kind === 'videoinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.videos.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'camera-' + inputs.videos.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (device.kind === 'audioinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.audios.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'microphone-' + inputs.audios.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (inputs.videos.length > 0 || inputs.audios.length > 0) {\r\n\t\t\t\t\t\tresolve(inputs);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(inputs);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t*/\r\n\t\t\t};\r\n\t\t\tconst tempStream = AgoraRTC.createStream({ audio: true, video: true });\r\n\t\t\ttempStream.init(() => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t}, () => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t});\r\n\t\t}));\r\n\t}\r\n\r\n\tconnect$(preferences) {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tif (preferences) {\r\n\t\t\tdevices.video = preferences.video;\r\n\t\t\tdevices.audio = preferences.audio;\r\n\t\t}\r\n\t\t// console.log('AgoraService.connect$', preferences, devices);\r\n\t\tif (!StateService.state.connecting) {\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connecting, connecting: true, devices });\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.createClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\t// console.log('AgoraService.rtcToken$', token);\r\n\t\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}, 250);\r\n\t\t}\r\n\t\treturn StateService.state$;\r\n\t}\r\n\r\n\tmembersCount$(channelId) {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\treturn interval(2000).pipe(\r\n\t\t\tswitchMap(() => from(messageClient.getChannelMemberCount([channelId]))),\r\n\t\t\tmap(counters => counters[channelId]),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tobserveMemberCount() {\r\n\t\tthis.unobserveMemberCount();\r\n\t\tthis.membersCountSubscription = this.membersCount$(StateService.state.channelNameLink).subscribe(\r\n\t\t\tmembersCount => {\r\n\t\t\t\tStateService.patchState({ membersCount: membersCount });\r\n\t\t\t}\r\n\t\t);\r\n\t}\r\n\r\n\tunobserveMemberCount() {\r\n\t\tif (this.membersCountSubscription) {\r\n\t\t\tthis.membersCountSubscription.unsubscribe();\r\n\t\t\tthis.membersCountSubscription = null;\r\n\t\t\tStateService.patchState({ membersCount: 0 });\r\n\t\t}\r\n\t}\r\n\r\n\tcreateClient(next) {\r\n\t\tif (this.client) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\t// console.log('agora rtc sdk version: ' + AgoraRTC.VERSION + ' compatible: ' + AgoraRTC.checkSystemRequirements());\r\n\t\t// AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.ERROR);\r\n\t\tAgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.NONE);\r\n\t\tconst client = this.client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t\tconsole.log('AgoraService.client.startProxyServer');\r\n\t\t\t}\r\n\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\t// console.log('AgoraRTC client initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\t// console.log('AgoraRTC client init failed', error);\r\n\t\t\t\tthis.client = null;\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (StateService.state.role === RoleType.Viewer) {\r\n\t\t\tclient.setClientRole('audience', function(error) {\r\n\t\t\t\tif (!error) {\r\n\t\t\t\t\tclientInit();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tclientInit();\r\n\t\t}\r\n\t\tclient.on('error', this.onError);\r\n\t\tclient.on('stream-published', this.onStreamPublished);\r\n\t\tclient.on('stream-unpublished', this.onStreamUnpublished);\r\n\t\t//subscribe remote stream\r\n\t\tclient.on('stream-added', this.onStreamAdded);\r\n\t\tclient.on('stream-removed', this.onStreamRemoved);\r\n\t\tclient.on('stream-subscribed', this.onStreamSubscribed);\r\n\t\tclient.on('mute-video', this.onMuteVideo);\r\n\t\tclient.on('unmute-video', this.onUnmuteVideo);\r\n\t\tclient.on('mute-audio', this.onMuteAudio);\r\n\t\tclient.on('unmute-audio', this.onUnmuteAudio);\r\n\t\tif (USE_VOLUME_INDICATOR) {\r\n\t\t\tclient.enableAudioVolumeIndicator(); // Triggers the \"volume-indicator\" callback event every two seconds.\r\n\t\t\tclient.on(\"volume-indicator\", this.onVolumeIndicator);\r\n\t\t}\r\n\t\tclient.on('peer-online', this.onPeerConnect);\r\n\t\t// Occurs when the peer user leaves the channel; for example, the peer user calls Client.leave.\r\n\t\tclient.on('peer-leave', this.onPeerLeaved);\r\n\t\t// client.on('connection-state-change', this.onConnectionStateChange);\r\n\t\tclient.on('onTokenPrivilegeWillExpire', this.onTokenPrivilegeWillExpire);\r\n\t\tclient.on('onTokenPrivilegeDidExpire', this.onTokenPrivilegeDidExpire);\r\n\t\t// console.log('agora rtm sdk version: ' + AgoraRTM.VERSION + ' compatible');\r\n\t\tif (USE_RTM) {\r\n\t\t\t/*\r\n\t\t\tAgoraRTM.LOG_FILTER_OFF\r\n\t\t\tAgoraRTM.LOG_FILTER_ERROR\r\n\t\t\tAgoraRTM.LOG_FILTER_INFO (Default)\r\n\t\t\tAgoraRTM.LOG_FILTER_WARNING\r\n\t\t\t*/\r\n\t\t\tconst messageClient = this.messageClient = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF }); // LOG_FILTER_DEBUG\r\n\t\t\tmessageClient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\t// messageClient.on('ConnectionStateChanged', console.warn);\r\n\t\t\t// messageClient.on('MessageFromPeer', console.log);\r\n\t\t}\r\n\t}\r\n\r\n\tgetChannelNameLink() {\r\n\t\tlet link = StateService.state.link || '';\r\n\t\tconst match = link.match(/(\\d{9})-(\\d{4})-(\\d{13})/);\r\n\t\tif (match) {\r\n\t\t\tlink = `${match[1]}-${match[3]}`;\r\n\t\t}\r\n\t\tconst channelName = StateService.state.channelName;\r\n\t\tconst channelNameLink = `${channelName}-${link}`;\r\n\t\t// console.log('AgoraService.getChannelNameLink', channelNameLink);\r\n\t\treturn channelNameLink;\r\n\t}\r\n\r\n\tstatic getUniqueUserId() {\r\n\t\t// max safe integer 9007199254740991 length 16\r\n\t\t// max allowed integer 4294967296 2^32\r\n\t\tconst m = 9007199254740991;\r\n\t\tconst mult = 10000000000000;\r\n\t\tconst a = (1 + Math.floor(Math.random() * 8)) * 100;\r\n\t\tconst b = (1 + Math.floor(Math.random() * 8)) * 10;\r\n\t\tconst c = (1 + Math.floor(Math.random() * 8)) * 1;\r\n\t\tconst combo = (a + b + c);\r\n\t\tconst date = Date.now();\r\n\t\tconst uid = combo * mult + date;\r\n\t\t// console.log(combo);\r\n\t\t// console.log(date);\r\n\t\t// console.log(m);\r\n\t\t// console.log('AgoraService.getUniqueUserId', uid);\r\n\t\treturn uid.toString();\r\n\t}\r\n\r\n\tjoin(token, channelNameLink) {\r\n\t\tthis.channel = null;\r\n\t\tconst client = this.client;\r\n\t\tconst clientId = LocalStorageService.get('bHereClientId') || AgoraService.getUniqueUserId();\r\n\t\t// console.log('AgoraService.join', { token, channelNameLink, clientId });\r\n\t\tclient.join(token, channelNameLink, clientId, (uid) => {\r\n\t\t\t// console.log('AgoraService.join', uid);\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connected, channelNameLink, connected: true, uid: uid });\r\n\t\t\tLocalStorageService.set('bHereClientId', uid);\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t\t// console.log('AgoraService.rtmToken$', token);\r\n\t\t\t\t\tthis.joinMessageChannel(token.token, uid).then((success) => {\r\n\t\t\t\t\t\t// console.log('joinMessageChannel.success', success);\r\n\t\t\t\t\t\tif (StateService.state.role !== RoleType.Viewer) {\r\n\t\t\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.observeMemberCount();\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\tconsole.log('joinMessageChannel.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tif (StateService.state.role !== RoleType.Viewer) {\r\n\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.join.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\t// https://console.agora.io/invite?sign=YXBwSWQlM0RhYjQyODlhNDZjZDM0ZGE2YTYxZmQ4ZDY2Nzc0YjY1ZiUyNm5hbWUlM0RaYW1wZXR0aSUyNnRpbWVzdGFtcCUzRDE1ODY5NjM0NDU=// join link expire in 30 minutes\r\n\t}\r\n\r\n\tjoinMessageChannel(token, uid) {\r\n\t\tlet channel;\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tmessageClient.login({ token: token, uid: uid.toString() }).then(() => {\r\n\t\t\t\t// console.log('AgoraService.messageClient.login.success');\r\n\t\t\t\tchannel = messageClient.createChannel(StateService.state.channelNameLink);\r\n\t\t\t\treturn channel.join();\r\n\t\t\t}).then(() => {\r\n\t\t\t\tthis.channel = channel;\r\n\t\t\t\tchannel.on('ChannelMessage', this.onMessage);\r\n\t\t\t\tthis.emit('channel', channel);\r\n\t\t\t\t// console.log('AgoraService.joinMessageChannel.success');\r\n\t\t\t\tresolve(uid);\r\n\t\t\t}).catch(reject);\r\n\t\t});\r\n\t}\r\n\r\n\tdetectDevices(next) {\r\n\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\tconst videos = [];\r\n\t\t\tconst audios = [];\r\n\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\tconst device = devices[i];\r\n\t\t\t\tif ('videoinput' == device.kind) {\r\n\t\t\t\t\tvideos.push({\r\n\t\t\t\t\t\tlabel: device.label || 'camera-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tif ('audioinput' == device.kind) {\r\n\t\t\t\t\taudios.push({\r\n\t\t\t\t\t\tlabel: device.label || 'microphone-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tnext({ videos: videos, audios: audios });\r\n\t\t}).catch((error) => {\r\n\t\t\tconsole.log('AgoraService.detectDevices', error);\r\n\t\t});\r\n\t}\r\n\r\n\tgetVideoOptions(options, video) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (video) {\r\n\t\t\t\tif (video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(video.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t\t\t// console.log('AgoraService.getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tconsole.log('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (video.kind === 'videoplayer' || video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t// console.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t// console.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// console.log('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.cameraId = video.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tgetAudioOptions(options, audio) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (audio) {\r\n\t\t\t\tif (audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// !!! try hls.service;\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(audio.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\t\t\thls.loadLevel = data.levels.length - 1;\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tconsole.log('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (audio.kind === 'videoplayer' || audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.microphoneId = audio.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tautoDetectDevice() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst state = StateService.state;\r\n\t\t\tif (state.role === RoleType.SmartDevice || USE_AUTODETECT) {\r\n\t\t\t\tAgoraService.getDevices().then(inputDevices => {\r\n\t\t\t\t\tconst devices = { videos: [], audios: [], video: null, audio: null };\r\n\t\t\t\t\tinputDevices.forEach(x => {\r\n\t\t\t\t\t\tif (x.kind === 'videoinput') {\r\n\t\t\t\t\t\t\tdevices.videos.push(x);\r\n\t\t\t\t\t\t} else if (x.kind === 'audioinput') {\r\n\t\t\t\t\t\t\tdevices.audios.push(x);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconsole.log(devices)\r\n\t\t\t\t\tdevices.video = devices.videos[0] || null;\r\n\t\t\t\t\tdevices.audio = devices.audios[0] || null;\r\n\t\t\t\t\tStateService.patchState({ devices });\r\n\t\t\t\t\tresolve(devices);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve(state.devices);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateMediaStream(uid, video, audio) {\r\n\t\t// this.releaseStream('_mediaVideoStream')\r\n\t\tconst options = {\r\n\t\t\tstreamID: uid,\r\n\t\t\tvideo: Boolean(video),\r\n\t\t\taudio: Boolean(audio),\r\n\t\t\tscreen: false,\r\n\t\t};\r\n\t\tPromise.all([\r\n\t\t\tthis.getVideoOptions(options, video),\r\n\t\t\tthis.getAudioOptions(options, audio)\r\n\t\t]).then(success => {\r\n\t\t\tconst quality = Object.assign({}, StateService.state.quality);\r\n\t\t\tthis.createLocalStreamWithOptions(options, quality);\r\n\t\t});\r\n\t}\r\n\r\n\tcreateLocalStreamWithOptions(options, quality) {\r\n\t\t/*\r\n\t\tconst getUserMedia = navigator.mediaDevices.getUserMedia;\r\n\t\tnavigator.mediaDevices.getUserMedia = function(options) {\r\n\t\t\tif (options.video) {\r\n\t\t\t\toptions.video.width = { ideal: 4096 };\r\n\t\t\t\toptions.video.height = { ideal: 2160 };\r\n\t\t\t\tconsole.log('getUserMedia', options.video.width.ideal, options.video.height.ideal);\r\n\t\t\t}\r\n\t\t\tconsole.log('getUserMedia', options);\r\n\t\t\treturn getUserMedia.call(navigator.mediaDevices, options);\r\n\t\t}\r\n\t\t*/\r\n\t\tconst local = AgoraRTC.createStream(options);\r\n\t\t/*\r\n\t\t// force video quality\r\n\t\tquality = {\r\n\t\t\tresolution: {\r\n\t\t\t\twidth: 1920,\r\n\t\t\t\theight: 1080\r\n\t\t\t},\r\n\t\t\tframeRate: {\r\n\t\t\t\tmin: 30,\r\n\t\t\t\tmax: 30\r\n\t\t\t},\r\n\t\t\tbitrate: {\r\n\t\t\t\tmin: 2000,\r\n\t\t\t\tmax: 4000\r\n\t\t\t}\r\n\t\t};\r\n\t\t*/\r\n\t\tif (quality) {\r\n\t\t\tlocal.setVideoProfile(quality.profile);\r\n\t\t\tlocal.setVideoEncoderConfiguration(quality);\r\n\t\t}\r\n\t\t// console.log('local', local.attributes);\r\n\t\tlocal.init(() => {\r\n\t\t\tStreamService.local = local;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishLocalStream();\r\n\t\t\t}, 1);\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.initLocalStream.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tinitLocalStream() {\r\n\t\tconst local = StreamService.local;\r\n\t\tlocal.init(() => {\r\n\t\t\tthis.publishLocalStream();\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.initLocalStream.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tcreateMediaVideoStream(video, callback) {\r\n\t\tconst videoStream = video.captureStream(60);\r\n\t\tconst stream = AgoraRTC.createStream({\r\n\t\t\taudio: true,\r\n\t\t\tvideo: true,\r\n\t\t\tvideoSource: videoStream.getVideoTracks()[0],\r\n\t\t\taudioSource: videoStream.getAudioTracks()[0],\r\n\t\t});\r\n\t\tstream.init(() => {\r\n\t\t\tcallback(stream.getVideoTrack(), stream.getAudioTrack());\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tpublishLocalStream() {\r\n\t\tconst client = this.client;\r\n\t\tconst local = StreamService.local;\r\n\t\t// publish local stream\r\n\t\tclient.publish(local, (error) => {\r\n\t\t\tconsole.log('AgoraService.publishLocalStream.error', local.getId(), error);\r\n\t\t});\r\n\t\tlocal.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.local = local;\r\n\t}\r\n\r\n\tunpublishLocalStream() {\r\n\t\tconst client = this.client;\r\n\t\tconst local = StreamService.local;\r\n\t\tif (local) {\r\n\t\t\tclient.unpublish(local, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.unpublishLocalStream.error', local.getId(), error);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tleaveChannel() {\r\n\t\tStateService.patchState({ connecting: false });\r\n\t\tthis.unpublishLocalStream();\r\n\t\tthis.unpublishScreenStream();\r\n\t\tStreamService.remotes = [];\r\n\t\tStreamService.peers = [];\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.leaveMessageChannel().then(() => {\r\n\t\t\t\treturn Promise.all([this.leaveClient(), this.leaveScreenClient()]);\r\n\t\t\t}, reject);\r\n\t\t});\r\n\t}\r\n\r\n\tleaveClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst client = this.client;\r\n\t\t\tif (client) {\r\n\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\tthis.client = null;\r\n\t\t\t\t\t// console.log('Leave channel successfully');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\tconsole.log('AgoraService.client.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tconsole.log('AgoraService.leaveClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tleaveMessageChannel() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tthis.unobserveMemberCount();\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tconst messageClient = this.messageClient;\r\n\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\tthis.channel = null;\r\n\t\t\t\t\tmessageClient.logout().then(() => {\r\n\t\t\t\t\t\tthis.messageClient = null;\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t}, reject);\r\n\t\t\t\t}, reject)\r\n\t\t\t} else {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// console.log('toggleCamera', local);\r\n\t\tif (local && local.video) {\r\n\t\t\tif (local.userMuteVideo) {\r\n\t\t\t\tlocal.unmuteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// console.log(local);\r\n\t\tif (local && local.audio) {\r\n\t\t\tif (local.userMuteAudio) {\r\n\t\t\t\tlocal.unmuteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleControl() {\r\n\t\tif (StateService.state.control) {\r\n\t\t\tthis.sendRemoteControlDismiss().then((control) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlDismiss', control);\r\n\t\t\t\tStateService.patchState({ control: !control });\r\n\t\t\t});\r\n\t\t} else if (StateService.state.spying) {\r\n\t\t\tthis.sendRemoteInfoDismiss(StateService.state.spying).then((spying) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss', spying);\r\n\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\tthis.sendRemoteControlRequest().then((control) => {\r\n\t\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest', control);\r\n\t\t\t\t\tStateService.patchState({ control: control });\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.sendRemoteControlRequest().then((control) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest', control);\r\n\t\t\t\tStateService.patchState({ control: control });\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleSpy(remoteId) {\r\n\t\tif (StateService.state.control) {\r\n\t\t\tthis.sendRemoteControlDismiss().then((control) => {\r\n\t\t\t\tStateService.patchState({ control: false });\r\n\t\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else if (StateService.state.spying) {\r\n\t\t\tthis.sendRemoteInfoDismiss(StateService.state.spying).then((spying) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss', spying);\r\n\t\t\t\t// StateService.patchState({ spying: !spying });\r\n\t\t\t\tif (StateService.state.spying !== remoteId) {\r\n\t\t\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tnewMessageId() {\r\n\t\treturn `${StateService.state.uid}-${Date.now().toString()}`;\r\n\t}\r\n\r\n\tsendRemoteControlDismiss() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControlDismiss,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlDismiss return', message);\r\n\t\t\t\tif (message.type === MessageType.RequestControlDismissed) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestControlRejected) {\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteControlRequest() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControl,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestControlAccepted) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestControlRejected) {\r\n\t\t\t\t\t// this.remoteDeviceInfo = undefined\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteRequestPeerInfo(remoteId) {\r\n\t\t// console.log('AgoraService.sendRemoteRequestPeerInfo', remoteId);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestPeerInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteRequestPeerInfo.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestPeerInfoResult) {\r\n\t\t\t\t\tif (message.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\tconst state = { hosted: true };\r\n\t\t\t\t\t\tif (message.clientInfo.control === true) {\r\n\t\t\t\t\t\t\tstate.locked = true;\r\n\t\t\t\t\t\t\tthis.sendControlRemoteRequestInfo(message.clientInfo.uid);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tStateService.patchState(state);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendControlRemoteRequestInfo(remoteId) {\r\n\t\t// console.log('AgoraService.sendControlRemoteRequestInfo', remoteId);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\tif (message.type === MessageType.RequestInfoResult) {\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendSpyRemoteRequestInfo(remoteId) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendSpyRemoteRequestInfo.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestInfoResult) {\r\n\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteInfoDismiss(remoteId) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfoDismiss,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestInfoDismissed) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestInfoRejected) {\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tnavToView(viewId) {\r\n\t\tif (StateService.state.control || StateService.state.spyed) {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.NavToView,\r\n\t\t\t\tviewId: viewId,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tgetSessionStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSessionStats((stats) => {\r\n\t\t\tconsole.log(`Current Session Duration: ${stats.Duration}`);\r\n\t\t\tconsole.log(`Current Session UserCount: ${stats.UserCount}`);\r\n\t\t\tconsole.log(`Current Session SendBytes: ${stats.SendBytes}`);\r\n\t\t\tconsole.log(`Current Session RecvBytes: ${stats.RecvBytes}`);\r\n\t\t\tconsole.log(`Current Session SendBitrate: ${stats.SendBitrate}`);\r\n\t\t\tconsole.log(`Current Session RecvBitrate: ${stats.RecvBitrate}`);\r\n\t\t});\r\n\t}\r\n\r\n\tgetSystemStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSystemStats((stats) => {\r\n\t\t\tconsole.log(`Current battery level: ${stats.BatteryLevel}`);\r\n\t\t});\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (StateService.state.connected) {\r\n\t\t\t\tmessage.clientId = StateService.state.uid;\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tcase MessageType.PlayMedia:\r\n\t\t\t\t\t\tif (!StateService.state.control && !StateService.state.spyed) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\t// message.wrc_version = 'beta';\r\n\t\t\t\t// message.uid = StateService.state.uid;\r\n\t\t\t\tconst send = (message, channel) => {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst text = JSON.stringify(message);\r\n\t\t\t\t\t\tif (message.messageId) {\r\n\t\t\t\t\t\t\tthis.once(`message-${message.messageId}`, (message) => {\r\n\t\t\t\t\t\t\t\tresolve(message);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// console.log('AgoraService.sendMessage.sending', message.type);\r\n\t\t\t\t\t\tchannel.sendMessage({ text: text }).then(() => {\r\n\t\t\t\t\t\t\t// console.log('AgoraService.sendMessage', text);\r\n\t\t\t\t\t\t\tif (!message.messageId) {\r\n\t\t\t\t\t\t\t\tresolve(message);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}).catch(error => {\r\n\t\t\t\t\t\t\tconsole.log('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\tconsole.log('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t// reject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tif (channel) {\r\n\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tthis.once(`channel`, (channel) => {\r\n\t\t\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// console.log('StateService.state.connected', StateService.state.connected)\r\n\t\t\t\t// reject();\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\taddOrUpdateChannelAttributes(messages) {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\tif (messageClient) {\r\n\t\t\tconst attributes = {};\r\n\t\t\tmessages.forEach(message => {\r\n\t\t\t\tconst key = message.date.toString();\r\n\t\t\t\tattributes[key] = JSON.stringify(message);\r\n\t\t\t});\r\n\t\t\tif (Object.keys(attributes).length) {\r\n\t\t\t\t// console.log('AgoraService.setChannelAttributes', attributes);\r\n\t\t\t\tconst promise = messageClient.addOrUpdateChannelAttributes(StateService.state.channelNameLink, attributes, { enableNotificationToChannelMembers: false });\r\n\t\t\t\treturn from(promise);\r\n\t\t\t} else {\r\n\t\t\t\treturn of(null);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tgetChannelAttributes() {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\tif (messageClient) {\r\n\t\t\tconst promise = messageClient.getChannelAttributes(StateService.state.channelNameLink);\r\n\t\t\treturn from(promise).pipe(\r\n\t\t\t\tmap(attributes => Object.keys(attributes).map(key => attributes[key])),\r\n\t\t\t\tmap(attributes => {\r\n\t\t\t\t\tattributes.sort((a, b) => {\r\n\t\t\t\t\t\treturn a.lastUpdateTs - b.lastUpdateTs;\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconst messages = attributes.map(attribute => {\r\n\t\t\t\t\t\tconst message = JSON.parse(attribute.value);\r\n\t\t\t\t\t\t// console.log('AgoraService.getChannelAttributes.attribute', attribute, message);\r\n\t\t\t\t\t\treturn message;\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('AgoraService.getChannelAttributes', messages);\r\n\t\t\t\t\treturn messages;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tcheckBroadcastMessage(message) {\r\n\t\t// filter for broadcast\r\n\t\t// !!! filter events here\r\n\t\tswitch (message.type) {\r\n\t\t\tcase MessageType.RequestControlDismiss:\r\n\t\t\t\tStateService.patchState({ locked: false });\r\n\t\t\t\tthis.sendMessage({\r\n\t\t\t\t\ttype: MessageType.RequestControlDismissed,\r\n\t\t\t\t\tmessageId: message.messageId\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RequestInfoDismiss:\r\n\t\t\t\t// console.log('checkBroadcastMessage.RequestInfoDismiss', message);\r\n\t\t\t\tStateService.patchState({ spyed: false });\r\n\t\t\t\tthis.sendMessage({\r\n\t\t\t\t\ttype: MessageType.RequestInfoDismissed,\r\n\t\t\t\t\tmessageId: message.messageId,\r\n\t\t\t\t\tremoteId: message.remoteId,\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t// console.log('checkBroadcastMessage.RequestInfoResult', message);\r\n\t\t\t\tif (StateService.state.role === RoleType.Publisher) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t} else if (StateService.state.locked) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.ControlInfo:\r\n\t\t\tcase MessageType.ShowPanel:\r\n\t\t\tcase MessageType.PlayMedia:\r\n\t\t\tcase MessageType.NavToView:\r\n\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\tif (StateService.state.locked || (StateService.state.spying && StateService.state.spying === message.clientId)) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthis.broadcastMessage(message);\r\n\t\t}\r\n\t}\r\n\r\n\tbroadcastMessage(message) {\r\n\t\tMessageService.out(message);\r\n\t}\r\n\r\n\tbroadcastEvent(event) {\r\n\t\tMessageService.out({\r\n\t\t\ttype: MessageType.AgoraEvent,\r\n\t\t\tevent,\r\n\t\t});\r\n\t}\r\n\r\n\tonMessage(data, uid) {\r\n\t\t// console.log('AgoraService.onMessage', data.text, uid, StateService.state.uid);\r\n\t\t// discard message delivered by current state uid;\r\n\t\tif (uid !== StateService.state.uid) {\r\n\t\t\t// console.log('AgoraService.onMessage', data.text);\r\n\t\t\tconst message = JSON.parse(data.text);\r\n\t\t\tif (message.messageId && this.has(`message-${message.messageId}`)) {\r\n\t\t\t\t// !!! removed return\r\n\t\t\t\tthis.emit(`message-${message.messageId}`, message);\r\n\t\t\t}\r\n\t\t\t// discard message delivered to specific remoteId when differs from current state uid;\r\n\t\t\tif (message.remoteId && message.remoteId !== StateService.state.uid && message.remoteId !== StateService.state.screenUid) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// !!! check position !!!\r\n\t\t\tif (message.type === MessageType.VRStarted) {\r\n\t\t\t\tconst container = document.createElement('div');\r\n\t\t\t\tcontainer.classList.add('player__vr');\r\n\t\t\t\tmessage.container = container;\r\n\t\t\t}\r\n\t\t\t/*\r\n\t\t\tif (message.type === MessageType.VRStarted || message.type === MessageType.VREnded) {\r\n\t\t\t\tconsole.log('AgoraService.onMessage', message.type, message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.checkBroadcastMessage(message);\r\n\t\t}\r\n\t}\r\n\r\n\tonError(error) {\r\n\t\tconsole.log('AgoraService.onError', error);\r\n\t}\r\n\r\n\tonStreamPublished(event) {\r\n\t\t// console.log('AgoraService.onStreamPublished');\r\n\t\tconst local = StreamService.local;\r\n\t\tlocal.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.local = local;\r\n\t}\r\n\r\n\tonStreamUnpublished(event) {\r\n\t\t// console.log('AgoraService.onStreamUnpublished');\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tonStreamAdded(event) {\r\n\t\tconst client = this.client;\r\n\t\tconst stream = event.stream;\r\n\t\tif (!stream) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst streamId = stream.getId();\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\t// console.log('AgoraService.onStreamAdded', streamId, StateService.state.uid, StateService.state.screenUid);\r\n\t\t\tclient.subscribe(stream, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.onStreamAdded.subscribe.error', error);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamRemoved(event) {\r\n\t\tconst stream = event.stream;\r\n\t\tconst streamId = stream.getId();\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\t// !!! this happen on oculus removed timeout\r\n\t\t\t// console.log('AgoraService.onStreamRemoved', streamId);\r\n\t\t\tthis.remoteRemove(streamId);\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamSubscribed(event) {\r\n\t\t// console.log('AgoraService.onStreamSubscribed', event.stream.getId());\r\n\t\tthis.remoteAdd(event.stream);\r\n\t}\r\n\r\n\tonPeerConnect(event) {\r\n\t\t// console.log('AgoraService.onPeerConnect', event);\r\n\t\tthis.peerAdd(event);\r\n\t}\r\n\r\n\tonPeerLeaved(event) {\r\n\t\tconst clientId = event.uid;\r\n\t\tif (clientId !== StateService.state.uid) {\r\n\t\t\t// console.log('AgoraService.onPeerLeaved', event.uid);\r\n\t\t\tconst remote = this.remoteRemove(clientId);\r\n\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t// !!! remove screenRemote?\r\n\t\t\t\tif (remote.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\tStateService.patchState({ hosted: false, locked: false, control: false, spyed: false });\r\n\t\t\t\t} else if (StateService.state.spying === clientId) {\r\n\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.peerRemove(clientId);\r\n\t}\r\n\r\n\tpeerAdd(event) {\r\n\t\t// console.log('AgoraService.peerAdd', event);\r\n\t\tconst peer = {\r\n\t\t\tuid: event.uid\r\n\t\t};\r\n\t\tconst peers = StreamService.peers;\r\n\t\tpeers.push(peer);\r\n\t\tStreamService.peers = peers;\r\n\t\tthis.broadcastEvent(new AgoraPeerEvent({ peer }));\r\n\t}\r\n\r\n\tpeerRemove(peerId) {\r\n\t\t// console.log('AgoraService.peerRemove', peerId);\r\n\t\tconst peers = StreamService.peers;\r\n\t\tconst peer = peers.find(x => x.uid === peerId);\r\n\t\tif (peer) {\r\n\t\t\tpeers.splice(peers.indexOf(peer), 1);\r\n\t\t\tStreamService.peers = peers;\r\n\t\t}\r\n\t}\r\n\r\n\tremoteAdd(stream) {\r\n\t\t// console.log('AgoraService.remoteAdd', stream);\r\n\t\tStreamService.remoteAdd(stream);\r\n\t\tthis.broadcastEvent(new AgoraRemoteEvent({ stream }));\r\n\t\tconst remoteId = stream.getId();\r\n\t\tthis.sendRemoteRequestPeerInfo(remoteId).then((message) => {\r\n\t\t\tStreamService.remoteSetClientInfo(remoteId, message.clientInfo);\r\n\t\t});\r\n\t}\r\n\r\n\tremoteRemove(streamId) {\r\n\t\t// console.log('AgoraService.remoteRemove', streamId);\r\n\t\tconst remote = StreamService.remoteRemove(streamId);\r\n\t\tif (remote && remote.clientInfo && remote.clientInfo.role === RoleType.Publisher && remote.clientInfo.screenUid !== streamId) {\r\n\t\t\tStateService.patchState({ hosted: false });\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tonMuteVideo(event) {\r\n\t\t// console.log('AgoraService.onMuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteVideo(event) {\r\n\t\t// console.log('AgoraService.onUnmuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonMuteAudio(event) {\r\n\t\t// console.log('AgoraService.onMuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteAudio(event) {\r\n\t\t// console.log('AgoraService.onUnmuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonVolumeIndicator(event) {\r\n\t\t// console.log('AgoraService.onVolumeIndicator', event);\r\n\t\tconst streams = event.attr.map(x => {\r\n\t\t\treturn { streamId: x.uid, level: x.level };\r\n\t\t});\r\n\t\tthis.broadcastEvent(new AgoraVolumeLevelsEvent({ streams: streams }));\r\n\t}\r\n\r\n\tonConnectionStateChange(event) {\r\n\t\tconsole.log('AgoraService.onConnectionStateChange', event);\r\n\t}\r\n\r\n\tonTokenPrivilegeWillExpire(event) {\r\n\t\tconsole.log('AgoraService.onTokenPrivilegeWillExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tconsole.log('AgoraService.onTokenPrivilegeWillExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonTokenPrivilegeDidExpire(event) {\r\n\t\tconsole.log('AgoraService.onTokenPrivilegeDidExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tconsole.log('AgoraService.onTokenPrivilegeDidExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t// screen\r\n\r\n\ttoggleScreen() {\r\n\t\tconst screen = StreamService.screen;\r\n\t\tif (screen) {\r\n\t\t\tthis.unpublishScreenStream();\r\n\t\t} else {\r\n\t\t\tif (this.screenClient) {\r\n\t\t\t\tthis.createScreenStream(StateService.state.screenUid);\r\n\t\t\t} else {\r\n\t\t\t\tthis.createScreenClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\t// console.log('AgoraService.rtcToken$', token);\r\n\t\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log(screen);\r\n\t}\r\n\r\n\tcreateScreenClient(next) {\r\n\t\tif (this.screenClient) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\tconst screenClient = this.screenClient = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc, vp8\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tscreenClient.startProxyServer(3);\r\n\t\t\t\tconsole.log('AgoraService.screenClient.startProxyServer');\r\n\t\t\t}\r\n\t\t\tscreenClient.init(environment.appKey, () => {\r\n\t\t\t\t// console.log('AgoraRTC screenClient initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\t// console.log('AgoraRTC client init failed', error);\r\n\t\t\t\tthis.screenClient = null;\r\n\t\t\t});\r\n\t\t}\r\n\t\tclientInit();\r\n\t\tscreenClient.on('error', this.onScreenError);\r\n\t\tscreenClient.on('stream-published', this.onScreenStreamPublished);\r\n\t\tscreenClient.on('stream-unpublished', this.onScreenStreamUnpublished);\r\n\t\t// only for remotes\r\n\t\t// screenClient.on('stream-added', this.onScreenStreamAdded);\r\n\t\t// screenClient.on('stream-removed', this.onScreenStreamRemoved);\r\n\t\t// screenClient.on('stream-subscribed', this.onScreenStreamSubscribed);\r\n\t\t// screenClient.on('peer-online', this.onScreenPeerConnect);\r\n\t\t// screenClient.on('peer-leave', this.onScreenPeerLeaved);\r\n\t\t// screenClient.on('onTokenPrivilegeWillExpire', this.onScreenTokenPrivilegeWillExpire);\r\n\t\t// screenClient.on('onTokenPrivilegeDidExpire', this.onScreenTokenPrivilegeDidExpire);\r\n\t}\r\n\r\n\tscreenJoin(token, channelNameLink) {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screenClientId = null;\r\n\t\t// console.log('AgoraService.join', { token, channelNameLink, screenClientId });\r\n\t\tscreenClient.join(token, channelNameLink, screenClientId, (uid) => {\r\n\t\t\t// console.log('AgoraService.join', uid);\r\n\t\t\tStateService.patchState({ screenUid: uid });\r\n\t\t\tthis.createScreenStream(uid);\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.screenJoin.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateScreenStream(screenUid) {\r\n\t\tconst options = {\r\n\t\t\tstreamID: screenUid,\r\n\t\t\taudio: false,\r\n\t\t\tvideo: false,\r\n\t\t\tscreen: true\r\n\t\t}\r\n\t\t/*\r\n\t\t// Set relevant properties according to the browser.\r\n\t\t// Note that you need to implement isFirefox and isCompatibleChrome.\r\n\t\tif (isFirefox()) {\r\n\t\t\toptions.mediaSource = 'window';\r\n\t\t} else if (!isCompatibleChrome()) {\r\n\t\t\toptions.extensionId = 'minllpmhdgpndnkomcoccfekfegnlikg';\r\n\t\t}\r\n\t\t*/\r\n\t\tconst quality = Object.assign({}, StateService.state.quality);\r\n\t\tconst stream = AgoraRTC.createStream(options);\r\n\t\tif (quality) {\r\n\t\t\tstream.setScreenProfile('720p_1');\r\n\t\t\t// stream.setVideoProfile(quality.profile);\r\n\t\t\t// stream.setVideoEncoderConfiguration(quality);\r\n\t\t}\r\n\t\t// Initialize the stream.\r\n\t\tstream.init(() => {\r\n\t\t\tStreamService.screen = stream;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishScreenStream();\r\n\t\t\t}, 1);\r\n\t\t}, function(error) {\r\n\t\t\tconsole.log('AgoraService.createScreenStream.screen.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tpublishScreenStream() {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screen = StreamService.screen;\r\n\t\t// publish screen stream\r\n\t\tscreenClient.publish(screen, (error) => {\r\n\t\t\tconsole.log('AgoraService.publishScreenStream.error', screen.getId(), error);\r\n\t\t});\r\n\t\tscreen.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.screen = screen;\r\n\t}\r\n\r\n\tunpublishScreenStream() {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screen = StreamService.screen;\r\n\t\t// console.log('AgoraService.unpublishScreenStream', screen, screenClient);\r\n\t\tif (screenClient && screen) {\r\n\t\t\tscreenClient.unpublish(screen, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.unpublishScreenStream.error', screen.getId(), error);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\tleaveScreenClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst screenClient = this.screenClient;\r\n\t\t\tif (screenClient) {\r\n\t\t\t\tscreenClient.leave(() => {\r\n\t\t\t\t\tthis.screenClient = null;\r\n\t\t\t\t\t// console.log('Leave channel successfully');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tscreenClient.stopProxyServer();\r\n\t\t\t\t\t\tconsole.log('AgoraService.screenClient.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tconsole.log('AgoraService.leaveScreenClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonScreenError(error) {\r\n\t\tconsole.log('AgoraService.onScreenError', error);\r\n\t}\r\n\r\n\tonScreenStreamPublished(event) {\r\n\t\t// console.log('AgoraService.onScreenStreamPublished');\r\n\t\tconst screen = StreamService.screen;\r\n\t\tscreen.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.screen = screen;\r\n\t}\r\n\r\n\tonScreenStreamUnpublished(event) {\r\n\t\t// console.log('AgoraService.onScreenStreamUnpublished');\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\t// tokens\r\n\tstatic rtcToken$(channelNameLink) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtc', { channelName: channelNameLink, uid: null });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\tstatic rtmToken$(uid) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtm', { uid: uid });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\t// checks\r\n\tstatic checkRtcConnection() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' });\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t}\r\n\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\tAgoraService.checkRtcTryJoin(client).then(uid => {\r\n\t\t\t\t\tresolve(uid);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t// clear\r\n\t\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, () => {});\r\n\t\t\t\t});\r\n\t\t\t}, (error) => {\r\n\t\t\t\treject(error);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtcTryJoin(client) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\tAgoraService.rtcToken$(channelName).subscribe(token => {\r\n\t\t\t\tclient.join(token.token, channelName, null, (uid) => {\r\n\t\t\t\t\t// this.createMediaStream(uid, StateService.state.devices.video, StateService.state.devices.audio);\r\n\t\t\t\t\tresolve(uid);\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\t\t\treturn AgoraService.checkRtcTryJoin(client);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log('AgoraService.checkRtcConnection.error', error);\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtmConnection(uid) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (!USE_RTM) {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t\tlet client = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\tclient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\tlet channel;\r\n\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t// console.log('AgoraService.rtmToken$', token);\r\n\t\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\t\tclient.login({ token: token.token, uid: uid.toString() }).then(() => {\r\n\t\t\t\t\tchannel = client.createChannel(channelName);\r\n\t\t\t\t\tchannel.join().then(() => {\r\n\t\t\t\t\t\tresolve(uid);\r\n\t\t\t\t\t\tchannel.leave();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t\t// clear\r\n\t\t\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\t\t\tchannel = null;\r\n\t\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t})\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t// clear\r\n\t\t\t\t\tif (client) {\r\n\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic getDevices() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tlet devices_ = AgoraService.devices_;\r\n\t\t\tif (devices_) {\r\n\t\t\t\tresolve(devices_);\r\n\t\t\t} else {\r\n\t\t\t\tdevices_ = AgoraService.devices_ = [];\r\n\t\t\t\tvar constraints = {\r\n\t\t\t\t\taudio: true,\r\n\t\t\t\t\tvideo: true,\r\n\t\t\t\t};\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia(constraints).then((stream) => {\r\n\t\t\t\t\t\tnavigator.mediaDevices.enumerateDevices().then((devices) => {\r\n\t\t\t\t\t\t\tstream.getTracks().forEach((track) => {\r\n\t\t\t\t\t\t\t\ttrack.stop();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tdevices.forEach((device) => {\r\n\t\t\t\t\t\t\t\tdevices_.push(device);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tresolve(devices_);\r\n\t\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\treject('Media device not available');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\nimport { MessageType } from './agora.types';\r\n\r\nexport class ChatMessage {\r\n\r\n\tconstructor(message, clientId, name) {\r\n\t\tthis.type = MessageType.ChatMessage;\r\n\t\tthis.clientId_ = clientId;\r\n\t\tif (typeof message === 'string') {\r\n\t\t\tthis.date = Date.now();\r\n\t\t\tthis.clientId = clientId;\r\n\t\t\tthis.name = name;\r\n\t\t\tthis.message = message;\r\n\t\t} else if (typeof message === 'object') {\r\n\t\t\tthis.date = message.date;\r\n\t\t\tthis.clientId = message.clientId;\r\n\t\t\tthis.name = message.name;\r\n\t\t\tthis.message = message.message;\r\n\t\t}\r\n\t\tconst names = this.name.split(' ');\r\n\t\tthis.shortName = names[0].substr(0, 1).toUpperCase() + (names.length > 1 ? names[1] : names[0]).substr(0, 1).toUpperCase();\r\n\t}\r\n\r\n\tget me() {\r\n\t\treturn this.clientId === this.clientId_;\r\n\t}\r\n\r\n\tgetPayload() {\r\n\t\treturn {\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t};\r\n\t}\r\n\r\n\tgetCopy() {\r\n\t\treturn new ChatMessage({\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t}, this.clientId_);\r\n\t}\r\n}\r\n\r\nexport default class AgoraChatComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tmessage: null,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraChatComponent.changes$', form.value);\r\n\t\t\tthis.checkTypings(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraChatComponent.state', state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraChatComponent.MessageService', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tthis.pushMessage(new ChatMessage(message, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\tthis.typingBegin(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\tthis.typingEnd(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.messages = [];\r\n\t\tthis.groupedMessages = [];\r\n\t\tif (this.demo) {\r\n\t\t\t// !!! only for demo\r\n\t\t\tconst messages = AgoraChatComponent.getFakeList().map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\tthis.updateMessages(messages);\r\n\t\t\tMessageService.in$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(message => {\r\n\t\t\t\tmessage.clientId = message.clientId || StateService.state.uid;\r\n\t\t\t\t// console.log('AgoraChatComponent.MessageService.in$', message);\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// !!! only for demo\r\n\t\t} else {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.getChannelAttributes().pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(messages => {\r\n\t\t\t\t\tmessages = messages.map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\t// console.log('AgoraChatComponent.getChannelAttributes.messages', messages);\r\n\t\t\t\t\tthis.updateMessages(messages);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonView() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tconst message = this.createMessage(this.form.value.message);\r\n\t\tthis.sendMessage(message);\r\n\t\tthis.form.get('message').value = null;\r\n\t\tif (this.demo) {\r\n\t\t\tthis.randomMessage();\r\n\t\t}\r\n\t}\r\n\r\n\tcreateMessage(text) {\r\n\t\tconst message = new ChatMessage(text, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\tthis.pushMessage(message);\r\n\t\tconst agora = this.agora;\r\n\t\tif (agora) {\r\n\t\t\tagora.addOrUpdateChannelAttributes([message.getPayload()]).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe();\r\n\t\t}\r\n\t\tMessageService.send(message);\r\n\t}\r\n\r\n\tonClose(event) {\r\n\t\tthis.close.next();\r\n\t}\r\n\r\n\tscrollToBottom() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst scrollView = node.querySelector('.group--scrollview');\r\n\t\tscrollView.scrollTop = scrollView.scrollHeight;\r\n\t}\r\n\r\n\tpushMessage(message) {\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, this.messages);\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingBegin(message) {\r\n\t\t// console.log('AgoraChatComponent.typingBegin', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingEnd(message) {\r\n\t\t// console.log('AgoraChatComponent.typingEnd', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, messages);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\tremoveTyping(message, messages, recursive = true) {\r\n\t\tconst index = messages.reduce((p,c,i) => {\r\n\t\t\treturn (c.type === message.type && c.clientId === message.clientId) ? i : p;\r\n\t\t}, -1);\r\n\t\tif (index !== -1) {\r\n\t\t\tmessages.splice(index, 1);\r\n\t\t\tif (recursive === true) {\r\n\t\t\t\tthis.removeTyping(message, messages, true);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn index;\r\n\t}\r\n\r\n\tcheckTypings(changes) {\r\n\t\tconst typings = (changes.message && changes.message.length > 0);\r\n\t\t// console.log('AgoraChatComponent.checkTypings', typings);\r\n\t\tif (this.typings_ !== typings) {\r\n\t\t\tthis.typings_ = typings;\r\n\t\t\tif (typings) {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingBegin });\r\n\t\t\t} else {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingEnd });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tupdateMessages(messages) {\r\n\t\tthis.messages = messages;\r\n\t\tif (true) {\r\n\t\t\tthis.groupedMessages = [];\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t\tconst groupedMessages = [];\r\n\t\tmessages.forEach(message => {\r\n\t\t\tif (message.type === MessageType.ChatMessage) {\r\n\t\t\t\t// ChatMessage\r\n\t\t\t\tconst lastMessage = groupedMessages.length ? groupedMessages[groupedMessages.length - 1] : null;\r\n\t\t\t\tif (lastMessage && lastMessage.clientId === message.clientId) {\r\n\t\t\t\t\tlastMessage.message += `<br />${message.message}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tgroupedMessages.push(message.getCopy());\r\n\t\t\t\t}\r\n\t\t\t} else if (message.type === MessageType.ChatTypingBegin) {\r\n\t\t\t\t// ChatTypingBegin\r\n\t\t\t\tconst lastMessage = groupedMessages.reduce((p, c, i) => {\r\n\t\t\t\t\treturn (c.clientId === message.clientId) ? c : p;\r\n\t\t\t\t}, null);\r\n\t\t\t\tif (lastMessage) {\r\n\t\t\t\t\tlastMessage.typing = true;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('MessageType.ChatTypingBegin', lastMessage, message);\r\n\t\t\t}\r\n\t\t});\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.groupedMessages = groupedMessages;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log('AgoraChatComponent.updateMessages', messages, groupedMessages);\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.scrollToBottom();\r\n\t\t\t}, 1);\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid && this.form.value.message && this.form.value.message.length > 0;\r\n\t}\r\n\r\n\t// demo\r\n\r\n\trandomMessage() {\r\n\t\tsetTimeout(() => {\r\n\t\t\tconst message = this.createRandomMessage();\r\n\t\t\tthis.sendMessage(message);\r\n\t\t}, (1 + Math.random() * 5) * 1000);\r\n\t}\r\n\r\n\tcreateRandomMessage(text) {\r\n\t\tconst message = new ChatMessage({\r\n\t\t\tdate: Date.now(),\r\n\t\t\tclientId: '9fe0e1b9-6a6b-418b-b916-4bbff3eeb123',\r\n\t\t\tname: 'Herman frederick',\r\n\t\t\tmessage: 'Lorem ipsum dolor',\r\n\t\t}, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t}\r\n}\r\n\r\nAgoraChatComponent.meta = {\r\n\tselector: '[agora-chat]',\r\n\toutputs: ['close'],\r\n\tinputs: ['demo'],\r\n};\r\n\r\nAgoraChatComponent.getFakeList = () => {\r\n\tlet messages = [\r\n\t\t{\r\n\t\t\t\"date\": 1614592230000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Function-based web-enabled benchmark\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592240000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Customizable exuding superstructure\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592250000,\r\n\t\t\t\"name\": \"Gilles Pitkins\",\r\n\t\t\t\"message\": \"Synergistic interactive archive\",\r\n\t\t\t\"clientId\": \"cfe9ff5b-f7da-449d-bf5a-3184b5eba6ea\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592260000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Digitized client-server initiative\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592270000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Quality-focused tertiary open system\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592280000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Exclusive uniform middleware\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592290000,\r\n\t\t\t\"name\": \"John Pruckner\",\r\n\t\t\t\"message\": \"Decentralized disintermediate extranet\",\r\n\t\t\t\"clientId\": \"ae51e846-d043-41e9-bb5c-3189181e5b43\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592300000,\r\n\t\t\t\"name\": \"Lamont Georgievski\",\r\n\t\t\t\"message\": \"Enhanced static approach\",\r\n\t\t\t\"clientId\": \"1961cd9e-93aa-4bd0-b96a-89fcbd36b257\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592310000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Ergonomic clear-thinking info-mediaries\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592320000,\r\n\t\t\t\"name\": \"Jeri Pedroni\",\r\n\t\t\t\"message\": \"Grass-roots dynamic encryption\",\r\n\t\t\t\"clientId\": \"13d69bba-3656-449b-8fe3-d7a87062b044\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592330000,\r\n\t\t\t\"name\": \"Frederik Dechelle\",\r\n\t\t\t\"message\": \"Compatible disintermediate policy\",\r\n\t\t\t\"clientId\": \"9151ebe0-efa8-40b4-a341-b8fd489e9c88\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592340000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Inverse user-facing adapter\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592350000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Future-proofed even-keeled application\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592360000,\r\n\t\t\t\"name\": \"Cassie Jonathon\",\r\n\t\t\t\"message\": \"Profit-focused content-based budgetary management\",\r\n\t\t\t\"clientId\": \"5b3dc6f3-2a3d-493d-aac5-66ddfce2d709\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592370000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Managed intermediate monitoring\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592380000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Exclusive client-server encoding\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592390000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Cross-group system-worthy matrices\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592400000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Upgradable encompassing benchmark\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592410000,\r\n\t\t\t\"name\": \"Emelen Beevors\",\r\n\t\t\t\"message\": \"Function-based full-range knowledge base\",\r\n\t\t\t\"clientId\": \"c93aea47-ebd8-4e5e-88fd-52053dd35cd1\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592420000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Synergistic system-worthy capability\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t}\r\n\t];\r\n\twhile (messages.length < 100) {\r\n\t\tmessages = messages.concat(messages);\r\n\t}\r\n\t// return messages;\r\n\treturn messages.slice(0, 5);\r\n}\r\n","import { Component } from 'rxcomp';\r\n\r\nexport default class AgoraCheckComponent extends Component {}\r\n\r\nAgoraCheckComponent.meta = {\r\n\tselector: '[agora-check]',\r\n\tinputs: ['value'],\r\n\ttemplate: /* html */ `\r\n\t\t<svg *if=\"value == null\" class=\"checkmark idle\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === true\" class=\"checkmark success\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" fill=\"none\" d=\"M14.1 27.2l7.1 7.2 16.7-16.8\" stroke-linecap=\"round\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === false\" class=\"checkmark error\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" stroke-linecap=\"round\" fill=\"none\" d=\"M16 16 36 36 M36 16 16 36\"/>\r\n\t\t</svg>\r\n\t`\r\n};\r\n","\r\nexport const DevicePlatform = {\r\n\tUnknown: 'unknown',\r\n\tIOS: 'ios',\r\n\tAndroid: 'android',\r\n\tWindowsPhone: 'windowsPhone',\r\n\tVRHeadset: 'vrHeadset',\r\n};\r\n\r\nexport class DeviceService {\r\n\r\n\tstatic get platform() {\r\n\t\tif (!this.platform_) {\r\n\t\t\tthis.platform_ = this.getDevicePlatform();\r\n\t\t}\r\n\t\treturn this.platform_;\r\n\t}\r\n\r\n\tstatic get isIOS() {\r\n\t\treturn ['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'].indexOf(navigator.platform) !== -1\r\n\t\t\t// iPad on iOS 13 detection\r\n\t\t\t|| (navigator.userAgent.indexOf('Mac') !== -1 && 'ontouchend' in document);\r\n\t}\r\n\r\n\tstatic get isVRHeadset() {\r\n\t\treturn navigator.userAgent.indexOf('VR') !== -1 || navigator.userAgent.indexOf('Quest') !== -1 || navigator.userAgent.indexOf('Oculus') !== -1;\r\n\t}\r\n\r\n\tstatic getDevicePlatform() {\r\n\t\tconst userAgent = navigator.userAgent || navigator.vendor || window.opera;\r\n\t\t// Windows Phone must come first because its UA also contains 'Android'\r\n\t\tif (/windows phone/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.WindowsPhone;\r\n\t\t}\r\n\t\tif (/android/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.Android;\r\n\t\t}\r\n\t\t// iOS detection from: http://stackoverflow.com/a/9039885/177710\r\n\t\t// if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {\r\n\t\tif (this.isIOS) {\r\n\t\t\treturn DevicePlatform.IOS;\r\n\t\t}\r\n\t\tif (this.isVRHeadset) {\r\n\t\t\treturn DevicePlatform.VRHeadset;\r\n\t\t}\r\n\t\treturn DevicePlatform.Unknown;\r\n\t}\r\n\r\n}\r\n","import { Component } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { DeviceService } from '../device/device.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport LocalStorageService from '../local-storage/local-storage.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\nimport AgoraService from './agora.service';\r\n\r\nconst TIMEOUT = 100;\r\n\r\nexport default class AgoraChecklistComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform; // !!!\r\n\t\tthis.checklist = {};\r\n\t\tthis.errors = {};\r\n\t\tthis.state = {};\r\n\t\tthis.busy = true;\r\n\t\tthis.shouldCheckDevices = true;\r\n\t\tLocalStorageService.set('checklist', false);\r\n\t\tStateService.state$.pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(state => {\r\n\t\t\tconsole.log('AgoraChecklistComponent', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tif (state.role === RoleType.Viewer) {\r\n\t\t\t\tthis.shouldCheckDevices = false;\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.checkBrowser();\r\n\t\t\t}, 1000);\r\n\t\t});\r\n\t}\r\n\r\n\tcheckBrowser() {\r\n\t\tconst browser = AgoraRTC.checkSystemRequirements();\r\n\t\tthis.checklist.browser = browser;\r\n\t\tif (browser) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.checkHttps();\r\n\t\t\t}, TIMEOUT);\r\n\t\t} else {\r\n\t\t\tthis.errors.browser = LabelPipe.transform('bhere_browser_error');\r\n\t\t\tthis.checkHttps(true);\r\n\t\t\tthis.checkAudio(true);\r\n\t\t\tthis.checkVideo(true);\r\n\t\t\tthis.checkRtc(true);\r\n\t\t\tthis.checkRtm(true);\r\n\t\t}\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tcheckHttps(skip) {\r\n\t\tconst https = window.location.protocol === 'https:';\r\n\t\tthis.checklist.https = https;\r\n\t\tif (skip) {\r\n\t\t\tif (!https) {\r\n\t\t\t\tthis.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\t}\r\n\t\t} else if (https) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tif (this.shouldCheckDevices) {\r\n\t\t\t\t\tthis.checkAudio();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}\r\n\t\t\t}, TIMEOUT);\r\n\t\t\tthis.pushChanges();\r\n\t\t} else {\r\n\t\t\tthis.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\tthis.checkAudio(true);\r\n\t\t\tthis.checkVideo(true);\r\n\t\t\tthis.checkRtc(true);\r\n\t\t\tthis.checkRtm(true);\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tcheckAudio(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.audio = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t// console.log('checkAudio', devices);\r\n\t\t\t\tconst audioinput = devices.find(x => x.kind === 'audioinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.audio = audioinput != null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.audio = false;\r\n\t\t\t\tthis.errors.audio = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\tconsole.log('checkAudio', devices);\r\n\t\t\t\tconst audioinput = devices.find(x => x.kind === 'audioinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.audio = audioinput != null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}, (error) => {\r\n\t\t\t\tthis.checklist.audio = false;\r\n\t\t\t\tthis.errors.audio = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tcheckVideo(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.video = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t// console.log('checkVideo', devices);\r\n\t\t\t\tconst videoinput = devices.find(x => x.kind === 'videoinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.video = videoinput != null;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.video = false;\r\n\t\t\t\tthis.errors.video = error;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\tconsole.log('checkVideo', devices);\r\n\t\t\t\tconst videoinput = devices.find(x => x.kind === 'videoinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.video = videoinput != null;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, (error) => {\r\n\t\t\t\tthis.checklist.video = false;\r\n\t\t\t\tthis.errors.video = error;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tcheckRtc(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.rtc = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.checkRtcConnection().then(uid => {\r\n\t\t\t\tthis.checklist.rtc = true;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtm(false, uid);\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.rtc = false;\r\n\t\t\t\tthis.errors.rtc = error;\r\n\t\t\t\tthis.checkRtm(true);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tcheckRtm(skip, uid) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.rtm = false;\r\n\t\t\tthis.onComplete();\r\n\t\t} else {\r\n\t\t\tAgoraService.checkRtmConnection(uid).then(_ => {\r\n\t\t\t\tthis.checklist.rtm = true;\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.rtm = false;\r\n\t\t\t\tthis.errors.rtm = error;\r\n\t\t\t}).finally(() => {\r\n\t\t\t\tthis.onComplete();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonComplete() {\r\n\t\tconsole.log('AgoraChecklistComponent.onComplete');\r\n\t\tconst success = Object.keys(this.checklist).reduce((p, c) => {\r\n\t\t\treturn p && this.checklist[c];\r\n\t\t}, true);\r\n\t\tthis.checklist.success = success;\r\n\t\tthis.checklist.error = !success;\r\n\t\tthis.busy = false;\r\n\t\tthis.pushChanges();\r\n\t\tif (state.role === RoleType.SmartDevice) {\r\n\t\t\tthis.onNext();\r\n\t\t}\r\n\t}\r\n\r\n\tonNext() {\r\n\t\tif (this.checklist.success) {\r\n\t\t\tLocalStorageService.set('checklist', true);\r\n\t\t}\r\n\t\tthis.checked.next(this.checklist);\r\n\t}\r\n\r\n\topenHttps() {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n}\r\n\r\nAgoraChecklistComponent.meta = {\r\n\tselector: '[agora-checklist]',\r\n\toutputs: ['checked'],\r\n};\r\n","import { BehaviorSubject, Observable, of } from \"rxjs\";\r\nimport { expand, filter, finalize, map, share, tap, withLatestFrom } from \"rxjs/operators\";\r\n\r\nconst BUFF_SIZE = 512;\r\n\r\nexport default class AudioStreamService {\r\n\r\n\tstatic get context() {\r\n\t\tif (!this.context_ && 'AudioContext' in window) {\r\n\t\t\tthis.context_ = new AudioContext();\r\n\t\t}\r\n\t\treturn this.context_;\r\n\t}\r\n\r\n\t/*\r\n\tstatic get processorNode() {\r\n\t\tif (!this.processorNode_) {\r\n\t\t\tthis.processorNode_ = this.context.createScriptProcessor(BUFF_SIZE, 1, 1);\r\n\t\t}\r\n\t\treturn this.processorNode_;\r\n\t}\r\n\t*/\r\n\r\n\t/*\r\n\tstatic get gain() {\r\n\t\tif (!this.gain_) {\r\n\t\t\tthis.gain_ = this.context.createGain();\r\n\t\t}\r\n\t\treturn this.gain_;\r\n\t}\r\n\t*/\r\n\r\n\tstatic get analyser() {\r\n\t\tif (!this.analyser_) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.analyser_ = this.context.createAnalyser();\r\n\t\t\t} catch(error) {\r\n\t\t\t\tconsole.log('AudioStreamService.analyser', error);\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn this.analyser_;\r\n\t}\r\n\r\n\tstatic addSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\tif (!this.sources_[key]) {\r\n\t\t\tif (streamOrElement instanceof MediaStream) {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaStreamSource(streamOrElement.clone());\r\n\t\t\t} else {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaElementSource(streamOrElement);\r\n\t\t\t}\r\n\t\t\t// this.sources_[key] = streamOrElement instanceof MediaStream ? this.context.createMediaStreamSource(streamOrElement) : this.context.createMediaElementSource(streamOrElement);\r\n\t\t}\r\n\t\treturn this.sources_[key];\r\n\t}\r\n\r\n\tstatic removeSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\treturn this.removeSourceKey(key);\r\n\t}\r\n\r\n\tstatic removeSourceKey(key) {\r\n\t\t// console.log('AudioStreamService.removeSourceKey', key);\r\n\t\tlet source;\r\n\t\tif (this.sources_[key]) {\r\n\t\t\tsource = this.sources_[key];\r\n\t\t\t/*\r\n\t\t\tif (source.mediaStream) {\r\n\t\t\t\tsource.mediaStream.stop();\r\n\t\t\t}\r\n\t\t\tsource.stop();\r\n\t\t\t*/\r\n\t\t\tif (this.analyser) {\r\n\t\t\t\tsource.disconnect(this.analyser);\r\n\t\t\t}\r\n\t\t\tsource.disconnect();\r\n\t\t\tdelete this.sources_[key];\r\n\t\t}\r\n\t\treturn source;\r\n\t}\r\n\r\n\tstatic frequency$(streamOrElement, fftSize = 64) {\r\n\t\tif (fftSize % 2 === 1) {\r\n\t\t\tthrow ('AudioStreamService.error', 'wrong fftSize', fftSize);\r\n\t\t}\r\n\t\tconst state = new Uint8Array(fftSize / 2);\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst analyser = this.analyser;\r\n\t\t\tif (analyser) {\r\n\t\t\t\t// Connect the output of the analyser to the destination\r\n\t\t\t\t// analyser.connect(context.destination); // no audio !\r\n\t\t\t\t// console.log(analyser.fftSize); // 2048 by default\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // will give us 1024 data points\r\n\t\t\t\tanalyser.fftSize = fftSize; // 64\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // fftSize/2 = 32 data points\r\n\t\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\t\t// source.connect(context.destination); // no audio!\r\n\t\t\t\t// Connect the output of the source to the input of the analyser\r\n\t\t\t\tsource.connect(analyser);\r\n\t\t\t}\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tif (analyser) {\r\n\t\t\t\t\t\t// Get the new frequency data\r\n\t\t\t\t\t\tanalyser.getByteFrequencyData(state);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tconst max = state.reduce((p, c, i) => {\r\n\t\t\t\t\t\t\treturn Math.max(c, p);\r\n\t\t\t\t\t\t}, 0);\r\n\t\t\t\t\t\tif (max > 0) {\r\n\t\t\t\t\t\t\t// console.log(max);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t// Update the visualisation\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic volume$(streamOrElement) {\r\n\t\tconst state = { volume: 0, clipped: false };\r\n\t\tconst context = this.context;\r\n\t\t// console.log('AudioStreamService.volume$', context, state);\r\n\t\tif (context) {\r\n\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\tconst meter = AudioStreamService.audioMeterCreate();\r\n\t\t\tsource.connect(meter);\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tstate.clipped = meter.checkClipping();\r\n\t\t\t\t\tstate.volume = meter.volume;\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic audioMeterCreate(clipLevel = 0.98, averaging = 0.95, clipLag = 750) {\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst processor = context.createScriptProcessor(512);\r\n\t\t\tprocessor.onaudioprocess = this.audioMeterProcess;\r\n\t\t\tprocessor.checkClipping = this.audioMeterClip;\r\n\t\t\tprocessor.dispose = this.audioMeterDispose;\r\n\t\t\tprocessor.clipping = false;\r\n\t\t\tprocessor.lastClip = 0;\r\n\t\t\tprocessor.volume = 0;\r\n\t\t\tprocessor.clipLevel = clipLevel;\r\n\t\t\tprocessor.averaging = averaging;\r\n\t\t\tprocessor.clipLag = clipLag;\r\n\t\t\t// this will have no effect, since we don't copy the input to the output,\r\n\t\t\t// but works around a current Chrome bug.\r\n\t\t\tprocessor.connect(context.destination);\r\n\t\t\treturn processor;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic audioMeterProcess(event) {\r\n\t\tconst buffer = event.inputBuffer.getChannelData(0);\r\n\t\tconst bufferLength = buffer.length;\r\n\t\tlet sum = 0;\r\n\t\tlet x;\r\n\r\n\t\t// Do a root-mean-square on the samples: sum up the squares...\r\n\t\tfor (let i = 0; i < bufferLength; i++) {\r\n\t\t\tx = buffer[i];\r\n\t\t\tif (Math.abs(x) >= this.clipLevel) {\r\n\t\t\t\tthis.clipping = true;\r\n\t\t\t\tthis.lastClip = window.performance.now();\r\n\t\t\t}\r\n\t\t\tsum += x * x;\r\n\t\t}\r\n\r\n\t\t// ... then take the square root of the sum.\r\n\t\tconst rms = Math.sqrt(sum / bufferLength);\r\n\r\n\t\t// Now smooth this out with the averaging factor applied\r\n\t\t// to the previous sample - take the max here because we\r\n\t\t// want \"fast attack, slow release.\"\r\n\t\tthis.volume = Math.max(rms, this.volume * this.averaging);\r\n\t}\r\n\r\n\tstatic audioMeterClip() {\r\n\t\tif (!this.clipping) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif ((this.lastClip + this.clipLag) < window.performance.now()) {\r\n\t\t\tthis.clipping = false;\r\n\t\t}\r\n\t\treturn this.clipping;\r\n\t}\r\n\r\n\tstatic audioMeterDispose() {\r\n\t\tthis.disconnect();\r\n\t\tthis.onaudioprocess = null;\r\n\t}\r\n\r\n\tstatic step$(previous) {\r\n\t\t/**\r\n\t\t * This function returns an observable that will emit the next frame once the\r\n\t\t * browser has returned an animation frame step. Given the previous frame it calculates\r\n\t\t * the delta time, and we also clamp it to 30FPS in case we get long frames.\r\n\t\t */\r\n\t\treturn Observable.create((observer) => {\r\n\t\t\trequestAnimationFrame((startTime) => {\r\n\t\t\t\t// Millis to seconds\r\n\t\t\t\tconst deltaTime = previous ? (startTime - previous.startTime) / 1000 : 0;\r\n\t\t\t\tobserver.next({\r\n\t\t\t\t\tstartTime,\r\n\t\t\t\t\tdeltaTime\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}).pipe(\r\n\t\t\tmap(frame => {\r\n\t\t\t\tif (frame.deltaTime > (1 / 30)) {\r\n\t\t\t\t\tframe.deltaTime = 1 / 30;\r\n\t\t\t\t}\r\n\t\t\t\treturn frame;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dispose() {\r\n\t\tObject.keys(this.sources_).forEach(key => {\r\n\t\t\tthis.removeSourceKey(key);\r\n\t\t});\r\n\t\tconst analyser = this.analyser;\r\n\t\tif (analyser) {\r\n\t\t\tanalyser.disconnect();\r\n\t\t}\r\n\t\tthis.sources_ = {};\r\n\t\t// this.context_.close().then(() => console.log('AudioStreamService.dispose'));\r\n\t\t// this.context_ = null;\r\n\t}\r\n\r\n}\r\n\r\nAudioStreamService.sources_ = {};\r\nAudioStreamService.frame$ = of(undefined).pipe(\r\n\texpand((value) => AudioStreamService.step$(value)),\r\n\t// Expand emits the first value provided to it, and in this\r\n\t//  case we just want to ignore the undefined input frame\r\n\tfilter(frame => frame !== undefined),\r\n\tmap(frame => frame.deltaTime),\r\n\tshare()\r\n);\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport AudioStreamService from '../audio/audio-stream.service';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport StateService from '../state/state.service';\r\nimport { getStreamQuality } from './agora.types';\r\n\r\nexport default class AgoraDevicePreviewComponent extends Component {\r\n\r\n\tget video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tset video(video) {\r\n\t\tif (this.video_ !== video) {\r\n\t\t\tthis.video_ = video;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget audio() {\r\n\t\treturn this.audio_;\r\n\t}\r\n\r\n\tset audio(audio) {\r\n\t\tif (this.audio_ !== audio) {\r\n\t\t\tthis.audio_ = audio;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.init();\r\n\t}\r\n\r\n\tinit() {\r\n\t\tif (this.initialized_) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.initialized_ = true;\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\tconst preview = this.preview = node.querySelector('video');\r\n\t\tpreview.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tconst audio = node.querySelector('.audio');\r\n\t\tif (this.hasPreview) {\r\n\t\t\tconst bars = this.bars = new Array(32).fill(0).map(x => {\r\n\t\t\t\tconst bar = document.createElement('div');\r\n\t\t\t\tbar.classList.add('bar');\r\n\t\t\t\taudio.appendChild(bar);\r\n\t\t\t\treturn bar;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tconst preview = this.preview;\r\n\t\tpreview.removeEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tif (this.hasPreview) {\r\n\t\t\tAudioStreamService.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tinitStream() {\r\n\t\tconst preview = this.preview;\r\n\t\tif (!this.preview) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// console.log(this.video_, this.audio_);\r\n\t\tif (this.video_ || this.audio_) {\r\n\t\t\t// const { node } = getContext(this);\r\n\t\t\t// node.classList.remove('ready');\r\n\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\tconst state = StateService.state;\r\n\t\t\t\tconst quality = getStreamQuality(state);\r\n\t\t\t\tconst options = {\r\n\t\t\t\t\tvideo: this.video_ ? {\r\n\t\t\t\t\t\tdeviceId: this.video_,\r\n\t\t\t\t\t\twidth: { ideal: quality.resolution.width },\r\n\t\t\t\t\t\theight: { ideal: quality.resolution.height },\r\n\t\t\t\t\t\tframeRate: { ideal: quality.frameRate.min, max: quality.frameRate.max },\r\n\t\t\t\t\t} : false,\r\n\t\t\t\t\taudio: this.audio_ ? { deviceId: this.audio_ } : false,\r\n\t\t\t\t};\r\n\t\t\t\t// console.log('AgoraDevicePreviewComponent.initStream.getUserMedia', options);\r\n\t\t\t\tnavigator.mediaDevices.getUserMedia(options).then((stream) => {\r\n\t\t\t\t\tif (this.hasPreview) {\r\n\t\t\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\t\t\tpreview.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpreview.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.audio_) {\r\n\t\t\t\t\t\t\tthis.analyzeData(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.loadingStream_ = stream;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.stream.next(stream);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\tconsole.log('AgoraDevicePreviewComponent.initStream.error', error.name, error.message);\r\n\t\t\t\t\tthis.stream.next(null);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (this.hasPreview) {\r\n\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\tpreview.srcObject = null;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpreview.src = null;\r\n\t\t\t\t}\r\n\t\t\t\tthis.analyzeData(null);\r\n\t\t\t}\r\n\t\t\tthis.stream.next(null);\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraDevicePreview.onLoadedMetadata', event);\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('ready');\r\n\t\tthis.preview.play();\r\n\t\tthis.stream.next(this.loadingStream_);\r\n\t}\r\n\r\n\tanalyzeData(stream) {\r\n\t\tif (this.frequencySubscription) {\r\n\t\t\tthis.frequencySubscription.unsubscribe();\r\n\t\t}\r\n\t\t// console.log('AgoraDevicePreviewComponent.analyzeData', stream);\r\n\t\tif (stream) {\r\n\t\t\tthis.frequencySubscription = AudioStreamService.frequency$(stream, 64).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(frequency => {\r\n\t\t\t\t// 32 data points\r\n\t\t\t\t// console.log(frequency);\r\n\t\t\t\tconst spacing = 100 / 32;\r\n\t\t\t\tconst bars = this.bars;\r\n\t\t\t\tbars.forEach((bar, i) => {\r\n\t\t\t\t\tconst pow = Math.min(100, (5 + frequency[i])) / 100;\r\n\t\t\t\t\tbar.style.left = i * spacing + '%';\r\n\t\t\t\t\tbar.style.transform = `scale(1,${pow})`;\r\n\t\t\t\t\tbar.style.opacity = pow;\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nAgoraDevicePreviewComponent.meta = {\r\n\tselector: '[agora-device-preview]',\r\n\toutputs: ['stream', 'change'],\r\n\tinputs: ['video', 'audio']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\n\r\nexport default class AgoraDeviceComponent extends Component {\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset; // && this.form && this.form.value.video;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.isHttps = window.location.protocol === 'https:';\r\n\t\tthis.state = {};\r\n\t\tthis.devices = { videos: [], audios: [] };\r\n\t\tthis.stream = null;\r\n\t\tthis.form = null;\r\n\t\tif (this.isHttps) {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tStateService.state$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(state => {\r\n\t\t\t\t// console.log('AgoraDeviceComponent.state', state);\r\n\t\t\t\tthis.state = state;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.devices$().subscribe(devices => {\r\n\t\t\t\t\t// console.log(devices);\r\n\t\t\t\t\tthis.devices = devices;\r\n\t\t\t\t\tthis.initForm(devices);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\topenHttps(event) {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n\r\n\tinitForm(devices) {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tvideo: new FormControl(null, devices.videos.length ? Validators.RequiredValidator() : undefined),\r\n\t\t\taudio: new FormControl(null, devices.audios.length ? Validators.RequiredValidator() : undefined),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tconst videoOptions = devices.videos.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (videoOptions.length > 0) {\r\n\t\t\tvideoOptions.unshift({\r\n\t\t\t\tid: null, name: LabelPipe.transform('bhere_select_video')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.video.options = videoOptions;\r\n\t\tconst audioOptions = devices.audios.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (audioOptions.length > 0) {\r\n\t\t\taudioOptions.unshift({\r\n\t\t\t\tid: null, name: LabelPipe.transform('bhere_select_audio')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.audio.options = audioOptions;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraDeviceComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonStreamDidChange(event) {\r\n\t\tthis.stream = null;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonStream(stream) {\r\n\t\tthis.stream = stream;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid && (this.stream || !this.hasPreview);\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonEnter(event) {\r\n\t\tconst preferences = this.form.value;\r\n\t\tconst devices = this.devices;\r\n\t\tdevices.video = devices.videos.find(x => x.deviceId === preferences.video);\r\n\t\tdevices.audio = devices.audios.find(x => x.deviceId === preferences.audio);\r\n\t\tthis.enter.next(devices);\r\n\t}\r\n\r\n}\r\n\r\nAgoraDeviceComponent.meta = {\r\n\tselector: '[agora-device]',\r\n\toutputs: ['enter'],\r\n};\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport default class AgoraLinkComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.state = {};\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tlink: new FormControl(null, [Validators.PatternValidator(/^\\d{9}-\\d{4}-\\d{13}$/), Validators.RequiredValidator()]),\r\n\t\t\tlinkAttendee: null,\r\n\t\t\tlinkStreamer: null,\r\n\t\t\tlinkViewer: null,\r\n\t\t\tlinkSmartDevice: null,\r\n\t\t\t// link: new FormControl(null),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraLinkComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraLinkComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonGenerateMeetingId($event) {\r\n\t\t// const timestamp = (performance.now() * 10000000000000).toString();\r\n\t\tconst timestamp = new Date().valueOf().toString();\r\n\t\tthis.form.patch({\r\n\t\t\tlink: this.getRoleMeetingId(timestamp, RoleType.Publisher),\r\n\t\t\tlinkAttendee: this.getRoleMeetingId(timestamp, RoleType.Attendee),\r\n\t\t\tlinkStreamer: this.getRoleMeetingId(timestamp, RoleType.Streamer),\r\n\t\t\tlinkViewer: this.getRoleMeetingId(timestamp, RoleType.Viewer),\r\n\t\t\tlinkSmartDevice: this.getRoleMeetingId(timestamp, RoleType.SmartDevice),\r\n\t\t});\r\n\t}\r\n\r\n\treplaceRoleMeetingId(meetingId, role) {\r\n\t\tconst components = meetingId.split('-');\r\n\t\tcomponents[1] = this.padded(this.getRoleIndex(role), 4);\r\n\t\treturn components.join('-');\r\n\t}\r\n\r\n\tonInputDidChange($event) {\r\n\t\t// console.log('onInputDidChange', this.form.get('link').value, this.form.get('link').valid);\r\n\t\tif (this.state.role !== 'publisher') {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsetTimeout(() => {\r\n\t\t\tif (this.form.get('link').valid) {\r\n\t\t\t\tconst value = this.form.get('link').value;\r\n\t\t\t\tthis.form.patch({\r\n\t\t\t\t\tlink: this.setRoleMeetingId(value, RoleType.Publisher),\r\n\t\t\t\t\tlinkAttendee: this.setRoleMeetingId(value, RoleType.Attendee),\r\n\t\t\t\t\tlinkStreamer: this.setRoleMeetingId(value, RoleType.Streamer),\r\n\t\t\t\t\tlinkViewer: this.setRoleMeetingId(value, RoleType.Viewer),\r\n\t\t\t\t\tlinkSmartDevice: this.setRoleMeetingId(value, RoleType.SmartDevice),\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tthis.form.get('linkAttendee').reset();\r\n\t\t\t\tthis.form.get('linkStreamer').reset();\r\n\t\t\t\tthis.form.get('linkViewer').reset();\r\n\t\t\t}\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tsetRoleMeetingId(meetingId, role) {\r\n\t\tconst meetingIdSegments = meetingId.split('-');\r\n\t\treturn `${meetingIdSegments[0]}-${this.padded(this.getRoleIndex(role), 4)}-${meetingIdSegments[2]}`;\r\n\t}\r\n\r\n\tgetRoleMeetingId(timestamp, role) {\r\n\t\treturn `${this.padded(this.state.user.id, 9)}-${this.padded(this.getRoleIndex(role), 4)}-${timestamp}`;\r\n\t}\r\n\r\n\tgetRoleIndex(role) {\r\n\t\treturn Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\treturn RoleType[c] === role ? i : p;\r\n\t\t}, -1);\r\n\t}\r\n\r\n\tonCopyToClipBoard(meetingId, asAccessCode = false) {\r\n\t\tconst input = document.createElement('input');\r\n\t\tinput.style.position = 'absolute';\r\n\t\tinput.style.top = '1000vh';\r\n\t\t// input.style.visibility = 'hidden';\r\n\t\tdocument.querySelector('body').appendChild(input);\r\n\t\tinput.value = asAccessCode ? this.getAccessCodeUrl(meetingId, true) : this.getUrl(meetingId, true);\r\n\t\tinput.focus();\r\n\t\tinput.select();\r\n\t\tinput.setSelectionRange(0, 99999);\r\n\t\tdocument.execCommand('copy');\r\n\t\tinput.parentNode.removeChild(input);\r\n\t\talert(`link copiato!\\n ${input.value}`);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tlet meetingId = this.controls.link.value;\r\n\t\t/*\r\n\t\tif (this.state.role === RoleType.Publisher) {\r\n\t\t\tmeetingId = this.replaceRoleMeetingId(meetingId, RoleType.Publisher);\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.replaceUrl(meetingId);\r\n\t\tthis.link.next(meetingId);\r\n\t}\r\n\r\n\tgetUrl(meetingId, shareable = false) {\r\n\t\tconst role = LocationService.get('role') || null;\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${meetingId}` + (name ? `&name=${name}` : '') + ((role && !shareable) ? `&role=${role}` : '');\r\n\t\treturn url;\r\n\t}\r\n\r\n\tgetAccessCodeUrl(meetingId, shareable = false) {\r\n\t\tconst role = LocationService.get('role') || null;\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tconst url = `${window.location.origin}${environment.url.accessCode}?link=${meetingId}` + (name ? `&name=${name}` : '') + ((role && !shareable) ? `&role=${role}` : '');\r\n\t\treturn url;\r\n\t}\r\n\r\n\treplaceUrl(meetingId) {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst url = this.getUrl(meetingId);\r\n\t\t\t// console.log('AgoraLinkComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n\r\n\tpadded(num, size) {\r\n\t\tconst s = '000000000' + num;\r\n\t\treturn s.substr(s.length - size);\r\n\t}\r\n}\r\n\r\nAgoraLinkComponent.meta = {\r\n\tselector: '[agora-link]',\r\n\toutputs: ['link'],\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { UserService } from '../user/user.service';\r\n\r\nexport default class AgoraLoginComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tthis.form.patch({\r\n\t\t\tusername: 'publisher',\r\n\t\t\tpassword: 'publisher',\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: ''\r\n\t\t});\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tthis.error = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tUserService.login$(payload).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(user => {\r\n\t\t\t\tif (StateService.state.role === user.type) {\r\n\t\t\t\t\t// this.login.next(user);\r\n\t\t\t\t\tthis.onNext(user);\r\n\t\t\t\t\tthis.form.reset();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.error = { friendlyMessage: LabelPipe.transform('error_credentials') };\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(user) {\r\n\t\tthis.replaceUrl(user);\r\n\t\tthis.login.next(user);\r\n\t}\r\n\r\n\treplaceUrl(user) {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst role = LocationService.get('role') || null;\r\n\t\t\tconst link = LocationService.get('link') || null;\r\n\t\t\tconst name = LocationService.get('name') || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}`\r\n\t\t\t\t+ (name ? `&name=${name}` : '')\r\n\t\t\t\t+ (role ? `&role=${role}` : '');\r\n\t\t\t// console.log('AgoraLoginComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nAgoraLoginComponent.meta = {\r\n\tselector: '[agora-login]',\r\n\toutputs: ['login'],\r\n};\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\n\r\nexport default class AgoraNameComponent extends Component {\r\n\tonInit() {\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tthis.state = {};\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(name, [Validators.PatternValidator(/^\\w{2,}\\s\\w{2,}/), Validators.RequiredValidator()]),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraNameComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraNameComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tthis.replaceUrl();\r\n\t\tthis.name.next(this.controls.name.value);\r\n\t}\r\n\r\n\treplaceUrl() {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst role = LocationService.get('role') || null;\r\n\t\t\tconst link = LocationService.get('link') || null;\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}&name=${this.controls.name.value}` + (role ? `&role=${role}` : '');\r\n\t\t\t// console.log('AgoraNameComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nAgoraNameComponent.meta = {\r\n\tselector: '[agora-name]',\r\n\toutputs: ['name'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, MessageType } from './agora.types';\r\n\r\nexport default class AgoraStreamComponent extends Component {\r\n\r\n\tset videoMuted(videoMuted) {\r\n\t\tif (this.videoMuted_ !== videoMuted) {\r\n\t\t\tthis.videoMuted_ = videoMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tvideoMuted ? node.classList.add('video--muted') : node.classList.remove('video--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tset audioMuted(audioMuted) {\r\n\t\tif (this.audioMuted_ !== audioMuted) {\r\n\t\t\tthis.audioMuted_ = audioMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\taudioMuted ? node.classList.add('audio--muted') : node.classList.remove('audio--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tget streamId() {\r\n\t\treturn this.streamId_;\r\n\t}\r\n\r\n\tset streamId(streamId) {\r\n\t\tthis.streamId_ = streamId;\r\n\t}\r\n\r\n\tget stream() {\r\n\t\treturn this.stream_;\r\n\t}\r\n\r\n\tset stream(stream) {\r\n\t\tif (this.stream_ !== stream) {\r\n\t\t\t// console.log('AgoraStreamComponent set stream', stream);\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst player = this.player = node.querySelector('.agora-stream__player');\r\n\t\t\twhile (player.childElementCount > 0) {\r\n\t\t\t\tplayer.removeChild(player.firstElementChild);\r\n\t\t\t}\r\n\t\t\t// player.textContent = '';\r\n\t\t\tif (this.stream_ && this.stream_.isPlaying() && this.stream_.player.div.parentNode === player) {\r\n\t\t\t\t// console.log('AgoraStreamComponent stopping stream', this.stream_.getId(), 'on', this.stream_.player.div.parentNode);\r\n\t\t\t\tthis.stream_.stop();\r\n\t\t\t}\r\n\t\t\tthis.stream_ = stream;\r\n\t\t\tif (stream) {\r\n\t\t\t\tthis.videoMuted = stream.userMuteVideo;\r\n\t\t\t\tthis.audioMuted = stream.userMuteAudio;\r\n\t\t\t}\r\n\t\t\tconst streamId = stream ? stream.getId() : null;\r\n\t\t\tthis.streamId = streamId;\r\n\t\t\t// console.log('AgoraStreamComponent streamId', streamId);\r\n\t\t\tif (streamId) {\r\n\t\t\t\tconst name = `stream-${streamId}`;\r\n\t\t\t\tplayer.setAttribute('id', name);\r\n\t\t\t\tconst self = this;\r\n\t\t\t\tif (stream.isPlaying()) {\r\n\t\t\t\t\tplayer.appendChild(stream.player.div);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.shouldUseResumeGesture = false;\r\n\t\t\t\t\tstream.play(name, { fit: 'cover' }, (error) => {\r\n\t\t\t\t\t\tif (error && error.status !== 'aborted') {\r\n\t\t\t\t\t\t\t// The playback fails, probably due to browser policy. You can resume the playback by user gesture.\r\n\t\t\t\t\t\t\tself.shouldUseResumeGesture = true;\r\n\t\t\t\t\t\t\tself.pushChanges();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tplayer.removeAttribute('id');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tset vrContainer(vrContainer) {\r\n\t\tif (this.vrContainer_ !== vrContainer) {\r\n\t\t\tthis.vrContainer_ = vrContainer;\r\n\t\t\tif (vrContainer) {\r\n\t\t\t\tthis.stream_.vrContainer = vrContainer;\r\n\t\t\t\tthis.player.appendChild(vrContainer);\r\n\t\t\t} else if (this.stream_.vrContainer && this.stream_.vrContainer.parentNode) {\r\n\t\t\t\tthis.stream_.vrContainer.parentNode.removeChild(this.stream_.vrContainer);\r\n\t\t\t\tthis.stream_.vrContainer = null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget videoNode() {\r\n\t\tlet videoNode = this.videoNode_;\r\n\t\tif (!videoNode) {\r\n\t\t\tconst player = getContext(this).node.querySelector('.agora-stream__player');\r\n\t\t\tvideoNode = document.createElement('video');\r\n\t\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\t\tvideoNode.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\t\tplayer.appendChild(videoNode);\r\n\t\t\tthis.videoNode_ = videoNode;\r\n\t\t}\r\n\t\treturn videoNode;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.videoMuted = false;\r\n\t\tthis.audioMuted = false;\r\n\t\tthis.shouldUseResumeGesture = false;\r\n\t\tthis.state = {};\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log('AgoraStreamComponent.StateService.state$', this.streamId, state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraStreamComponent.MessageService.out$', this.streamId, message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.AgoraEvent:\r\n\t\t\t\t\tconst event = message.event;\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.AgoraEvent', message.event);\r\n\t\t\t\t\tif (this.streamId && event.streamId === this.streamId) {\r\n\t\t\t\t\t\tif (event instanceof AgoraMuteVideoEvent) {\r\n\t\t\t\t\t\t\tthis.videoMuted = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraUnmuteVideoEvent) {\r\n\t\t\t\t\t\t\tthis.videoMuted = false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraMuteAudioEvent) {\r\n\t\t\t\t\t\t\tthis.audioMuted = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraUnmuteAudioEvent) {\r\n\t\t\t\t\t\t\tthis.audioMuted = false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VRStarted', this.streamId, message.clientId, message.container);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = message.container;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VREnded', this.streamId, message.clientId);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetMediaStream(mediaStream) {\r\n\t\tconst videoNode = this.videoNode;\r\n\t\tif ('srcObject' in videoNode) {\r\n\t\t\tvideoNode.srcObject = mediaStream;\r\n\t\t} else {\r\n\t\t\tvideoNode.src = mediaStream ? window.URL.createObjectURL(mediaStream) : null;\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraStreamComponent.onLoadedMetadata', event);\r\n\t\tthis.videoNode.play().then(success => {\r\n\t\t\t// console.log('AgoraStreamComponent.play.success', success);\r\n\t\t}, error => {\r\n\t\t\tconsole.log('AgoraStreamComponent.play.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonToggleSpy($event) {\r\n\t\tthis.toggleSpy.next($event);\r\n\t}\r\n}\r\n\r\nAgoraStreamComponent.meta = {\r\n\tselector: '[agora-stream]',\r\n\toutputs: ['toggleSpy'],\r\n\tinputs: ['stream'],\r\n};\r\n","function push_(event) {\r\n\tconst dataLayer = window.dataLayer || [];\r\n\tdataLayer.push(event);\r\n\tconsole.log('GtmService.dataLayer', event);\r\n}\r\n\r\nexport default class GtmService {\r\n\r\n\tstatic push(event) {\r\n\t\treturn push_(event);\r\n\t}\r\n\r\n}\r\n","import { from, Subject } from 'rxjs';\r\nimport { map, switchMap, tap } from 'rxjs/operators';\r\n\r\nexport class ModalEvent {\r\n\r\n\tconstructor(data) {\r\n\t\tthis.data = data;\r\n\t}\r\n\r\n}\r\n\r\nexport class ModalResolveEvent extends ModalEvent { }\r\nexport class ModalRejectEvent extends ModalEvent { }\r\n\r\nexport default class ModalService {\r\n\r\n\tstatic open$(modal) {\r\n\t\treturn this.getTemplate$(modal.src).pipe(\r\n\t\t\tmap(template => {\r\n\t\t\t\treturn { node: this.getNode(template), data: modal.data, modal: modal };\r\n\t\t\t}),\r\n\t\t\ttap(node => this.modal$.next(node)),\r\n\t\t\tswitchMap(node => this.events$),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic load$(modal) {\r\n\r\n\t}\r\n\r\n\tstatic getTemplate$(url) {\r\n\t\treturn from(fetch(url).then(response => {\r\n\t\t\treturn response.text();\r\n\t\t}));\r\n\t}\r\n\r\n\tstatic getNode(template) {\r\n\t\tconst div = document.createElement('div');\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tstatic reject(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalRejectEvent(data));\r\n\t}\r\n\r\n\tstatic resolve(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalResolveEvent(data));\r\n\t}\r\n\r\n}\r\n\r\nModalService.modal$ = new Subject();\r\nModalService.events$ = new Subject();\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ModalService from './modal.service';\r\n\r\nexport default class ModalOutletComponent extends Component {\r\n\tget modal() {\r\n\t\treturn this.modal_;\r\n\t}\r\n\r\n\tset modal(modal) {\r\n\t\t// console.log('ModalOutletComponent set modal', modal, this);\r\n\t\tconst { module } = getContext(this);\r\n\t\tif (this.modal_ && this.modal_.node) {\r\n\t\t\tmodule.remove(this.modal_.node, this);\r\n\t\t\tthis.modalNode.removeChild(this.modal_.node);\r\n\t\t}\r\n\t\tif (modal && modal.node) {\r\n\t\t\tthis.modal_ = modal;\r\n\t\t\tthis.modalNode.appendChild(modal.node);\r\n\t\t\tconst instances = module.compile(modal.node);\r\n\t\t}\r\n\t\tthis.modal_ = modal;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.modalNode = node.querySelector('.modal-outlet__modal');\r\n\t\tModalService.modal$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(modal => {\r\n\t\t\tthis.modal = modal;\r\n\t\t});\r\n\t}\r\n\r\n\treject(event) {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nModalOutletComponent.meta = {\r\n\tselector: '[modal-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"modal-outlet__container\" [class]=\"{ active: modal }\">\r\n\t\t<div class=\"modal-outlet__background\" (click)=\"reject($event)\"></div>\r\n\t\t<div class=\"modal-outlet__modal\"></div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport ModalService from '../modal/modal.service';\r\n\r\nexport default class TryInARModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance, node } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tconst data = this.data = parentInstance.modal.data;\r\n\t\t\t// console.log('data', data);\r\n\t\t\tif (data && data.ar) {\r\n\t\t\t\tconst url = TryInARModalComponent.getUrl(data);\r\n\t\t\t\tconst qrcode = new QRious({\r\n\t\t\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\t\t\tvalue: url,\r\n\t\t\t\t\tsize: 256\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tstatic getUrl(data) {\r\n\t\tconst url = environment.getAbsoluteUrl(environment.template.tryInAr, { viewId: data.id });\r\n\t\tconsole.log('TryInARModalComponent.getUrl', url);\r\n\t\treturn url;\r\n\t}\r\n\r\n\tstatic openInAR(data) {\r\n\t\tconst url = this.getUrl(data);\r\n\t\twindow.open(url, '_blank');\r\n\t}\r\n\r\n}\r\n\r\nTryInARModalComponent.meta = {\r\n\tselector: '[try-in-ar-modal]'\r\n};\r\n","/* global THREE */\r\n\r\nimport { Subject } from \"rxjs\";\r\n\r\nexport const ViewType = {\r\n\tWaitingRoom: { id: 1, name: 'waiting-room' },\r\n\tPanorama: { id: 2, name: 'panorama' },\r\n\tPanoramaGrid: { id: 3, name: 'panorama-grid' },\r\n\tRoom3d: { id: 4, name: 'room-3d' },\r\n\tModel: { id: 5, name: 'model' },\r\n};\r\n\r\nexport const ViewItemType = {\r\n\tNav: { id: 1, name: 'nav' },\r\n\tPlane: { id: 2, name: 'plane' },\r\n\tCurvedPlane: { id: 3, name: 'curved-plane' },\r\n\tModel: { id: 4, name: 'model' },\r\n\tTexture: { id: 5, name: 'texture' },\r\n};\r\n\r\nexport class View {\r\n\t// 'liked'\r\n\tstatic allowedProps = ['id', 'type', 'name', 'hidden', 'likes', 'asset', 'items', 'orientation', 'zoom', 'ar', 'tiles', 'invertAxes', 'flipAxes'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t\tthis.updateIndices(options.items);\r\n\t\t}\r\n\t\tthis.items = (this.items || []).map(item => mapViewItem(item));\r\n\t\tif (this.tiles) {\r\n\t\t\tthis.tiles = this.tiles.map(tile => mapViewTile(tile));\r\n\t\t}\r\n\t\tthis.originalItems = this.items.slice();\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (View.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'items':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(item => mapViewItem(item).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'tiles':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(tile => mapViewTile(tile).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\r\n\tget shortType() {\r\n\t\treturn this.type ? this.type.split('-').map(x => x.substring(0, 1).toUpperCase()).join('') : '??';\r\n\t}\r\n\r\n\tupdateIndices(items) {\r\n\t\tif (items) {\r\n\t\t\tlet publisherStreamIndex = 0;\r\n\t\t\tlet attendeeStreamIndex = 0;\r\n\t\t\tlet smartDeviceStream = 0;\r\n\t\t\tlet publisherScreenIndex = 0;\r\n\t\t\tlet attendeeScreenIndex = 0;\r\n\t\t\titems.forEach((item, index) => {\r\n\t\t\t\titem.index = index;\r\n\t\t\t\tif (item.asset) {\r\n\t\t\t\t\tswitch(item.asset.file) {\r\n\t\t\t\t\t\tcase 'publisherStream':\r\n\t\t\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'nextAttendeeStream':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'smartDeviceStream':\r\n\t\t\t\t\t\t\titem.asset.index = smartDeviceStream++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'publisherScreen':\r\n\t\t\t\t\t\t\titem.asset.index = publisherScreenIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'attendeeScreen':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeScreenIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t/*\r\n\t\t\t\tif (item.asset && item.asset.file === 'publisherStream') {\r\n\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\tif (item.asset && item.asset.file === 'nextAttendeeStream') {\r\n\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class PanoramaView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class PanoramaGridView extends View {\r\n\r\n\tstatic mapTiles(tiles = [], flipAxes = false, invertAxes = false, folder = '') {\r\n\t\tconst axes = flipAxes ? -1 : 1;\r\n\t\treturn tiles.map((tile, i) => {\r\n\t\t\tconst indices = new THREE.Vector2();\r\n\t\t\ttile = typeof tile === 'string' ? { id: i + 1, asset: { folder: folder, file: tile }, navs: [] } : tile;\r\n\t\t\ttile.asset.file.replace(/_x([-|\\d]+)_y([-|\\d]+)/g, (a, b, c) => {\r\n\t\t\t\tif (invertAxes) {\r\n\t\t\t\t\tindices.y = parseInt(b);\r\n\t\t\t\t\tindices.x = parseInt(c) * axes;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tindices.x = parseInt(b);\r\n\t\t\t\t\tindices.y = parseInt(c) * axes;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn {\r\n\t\t\t\tid: tile.id,\r\n\t\t\t\tasset: tile.asset,\r\n\t\t\t\tnavs: tile.navs || [],\r\n\t\t\t\tindices,\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tset index(index) {\r\n\t\tif (this.index_ !== index) {\r\n\t\t\tthis.index_ = index;\r\n\t\t\tthis.tiles.forEach((tile, i) => tile.selected = i === index);\r\n\t\t\tthis.updateCurrentItems();\r\n\t\t\t// console.log('PanoramaGridView.index.set', index, this.items);\r\n\t\t\tthis.index$.next(index);\r\n\t\t}\r\n\t}\r\n\tget index() {\r\n\t\treturn this.index_;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\toptions.tiles = PanoramaGridView.mapTiles(options.tiles, options.flipAxes, options.invertAxes, options.asset ? options.asset.folder : '');\r\n\t\tsuper(options);\r\n\t\t/*\r\n\t\tif (!this.tiles.length) {\r\n\t\t\tthrow new Error('PanoramaGridView.constructor tile list is empty!');\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.index_ = 0;\r\n\t\tthis.index$ = new Subject();\r\n\t\tthis.tiles.forEach((tile, i) => tile.selected = i === 0);\r\n\t\tif (this.tiles.length) {\r\n\t\t\tthis.items = this.originalItems.concat(this.tiles[0].navs);\r\n\t\t\tthis.asset = this.tiles[0].asset;\r\n\t\t}\r\n\t}\r\n\r\n\tupdateCurrentItems() {\r\n\t\tthis.items = this.originalItems.concat(this.tiles[this.index_].navs);\r\n\t}\r\n\r\n\tgetTileIndex(x, y) {\r\n\t\treturn this.tiles.reduce((p, c, i) => {\r\n\t\t\tif (c.indices.x === x && c.indices.y === y) {\r\n\t\t\t\treturn i;\r\n\t\t\t} else {\r\n\t\t\t\treturn p;\r\n\t\t\t}\r\n\t\t}, -1);\r\n\t}\r\n\thasTile(x, y) {\r\n\t\treturn this.getTileIndex(x, y) !== -1;\r\n\t}\r\n\tgetTile(x, y) {\r\n\t\tconst index = this.getTileIndex(x, y);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.index = index;\r\n\t\t\treturn this.tiles[index];\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ModelView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class ViewItem {\r\n\tstatic allowedProps = ['id', 'type', 'title', 'abstract', 'asset', 'link', 'viewId', 'keepOrientation', 'position', 'rotation', 'scale', 'radius', 'height', 'arc'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewItem.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (payload.link && (!payload.link.title || !payload.link.href)) {\r\n\t\t\tdelete payload.link;\r\n\t\t}\r\n\t\treturn payload;\r\n\t}\r\n\tget hasPanel() {\r\n\t\treturn this.type.name === ViewItemType.Nav.name && (\r\n\t\t\t(this.title && this.title !== '') ||\r\n\t\t\t(this.abstract && this.abstract !== '') ||\r\n\t\t\tthis.asset ||\r\n\t\t\tthis.link\r\n\t\t);\r\n\t}\r\n}\r\n\r\nexport class NavViewItem extends ViewItem {\r\n\r\n}\r\n\r\nexport class ViewTile {\r\n\tstatic allowedProps = ['id', 'asset', 'navs'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t\tthis.navs = (this.navs || []).map(nav => mapViewItem(nav));\r\n\t\tthis.originalItems = this.navs.slice();\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewTile.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'navs':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(nav => mapViewItem(nav).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n}\r\n\r\nexport function mapView(view) {\r\n\tswitch (view.type.name) {\r\n\t\tcase ViewType.Panorama.name:\r\n\t\t\tview = new PanoramaView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\tview = new PanoramaGridView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.Model.name:\r\n\t\t\tview = new ModelView(view);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tview = new View(view);\r\n\t}\r\n\treturn view;\r\n}\r\n\r\nexport function mapViewItem(item) {\r\n\tswitch (item.type.name) {\r\n\t\tcase ViewItemType.Nav.name:\r\n\t\t\titem = new NavViewItem(item);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\titem = new ViewItem(item);\r\n\t}\r\n\treturn item;\r\n}\r\n\r\nexport function mapViewTile(tile) {\r\n\treturn new ViewTile(tile);\r\n}\r\n","import { BehaviorSubject, combineLatest, of } from 'rxjs';\r\nimport { distinctUntilChanged, map, shareReplay, tap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport HttpService from '../http/http.service';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { mapView } from '../view/view';\r\n\r\nexport default class ViewService {\r\n\r\n\t// action: { viewId:number, keepOrientation:boolean };\r\n\tstatic action$_ = new BehaviorSubject(null);\r\n\tstatic set action(action) {\r\n\t\tthis.action$_.next(action);\r\n\t}\r\n\tstatic get action() {\r\n\t\treturn this.action$_.getValue();\r\n\t}\r\n\r\n\t// static viewId$_ = new BehaviorSubject(null);\r\n\tstatic set viewId(viewId) {\r\n\t\tthis.action$_.next({ viewId, keepOrientation: false });\r\n\t}\r\n\tstatic get viewId() {\r\n\t\tconst action = this.action$_.getValue();\r\n\t\treturn action ? action.viewId : null;\r\n\t}\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tconst dataUrl = environment.flags.production ? '/api/view' : './api/data.json';\r\n\t\t\tthis.data$_ = HttpService.get$(dataUrl).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\t// tap(data => console.log('ViewService.data$', data)),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic view$(data, editor) {\r\n\t\tconst views = editor ? data.views : data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\tconst initialViewId = LocationService.has('viewId') ? parseInt(LocationService.get('viewId')) : (views.length ? views[0].id : null);\r\n\t\tthis.action$_.next({ viewId: initialViewId });\r\n\t\treturn this.action$_.pipe(\r\n\t\t\tdistinctUntilChanged((a, b) => a.viewId === b.viewId),\r\n\t\t\tmap(action => {\r\n\t\t\t\tconst view = data.views.find(view => view.id === action.viewId);\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.keepOrientation = action.keepOrientation || false;\r\n\t\t\t\t}\r\n\t\t\t\treturn view || this.getWaitingRoom(data);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic hostedView$(data) {\r\n\t\tconst waitingRoom = this.getWaitingRoom(data);\r\n\t\treturn combineLatest([this.view$(data), this.hosted$()]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst view = datas[0];\r\n\t\t\t\tconst hosted = datas[1];\r\n\t\t\t\treturn hosted ? view : waitingRoom;\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\tLocationService.set('viewId', view.id);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic editorView$(data) {\r\n\t\tconst waitingRoom = this.getWaitingRoom(data);\r\n\t\treturn this.view$(data, true).pipe(\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\tLocationService.set('viewId', view.id);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic hosted$() {\r\n\t\treturn StateService.state$.pipe(\r\n\t\t\tmap(state => state.hosted),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewById$(viewId) {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => data.views.find(x => x.id === viewId))\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewLike$(view) {\r\n\t\tif (!view.liked) {\r\n\t\t\tview.liked = true;\r\n\t\t\tif (environment.flags.production) {\r\n\t\t\t\treturn HttpService.get$(`/api/view/${view.id}/like`);\r\n\t\t\t} else {\r\n\t\t\t\tview.likes = view.likes || 0;\r\n\t\t\t\tview.likes++;\r\n\t\t\t\treturn of(view);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic setViewLike$(message) {\r\n\t\treturn this.viewById$(message.viewId).pipe(\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.likes = message.likes;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getWaitingRoom(data) {\r\n\t\treturn data && data.views.find(x => x.type.name === 'waiting-room') || {\r\n\t\t\tid: 'waiting-room',\r\n\t\t\ttype: { id: 1, name: 'waiting-room' },\r\n\t\t\tname: 'Waiting Room',\r\n\t\t\tlikes: 0,\r\n\t\t\tliked: false,\r\n\t\t\tasset: {\r\n\t\t\t\ttype: { id: 1, name: 'image' },\r\n\t\t\t\tfolder: '/textures/waiting-room/',\r\n\t\t\t\tfile: 'waiting-room.jpg',\r\n\t\t\t},\r\n\t\t\titems: [],\r\n\t\t\torientation: {\r\n\t\t\t\tlatitude: 0,\r\n\t\t\t\tlongitude: 0\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n}\r\n","import { BehaviorSubject, Subject } from \"rxjs\";\r\n\r\nexport const XRStatus = {\r\n\tWaiting: 'waiting',\r\n\tEnabled: 'enabled',\r\n\tEnded: 'ended',\r\n\tStarted: 'started',\r\n\tDisabled: 'disabled',\r\n\tNeedsHttps: 'needs-https',\r\n\tUnavailable: 'unavailable',\r\n};\r\n\r\nexport default class VRService {\r\n\r\n\tstatic getService() {\r\n\t\tif (!this.service_) {\r\n\t\t\tthis.service_ = new VRService();\r\n\t\t}\r\n\t\treturn this.service_;\r\n\t}\r\n\r\n\tget status() {\r\n\t\treturn this.status$.getValue();\r\n\t}\r\n\r\n\tget state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tif (VRService.service_) {\r\n\t\t\tthrow ('VRService is a singleton class!');\r\n\t\t}\r\n\t\tconst state = this.state_ = {\r\n\t\t\tcamera: {\r\n\t\t\t\tposition: new THREE.Vector3(),\r\n\t\t\t\tquaternion: new THREE.Quaternion(),\r\n\t\t\t\tscale: new THREE.Vector3(),\r\n\t\t\t\tarray: new Array(3 + 4 + 3).fill(0),\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis.onSessionStarted = this.onSessionStarted.bind(this);\r\n\t\tthis.onSessionEnded = this.onSessionEnded.bind(this);\r\n\t\tthis.status$ = new BehaviorSubject(XRStatus.Waiting);\r\n\t\tthis.session$ = new Subject();\r\n\t\tthis.state$ = new BehaviorSubject(state);\r\n\t\tthis.currentSession = null;\r\n\t\tif ('xr' in navigator) {\r\n\t\t\tnavigator.xr.isSessionSupported('immersive-vr').then((supported) => {\r\n\t\t\t\tif (supported) {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Enabled);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Disabled);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (window.isSecureContext === false) {\r\n\t\t\t\tthis.status$.next(XRStatus.NeedsHttps);\r\n\t\t\t} else {\r\n\t\t\t\tthis.status$.next(XRStatus.Unavailable);\r\n\t\t\t\t// 'https://immersiveweb.dev/';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonSessionStarted(session) {\r\n\t\tsession.addEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = session;\r\n\t\tthis.session$.next(session);\r\n\t\tthis.status$.next(XRStatus.Started);\r\n\t}\r\n\r\n\tonSessionEnded( /*event*/) {\r\n\t\tthis.currentSession.removeEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = null;\r\n\t\tthis.session$.next(null);\r\n\t\tthis.status$.next(XRStatus.Ended);\r\n\t}\r\n\r\n\ttoggleVR(event) {\r\n\t\tif (this.currentSession === null) {\r\n\t\t\t// WebXR's requestReferenceSpace only works if the corresponding feature\r\n\t\t\t// was requested at session creation time. For simplicity, just ask for\r\n\t\t\t// the interesting ones as optional features, but be aware that the\r\n\t\t\t// requestReferenceSpace call will fail if it turns out to be unavailable.\r\n\t\t\t// ('local' is always available for immersive sessions and doesn't need to\r\n\t\t\t// be requested separately.)\r\n\t\t\tconst sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor'] };\r\n\t\t\tnavigator.xr.requestSession('immersive-vr', sessionInit).then(this.onSessionStarted);\r\n\t\t} else {\r\n\t\t\tthis.currentSession.end();\r\n\t\t}\r\n\t}\r\n\r\n\tisDisabled() {\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\treturn true;\r\n\t\t\tdefault:\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet label;\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\t\tlabel = 'Waiting VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Enabled:\r\n\t\t\tcase XRStatus.Ended:\r\n\t\t\t\tlabel = 'Enter VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Started:\r\n\t\t\t\tlabel = 'Exit VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\t\tlabel = 'VR Disabled';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\t\tlabel = 'VR Needs Https';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\tlabel = 'VR Unavailable';\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn label;\r\n\t}\r\n\r\n\tupdateState(world) {\r\n\t\tif (this.status === XRStatus.Started) {\r\n\t\t\tconst renderer = world.renderer,\r\n\t\t\t\tscene = world.scene,\r\n\t\t\t\tcamera = world.camera,\r\n\t\t\t\tstate = this.state_;\r\n\t\t\tcamera.matrixWorld.decompose(state.camera.position, state.camera.quaternion, state.camera.scale);\r\n\t\t\tstate.camera.array[0] = state.camera.position.x;\r\n\t\t\tstate.camera.array[1] = state.camera.position.y;\r\n\t\t\tstate.camera.array[2] = state.camera.position.z;\r\n\t\t\tstate.camera.array[3] = state.camera.quaternion.x;\r\n\t\t\tstate.camera.array[4] = state.camera.quaternion.y;\r\n\t\t\tstate.camera.array[5] = state.camera.quaternion.z;\r\n\t\t\tstate.camera.array[6] = state.camera.quaternion.w;\r\n\t\t\tstate.camera.array[7] = state.camera.scale.x;\r\n\t\t\tstate.camera.array[8] = state.camera.scale.y;\r\n\t\t\tstate.camera.array[9] = state.camera.scale.z;\r\n\t\t\tthis.state$.next(state);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { first, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { DEBUG, environment } from '../environment';\r\nimport GtmService from '../gtm/gtm.service';\r\nimport LocalStorageService from '../local-storage/local-storage.service';\r\nimport LocationService from '../location/location.service';\r\nimport MessageService from '../message/message.service';\r\nimport ModalService from '../modal/modal.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport TryInARModalComponent from '../try-in-ar/try-in-ar-modal.component';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { PanoramaGridView } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport VRService from '../world/vr.service';\r\nimport AgoraService from './agora.service';\r\nimport { AgoraStatus, MessageType } from './agora.types';\r\n\r\nexport default class AgoraComponent extends Component {\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.env = environment;\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.state = {};\r\n\t\tthis.hosted = null;\r\n\t\tthis.data = null;\r\n\t\tthis.views = null;\r\n\t\tthis.view = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.screen = null;\r\n\t\tthis.remotes = [];\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tgetLinkRole() {\r\n\t\tlet linkRole = null;\r\n\t\tconst match = (LocationService.get('link') || '').match(/\\d{9}-(\\d{4})-\\d{13}/);\r\n\t\tif (match) {\r\n\t\t\tconst index = parseInt(match[1]);\r\n\t\t\tlinkRole = Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\t\treturn i === index ? RoleType[c] : p;\r\n\t\t\t}, null)\r\n\t\t}\r\n\t\treturn linkRole;\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tUserService.me$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(user => {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t\t// this.userGuard(user);\r\n\t\t});\r\n\t}\r\n\r\n\tuserGuard(user) {\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || user.type === linkRole)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tuserGuardRedirect(user) {\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || linkRole === user.type)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else if (linkRole === RoleType.Publisher || linkRole === RoleType.Attendee) {\r\n\t\t\twindow.location.href = environment.url.access;\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tsetNextStatus() {\r\n\t\tlet status = AgoraStatus.Idle;\r\n\t\tconst state = StateService.state;\r\n\t\tif (state.role === RoleType.SmartDevice) {\r\n\t\t\tstate.name = state.name || 'Smart Device';\r\n\t\t}\r\n\t\tif (!state.checklist) {\r\n\t\t\tstatus = AgoraStatus.Checklist;\r\n\t\t} else if (!state.link) {\r\n\t\t\tstatus = AgoraStatus.Link;\r\n\t\t} else if (!state.user.id && (state.role === RoleType.Publisher || state.role === RoleType.Attendee)) {\r\n\t\t\tstatus = AgoraStatus.Login;\r\n\t\t} else if (!state.name) {\r\n\t\t\tstatus = AgoraStatus.Name;\r\n\t\t} else if (state.role !== RoleType.Viewer && state.role !== RoleType.SmartDevice) {\r\n\t\t\tstatus = AgoraStatus.Device;\r\n\t\t} else {\r\n\t\t\tstatus = AgoraStatus.ShouldConnect;\r\n\t\t}\r\n\t\tStateService.patchState({ status });\r\n\t\treturn status;\r\n\t}\r\n\r\n\tinitWithUser(user) {\r\n\t\tconsole.log('initWithUser', user);\r\n\t\tconst link = LocationService.get('link') || null;\r\n\t\tconst role = this.getLinkRole() || (user ? user.type : null);\r\n\t\tuser = user || { type: role };\r\n\t\tif (role !== user.type) {\r\n\t\t\tuser = { type: role };\r\n\t\t}\r\n\t\tconst has3D = role !== RoleType.SmartDevice;\r\n\t\tconst name = LocationService.get('name') || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\tconst checklist = LocalStorageService.get('checklist') || null;\r\n\t\tconst hosted = role === RoleType.Publisher ? true : false;\r\n\t\tconst live = (DEBUG || role === RoleType.SelfService) ? false : true;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\thas3D: has3D,\r\n\t\t\tname: name,\r\n\t\t\tchecklist: checklist,\r\n\t\t\tlink: link,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: 'idle',\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: false,\r\n\t\t\tlocked: false,\r\n\t\t\tcontrol: false,\r\n\t\t\tspyed: false,\r\n\t\t\thosted: hosted,\r\n\t\t\tlive: live,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log(state);\r\n\t\t});\r\n\t\tthis.initAgora();\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(view => {\r\n\t\t\t// console.log('AgoraComponent.viewObserver$', view);\r\n\t\t});\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn ViewService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\tthis.data = data;\r\n\t\t\t\tthis.views = data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\t\t\treturn ViewService.hostedView$(data);\r\n\t\t\t}),\r\n\t\t\t/*\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\t*/\r\n\t\t\ttap(view => {\r\n\t\t\t\t// !!! move navToView to user action?\r\n\t\t\t\tif (this.agora) {\r\n\t\t\t\t\tthis.agora.navToView(view.id);\r\n\t\t\t\t}\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tinitAgora() {\r\n\t\tlet agora = null;\r\n\t\tif (DEBUG || this.state.role === RoleType.SelfService) {\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connected, hosted: true });\r\n\t\t} else {\r\n\t\t\tagora = this.agora = AgoraService.getSingleton();\r\n\t\t\tconst role = this.getLinkRole();\r\n\t\t\tconst status = this.setNextStatus();\r\n\t\t\t// console.log('initAgora', status, role);\r\n\t\t}\r\n\t\tStreamService.local$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(local => {\r\n\t\t\t// console.log('AgoraComponent.local', local);\r\n\t\t\tthis.local = local;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.screen$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(screen => {\r\n\t\t\t// console.log('AgoraComponent.screen', screen);\r\n\t\t\tthis.screen = screen;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.orderedRemotes$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(remotes => {\r\n\t\t\t// console.log('AgoraComponent.remotes', remotes);\r\n\t\t\tthis.remotes = remotes;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraComponent.message', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.RequestPeerInfo:\r\n\t\t\t\t\tmessage.type = MessageType.RequestPeerInfoResult;\r\n\t\t\t\t\tmessage.clientInfo = {\r\n\t\t\t\t\t\trole: StateService.state.role,\r\n\t\t\t\t\t\tname: StateService.state.name,\r\n\t\t\t\t\t\tuid: StateService.state.uid,\r\n\t\t\t\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t\t\t\t\tcontrol: StateService.state.control,\r\n\t\t\t\t\t};\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestControl:\r\n\t\t\t\t\t// console.log('AgoraComponent', 'MessageType.RequestControlAccepted');\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlAccepted;\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tStateService.patchState({ locked: true });\r\n\t\t\t\t\tif (this.agora) {\r\n\t\t\t\t\t\tthis.agora.sendControlRemoteRequestInfo(message.clientId);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// !!! control request permission not required\r\n\t\t\t\t\t// this.onRemoteControlRequest(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t// !!! moved to WorldComponent\r\n\t\t\t\t/*\r\n\t\t\t\tcase MessageType.RequestInfo:\r\n\t\t\t\t\tif (StateService.state.role !== RoleType.Publisher) {\r\n\t\t\t\t\t\tStateService.patchState({ spyed: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t\tconsole.log('AgoraComponent.RequestInfoResult', ViewService.viewId, message.viewId);\r\n\t\t\t\t\tViewService.viewId = message.viewId;\r\n\t\t\t\t\t// console.log('AgoraComponent.RequestInfoResult', message.viewId);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t*/\r\n\t\t\t\tcase MessageType.NavToView:\r\n\t\t\t\t\tthis.onRemoteNavTo(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.AddLike:\r\n\t\t\t\t\tViewService.setViewLike$(message).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t).subscribe(view => this.showLove(view));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tif (!StateService.state.chat) {\r\n\t\t\t\t\t\tStateService.patchState({ chatDirty: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.sendMessage(message);\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (agora && StateService.state.status === AgoraStatus.ShouldConnect) {\r\n\t\t\tthis.connect();\r\n\t\t}\r\n\t}\r\n\r\n\tonChecked(checklist) {\r\n\t\t// console.log('AgoraComponent.onChecked', checklist);\r\n\t\tStateService.patchState({ checklist: true });\r\n\t\tthis.setNextStatus();\r\n\t}\r\n\r\n\tonLink(link) {\r\n\t\tconst role = this.getLinkRole();\r\n\t\tconst has3D = role !== RoleType.SmartDevice;\r\n\t\tconst user = StateService.state.user;\r\n\t\tif ((role === RoleType.Publisher || role === RoleType.Attendee) && (!user.id || user.type !== role)) {\r\n\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Login });\r\n\t\t} else if (StateService.state.name) {\r\n\t\t\tif (role === RoleType.Viewer || role === RoleType.SmartDevice) {\r\n\t\t\t\tStateService.patchState({ link, role, has3D });\r\n\t\t\t\tthis.connect();\r\n\t\t\t} else {\r\n\t\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Device });\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonLogin(user) {\r\n\t\tconst name = StateService.state.name || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\tif (name) {\r\n\t\t\tStateService.patchState({ user, name, status: AgoraStatus.Device });\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ user, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonName(name) {\r\n\t\tif (StateService.state.role === RoleType.Viewer || StateService.state.role === RoleType.SmartDevice) {\r\n\t\t\tStateService.patchState({ name });\r\n\t\t\tthis.connect();\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ name, status: AgoraStatus.Device });\r\n\t\t}\r\n\t}\r\n\r\n\tonEnter(preferences) {\r\n\t\tthis.connect(preferences);\r\n\t}\r\n\r\n\tconnect(preferences) {\r\n\t\tthis.agora.connect$(preferences).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t// console.log('AgoraComponent.connect', this.state.role);\r\n\t\tif (this.state.role !== RoleType.SelfService) {\r\n\t\t\tconst sharedMeetingId = this.state.link.replace(/-\\d+-/, '-');\r\n\t\t\tconst log = {\r\n\t\t\t\tmeetingId: this.state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tfullName: this.state.name,\r\n\t\t\t\tuserType: this.state.role\r\n\t\t\t};\r\n\t\t\t// console.log('AgoraComponent.connect', log);\r\n\t\t\tUserService.log$(log).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe();\r\n\t\t\tGtmService.push({\r\n\t\t\t\taction: 'b-here-meeting',\r\n\t\t\t\tmeetingId: this.state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tuserType: this.state.role\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.leaveChannel().then(() => {\r\n\t\t\t\t// StateService.patchState({ status: AgoraStatus.Disconnected, connected: false });\r\n\t\t\t\twindow.location.href = window.location.href;\r\n\t\t\t}, console.log);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ connecting: false, connected: false });\r\n\t\t}\r\n\t}\r\n\r\n\tonNavTo(navItem) {\r\n\t\tconst viewId = navItem.viewId;\r\n\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\tViewService.action = { viewId, keepOrientation: navItem.keepOrientation };\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoteNavTo(message) {\r\n\t\tconst viewId = message.viewId;\r\n\t\tconst gridIndex = message.gridIndex;\r\n\t\tif (viewId && ViewService.viewId !== viewId) {\r\n\t\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\t\tif (view) {\r\n\t\t\t\tViewService.action = { viewId, keepOrientation: message.keepOrientation };\r\n\t\t\t\tif (gridIndex != null && view instanceof PanoramaGridView) {\r\n\t\t\t\t\tview.index = gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// console.log('AgoraComponent.onRemoteNavTo', viewId, gridIndex);\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonRemoteControlRequest(message) {\r\n\t\tModalService.open$({ src: environment.template.modal.controlRequest, data: null }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (!DEBUG) {\r\n\t\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlAccepted;\r\n\t\t\t\t\tthis.state.locked = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlRejected;\r\n\t\t\t\t\tthis.state.locked = false;\r\n\t\t\t\t}\r\n\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t} else {\r\n\t\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t\tthis.patchState({ control: true, spying: false });\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.patchState({ control: false, spying: false });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\t// !!! why locally?\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleCamera();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleAudio();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleScreen();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ screen: !this.state.screen });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tconst volumeMuted = !this.state.volumeMuted;\r\n\t\tStateService.patchState({ volumeMuted })\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tStateService.patchState({ chat: !this.state.chat, chatDirty: false });\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tthis.patchState({ chat: false });\r\n\t}\r\n\r\n\tonToggleControl() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleControl();\r\n\t\t} else if (this.state.control) {\r\n\t\t\tthis.patchState({ control: false });\r\n\t\t}/* else {\r\n\t\t\tthis.onRemoteControlRequest({});\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleSpy(remoteId);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ spying: !this.state.spying, control: false });\r\n\t\t}\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tViewService.viewLike$(this.view).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe((view) => {\r\n\t\t\tif (view) {\r\n\t\t\t\tthis.view.liked = true; // view.liked;\r\n\t\t\t\tthis.showLove(view);\r\n\t\t\t\t// this.view.likes = view.likes;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t\tMessageService.send({\r\n\t\t\t\t\ttype: MessageType.AddLike,\r\n\t\t\t\t\tviewId: this.view.id,\r\n\t\t\t\t\tlikes: this.view.likes,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tif (this.platform === DevicePlatform.IOS || this.platform === DevicePlatform.Android) {\r\n\t\t\tTryInARModalComponent.openInAR(this.view);\r\n\t\t} else {\r\n\t\t\tModalService.open$({ src: environment.template.modal.tryInAr, data: this.view }).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonPrevent(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopImmediatePropagation();\r\n\t}\r\n\t*/\r\n}\r\n\r\nAgoraComponent.meta = {\r\n\tselector: '[agora-component]',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\n\r\nexport default class AppComponent extends Component {\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t}\r\n}\r\n\r\nAppComponent.meta = {\r\n\tselector: '[app-component]',\r\n};\r\n","import { environment } from \"../environment\";\r\n\r\nexport const EXT_IMAGE = [\r\n\t'jpeg', 'jpg', 'png',\r\n];\r\nexport const EXT_VIDEO = [\r\n\t'mp4', 'webm',\r\n];\r\nexport const EXT_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'usdz'\r\n];\r\n\r\nexport const AssetType = {\r\n\tImage: { id: 1, name: 'image' }, // jpg, png, ...\r\n\tVideo: { id: 2, name: 'video' }, // mp4, webm, ...\r\n\tModel: { id: 3, name: 'model' }, // fbx, gltf, glb, usdz ...\r\n\tPublisherStream: { id: 4, name: 'publisher-stream', file: 'publisherStream' }, // valore fisso di file a ‘publisherStream’ e folder string.empty\r\n\tAttendeeStream: { id: 5, name: 'next-attendee-stream', file: 'nextAttendeeStream' }, // valore fisso di file a ‘nextAttendeeStream’ e folder string.empty\r\n\tPublisherScreen: { id: 6, name: 'publisher-screen', file: 'publisherScreen' }, // valore fisso di file a ‘publisherScreen’ e folder string.empty\r\n\tAttendeeScreen: { id: 7, name: 'attendee-screen', file: 'attendeeScreen' }, // valore fisso di file a ‘attendeeScreen’ e folder string.empty\r\n\tSmartDeviceStream: { id: 8, name: 'smart-device-stream', file: 'smartDeviceStream' }, // valore fisso di file a smartDeviceStream e folder string.empty\r\n};\r\n\r\nexport const AssetGroupType = {\r\n\tImageOrVideo: { id: 1, name: 'Image or Video', ids: [1, 2] },\r\n\t// Model: { id: 2, name: 'Model 3D', ids: [3] },\r\n\tPublisher: { id: 3, name: 'Publisher', ids: [4] },\r\n\tAttendee: { id: 4, name: 'Attendee', ids: [5] },\r\n\t// PublisherScreen: { id: 5, name: 'PublisherScreen', ids: [6] },\r\n\t// AttendeeScreen: { id: 6, name: 'AttendeeScreen', ids: [7] },\r\n};\r\n\r\nif (environment.flags.editorAssetScreen) {\r\n\tAssetGroupType.PublisherScreen = { id: 5, name: 'PublisherScreen', ids: [6] };\r\n\tAssetGroupType.AttendeeScreen = { id: 6, name: 'AttendeeScreen', ids: [7] };\r\n}\r\n\r\nAssetGroupType.SmartDevice = { id: 7, name: 'Smart Device', ids: [8] };\r\n\r\nexport const STREAM_TYPES = [\r\n\tAssetType.PublisherStream.name,\r\n\tAssetType.AttendeeStream.name,\r\n\tAssetType.PublisherScreen.name,\r\n\tAssetType.AttendeeScreen.name,\r\n\tAssetType.SmartDeviceStream.name,\r\n];\r\n\r\nexport function assetIsStream(asset) {\r\n\treturn asset && STREAM_TYPES.indexOf(asset.type.name) !== -1;\r\n}\r\n\r\nexport function assetTypeById(id) {\r\n\tconst type = Object.keys(AssetType).reduce((p, key) => {\r\n\t\tconst type = AssetType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetType).map(x => AssetType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeById(id) {\r\n\tconst type = Object.keys(AssetGroupType).reduce((p, key) => {\r\n\t\tconst type = AssetGroupType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetGroupType).map(x => AssetGroupType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeFromItem(item) {\r\n\tlet key;\r\n\tif (item && item.asset) {\r\n\t\tkey = Object.keys(AssetGroupType).find(key => {\r\n\t\t\t// console.log(key, AssetGroupType[key].ids, item.asset.type.id);\r\n\t\t\treturn AssetGroupType[key].ids.indexOf(item.asset.type.id) !== -1;\r\n\t\t});\r\n\t}\r\n\treturn AssetGroupType[key || 'ImageOrVideo'];\r\n}\r\n\r\nexport function assetPayloadFromGroupTypeId(groupTypeId) {\r\n\tconst groupType = assetGroupTypeById(groupTypeId);\r\n\tconst type = assetTypeById(groupType.ids[0]);\r\n\tconst file = type.file;\r\n\tconst asset = {\r\n\t\ttype: type,\r\n\t\tfolder: '',\r\n\t\tfile: file,\r\n\t}\r\n\tconsole.log('assetPayloadFromGroupTypeId', asset);\r\n\treturn new Asset(asset);\r\n}\r\n\r\nexport function assetTypeFromPath(path) {\r\n\tconst extension = path.split('.').pop().toLowerCase();\r\n\tif (EXT_IMAGE.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Image;\r\n\t} else if (EXT_VIDEO.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Video;\r\n\t} else if (EXT_MODEL.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Model;\r\n\t}\r\n}\r\n\r\nexport function isAssetType(path, type) {\r\n\tconst assetType = assetTypeFromPath(path);\r\n\treturn assetType === type;\r\n}\r\n\r\nexport class Asset {\r\n\tstatic allowedProps = ['id', 'type', 'folder', 'file', 'linkedPlayId', 'chromaKeyColor'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (Asset.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\tstatic fromUrl(url) {\r\n\t\tconst segments = url.split('/');\r\n\t\tconst file = segments.pop();\r\n\t\tconst folder = segments.join('/') + '/';\r\n\t\tconst type = assetTypeFromPath(file);\r\n\t\treturn new Asset({\r\n\t\t\ttype: type,\r\n\t\t\tfolder: folder,\r\n\t\t\tfile: file,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport function mapAsset(asset) {\r\n\tswitch (asset.type) {\r\n\t\tdefault:\r\n\t\t\tasset = new Asset(asset);\r\n\t}\r\n\treturn asset;\r\n}\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport { AssetType } from './asset';\r\n\r\nexport const MIME_IMAGE = [\r\n\t'bmp', 'gif', 'ico', 'jpeg', 'jpg', 'png', 'svg', 'tif', 'tiff', 'webp',\r\n];\r\nexport const MIME_AUDIO = [\r\n\t'aac', 'mid', 'midi', 'mp3', 'oga', 'opus', 'wav', 'weba',\r\n];\r\nexport const MIME_VIDEO = [\r\n\t'mp4', 'avi', 'mpeg', 'ogv', 'ts', 'webm', '3gp', '3g2',\r\n];\r\nexport const MIME_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'obj', 'usdz',\r\n];\r\nexport const MIME_STREAM = [\r\n\t'publisherStream', 'nextAttendeeStream', 'publisherScreen', 'attendeeScreen',\r\n];\r\nexport function isImage(path) {\r\n\treturn new RegExp(`/\\.(${MIME_IMAGE.join('|')})$/i`).test(path);\r\n}\r\nexport function isVideo(path) {\r\n\treturn new RegExp(`/\\.(${MIME_VIDEO.join('|')})$/i`).test(path);\r\n}\r\nexport function isModel(path) {\r\n\treturn new RegExp(`/\\.(${MIME_MODEL.join('|')})$/i`).test(path);\r\n}\r\nexport function isStream(path) {\r\n\treturn MIME_STREAM.indexOf(path) !== -1;\r\n}\r\nexport default class AssetPipe extends Pipe {\r\n\tstatic transform(asset, type = null) {\r\n\t\tif (type != null) { // keep loose equality\r\n\t\t\tasset = asset.type.name === type ? asset : null;\r\n\t\t}\r\n\t\tif (asset) {\r\n\t\t\t// console.log(asset.type.name, AssetType.Image.name);\r\n\t\t\tswitch (asset.type.name) {\r\n\t\t\t\tcase AssetType.Image.name:\r\n\t\t\t\tcase AssetType.Video.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.Model.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\t\tasset = environment.getPath(asset.file);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tif (isImage(asset.file) || isVideo(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isModel(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isStream(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.file;\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tasset = asset;\r\n\t\t} else {\r\n\t\t\tasset = null;\r\n\t\t}\r\n\t\t// console.log('AssetPipe.transform', asset);\r\n\t\treturn asset;\r\n\t}\r\n}\r\nAssetPipe.meta = {\r\n\tname: 'asset',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\nimport ModalOutletComponent from '../modal/modal-outlet.component';\nimport ModalService from '../modal/modal.service';\n\nexport default class ControlRequestModalComponent extends Component {\n\n\tonInit() {\n\t\tsuper.onInit();\n\t\tconst { parentInstance } = getContext(this);\n\t\tif (parentInstance instanceof ModalOutletComponent) {\n\t\t\tthis.data = parentInstance.modal.data;\n\t\t}\n\t}\n\n\tonAccept(user) {\n\t\tModalService.resolve();\n\t}\n\n\tonReject(user) {\n\t\tModalService.reject();\n\t}\n\n\t/*\n\tonDestroy() {\n\t\t// console.log('ControlRequestModalComponent.onDestroy');\n\t}\n\t*/\n\n\tclose() {\n\t\tModalService.reject();\n\t}\n\n}\n\nControlRequestModalComponent.meta = {\n\tselector: '[control-request-modal]'\n};\n","import { Directive, getContext } from 'rxcomp';\nimport { fromEvent } from 'rxjs';\nimport { shareReplay, takeUntil } from 'rxjs/operators';\n\nexport default class DropDirective extends Directive {\n\n\tonInit() {\n\t\tconst { module, node, parentInstance, selector } = getContext(this);\n\t\tconst event = 'drop';\n\t\tconst event$ = fromEvent(node, event).pipe(shareReplay(1));\n\t\tconst expression = node.getAttribute(`(${event})`);\n\t\tif (expression) {\n\t\t\tconst outputFunction = module.makeFunction(expression, ['$event']);\n\t\t\tevent$.pipe(\n\t\t\t\ttakeUntil(this.unsubscribe$)\n\t\t\t).subscribe(event => {\n\t\t\t\tmodule.resolve(outputFunction, parentInstance, event);\n\t\t\t});\n\t\t\tfromEvent(node, 'dragover').pipe(\n\t\t\t\ttakeUntil(this.unsubscribe$)\n\t\t\t).subscribe(event => event.preventDefault());\n\t\t} else {\n\t\t\tparentInstance[`${event}$`] = event$;\n\t\t}\n\t\t// console.log('DropDirective.onInit', 'selector', selector, 'event', event);\n\t}\n\n}\n\nDropDirective.meta = {\n\tselector: `[(drop)]`,\n};\n","import { Directive, getContext } from \"rxcomp\";\r\nimport { BehaviorSubject } from \"rxjs\";\r\nimport { takeUntil } from \"rxjs/operators\";\r\n\r\nlet DROPDOWN_ID = 1000000;\r\n\r\nexport default class DropdownDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this.dropdown || this.id_ || (this.id_ = DropdownDirective.nextId());\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst trigger = node.getAttribute('dropdown-trigger');\r\n\t\tthis.trigger = trigger ? node.querySelector(trigger) : node;\r\n\t\tthis.opened = null;\r\n\t\tthis.onClick = this.onClick.bind(this);\r\n\t\tthis.onDocumentClick = this.onDocumentClick.bind(this);\r\n\t\tthis.openDropdown = this.openDropdown.bind(this);\r\n\t\tthis.closeDropdown = this.closeDropdown.bind(this);\r\n\t\tthis.addListeners();\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.openDropdown();\r\n\t\t} else {\r\n\t\t\tconst dropdownItemNode = node.querySelector('[dropdown-item]');\r\n\t\t\t// console.log('dropdownItemNode', dropdownItemNode);\r\n\t\t\tif (!dropdownItemNode) { // if (this.trigger !== node) {\r\n\t\t\t\tthis.closeDropdown();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDocumentClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst clickedInside = node === event.target || node.contains(event.target);\r\n\t\tif (!clickedInside) {\r\n\t\t\tthis.closeDropdown();\r\n\t\t}\r\n\t}\r\n\r\n\topenDropdown() {\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.opened = true;\r\n\t\t\tthis.addDocumentListeners();\r\n\t\t\tDropdownDirective.dropdown$.next(this.id);\r\n\t\t\tthis.dropped.next(this.id);\r\n\t\t}\r\n\t}\r\n\r\n\tcloseDropdown() {\r\n\t\tif (this.opened !== null) {\r\n\t\t\tthis.removeDocumentListeners();\r\n\t\t\tthis.opened = null;\r\n\t\t\tif (DropdownDirective.dropdown$.getValue() === this.id) {\r\n\t\t\t\tDropdownDirective.dropdown$.next(null);\r\n\t\t\t\tthis.dropped.next(null);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.trigger.addEventListener('click', this.onClick);\r\n\t}\r\n\r\n\taddDocumentListeners() {\r\n\t\tdocument.addEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\tthis.trigger.removeEventListener('click', this.onClick);\r\n\t}\r\n\r\n\tremoveDocumentListeners() {\r\n\t\tdocument.removeEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tthis.removeDocumentListeners();\r\n\t}\r\n\r\n\tstatic nextId() {\r\n\t\treturn DROPDOWN_ID++;\r\n\t}\r\n\r\n}\r\n\r\nDropdownDirective.meta = {\r\n\tselector: '[dropdown]',\r\n\tinputs: ['dropdown', 'dropdown-trigger'],\r\n\toutputs: ['dropped']\r\n};\r\n\r\nDropdownDirective.dropdown$ = new BehaviorSubject(null);\r\n","import { Directive, getContext } from \"rxcomp\";\r\nimport { takeUntil } from \"rxjs/operators\";\r\nimport DropdownDirective from \"./dropdown.directive\";\r\n\r\nexport default class DropdownItemDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this['dropdown-item'];\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('dropdown-item');\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownItemDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nDropdownItemDirective.meta = {\r\n\tselector: '[dropdown-item], [[dropdown-item]]',\r\n\tinputs: ['dropdown-item']\r\n};\r\n","import { Subject } from 'rxjs';\r\n\r\nexport class ToastEvent {\r\n\tconstructor(toast) {\r\n\t\tthis.toast = toast;\r\n\t}\r\n}\r\n\r\nexport class ToastResolveEvent extends ToastEvent { }\r\n\r\nexport default class ToastService {\r\n\tstatic open$(toast) {\r\n\t\ttoast.id = new Date().getTime();\r\n\t\tthis.toast$.next(toast);\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.resolve(toast);\r\n\t\t}, toast.duration || 3000);\r\n\t\treturn this.events$;\r\n\t\t/*\r\n\t\treturn of(toast).pipe(\r\n\t\t\ttap(toast => this.toast$.next(toast)),\r\n\t\t\tswitchMap(toast => this.events$),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\tstatic resolve(toast) {\r\n\t\tthis.toast$.next(null);\r\n\t\tthis.events$.next(new ToastResolveEvent(toast));\r\n\t}\r\n}\r\n\r\nToastService.toast$ = new Subject();\r\nToastService.events$ = new Subject();\r\n","import { Component } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ToastService from './toast.service';\r\n\r\nexport default class ToastOutletComponent extends Component {\r\n\tonInit() {\r\n\t\tthis.toast = null;\r\n\t\tthis.lastMessage = '';\r\n\t\tToastService.toast$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(toast => {\r\n\t\t\tif (toast) {\r\n\t\t\t\tthis.lastMessage = toast.message;\r\n\t\t\t}\r\n\t\t\tthis.toast = toast;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t// console.log('ToastOutletComponent.onInit');\r\n\t}\r\n}\r\n\r\nToastOutletComponent.meta = {\r\n\tselector: '[toast-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"toast-outlet__container\" [class]=\"{ active: toast }\">\r\n\t\t<div class=\"toast-outlet__toast\" [innerHTML]=\"lastMessage\"></div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\n\r\nexport default class AsideComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.mode = 1;\r\n\t\tthis.viewTypes = Object.keys(ViewType).map(key => {\r\n\t\t\tconst type = ViewType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.viewItemTypes = Object.keys(ViewItemType).map(key => {\r\n\t\t\tconst type = ViewItemType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewItemTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tsetSupportedViewTypes() {\r\n\t\tthis.supportedViewTypes = this.viewTypes.filter(x => this.supportedViewType(x.type.name)).sort((a, b) => {\r\n\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t} else {\r\n\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetSupportedViewItemTypes() {\r\n\t\tif (this.view) {\r\n\t\t\tthis.supportedViewItemTypes = this.viewItemTypes.filter(x => this.supportedViewItemType(this.view.type.name, x.type.name)).sort((a, b) => {\r\n\t\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.supportedViewItemTypes = [];\r\n\t\t}\r\n\t}\r\n\r\n\tsetMode(mode) {\r\n\t\tif (this.mode !== mode) {\r\n\t\t\tthis.mode = mode;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tsupportedViewType(viewTypeName) {\r\n\t\tlet supported = [ViewType.Panorama.name, ViewType.PanoramaGrid.name, ViewType.Room3d.name, ViewType.Model.name].indexOf(viewTypeName) !== -1; // ViewType.WaitingRoom,\r\n\t\t// console.log('supportedViewType', viewType, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tsupportedViewItemType(viewTypeName, viewItemTypeName) {\r\n\t\tlet supported;\r\n\t\tswitch (viewTypeName) {\r\n\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\tsupported = false;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Texture.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Model.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t// console.log('supportedViewItemType', viewTypeName, viewItemTypeName, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next(event);\r\n\t}\r\n\r\n\tonUpdate(event) {\r\n\t\tthis.update.next(event);\r\n\t}\r\n\r\n\tonDelete(event) {\r\n\t\tthis.delete.next(event);\r\n\t}\r\n}\r\n\r\nAsideComponent.meta = {\r\n\tselector: '[aside]',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n};\r\n","import { fromEvent, merge, of } from \"rxjs\";\r\nimport { filter, map } from \"rxjs/operators\";\r\nimport HttpService from \"../http/http.service\";\r\nimport { Asset, mapAsset } from './asset';\r\n\r\nexport class AssetService {\r\n\r\n\tstatic assetCreate$(asset) {\r\n\t\treturn HttpService.post$(`/api/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetUpdate$(asset) {\r\n\t\treturn HttpService.put$(`/api/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetDelete$(asset) {\r\n\t\tif (asset && asset.id) {\r\n\t\t\treturn HttpService.delete$(`/api/asset/${asset.id}`).pipe(\r\n\t\t\t\tmap(() => null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic localizedAssetCreate$(lg, asset) {\r\n\t\treturn HttpService.post$(`/api/${lg}/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic localizedAssetUpdate$(lg, asset) {\r\n\t\treturn HttpService.put$(`/api/${lg}/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic upload$(files) {\r\n\t\tconst formData = new FormData();\r\n\t\tfiles.forEach(file => formData.append('file', file, file.name));\r\n\t\tconst xhr = new XMLHttpRequest();\r\n\t\tconst events$ = merge(\r\n\t\t\tfromEvent(xhr.upload, 'loadstart'),\r\n\t\t\tfromEvent(xhr.upload, 'progress'),\r\n\t\t\tfromEvent(xhr.upload, 'load'),\r\n\t\t\tfromEvent(xhr, 'readystatechange'),\r\n\t\t).pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tswitch (event.type) {\r\n\t\t\t\t\tcase 'readystatechange':\r\n\t\t\t\t\t\tif (xhr.readyState === 4) {\r\n\t\t\t\t\t\t\treturn JSON.parse(xhr.responseText);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== null)\r\n\t\t);\r\n\t\txhr.open('POST', `/api/upload/`, true);\r\n\t\txhr.send(formData);\r\n\t\treturn events$;\r\n\t}\r\n\r\n\tstatic createOrUpdateAsset$(uploads, control) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.assetUpdate$(asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic createOrUpdateLocalizedAsset$(uploads, control, lg) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.localizedAssetUpdate$(lg, asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.localizedAssetCreate$(lg, asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic assetDidChange(previous, current) {\r\n\t\tlet previousId = null;\r\n\t\tlet previousFile = null;\r\n\t\tlet currentId = null;\r\n\t\tlet currentFile = null;\r\n\t\tif (previous) {\r\n\t\t\tpreviousId = previous.id;\r\n\t\t\tpreviousFile = previous.file;\r\n\t\t}\r\n\t\tif (current) {\r\n\t\t\tcurrentId = current.id;\r\n\t\t\tcurrentFile = current.file;\r\n\t\t}\r\n\t\treturn (previousId !== currentId || previousFile !== currentFile);\r\n\t}\r\n\r\n}\r\n","import { map, shareReplay } from 'rxjs/operators';\r\nimport HttpService from '../http/http.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport { mapView, mapViewItem, ViewType } from '../view/view';\r\n\r\nexport default class EditorService {\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tthis.data$_ = HttpService.get$(`/api/view`).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic viewIdOptions$() {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tconst options = data.views.map(view => ({ id: view.id, name: view.name }));\r\n\t\t\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\t\t\treturn options;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewCreate$(view) {\r\n\t\treturn HttpService.post$(`/api/view`, view).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewUpdate$(view) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}`, view.payload).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewDelete$(view) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}`);\r\n\t}\r\n\r\n\tstatic getTile(view) {\r\n\t\tlet tile;\r\n\t\tif (view.type.name === ViewType.PanoramaGrid.name) {\r\n\t\t\ttile = view.tiles[view.index];\r\n\t\t}\r\n\t\treturn tile;\r\n\t}\r\n\r\n\tstatic inferItemCreate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemCreate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemCreate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemUpdate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemUpdate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDelete$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemDelete$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemDelete$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdateResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet currentItem;\r\n\t\tif (tile) {\r\n\t\t\tcurrentItem = tile.navs.find(i => i.id === item.id);\r\n\t\t} else {\r\n\t\t\tcurrentItem = view.items.find(i => i.id === item.id);\r\n\t\t}\r\n\t\tif (currentItem) {\r\n\t\t\tObject.assign(currentItem, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDeleteResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet items;\r\n\t\tif (tile) {\r\n\t\t\titems = tile.navs;\r\n\t\t} else {\r\n\t\t\titems = view.items;\r\n\t\t}\r\n\t\tif (items) {\r\n\t\t\tconst index = items.indexOf(item);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\titems.splice(index, 1);\r\n\t\t\t}\r\n\t\t\tif (tile) {\r\n\t\t\t\tview.updateCurrentItems();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic itemCreate$(view, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemUpdate$(view, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemDelete$(view, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/item/${item.id}`);\r\n\t}\r\n\r\n\tstatic tileItemCreate$(view, tile, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/tile/${tile.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemUpdate$(view, tile, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemDelete$(view, tile, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`);\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { Subject } from 'rxjs';\r\nimport { delay, first, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { AgoraStatus } from '../agora/agora.types';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { environment } from '../environment';\r\nimport ModalService, { ModalResolveEvent } from '../modal/modal.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService, { StreamServiceMode } from '../stream/stream.service';\r\nimport ToastService from '../toast/toast.service';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { ViewItemType, ViewType } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport VRService from '../world/vr.service';\r\nimport EditorService from './editor.service';\r\n\r\nexport default class EditorComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.aside = false;\r\n\t\tthis.settings = false;\r\n\t\tthis.state = {};\r\n\t\tthis.data = null;\r\n\t\tthis.views = null;\r\n\t\tthis.view = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.remotes = [];\r\n\t\tthis.viewHit = new Subject();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tUserService.me$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(user => {\r\n\t\t\tif (user && user.type === RoleType.Publisher) {\r\n\t\t\t\tthis.user = user;\r\n\t\t\t\tthis.initState();\r\n\t\t\t} else {\r\n\t\t\t\twindow.location.href = environment.url.access;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tinitState() {\r\n\t\tconst user = this.user;\r\n\t\tconst role = user.type;\r\n\t\tconst name = user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\tname: name,\r\n\t\t\tlink: null,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: AgoraStatus.Connected,\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: true,\r\n\t\t\tlocked: false,\r\n\t\t\tcontrol: false,\r\n\t\t\tspyed: false,\r\n\t\t\thosted: true,\r\n\t\t\tlive: false,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(view => {\r\n\t\t\t// console.log('EditorComponent.viewObserver$', view);\r\n\t\t});\r\n\t\tStreamService.mode = StreamServiceMode.Editor;\r\n\t\t// this.getUserMedia();\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn EditorService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\tthis.data = data;\r\n\t\t\t\tthis.views = data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\t\t\treturn ViewService.editorView$(data);\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tonNavTo(navItem) {\r\n\t\t// console.log('EditorComponent.onNavTo', navItem);\r\n\t\tconst viewId = navItem.viewId;\r\n\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\tViewService.action = { viewId, keepOrientation: navItem.keepOrientation };\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoteControlRequest(message) {\r\n\t\tModalService.open$({ src: environment.template.modal.controlRequest, data: null }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.patchState({ control: true, spying: false });\r\n\t\t\t} else {\r\n\t\t\t\tthis.patchState({ control: false, spying: false });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tModalService.open$({ src: environment.template.modal.tryInAr, data: this.view }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonPrevent(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopImmediatePropagation();\r\n\t}\r\n\t*/\r\n\r\n\treplaceUrl() {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t\tconst debug = params.get('debug') || null;\r\n\t\t\tconst editor = params.get('editor') || null;\r\n\t\t\tconst role = params.get('role') || null;\r\n\t\t\tconst link = params.get('link') || null;\r\n\t\t\tconst name = params.get('name') || null;\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}${name ? `&name=${name}` : ''}${role ? `&role=${role}` : ''}${debug ? `&debug` : ''}${editor ? `&editor` : ''}`;\r\n\t\t\t// console.log('AgoraNameComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggleAside() {\r\n\t\tthis.aside = !this.aside;\r\n\t\tthis.pushChanges();\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tonToggleSettings() {\r\n\t\tthis.settings = !this.settings;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\t// editor\r\n\r\n\tonViewHit(event) {\r\n\t\t// console.log('onViewHit');\r\n\t\tthis.viewHit.next(event);\r\n\t}\r\n\r\n\tonViewHitted(callback) {\r\n\t\tif (this.viewHitSubscription) {\r\n\t\t\tthis.viewHitSubscription.unsubscribe();\r\n\t\t\tthis.viewHitSubscription = null;\r\n\t\t}\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tthis.viewHitSubscription = this.viewHit.pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(position => callback(position))\r\n\t\t}\r\n\t}\r\n\r\n\tonDragEnd(event) {\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onDragEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onDragEnd.inferItemUpdate$.error', error));\r\n\t}\r\n\r\n\tonResizeEnd(event) {\r\n\t\tconsole.log('EditorComponent.onResizeEnd');\r\n\t\t/*\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onResizeEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onResizeEnd.inferItemUpdate$.error', error));\r\n\t\t*/\r\n\t}\r\n\r\n\tonWorldSelect(event) {\r\n\t\t// console.log('EditorComponent.onWorldSelect', this.view);\r\n\t\tif (this.view) {\r\n\t\t\tlet selectedItem;\r\n\t\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\t\tthis.view.items.forEach(item => {\r\n\t\t\t\titem.selected = item === event.item;\r\n\t\t\t\tselectedItem = item.selected ? item : selectedItem;\r\n\t\t\t});\r\n\t\t\tthis.view.selected = !selectedItem;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (selectedItem) {\r\n\t\t\t\tthis.aside = true;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonOpenModal(modal, data) {\r\n\t\tModalService.open$({ src: environment.template.modal[modal.type][modal.value], data }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tconsole.log('EditorComponent.onOpenModal.resolve', event);\r\n\t\t\t\tswitch(modal.type) {\r\n\t\t\t\t\tcase 'view':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\t\tthis.data.views.push(event.data);\r\n\t\t\t\t\t\t\t\tViewService.viewId = event.data.id;\r\n\t\t\t\t\t\t\t\tthis.pushChanges(); // !!!\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'viewItem':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\t\t\t\tconst tile = EditorService.getTile(this.view);\r\n\t\t\t\t\t\t\t\tif (tile) {\r\n\t\t\t\t\t\t\t\t\tconst navs = tile.navs || [];\r\n\t\t\t\t\t\t\t\t\tnavs.push(event.data);\r\n\t\t\t\t\t\t\t\t\tObject.assign(tile, { navs });\r\n\t\t\t\t\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tconst items = this.view.items || [];\r\n\t\t\t\t\t\t\t\t\titems.push(event.data);\r\n\t\t\t\t\t\t\t\t\tObject.assign(this.view, { items });\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonAsideSelect(event) {\r\n\t\t// console.log('onAsideSelect', event);\r\n\t\tif (event.value) {\r\n\t\t\tswitch (event.value) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tthis.onViewHitted((position) => {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, position });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (event.type === 'viewItem') {\r\n\t\t\t\t\t\tif (this.view.type.name === ViewType.Model.name) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.onViewHitted((position) => {\r\n\t\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, position });\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t}\r\n\t\t} else if (event.view && (event.item || event.item === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.items.forEach(item => item.selected = item === event.item);\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view && (event.tile || event.tile === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.tiles.forEach(tile => tile.selected = tile === event.tile);\r\n\t\t\t/*\r\n\t\t\t// if tile selected\r\n\t\t\t// send ChangeTile message to world component\r\n\t\t\tthis.orbit.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\t\tconst item = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\t\tif (item) {\r\n\t\t\t\t\tthis.panorama.crossfade(item, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\t\t\tthis.orbit.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\t\t// this.render();\r\n\t\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view || event.view === null) {\r\n\t\t\tthis.view.selected = (this.view === event.view);\r\n\t\t\tthis.view.items.forEach(item => item.selected = false);\r\n\t\t\tconst currentTile = EditorService.getTile(this.view);\r\n\t\t\tif (currentTile) {\r\n\t\t\t\tthis.view.tiles.forEach(tile => tile.selected = tile === currentTile);\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideUpdate(event) {\r\n\t\t// console.log('onAsideUpdate', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.tile && event.view) {\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t} else if (event.view) {\r\n\t\t\tif (ViewService.viewId !== event.view.id) {\r\n\t\t\t\tViewService.viewId = event.view.id;\r\n\t\t\t} else {\r\n\t\t\t\tconst assetDidChange = AssetService.assetDidChange(this.view.asset, event.view.asset);\r\n\t\t\t\tObject.assign(this.view, event.view);\r\n\t\t\t\tif (assetDidChange) {\r\n\t\t\t\t\tif (typeof this.view.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\tthis.view.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideDelete(event) {\r\n\t\tconsole.log('onAsideDelete', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tEditorService.inferItemDelete$(event.view, event.item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.inferItemDelete$.success', response);\r\n\t\t\t\tEditorService.inferItemDeleteResult$(event.view, event.item);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.inferItemDelete$.error', error));\r\n\t\t} else if (event.view) {\r\n\t\t\tEditorService.viewDelete$(event.view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.viewDelete$.success', response);\r\n\t\t\t\tconst index = this.data.views.indexOf(event.view);\r\n\t\t\t\tif (index !== -1) {\r\n\t\t\t\t\tthis.data.views.splice(index, 1);\r\n\t\t\t\t}\r\n\t\t\t\tthis.views = this.data.views.slice();\r\n\t\t\t\tViewService.viewId = this.views[0].id;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.viewDelete$.error', error));\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nEditorComponent.meta = {\r\n\tselector: '[editor-component]',\r\n};\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport { map, switchMap } from 'rxjs/operators';\r\nimport HttpService from '../../http/http.service';\r\nimport { ViewType } from '../../view/view';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class MenuService {\r\n\r\n\tstatic active$ = new BehaviorSubject(false);\r\n\tstatic set active(active) {\r\n\t\tthis.active$.next(active);\r\n\t}\r\n\tstatic get active() {\r\n\t\treturn this.active$.getValue();\r\n\t}\r\n\r\n\tstatic menu$_ = new BehaviorSubject([]);\r\n\r\n\tstatic menu$() {\r\n\t\treturn this.getMenu$().pipe(\r\n\t\t\tswitchMap(menu => {\r\n\t\t\t\tthis.menu$_.next(menu);\r\n\t\t\t\treturn this.menu$_;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getMenu$() {\r\n\t\treturn HttpService.get$(`/api/menu`).pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tdata.menu.sort((a, b) => {\r\n\t\t\t\t\treturn a.order - b.order;\r\n\t\t\t\t});\r\n\t\t\t\treturn data.menu;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic updateMenu$(menu) {\r\n\t\treturn HttpService.put$(`/api/menu`, menu);\r\n\t}\r\n\r\n\tstatic createMenuItem$(parentId = null, order = 0) {\r\n\t\tconst payload = {\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\torder: order * 10,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t}\r\n\t\treturn HttpService.post$(`/api/menu`, payload);\r\n\t}\r\n\r\n\tstatic updateMenuItem$(item) {\r\n\t\treturn HttpService.put$(`/api/menu/${item.id}`, item);\r\n\t}\r\n\r\n\tstatic deleteMenuItem$(item) {\r\n\t\treturn HttpService.delete$(`/api/menu/${item.id}`);\r\n\t}\r\n\r\n\tstatic getModelMenu$(views, editor = false) {\r\n\t\treturn this.menu$().pipe(\r\n\t\t\tmap(menu => {\r\n\t\t\t\tif (menu && menu.length) {\r\n\t\t\t\t\treturn this.mapMenuItems(menu);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst keys = {};\r\n\t\t\t\t\tviews.forEach(item => {\r\n\t\t\t\t\t\tif (item.type.name !== ViewType.WaitingRoom.name && (!item.hidden || editor)) {\r\n\t\t\t\t\t\t\tlet group = keys[item.type.name];\r\n\t\t\t\t\t\t\tif (!group) {\r\n\t\t\t\t\t\t\t\tgroup = keys[item.type.name] = [];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tgroup.push(item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconst menu = Object.keys(keys).map(typeName => {\r\n\t\t\t\t\t\tlet name = 'Button';\r\n\t\t\t\t\t\tswitch (typeName) {\r\n\t\t\t\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\t\t\t\tname = 'Waiting Room';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\t\tname = 'Experience';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\t\tname = 'Virtual Tour';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\t\t\t\tname = 'Stanze 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\t\tname = 'Modelli 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn { name, type: { name: 'menu-group' }, items: views.filter(x => x.type.name === typeName && (!x.hidden || editor)) };\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn menu;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic mapMenuItem(item, items) {\r\n\t\tif (item.viewId) {\r\n\t\t\treturn { id: item.viewId, name: item.name, type: { name: 'panorama' } };\r\n\t\t} else {\r\n\t\t\treturn { name: item.name, type: { name: 'menu-group' }, items: this.mapMenuItems(items, item.id) };\r\n\t\t}\r\n\t}\r\n\r\n\tstatic mapMenuItems(items, parentId = null) {\r\n\t\treturn items.filter(item => (item.parentId || null) === parentId ).map(item => this.mapMenuItem(item, items))\r\n\t}\r\n\r\n}\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { combineLatest, EMPTY, from, fromEvent, merge } from 'rxjs';\r\nimport { filter, map, switchMap, tap } from 'rxjs/operators';\r\nimport { Asset } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class DropService {\r\n\r\n\tstatic drop$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\tconsole.log('DropService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === input) {\r\n\t\t\t\t\t\tinput.files = event.dataTransfer.files;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic change$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tfilter((event) => input.files && input.files.length),\r\n\t\t\t\tmap((event) => Array.from(input.files)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic asset$(input, previews = []) {\r\n\t\treturn this.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tpreviews.length = files.length;\r\n\t\t\t\tpreviews.fill(null);\r\n\t\t\t\t// output.previews = files.map(() => null);\r\n\t\t\t\tconst uploads$ = files.map((file, i) => this.read$(file, i, previews).pipe(\r\n\t\t\t\t\tmap(() => file),\r\n\t\t\t\t\tswitchMap((file) => AssetService.upload$([file])),\r\n\t\t\t\t\tswitchMap((uploads) => {\r\n\t\t\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic read$(file, i, previews = []) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\treturn this.resize$(blob);\r\n\t\t\t}),\r\n\t\t\ttap(resized => {\r\n\t\t\t\tpreviews[i] = resized;\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tstatic resize$(blob) {\r\n\t\treturn from(this.resize_(blob));\r\n\t}\r\n\r\n\tstatic resize_(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function() {\r\n\t\t\t\treject(blob);\r\n\t\t\t}\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n\r\nexport default class ControlComponent extends Component {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(this, node, this.control);\r\n\t\tconst control = this.control;\r\n\t\tconst flags = control.flags;\r\n\t\tObject.keys(flags).forEach((key) => {\r\n\t\t\tflags[key] ? node.classList.add(key) : node.classList.remove(key);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlComponent.meta = {\r\n\tselector: '[control]',\r\n\tinputs: ['control']\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlAssetComponent.meta = {\r\n\tselector: '[control-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"control.value | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"control.value && control.value.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"control.value | asset\" *if=\"control.value && control.value.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport EditorService from '../editor/editor.service';\r\nimport MenuService from '../editor/menu/menu.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class ControlMenuComponent extends ControlAssetComponent {\r\n\r\n\tstatic itemToFormGroup(item) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: item.id,\r\n\t\t\tparentId: item.parentId,\r\n\t\t\tviewId: item.viewId,\r\n\t\t\tname: item.name,\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tstatic newFormGroup(parentId = null) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: null,\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonInit() {\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tthis.controls = this.control.controls;\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t});\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(this.controls.id.value, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup(this.controls.id.value));\r\n\t}\r\n\r\n\tonRemoveItem() {\r\n\t\tthis.remove.next(this.control);\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tonLinkItem() {\r\n\t\tthis.link.next(this.control);\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\t\tthis.link.next(control);\r\n\t}\r\n\r\n\tonItemUp() {\r\n\t\tthis.up.next(this.control);\r\n\t}\r\n\r\n\tonItemDown() {\r\n\t\tthis.down.next(this.control);\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex --;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex ++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tsetView(view) {\r\n\t\tconsole.log('ControlMenuComponent.setView', view.id);\r\n\t\tconst payload = Object.assign({}, this.control.value);\r\n\t\tpayload.viewId = view.id;\r\n\t\tif (view.id) {\r\n\t\t\tpayload.name = view.name;\r\n\t\t}\r\n\t\tMenuService.updateMenuItem$(payload).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.viewId.value = view.id;\r\n\t\t\tif (view.id) {\r\n\t\t\t\tthis.controls.name.value = view.name;\r\n\t\t\t\t// clear sub items\r\n\t\t\t\tthis.controls.items.controls = [];\r\n\t\t\t\tthis.controls.items.switchSubjects_();\r\n\t\t\t}\r\n\t\t\t// this.change.next(value);\r\n\t\t});\r\n\t}\r\n\r\n\tonTextDidChange(event) {\r\n\t\tconsole.log('ControlMenuComponent.onTextDidChange', this.controls.name.value);\r\n\t\tMenuService.updateMenuItem$(this.control.value).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\treturn this.controls.viewId.value === item.id;\r\n\t}\r\n\r\n\tonDropped(id) {\r\n\t\t// console.log('ControlMenuComponent.onDropped', id);\r\n\t}\r\n\r\n}\r\n\r\nControlMenuComponent.meta = {\r\n\tselector: '[control-menu]',\r\n\toutputs: ['remove', 'link', 'up', 'down'],\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\">\r\n\t\t\t<button type=\"button\" class=\"control-menu__link\" [class]=\"{ active: control.controls.viewId.value }\" (click)=\"onLinkItem($event)\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#link\"></use></svg>\r\n\t\t\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t\t\t<div class=\"category\">View</div>\r\n\t\t\t\t\t<ul class=\"nav--dropdown\">\r\n\t\t\t\t\t\t<li (click)=\"setView(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.controls.viewId.options\">\r\n\t\t\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name\"></span>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t</div>\r\n\t\t\t</button>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control.controls.name\" placeholder=\"Name\" (change)=\"onTextDidChange($event)\" />\r\n\t\t\t<!--\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\">\r\n\t\t\t\t<span [innerHTML]=\"control.controls.viewId.value\"></span>\r\n\t\t\t</button>\r\n\t\t\t-->\r\n\t\t\t<!--\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control.controls.viewId\">\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.controls.viewId.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t-->\r\n\t\t\t<button type=\"button\" class=\"control-menu__up\" (click)=\"onItemUp($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#up\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__down\" (click)=\"onItemDown($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#down\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\" *if=\"!control.controls.viewId.value\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#add\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__remove\" (click)=\"onRemoveItem($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#remove\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"group--items\">\r\n\t\t\t<div control-menu *for=\"let sub of control.controls.items.controls\" [control]=\"sub\" (remove)=\"onRemoveControl($event)\" (link)=\"onLinkControl($event)\" (up)=\"onUpControl($event)\" (down)=\"onDownControl($event)\"></div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport ControlMenuComponent from '../../forms/control-menu.component';\r\nimport MenuService from './menu.service';\r\n\r\nexport default class MenuBuilderComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.changes = 0;\r\n\t\tthis.form = null;\r\n\t\tMenuService.getMenu$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.initForm(menu));\r\n\t}\r\n\r\n\tinitForm(menu = []) {\r\n\t\tconst items = this.menuToControls(menu);\r\n\t\t// console.log('MenuBuilderComponent', items);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\titems: items,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('MenuBuilderComponent', changes);\r\n\t\t\tthis.changes ++;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex --;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex ++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(null, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup());\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonSubmit(event) {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst menu = this.controlsToMenu(changes);\r\n\t\t\tMenuService.updateMenu$(menu);\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tmenuToControls(menu, parentId = null) {\r\n\t\tconst items = new FormArray(menu.filter(x => {\r\n\t\t\treturn (x.parentId || null) === parentId;\r\n\t\t}).map(x => {\r\n\t\t\tconst subitems = this.menuToControls(menu, x.id);\r\n\t\t\treturn new FormGroup({\r\n\t\t\t\tid: x.id,\r\n\t\t\t\tparentId: x.parentId,\r\n\t\t\t\tviewId: x.viewId,\r\n\t\t\t\tname: x.name,\r\n\t\t\t\titems: subitems,\r\n\t\t\t});\r\n\t\t}))\r\n\t\treturn items;\r\n\t}\r\n\r\n\tcontrolsToMenu(changes) {\r\n\t\tconst menu = [];\r\n\t\tconst pushItem = (items) => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems.forEach((item, i) => {\r\n\t\t\t\t\tconst menuItem = Object.assign({}, item);\r\n\t\t\t\t\tmenuItem.order = i * 10;\r\n\t\t\t\t\tdelete menuItem.items;\r\n\t\t\t\t\tmenu.push(menuItem);\r\n\t\t\t\t\tpushItem(item.items);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\tpushItem(changes.items);\r\n\t\treturn menu;\r\n\t}\r\n\r\n}\r\n\r\nMenuBuilderComponent.meta = {\r\n\tselector: '[menu-builder]',\r\n\tinputs: ['views'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class CurvedPlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(CurvedPlaneModalComponent.ORIGIN);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.CurvedPlane,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(20).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tradius: new FormControl(35, RequiredValidator()),\r\n\t\t\theight: new FormControl(20, RequiredValidator()),\r\n\t\t\tarc: new FormControl(90, RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('CurvedPlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('CurvedPlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('CurvedPlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('CurvedPlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nCurvedPlaneModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nCurvedPlaneModalComponent.meta = {\r\n\tselector: '[curved-plane-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class ItemModelModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t/*\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(ItemModelModalComponent.ORIGIN);\r\n\t\t*/\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Model,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(4).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl([0, 0, 0], RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\t// rotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ItemModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('ItemModelModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('ItemModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('ItemModelModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nItemModelModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nItemModelModalComponent.meta = {\r\n\tselector: '[item-model-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first, map, switchMap } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class ModelModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Model,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\tmodel: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tconsole.log('ModelModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tswitchMap(view => {\r\n\t\t\t\t\tconst item = {\r\n\t\t\t\t\t\ttype: ViewItemType.Model,\r\n\t\t\t\t\t\tasset: values.model,\r\n\t\t\t\t\t};\r\n\t\t\t\t\treturn EditorService.itemCreate$(view, item).pipe(\r\n\t\t\t\t\t\tmap(item => {\r\n\t\t\t\t\t\t\tview.items = [item];\r\n\t\t\t\t\t\t\treturn view;\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\t\t\t\t}),\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('ModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('ModelModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nModelModalComponent.meta = {\r\n\tselector: '[model-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class NavModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Nav,\r\n\t\t\ttitle: null,\r\n\t\t\tabstract: null,\r\n\t\t\tviewId: new FormControl(null, RequiredValidator()),\r\n\t\t\tkeepOrientation: false,\r\n\t\t\tposition: this.position.toArray(),\r\n\t\t\tasset: null,\r\n\t\t\tlink: new FormGroup({\r\n\t\t\t\ttitle: new FormControl(null),\r\n\t\t\t\thref: new FormControl(null),\r\n\t\t\t\ttarget: '_blank',\r\n\t\t\t}),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\t/*\r\n\t\tthis.controls.viewId.options = [{\r\n\t\t\tname: \"Name\",\r\n\t\t\tid: 2,\r\n\t\t}];\r\n\t\t*/\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('NavModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\titem.viewId = parseInt(item.viewId);\r\n\t\t\tif (item.link && (!item.link.title || !item.link.href)) {\r\n\t\t\t\titem.link = null;\r\n\t\t\t}\r\n\t\t\t// console.log('NavModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('NavModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('NavModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.submitted = false;\r\n\t\t\t\t// this.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nNavModalComponent.meta = {\r\n\tselector: '[nav-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { PanoramaGridView, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PanoramaGridModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.PanoramaGrid,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tassets: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaGridModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit', this.form.value);\r\n\t\t\tconst assets = this.form.value.assets;\r\n\t\t\tconst tiles = PanoramaGridView.mapTiles(assets.map(asset => ({\r\n\t\t\t\tasset,\r\n\t\t\t\tnavs: [],\r\n\t\t\t})), false, true);\r\n\t\t\ttiles.sort((a, b) => {\r\n\t\t\t\tconst ai = a.indices.x * 10000 + a.indices.y;\r\n\t\t\t\tconst bi = b.indices.x * 10000 + b.indices.y;\r\n\t\t\t\treturn ai - bi;\r\n\t\t\t});\r\n\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit', tiles);\r\n\t\t\tconst asset = tiles[0].asset;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: this.form.value.type,\r\n\t\t\t\tname: this.form.value.name,\r\n\t\t\t\tasset,\r\n\t\t\t\ttiles: tiles,\r\n\t\t\t\tinvertAxes: true,\r\n\t\t\t\tflipAxes: false,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tEditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPanoramaGridModalComponent.meta = {\r\n\tselector: '[panorama-grid-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PanoramaModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Panorama,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tconsole.log('PanoramaModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tconst asset = Asset.fromUrl(this.form.value.upload);\r\n\t\t\tconsole.log('PanoramaModalComponent.onSubmit.asset', asset);\r\n\t\t\tAssetService.assetCreate$(asset).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t\tswitchMap(response => {\r\n\t\t\t\t\tconst view = {\r\n\t\t\t\t\t\ttype: this.form.value.type,\r\n\t\t\t\t\t\tname: this.form.value.name,\r\n\t\t\t\t\t\tasset: response,\r\n\t\t\t\t\t\torientation: {\r\n\t\t\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\t\t\tlongitude: 0\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tzoom: 75\r\n\t\t\t\t\t};\r\n\t\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.view', view);\r\n\t\t\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t);\r\n\t\t\t\t})\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\tEditorService.viewCreate$({\r\n\t\t\t\"id\": 1,\r\n\t\t\t\"type\": \"panorama\",\r\n\t\t\t\"name\": \"Welcome Room\",\r\n\t\t\t\"likes\": 134,\r\n\t\t\t\"liked\": false,\r\n\t\t\t\"asset\": {\r\n\t\t\t\t\"type\": \"image\",\r\n\t\t\t\t\"folder\": \"waiting-room/\",\r\n\t\t\t\t\"file\": \"mod2.jpg\"\r\n\t\t\t},\r\n\t\t\t\"items\": [\r\n\t\t\t\t{\r\n\t\t\t\t\t\"id\": 110,\r\n\t\t\t\t\t\"type\": \"nav\",\r\n\t\t\t\t\t\"title\": \"Barilla Experience\",\r\n\t\t\t\t\t\"abstract\": \"Abstract\",\r\n\t\t\t\t\t\"asset\": {\r\n\t\t\t\t\t\t\"type\": \"image\",\r\n\t\t\t\t\t\t\"folder\": \"barilla/\",\r\n\t\t\t\t\t\t\"file\": \"logo-barilla.jpg\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"link\": {\r\n\t\t\t\t\t\t\"title\": \"Scopri di più...\",\r\n\t\t\t\t\t\t\"href\": \"https://www.barilla.com/it-it/\",\r\n\t\t\t\t\t\t\"target\": \"_blank\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"position\": [\r\n\t\t\t\t\t\t0.9491595148619703,\r\n\t\t\t\t\t\t-0.3147945860255039,\r\n\t\t\t\t\t\t0\r\n\t\t\t\t\t],\r\n\t\t\t\t\t\"viewId\": 23\r\n\t\t\t\t}\r\n\t\t\t],\r\n\t\t\t\"orientation\": {\r\n\t\t\t\t\"latitude\": -10,\r\n\t\t\t\t\"longitude\": 360\r\n\t\t\t},\r\n\t\t\t\"zoom\": 75\r\n\t\t}).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(data => {\r\n\t\t\tconsole.log('EditorService.viewCreate$', data);\r\n\t\t});\r\n\t\t\t*/\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPanoramaModalComponent.meta = {\r\n\tselector: '[panorama-modal]'\r\n};\r\n\r\n/*\r\n{\r\n\t\"id\": 1,\r\n\t\"type\": \"panorama\",\r\n\t\"name\": \"Welcome Room\",\r\n\t\"likes\": 134,\r\n\t\"liked\": false,\r\n\t\"asset\": {\r\n\t\t\"type\": \"image\",\r\n\t\t\"folder\": \"waiting-room/\",\r\n\t\t\"file\": \"mod2.jpg\"\r\n\t},\r\n\t\"items\": [{\r\n\t\t\"id\": 110,\r\n\t\t\"type\": \"nav\",\r\n\t\t\"title\": \"Barilla Experience\",\r\n\t\t\"abstract\": \"Abstract\",\r\n\t\t\"asset\": {\r\n\t\t\t\"type\": \"image\",\r\n\t\t\t\"folder\": \"barilla/\",\r\n\t\t\t\"file\": \"logo-barilla.jpg\"\r\n\t\t},\r\n\t\t\"link\": {\r\n\t\t\t\"title\": \"Scopri di più...\",\r\n\t\t\t\"href\": \"https://www.barilla.com/it-it/\",\r\n\t\t\t\"target\": \"_blank\"\r\n\t\t},\r\n\t\t\"position\": [0.9491595148619703,-0.3147945860255039,0],\r\n\t\t\"viewId\": 23\r\n\t}],\r\n\t\"orientation\": {\r\n\t\t\"latitude\": -10,\r\n\t\t\"longitude\": 360\r\n\t},\r\n\t\"zoom\": 75\r\n}\r\n*/\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(PlaneModalComponent.ORIGIN);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Plane,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(20).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([12, 6.75, 1], RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('PlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('PlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPlaneModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nPlaneModalComponent.meta = {\r\n\tselector: '[plane-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\n\r\nexport default class RemoveModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget item() {\r\n\t\tlet item = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\titem = data.item;\r\n\t\t}\r\n\t\treturn item;\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nRemoveModalComponent.meta = {\r\n\tselector: '[remove-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { of } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetGroupType, assetGroupTypeFromItem, assetPayloadFromGroupTypeId } from '../../asset/asset';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\nimport { ViewItem, ViewItemType, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class UpdateViewItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tconst item = this.item;\r\n\t\tthis.originalItem = Object.assign({}, item);\r\n\t\titem.hasChromaKeyColor = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\titem.assetType = assetGroupTypeFromItem(item).id;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewItemComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateItem(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tgetAssetDidChange(changes) {\r\n\t\tconst item = this.item;\r\n\t\t// console.log('UpdateViewItemComponent.getAssetDidChange', item, changes);\r\n\t\tconst itemHasChromaKeyColor = item.hasChromaKeyColor === true;\r\n\t\tconst changesHasChromaKeyColor = changes.hasChromaKeyColor === true;\r\n\t\tif (AssetService.assetDidChange(item.asset, changes.asset) ||\r\n\t\t\titemHasChromaKeyColor !== changesHasChromaKeyColor) {\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateItem(changes) {\r\n\t\tconst item = this.item;\r\n\t\tconst assetDidChange = this.getAssetDidChange(changes);\r\n\t\t// console.log('doUpdateItem.assetDidChange', assetDidChange);\r\n\t\tObject.assign(item, changes);\r\n\t\tif (item.asset) {\r\n\t\t\titem.asset.chromaKeyColor = item.hasChromaKeyColor ? [0.0, 1.0, 0.0] : null;\r\n\t\t}\r\n\t\tif (assetDidChange) {\r\n\t\t\tconst asset$ = item.asset ? AssetService.assetUpdate$(item.asset) : of(null);\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t// !!! create indices for nextAttendeeStream\r\n\t\t\tthis.view.updateIndices(this.view.items);\r\n\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\titem.onUpdateAsset();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (typeof item.onUpdate === 'function') {\r\n\t\t\titem.onUpdate();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst item = this.item;\r\n\t\tconst form = this.form;\r\n\t\tif (!this.type || this.type.name !== item.type.name) {\r\n\t\t\tthis.type = item.type;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (item.type.name) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'title?', 'abstract?', 'viewId', 'keepOrientation?', 'position', 'asset?', 'link?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'assetType?', 'asset?', 'hasChromaKeyColor?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'radius', 'height', 'arc', 'assetType?', 'asset?', 'hasChromaKeyColor?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Texture.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'assetType?', 'asset?', 'hasChromaKeyColor?']; // asset, key no id!!\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (this.view.type.name === ViewType.Model) {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'asset?'];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'asset?'];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type'];\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tconst value = (item[key] != null ? item[key] : null);\r\n\t\t\t\tlet control;\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'viewId':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t\t).subscribe(options => {\r\n\t\t\t\t\t\t\tcontrol.options = options;\r\n\t\t\t\t\t\t\tcontrol.value = control.value || null;\r\n\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tcontrol.options = Object.keys(AssetGroupType).map(x => AssetGroupType[x]);\r\n\t\t\t\t\t\t// console.log(control.options);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tcontrol = new FormGroup({\r\n\t\t\t\t\t\t\ttitle: new FormControl(title),\r\n\t\t\t\t\t\t\thref: new FormControl(href),\r\n\t\t\t\t\t\t\ttarget\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t}\r\n\t\t\t\tform.add(control, key);\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t} else {\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tthis.controls[key].value = { title, href, target };\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'hasChromaKeyColor':\r\n\t\t\t\t\t\tthis.controls[key].value = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tthis.controls[key].value = assetGroupTypeFromItem(item).id;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tthis.controls[key].value = (item[key] != null ? item[key] : null);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonAssetTypeDidChange(assetType) {\r\n\t\tconst item = this.item;\r\n\t\tconst currentType = assetGroupTypeFromItem(item).id;\r\n\t\t// console.log('UpdateViewItemComponent.onAssetTypeDidChange', assetType, currentType);\r\n\t\tif (assetType !== currentType) {\r\n\t\t\titem.assetType = assetType;\r\n\t\t\tlet asset$ = of(null); // AssetService.assetDelete$(item.asset);\r\n\t\t\tif (assetType !== AssetGroupType.ImageOrVideo.id) {\r\n\t\t\t\tasset$ = asset$.pipe(\r\n\t\t\t\t\tswitchMap(() => {\r\n\t\t\t\t\t\tconst asset = assetPayloadFromGroupTypeId(assetType);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(asset => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.asset$', asset);\r\n\t\t\t\tthis.controls.asset.value = asset;\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tasset$.pipe(\r\n\t\t\t\ttap(asset => {\r\n\t\t\t\t\titem.asset = asset;\r\n\t\t\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\titem.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\t// console.log('UpdateViewItemComponent.onChanges', changes);\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst payload = Object.assign({}, changes);\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst item = new ViewItem(payload);\r\n\t\t\tEditorService.inferItemUpdate$(view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.success', response);\r\n\t\t\t\tEditorService.inferItemUpdateResult$(view, item);\r\n\t\t\t\tthis.update.next({ view, item });\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 300);\r\n\t\t\t}, error => console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: this.view, item: new ViewItem(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { item: this.item } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, item: this.item });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, item: this.item.selected ? null : this.item });\r\n\t\t/*\r\n\t\tthis.item.active = !this.item.active;\r\n\t\tthis.pushChanges();\r\n\t\t*/\r\n\t}\r\n\r\n\tgetTitle(item) {\r\n\t\treturn LabelPipe.getKeys('editor', item.type.name);\r\n\t}\r\n}\r\n\r\nUpdateViewItemComponent.meta = {\r\n\tselector: 'update-view-item',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'item'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: item.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"item.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"item.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(item)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"item.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'nav'\">\r\n\t\t\t\t<div control-text [control]=\"controls.title\" label=\"Title\"></div>\r\n\t\t\t\t<div control-textarea [control]=\"controls.abstract\" label=\"Abstract\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.viewId\" label=\"NavToView\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.keepOrientation\" label=\"Keep Orientation\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"3\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.link.controls.title\" label=\"Link Title\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.link.controls.href\" label=\"Link Url\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'plane'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Localized Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'curved-plane'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<!-- <div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-number [control]=\"controls.radius\" label=\"Radius\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.height\" label=\"Height\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.arc\" label=\"Arc\" [precision]=\"0\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'model'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.asset\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'texture'\">\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\n\r\nexport default class UpdateViewTileComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tid: new FormControl(this.tile.id, RequiredValidator()),\r\n\t\t\tasset: new FormControl(this.tile.asset, RequiredValidator()),\r\n\t\t\tnavs: new FormControl(this.tile.navs, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewTileComponent.form.changes$', changes);\r\n\t\t\tconst tile = this.tile;\r\n\t\t\tObject.assign(tile, changes);\r\n\t\t\tif (typeof tile.onUpdate === 'function') {\r\n\t\t\t\ttile.onUpdate();\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tconsole.log('UpdateViewTileComponent.onInit', this.view, this.tile);\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.form.value);\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst tile = payload;\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t\tthis.update.next({ view, tile });\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.busy = false;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, 300);\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { tile: this.tile } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, tile: this.tile });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, tile: this.tile.selected ? null : this.tile });\r\n\t}\r\n}\r\n\r\nUpdateViewTileComponent.meta = {\r\n\tselector: 'update-view-tile',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'tile'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: tile.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon name=\"tile\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\">Tile {{tile.id}}</div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"tile.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<!--\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t-->\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { auditTime, distinctUntilChanged, filter, first, takeUntil } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport MessageService from '../../message/message.service';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\nimport { View, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class UpdateViewComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateView(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.orbit$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (this.view.type.name) {\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tthis.form.patch({\r\n\t\t\t\t\t\tlatitude: message.orientation.latitude,\r\n\t\t\t\t\t\tlongitude: message.orientation.longitude,\r\n\t\t\t\t\t\tzoom: message.zoom,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\torbit$() {\r\n\t\tlet latitude, longitude, zoom = null;\r\n\t\treturn MessageService.in$.pipe(\r\n\t\t\tfilter(message => message.type === MessageType.ControlInfo),\r\n\t\t\tauditTime(65),\r\n\t\t\tdistinctUntilChanged((previous, current) => {\r\n\t\t\t\tconst didChange = (latitude !== current.orientation.latitude ||\r\n\t\t\t\t\tlongitude !== current.orientation.longitude ||\r\n\t\t\t\t\tzoom !== current.zoom);\r\n\t\t\t\tlatitude = current.orientation.latitude;\r\n\t\t\t\tlongitude = current.orientation.longitude;\r\n\t\t\t\tzoom = current.zoom;\r\n\t\t\t\treturn !didChange;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tgetAssetDidChange(changes) {\r\n\t\tconst view = this.view;\r\n\t\tconst assetDidChange = AssetService.assetDidChange(view.asset, changes.asset);\r\n\t\tconst usdzDidChange = AssetService.assetDidChange(view.ar ? view.ar.usdz : null, changes.usdz);\r\n\t\tconst gltfDidChange = AssetService.assetDidChange(view.ar ? view.ar.gltf : null, changes.gltf);\r\n\t\tif (assetDidChange || usdzDidChange || gltfDidChange) {\r\n\t\t\t// console.log('UpdateViewComponent.getAssetDidChange', assetDidChange, usdzDidChange, gltfDidChange);\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateView(changes) {\r\n\t\tconst assetDidChange = this.getAssetDidChange(changes);\r\n\t\t// console.log('doUpdateItem.assetDidChange', assetDidChange);\r\n\t\tif (assetDidChange) {\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst view = this.view;\r\n\t\tif (!this.type || this.type.name !== view.type.name) {\r\n\t\t\tthis.type = view.type;\r\n\t\t\tconst form = this.form;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (view.type.name) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name'];\r\n\t\t\t}\r\n\t\t\tif (view.type.name !== ViewType.WaitingRoom.name && environment.flags.ar) {\r\n\t\t\t\tkeys.push('usdz?');\r\n\t\t\t\tkeys.push('gltf?');\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'latitude':\r\n\t\t\t\t\tcase 'longitude':\r\n\t\t\t\t\t\tconst orientation = view.orientation || { latitude: 0, longitude: 0 };\r\n\t\t\t\t\t\tform.add(new FormControl(orientation[key], RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'usdz':\r\n\t\t\t\t\tcase 'gltf':\r\n\t\t\t\t\t\tform.add(new FormControl((view.ar ? (view.ar[key] || null) : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tform.add(new FormControl((view[key] != null ? view[key] : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.view, this.form.value);\r\n\t\t\tif (payload.latitude != null) { // !!! keep loose inequality\r\n\t\t\t\tpayload.orientation = {\r\n\t\t\t\t\tlatitude: payload.latitude,\r\n\t\t\t\t\tlongitude: payload.longitude,\r\n\t\t\t\t};\r\n\t\t\t\tdelete payload.latitude;\r\n\t\t\t\tdelete payload.longitude;\r\n\t\t\t}\r\n\t\t\tconst usdz = payload.usdz || null;\r\n\t\t\tconst gltf = payload.gltf || null;\r\n\t\t\tdelete payload.usdz;\r\n\t\t\tdelete payload.gltf;\r\n\t\t\tpayload.ar = (usdz || gltf) ? { usdz, gltf } : null;\r\n\t\t\tconst view = new View(payload);\r\n\t\t\tEditorService.viewUpdate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewComponent.onSubmit.viewUpdate$.success', response);\r\n\t\t\t\tthis.update.next({ view });\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 300);\r\n\t\t\t}, error => console.log('UpdateViewComponent.onSubmit.viewUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: new View(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { item: this.item } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view.selected ? null : this.view });\r\n\t}\r\n\r\n\tgetTitle(view) {\r\n\t\treturn LabelPipe.getKeys('editor', view.type.name);\r\n\t}\r\n}\r\n\r\nUpdateViewComponent.meta = {\r\n\tselector: 'update-view',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: view.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"view.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"view.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(view)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"view.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'waiting-room'\">\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama-grid'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'model'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name != 'waiting-room' && ('ar' | flag)\">\r\n\t\t\t\t<div control-model [control]=\"controls.usdz\" label=\"AR IOS (.usdz)\" accept=\".usdz\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.gltf\" label=\"AR Android (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" *if=\"view.type.name != 'waiting-room'\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Module } from 'rxcomp';\r\nimport ToastOutletComponent from '../toast/toast-outlet.component';\r\nimport AsideComponent from './aside/aside.component';\r\nimport EditorComponent from './editor.component';\r\nimport MenuBuilderComponent from './menu/menu-builder.component';\r\nimport CurvedPlaneModalComponent from './modals/curved-plane-modal.component';\r\nimport ItemModelModalComponent from './modals/item-model-modal.component';\r\nimport ModelModalComponent from './modals/model-modal.component';\r\nimport NavModalComponent from './modals/nav-modal.component';\r\nimport PanoramaGridModalComponent from './modals/panorama-grid-modal.component';\r\nimport PanoramaModalComponent from './modals/panorama-modal.component';\r\nimport PlaneModalComponent from './modals/plane-modal.component';\r\nimport RemoveModalComponent from './modals/remove-modal.component';\r\nimport UpdateViewItemComponent from './update/update-view-item.component';\r\nimport UpdateViewTileComponent from './update/update-view-tile.component';\r\nimport UpdateViewComponent from './update/update-view.component';\r\n\r\nconst factories = [\r\n\tAsideComponent,\r\n\tCurvedPlaneModalComponent,\r\n\tEditorComponent,\r\n\tItemModelModalComponent,\r\n\tMenuBuilderComponent,\r\n\tModelModalComponent,\r\n\tNavModalComponent,\r\n\tPanoramaModalComponent,\r\n\tPanoramaGridModalComponent,\r\n\tPlaneModalComponent,\r\n\tRemoveModalComponent,\r\n\tToastOutletComponent,\r\n\tUpdateViewItemComponent,\r\n\tUpdateViewTileComponent,\r\n\tUpdateViewComponent,\r\n];\r\n\r\nconst pipes = [];\r\n\r\nexport class EditorModule extends Module { }\r\n\r\nEditorModule.meta = {\r\n\timports: [],\r\n\tdeclarations: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t],\r\n\texports: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t]\r\n};\r\n","import { Pipe } from \"rxcomp\";\r\nimport { environment } from \"../environment\";\r\n\r\nexport default class FlagPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst flags = environment.flags;\r\n\t\treturn flags[key] || false;\r\n\t}\r\n\r\n}\r\n\r\nFlagPipe.meta = {\r\n\tname: 'flag',\r\n};\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { BehaviorSubject, combineLatest, EMPTY, fromEvent, merge, of, ReplaySubject } from \"rxjs\";\r\nimport { delayWhen, filter, first, map, switchMap, tap } from \"rxjs/operators\";\r\nimport { Asset, assetTypeFromPath } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class UploadItem {\r\n\r\n\tconstructor(file) {\r\n\t\tthis.file = file;\r\n\t\tthis.name = file.name;\r\n\t\tthis.type = assetTypeFromPath(file.name);\r\n\t\tthis.progress = 0;\r\n\t\tthis.size = file.size;\r\n\t\tthis.uploading = false;\r\n\t\tthis.paused = false;\r\n\t\tthis.success = false;\r\n\t\tthis.complete = false;\r\n\t\tthis.error = null;\r\n\t\tthis.preview = null;\r\n\t}\r\n\r\n}\r\n\r\nexport class UploadEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class UploadStartEvent extends UploadEvent { }\r\n\r\nexport class UploadCompleteEvent extends UploadEvent { }\r\n\r\nexport class UploadAssetEvent extends UploadEvent { }\r\n\r\nexport class UploadService {\r\n\r\n\tconstructor() {\r\n\t\tthis.concurrent$ = new BehaviorSubject(0);\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tupload$() {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst uploadItems = items.filter(item => !item.uploading);\r\n\t\treturn combineLatest(uploadItems.map(item => this.uploadItem$(item)));\r\n\t}\r\n\r\n\tuploadItem$(item) {\r\n\t\t// max 4 concurrent upload\r\n\t\titem.uploading = true;\r\n\t\tthis.events$.next(new UploadStartEvent({ item }));\r\n\t\tconst files = [item.file];\r\n\t\treturn of(files).pipe(\r\n\t\t\tdelayWhen(() => this.concurrent$.pipe(\r\n\t\t\t\tfilter(x => x < 4)\r\n\t\t\t)),\r\n\t\t\ttap(() => this.concurrent$.next(this.concurrent$.getValue() + 1)),\r\n\t\t\tfirst(),\r\n\t\t\tswitchMap(files => AssetService.upload$(files)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t\tthis.concurrent$.next(this.concurrent$.getValue() - 1);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t/*\r\n\t\t// concurrent upload\r\n\t\treturn AssetService.upload$([item.file]).pipe(\r\n\t\t\t// tap(upload => console.log('upload', upload)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\taddItems(files) {\r\n\t\tif (files && files.length) {\r\n\t\t\t// console.log('addItems', files);\r\n\t\t\tconst items = this.items$.getValue();\r\n\t\t\tconst newItems = Array.from(files).map(file => new UploadItem(file));\r\n\t\t\titems.push(...newItems);\r\n\t\t\tthis.items$.next(items);\r\n\t\t}\r\n\t}\r\n\r\n\tremove(item) {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst index = items.indexOf(item);\r\n\t\tif (index !== -1) {\r\n\t\t\titems.splice(index, 1);\r\n\t\t}\r\n\t\tthis.items$.next(items);\r\n\t}\r\n\r\n\tremoveAll() {\r\n\t\t// !!!\r\n\t\tthis.items$.next([]);\r\n\t}\r\n\r\n\tdrop$(input, dropArea) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tdropArea = dropArea || input;\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\t// console.log('UploadService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === dropArea) {\r\n\t\t\t\t\t\tthis.addItems(event.dataTransfer.files);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tchange$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tswitchMap((event) => {\r\n\t\t\t\t\tif (input.files.length) {\r\n\t\t\t\t\t\tthis.addItems(input.files);\r\n\t\t\t\t\t\tinput.value = '';\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tfiles$(files) {\r\n\t\treturn combineLatest(Array.from(files).map((file, i) => this.file$(file, i)));\r\n\t}\r\n\r\n\tfile$(file, i) {\r\n\t\treturn this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\tstatic files$(files) {\r\n\t\tconst fileArray = Array.from(files);\r\n\t\tthis.previews = fileArray.map(() => null);\r\n\t\tconst uploads$ = fileArray.map((file, i) => this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t));\r\n\t\treturn combineLatest(uploads$);\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tthis.resize(blob, (resized) => {\r\n\t\t\t\t\tthis.previews[i] = resized;\r\n\t\t\t\t\t// console.log('resized', resized);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tuploadFile$(file) {\r\n\t\treturn AssetService.upload$([file]).pipe(\r\n\t\t\t// tap(upload => console.log('upload', upload)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t/*\r\n\t\t\t\tid: 1601303293569\r\n\t\t\t\ttype: \"image/jpeg\"\r\n\t\t\t\tfile: \"1601303293569_ambiente1_x0_y2.jpg\"\r\n\t\t\t\toriginalFileName: \"ambiente1_x0_y2.jpg\"\r\n\t\t\t\turl: \"/uploads/1601303293569_ambiente1_x0_y2.jpg\"\r\n\t\t\t\t*/\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tresize(blob, callback) {\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tcallback(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t}\r\n\t}\r\n\r\n\tsupported() {\r\n\t\treturn supportFileAPI() && supportAjaxUploadProgressEvents() && supportFormData();\r\n\t\tfunction supportFileAPI() {\r\n\t\t\tvar input = document.createElement('input');\r\n\t\t\tinput.type = 'file';\r\n\t\t\treturn 'files' in input;\r\n\t\t}\r\n\t\tfunction supportAjaxUploadProgressEvents() {\r\n\t\t\tvar xhr = new XMLHttpRequest();\r\n\t\t\treturn !!(xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));\r\n\t\t}\r\n\t\tfunction supportFormData() {\r\n\t\t\treturn !!window.FormData;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { getContext } from 'rxcomp';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { UploadAssetEvent, UploadService } from '../upload/upload.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetsComponent extends ControlComponent {\r\n\r\n\tget items() {\r\n\t\treturn this.items_;\r\n\t}\r\n\tset items(items) {\r\n\t\tthis.items_ = items;\r\n\t\tthis.uploadCount = items.reduce((p, c) => {\r\n\t\t\treturn p + (c.uploading || c.completed ? 0 : 1);\r\n\t\t}, 0);\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.multiple = (this.multiple !== false);\r\n\t\tthis.items = [];\r\n\t\tthis.assets = this.control.value || [];\r\n\t\tthis.hasFiles = false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tconst dropArea = node.querySelector('.upload-drop');\r\n\t\tconst service = this.service = new UploadService();\r\n\t\tservice.drop$(input, dropArea).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.drop$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.change$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.events$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// console.log('ControlAssetComponent.events$', event);\r\n\t\t\tif (event instanceof UploadAssetEvent) {\r\n\t\t\t\tthis.assets.push(event.asset);\r\n\t\t\t\tthis.control.value = this.assets;\r\n\t\t\t}\r\n\t\t\tthis.items = this.items;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// this.control.value = assets;\r\n\t\t});\r\n\t}\r\n\r\n\tonUpload() {\r\n\t\t// console.log('ControlAssetsComponent.onUpload');\r\n\t\tthis.service.upload$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\t// console.log('ControlAssetsComponent.onCancel');\r\n\t\tthis.service.removeAll();\r\n\t}\r\n\r\n\tonItemPause(item) {\r\n\t\t// console.log('ControlAssetsComponent.onPause', item);\r\n\t}\r\n\r\n\tonItemResume(item) {\r\n\t\t// console.log('ControlAssetsComponent.onResume', item);\r\n\t}\r\n\r\n\tonItemCancel(item) {\r\n\t\t// console.log('ControlAssetsComponent.onCancel', item);\r\n\t}\r\n\r\n\tonItemRemove(item) {\r\n\t\t// console.log('ControlAssetsComponent.onRemove', item);\r\n\t\tthis.service.remove(item);\r\n\t}\r\n}\r\n\r\nControlAssetsComponent.meta = {\r\n\tselector: '[control-assets]',\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"listing--assets\">\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of assets\">\r\n\t\t\t\t\t<div class=\"upload-item\">\r\n\t\t\t\t\t\t<div class=\"picture\">\r\n\t\t\t\t\t\t\t<img [lazy]=\"item | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.type.name === 'image'\" />\r\n\t\t\t\t\t\t\t<video [src]=\"item | asset\" *if=\"item.type.name === 'video'\"></video>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"name\" [innerHTML]=\"item.file\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of items\">\r\n\t\t\t\t\t<div upload-item [item]=\"item\" (pause)=\"onItemPause($event)\" (resume)=\"onItemResume($event)\" (cancel)=\"onItemCancel($event)\" (remove)=\"onItemRemove($event)\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<div class=\"btn--browse\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t\t<input type=\"file\" accept=\"image/jpeg\" multiple />\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"btn--upload\" (click)=\"onUpload()\" *if=\"uploadCount > 0\" [innerHTML]=\"'upload' | label\"></div>\r\n\t\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\" *if=\"uploadCount > 0\" [innerHTML]=\"'cancel' | label\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"upload-drop\">\r\n    \t\t\t<span [innerHTML]=\"'drag_and_drop_images' | label\"></span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlCheckboxComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlCheckboxComponent.meta = {\r\n\tselector: '[control-checkbox]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--checkbox\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label>\r\n\t\t\t\t<input type=\"checkbox\" class=\"control--checkbox\" [formControl]=\"control\" [value]=\"true\" />\r\n\t\t\t\t<span [innerHTML]=\"label | html\"></span>\r\n\t\t\t</label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { fromEvent, merge } from 'rxjs';\r\nimport { filter, map, shareReplay, startWith } from 'rxjs/operators';\r\n\r\nexport default class KeyboardService {\r\n\r\n\tstatic keys = {};\r\n\r\n\tstatic keydown$() {\r\n\t\tif (!this.keydown$_) {\r\n\t\t\tthis.keydown$_ = fromEvent(window, 'keydown').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keydown$_;\r\n\t}\r\n\r\n\tstatic keyup$() {\r\n\t\tif (!this.keyup$_) {\r\n\t\t\tthis.keyup$_ = fromEvent(window, 'keyup').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keyup$_;\r\n\t}\r\n\r\n\tstatic keys$() {\r\n\t\tif (!this.keys$_) {\r\n\t\t\tthis.keys$_ = merge(this.keydown$(), this.keyup$()).pipe(\r\n\t\t\t\tmap(event => {\r\n\t\t\t\t\tconst keys = this.keys;\r\n\t\t\t\t\tif (event.type === 'keydown') {\r\n\t\t\t\t\t\tkeys[event.key] = true;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdelete keys[event.key];\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.keys;\r\n\t\t\t\t}),\r\n\t\t\t\tstartWith(this.keys),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.keys$_;\r\n\t}\r\n\r\n\tstatic key$() {\r\n\t\tif (!this.key$_) {\r\n\t\t\tconst regexp = /\\w/;\r\n\t\t\tthis.key$_ = this.keydown$().pipe(\r\n\t\t\t\tfilter(event => event.key && event.key.match(regexp)),\r\n\t\t\t\tmap(event => event.key),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.key$_;\r\n\t}\r\n\r\n\tstatic typing$() {\r\n\t\tif (!this.typing$_) {\r\n\t\t\tlet typing = '',\r\n\t\t\t\tto;\r\n\t\t\tthis.typing$_ = this.key$().pipe(\r\n\t\t\t\tmap(key => {\r\n\t\t\t\t\tif (to) {\r\n\t\t\t\t\t\tclearTimeout(to);\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttyping += key;\r\n\t\t\t\t\tto = setTimeout(() => {\r\n\t\t\t\t\t\ttyping = '';\r\n\t\t\t\t\t}, 1500);\r\n\t\t\t\t\treturn typing;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.typing$_;\r\n\t}\r\n\r\n}\r\n","import { getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlCustomSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.dropped = false;\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tKeyboardService.typing$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(word => {\r\n\t\t\tthis.scrollToWord(word);\r\n\t\t});\r\n\t\t/*\r\n\t\tKeyboardService.key$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(key => {\r\n\t\t\tthis.scrollToKey(key);\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tscrollToWord(word) {\r\n\t\t// console.log('ControlCustomSelectComponent.scrollToWord', word);\r\n\t\tconst items = this.control.options || [];\r\n\t\tlet index = -1;\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst x = items[i];\r\n\t\t\tif (x.name.toLowerCase().indexOf(word.toLowerCase()) === 0) {\r\n\t\t\t\t// console.log(word, x.name);\r\n\t\t\t\tindex = i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (index !== -1) {\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst dropdown = node.querySelector('.dropdown');\r\n\t\t\tconst navDropdown = node.querySelector('.nav--dropdown');\r\n\t\t\tconst item = navDropdown.children[index];\r\n\t\t\tdropdown.scrollTo(0, item.offsetTop);\r\n\t\t}\r\n\t}\r\n\r\n\tsetOption(item) {\r\n\t\t// console.log('setOption', item, this.isMultiple);\r\n\t\tlet value;\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst value = this.control.value || [];\r\n\t\t\tconst index = value.indexOf(item.id);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\t// if (value.length > 1) {\r\n\t\t\t\tvalue.splice(index, 1);\r\n\t\t\t\t// }\r\n\t\t\t} else {\r\n\t\t\t\tvalue.push(item.id);\r\n\t\t\t}\r\n\t\t\tvalue = value.length ? value.slice() : null;\r\n\t\t} else {\r\n\t\t\tvalue = item.id;\r\n\t\t\t// DropdownDirective.dropdown$.next(null);\r\n\t\t}\r\n\t\tthis.control.value = value;\r\n\t\tthis.change.next(value);\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst values = this.control.value || [];\r\n\t\t\treturn values.indexOf(item.id) !== -1;\r\n\t\t} else {\r\n\t\t\treturn this.control.value === item.id;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet value = this.control.value;\r\n\t\tconst items = this.control.options || [];\r\n\t\tif (this.isMultiple) {\r\n\t\t\tvalue = value || [];\r\n\t\t\tif (value.length) {\r\n\t\t\t\treturn value.map(v => {\r\n\t\t\t\t\tconst item = items.find(x => x.id === v || x.name === v);\r\n\t\t\t\t\treturn item ? item.name : '';\r\n\t\t\t\t}).join(', ');\r\n\t\t\t} else {\r\n\t\t\t\treturn LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst item = items.find(x => x.id === value || x.name === value);\r\n\t\t\tif (item) {\r\n\t\t\t\treturn item.name;\r\n\t\t\t} else {\r\n\t\t\t\treturn LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDropped($event) {\r\n\t\t// console.log('ControlCustomSelectComponent.onDropped', id);\r\n\t\tif (this.dropped && $event === null) {\r\n\t\t\tthis.control.touched = true;\r\n\t\t}\r\n\t\tthis.dropped = $event === this.dropdownId;\r\n\t}\r\n\r\n\tget isMultiple() {\r\n\t\treturn this.multiple && this.multiple !== false && this.multiple !== 'false';\r\n\t}\r\n}\r\n\r\nControlCustomSelectComponent.meta = {\r\n\tselector: '[control-custom-select]',\r\n\toutputs: ['change'],\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length, multiple: isMultiple }\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"control--custom-select\" [innerHTML]=\"getLabel()\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t<div class=\"category\" [innerHTML]=\"label\"></div>\r\n\t\t\t<ul class=\"nav--dropdown\" [class]=\"{ multiple: isMultiple }\">\r\n\t\t\t\t<li (click)=\"setOption(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.options\">\r\n\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name\"></span>\r\n\t\t\t\t</li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlLinkComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tmerge(fromEvent(input, 'input')).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tfromEvent(input, 'blur').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\tconsole.log('ControlLinkComponent.onInputDidChange', event.target.value);\r\n\t\t// event.target.value = event.target.value.replace(/[^\\d|\\.]/g, '');\r\n\t\t/*\r\n\t\tconst value = parseFloat(event.target.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\tconsole.log('ControlLinkComponent.onInputDidBlur', event.target.value);\r\n\t\tthis.control.touched = true;\r\n\t\tthis.value = this.input.value;\r\n\t}\r\n\r\n}\r\n\r\nControlLinkComponent.meta = {\r\n\tselector: '[control-link]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport { environment } from '../environment';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlLocalizedAssetComponent extends ControlComponent {\r\n\r\n\tget localizedValue() {\r\n\t\tlet asset = this.control.value;\r\n\t\tif (asset && asset.locale) {\r\n\t\t\tconst localizedAsset = asset.locale[this.currentLanguage];\r\n\t\t\tif (localizedAsset) {\r\n\t\t\t\tasset = localizedAsset;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn asset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.languages = environment.languages;\r\n\t\tthis.currentLanguage = environment.defaultLanguage;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => (this.languages.length > 1 ? AssetService.createOrUpdateLocalizedAsset$ : AssetService.createOrUpdateAsset$)(uploads, this.control, this.currentLanguage)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlLocalizedAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tsetLanguage(language) {\r\n\t\tthis.currentLanguage = language;\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nControlLocalizedAssetComponent.meta = {\r\n\tselector: '[control-localized-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"localizedValue | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"localizedValue && localizedValue.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"localizedValue | asset\" *if=\"localizedValue && localizedValue.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"localizedValue\" [innerHTML]=\"localizedValue.file\"></div>\r\n\t\t\t<ul class=\"nav--languages\" *if=\"languages.length > 1\">\r\n\t\t\t\t<li class=\"nav__item\" [class]=\"{ active: lang == currentLanguage }\" (click)=\"setLanguage(lang)\" [innerHTML]=\"lang\" *for=\"let lang of languages\"></li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest, of } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nexport default class ControlModelComponent extends ControlAssetComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || '.glb';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\t/*\r\n\t\tthis.click$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t*/\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(assets => {\r\n\t\t\tconsole.log('ControlModelComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tAssetService.assetDelete$(this.control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.control.value = null;\r\n\t\t\tthis.input.value = null;\r\n\t\t\tthis.control.touched = true; // !!!\r\n\t\t});\r\n\t\t// !!! delete upload\r\n\t\t// !!! delete asset\r\n\t}\r\n\r\n\t/*\r\n\tclick$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'click').pipe(\r\n\t\t\t\ttap(() => input.value = null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\treturn of(file);\r\n\t}\r\n}\r\n\r\nControlModelComponent.meta = {\r\n\tselector: '[control-model]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--model\">\r\n\t\t\t\t<div class=\"file-name\" *if=\"!control.value\" [innerHTML]=\"'select_file' | label\"></div>\r\n\t\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t\t\t<div class=\"btn--upload\"><input type=\"file\"><span [innerHTML]=\"'browse' | label\"></span></div>\r\n\t\t\t\t<div class=\"btn--remove\" *if=\"control.value\" (click)=\"onRemove($event)\"><span [innerHTML]=\"'remove' | label\"></span></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlNumberComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(value) {\r\n\t\tthis.control.value = value;\r\n\t}\r\n}\r\n\r\nControlNumberComponent.meta = {\r\n\tselector: '[control-number]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--number\">\r\n\t\t\t\t<input-value label=\"\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value\" (update)=\"updateValue($event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlPasswordComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlPasswordComponent.meta = {\r\n\tselector: '[control-password]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"password\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlSelectComponent.meta = {\r\n\tselector: '[control-select]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control\" required>\r\n\t\t\t\t<option [value]=\"null\" [innerHTML]=\"'select' | label\"></option>\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextComponent.meta = {\r\n\tselector: '[control-text]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextareaComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextareaComponent.meta = {\r\n\tselector: '[control-textarea]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--textarea\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<textarea class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [innerHTML]=\"label\" rows=\"6\" [disabled]=\"disabled\"></textarea>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlVectorComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(index, value) {\r\n\t\tconst values = this.control.value;\r\n\t\tvalues[index] = value;\r\n\t\tthis.control.value = values.slice();\r\n\t}\r\n}\r\n\r\nControlVectorComponent.meta = {\r\n\tselector: '[control-vector]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--vector\">\r\n\t\t\t\t<input-value label=\"x\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[0]\" (update)=\"updateValue(0, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"y\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[1]\" (update)=\"updateValue(1, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"z\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[2]\" (update)=\"updateValue(2, $event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class DisabledDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('DisabledDirective.onChanges', this.disabled);\r\n\t\tif (this.disabled === true) {\r\n\t\t\tnode.disabled = this.disabled;\r\n\t\t\tnode.setAttribute('disabled', this.disabled);\r\n\t\t} else {\r\n\t\t\tdelete node.disabled;\r\n\t\t\tnode.removeAttribute('disabled');\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nDisabledDirective.meta = {\r\n\tselector: 'input[disabled],textarea[disabled]',\r\n\tinputs: ['disabled'],\r\n};\r\n","import LabelPipe from '../label/label.pipe';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ErrorsComponent extends ControlComponent {\r\n\tgetLabel(key, value) {\r\n\t\tconst label = LabelPipe.transform(`error_${key}`);\r\n\t\treturn label;\r\n\t}\r\n}\r\n\r\nErrorsComponent.meta = {\r\n\tselector: 'errors-component',\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"inner\" [style]=\"{ display: control.invalid && control.touched ? 'block' : 'none' }\">\r\n\t\t<div class=\"error\" *for=\"let [key, value] of control.errors\">\r\n\t\t\t<span [innerHTML]=\"getLabel(key, value)\"></span>\r\n\t\t\t<!-- <span class=\"key\" [innerHTML]=\"key\"></span> <span class=\"value\" [innerHTML]=\"value | json\"></span> -->\r\n\t\t</div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { fromEvent, interval, merge, race } from 'rxjs';\r\nimport { filter, map, switchMap, takeUntil, tap } from 'rxjs/operators';\r\n\r\nexport default class InputValueComponent extends Component {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.value = this.value || 0;\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.increment$('.btn--more', 1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tthis.increment$('.btn--less', -1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\t// fromEvent(input, 'change')\r\n\t\tmerge(fromEvent(input, 'input')).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tfromEvent(input, 'blur').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t\t// fromEvent(node, 'focus').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onFocus(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\t// const node = getContext(this).node;\r\n\t\t// const value = node.value === '' ? null : node.value;\r\n\t\tevent.target.value = event.target.value.replace(/[^\\d|\\.]/g, '');\r\n\t\t// console.log('InputValueComponent.onInputDidChange', event.target.value);\r\n\t\t/*\r\n\t\tconst value = parseFloat(event.target.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\t// this.control.touched = true;\r\n\t\t// console.log('InputValueComponent.onInputDidBlur', event.target.value);\r\n\t\tconst value = parseFloat(this.input.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t} else {\r\n\t\t\t\tthis.input.value = this.getValue();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tincrement$(selector, sign) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst element = node.querySelector(selector);\r\n\t\tlet m, increment;\r\n\t\treturn race(fromEvent(element, 'mousedown'), fromEvent(element, 'touchstart')).pipe(\r\n\t\t\ttap(() => {\r\n\t\t\t\tincrement = this.increment;\r\n\t\t\t\tm = 32;\r\n\t\t\t}),\r\n\t\t\tswitchMap((e) => {\r\n\t\t\t\treturn interval(30).pipe(\r\n\t\t\t\t\tfilter((i) => {\r\n\t\t\t\t\t\treturn i % m === 0;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tmap(() => {\r\n\t\t\t\t\t\tconst i = increment * sign;\r\n\t\t\t\t\t\t// increment = Math.min(this.increment * 100, increment * 2);\r\n\t\t\t\t\t\tm = Math.max(1, Math.floor(m * 0.85));\r\n\t\t\t\t\t\treturn i;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\t// startWith(increment * sign),\r\n\t\t\t\t\ttakeUntil(race(fromEvent(element, 'mouseup'), fromEvent(element, 'touchend')))\r\n\t\t\t\t);\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\tgetValue() {\r\n\t\treturn this.value.toFixed(this.precision);\r\n\t}\r\n\tsetValue(sign) {\r\n\t\tthis.value += this.increment * sign;\r\n\t\tthis.update.next(this.value);\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nInputValueComponent.meta = {\r\n\tselector: 'input-value',\r\n\toutputs: ['update'],\r\n\tinputs: ['value', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--control\" [class]=\"{ disabled: disabled }\">\r\n\t\t\t<input type=\"text\" class=\"control--text\" [placeholder]=\"label\" [value]=\"getValue()\" [disabled]=\"disabled\" />\r\n\t\t\t<div class=\"control--trigger\">\r\n\t\t\t\t<div class=\"btn--more\" (click)=\"setValue(1)\">+</div>\r\n\t\t\t\t<div class=\"btn--less\" (click)=\"setValue(-1)\">-</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { ENV } from '../environment';\r\n\r\nexport default class TestComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = ENV;\r\n\t}\r\n\r\n\tonTest(event) {\r\n\t\tthis.test.next(event);\r\n\t}\r\n\r\n\tonReset(event) {\r\n\t\tthis.reset.next(event);\r\n\t}\r\n\r\n}\r\n\r\nTestComponent.meta = {\r\n\tselector: 'test-component',\r\n\tinputs: ['form'],\r\n\toutputs: ['test', 'reset'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"group--form--results\" *if=\"env.DEVELOPMENT\">\r\n\t\t<code [innerHTML]=\"form.value | json\"></code>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onTest($event)\"><span>test</span></button>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onReset($event)\"><span>reset</span></button>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class ValueDirective extends Directive {\r\n\r\n\tonChanges(changes) {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('ValueDirective.onChanges', this.value);\r\n\t\tnode.value = this.value;\r\n\t\tnode.setAttribute('value', this.value);\r\n\t}\r\n\r\n}\r\n\r\nValueDirective.meta = {\r\n\tselector: '[value]',\r\n\tinputs: ['value'],\r\n};\r\n","import { Pipe } from \"rxcomp\";\r\n\r\n/*\r\n['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n['\"', '&', ''', '<', '>', ' ', '¡', '¢', '£', '¤', '¥', '¦', '§', '¨', '©', 'ª', '«', '¬', '­', '®', '¯', '°', '±', '²', '³', '´', 'µ', '¶', '·', '¸', '¹', 'º', '»', '¼', '½', '¾', '¿', 'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ð', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', '×', 'Ø', 'Ù', 'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß', 'à', 'á', 'ã', 'ä', 'å', 'æ', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ð', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', '÷', 'ø', 'ù', 'ú', 'û', 'ü', 'ý', 'þ', 'ÿ', '&', '•', '°', '∞', '‰', '⋅', '±', '†', '—', '¬', 'µ', '⊥', '∥', '€', '£', '¥', '¢', '©', '®', '™', 'α', 'β', 'γ', 'δ', 'ε', 'ζ', 'η', 'θ', 'ι', 'κ', 'λ', 'μ', 'ν', 'ξ', 'ο', 'π', 'ρ', 'σ', 'τ', 'υ', 'φ', 'χ', 'ψ', 'ω', 'Α', 'Β', 'Γ', 'Δ', 'Ε', 'Ζ', 'Η', 'Θ', 'Ι', 'Κ', 'Λ', 'Μ', 'Ν', 'Ξ', 'Ο', 'Π', 'Ρ', 'Σ', 'Τ', 'Υ', 'Φ', 'Χ', 'Ψ', 'Ω'];\r\n*/\r\n\r\nexport default class HtmlPipe extends Pipe {\r\n\r\n\tstatic transform(value) {\r\n\t\tif (value) {\r\n\t\t\tvalue = value.replace(/&#(\\d+);/g, function(m, n) {\r\n\t\t\t\treturn String.fromCharCode(parseInt(n));\r\n\t\t\t});\r\n\t\t\tconst escapes = ['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n\t\t\tconst unescapes = ['\"', '&', '\\'', '<', '>', ' ', '¡', '¢', '£', '¤', '¥', '¦', '§', '¨', '©', 'ª', '«', '¬', '­', '®', '¯', '°', '±', '²', '³', '´', 'µ', '¶', '·', '¸', '¹', 'º', '»', '¼', '½', '¾', '¿', 'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ð', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', '×', 'Ø', 'Ù', 'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß', 'à', 'á', 'ã', 'ä', 'å', 'æ', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ð', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', '÷', 'ø', 'ù', 'ú', 'û', 'ü', 'ý', 'þ', 'ÿ', '&', '•', '°', '∞', '‰', '⋅', '±', '†', '—', '¬', 'µ', '⊥', '∥', '€', '£', '¥', '¢', '©', '®', '™', 'α', 'β', 'γ', 'δ', 'ε', 'ζ', 'η', 'θ', 'ι', 'κ', 'λ', 'μ', 'ν', 'ξ', 'ο', 'π', 'ρ', 'σ', 'τ', 'υ', 'φ', 'χ', 'ψ', 'ω', 'Α', 'Β', 'Γ', 'Δ', 'Ε', 'Ζ', 'Η', 'Θ', 'Ι', 'Κ', 'Λ', 'Μ', 'Ν', 'Ξ', 'Ο', 'Π', 'Ρ', 'Σ', 'Τ', 'Υ', 'Φ', 'Χ', 'Ψ', 'Ω'];\r\n\t\t\tconst rx = new RegExp(`(&${escapes.join(';)|(&')};)`, 'g');\r\n\t\t\tvalue = value.replace(rx, function() {\r\n\t\t\t\tfor (let i = 1; i < arguments.length; i++) {\r\n\t\t\t\t\tif (arguments[i]) {\r\n\t\t\t\t\t\t// console.log(arguments[i], unescapes[i - 1]);\r\n\t\t\t\t\t\treturn unescapes[i - 1];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// console.log(value);\r\n\t\t\treturn value;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHtmlPipe.meta = {\r\n\tname: 'html',\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class IdDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.setAttribute('id', this.id);\r\n\t}\r\n\r\n}\r\n\r\nIdDirective.meta = {\r\n\tselector: '[id]',\r\n\tinputs: ['id']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport default class LayoutComponent extends Component {\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tthis.state = {\r\n\t\t\tstatus: LocationService.get('status') || 'connected',\r\n\t\t\trole: LocationService.get('role') || 'publisher',\r\n\t\t\tmembersCount: 1,\r\n\t\t\tlive: true,\r\n\t\t\tchat: false,\r\n\t\t\tchatDirty: true,\r\n\t\t\tname: \"Jhon Appleseed\",\r\n\t\t\tuid: \"7341614597544882\"\r\n\t\t};\r\n\t\tthis.state.has3D = this.state.role !== RoleType.SmartDevice;\r\n\t\tthis.view = {\r\n\t\t\tlikes: 41,\r\n\t\t};\r\n\t\tthis.local = {};\r\n\t\tthis.screen = null;\r\n\t\tthis.remotes = new Array(8).fill(0).map((x, i) => ({ id: i + 1, }));\r\n\t\tStateService.patchState(this.state);\r\n\t\tconsole.log('LayoutComponent', this);\r\n\t\t// console.log(AgoraService.getUniqueUserId());\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tthis.patchState({ screen: !this.state.screen });\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tthis.patchState({ volumeMuted: !this.state.volumeMuted });\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tthis.patchState({ chat: !this.state.chat, chatDirty: false });\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tthis.patchState({ chat: false });\r\n\t}\r\n\r\n\tonToggleControl() {\r\n\t\tthis.patchState({ control: !this.state.control, spying: false });\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tconst spying = this.state.spying === remoteId ? null : remoteId;\r\n\t\tthis.patchState({ spying, control: false });\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tthis.view.liked = true; // view.liked;\r\n\t\tthis.showLove(this.view);\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\r\n\t}\r\n}\r\n\r\nLayoutComponent.meta = {\r\n\tselector: '[layout-component]',\r\n};\r\n","import { fromEvent, of } from 'rxjs';\r\nimport { auditTime, filter, finalize, map, takeWhile } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\n\r\nlet UID = 0;\r\n\r\nexport const ImageServiceEvent = {\r\n\tProgress: 'progress',\r\n\tComplete: 'complete',\r\n};\r\nexport default class ImageService {\r\n\r\n\tstatic worker() {\r\n\t\tif (!this.worker_) {\r\n\t\t\tthis.worker_ = new Worker(environment.worker);\r\n\t\t}\r\n\t\treturn this.worker_;\r\n\t}\r\n\r\n\tstatic events$(src, size) {\r\n\t\tif (!('Worker' in window) || this.isBlob(src) || this.isCors(src)) {\r\n\t\t\treturn of({ type: ImageServiceEvent.Complete, data:src });\r\n\t\t}\r\n\t\tconst id = ++UID;\r\n\t\tconst worker = this.worker();\r\n\t\tworker.postMessage({ src, id, size });\r\n\t\tlet lastEvent;\r\n\t\treturn fromEvent(worker, 'message').pipe(\r\n\t\t\tmap(event => event.data),\r\n\t\t\tfilter(event => event.src === src),\r\n\t\t\tauditTime(100),\r\n\t\t\tmap(event => {\r\n\t\t\t\t// console.log('ImageService', event);\r\n\t\t\t\tif (event.type === ImageServiceEvent.Complete && event.data instanceof Blob) {\r\n\t\t\t\t\tconst url = URL.createObjectURL(event.data);\r\n\t\t\t\t\tevent.data = url;\r\n\t\t\t\t}\r\n\t\t\t\tlastEvent = event;\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t\tfinalize(() => {\r\n\t\t\t\t// console.log('ImageService.finalize', lastEvent);\r\n\t\t\t\tworker.postMessage({ id });\r\n\t\t\t\t/*\r\n\t\t\t\tif (lastEvent && lastEvent.type === ImageServiceEvent.Complete && lastEvent.data) {\r\n\t\t\t\t\tURL.revokeObjectURL(lastEvent.data);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic load$(src, size) {\r\n\t\treturn this.events$(src, size).pipe(\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tmap(event => event.data),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic isCors(src) {\r\n\t\t// !!! handle cors environment flag\r\n\t\treturn false;\r\n\t\treturn src.indexOf('://') !== -1 && src.indexOf(window.location.host) === -1;\r\n\t}\r\n\r\n\tstatic isBlob(src) {\r\n\t\treturn src.indexOf('blob:') === 0;\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject, of , Subject } from 'rxjs';\r\nimport { filter, finalize, first, map } from 'rxjs/operators';\r\n\r\nexport default class IntersectionService {\r\n\r\n\tstatic observer() {\r\n\t\tif (!this.observer_) {\r\n\t\t\tthis.readySubject_ = new BehaviorSubject(false);\r\n\t\t\tthis.observerSubject_ = new Subject();\r\n\t\t\tthis.observer_ = new IntersectionObserver(entries => {\r\n\t\t\t\tthis.observerSubject_.next(entries);\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn this.observer_;\r\n\t}\r\n\r\n\tstatic intersection$(node) {\r\n\t\tif ('IntersectionObserver' in window) {\r\n\t\t\tconst observer = this.observer();\r\n\t\t\tobserver.observe(node);\r\n\t\t\treturn this.observerSubject_.pipe(\r\n\t\t\t\t// tap(entries => console.log(entries.length)),\r\n\t\t\t\tmap(entries => entries.find(entry => entry.target === node)),\r\n\t\t\t\t// tap(entry => console.log('IntersectionService.intersection$', entry)),\r\n\t\t\t\tfilter(entry => entry !== undefined && entry.isIntersecting), // entry.intersectionRatio > 0\r\n\t\t\t\tfirst(),\r\n\t\t\t\tfinalize(() => observer.unobserve(node)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of({ target: node });\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\tfunction observer() {\r\n\t\t\tif ('IntersectionObserver' in window) {\r\n\t\t\t\treturn new IntersectionObserver(entries => {\r\n\t\t\t\t\tentries.forEach(function(entry) {\r\n\t\t\t\t\t\tif (entry.isIntersecting) {\r\n\t\t\t\t\t\t\tentry.target.classList.add('appear');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\treturn { observe: function(node) { node.classList.add('appear')}, unobserve: function() {} };\r\n\t\t\t}\r\n\t\t}\r\n\t\tobserver.observe(node);\r\n\t\tobserver.unobserve(node);\r\n\t\t*/\r\n\r\n\t}\r\n\r\n}\r\n","export default class LazyCache {\r\n\tstatic get cache() {\r\n\t\tif (!this.cache_) {\r\n\t\t\tthis.cache_ = {};\r\n\t\t}\r\n\t\treturn this.cache_;\r\n\t}\r\n\r\n\tstatic get(src) {\r\n\t\treturn this.cache[src];\r\n\t}\r\n\r\n\tstatic set(src, blob) {\r\n\t\tthis.cache[src] = blob;\r\n\t\tconst keys = Object.keys(this.cache);\r\n\t\tif (keys.length > 100) {\r\n\t\t\tthis.remove(keys[0]);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remove(src) {\r\n\t\tdelete this.cache[src];\r\n\t}\r\n}\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { of, Subject } from 'rxjs';\r\nimport { distinctUntilChanged, first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport ImageService from '../image/image.service';\r\nimport IntersectionService from '../intersection/intersection.service';\r\nimport LazyCache from './lazy.cache';\r\n\r\nexport default class LazyDirective extends Directive {\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('lazy');\r\n\t\tthis.input$ = new Subject().pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t\tswitchMap(input => {\r\n\t\t\t\tconst src = LazyCache.get(input);\r\n\t\t\t\tif (src) {\r\n\t\t\t\t\treturn of(src);\r\n\t\t\t\t}\r\n\t\t\t\tnode.classList.remove('lazyed');\r\n\t\t\t\treturn this.lazy$(input);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t);\r\n\t\tthis.input$.subscribe(src => {\r\n\t\t\tLazyCache.set(this.lazy, src);\r\n\t\t\tnode.setAttribute('src', src);\r\n\t\t\tnode.classList.add('lazyed');\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.input$.next(this.lazy);\r\n\t}\r\n\r\n\tlazy$(input) {\r\n\t\tconst { node } = getContext(this);\r\n\t\treturn IntersectionService.intersection$(node).pipe(\r\n\t\t\t// first(),\r\n\t\t\tswitchMap(() => ImageService.load$(input, this.size)),\r\n\t\t\tfirst(),\r\n\t\t\t// takeUntil(this.unsubscribe$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n\r\nLazyDirective.meta = {\r\n\tselector: '[lazy],[[lazy]]',\r\n\tinputs: ['lazy', 'size']\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from './modal-outlet.component';\r\nimport ModalService from './modal.service';\r\n\r\nexport default class ModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nModalComponent.meta = {\r\n\tselector: '[modal]'\r\n};\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\n\r\nexport default class SlugPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst url = environment.url;\r\n\t\treturn url[key] || `#${key}`;\r\n\t}\r\n\r\n}\r\n\r\nSlugPipe.meta = {\r\n\tname: 'slug',\r\n};\r\n","import { getContext, Structure } from 'rxcomp';\r\n\r\nexport default class SvgIconStructure extends Structure {\r\n\tonInit() {\r\n\t\tthis.update();\r\n\t}\r\n\tonChanges() {\r\n\t\tthis.update();\r\n\t}\r\n\tupdate() {\r\n\t\tif (this.name_ !== this.name) {\r\n\t\t\tthis.name_ = this.name;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tif (node.parentNode) {\r\n\t\t\t\tconst xmlns = 'http://www.w3.org/2000/svg';\r\n\t\t\t\tconst element = document.createElementNS(xmlns, `svg`);\r\n\t\t\t\tconst w = this.width || 24;\r\n\t\t\t\tconst h = this.height || 24;\r\n\t\t\t\telement.setAttribute('class', `icon--${this.name}`);\r\n\t\t\t\t// element.setAttributeNS(null, 'width', w);\r\n\t\t\t\t// element.setAttributeNS(null, 'height', h);\r\n\t\t\t\telement.setAttributeNS(null, 'viewBox', `0 0 ${w} ${h}`);\r\n\t\t\t\telement.innerHTML = `<use xlink:href=\"#${this.name}\"></use>`;\r\n\t\t\t\telement.rxcompId = node.rxcompId;\r\n\t\t\t\telement.classList.add(...node.classList);\r\n\t\t\t\tnode.parentNode.replaceChild(element, node);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nSvgIconStructure.meta = {\r\n\tselector: 'svg-icon',\r\n\tinputs: ['name', 'width', 'height']\r\n};\r\n\r\n/*\r\n<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n*/\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport ViewService from '../view/view.service';\r\n\r\nexport default class TryInARComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.missingAr = false;\r\n\t\tthis.missingUsdz = false;\r\n\t\tthis.missingGltf = false;\r\n\t\tconst viewId = this.viewId = this.getViewId();\r\n\t\t// console.log('TryInARComponent.viewId', viewId);\r\n\t\tif (viewId) {\r\n\t\t\tViewService.viewById$(viewId).pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(view => {\r\n\t\t\t\tif (!view.ar) {\r\n\t\t\t\t\tthis.missingAr = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('TryInARComponent.view', view);\r\n\t\t\t\tif (this.platform === DevicePlatform.IOS) {\r\n\t\t\t\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\t\t\t\tif (usdzSrc) {\r\n\t\t\t\t\t\twindow.location.href = usdzSrc;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.missingUsdz = true;\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (this.getGltfSrc(view) !== null) {\r\n\t\t\t\t\tconst modelViewerNode = this.getModelViewerNode(view);\r\n\t\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\t\tnode.appendChild(modelViewerNode);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.missingGltf = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tgetUsdzSrc(view) {\r\n\t\treturn (view.ar && view.ar.usdz) ? environment.getPath(view.ar.usdz.folder + view.ar.usdz.file) : null;\r\n\t}\r\n\r\n\tgetGltfSrc(view) {\r\n\t\treturn (view.ar && view.ar.gltf) ? environment.getPath(view.ar.gltf.folder + view.ar.gltf.file) : null;\r\n\t}\r\n\r\n\tgetViewId() {\r\n\t\tlet viewId = LocationService.get('viewId') || null;\r\n\t\tif (viewId) {\r\n\t\t\tviewId = parseInt(viewId);\r\n\t\t}\r\n\t\treturn viewId;\r\n\t}\r\n\r\n\tgetModelViewerNode(view) {\r\n\t\tconst panorama = environment.getPath(view.asset.folder + view.asset.file);\r\n\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\tconst gltfSrc = this.getGltfSrc(view);\r\n\t\tconst template = /* html */`\r\n\t\t\t<model-viewer alt=\"${view.name}\" skybox-image=\"${panorama}\" ios-src=\"${usdzSrc}\" src=\"${gltfSrc}\" ar ar-modes=\"webxr scene-viewer quick-look\" ar-scale=\"auto\" camera-controls></model-viewer>\r\n\t\t`;\r\n\t\tconst div = document.createElement(\"div\");\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n}\r\n\r\nTryInARComponent.meta = {\r\n\tselector: '[try-in-ar]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { fromEvent, of } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetType } from '../asset/asset';\r\n\r\nexport default class UploadItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\t// console.log('UploadItemComponent.onInit', this.item);\r\n\t\tif (this.item.preview === null) {\r\n\t\t\tthis.read$(this.item.file).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe(preview => {\r\n\t\t\t\tthis.item.preview = preview;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tread$(file) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tif (this.item.type.name === AssetType.Image.name) {\r\n\t\t\t\t\treturn this.resize$(blob);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn of(blob);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tresize$(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function(error) {\r\n\t\t\t\treject(error);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n\r\n\tonPause() {\r\n\t\tthis.pause.next(this.item);\r\n\t}\r\n\r\n\tonResume() {\r\n\t\tthis.resume.next(this.item);\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tthis.cancel.next(this.item);\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tthis.remove.next(this.item);\r\n\t}\r\n}\r\n\r\nUploadItemComponent.meta = {\r\n\tselector: '[upload-item]',\r\n\toutputs: ['pause', 'resume', 'cancel', 'remove'],\r\n\tinputs: ['item'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"upload-item\" [class]=\"{ 'error': item.error, 'success': item.success }\">\r\n\t\t<div class=\"picture\">\r\n\t\t\t<img [lazy]=\"item.preview\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.preview && item.type.name === 'image'\" />\r\n\t\t\t<video [src]=\"item.preview\" *if=\"item.preview && item.type.name === 'video'\"></video>\r\n\t\t\t<svg class=\"spinner\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" [class]=\"{ uploading: item.uploading }\" *if=\"item.uploading\"><use xlink:href=\"#spinner\"></use></svg>\r\n\t\t</div>\r\n\t\t<div class=\"name\">{{item.name}}</div>\r\n\t\t<!--\r\n\t\t<div class=\"group--info\">\r\n\t\t\t<div>progress: {{item.progress}}</div>\r\n\t\t\t<div>size: {{item.size}} bytes</div>\r\n\t\t\t<div>current speed: {{item.currentSpeed}} bytes/s</div>\r\n\t\t\t<div>average speed: {{item.averageSpeed}} bytes/s</div>\r\n\t\t\t<div>time ramining: {{item.timeRemaining}}s</div>\r\n\t\t\t<div>paused: {{item.paused}}</div>\r\n\t\t\t<div>success: {{item.success}}</div>\r\n\t\t\t<div>complete: {{item.complete}}</div>\r\n\t\t\t<div>error: {{item.error}}</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<!--\r\n\t\t<div class=\"group--cta\" *if=\"!item.complete && item.uploading\">\r\n\t\t\t<div class=\"btn--pause\" (click)=\"onPause()\">pause</div>\r\n\t\t\t<div class=\"btn--resume\" (click)=\"onResume()\">resume</div>\r\n\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\">cancel</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<div class=\"group--cta\">\r\n\t\t\t<div class=\"btn--remove\" (click)=\"onRemove()\" *if=\"!item.complete\">remove</div>\r\n\t\t</div>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class HlsDirective extends Directive {\r\n\r\n\tset hls(hls) {\r\n\t\tif (this.hls_ !== hls) {\r\n\t\t\tthis.hls_ = hls;\r\n\t\t\tthis.play(hls);\r\n\t\t}\r\n\t}\r\n\r\n\tget hls() {\r\n\t\treturn this.hls_;\r\n\t}\r\n\r\n\tplay(src) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\t// bind them together\r\n\t\t\thls.attachMedia(node);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\tnode.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHlsDirective.meta = {\r\n\tselector: '[[hls]]',\r\n\tinputs: ['hls'],\r\n};\r\n","import { Context } from 'rxcomp';\r\n\r\nexport default class VirtualItem extends Context {\r\n\tconstructor(key, $key, value, $value, index, count, parentInstance) {\r\n\t\tsuper(parentInstance);\r\n\t\tthis[key] = $key;\r\n\t\tthis[value] = $value;\r\n\t\tthis.index = index;\r\n\t\tthis.count = count;\r\n\t}\r\n\r\n\tget first() {\r\n\t\treturn this.index === 0;\r\n\t}\r\n\r\n\tget last() {\r\n\t\treturn this.index === this.count - 1;\r\n\t}\r\n\r\n\tget even() {\r\n\t\treturn this.index % 2 === 0;\r\n\t}\r\n\r\n\tget odd() {\r\n\t\treturn !this.even;\r\n\t}\r\n}\r\n","import { getContext, Structure } from 'rxcomp';\r\nimport { BehaviorSubject, fromEvent, merge } from 'rxjs';\r\nimport { auditTime, distinctUntilChanged, map, startWith, takeUntil, tap } from 'rxjs/operators';\r\nimport VirtualItem from './virtual.item';\r\n\r\nexport const VirtualMode = {\r\n\tResponsive: 1,\r\n\tGrid: 2,\r\n\tCentered: 3,\r\n\tList: 4\r\n};\r\n\r\nexport default class VirtualStructure extends Structure {\r\n\r\n\tonInit() {\r\n\t\tconst { module, node } = getContext(this);\r\n\t\tconst template = node.firstElementChild;\r\n\t\tconst expression = node.getAttribute('*virtual');\r\n\t\tnode.removeAttribute('*virtual');\r\n\t\tnode.removeChild(template);\r\n\t\tconst tokens = (this.tokens = this.getExpressionTokens(expression));\r\n\t\tthis.virtualFunction = module.makeFunction(tokens.iterable);\r\n\t\tthis.container = node;\r\n\t\tthis.template = template;\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.reverse = this.reverse === true ? true : false;\r\n\t\tthis.options = {\r\n\t\t\twidth: this.width,\r\n\t\t\tgutter: this.gutter,\r\n\t\t\treverse: this.reverse,\r\n\t\t\tcontainerWidth: 0,\r\n\t\t\tcontainerHeight: 0,\r\n\t\t\ttop: 0,\r\n\t\t\tcols: [0],\r\n\t\t};\r\n\t\tthis.cachedRects = {};\r\n\t\tthis.cachedInstances = [];\r\n\t\tthis.cacheNodes = [];\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.update$()\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe(visibleItems => {\r\n\t\t\t\t// console.log(visibleItems.length);\r\n\t\t\t});\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\t// resolve\r\n\t\tconst items = module.resolve(this.virtualFunction, context.parentInstance, this) || [];\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.options.width = this.width;\r\n\t\tthis.updateView(true);\r\n\t\tthis.items$.next(items);\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t}\r\n\r\n\tupdate$() {\r\n\t\treturn merge(this.scroll$(), this.resize$(), this.items$.pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t)).pipe(\r\n\t\t\tmap(_ => {\r\n\t\t\t\tconst visibleItems = this.updateForward();\r\n\t\t\t\treturn visibleItems;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tupdateForward() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = 0, len = items.length; i < len; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tconst parentContainer = this.container.parentNode;\r\n\t\tif (this.reverse && (highestHeight < parentContainer.offsetHeight - 1)) {\r\n\t\t\tconst diff = parentContainer.offsetHeight - 1 - highestHeight;\r\n\t\t\titems.forEach((item, i) => {\r\n\t\t\t\tif (visibleItems.indexOf(item) !== -1) {\r\n\t\t\t\t\tconst rect = this.cachedRects[i];\r\n\t\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\t\tnode.style.top = (rect.top + diff) + 'px';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.container.style.height = `${parentContainer.offsetHeight - 1}px`;\r\n\t\t} else {\r\n\t\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\t}\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\t/*\r\n\tupdateForward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = items.filter((item, i) => {\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t});\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\tupdateBackward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet lowestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = items.length - 1; i >= 0; i--) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\tbottom = options.cols[col];\r\n\t\t\tif (this.intersect(bottom - height + options.top, bottom + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, -top);\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom: bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.top = top;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, top);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${-lowestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\t*/\r\n\r\n\tgetCols() {\r\n\t\tconst options = this.options;\r\n\t\tconst cols = Math.floor((options.containerWidth + options.gutter) / (options.width + options.gutter)) || 1;\r\n\t\treturn new Array(cols).fill(0);\r\n\t}\r\n\r\n\tgetCol() {\r\n\t\tconst options = this.options;\r\n\t\tlet col;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tcol = options.cols.reduce((p, c, i, a) => {\r\n\t\t\t\t\treturn c < a[p] ? i : p;\r\n\t\t\t\t}, 0);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tcol = 0;\r\n\t\t}\r\n\t\treturn col;\r\n\t}\r\n\r\n\tgetWidth() {\r\n\t\tconst options = this.options;\r\n\t\tlet width;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\twidth = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\twidth = (options.containerWidth - (options.cols.length - 1) * options.gutter) / options.cols.length;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\twidth = options.containerWidth;\r\n\t\t}\r\n\t\treturn width;\r\n\t}\r\n\r\n\tgetHeight(width, item) {\r\n\t\tconst options = this.options;\r\n\t\tlet height;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\theight = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\theight = 80;\r\n\t\t}\r\n\t\treturn height;\r\n\t}\r\n\r\n\tgetGutter(width) {\r\n\t\tconst options = this.options;\r\n\t\tlet gutter;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tgutter = options.gutter;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tgutter = (options.containerWidth - options.cols.length * width) / (options.cols.length - 1);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tgutter = 0;\r\n\t\t}\r\n\t\treturn gutter;\r\n\t}\r\n\r\n\tgetLeft(index, width, gutter) {\r\n\t\tconst options = this.options;\r\n\t\tlet left;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tleft = index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tleft = (options.containerWidth - options.cols.length * (width + gutter) + gutter) / 2 + index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tleft = 0;\r\n\t\t}\r\n\t\treturn left;\r\n\t}\r\n\r\n\tcachedNode(index, i, value, total) {\r\n\t\tif (this.cacheNodes[index]) {\r\n\t\t\treturn this.updateNode(index, i, value);\r\n\t\t} else {\r\n\t\t\treturn this.createNode(index, i, value, total);\r\n\t\t}\r\n\t}\r\n\r\n\tcreateNode(index, i, value, total) {\r\n\t\tconst clonedNode = this.template.cloneNode(true);\r\n\t\tdelete clonedNode.rxcompId;\r\n\t\tthis.container.appendChild(clonedNode);\r\n\t\tthis.cacheNodes[index] = clonedNode;\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\tconst tokens = this.tokens;\r\n\t\tconst args = [tokens.key, i, tokens.value, value, i, total, context.parentInstance];\r\n\t\tconst instance = module.makeInstance(clonedNode, VirtualItem, context.selector, context.parentInstance, args);\r\n\t\tconst forItemContext = getContext(instance);\r\n\t\tmodule.compile(clonedNode, forItemContext.instance);\r\n\t\tthis.cachedInstances[index] = instance;\r\n\t\treturn clonedNode;\r\n\t}\r\n\r\n\tupdateNode(index, i, value) {\r\n\t\tconst instance = this.cachedInstances[index];\r\n\t\tconst tokens = this.tokens;\r\n\t\tif (instance[tokens.key] !== i) {\r\n\t\t\tinstance[tokens.key] = i;\r\n\t\t\tinstance[tokens.value] = value;\r\n\t\t\tinstance.pushChanges();\r\n\t\t}\r\n\t\t// console.log(index, i, value);\r\n\t\treturn this.cacheNodes[index];\r\n\t}\r\n\r\n\tremoveNode(index) {\r\n\t\tthis.cachedInstances[index] = undefined;\r\n\t\tconst node = this.cacheNodes[index];\r\n\t\tif (node) {\r\n\t\t\tconst context = getContext(this);\r\n\t\t\tconst module = context.module;\r\n\t\t\tnode.parentNode.removeChild(node);\r\n\t\t\tmodule.remove(node);\r\n\t\t}\r\n\t\tthis.cacheNodes[index] = undefined;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tintersect(top1, bottom1, top2, bottom2) {\r\n\t\treturn top2 < bottom1 && bottom2 > top1;\r\n\t}\r\n\r\n\tresize$() {\r\n\t\treturn fromEvent(window, 'resize').pipe(\r\n\t\t\tauditTime(100),\r\n\t\t\tstartWith(null),\r\n\t\t\ttap(() => this.updateView(true))\r\n\t\t);\r\n\t}\r\n\r\n\tscroll$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(node.parentNode, getComputedStyle(node.parentNode).overflowY, node.parentNode.style.overflowY);\r\n\t\tif (node.parentNode && getComputedStyle(node.parentNode).overflowY === 'auto') {\r\n\t\t\treturn fromEvent(node.parentNode, 'scroll').pipe(tap(() => {\r\n\t\t\t\tthis.updateView();\r\n\t\t\t}));\r\n\t\t} else {\r\n\t\t\treturn fromEvent(window, 'scroll').pipe(tap(() => this.updateView()));\r\n\t\t}\r\n\t}\r\n\r\n\tupdateView(reset) {\r\n\t\tconst rect = this.container.getBoundingClientRect();\r\n\t\tconst options = this.options;\r\n\t\toptions.top = rect.top;\r\n\t\toptions.containerWidth = rect.width;\r\n\t\toptions.containerHeight = rect.height; // window.innerHeight;\r\n\t\toptions.cols = this.getCols();\r\n\t\tif (reset) {\r\n\t\t\tthis.cachedRects = {};\r\n\t\t}\r\n\t}\r\n\r\n\tgetExpressionTokens(expression) {\r\n\t\tif (expression === null) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tif (expression.trim().indexOf('let ') === -1 || expression.trim().indexOf(' of ') === -1) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tconst expressions = expression\r\n\t\t\t.split(';')\r\n\t\t\t.map(x => x.trim())\r\n\t\t\t.filter(x => x !== '');\r\n\t\tconst virtualExpressions = expressions[0].split(' of ').map(x => x.trim());\r\n\t\tlet value = virtualExpressions[0].replace(/\\s*let\\s*/, '');\r\n\t\tconst iterable = virtualExpressions[1];\r\n\t\tlet key = 'index';\r\n\t\tconst keyValueMatches = value.match(/\\[(.+)\\s*,\\s*(.+)\\]/);\r\n\t\tif (keyValueMatches) {\r\n\t\t\tkey = keyValueMatches[1];\r\n\t\t\tvalue = keyValueMatches[2];\r\n\t\t}\r\n\t\tif (expressions.length > 1) {\r\n\t\t\tconst indexExpressions = expressions[1].split(/\\s*let\\s*|\\s*=\\s*index/).map(x => x.trim());\r\n\t\t\tif (indexExpressions.length === 3) {\r\n\t\t\t\tkey = indexExpressions[1];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn { key, value, iterable };\r\n\t}\r\n}\r\n\r\nVirtualStructure.meta = {\r\n\tselector: '[*virtual]',\r\n\tinputs: ['mode', 'width', 'gutter', 'reverse']\r\n};\r\n","import { BehaviorSubject, combineLatest, of, ReplaySubject } from 'rxjs';\r\nimport { map, switchAll } from 'rxjs/operators';\r\n\r\nlet LOADER_UID = 0;\r\n\r\nexport default class LoaderService {\r\n\r\n\tstatic progress = { value: 0, loaded: 0, total: 0, count: 0, title: '' };\r\n\r\n\tstatic items = {};\r\n\r\n\t// merge(this.statusSubject, this.validatorsSubject)\r\n\tstatic progress$ = new ReplaySubject(1).pipe(\r\n\t\tswitchAll(),\r\n\t\tmap(() => {\r\n\t\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\t\tconst progress = items.reduce((progress, subject, i, items) => {\r\n\t\t\t\tconst item = subject.getValue();\r\n\t\t\t\tconst loaded = item.loaded || 0;\r\n\t\t\t\tconst total = item.total || 1;\r\n\t\t\t\tconst value = loaded / total;\r\n\t\t\t\tprogress.value += value;\r\n\t\t\t\tprogress.loaded += loaded;\r\n\t\t\t\tprogress.total += total;\r\n\t\t\t\treturn progress;\r\n\t\t\t}, { value: 0, loaded: 0, total: 0 });\r\n\t\t\tprogress.count = items.length;\r\n\t\t\tif (items.length) {\r\n\t\t\t\tprogress.value /= progress.count;\r\n\t\t\t}\r\n\t\t\tprogress.title = `${Math.round(progress.value * 100)}%`;\r\n\t\t\tthis.progress = progress;\r\n\t\t\treturn progress;\r\n\t\t}),\r\n\t);\r\n\r\n\tstatic switchLoaders() {\r\n\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\tconst items$ = items.length ? combineLatest(items) : of(items);\r\n\t\tthis.progress$.next(items$);\r\n\t}\r\n\r\n\tstatic getRef() {\r\n\t\tconst ref = ++LOADER_UID;\r\n\t\tthis.items[ref] = new BehaviorSubject({ loaded: 0, total: 1 });\r\n\t\tthis.switchLoaders();\r\n\t\treturn ref;\r\n\t}\r\n\r\n\tstatic setProgress(ref, loaded, total = 1) {\r\n\t\tconst item = this.items[ref];\r\n\t\tif (item) {\r\n\t\t\titem.next({ loaded, total });\r\n\t\t}\r\n\t\tif (loaded >= total) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tdelete this.items[ref];\r\n\t\t\t\tthis.switchLoaders();\r\n\t\t\t}, 300);\r\n\t\t}\r\n\t\tthis.switchLoaders();\r\n\t}\r\n\r\n}\r\n","import { fromEvent } from 'rxjs';\r\nimport { filter, first, switchMap, takeWhile, tap } from 'rxjs/operators';\r\nimport { AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport ImageService, { ImageServiceEvent } from '../../image/image.service';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport StreamService from '../../stream/stream.service';\r\n// import DebugService from '../debug.service';\r\n\r\nexport class EnvMapLoader {\r\n\r\n\tstatic get video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tstatic set video(video) {\r\n\t\tif (this.video_) {\r\n\t\t\tthis.video_.muted = true;\r\n\t\t\tthis.video_.pause();\r\n\t\t\tif (this.video_.parentNode) {\r\n\t\t\t\tthis.video_.parentNode.removeChild(this.video_);\r\n\t\t\t}\r\n\t\t\tthis.video_ = null;\r\n\t\t}\r\n\t\tif (video) {\r\n\t\t\tconst video = this.video_ = document.createElement('video');\r\n\t\t\tvideo.loop = true;\r\n\t\t\t// video.muted = true;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\t// document.querySelector('body').appendChild(video);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tstatic set muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('EnvMapLoader.muted', muted, this.video);\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic set cubeRenderTarget(cubeRenderTarget) {\r\n\t\tif (this.cubeRenderTarget_) {\r\n\t\t\tthis.cubeRenderTarget_.texture.dispose();\r\n\t\t\tthis.cubeRenderTarget_.dispose();\r\n\t\t}\r\n\t\tthis.cubeRenderTarget_ = cubeRenderTarget;\r\n\t}\r\n\r\n\tstatic set texture(texture) {\r\n\t\tif (this.texture_) {\r\n\t\t\tthis.texture_.dispose();\r\n\t\t}\r\n\t\tthis.texture_ = texture;\r\n\t}\r\n\r\n\tstatic load(item, renderer, callback) {\r\n\t\tthis.video = null;\r\n\t\tif (!item.asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (item.asset.type.name === AssetType.PublisherStream.name) {\r\n\t\t\treturn this.loadPublisherStreamBackground(renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.mp4') !== -1 || item.asset.file.indexOf('.webm') !== -1) {\r\n\t\t\treturn this.loadVideoBackground(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.m3u8') !== -1) {\r\n\t\t\treturn this.loadHlslVideoBackground(item.asset.file, renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.hdr') !== -1) {\r\n\t\t\treturn this.loadRgbeBackground(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t} else {\r\n\t\t\treturn this.loadBackgroundImageService(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadBackground(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('loadBackground.progressRef');\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tloader.setPath(folder).load(file, (texture) => {\r\n\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\tpmremGenerator.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t}, (request) => {\r\n\t\t\tconsole.log(request.loaded, request.total);\r\n\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadBackgroundImageService(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst image = new Image();\r\n\t\tImageService.events$(folder + file).pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tif (event.type === ImageServiceEvent.Progress) {\r\n\t\t\t\t\tLoaderService.setProgress(progressRef, event.data.loaded, event.data.total);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst load = fromEvent(image, 'load');\r\n\t\t\t\timage.crossOrigin = 'anonymous';\r\n\t\t\t\timage.src = event.data;\r\n\t\t\t\treturn load;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t).subscribe(event => {\r\n\t\t\tURL.revokeObjectURL(event.data);\r\n\t\t\tconst texture = new THREE.Texture(image);\r\n\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\tpmremGenerator.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic loadRgbeBackground(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst loader = new THREE.RGBELoader();\r\n\t\tloader\r\n\t\t\t.setDataType(THREE.UnsignedByteType)\r\n\t\t\t// .setDataType(THREE.FloatType)\r\n\t\t\t.setPath(folder)\r\n\t\t\t.load(file, (texture) => {\r\n\t\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\t\t// texture.dispose();\r\n\t\t\t\tpmremGenerator.dispose();\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(envMap, texture, true);\r\n\t\t\t\t}\r\n\t\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t}, (request) => {\r\n\t\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadHlslVideoBackground(src, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst video = document.createElement('video');\r\n\t\tconst onPlaying = () => {\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// const envMap = new THREE.VideoTexture(video);\r\n\t\t\tconst cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t// texture.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t};\r\n\t\tvideo.oncanplay = () => {\r\n\t\t\t// console.log('videoReady', videoReady);\r\n\t\t\tonPlaying();\r\n\t\t};\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\t// bind them together\r\n\t\t\thls.attachMedia(video);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\tvideo.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadVideoBackground(folder, file, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// const debugService = DebugService.getService();\r\n\t\tthis.video = true;\r\n\t\tconst video = this.video;\r\n\t\tconst onPlaying = () => {\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// const envMap = new THREE.VideoTexture(video);\r\n\t\t\tconst cubeRenderTarget = this.cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t// texture.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t};\r\n\t\t// video.addEventListener('playing', onPlaying);\r\n\t\tvideo.oncanplay = () => {\r\n\t\t\t// console.log('EnvMapLoader.loadVideoBackground.oncanplay');\r\n\t\t\tonPlaying();\r\n\t\t};\r\n\t\tvideo.src = folder + file;\r\n\t\tvideo.load();\r\n\t\tvideo.play().then(() => {\r\n\t\t\t// console.log('EnvMapLoader.loadVideoBackground.play');\r\n\t\t\t// debugService.setMessage(`play ${video.src}`);\r\n\t\t}, error => {\r\n\t\t\tconsole.log('EnvMapLoader.loadVideoBackground.play.error', error);\r\n\t\t\t// debugService.setMessage(`play.error ${video.src}`);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic loadPublisherStreamBackground(renderer, callback) {\r\n\t\tconst onPublisherStreamId = (publisherStreamId) => {\r\n\t\t\t// const target = StateService.state.role === RoleType.Publisher ? '.video--local' : '.video--remote';\r\n\t\t\tconst target = `#stream-${publisherStreamId}`;\r\n\t\t\tconst video = document.querySelector(`${target} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tconst cubeRenderTarget = this.cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t\t// texture.dispose();\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonPlaying();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\tonPlaying();\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t};\r\n\t\tStreamService.getPublisherStreamId$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(publisherStreamId => onPublisherStreamId(publisherStreamId));\r\n\t}\r\n\r\n}\r\n","\r\nexport default class FreezableMesh extends THREE.Mesh {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || new THREE.BoxBufferGeometry(5, 5, 5);\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import FreezableMesh from \"./freezable.mesh\";\r\n\r\nexport default class EmittableMesh extends FreezableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || new THREE.BoxBufferGeometry(5, 5, 5);\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","// import DebugService from '../debug.service';\r\n\r\nconst defaultEvent = {};\r\n\r\nexport default class Interactive { }\r\n\r\nInteractive.items = [];\r\nInteractive.hittest = interactiveHittest.bind(Interactive);\r\nInteractive.dispose = interactiveDispose.bind(Interactive);\r\n\r\nexport function interactiveHittest(raycaster, down = false, event = defaultEvent) {\r\n\t// const debugService = DebugService.getService();\r\n\tlet dirty = false;\r\n\tif (this.down !== down) {\r\n\t\tthis.down = down;\r\n\t\tthis.lock = false;\r\n\t\tdirty = true;\r\n\t}\r\n\tconst items = this.items.filter(x => !x.freezed);\r\n\tconst intersections = raycaster.intersectObjects(items);\r\n\tlet key, hit;\r\n\tconst hash = {};\r\n\tintersections.forEach((intersection, i) => {\r\n\t\tconst object = intersection.object;\r\n\t\tkey = object.uuid;\r\n\t\tif (i === 0) {\r\n\t\t\tif (this.lastIntersectedObject !== object || dirty) {\r\n\t\t\t\tthis.lastIntersectedObject = object;\r\n\t\t\t\thit = object;\r\n\t\t\t\t// debugService.setMessage(hit.name || hit.id);\r\n\t\t\t\t// haptic feedback\r\n\t\t\t} else if (\r\n\t\t\t\tobject.intersection && (\r\n\t\t\t\t\tMath.abs(object.intersection.point.x - intersection.point.x) > 0.01 ||\r\n\t\t\t\t\tMath.abs(object.intersection.point.y - intersection.point.y) > 0.01\r\n\t\t\t\t)\r\n\t\t\t) {\r\n\t\t\t\tobject.intersection = intersection;\r\n\t\t\t\tobject.emit('move', object);\r\n\t\t\t}\r\n\t\t}\r\n\t\thash[key] = intersection;\r\n\t});\r\n\tif (intersections.length === 0) {\r\n\t\tthis.lastIntersectedObject = null;\r\n\t}\r\n\titems.forEach(x => {\r\n\t\tx.intersection = hash[x.uuid];\r\n\t\tx.over = (x === this.lastIntersectedObject) || (x.intersection && !x.depthTest && (!this.lastIntersectedObject || this.lastIntersectedObject.depthTest));\r\n\t\tx.down = down && x.over && !this.lock;\r\n\t\tif (x.down) {\r\n\t\t\tthis.lock = true;\r\n\t\t}\r\n\t});\r\n\treturn hit;\r\n}\r\n\r\nexport function interactiveDispose(object) {\r\n\tif (object) {\r\n\t\tconst index = this.items.indexOf(object);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.items.splice(index, 1);\r\n\t\t}\r\n\t}\r\n}\r\n","import EmittableMesh from './emittable.mesh';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveMesh extends EmittableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tsuper(geometry, material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveMesh() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import { Texture } from 'three';\r\n\r\nfunction VideoTexture(video, mapping, wrapS, wrapT, magFilter, minFilter, format, type, anisotropy) {\r\n\tTexture.call(this, video, mapping, wrapS, wrapT, magFilter, minFilter, format, type, anisotropy);\r\n\tthis.format = format !== undefined ? format : THREE.RGBFormat;\r\n\tthis.minFilter = minFilter !== undefined ? minFilter : THREE.LinearFilter;\r\n\tthis.magFilter = magFilter !== undefined ? magFilter : THREE.LinearFilter;\r\n\tthis.mapping = THREE.UVMapping;\r\n\tthis.generateMipmaps = false;\r\n}\r\n\r\nVideoTexture.prototype = Object.assign(Object.create(Texture.prototype), {\r\n\r\n\tconstructor: VideoTexture,\r\n\r\n\tisVideoTexture: true,\r\n\r\n\tupdate: function() {\r\n\t\tvar video = this.image;\r\n\t\tif (video.readyState >= video.HAVE_CURRENT_DATA) {\r\n\t\t\tthis.needsUpdate = true;\r\n\t\t}\r\n\t}\r\n\r\n});\r\n\r\nexport { VideoTexture };\r\n","import StateService from '../../state/state.service';\r\nimport { PanoramaGridView } from '../../view/view';\r\nimport { EnvMapLoader } from '../envmap/envmap.loader';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport { VideoTexture } from '../video-texture';\r\n\r\nexport const PANORAMA_RADIUS = 101;\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\t// gl_PointSize = 8.0;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform vec2 resolution;\r\nuniform float tween;\r\nuniform bool rgbe;\r\nuniform sampler2D texture;\r\n\r\nvec3 ACESFilmicToneMapping_( vec3 color ) {\r\n\tcolor *= 1.8;\r\n\treturn saturate( ( color * ( 2.51 * color + 0.03 ) ) / ( color * ( 2.43 * color + 0.59 ) + 0.14 ) );\r\n}\r\n\r\nvec4 getColor(vec2 p) {\r\n\treturn texture2D(texture, p);\r\n}\r\n\r\nvec3 encodeColor(vec4 color) {\r\n\treturn ACESFilmicToneMapping_(RGBEToLinear(color).rgb);\r\n}\r\n\r\nfloat rand(vec2 co){\r\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\r\n}\r\n\r\nvec4 Blur(vec2 st, vec4 color) {\r\n\tconst float directions = 16.0;\r\n\tconst float quality = 3.0;\r\n\tfloat size = 16.0;\r\n\tconst float PI2 = 6.28318530718;\r\n\tconst float qq = 1.0;\r\n\tconst float q = 1.0 / quality;\r\n\tvec2 radius = size / resolution.xy;\r\n\tfor (float d = 0.0; d < PI2; d += PI2 / directions) {\r\n\t\tfor (float i = q; i <= qq; i += q) {\r\n\t\t\tvec2 dUv = vec2(cos(d), sin(d)) * radius * i;\r\n\t\t\tcolor += getColor(st + dUv);\r\n        }\r\n\t}\r\n\treturn color /= quality * directions - 15.0 + rand(st) * 4.0;\r\n}\r\n\r\nvoid main() {\r\n\tvec4 color = texture2D(texture, vUv);\r\n\t// color = Blur(vUv, color);\r\n\tif (rgbe) {\r\n\t\tcolor = vec4(encodeColor(color) * tween + rand(vUv) * 0.01, 1.0);\r\n\t} else {\r\n\t\tcolor = vec4(color.rgb * tween + rand(vUv) * 0.01, 1.0);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class Panorama {\r\n\r\n\tconstructor() {\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => EnvMapLoader.muted = state.volumeMuted);\r\n\t\tthis.tween = 0;\r\n\t\tthis.create();\r\n\t}\r\n\r\n\tcreate() {\r\n\t\tconst geometry = new THREE.SphereBufferGeometry(PANORAMA_RADIUS, 60, 40);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\tgeometry.rotateY(Math.PI);\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\ttexture: { type: \"t\", value: null },\r\n\t\t\t\tresolution: { value: new THREE.Vector2() },\r\n\t\t\t\ttween: { value: 0 },\r\n\t\t\t\trgbe: { value: false },\r\n\t\t\t},\r\n\t\t});\r\n\t\t/*\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t});\r\n\t\t*/\r\n\t\tconst mesh = this.mesh = new InteractiveMesh(geometry, material);\r\n\t\t// mesh.renderOrder = environment.renderOrder.panorama;\r\n\t\tmesh.name = '[panorama]';\r\n\t}\r\n\r\n\t/*\r\n\tswap(view, renderer, callback, onexit) {\r\n\t\tconst item = view instanceof PanoramaGridView ? view.tiles[view.index_] : view;\r\n\t\tconst material = this.mesh.material;\r\n\t\tif (this.tween > 0) {\r\n\t\t\tgsap.to(this, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\ttween: 0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\t\t\tonexit(view);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\t\t\ttween: 1,\r\n\t\t\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\tonexit(view);\r\n\t\t\t}\r\n\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tchange(view, renderer, callback, onexit) {\r\n\t\tconst item = view instanceof PanoramaGridView ? view.tiles[view.index_] : view;\r\n\t\tconst material = this.mesh.material;\r\n\t\t// setTimeout(() => {\r\n\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t// setTimeout(() => {\r\n\t\t\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\t\t\tonexit(view);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmaterial.uniforms.tween.value = 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, 100); // !!! delay\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\t\ttween: 1,\r\n\t\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}, 100); // !!! delay\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t// }, 100); // !!! delay\r\n\t\t\t});\r\n\t\t// }, 300); // !!! delay\r\n\t}\r\n\r\n\tcrossfade(item, renderer, callback) {\r\n\t\tconst material = this.mesh.material;\r\n\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\tmaterial.uniforms.tween.value = 1;\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tload(item, renderer, callback) {\r\n\t\tif (!item.asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.currentAsset = item.asset.folder + item.asset.file;\r\n\t\tconst material = this.mesh.material;\r\n\t\tEnvMapLoader.load(item, renderer, (envMap, texture, rgbe, video, pmremGenerator) => {\r\n\t\t\tif (item.asset.folder + item.asset.file !== this.currentAsset) {\r\n\t\t\t\ttexture.dispose();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (material.uniforms.texture.value) {\r\n\t\t\t\tmaterial.uniforms.texture.value.dispose();\r\n\t\t\t\tmaterial.uniforms.texture.value = null;\r\n\t\t\t}\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// material.map = texture;\r\n\t\t\tmaterial.uniforms.texture.value = texture;\r\n\t\t\tmaterial.uniforms.resolution.value = new THREE.Vector2(texture.width, texture.height);\r\n\t\t\tmaterial.uniforms.tween.value = 0;\r\n\t\t\tmaterial.uniforms.rgbe.value = rgbe;\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tloadVideo(src) {\r\n\t\tconst video = document.createElement('video');\r\n\t\tvideo.src = src;\r\n\t\tvideo.volume = 0.8;\r\n\t\tvideo.muted = true;\r\n\t\tvideo.playsInline = true;\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tvideo.play();\r\n\t\tthis.setVideo(video);\r\n\t}\r\n\r\n\tsetVideo(video) {\r\n\t\t// console.log('Panorama.setVideo', video);\r\n\t\tif (video) {\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = new VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tconst material = this.mesh.material;\r\n\t\t\t\tmaterial.map = texture;\r\n\t\t\t\tmaterial.uniforms.texture.value = texture;\r\n\t\t\t\tmaterial.uniforms.resolution.value = new THREE.Vector2(texture.width, texture.height);\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t};\r\n\t\t\t// video.addEventListener('canplay', onPlaying);\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\tonPlaying();\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.subscription.unsubscribe();\r\n\t}\r\n\r\n}\r\n","export class Rect {\n\n\tconstructor(rect) {\n\t\tthis.x = 0;\n\t\tthis.y = 0;\n\t\tthis.top = 0;\n\t\tthis.right = 0;\n\t\tthis.bottom = 0;\n\t\tthis.left = 0;\n\t\tthis.width = 0;\n\t\tthis.height = 0;\n\t\tthis.set(rect);\n\t}\n\n\tstatic contains(rect, left, top) {\n\t\treturn rect.top <= top && top <= rect.bottom && rect.left <= left && left <= rect.right;\n\t}\n\n\tstatic intersectRect(r1, r2) {\n\t\treturn !(r2.left > r1.right ||\n\t\t\tr2.right < r1.left ||\n\t\t\tr2.top > r1.bottom ||\n\t\t\tr2.bottom < r1.top);\n\t}\n\n\tstatic fromNode(node) {\n\t\tif (!node) {\n\t\t\treturn;\n\t\t}\n\t\tconst rect = node.rect_ || (node.rect_ = new Rect());\n\t\tconst rects = node.getClientRects();\n\t\tif (!rects.length) {\n\t\t\t// console.log(rects, node);\n\t\t\treturn rect;\n\t\t}\n\t\tconst boundingRect = node.getBoundingClientRect();\n\t\t// rect.top: boundingRect.top + defaultView.pageYOffset,\n\t\t// rect.left: boundingRect.left + defaultView.pageXOffset,\n\t\trect.x = boundingRect.left;\n\t\trect.y = boundingRect.top;\n\t\trect.top = boundingRect.top;\n\t\trect.left = boundingRect.left;\n\t\trect.width = boundingRect.width;\n\t\trect.height = boundingRect.height;\n\t\trect.right = rect.left + rect.width;\n\t\trect.bottom = rect.top + rect.height;\n\t\trect.setCenter();\n\t\treturn rect;\n\t}\n\n\tset(rect) {\n\t\tif (rect) {\n\t\t\tObject.assign(this, rect);\n\t\t\tthis.right = this.left + this.width;\n\t\t\tthis.bottom = this.top + this.height;\n\t\t}\n\t\tthis.setCenter();\n\t}\n\n\tsetSize(w, h) {\n\t\tthis.width = w;\n\t\tthis.height = h;\n\t\tthis.right = this.left + this.width;\n\t\tthis.bottom = this.top + this.height;\n\t\tthis.setCenter();\n\t\t// console.log(w, h);\n\t}\n\n\tsetCenter() {\n\t\tconst center = this.center || (this.center = {});\n\t\tcenter.top = this.top + this.height / 2;\n\t\tcenter.left = this.left + this.width / 2;\n\t\tcenter.x = center.left;\n\t\tcenter.y = center.top;\n\t}\n\n\tcontains(left, top) {\n\t\treturn Rect.contains(this, left, top);\n\t}\n\n\tintersect(rect) {\n\t\treturn Rect.intersectRect(this, rect);\n\t}\n\n\tintersection(rect) {\n\t\tconst intersection = this.intersection_ || (this.intersection_ = {\n\t\t\tleft: 0,\n\t\t\ttop: 0,\n\t\t\twidth: 0,\n\t\t\theight: 0,\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\tpow: {\n\t\t\t\tx: -1,\n\t\t\t\ty: -1\n\t\t\t},\n\t\t\toffset: function(offset) {\n\t\t\t\toffset = offset || 0;\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\n\t\t\t\treturn pow;\n\t\t\t},\n\t\t\tscroll: function(offset) {\n\t\t\t\toffset = offset || 0;\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\n\t\t\t\treturn pow;\n\t\t\t}\n\t\t});\n\t\tintersection.left = this.left;\n\t\tintersection.top = this.top;\n\t\tintersection.width = this.width;\n\t\tintersection.height = this.height;\n\t\tintersection.x = this.left + this.width / 2;\n\t\tintersection.y = this.top + this.height / 2;\n\t\tintersection.rect = rect;\n\t\tconst pow = intersection.offset(0);\n\t\tintersection.pow.y = pow;\n\t\treturn intersection;\n\t}\n\n}\n","// import { auditTime, tap } from \"rxjs/operators\";\r\n// import AudioStreamService from \"../../audio/audio-stream.service\";\r\nimport StreamService from \"../../stream/stream.service\";\r\n\r\nexport const W = 320;\r\nexport const H = 240;\r\nexport const COLORS = [0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff, 0xffffff];\r\n\r\nexport default class AvatarElement {\r\n\r\n\tstatic get headGeometry() {\r\n\t\tif (!this.headGeometry_) {\r\n\t\t\tthis.headGeometry_ = new THREE.SphereBufferGeometry(0.2, 48, 48);\r\n\t\t}\r\n\t\treturn this.headGeometry_;\r\n\t}\r\n\r\n\tconstructor(message) {\r\n\t\tconst clientId = this.clientId = message.clientId;\r\n\t\tconst container = this.container = message.container;\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: true,\r\n\t\t\talpha: false,\r\n\t\t\tpremultipliedAlpha: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(W, H);\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = 0.8;\r\n\t\trenderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\tcontainer.appendChild(renderer.domElement);\r\n\r\n\t\tconst camera = this.camera = new THREE.PerspectiveCamera(70, W / H, 0.01, 1000);\r\n\t\tcamera.position.set(0, 0, -0.5);\r\n\t\tcamera.target = new THREE.Vector3();\r\n\t\tcamera.lookAt(camera.target);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\r\n\t\t/*\r\n\t\tconst ambient = this.ambient = new THREE.AmbientLight(0x202020);\r\n\t\tscene.add(ambient);\r\n\t\t*/\r\n\r\n\t\tconst light = this.light = new THREE.PointLight(0xffffff, 1, 100);\r\n\t\tlight.position.set(0, 2, -2);\r\n\t\tscene.add(light);\r\n\r\n\t\tconst head = this.head = this.addHead();\r\n\t\tscene.add(head);\r\n\r\n\t\tconst remote = this.remote = StreamService.getRemoteById(clientId);\r\n\t\t/*\r\n\t\tif (remote) {\r\n\t\t\tthis.subscription = AudioStreamService.volume$(remote.stream).pipe(\r\n\t\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t\t\ttap(meter => {\r\n\t\t\t\t\tthis.chalk(meter.volume);\r\n\t\t\t\t})\r\n\t\t\t);\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\taddHead() {\r\n\t\tconst geometry = AvatarElement.headGeometry;\r\n\t\tconst canvas = this.canvas = document.createElement('canvas');\r\n\t\tcanvas.width = 1024;\r\n\t\tcanvas.height = 512;\r\n\t\tconst ctx = this.ctx = this.canvas.getContext('2d');\r\n\t\tconst map = this.map = new THREE.CanvasTexture(canvas);\r\n\t\tmap.offset.x = -0.25;\r\n\t\tconst color = COLORS[this.clientId % COLORS.length];\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tmap: map,\r\n\t\t\tcolor: color,\r\n\t\t});\r\n\t\tthis.chalk(0);\r\n\t\treturn new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t// if (tick % 2 === 1) {\r\n\t\tif (this.remote) {\r\n\t\t\tconst audioLevel = this.remote.getAudioLevel() * 12;\r\n\t\t\tthis.chalk(audioLevel);\r\n\t\t}\r\n\t\tconst renderer = this.renderer,\r\n\t\t\tscene = this.scene,\r\n\t\t\tcamera = this.camera;\r\n\t\trenderer.render(scene, camera);\r\n\t\t// }\r\n\t}\r\n\r\n\tupdate(message) {\r\n\t\tconst camera = message.camera;\r\n\t\tconst head = this.head;\r\n\t\thead.quaternion.set(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t/*\r\n\t\thead.position.set(camera[0], camera[1], camera[2]);\r\n\t\t*/\r\n\t}\r\n\r\n\tdispose() {\r\n\t\t// !!! dispose threejs\r\n\t\tif (this.subscription) {\r\n\t\t\tthis.subscription.unsubscribe();\r\n\t\t}\r\n\t}\r\n\r\n\tchalk(i) {\r\n\t\ti = (i + Math.PI * 0.5) % (Math.PI * 2);\r\n\t\tconst vol = Math.sin(i) * 30;\r\n\t\tconst smile = Math.cos(i) * 10;\r\n\t\tconst x = 512;\r\n\t\tconst y = 256;\r\n\t\tconst ctx = this.ctx;\r\n\t\tctx.fillStyle = '#888888';\r\n\t\tctx.fillRect(0, 0, 1024, 512);\r\n\t\tctx.fillStyle = 'white';\r\n\t\tctx.beginPath();\r\n\t\tctx.arc(x - 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.arc(x + 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.beginPath();\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 30, x - 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 60, x, y + 60);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y + 60, x + 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y, x, y);\r\n\t\tctx.moveTo(x - 40 - smile, y + 30);\r\n\t\tctx.bezierCurveTo(x - 40 - smile, y + 60, x + 40 + smile, y + 60, x + 40 + smile, y + 30);\r\n\t\tctx.bezierCurveTo(x + 40 + smile, y + vol, x - 40 - smile, y + vol, x - 40 - smile, y + 30);\r\n\t\t// ctx.arc(x, 256 + 50, 50, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tthis.map.needsUpdate = true;\r\n\t}\r\n\r\n}\r\n","\r\n\r\nexport default class Camera extends THREE.PerspectiveCamera {\r\n\tconstructor(fov = 70, aspect = 1, near = 0.01, far = 1000, dolly = 70) {\r\n\t\tsuper(fov, aspect, near, far);\r\n\t\tthis.target = new THREE.Vector3();\r\n\t\tthis.box = new THREE.Group();\r\n\t\tthis.add(this.box);\r\n\t}\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\nimport { assetIsStream, AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StateService from '../../state/state.service';\r\n\r\nexport class MediaLoaderEvent {\r\n\tconstructor(src, id) {\r\n\t\tthis.src = src;\r\n\t\tthis.id = id;\r\n\t}\r\n}\r\n\r\nexport class MediaLoaderPlayEvent extends MediaLoaderEvent { }\r\n\r\nexport class MediaLoaderPauseEvent extends MediaLoaderEvent { }\r\n\r\nexport default class MediaLoader {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn MediaLoader.loader || (MediaLoader.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getPath(item) {\r\n\t\treturn environment.getPath(item.asset.folder + item.asset.file);\r\n\t}\r\n\r\n\tstatic loadTexture(item, callback) {\r\n\t\tconst path = MediaLoader.getPath(item);\r\n\t\treturn MediaLoader.getLoader().load(path, callback);\r\n\t}\r\n\r\n\tstatic isVideo(item) {\r\n\t\treturn item.asset && item.asset.file && (item.asset.file.indexOf('.mp4') !== -1 || item.asset.file.indexOf('.webm') !== -1);\r\n\t}\r\n\r\n\tstatic isStream(item) {\r\n\t\treturn assetIsStream(item.asset);\r\n\t}\r\n\r\n\tstatic isPublisherStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherStream.name;\r\n\t}\r\n\r\n\tstatic isAttendeeStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeStream.name;\r\n\t}\r\n\r\n\tstatic isSmartDeviceStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.SmartDeviceStream.name;\r\n\t}\r\n\r\n\tstatic isPublisherScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherScreen.name;\r\n\t}\r\n\r\n\tstatic isAttendeeScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeScreen.name;\r\n\t}\r\n\r\n\tget isVideo() {\r\n\t\treturn MediaLoader.isVideo(this.item);\r\n\t}\r\n\r\n\tget isStream() {\r\n\t\treturn MediaLoader.isStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherStream() {\r\n\t\treturn MediaLoader.isPublisherStream(this.item);\r\n\t}\r\n\r\n\tget isAttendeeStream() {\r\n\t\treturn MediaLoader.isAttendeeStream(this.item);\r\n\t}\r\n\r\n\tget isSmartDeviceStream() {\r\n\t\treturn MediaLoader.isSmartDeviceStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherScreen() {\r\n\t\treturn MediaLoader.isPublisherScreen(this.item);\r\n\t}\r\n\r\n\tget isAttendeeScreen() {\r\n\t\treturn MediaLoader.isAttendeeScreen(this.item);\r\n\t}\r\n\r\n\tget isPlayableVideo() {\r\n\t\treturn this.isVideo && !this.item.asset.autoplay;\r\n\t}\r\n\r\n\tget isAutoplayVideo() {\r\n\t\treturn this.isStream || (this.isVideo && (this.item.asset.autoplay != null));\r\n\t}\r\n\r\n\tget muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tset muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('MediaLoader.muted', muted, this.video);\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(item) {\r\n\t\tthis.item = item;\r\n\t\tthis.toggle = this.toggle.bind(this);\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => this.muted = state.volumeMuted);\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tconst item = this.item;\r\n\t\tlet texture;\r\n\t\t// console.log('MediaLoader.load', item, this.isStream);\r\n\t\tif (this.isStream && item.streamId) {\r\n\t\t\tconst streamId = item.streamId;\r\n\t\t\tconst target = `#stream-${streamId}`;\r\n\t\t\tconst video = document.querySelector(`${target} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tvideo.removeEventListener('canplay', onCanPlay);\r\n\t\t\t\ttexture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonCanPlay();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.addEventListener('canplay', onCanPlay);\r\n\t\t\t}\r\n\t\t} else if (this.isVideo) {\r\n\t\t\t// create the video element\r\n\t\t\tconst video = this.video = document.createElement('video');\r\n\t\t\tvideo.preload = 'metadata';\r\n\t\t\tvideo.volume = 0.8;\r\n\t\t\tvideo.muted = true;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (item.asset && item.asset.autoplay) {\r\n\t\t\t\tvideo.loop = true;\r\n\t\t\t}\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tvideo.oncanplay = null;\r\n\t\t\t\ttexture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (!item.asset || !item.asset.autoplay) {\r\n\t\t\t\t\tvideo.pause();\r\n\t\t\t\t}\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.oncanplay = onCanPlay;\r\n\t\t\tvideo.src = MediaLoader.getPath(item);\r\n\t\t\tvideo.load(); // must call after setting/changing source\r\n\t\t\tthis.play(true);\r\n\t\t} else if (item.asset) {\r\n\t\t\tMediaLoader.loadTexture(item, texture => {\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\ttexture.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tcallback(null, this);\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\r\n\tplay(silent) {\r\n\t\t// console.log('MediaLoader.play');\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.play().then(() => {\r\n\t\t\t\t// console.log('MediaLoader.play.success', this.item.asset.file);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('MediaLoader.play.error', this.item.asset.file, error);\r\n\t\t\t});\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPlayEvent(this.video.src, this.item.id));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpause(silent) {\r\n\t\t// console.log('MediaLoader.pause');\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = true;\r\n\t\t\tthis.video.pause();\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPauseEvent(this.video.src, this.item.id));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggle() {\r\n\t\t// console.log('MediaLoader.toggle', this.video);\r\n\t\tif (this.video) {\r\n\t\t\tif (this.video.paused) {\r\n\t\t\t\tthis.video.muted = this.muted_;\r\n\t\t\t\tthis.play();\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.pause();\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.subscription.unsubscribe();\r\n\t\tthis.pause();\r\n\t\tdelete this.video;\r\n\t}\r\n\r\n}\r\n\r\nMediaLoader.events$ = new ReplaySubject(1);\r\n","import { of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\nimport { assetIsStream, AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StreamService from '../../stream/stream.service';\r\nimport { RoleType } from '../../user/user';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport MediaLoader, { MediaLoaderPauseEvent, MediaLoaderPlayEvent } from './media-loader';\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 overlayColor;\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tif (video) {\r\n\t\tvec4 colorB = texture2D(textureB, vUv);\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2) + (colorB.rgb * tween * colorB.a), opacity);\r\n\t} else {\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nconst FRAGMENT_CHROMA_KEY_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\n#define threshold 0.55\r\n#define padding 0.05\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 chromaKeyColor;\r\nuniform vec3 overlayColor;\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 chromaKey = vec4(chromaKeyColor, 1.0);\r\n    vec3 chromaKeyDiff = colorA.rgb - chromaKey.rgb;\r\n    float chromaKeyValue = smoothstep(threshold - padding, threshold + padding, dot(chromaKeyDiff, chromaKeyDiff));\r\n\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity * chromaKeyValue);\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class MediaMesh extends InteractiveMesh {\r\n\r\n\tstatic getMaterial(useChromaKey) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: useChromaKey ? FRAGMENT_CHROMA_KEY_SHADER : FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tvideo: { value: false },\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\toverlayColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\toverlay: { value: 0 },\r\n\t\t\t\ttween: { value: 1 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t\t// side: THREE.DoubleSide\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getChromaKeyMaterial(chromaKeyColor = [0.0, 1.0, 0.0]) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: FRAGMENT_CHROMA_KEY_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tvideo: { value: false },\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\tchromaKeyColor: { value: new THREE.Vector3(chromaKeyColor[0], chromaKeyColor[1], chromaKeyColor[2]) },\r\n\t\t\t\toverlayColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\toverlay: { value: 0 },\r\n\t\t\t\ttween: { value: 1 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t\tside: THREE.DoubleSide\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic isPublisherStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher;\r\n\t}\r\n\tstatic isAttendeeStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee;\r\n\t}\r\n\tstatic isSmartDeviceStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.SmartDevice;\r\n\t}\r\n\tstatic isPublisherScreen(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher && stream.clientInfo.uid !== stream.getId();\r\n\t}\r\n\tstatic isAttendeeScreen(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee && stream.clientInfo.uid !== stream.getId();\r\n\t}\r\n\tstatic getTypeMatcher(assetType) {\r\n\t\tlet matcher;\r\n\t\tswitch (assetType.name) {\r\n\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tmatcher = this.isPublisherStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tmatcher = this.isAttendeeStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\tmatcher = this.isSmartDeviceStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tmatcher = this.isPublisherScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tmatcher = this.isAttendeeScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tmatcher = (stream) => { return false; }\r\n\t\t}\r\n\t\treturn matcher;\r\n\t}\r\n\r\n\tstatic getStreamId$(item) {\r\n\t\tif (!item.asset) {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t\tconst assetType = item.asset.type;\r\n\t\tconst file = item.asset.file;\r\n\t\tif (assetIsStream(item.asset)) {\r\n\t\t\treturn StreamService.streams$.pipe(\r\n\t\t\t\tmap((streams) => {\r\n\t\t\t\t\tlet stream;\r\n\t\t\t\t\tlet i = 0;\r\n\t\t\t\t\tconst matchType = this.getTypeMatcher(assetType);\r\n\t\t\t\t\tstreams.forEach(x => {\r\n\t\t\t\t\t\tif (matchType(x)) {\r\n\t\t\t\t\t\t\tif (i === item.asset.index) {\r\n\t\t\t\t\t\t\t\tstream = x;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ti++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('MediaMesh.getStreamId$', assetType.name, stream, streams);\r\n\t\t\t\t\tif (stream) {\r\n\t\t\t\t\t\treturn stream.getId();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(file);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getMaterialByItem(item) {\r\n\t\tlet material;\r\n\t\tif (item.asset && item.asset.chromaKeyColor) {\r\n\t\t\tmaterial = MediaMesh.getChromaKeyMaterial(item.asset.chromaKeyColor);\r\n\t\t} else if (item.asset) {\r\n\t\t\tmaterial = MediaMesh.getMaterial();\r\n\t\t} else {\r\n\t\t\tmaterial = new THREE.MeshBasicMaterial({ color: 0x888888 });\r\n\t\t}\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getUniformsByItem(item) {\r\n\t\tlet uniforms = null;\r\n\t\tif (item.asset) {\r\n\t\t\tuniforms = {\r\n\t\t\t\toverlay: 0,\r\n\t\t\t\ttween: 1,\r\n\t\t\t\topacity: 0,\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn uniforms;\r\n\t}\r\n\r\n\tconstructor(item, items, geometry) {\r\n\t\tconst material = MediaMesh.getMaterialByItem(item);\r\n\t\tsuper(geometry, material);\r\n\t\tthis.item = item;\r\n\t\tthis.items = items;\r\n\t\tthis.renderOrder = environment.renderOrder.plane;\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tconst mediaLoader = this.mediaLoader = new MediaLoader(item);\r\n\t\t/*\r\n\t\tif (item.asset && !mediaLoader.isVideo) {\r\n\t\t\tthis.freeze();\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tif (!this.item.asset) {\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst material = this.material;\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tmediaLoader.load((textureA) => {\r\n\t\t\t// console.log('MediaMesh.textureA', textureA);\r\n\t\t\tif (textureA) {\r\n\t\t\t\tmaterial.uniforms.textureA.value = textureA;\r\n\t\t\t\t// material.uniforms.resolutionA.value.x = textureA.image.width;\r\n\t\t\t\t// material.uniforms.resolutionA.value.y = textureA.image.height;\r\n\t\t\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureA.image.width || textureA.image.videoWidth, textureA.image.height || textureA.image.videoHeight);\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\t\tthis.createTextureB(textureA, (textureB) => {\r\n\t\t\t\t\t\t// console.log('MediaMesh.textureB', textureB);\r\n\t\t\t\t\t\ttextureB.minFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\ttextureB.magFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\ttextureB.mapping = THREE.UVMapping;\r\n\t\t\t\t\t\t// textureB.format = THREE.RGBFormat;\r\n\t\t\t\t\t\ttextureB.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\t\t\ttextureB.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\t\t\tmaterial.uniforms.textureB.value = textureB;\r\n\t\t\t\t\t\t// material.uniforms.resolutionB.value.x = textureB.image.width;\r\n\t\t\t\t\t\t// material.uniforms.resolutionB.value.y = textureB.image.height;\r\n\t\t\t\t\t\tmaterial.uniforms.resolutionB.value = new THREE.Vector2(textureB.image.width, textureB.image.height);\r\n\t\t\t\t\t\t// console.log(material.uniforms.resolutionB.value, textureB);\r\n\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\tmaterial.uniforms.video.value = true;\r\n\t\t\t\tthis.onOver = this.onOver.bind(this);\r\n\t\t\t\tthis.onOut = this.onOut.bind(this);\r\n\t\t\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\t\t\tthis.on('over', this.onOver);\r\n\t\t\t\tthis.on('out', this.onOut);\r\n\t\t\t\tthis.on('down', this.onToggle);\r\n\t\t\t}\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateTextureB(textureA, callback) {\r\n\t\tconst aw = textureA.image.width || textureA.image.videoWidth;\r\n\t\tconst ah = textureA.image.height || textureA.image.videoHeight;\r\n\t\tconst ar = aw / ah;\r\n\t\tconst scale = 0.32;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = aw;\r\n\t\tcanvas.height = ah;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.imageSmoothingEnabled = true;\r\n\t\tctx.imageSmoothingQuality = 'high';\r\n\t\tconst image = new Image();\r\n\t\timage.onload = function() {\r\n\t\t\tconst bw = image.width;\r\n\t\t\tconst bh = image.height;\r\n\t\t\tconst br = bw / bh;\r\n\t\t\tlet w;\r\n\t\t\tlet h;\r\n\t\t\tif (ar > br) {\r\n\t\t\t\tw = ah * scale;\r\n\t\t\t\th = w / br;\r\n\t\t\t} else {\r\n\t\t\t\th = aw * scale;\r\n\t\t\t\tw = h * br;\r\n\t\t\t}\r\n\t\t\tctx.drawImage(image, aw / 2 - w / 2, ah / 2 - h / 2, w, h);\r\n\t\t\tconst textureB = new THREE.CanvasTexture(canvas);\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(textureB);\r\n\t\t\t}\r\n\t\t}\r\n\t\timage.crossOrigin = 'anonymous';\r\n\t\timage.src = environment.getPath('textures/ui/play.png');\r\n\t}\r\n\r\n\tevents$() {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\tthis.freeze();\r\n\t\t}\r\n\t\treturn MediaLoader.events$.pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\t\t\tconst eventItem = items.find(x => x.asset && event.src.indexOf(x.asset.file) !== -1 && event.id === item.asset.linkedPlayId);\r\n\t\t\t\t\tif (eventItem) {\r\n\t\t\t\t\t\t// console.log('MediaLoader.events$.eventItem', event, eventItem);\r\n\t\t\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\t\t\tthis.play();\r\n\t\t\t\t\t\t} else if (event instanceof MediaLoaderPauseEvent) {\r\n\t\t\t\t\t\t\tthis.pause();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn event;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tonAppear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonDisappear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonOver() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\toverlay: 1,\r\n\t\t\t\ttween: this.playing ? 0 : 1,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.overlay.value = uniforms.overlay;\r\n\t\t\t\t\tmaterial.uniforms.tween.value = uniforms.tween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\toverlay: 0,\r\n\t\t\t\ttween: this.playing ? 0 : 1,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.overlay.value = uniforms.overlay;\r\n\t\t\t\t\tmaterial.uniforms.tween.value = uniforms.tween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\tthis.playing = this.mediaLoader.toggle();\r\n\t\tthis.emit('playing', this.playing);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tplay() {\r\n\t\tthis.mediaLoader.play();\r\n\t\tthis.playing = true;\r\n\t\tthis.emit('playing', true);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tpause() {\r\n\t\tthis.mediaLoader.pause();\r\n\t\tthis.playing = false;\r\n\t\tthis.emit('playing', false);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tsetPlayingState(playing) {\r\n\t\tif (this.playing !== playing) {\r\n\t\t\tthis.playing = playing;\r\n\t\t\tplaying ? this.mediaLoader.play() : this.mediaLoader.pause();\r\n\t\t\tthis.onOut();\r\n\t\t}\r\n\t}\r\n\r\n\tupdateByItem(item) {\r\n\t\tthis.disposeMaterial();\r\n\t\tthis.disposeMediaLoader();\r\n\t\tthis.material = MediaMesh.getMaterialByItem(item);\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tthis.mediaLoader = new MediaLoader(item);\r\n\t}\r\n\r\n\tdisposeMaterial() {\r\n\t\tif (this.material) {\r\n\t\t\tif (this.material.map && this.material.map.disposable !== false) {\r\n\t\t\t\tthis.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tthis.material.dispose();\r\n\t\t\tthis.material = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeMediaLoader() {\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tif (mediaLoader) {\r\n\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\tthis.off('over', this.onOver);\r\n\t\t\t\tthis.off('out', this.onOut);\r\n\t\t\t\tthis.off('down', this.onToggle);\r\n\t\t\t}\r\n\t\t\tmediaLoader.dispose();\r\n\t\t\tthis.mediaLoader = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.disposeMediaLoader();\r\n\t}\r\n\r\n}\r\n\r\n/*\r\nconst FRAGMENT_SHADER_BAK = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 overlayColor;\r\n\r\nmat3 rotate(float a) {\r\n\treturn mat3(\r\n\t\tcos(a), sin(a), 0.0,\r\n\t\t-sin(a), cos(a), 0.0,\r\n\t\t0.0, 0.0, 1.0\r\n\t);\r\n}\r\n\r\nmat3 translate(vec2 t) {\r\n\treturn mat3(\r\n\t\t1.0, 0.0, 0.0,\r\n\t\t0.0, 1.0, 0.0,\r\n\t\tt.x, t.y, 1.0\r\n\t);\r\n}\r\n\r\nmat3 scale(vec2 s) {\r\n\treturn mat3(\r\n\t\ts.x, 0.0, 0.0,\r\n\t\t0.0, s.y, 0.0,\r\n\t\t0.0, 0.0, 1.0\r\n\t);\r\n}\r\n\r\nvec2 getUV2(vec2 vUv, vec2 t, vec2 s, float a) {\r\n\tmat3 transform = scale(s) * rotate(a);\r\n\treturn (vec3(vUv + t, 0.0) * transform).xy;\r\n}\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tif (video) {\r\n\t\tfloat rA = resolutionA.x / resolutionA.y;\r\n\t\tfloat rB = resolutionB.x / resolutionB.y;\r\n\t\tfloat aspect = 1.0 / rA * rB;\r\n\t\tvec2 s = vec2(3.0 / aspect, 3.0);\r\n\t\tvec2 t = vec2(\r\n\t\t\t-(resolutionA.x - resolutionB.x / s.x) * 0.5 / resolutionA.x,\r\n\t\t\t-(resolutionA.y - resolutionB.y / s.y) * 0.5 / resolutionA.y\r\n\t\t);\r\n\t\tt = vec2(\r\n\t\t\t-(resolutionA.x - resolutionB.x / s.y) * 0.5 / resolutionA.x,\r\n\t\t\t-(resolutionA.y - resolutionB.y / s.y) * 0.5 / resolutionA.y\r\n\t\t);\r\n\t\t// float dx = (resolutionA.x - resolutionB.x) / resolutionA.x * 0.5;\r\n\t\t// float dy = (resolutionA.y - resolutionB.y) / resolutionA.y * 0.5;\r\n\t\t// t = vec2(-0.5 + dx, -0.5 - dy);\r\n\t\tvec2 uv2 = clamp(\r\n\t\t\tgetUV2(vUv, t, s, 0.0),\r\n\t\t\tvec2(0.0,0.0),\r\n\t\t\tvec2(1.0,1.0)\r\n\t\t);\r\n\t\tvec4 colorB = texture2D(textureB, uv2);\r\n\t\tcolorB = texture2D(textureB, vUv);\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2) + (colorB.rgb * tween * colorB.a), opacity);\r\n\t} else {\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n*/\r\n","import { fromEvent, merge, ReplaySubject, Subject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, takeUntil } from 'rxjs/operators';\r\n\r\nexport class DragPoint {\r\n\tconstructor() {\r\n\t\tthis.x = 0;\r\n\t\tthis.y = 0;\r\n\t}\r\n}\r\n\r\nexport class DragEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class DragDownEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragMoveEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragUpEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nlet upEvent;\r\n\r\nexport default class DragService {\r\n\r\n\tstatic getPosition(event, point) {\r\n\t\tif (event instanceof MouseEvent) {\r\n\t\t\tpoint ? (\r\n\t\t\t\tpoint.x = event.clientX,\r\n\t\t\t\tpoint.y = event.clientY\r\n\t\t\t) : point = {\r\n\t\t\t\tx: event.clientX,\r\n\t\t\t\ty: event.clientY,\r\n\t\t\t};\r\n\t\t} else if (window.TouchEvent && event instanceof TouchEvent) {\r\n\t\t\tif (event.touches.length > 0) {\r\n\t\t\t\tpoint ? (\r\n\t\t\t\t\tpoint.x = event.touches[0].pageX,\r\n\t\t\t\t\tpoint.y = event.touches[0].pageY\r\n\t\t\t\t) : point = {\r\n\t\t\t\t\tx: event.touches[0].pageX,\r\n\t\t\t\t\ty: event.touches[0].pageY\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn point;\r\n\t}\r\n\r\n\tstatic down$(target, events$) {\r\n\t\tlet downEvent;\r\n\t\treturn merge(\r\n\t\t\tfromEvent(target, 'mousedown').pipe(filter(event => event.button === 0)),\r\n\t\t\tfromEvent(target, 'touchstart')\r\n\t\t).pipe(\r\n\t\t\tmap((event) => {\r\n\t\t\t\tdownEvent = downEvent || new DragDownEvent();\r\n\t\t\t\tdownEvent.node = target;\r\n\t\t\t\tdownEvent.target = event.target;\r\n\t\t\t\tdownEvent.originalEvent = event;\r\n\t\t\t\tdownEvent.down = this.getPosition(event, downEvent.down);\r\n\t\t\t\tif (downEvent.down) {\r\n\t\t\t\t\tdownEvent.distance = new DragPoint();\r\n\t\t\t\t\tdownEvent.strength = new DragPoint();\r\n\t\t\t\t\tdownEvent.speed = new DragPoint();\r\n\t\t\t\t\tevents$.next(downEvent);\r\n\t\t\t\t\treturn downEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== undefined),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic move$(target, events$, dismiss$, downEvent) {\r\n\t\tlet moveEvent;\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mousemove' : 'touchmove').pipe(\r\n\t\t\tstartWith(downEvent),\r\n\t\t\tmap((event) => {\r\n\t\t\t\tmoveEvent = moveEvent || new DragMoveEvent();\r\n\t\t\t\tmoveEvent.node = target;\r\n\t\t\t\tmoveEvent.target = event.target;\r\n\t\t\t\tmoveEvent.originalEvent = event;\r\n\t\t\t\tmoveEvent.position = this.getPosition(event, moveEvent.position);\r\n\t\t\t\tconst dragging = downEvent.down !== undefined && moveEvent.position !== undefined;\r\n\t\t\t\tif (dragging) {\r\n\t\t\t\t\tmoveEvent.distance.x = moveEvent.position.x - downEvent.down.x;\r\n\t\t\t\t\tmoveEvent.distance.y = moveEvent.position.y - downEvent.down.y;\r\n\t\t\t\t\tmoveEvent.strength.x = moveEvent.distance.x / window.innerWidth * 2;\r\n\t\t\t\t\tmoveEvent.strength.y = moveEvent.distance.y / window.innerHeight * 2;\r\n\t\t\t\t\tmoveEvent.speed.x = downEvent.speed.x + (moveEvent.strength.x - downEvent.strength.x) * 0.1;\r\n\t\t\t\t\tmoveEvent.speed.y = downEvent.speed.y + (moveEvent.strength.y - downEvent.strength.y) * 0.1;\r\n\t\t\t\t\tdownEvent.distance.x = moveEvent.distance.x;\r\n\t\t\t\t\tdownEvent.distance.y = moveEvent.distance.y;\r\n\t\t\t\t\tdownEvent.speed.x = moveEvent.speed.x;\r\n\t\t\t\t\tdownEvent.speed.y = moveEvent.speed.y;\r\n\t\t\t\t\tdownEvent.strength.x = moveEvent.strength.x;\r\n\t\t\t\t\tdownEvent.strength.y = moveEvent.strength.y;\r\n\t\t\t\t\tevents$.next(moveEvent);\r\n\t\t\t\t\treturn moveEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dismissEvent(event, events$, dismiss$, downEvent) {\r\n\t\t// console.log('DragService.dismissEvent', event);\r\n\t\tupEvent = upEvent || new DragUpEvent();\r\n\t\tevents$.next(upEvent);\r\n\t\tdismiss$.next();\r\n\t\t// console.log(downEvent.distance);\r\n\t\tif (downEvent && Math.abs(downEvent.distance.x) > 10) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopImmediatePropagation();\r\n\t\t}\r\n\t\treturn upEvent;\r\n\t}\r\n\r\n\tstatic up$(target, events$, dismiss$, downEvent) {\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mouseup' : 'touchend').pipe(\r\n\t\t\tmap(event => this.dismissEvent(event, events$, dismiss$, downEvent)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic observe$(target) {\r\n\t\ttarget = target || document;\r\n\t\tconst events$ = DragService.events$ = new ReplaySubject(1);\r\n\t\tconst dismiss$ = DragService.dismiss$ = new Subject();\r\n\t\treturn this.down$(target, events$).pipe(\r\n\t\t\tswitchMap((downEvent) => {\r\n\t\t\t\tDragService.downEvent = downEvent;\r\n\t\t\t\treturn merge(\r\n\t\t\t\t\tthis.move$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t\tthis.up$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t).pipe(\r\n\t\t\t\t\ttakeUntil(dismiss$),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t\tswitchMap(() => events$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n","import { combineLatest, ReplaySubject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, tap } from 'rxjs/operators';\r\nimport DragService, { DragDownEvent, DragMoveEvent, DragUpEvent } from '../../drag/drag.service';\r\nimport KeyboardService from '../../keyboard/keyboard.service';\r\nimport StateService from '../../state/state.service';\r\n\r\nexport const OrbitMode = {\r\n\tPanorama: 'panorama',\r\n\tPanoramaGrid: 'panorama-grid',\r\n\tModel: 'model',\r\n};\r\n\r\nexport class OrbitEvent { }\r\nexport class OrbitDragEvent extends OrbitEvent { }\r\nexport class OrbitResizeEvent extends OrbitEvent { }\r\nexport class OrbitMoveEvent extends OrbitEvent { }\r\nconst orbitMoveEvent = new OrbitMoveEvent();\r\nconst orbitDragEvent = new OrbitDragEvent();\r\nconst orbitResizeEvent = new OrbitResizeEvent();\r\n\r\nexport const USE_DOLLY = false;\r\nexport const DOLLY_MIN = 15;\r\nexport const DOLLY_MAX = 75; // 115\r\nexport const ZOOM_MIN = 15;\r\nexport const ZOOM_MAX = 75;\r\n\r\nexport default class OrbitService {\r\n\r\n\tget dolly() {\r\n\t\treturn this.dolly_;\r\n\t}\r\n\tset dolly(dolly) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(dolly, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.dolly_ !== clampedDolly) {\r\n\t\t\tthis.dolly_ = clampedDolly;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\tgetDollyValue() {\r\n\t\treturn (1 - (this.dolly_ - DOLLY_MIN) / (DOLLY_MAX - DOLLY_MIN)) - 0.5;\r\n\t}\r\n\r\n\tget zoom() {\r\n\t\treturn this.zoom_;\r\n\t}\r\n\tset zoom(zoom) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(zoom, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.zoom_ !== clampedDolly) {\r\n\t\t\tthis.zoom_ = clampedDolly;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\tgetZoomValue() {\r\n\t\treturn 1 + 1 - (this.zoom_ - ZOOM_MIN) / (ZOOM_MAX - ZOOM_MIN);\r\n\t}\r\n\r\n\tget mode() {\r\n\t\treturn this.mode_;\r\n\t}\r\n\tset mode(mode) {\r\n\t\tif (this.mode_ !== mode) {\r\n\t\t\tthis.mode_ = mode;\r\n\t\t\tOrbitService.mode = mode;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(camera) {\r\n\t\tthis.mode_ = OrbitService.mode = OrbitMode.Panorama;\r\n\t\tthis.dolly_ = 70;\r\n\t\tthis.zoom_ = 70;\r\n\t\tthis.longitude = 0;\r\n\t\tthis.latitude = 0;\r\n\t\tthis.direction = 1;\r\n\t\tthis.radius = 101;\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\t// this.speed = 1;\r\n\t\tthis.inertia = new THREE.Vector2();\r\n\t\tthis.rotation = new THREE.Euler(0, 0, 0, 'XYZ');\r\n\t\tthis.target = new THREE.Vector3();\r\n\t\tthis.updatePosition = new THREE.Vector3();\r\n\t\tthis.updateTarget = new THREE.Vector3();\r\n\t\tthis.camera = camera;\r\n\t\tthis.setLongitudeLatitude(0, 0);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tsetOrientation(orientation) {\r\n\t\tif (orientation) {\r\n\t\t\tthis.setLongitudeLatitude(orientation.longitude, orientation.latitude);\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tgetOrientation() {\r\n\t\treturn {\r\n\t\t\tlatitude: this.latitude,\r\n\t\t\tlongitude: this.longitude,\r\n\t\t};\r\n\t}\r\n\r\n\tsetLongitudeLatitude(longitude, latitude) {\r\n\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\tthis.longitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\tthis.latitude = latitude;\r\n\t\t// console.log(this.longitude);\r\n\t\tconst phi = THREE.Math.degToRad(90 - latitude);\r\n\t\tconst theta = THREE.Math.degToRad(longitude);\r\n\t\tthis.phi = phi;\r\n\t\tthis.theta = theta;\r\n\t}\r\n\r\n\tobserve$(node) {\r\n\t\t// const camera = this.camera;\r\n\t\tlet latitude, longitude;\r\n\t\treturn combineLatest([KeyboardService.keys$(), DragService.observe$(node)]).pipe(\r\n\t\t\tfilter(event => (!StateService.state.locked && !StateService.state.spying)),\r\n\t\t\tmap((datas) => {\r\n\t\t\t\tconst keys = datas[0];\r\n\t\t\t\tconst event = datas[1];\r\n\t\t\t\t// const group = this.objects.children[this.index];\r\n\t\t\t\tif (event instanceof DragDownEvent) {\r\n\t\t\t\t\tlatitude = this.latitude;\r\n\t\t\t\t\tlongitude = this.longitude;\r\n\t\t\t\t} else if (event instanceof DragMoveEvent) {\r\n\t\t\t\t\tif (keys.Shift) {\r\n\t\t\t\t\t\tthis.events$.next(orbitDragEvent);\r\n\t\t\t\t\t} else if (keys.Control) {\r\n\t\t\t\t\t\tthis.events$.next(orbitResizeEvent);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst flip = this.mode_ === OrbitMode.Model ? -1 : 1;\r\n\t\t\t\t\t\tthis.setLongitudeLatitude(longitude - event.distance.x * 0.1 * flip, latitude + event.distance.y * 0.1);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (event instanceof DragUpEvent) {\r\n\r\n\t\t\t\t}\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\tfilter(event => event instanceof DragMoveEvent),\r\n\t\t\tstartWith({ latitude: this.latitude, longitude: this.longitude }),\r\n\t\t\ttap(event => this.update()),\r\n\t\t\tswitchMap(event => this.events$),\r\n\t\t);\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tlet radius, position = this.updatePosition, target = this.updateTarget;\r\n\t\tconst zoom = this.getZoomValue();\r\n\t\tconst dolly = this.getDollyValue();\r\n\t\t// console.log('dolly', dolly);\r\n\t\tconst phi = THREE.MathUtils.degToRad(90 - this.latitude);\r\n\t\tconst theta = THREE.MathUtils.degToRad(this.longitude);\r\n\t\tconst camera = this.camera;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = USE_DOLLY ? 3 + 3 * dolly : 3;\r\n\t\t\t\tposition.copy(this.position);\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tcamera.target.copy(position);\r\n\t\t\t\tcamera.position.copy(target);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tif (USE_DOLLY) {\r\n\t\t\t\t\tposition.copy(target).position.multiplyScalar(-1 * dolly);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tposition.copy(this.position);\r\n\t\t\t\t}\r\n\t\t\t\tcamera.position.copy(position);\r\n\t\t\t\tcamera.target.copy(target);\r\n\t\t}\r\n\t\t// console.log(camera.position.x, camera.position.y, camera.position.z);\r\n\t\t// console.log(camera.target.x, camera.target.y, camera.target.z);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t\t// this.inverse();\r\n\t\tif (!USE_DOLLY) {\r\n\t\t\tcamera.zoom = zoom;\r\n\t\t}\r\n\t\tcamera.lookAt(camera.target);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tthis.events$.next(orbitMoveEvent);\r\n\t}\r\n\r\n\t/*\r\n\tinverse() {\r\n\t\tlet position, radius;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = 3;\r\n\t\t\t\tposition = this.camera.position;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\tposition = this.camera.target;\r\n\t\t}\r\n\t\tradius = Math.sqrt(position.x * position.x + position.y * position.y + position.z * position.z);\r\n\t\tconst phi = Math.acos(position.y / radius);\r\n\t\tconst theta = Math.atan2(position.z, position.x);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t}\r\n\t*/\r\n\r\n\trender() {\r\n\t\tthis.longitude += 0.025;\r\n\t\tthis.update();\r\n\t}\r\n\r\n\twalk(position, callback) {\r\n\t\tlet radius;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = 3;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t}\r\n\t\tconst heading = new THREE.Vector2(position.x, position.y).normalize().multiplyScalar(radius);\r\n\t\tconst headingTheta = Math.atan2(heading.y, heading.x);\r\n\t\tlet headingLongitude = THREE.MathUtils.radToDeg(headingTheta);\r\n\t\theadingLongitude = (headingLongitude < 0 ? 360 + headingLongitude : headingLongitude) % 360;\r\n\t\tconst headingLatitude = 0;\r\n\t\tconst latitude = this.latitude;\r\n\t\tconst longitude = this.longitude;\r\n\t\tlet differenceLongitude = (headingLongitude - longitude);\r\n\t\tdifferenceLongitude = Math.abs(differenceLongitude) > 180 ? (differenceLongitude - 360 * (differenceLongitude / Math.abs(differenceLongitude))) : differenceLongitude;\r\n\t\tlet differenceLatitude = (headingLatitude - latitude);\r\n\t\tdifferenceLatitude = Math.abs(differenceLatitude) > 90 ? (differenceLatitude - 90 * (differenceLatitude / Math.abs(differenceLatitude))) : differenceLatitude;\r\n\t\t// console.log('headingTheta', headingTheta, 'headingLongitude', headingLongitude, 'differenceLongitude', differenceLongitude);\r\n\t\tconst from = { tween: 0 };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.7,\r\n\t\t\ttween: 1,\r\n\t\t\tdelay: 0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.setLongitudeLatitude(longitude + differenceLongitude * from.tween, latitude + differenceLatitude * from.tween);\r\n\t\t\t\tthis.position.set(position.x * from.tween, 0, position.y * from.tween);\r\n\t\t\t\tthis.update();\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\t// this.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(headingLongitude, headingLatitude);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\twalkComplete(headingLongitude, headingLatitude) {\r\n\t\tthis.setLongitudeLatitude(headingLongitude, headingLatitude);\r\n\t\tthis.position.set(0, 0, 0);\r\n\t\tthis.update();\r\n\t}\r\n\r\n\tlookAt(object3d) {\r\n\t\t// !!! fix\r\n\t\tif (object3d) {\r\n\t\t\t/*\r\n\t\t\tconst camera = this.camera;\r\n\t\t\tcamera.target.copy(object3d.position);\r\n\t\t\tcamera.lookAt(camera.target);\r\n\t\t\tcamera.updateProjectionMatrix();\r\n\t\t\t*/\r\n\t\t\tconst position = object3d.position;\r\n\t\t\tlet radius;\r\n\t\t\tswitch (this.mode_) {\r\n\t\t\t\tcase OrbitMode.Model:\r\n\t\t\t\t\tradius = 3;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tradius = this.radius;\r\n\t\t\t}\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.update();\r\n\t\t\t// this.events$.next(orbitMoveEvent);\r\n\t\t}\r\n\t\t/*\r\n\t\tlet radius, position = this.updatePosition, target = this.updateTarget;\r\n\t\tconst zoom = this.getZoomValue();\r\n\t\tconst dolly = this.getDollyValue();\r\n\t\t// console.log('dolly', dolly);\r\n\t\tconst phi = THREE.MathUtils.degToRad(90 - this.latitude);\r\n\t\tconst theta = THREE.MathUtils.degToRad(this.longitude);\r\n\t\tconst camera = this.camera;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = USE_DOLLY ? 3 + 3 * dolly : 3;\r\n\t\t\t\tposition.copy(this.position);\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tcamera.target.copy(position);\r\n\t\t\t\tcamera.position.copy(target);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tif (USE_DOLLY) {\r\n\t\t\t\t\tposition.copy(target).position.multiplyScalar(-1 * dolly);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tposition.copy(this.position);\r\n\t\t\t\t}\r\n\t\t\t\tcamera.position.copy(position);\r\n\t\t\t\tcamera.target.copy(target);\r\n\t\t}\r\n\t\t// console.log(camera.position.x, camera.position.y, camera.position.z);\r\n\t\t// console.log(camera.target.x, camera.target.y, camera.target.z);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t\t// this.inverse();\r\n\t\tif (!USE_DOLLY) {\r\n\t\t\tcamera.zoom = zoom;\r\n\t\t}\r\n\t\tcamera.lookAt(camera.target);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tthis.events$.next(orbitMoveEvent);\r\n\t\t*/\r\n\t}\r\n\r\n\tsetVRCamera(camera) {\r\n\t\tif (camera) {\r\n\t\t\t// head.quaternion.set(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t\t// head.position.set(camera[0], camera[1], camera[2]);\r\n\t\t\tconst radius = this.radius;\r\n\t\t\tconst position = new THREE.Vector3(0, 0, -radius);\r\n\t\t\tconst quaternion = new THREE.Quaternion(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t\tposition.applyQuaternion(quaternion);\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import StreamService from \"../../stream/stream.service\";\r\n\r\nexport const W = 12;\r\nexport const H = 27;\r\nexport const D = 0.5;\r\nexport const R = 4 / 3;\r\nexport const COLORS = [0xffffff, 0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff];\r\n\r\nexport class PhoneStreamElement {\r\n\r\n\tstatic get geometry() {\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(0.01 * W, 0.01 * W / R, 2, 2);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tsetRemote(remote, i, total) {\r\n\t\tthis.remote = remote;\r\n\t\tlet s, c, r, w, h, sx, sy, sz = 0.01 * D; // !!! double distance\r\n\t\tif (total < 4) {\r\n\t\t\ts = 1;\r\n\t\t\tc = 0;\r\n\t\t\tr = i;\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = 0;\r\n\t\t\tsy = h / 2 - (total * h) / 2;\r\n\t\t\tthis.plane.position.set(sx, sy + h * i, sz);\r\n\t\t} else {\r\n\t\t\ts = 0.5;\r\n\t\t\tc = i % 2;\r\n\t\t\tr = Math.floor(i / 2);\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = -w / 2;\r\n\t\t\tsy = h / 2 - (Math.ceil(total / 2) * h) / 2;\r\n\t\t\tthis.plane.position.set(sx + c * w, sy + r * h, sz);\r\n\t\t}\r\n\t\tthis.plane.scale.set(s, s, s);\r\n\t\t// console.log(this.plane.position);\r\n\t\tif (typeof remote === 'number') {\r\n\t\t\tthis.plane.material.color.set(COLORS[i % COLORS.length]);\r\n\t\t} else {\r\n\t\t\tif (remote.texture) {\r\n\t\t\t\tthis.plane.material.map = remote.texture;\r\n\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.addStreamTexture(remote.getId(), (texture) => {\r\n\t\t\t\t\tremote.texture = texture;\r\n\t\t\t\t\tthis.plane.material.map = texture;\r\n\t\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddStreamTexture(streamId, callback) {\r\n\t\tconst target = `#stream-${streamId}`;\r\n\t\tconst video = document.querySelector(`${target} video`);\r\n\t\tif (!video) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst onPlaying = () => {\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t}\r\n\t\t};\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\tonPlaying();\r\n\t\t} else {\r\n\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\tonPlaying();\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst geometry = PhoneStreamElement.geometry;\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0xffffff,\r\n\t\t\tside: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst plane = this.plane = new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n}\r\n\r\nexport default class PhoneElement {\r\n\r\n\tset remotes(remotes) {\r\n\t\t// console.log('PhoneElement', remotes);\r\n\t\tremotes.forEach((remote, i) => {\r\n\t\t\tlet stream = this.streams[i];\r\n\t\t\tif (!stream) {\r\n\t\t\t\tstream = new PhoneStreamElement();\r\n\t\t\t}\r\n\t\t\tstream.setRemote(remote, i, remotes.length);\r\n\t\t\tthis.phone.add(stream.plane);\r\n\t\t\tthis.streams[i] = stream;\r\n\t\t});\r\n\t\tfor (let i = remotes.length; i < this.streams.length; i++) {\r\n\t\t\tthis.phone.remove(this.streams[i].plane);\r\n\t\t}\r\n\t\tthis.streams.length = remotes.length;\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst mesh = this.mesh = new THREE.Group();\r\n\t\tconst phone = this.phone = this.create();\r\n\t\tmesh.add(phone);\r\n\t\tconst streams = this.streams = [];\r\n\t\tStreamService.remotes$.subscribe(remotes => {\r\n\t\t\tthis.remotes = remotes;\r\n\t\t});\r\n\t}\r\n\r\n\tcreate() {\r\n\t\tconst geometry = new THREE.BoxBufferGeometry(0.01 * W, 0.01 * H, 0.01 * D, 2, 2, 1);\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0x202020,\r\n\t\t});\r\n\t\tconst phone = new THREE.Mesh(geometry, material);\r\n\t\tphone.rotation.set(-Math.PI / 4, 0, 0);\r\n\t\treturn phone;\r\n\t}\r\n\r\n}\r\n","import { environment } from '../../environment';\r\nimport Interactive from '../interactive/interactive';\r\n\r\nconst ORIGIN = new THREE.Vector3();\r\n\r\nexport default class PointerElement {\r\n\r\n\tconstructor(color = '#ffffff') {\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1.2, 1.2, 2, 2);\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tconst texture = loader.load(environment.getPath('textures/ui/nav-point.png'));\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: new THREE.Color(color),\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = this.mesh = new THREE.Mesh(geometry, material);\r\n\t\tmesh.renderOrder = environment.renderOrder.pointer;\r\n\t\tmesh.position.set(-100000, -100000, -100000);\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tif (Interactive.lastIntersectedObject) {\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst position = Interactive.lastIntersectedObject.intersection.point.multiplyScalar(0.99);\r\n\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\tconst s = mesh.position.length() / 80;\r\n\t\t\tmesh.scale.set(s, s, s);\r\n\t\t\tmesh.lookAt(ORIGIN);\r\n\t\t}\r\n\t}\r\n\r\n\tsetPosition(x, y, z) {\r\n\t\tconst mesh = this.mesh;\r\n\t\tmesh.position.set(x, y, z).multiplyScalar(80);\r\n\t\tconst s = mesh.position.length() / 80;\r\n\t\tmesh.scale.set(s, s, s);\r\n\t\tmesh.lookAt(ORIGIN);\r\n\t\t// console.log('PointerElement.setPosition', x, y, z);\r\n\t}\r\n}\r\n","import Emittable from '../interactive/emittable';\r\n\r\nexport class Gamepad extends Emittable {\r\n\tconstructor(gamepad) {\r\n\t\tsuper();\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.buttons = {};\r\n\t\tthis.axes = {};\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tthis.updateButtons();\r\n\t\tthis.updateAxes();\r\n\t}\r\n\r\n\tupdateButtons() {\r\n\t\tthis.gamepad.buttons.forEach((x, i) => {\r\n\t\t\tconst pressed = x.pressed;\r\n\t\t\tconst button = this.buttons[i] || (this.buttons[i] = new GamepadButton(i, this));\r\n\t\t\tif (button.pressed !== pressed) {\r\n\t\t\t\tbutton.pressed = pressed;\r\n\t\t\t\tif (pressed) {\r\n\t\t\t\t\tthis.emit('press', button);\r\n\t\t\t\t} else if (status !== undefined) {\r\n\t\t\t\t\tthis.emit('release', button);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tupdateAxes() {\r\n\t\tconst axes = this.gamepad.axes;\r\n\t\tfor (let i = 0; i < axes.length; i += 2) {\r\n\t\t\tconst index = Math.floor(i / 2);\r\n\t\t\tconst axis = this.axes[index] || (this.axes[index] = new GamepadAxis(index, this));\r\n\t\t\tconst x = axes[i];\r\n\t\t\tconst y = axes[i + 1];\r\n\t\t\tif (axis.x !== x || axis.y !== y) {\r\n\t\t\t\taxis.x = x;\r\n\t\t\t\taxis.y = y;\r\n\t\t\t\tif (Math.abs(x) > Math.abs(y)) {\r\n\t\t\t\t\tconst left = x < -0.85;\r\n\t\t\t\t\tconst right = x > 0.85;\r\n\t\t\t\t\tif (axis.left !== left) {\r\n\t\t\t\t\t\taxis.left = left;\r\n\t\t\t\t\t\tthis.emit((left ? 'left' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} left ${left}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.right !== right) {\r\n\t\t\t\t\t\taxis.right = right;\r\n\t\t\t\t\t\tthis.emit((right ? 'right' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} right ${right}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst up = y < -0.85;\r\n\t\t\t\t\tconst down = y > 0.85;\r\n\t\t\t\t\tif (axis.up !== up) {\r\n\t\t\t\t\t\taxis.up = up;\r\n\t\t\t\t\t\tthis.emit((up ? 'up' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} up ${up}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.down !== down) {\r\n\t\t\t\t\t\taxis.down = down;\r\n\t\t\t\t\t\tthis.emit((down ? 'down' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} down ${down}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.emit('axis', axis);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfeedback(strength = 0.1, duration = 50) {\r\n\t\t// !!! care for battery\r\n\t\tconst actuators = this.gamepad.hapticActuators;\r\n\t\tif (actuators && actuators.length) {\r\n\t\t\treturn actuators[0].pulse(strength, duration);\r\n\t\t} else {\r\n\t\t\treturn Promise.reject();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass GamepadButton {\r\n\tconstructor(index, gamepad) {\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.pressed = false;\r\n\t}\r\n}\r\n\r\nclass GamepadAxis extends THREE.Vector2 {\r\n\tconstructor(index, gamepad) {\r\n\t\tsuper();\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.left = this.right = this.up = this.down = false;\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","/**\r\n * @webxr-input-profiles/motion-controllers 1.0.0 https://github.com/immersive-web/webxr-input-profiles\r\n */\r\n\r\nconst Constants = {\r\n  Handedness: Object.freeze({\r\n    NONE: 'none',\r\n    LEFT: 'left',\r\n    RIGHT: 'right'\r\n  }),\r\n\r\n  ComponentState: Object.freeze({\r\n    DEFAULT: 'default',\r\n    TOUCHED: 'touched',\r\n    PRESSED: 'pressed'\r\n  }),\r\n\r\n  ComponentProperty: Object.freeze({\r\n    BUTTON: 'button',\r\n    X_AXIS: 'xAxis',\r\n    Y_AXIS: 'yAxis',\r\n    STATE: 'state'\r\n  }),\r\n\r\n  ComponentType: Object.freeze({\r\n    TRIGGER: 'trigger',\r\n    SQUEEZE: 'squeeze',\r\n    TOUCHPAD: 'touchpad',\r\n    THUMBSTICK: 'thumbstick',\r\n    BUTTON: 'button'\r\n  }),\r\n\r\n  ButtonTouchThreshold: 0.05,\r\n\r\n  AxisTouchThreshold: 0.1,\r\n\r\n  VisualResponseProperty: Object.freeze({\r\n    TRANSFORM: 'transform',\r\n    VISIBILITY: 'visibility'\r\n  })\r\n};\r\n\r\n/**\r\n * @description Static helper function to fetch a JSON file and turn it into a JS object\r\n * @param {string} path - Path to JSON file to be fetched\r\n */\r\nasync function fetchJsonFile(path) {\r\n  const response = await fetch(path);\r\n  if (!response.ok) {\r\n    throw new Error(response.statusText);\r\n  } else {\r\n    return response.json();\r\n  }\r\n}\r\n\r\nasync function fetchProfilesList(basePath) {\r\n  if (!basePath) {\r\n    throw new Error('No basePath supplied');\r\n  }\r\n\r\n  const profileListFileName = 'profilesList.json';\r\n  const profilesList = await fetchJsonFile(`${basePath}/${profileListFileName}`);\r\n  return profilesList;\r\n}\r\n\r\nasync function fetchProfile(xrInputSource, basePath, defaultProfile = null, getAssetPath = true) {\r\n  if (!xrInputSource) {\r\n    throw new Error('No xrInputSource supplied');\r\n  }\r\n\r\n  if (!basePath) {\r\n    throw new Error('No basePath supplied');\r\n  }\r\n\r\n  // Get the list of profiles\r\n  const supportedProfilesList = await fetchProfilesList(basePath);\r\n\r\n  // Find the relative path to the first requested profile that is recognized\r\n  let match;\r\n  xrInputSource.profiles.some((profileId) => {\r\n    const supportedProfile = supportedProfilesList[profileId];\r\n    if (supportedProfile) {\r\n      match = {\r\n        profileId,\r\n        profilePath: `${basePath}/${supportedProfile.path}`,\r\n        deprecated: !!supportedProfile.deprecated\r\n      };\r\n    }\r\n    return !!match;\r\n  });\r\n\r\n  if (!match) {\r\n    if (!defaultProfile) {\r\n      throw new Error('No matching profile name found');\r\n    }\r\n\r\n    const supportedProfile = supportedProfilesList[defaultProfile];\r\n    if (!supportedProfile) {\r\n      throw new Error(`No matching profile name found and default profile \"${defaultProfile}\" missing.`);\r\n    }\r\n\r\n    match = {\r\n      profileId: defaultProfile,\r\n      profilePath: `${basePath}/${supportedProfile.path}`,\r\n      deprecated: !!supportedProfile.deprecated\r\n    };\r\n  }\r\n\r\n  const profile = await fetchJsonFile(match.profilePath);\r\n\r\n  let assetPath;\r\n  if (getAssetPath) {\r\n    let layout;\r\n    if (xrInputSource.handedness === 'any') {\r\n      layout = profile.layouts[Object.keys(profile.layouts)[0]];\r\n    } else {\r\n      layout = profile.layouts[xrInputSource.handedness];\r\n    }\r\n    if (!layout) {\r\n      throw new Error(\r\n        `No matching handedness, ${xrInputSource.handedness}, in profile ${match.profileId}`\r\n      );\r\n    }\r\n\r\n    if (layout.assetPath) {\r\n      assetPath = match.profilePath.replace('profile.json', layout.assetPath);\r\n    }\r\n  }\r\n\r\n  return { profile, assetPath };\r\n}\r\n\r\n/** @constant {Object} */\r\nconst defaultComponentValues = {\r\n  xAxis: 0,\r\n  yAxis: 0,\r\n  button: 0,\r\n  state: Constants.ComponentState.DEFAULT\r\n};\r\n\r\n/**\r\n * @description Converts an X, Y coordinate from the range -1 to 1 (as reported by the Gamepad\r\n * API) to the range 0 to 1 (for interpolation). Also caps the X, Y values to be bounded within\r\n * a circle. This ensures that thumbsticks are not animated outside the bounds of their physical\r\n * range of motion and touchpads do not report touch locations off their physical bounds.\r\n * @param {number} x The original x coordinate in the range -1 to 1\r\n * @param {number} y The original y coordinate in the range -1 to 1\r\n */\r\nfunction normalizeAxes(x = 0, y = 0) {\r\n  let xAxis = x;\r\n  let yAxis = y;\r\n\r\n  // Determine if the point is outside the bounds of the circle\r\n  // and, if so, place it on the edge of the circle\r\n  const hypotenuse = Math.sqrt((x * x) + (y * y));\r\n  if (hypotenuse > 1) {\r\n    const theta = Math.atan2(y, x);\r\n    xAxis = Math.cos(theta);\r\n    yAxis = Math.sin(theta);\r\n  }\r\n\r\n  // Scale and move the circle so values are in the interpolation range.  The circle's origin moves\r\n  // from (0, 0) to (0.5, 0.5). The circle's radius scales from 1 to be 0.5.\r\n  const result = {\r\n    normalizedXAxis: (xAxis * 0.5) + 0.5,\r\n    normalizedYAxis: (yAxis * 0.5) + 0.5\r\n  };\r\n  return result;\r\n}\r\n\r\n/**\r\n * Contains the description of how the 3D model should visually respond to a specific user input.\r\n * This is accomplished by initializing the object with the name of a node in the 3D model and\r\n * property that need to be modified in response to user input, the name of the nodes representing\r\n * the allowable range of motion, and the name of the input which triggers the change. In response\r\n * to the named input changing, this object computes the appropriate weighting to use for\r\n * interpolating between the range of motion nodes.\r\n */\r\nclass VisualResponse {\r\n  constructor(visualResponseDescription) {\r\n    this.componentProperty = visualResponseDescription.componentProperty;\r\n    this.states = visualResponseDescription.states;\r\n    this.valueNodeName = visualResponseDescription.valueNodeName;\r\n    this.valueNodeProperty = visualResponseDescription.valueNodeProperty;\r\n\r\n    if (this.valueNodeProperty === Constants.VisualResponseProperty.TRANSFORM) {\r\n      this.minNodeName = visualResponseDescription.minNodeName;\r\n      this.maxNodeName = visualResponseDescription.maxNodeName;\r\n    }\r\n\r\n    // Initializes the response's current value based on default data\r\n    this.value = 0;\r\n    this.updateFromComponent(defaultComponentValues);\r\n  }\r\n\r\n  /**\r\n   * Computes the visual response's interpolation weight based on component state\r\n   * @param {Object} componentValues - The component from which to update\r\n   * @param {number} xAxis - The reported X axis value of the component\r\n   * @param {number} yAxis - The reported Y axis value of the component\r\n   * @param {number} button - The reported value of the component's button\r\n   * @param {string} state - The component's active state\r\n   */\r\n  updateFromComponent({\r\n    xAxis, yAxis, button, state\r\n  }) {\r\n    const { normalizedXAxis, normalizedYAxis } = normalizeAxes(xAxis, yAxis);\r\n    switch (this.componentProperty) {\r\n      case Constants.ComponentProperty.X_AXIS:\r\n        this.value = (this.states.includes(state)) ? normalizedXAxis : 0.5;\r\n        break;\r\n      case Constants.ComponentProperty.Y_AXIS:\r\n        this.value = (this.states.includes(state)) ? normalizedYAxis : 0.5;\r\n        break;\r\n      case Constants.ComponentProperty.BUTTON:\r\n        this.value = (this.states.includes(state)) ? button : 0;\r\n        break;\r\n      case Constants.ComponentProperty.STATE:\r\n        if (this.valueNodeProperty === Constants.VisualResponseProperty.VISIBILITY) {\r\n          this.value = (this.states.includes(state));\r\n        } else {\r\n          this.value = this.states.includes(state) ? 1.0 : 0.0;\r\n        }\r\n        break;\r\n      default:\r\n        throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`);\r\n    }\r\n  }\r\n}\r\n\r\nclass Component {\r\n  /**\r\n   * @param {Object} componentId - Id of the component\r\n   * @param {Object} componentDescription - Description of the component to be created\r\n   */\r\n  constructor(componentId, componentDescription) {\r\n    if (!componentId\r\n     || !componentDescription\r\n     || !componentDescription.visualResponses\r\n     || !componentDescription.gamepadIndices\r\n     || Object.keys(componentDescription.gamepadIndices).length === 0) {\r\n      throw new Error('Invalid arguments supplied');\r\n    }\r\n\r\n    this.id = componentId;\r\n    this.type = componentDescription.type;\r\n    this.rootNodeName = componentDescription.rootNodeName;\r\n    this.touchPointNodeName = componentDescription.touchPointNodeName;\r\n\r\n    // Build all the visual responses for this component\r\n    this.visualResponses = {};\r\n    Object.keys(componentDescription.visualResponses).forEach((responseName) => {\r\n      const visualResponse = new VisualResponse(componentDescription.visualResponses[responseName]);\r\n      this.visualResponses[responseName] = visualResponse;\r\n    });\r\n\r\n    // Set default values\r\n    this.gamepadIndices = Object.assign({}, componentDescription.gamepadIndices);\r\n\r\n    this.values = {\r\n      state: Constants.ComponentState.DEFAULT,\r\n      button: (this.gamepadIndices.button !== undefined) ? 0 : undefined,\r\n      xAxis: (this.gamepadIndices.xAxis !== undefined) ? 0 : undefined,\r\n      yAxis: (this.gamepadIndices.yAxis !== undefined) ? 0 : undefined\r\n    };\r\n  }\r\n\r\n  get data() {\r\n    const data = { id: this.id, ...this.values };\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @description Poll for updated data based on current gamepad state\r\n   * @param {Object} gamepad - The gamepad object from which the component data should be polled\r\n   */\r\n  updateFromGamepad(gamepad) {\r\n    // Set the state to default before processing other data sources\r\n    this.values.state = Constants.ComponentState.DEFAULT;\r\n\r\n    // Get and normalize button\r\n    if (this.gamepadIndices.button !== undefined\r\n        && gamepad.buttons.length > this.gamepadIndices.button) {\r\n      const gamepadButton = gamepad.buttons[this.gamepadIndices.button];\r\n      this.values.button = gamepadButton.value;\r\n      this.values.button = (this.values.button < 0) ? 0 : this.values.button;\r\n      this.values.button = (this.values.button > 1) ? 1 : this.values.button;\r\n\r\n      // Set the state based on the button\r\n      if (gamepadButton.pressed || this.values.button === 1) {\r\n        this.values.state = Constants.ComponentState.PRESSED;\r\n      } else if (gamepadButton.touched || this.values.button > Constants.ButtonTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Get and normalize x axis value\r\n    if (this.gamepadIndices.xAxis !== undefined\r\n        && gamepad.axes.length > this.gamepadIndices.xAxis) {\r\n      this.values.xAxis = gamepad.axes[this.gamepadIndices.xAxis];\r\n      this.values.xAxis = (this.values.xAxis < -1) ? -1 : this.values.xAxis;\r\n      this.values.xAxis = (this.values.xAxis > 1) ? 1 : this.values.xAxis;\r\n\r\n      // If the state is still default, check if the xAxis makes it touched\r\n      if (this.values.state === Constants.ComponentState.DEFAULT\r\n        && Math.abs(this.values.xAxis) > Constants.AxisTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Get and normalize Y axis value\r\n    if (this.gamepadIndices.yAxis !== undefined\r\n        && gamepad.axes.length > this.gamepadIndices.yAxis) {\r\n      this.values.yAxis = gamepad.axes[this.gamepadIndices.yAxis];\r\n      this.values.yAxis = (this.values.yAxis < -1) ? -1 : this.values.yAxis;\r\n      this.values.yAxis = (this.values.yAxis > 1) ? 1 : this.values.yAxis;\r\n\r\n      // If the state is still default, check if the yAxis makes it touched\r\n      if (this.values.state === Constants.ComponentState.DEFAULT\r\n        && Math.abs(this.values.yAxis) > Constants.AxisTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Update the visual response weights based on the current component data\r\n    Object.values(this.visualResponses).forEach((visualResponse) => {\r\n      visualResponse.updateFromComponent(this.values);\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n  * @description Builds a motion controller with components and visual responses based on the\r\n  * supplied profile description. Data is polled from the xrInputSource's gamepad.\r\n  * @author Nell Waliczek / https://github.com/NellWaliczek\r\n*/\r\nclass MotionController {\r\n  /**\r\n   * @param {Object} xrInputSource - The XRInputSource to build the MotionController around\r\n   * @param {Object} profile - The best matched profile description for the supplied xrInputSource\r\n   * @param {Object} assetUrl\r\n   */\r\n  constructor(xrInputSource, profile, assetUrl) {\r\n    if (!xrInputSource) {\r\n      throw new Error('No xrInputSource supplied');\r\n    }\r\n\r\n    if (!profile) {\r\n      throw new Error('No profile supplied');\r\n    }\r\n\r\n    this.xrInputSource = xrInputSource;\r\n    this.assetUrl = assetUrl;\r\n    this.id = profile.profileId;\r\n\r\n    // Build child components as described in the profile description\r\n    this.layoutDescription = profile.layouts[xrInputSource.handedness];\r\n    this.components = {};\r\n    Object.keys(this.layoutDescription.components).forEach((componentId) => {\r\n      const componentDescription = this.layoutDescription.components[componentId];\r\n      this.components[componentId] = new Component(componentId, componentDescription);\r\n    });\r\n\r\n    // Initialize components based on current gamepad state\r\n    this.updateFromGamepad();\r\n  }\r\n\r\n  get gripSpace() {\r\n    return this.xrInputSource.gripSpace;\r\n  }\r\n\r\n  get targetRaySpace() {\r\n    return this.xrInputSource.targetRaySpace;\r\n  }\r\n\r\n  /**\r\n   * @description Returns a subset of component data for simplified debugging\r\n   */\r\n  get data() {\r\n    const data = [];\r\n    Object.values(this.components).forEach((component) => {\r\n      data.push(component.data);\r\n    });\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @description Poll for updated data based on current gamepad state\r\n   */\r\n  updateFromGamepad() {\r\n    Object.values(this.components).forEach((component) => {\r\n      component.updateFromGamepad(this.xrInputSource.gamepad);\r\n    });\r\n  }\r\n}\r\n\r\nexport { Constants, MotionController, fetchProfile, fetchProfilesList };\r\n","\r\n// import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\n\r\nimport { Constants as MotionControllerConstants, fetchProfile, MotionController } from './motion-controllers.module.js';\r\n\r\nconst DEFAULT_PROFILES_PATH = 'https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles';\r\nconst DEFAULT_PROFILE = 'generic-trigger';\r\n\r\nfunction XRControllerModel() {\r\n\tTHREE.Object3D.call(this);\r\n\tthis.motionController = null;\r\n\tthis.envMap = null;\r\n}\r\n\r\nXRControllerModel.prototype = Object.assign(Object.create(THREE.Object3D.prototype), {\r\n\r\n\tconstructor: XRControllerModel,\r\n\r\n\tsetEnvironmentMap: function(envMap) {\r\n\r\n\t\tif (this.envMap == envMap) {\r\n\r\n\t\t\treturn this;\r\n\r\n\t\t}\r\n\r\n\t\tthis.envMap = envMap;\r\n\t\tthis.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh) {\r\n\r\n\t\t\t\tchild.material.envMap = this.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\treturn this;\r\n\r\n\t},\r\n\r\n\t/**\r\n\t * Polls data from the XRInputSource and updates the model's components to match\r\n\t * the real world data\r\n\t */\r\n\tupdateMatrixWorld: function(force) {\r\n\r\n\t\tTHREE.Object3D.prototype.updateMatrixWorld.call(this, force);\r\n\r\n\t\tif (!this.motionController) return;\r\n\r\n\t\t// Cause the MotionController to poll the Gamepad for data\r\n\t\tthis.motionController.updateFromGamepad();\r\n\r\n\t\t// Update the 3D model to reflect the button, thumbstick, and touchpad state\r\n\t\tObject.values(this.motionController.components).forEach((component) => {\r\n\r\n\t\t\t// Update node data based on the visual responses' current states\r\n\t\t\tObject.values(component.visualResponses).forEach((visualResponse) => {\r\n\r\n\t\t\t\tconst { valueNode, minNode, maxNode, value, valueNodeProperty } = visualResponse;\r\n\r\n\t\t\t\t// Skip if the visual response node is not found. No error is needed,\r\n\t\t\t\t// because it will have been reported at load time.\r\n\t\t\t\tif (!valueNode) return;\r\n\r\n\t\t\t\t// Calculate the new properties based on the weight supplied\r\n\t\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.VISIBILITY) {\r\n\r\n\t\t\t\t\tvalueNode.visible = value;\r\n\r\n\t\t\t\t} else if (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\r\n\t\t\t\t\tTHREE.Quaternion.slerp(\r\n\t\t\t\t\t\tminNode.quaternion,\r\n\t\t\t\t\t\tmaxNode.quaternion,\r\n\t\t\t\t\t\tvalueNode.quaternion,\r\n\t\t\t\t\t\tvalue\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tvalueNode.position.lerpVectors(\r\n\t\t\t\t\t\tminNode.position,\r\n\t\t\t\t\t\tmaxNode.position,\r\n\t\t\t\t\t\tvalue\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n});\r\n\r\n/**\r\n * Walks the model's tree to find the nodes needed to animate the components and\r\n * saves them to the motionContoller components for use in the frame loop. When\r\n * touchpads are found, attaches a touch dot to them.\r\n */\r\nfunction findNodes(motionController, scene) {\r\n\r\n\t// Loop through the components and find the nodes needed for each components' visual responses\r\n\tObject.values(motionController.components).forEach((component) => {\r\n\r\n\t\tconst { type, touchPointNodeName, visualResponses } = component;\r\n\r\n\t\tif (type === MotionControllerConstants.ComponentType.TOUCHPAD) {\r\n\r\n\t\t\tcomponent.touchPointNode = scene.getObjectByName(touchPointNodeName);\r\n\t\t\tif (component.touchPointNode) {\r\n\r\n\t\t\t\t// Attach a touch dot to the touchpad.\r\n\t\t\t\tconst sphereGeometry = new THREE.SphereBufferGeometry(0.001);\r\n\t\t\t\tconst material = new THREE.MeshBasicMaterial({ color: 0x0000FF });\r\n\t\t\t\tconst sphere = new THREE.Mesh(sphereGeometry, material);\r\n\t\t\t\tcomponent.touchPointNode.add(sphere);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.warn(`Could not find touch dot, ${component.touchPointNodeName}, in touchpad component ${component.id}`);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t// Loop through all the visual responses to be applied to this component\r\n\t\tObject.values(visualResponses).forEach((visualResponse) => {\r\n\r\n\t\t\tconst { valueNodeName, minNodeName, maxNodeName, valueNodeProperty } = visualResponse;\r\n\r\n\t\t\t// If animating a transform, find the two nodes to be interpolated between.\r\n\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\r\n\t\t\t\tvisualResponse.minNode = scene.getObjectByName(minNodeName);\r\n\t\t\t\tvisualResponse.maxNode = scene.getObjectByName(maxNodeName);\r\n\r\n\t\t\t\t// If the extents cannot be found, skip this animation\r\n\t\t\t\tif (!visualResponse.minNode) {\r\n\r\n\t\t\t\t\tconsole.warn(`Could not find ${minNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!visualResponse.maxNode) {\r\n\r\n\t\t\t\t\tconsole.warn(`Could not find ${maxNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// If the target node cannot be found, skip this animation\r\n\t\t\tvisualResponse.valueNode = scene.getObjectByName(valueNodeName);\r\n\t\t\tif (!visualResponse.valueNode) {\r\n\r\n\t\t\t\tconsole.warn(`Could not find ${valueNodeName} in the model`);\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction addAssetSceneToControllerModel(controllerModel, scene) {\r\n\r\n\t// Find the nodes needed for animation and cache them on the motionController.\r\n\tfindNodes(controllerModel.motionController, scene);\r\n\r\n\t// Apply any environment map that the mesh already has set.\r\n\tif (controllerModel.envMap) {\r\n\r\n\t\tscene.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh) {\r\n\r\n\t\t\t\tchild.material.envMap = controllerModel.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\t// Add the glTF scene to the controllerModel.\r\n\tcontrollerModel.add(scene);\r\n\r\n}\r\n\r\nvar XRControllerModelFactory = (function() {\r\n\r\n\tfunction XRControllerModelFactory(gltfLoader = null) {\r\n\r\n\t\tthis.gltfLoader = gltfLoader;\r\n\t\tthis.path = DEFAULT_PROFILES_PATH;\r\n\t\tthis._assetCache = {};\r\n\r\n\t\t// If a GLTFLoader wasn't supplied to the constructor create a new one.\r\n\t\tif (!this.gltfLoader) {\r\n\t\t\tthis.gltfLoader = new THREE.GLTFLoader();\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tXRControllerModelFactory.prototype = {\r\n\r\n\t\tconstructor: XRControllerModelFactory,\r\n\r\n\t\tcreateControllerModel: function(controller) {\r\n\r\n\t\t\tconst controllerModel = new XRControllerModel();\r\n\t\t\tlet scene = null;\r\n\r\n\t\t\tcontroller.addEventListener('connected', (event) => {\r\n\r\n\t\t\t\tconst xrInputSource = event.data;\r\n\r\n\t\t\t\tif (xrInputSource.targetRayMode !== 'tracked-pointer' || !xrInputSource.gamepad) return;\r\n\r\n\t\t\t\tfetchProfile(xrInputSource, this.path, DEFAULT_PROFILE).then(({ profile, assetPath }) => {\r\n\r\n\t\t\t\t\tcontrollerModel.motionController = new MotionController(\r\n\t\t\t\t\t\txrInputSource,\r\n\t\t\t\t\t\tprofile,\r\n\t\t\t\t\t\tassetPath\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tlet cachedAsset = this._assetCache[controllerModel.motionController.assetUrl];\r\n\t\t\t\t\tif (cachedAsset) {\r\n\r\n\t\t\t\t\t\tscene = cachedAsset.scene.clone();\r\n\r\n\t\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\tif (!this.gltfLoader) {\r\n\r\n\t\t\t\t\t\t\tthrow new Error(`GLTFLoader not set.`);\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tthis.gltfLoader.setPath('');\r\n\t\t\t\t\t\tthis.gltfLoader.load(controllerModel.motionController.assetUrl, (asset) => {\r\n\r\n\t\t\t\t\t\t\tthis._assetCache[controllerModel.motionController.assetUrl] = asset;\r\n\r\n\t\t\t\t\t\t\tscene = asset.scene.clone();\r\n\r\n\t\t\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tnull,\r\n\t\t\t\t\t\t\t() => {\r\n\r\n\t\t\t\t\t\t\t\tthrow new Error(`Asset ${controllerModel.motionController.assetUrl} missing or malformed.`);\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}).catch((err) => {\r\n\r\n\t\t\t\t\tconsole.warn(err);\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t});\r\n\r\n\t\t\tcontroller.addEventListener('disconnected', () => {\r\n\r\n\t\t\t\tcontrollerModel.motionController = null;\r\n\t\t\t\tcontrollerModel.remove(scene);\r\n\t\t\t\tscene = null;\r\n\r\n\t\t\t});\r\n\r\n\t\t\treturn controllerModel;\r\n\r\n\t\t}\r\n\r\n\t};\r\n\r\n\treturn XRControllerModelFactory;\r\n\r\n})();\r\n\r\nexport { XRControllerModelFactory };\r\n\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { ReplaySubject } from 'rxjs';\r\nimport { auditTime, filter, shareReplay, takeUntil, tap } from 'rxjs/operators';\r\nimport { MessageType } from '../agora/agora.types';\r\nimport { DEBUG } from '../environment';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport MessageService from '../message/message.service';\r\nimport { Rect } from '../rect/rect';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\nimport { PanoramaGridView } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport AvatarElement from './avatar/avatar-element';\r\nimport Camera from './camera/camera';\r\n// import DebugService from './debug.service';\r\nimport Interactive from './interactive/interactive';\r\nimport MediaMesh from './media/media-mesh';\r\nimport OrbitService, { OrbitMoveEvent } from './orbit/orbit';\r\nimport Panorama from './panorama/panorama';\r\nimport PhoneElement from './phone/phone.element';\r\nimport PointerElement from './pointer/pointer.element';\r\nimport VRService from './vr.service';\r\nimport { Gamepad } from './webxr/gamepad';\r\nimport { XRControllerModelFactory } from './webxr/xr-controller-model-factory';\r\n\r\nconst ORIGIN = new THREE.Vector3();\r\nconst USE_SHADOW = false;\r\nconst USE_PHONE = true;\r\n\r\nexport default class WorldComponent extends Component {\r\n\r\n\tget error() {\r\n\t\treturn this.error_;\r\n\t}\r\n\tset error(error) {\r\n\t\tif (this.error_ !== error) {\r\n\t\t\tthis.error_ = error;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\tget view() {\r\n\t\treturn this.view_;\r\n\t}\r\n\tset view(view) {\r\n\t\tif (this.view_ !== view) {\r\n\t\t\tthis.view_ = view;\r\n\t\t\tthis.setView();\r\n\t\t}\r\n\t}\r\n\tget debugging() {\r\n\t\t// return STATIC || DEBUG;\r\n\t\treturn DEBUG;\r\n\t}\r\n\tget locked() {\r\n\t\treturn this.state.locked || this.state.spying;\r\n\t}\r\n\tget lockedOrXR() {\r\n\t\treturn this.locked || this.renderer.xr.isPresenting;\r\n\t}\r\n\r\n\tget showPointer() {\r\n\t\treturn this.pointer.mesh.parent != null;\r\n\t}\r\n\tset showPointer(showPointer) {\r\n\t\tif (this.showPointer !== showPointer) {\r\n\t\t\tshowPointer ? this.scene.add(this.pointer.mesh) : this.scene.remove(this.pointer.mesh);\r\n\t\t\t// console.log('showPointer', showPointer);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('WorldComponent.onInit');\r\n\t\tthis.index = 0;\r\n\t\tthis.error_ = null;\r\n\t\tthis.loading = null;\r\n\t\tthis.waiting = null;\r\n\t\tthis.avatars = {};\r\n\t\tthis.createScene();\r\n\t\tthis.setView();\r\n\t\tthis.addListeners();\r\n\t\tthis.animate(); // !!!\r\n\t\tKeyboardService.keys$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(keys => {\r\n\t\t\tthis.keys = keys;\r\n\t\t\t// console.log(keys);\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tif (this.view) {\r\n\t\t\tconst selected = this.view.items.find(item => item.selected);\r\n\t\t\tif (selected && selected.mesh) {\r\n\t\t\t\tif (this.view.type.name !== 'model') {\r\n\t\t\t\t\tthis.orbit.lookAt(selected.mesh);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(() => { });\r\n\t}\r\n\r\n\tcreateScene() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.size = { left: 0, top: 0, width: 0, height: 0, aspect: 0 };\r\n\t\tthis.mouse = new THREE.Vector2();\r\n\t\tthis.controllerMatrix_ = new THREE.Matrix4();\r\n\t\tthis.controllerWorldPosition_ = new THREE.Vector3();\r\n\t\tthis.controllerWorldDirection_ = new THREE.Vector3();\r\n\r\n\t\tconst container = this.container = node;\r\n\t\tconst info = this.info = node.querySelector('.world__info');\r\n\r\n\t\tconst worldRect = this.worldRect = Rect.fromNode(container);\r\n\t\tconst cameraRect = this.cameraRect = new Rect();\r\n\r\n\t\t// !!! eliminabile?\r\n\t\tconst cameraGroup = this.cameraGroup = new THREE.Group();\r\n\t\t// new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, ROOM_RADIUS * 2);\r\n\t\t// const camera = this.camera = new THREE.PerspectiveCamera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\tconst camera = this.camera = new Camera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\t/*\r\n\t\tcamera.position.set(0, 20, 20);\r\n\t\tcamera.lookAt(camera.target);\r\n\t\t*/\r\n\t\tcameraGroup.add(camera);\r\n\t\tcameraGroup.target = new THREE.Vector3();\r\n\r\n\t\tconst orbit = this.orbit = new OrbitService(camera);\r\n\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: true,\r\n\t\t\talpha: false,\r\n\t\t\tpremultipliedAlpha: true,\r\n\t\t\tlogarithmicDepthBuffer: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(container.offsetWidth, container.offsetHeight);\r\n\t\trenderer.xr.enabled = true;\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = 0.8;\r\n\t\trenderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\tif (USE_SHADOW) {\r\n\t\t\trenderer.shadowMap.enabled = true;\r\n\t\t\trenderer.shadowMap.type = THREE.PCFShadowMap; // THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap\r\n\t\t}\r\n\t\tif (container.childElementCount > 0) {\r\n\t\t\tcontainer.insertBefore(renderer.domElement, container.children[0]);\r\n\t\t} else {\r\n\t\t\tcontainer.appendChild(renderer.domElement);\r\n\t\t}\r\n\r\n\t\tconst raycaster = this.raycaster = new THREE.Raycaster();\r\n\t\traycaster.setFromCamera(this.mouse, camera);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\t\tscene.add(cameraGroup);\r\n\r\n\t\tconst objects = this.objects = new THREE.Group();\r\n\t\tobjects.name = '[objects]';\r\n\t\tscene.add(objects);\r\n\r\n\t\tconst panorama = this.panorama = new Panorama();\r\n\t\tobjects.add(panorama.mesh);\r\n\r\n\t\tconst indicator = this.indicator = new PointerElement();\r\n\r\n\t\tconst pointer = this.pointer = new PointerElement('#ff4332');\r\n\r\n\t\tconst mainLight = new THREE.PointLight(0xffffff);\r\n\t\tmainLight.position.set(-50, 0, -50);\r\n\t\tobjects.add(mainLight);\r\n\r\n\t\tconst light2 = new THREE.DirectionalLight(0xffe699, 5);\r\n\t\tlight2.position.set(5, -5, 5);\r\n\t\tlight2.target.position.set(0, 0, 0);\r\n\t\tobjects.add(light2);\r\n\r\n\t\tconst light = new THREE.AmbientLight(0x101010);\r\n\t\tobjects.add(light);\r\n\r\n\t\tthis.addControllers();\r\n\t\t//\r\n\t\tthis.resize();\r\n\t\t//\r\n\t\t// console.log('WorldComponent.createScene');\r\n\t}\r\n\r\n\taddOffCanvasScene(message) {\r\n\t\tconst avatar = new AvatarElement(message);\r\n\t\tthis.avatars[message.clientId] = avatar;\r\n\t\t// avatar.container.appendChild(avatar.element);\r\n\t}\r\n\r\n\tremoveOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\t/*\r\n\t\tif (avatar && avatar.element.parentNode) {\r\n\t\t\tavatar.element.parentNode.removeChild(avatar.element);\r\n\t\t}\r\n\t\t*/\r\n\t\tdelete this.avatars[message.clientId];\r\n\t}\r\n\r\n\tupdateOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\tif (avatar) {\r\n\t\t\tavatar.update(message);\r\n\t\t}\r\n\t}\r\n\r\n\tsetView() {\r\n\t\tif (!this.panorama) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst view = this.view_;\r\n\t\tif (view) {\r\n\t\t\tif (this.views) {\r\n\t\t\t\tthis.views.forEach(view => delete view.onUpdateAsset);\r\n\t\t\t}\r\n\t\t\tconst message = this.requestInfoResult;\r\n\t\t\tif (message) {\r\n\t\t\t\tif (view instanceof PanoramaGridView && message.gridIndex !== undefined) {\r\n\t\t\t\t\tview.index_ = message.gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tview.ready = false;\r\n\t\t\t// this.loading = LOADING_BANNER;\r\n\t\t\t// this.waiting = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tthis.panorama.change(view, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\tview.ready = true;\r\n\t\t\t\tview.onUpdateAsset = () => {\r\n\t\t\t\t\tthis.onViewAssetDidChange();\r\n\t\t\t\t};\r\n\t\t\t\t// this.waiting = (view && view.type.name === 'waiting-room') ? WAITING_BANNER : null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\t// this.render();\r\n\t\t\t}, (view) => {\r\n\t\t\t\tthis.setViewOrientation(view);\r\n\t\t\t\t// this.loading = null;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonViewAssetDidChange() {\r\n\t\tif (this.panorama) {\r\n\t\t\tthis.panorama.crossfade(this.view, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tsetViewOrientation(view) {\r\n\t\tconst message = this.requestInfoResult;\r\n\t\tthis.requestInfoResult = null;\r\n\t\tif (this.orbit) {\r\n\t\t\tthis.orbit.mode = view.type.name;\r\n\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\tif (message) {\r\n\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t} else if (!view.keepOrientation) {\r\n\t\t\t\t\tthis.orbit.setOrientation(view.orientation);\r\n\t\t\t\t\tthis.orbit.zoom = view.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddControllers() {\r\n\t\tconst controllerGroup = this.controllerGroup = new THREE.Group();\r\n\t\tthis.controllers = [];\r\n\t\tthis.controllerModelFactory = new XRControllerModelFactory();\r\n\t\tthis.addController(0);\r\n\t\tthis.addController(1);\r\n\t\tthis.cameraGroup.add(controllerGroup);\r\n\t}\r\n\r\n\taddController(index) {\r\n\t\tconst showPhone = USE_PHONE && StateService.state.live;\r\n\t\tconst renderer = this.renderer;\r\n\t\tconst controllerGroup = this.controllerGroup;\r\n\t\tconst controller = renderer.xr.getController(index);\r\n\t\tconst controllerModelFactory = this.controllerModelFactory;\r\n\t\tcontroller.name = `[controller${index + 1}]`;\r\n\t\tcontrollerGroup.add(controller);\r\n\t\tconst setController = (controller) => {\r\n\t\t\t// console.log('setController', this);\r\n\t\t\tthis.controller = controller;\r\n\t\t}\r\n\t\tconst onSelectStart = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = true;\r\n\t\t\tsetController(controller);\r\n\t\t};\r\n\t\tconst onSelectEnd = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = false;\r\n\t\t};\r\n\t\t// const debugService = DebugService.getService();\r\n\t\t// debugService.setMessage('DebugService 1001');\r\n\t\tconst onPress = (event) => {\r\n\t\t\t// console.log('Gamepad.onPress', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onPress ' + event.index);\r\n\t\t\t// 0: select\r\n\t\t\t// 1: squeeze\r\n\t\t\t// 4: x / a\r\n\t\t\t// 5: y / b\r\n\t\t\tswitch(event.index) {\r\n\t\t\t\tcase 0:\r\n\t\t\t\t\t// select\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 1:\r\n\t\t\t\t\t// squeeze\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 4:\r\n\t\t\t\t\t// x / a\r\n\t\t\t\t\tMessageService.send({\r\n\t\t\t\t\t\ttype: MessageType.MenuToggle,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst onRelease = (event) => {\r\n\t\t\tthis.onModelUp();\r\n\t\t};\r\n\t\tconst onLeft = (event) => {\r\n\t\t\t// console.log('Gamepad.onLeft', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onLeft');\r\n\t\t\tthis.cameraGroup.rotation.y += Math.PI / 180 * 45;\r\n\t\t};\r\n\t\tconst onRight = (event) => {\r\n\t\t\t// console.log('Gamepad.onRight', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onRight');\r\n\t\t\tthis.cameraGroup.rotation.y -= Math.PI / 180 * 45;\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// console.log('Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.cameraGroup.rotation.y += (Math.PI / 180 * event.x);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// console.log('Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.onModelDistance(event.y);\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\t// console.log('Gamepad.onUp', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onUp');\r\n\t\t\tthis.cameraGroup.position.y += 1;\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\t// console.log('Gamepad.onDown', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onDown');\r\n\t\t\tthis.cameraGroup.position.y -= 1;\r\n\t\t};\r\n\t\t*/\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\tthis.onModelDistance(1);\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\tthis.onModelDistance(-1);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onConnected = (event) => {\r\n\t\t\tcontroller.add(this.buildController(event.data));\r\n\t\t\tif (showPhone && event.data.handedness === 'left') {\r\n\t\t\t\tconst phone = this.phone = new PhoneElement();\r\n\t\t\t\tcontroller.add(phone.mesh);\r\n\t\t\t}\r\n\t\t\tif (!showPhone || event.data.handedness === 'right') {\r\n\t\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\t\tcontrollerGrip.name = `[controller-grip${index + 1}]`;\r\n\t\t\t\tcontrollerGrip.add(controllerModelFactory.createControllerModel(controllerGrip));\r\n\t\t\t\tcontrollerGroup.add(controllerGrip);\r\n\t\t\t}\r\n\t\t\tconst gamepad = new Gamepad(event.data.gamepad);\r\n\t\t\tgamepad.on('press', onPress);\r\n\t\t\tgamepad.on('release', onRelease);\r\n\t\t\tgamepad.on('left', onLeft);\r\n\t\t\tgamepad.on('right', onRight);\r\n\t\t\tgamepad.on('axis', onAxis);\r\n\t\t\t// gamepad.on('up', onUp);\r\n\t\t\t// gamepad.on('down', onDown);\r\n\t\t\tcontroller.userData.gamepad = gamepad;\r\n\t\t}\r\n\t\tconst onDisconnected = (event) => {\r\n\t\t\twhile (controller.children.length) {\r\n\t\t\t\tcontroller.remove(controller.children[0]);\r\n\t\t\t}\r\n\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\twhile (controllerGrip.children.length) {\r\n\t\t\t\tcontrollerGrip.remove(controllerGrip.children[0]);\r\n\t\t\t}\r\n\t\t\tcontrollerGroup.remove(controllerGrip);\r\n\t\t\tconst gamepad = controller.userData.gamepad;\r\n\t\t\tgamepad.off('press', onPress);\r\n\t\t\tgamepad.off('release', onRelease);\r\n\t\t\tgamepad.off('left', onLeft);\r\n\t\t\tgamepad.off('right', onRight);\r\n\t\t\tgamepad.off('axis', onAxis);\r\n\t\t\t// gamepad.off('up', onUp);\r\n\t\t\t// gamepad.off('down', onDown);\r\n\t\t}\r\n\t\tcontroller.addEventListener('selectstart', onSelectStart);\r\n\t\tcontroller.addEventListener('selectend', onSelectEnd);\r\n\t\tcontroller.addEventListener('connected', onConnected);\r\n\t\tcontroller.addEventListener('disconnected', onDisconnected);\r\n\t\tconst controllers = this.controllers;\r\n\t\tcontrollers.push(controller);\r\n\t}\r\n\r\n\tbuildController(data) {\r\n\t\tconsole.log('buildController', data);\r\n\t\tlet geometry, material;\r\n\t\tswitch (data.targetRayMode) {\r\n\t\t\tcase 'tracked-pointer':\r\n\t\t\t\tgeometry = new THREE.BufferGeometry();\r\n\t\t\t\tgeometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 0, 0, 0, -1], 3));\r\n\t\t\t\tgeometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));\r\n\t\t\t\tmaterial = new THREE.LineBasicMaterial({\r\n\t\t\t\t\tvertexColors: true,\r\n\t\t\t\t\tblending: THREE.AdditiveBlending\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Line(geometry, material);\r\n\t\t\tcase 'gaze':\r\n\t\t\t\tgeometry = new THREE.RingBufferGeometry(0.02, 0.04, 32).translate(0, 0, -1);\r\n\t\t\t\tmaterial = new THREE.MeshBasicMaterial({\r\n\t\t\t\t\topacity: 0.5,\r\n\t\t\t\t\ttransparent: true\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Mesh(geometry, material);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelDown(event) {\r\n\t\t// vr controller model grab\r\n\t\tconst controller = this.controller;\r\n\t\tif (controller && this.renderer.xr.isPresenting) {\r\n\t\t\tconst target = this.tempTarget = event.mesh;\r\n\t\t\t// console.log('WorldComponent.onModelDown', target);\r\n\t\t\t// DebugService.getService().setMessage('onModelDown ', target.name);\r\n\t\t\tconst parent = this.tempParent = target.parent;\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tcontroller.worldToLocal(position);\r\n\t\t\tcontroller.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelDistance(direction) {\r\n\t\t// vr controller model distance\r\n\t\tconst controller = this.controller;\r\n\t\tconst target = this.tempTarget;\r\n\t\tif (controller && target && this.renderer.xr.isPresenting) {\r\n\t\t\tlet position = new THREE.Vector3();\r\n\t\t\tposition = position.copy(target.position);\r\n\t\t\tconst distance = Math.max(1, Math.min(8, position.distanceTo(ORIGIN) + 0.02 * direction));\r\n\t\t\tposition.normalize();\r\n\t\t\tposition = position.multiplyScalar(distance);\r\n\t\t\t// DebugService.getService().setMessage('onModelDistance ' + distance);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelUp() {\r\n\t\t// vr controller model release\r\n\t\tconst target = this.tempTarget;\r\n\t\tconst parent = this.tempParent;\r\n\t\tif (target && parent) {\r\n\t\t\t// console.log('WorldComponent.onModelUp', target, parent);\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tparent.worldToLocal(position);\r\n\t\t\tparent.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t\tthis.tempTarget = null;\r\n\t\t\tthis.tempParent = null;\r\n\t\t}\r\n\t}\r\n\r\n\tonTween() {\r\n\t\t// this.render();\r\n\t}\r\n\r\n\tupdateRaycasterXR(controller, raycaster) {\r\n\t\tif (controller) {\r\n\t\t\tthis.controllerMatrix_.identity().extractRotation(controller.matrixWorld);\r\n\t\t\traycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);\r\n\t\t\traycaster.ray.direction.set(0, 0, -1).applyMatrix4(this.controllerMatrix_);\r\n\t\t\t// raycaster.camera = this.host.renderer.xr.getCamera(this.camera);\r\n\t\t\treturn raycaster;\r\n\t\t}\r\n\t}\r\n\r\n\traycasterHitTest() {\r\n\t\ttry {\r\n\t\t\tif (this.renderer.xr.isPresenting) {\r\n\t\t\t\tconst raycaster = this.updateRaycasterXR(this.controller, this.raycaster);\r\n\t\t\t\tif (raycaster) {\r\n\t\t\t\t\tconst hit = Interactive.hittest(raycaster, this.controller.userData.isSelecting);\r\n\t\t\t\t\tthis.indicator.update();\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t\t// controllers.feedback();\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t} else if (!this.dragItem && !this.resizeItem) {\r\n\t\t\t\treturn; // !!!\r\n\t\t\t\tconst raycaster = this.raycaster;\r\n\t\t\t\tif (raycaster) {\r\n\t\t\t\t\tconst hit = Interactive.hittest(raycaster);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t\t// console.log('hit', hit);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\trepos(object, rect) {\r\n\t\tconst worldRect = this.worldRect;\r\n\t\tconst sx = 0.8;\r\n\t\t// const sx = rect.width / worldRect.width;\r\n\t\t// const sy = rect.height / worldRect.height;\r\n\t\tobject.scale.set(sx, sx, sx);\r\n\t\t// const tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect; // * cameraRect.width / worldRect.width - cameraRect.width / 2;\r\n\t\t// const ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect; // * cameraRect.height / worldRect.height - cameraRect.height / 2;\r\n\t\tconst tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect;\r\n\t\tconst ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect;\r\n\t\t// console.log(tx);\r\n\t\t// const position = new THREE.Vector3(tx, ty, 0).unproject(this.camera);\r\n\t\tobject.position.set(tx, -ty, 0);\r\n\t\t// console.log(tx, -ty, 0);\r\n\t}\r\n\r\n\trender(delta) {\r\n\t\ttry {\r\n\t\t\tconst renderer = this.renderer,\r\n\t\t\t\tscene = this.scene,\r\n\t\t\t\tcamera = this.camera;\r\n\t\t\tconst time = performance.now();\r\n\t\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t\tthis.raycasterXRHitTest();\r\n\t\t\tthis.scene.traverse((child) => {\r\n\t\t\t\tif (typeof child.userData.render === 'function') {\r\n\t\t\t\t\tchild.userData.render(time, tick);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.vrService.updateState(this);\r\n\t\t\tObject.keys(this.avatars).forEach(key => {\r\n\t\t\t\tthis.avatars[key].render();\r\n\t\t\t});\r\n\t\t\tif (renderer.xr.isPresenting) {\r\n\t\t\t\tgsap.ticker.tick();\r\n\t\t\t\tthis.controllers.forEach(controller => {\r\n\t\t\t\t\tcontroller.userData.gamepad.update();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t/*\r\n\t\t\tconst objects = this.objects;\r\n\t\t\tfor (let i = 0; i < objects.children.length; i++) {\r\n\t\t\t\tconst x = objects.children[i];\r\n\t\t\t\tif (typeof x.userData.render === 'function') {\r\n\t\t\t\t\tx.userData.render(time, tick);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\trenderer.render(this.scene, this.camera);\r\n\t\t\tif (this.state && !this.state.hosted) {\r\n\t\t\t\tthis.orbit.render();\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tanimate() {\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(this.render);\r\n\t}\r\n\r\n\tresize() {\r\n\t\ttry {\r\n\t\t\tconst container = this.container,\r\n\t\t\t\trenderer = this.renderer,\r\n\t\t\t\tcamera = this.camera;\r\n\t\t\tconst size = this.size;\r\n\t\t\tconst rect = container.getBoundingClientRect();\r\n\t\t\tsize.left = Math.floor(rect.left);\r\n\t\t\tsize.top = Math.floor(rect.top);\r\n\t\t\tsize.width = Math.ceil(rect.width);\r\n\t\t\tsize.height = Math.ceil(rect.height);\r\n\t\t\tsize.aspect = size.width / size.height;\r\n\t\t\tconst worldRect = this.worldRect;\r\n\t\t\tworldRect.setSize(size.width, size.height);\r\n\t\t\tif (!renderer.xr.isPresenting) {\r\n\t\t\t\trenderer.setSize(size.width, size.height);\r\n\t\t\t\tif (camera) {\r\n\t\t\t\t\tcamera.aspect = size.width / size.height;\r\n\t\t\t\t\tconst angle = camera.fov * Math.PI / 180;\r\n\t\t\t\t\tconst height = Math.abs(camera.position.z * Math.tan(angle / 2) * 2);\r\n\t\t\t\t\tconst cameraRect = this.cameraRect;\r\n\t\t\t\t\tcameraRect.width = height * camera.aspect;\r\n\t\t\t\t\tcameraRect.height = height;\r\n\t\t\t\t\t// console.log('position', camera.position.z, 'angle', angle, 'height', height, 'aspect', camera.aspect, cameraRect);\r\n\t\t\t\t\tcamera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// this.render();\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateRaycasterMouse(event) {\r\n\t\tconst w2 = this.size.width / 2;\r\n\t\tconst h2 = this.size.height / 2;\r\n\t\tthis.mouse.x = (event.clientX - this.size.left - w2) / w2;\r\n\t\tthis.mouse.y = -(event.clientY - this.size.top - h2) / h2;\r\n\t\tconst raycaster = this.raycaster;\r\n\t\traycaster.setFromCamera(this.mouse, this.camera);\r\n\t\treturn raycaster;\r\n\t}\r\n\r\n\tonMouseDown(event) {\r\n\t\ttry {\r\n\t\t\tif (event.button !== 0) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, true);\r\n\t\t\tif (this.editor || DEBUG) {\r\n\t\t\t\tif (this.keys.Shift || this.keys.Control) {\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.select.next({ item: null });\r\n\t\t\t\t\tif (this.panorama.mesh.intersection) {\r\n\t\t\t\t\t\tconst position = new THREE.Vector3().copy(this.panorama.mesh.intersection.point).normalize();\r\n\t\t\t\t\t\tconsole.log(JSON.stringify({ position: position.toArray() }));\r\n\t\t\t\t\t\tthis.viewHit.next(position);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\traycasterXRHitTest() {\r\n\t\tif (this.renderer.xr.isPresenting) {\r\n\t\t\tconst raycaster = this.updateRaycasterXR(this.controller, this.raycaster);\r\n\t\t\tif (raycaster) {\r\n\t\t\t\tconst hit = Interactive.hittest(raycaster, this.controller.userData.isSelecting);\r\n\t\t\t\tthis.indicator.update();\r\n\t\t\t\t/*\r\n\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t// controllers.feedback();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\traycasterDesktopHitTest(event) {\r\n\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.dragItem) {\r\n\t\t\tif (typeof this.dragItem.onDragMove === 'function') {\r\n\t\t\t\tconst intersections = raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst position = new THREE.Vector3().copy(intersection.point).normalize();\r\n\t\t\t\t\tthis.dragItem.onDragMove(position);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (this.resizeItem) {\r\n\t\t\tif (typeof this.resizeItem.onResizeMove === 'function') {\r\n\t\t\t\t/*\r\n\t\t\t\t// calc arc x & y as scale;\r\n\t\t\t\tconst intersections = raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst position = new THREE.Vector3().copy(intersection.point).normalize();\r\n\t\t\t\t\tthis.resizeItem.onResizeMove(position);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst hit = Interactive.hittest(raycaster);\r\n\t\t\t/*\r\n\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t// console.log('hit', hit);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.controlEvent$.next(this.control);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseMove(event) {\r\n\t\ttry {\r\n\t\t\tthis.raycasterDesktopHitTest(event);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseUp(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (this.dragItem) {\r\n\t\t\t\tif (typeof this.dragItem.onDragEnd === 'function') {\r\n\t\t\t\t\tthis.dragItem.onDragEnd();\r\n\t\t\t\t\tthis.dragEnd.next(this.dragItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.dragItem = null;\r\n\t\t\tif (this.resizeItem) {\r\n\t\t\t\tif (typeof this.resizeItem.onResizeEnd === 'function') {\r\n\t\t\t\t\tthis.resizeItem.onResizeEnd();\r\n\t\t\t\t\tthis.resizeEnd.next(this.resizeItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.resizeItem = null;\r\n\t\t\t/*\r\n\t\t\tif (NavPointDragging) {\r\n\t\t\t\tstopDragging\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, false);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseWheel(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst deltaY = event.deltaY * (event.wheelDeltaY !== undefined ? 1 : 37);\r\n\t\t\tconst orbit = this.orbit;\r\n\t\t\tgsap.to(orbit, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tzoom: orbit.zoom + deltaY * 0.1,\r\n\t\t\t\tease: Power4.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t});\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonOrientationDidChange() {\r\n\t\tthis.controlEvent$.next(this.control);\r\n\t}\r\n\r\n\tonVRStarted() {\r\n\t\t// this.objects.rotation.y = - Math.PI / 2;\r\n\t\tthis.objects.position.y = 1.3;\r\n\t\tthis.scene.add(this.indicator.mesh);\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRStarted,\r\n\t\t});\r\n\t}\r\n\r\n\tonVREnded() {\r\n\t\t// this.objects.rotation.y = 0;\r\n\t\tthis.objects.position.y = 0;\r\n\t\tthis.cameraGroup.rotation.y = 0;\r\n\t\tthis.cameraGroup.position.y = 0;\r\n\t\tthis.scene.remove(this.indicator.mesh);\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VREnded,\r\n\t\t});\r\n\t}\r\n\r\n\tonVRStateDidChange(state) {\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRState,\r\n\t\t\tcamera: state.camera.array,\r\n\t\t});\r\n\t}\r\n\r\n\tonMenuNav(event) {\r\n\t\t// console.log('WorldComponent.onMenuNav', event.id, event);\r\n\t\tthis.menu = undefined;\r\n\t\tthis.navTo.next({ viewId: event.id });\r\n\t}\r\n\r\n\tonMenuToggle(event) {\r\n\t\t// console.log('WorldComponent.onMenuToggle', event.id, event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.menu = event;\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavOver(nav) {\r\n\t\t// console.log('WorldComponent.onNavOver', nav);\r\n\t\tif (this.menu) {\r\n\t\t\treturn;\r\n\t\t\t// this.menu.removeMenu();\r\n\t\t}\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tnav.item.showPanel = nav.shouldShowPanel();\r\n\t\tthis.pushChanges();\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.ShowPanel,\r\n\t\t\titemId: nav.item.showPanel ? nav.item.id : null,\r\n\t\t});\r\n\t}\r\n\r\n\tonNavOut(nav) {\r\n\t\t// console.log('WorldComponent.onNavOut', nav);\r\n\t\t// nav.item.showPanel = false;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavDown(event) {\r\n\t\tevent.item.showPanel = false;\r\n\t\t// console.log('WorldComponent.onNavDown', this.keys);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else {\r\n\t\t\tthis.navTo.next(event.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonObjectDown(event) {\r\n\t\t// console.log('WorldComponent.onObjectDown', this.keys);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t}\r\n\t}\r\n\r\n\tonPlayMedia(event) {\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.PlayMedia,\r\n\t\t\titemId: event.itemId,\r\n\t\t\tplaying: event.playing,\r\n\t\t});\r\n\t}\r\n\r\n\tonPanelDown(event) {\r\n\t\t// console.log('WorldComponent.onPanelDown', href, target);\r\n\t\tconst href = event.getAttribute('href');\r\n\t\tconst target = event.getAttribute('target') || '_self';\r\n\t\tif (href) {\r\n\t\t\twindow.open(href, '_blank');\r\n\t\t}\r\n\t}\r\n\r\n\tonGridMove(event) {\r\n\t\t// console.log('WorldComponent.onGridMove', event, this.view);\r\n\t\tthis.view.items = [];\r\n\t\t// this.loading = LOADING_BANNER;\r\n\t\tthis.pushChanges();\r\n\t\tthis.orbit.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\tconst tile = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\tif (tile) {\r\n\t\t\t\tthis.panorama.crossfade(tile, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\t\tthis.orbit.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t// this.loading = null;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t// this.render();\r\n\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonGridNav(event) {\r\n\t\t// console.log('WorldComponent.onGridNav', event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.NavToGrid,\r\n\t\t\tviewId: this.view.id,\r\n\t\t\tgridIndex: event,\r\n\t\t});\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tcontrol$() {\r\n\t\treturn this.controlEvent$.pipe(\r\n\t\t\tfilter(() => StateService.state.control || StateService.state.spyed || this.editor),\r\n\t\t\tauditTime(40),\r\n\t\t\ttap((control) => {\r\n\t\t\t\tcontrol.orientation.latitude = this.orbit.latitude;\r\n\t\t\t\tcontrol.orientation.longitude = this.orbit.longitude;\r\n\t\t\t\tcontrol.zoom = this.orbit.zoom;\r\n\t\t\t\tconst intersections = this.raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tconst point = intersections.length ? intersections[0].point.normalize() : null;\r\n\t\t\t\tif (point) {\r\n\t\t\t\t\tcontrol.pointer[0] = point.x;\r\n\t\t\t\t\tcontrol.pointer[1] = point.y;\r\n\t\t\t\t\tcontrol.pointer[2] = point.z;\r\n\t\t\t\t}\r\n\t\t\t\tMessageService.send(control);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.control = {\r\n\t\t\ttype: MessageType.ControlInfo,\r\n\t\t\torientation: { latitude: 0, longitude: 0 },\r\n\t\t\tzoom: 1,\r\n\t\t\tpointer: [0, 0, 0],\r\n\t\t};\r\n\t\tthis.controlEvent$ = new ReplaySubject(1);\r\n\t\tthis.control$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tthis.renderer.xr.setSession(session);\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.onVRStarted();\r\n\t\t\t} else {\r\n\t\t\t\tthis.onVREnded();\r\n\t\t\t}\r\n\t\t});\r\n\t\tvrService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t).subscribe((state) => {\r\n\t\t\tthis.onVRStateDidChange(state);\r\n\t\t});\r\n\t\tconst orbit$ = this.orbit.observe$(this.container).pipe(\r\n\t\t\tshareReplay(1)\r\n\t\t);\r\n\t\t/*\r\n\t\tconst drag$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitDragEvent),\r\n\t\t);\r\n\t\t*/\r\n\t\tconst orientation$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitMoveEvent),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t);\r\n\t\torientation$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.render();\r\n\t\t\tthis.onOrientationDidChange();\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.RequestInfo:\r\n\t\t\t\t\tmessage.type = MessageType.RequestInfoResult;\r\n\t\t\t\t\tmessage.viewId = this.view.id;\r\n\t\t\t\t\tmessage.orientation = this.orbit.getOrientation();\r\n\t\t\t\t\tmessage.zoom = this.orbit.zoom;\r\n\t\t\t\t\tif (this.view instanceof PanoramaGridView) {\r\n\t\t\t\t\t\tmessage.gridIndex = this.view.index;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfo', 'from', message.clientId, 'to', StateService.state.uid, message.orientation);\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tif (StateService.state.role !== RoleType.Publisher) {\r\n\t\t\t\t\t\tStateService.patchState({ spyed: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfoResult', 'from', message.clientId, 'to', StateService.state.uid, message.orientation);\r\n\t\t\t\t\tif (ViewService.viewId !== message.viewId) {\r\n\t\t\t\t\t\tViewService.viewId = message.viewId;\r\n\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.view instanceof PanoramaGridView && message.gridIndex) {\r\n\t\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (!this.view || !this.view.ready) {\r\n\t\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (this.view && this.view.id === message.viewId) {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.view instanceof PanoramaGridView && message.gridIndex) {\r\n\t\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfoResult', message, StateService.state);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t// !!! old control accepted message\r\n\t\t\t\t/*\r\n\t\t\t\tcase MessageType.RequestControlAccepted:\r\n\t\t\t\t\tmessage = {\r\n\t\t\t\t\t\ttype: MessageType.NavToView,\r\n\t\t\t\t\t\tviewId: this.view.id,\r\n\t\t\t\t\t};\r\n\t\t\t\t\tif (this.view instanceof PanoramaGridView) {\r\n\t\t\t\t\t\tmessage.gridIndex = this.view.index;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tMessageService.send(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t*/\r\n\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tif (this.menu) {\r\n\t\t\t\t\t\tthis.menu.removeMenu();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.view.items.forEach(item => item.showPanel = (item.id === message.itemId));\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.PlayMedia:\r\n\t\t\t\t\tconst item = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (item && item.mesh instanceof MediaMesh) {\r\n\t\t\t\t\t\titem.mesh.setPlayingState(message.playing);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\t// console.log('WorldComponent.NavToGrid', this.view.id, message);\r\n\t\t\t\t\tif (this.view.id === message.viewId) {\r\n\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\tthis.addOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\tthis.removeOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRState:\r\n\t\t\t\t\tthis.updateOffCanvasScene(message);\r\n\t\t\t\t\tif (StateService.state.spying === message.clientId) {\r\n\t\t\t\t\t\tthis.orbit.setVRCamera(message.camera);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t// this.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t// this.render();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.pointer.setPosition(message.pointer[0], message.pointer[1], message.pointer[2]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.showPointer = (StateService.state.locked || StateService.state.spying);\r\n\t\t\t// console.log(state);\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t\tthis.resize = this.resize.bind(this);\r\n\t\tthis.render = this.render.bind(this);\r\n\t\tthis.onMouseDown = this.onMouseDown.bind(this);\r\n\t\tthis.onMouseMove = this.onMouseMove.bind(this);\r\n\t\tthis.onMouseUp = this.onMouseUp.bind(this);\r\n\t\tthis.onMouseWheel = this.onMouseWheel.bind(this);\r\n\t\t// this.controls.addEventListener('change', this.render); // use if there is no animation loop\r\n\t\twindow.addEventListener('resize', this.resize, false);\r\n\t\tthis.container.addEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.addEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.addEventListener('mouseup', this.onMouseUp, false);\r\n\t\tdocument.addEventListener('mousemove', this.onMouseMove, false);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\tdocument.removeEventListener('mousemove', this.onMouseMove, false);\r\n\t\tdocument.removeEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.removeEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.removeEventListener('mouseup', this.onMouseUp, false);\r\n\t}\r\n}\r\n\r\nWorldComponent.meta = {\r\n\tselector: '[world]',\r\n\tinputs: ['view', 'views', 'editor'],\r\n\toutputs: ['navTo', 'viewHit', 'dragEnd', 'resizeEnd', 'select'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport Interactive from '../interactive/interactive';\r\n// import Ease from '../ease/ease';\r\nimport WorldComponent from '../world.component';\r\n\r\nconst deg = THREE.Math.degToRad;\r\n\r\nconst GEOMETRY = new THREE.BoxBufferGeometry(1, 1, 1);\r\n// const GEOMETRY = new THREE.IcosahedronBufferGeometry(0.5, 1);\r\n\r\nexport default class ModelComponent extends Component {\r\n\r\n\tset renderOrder(renderOrder) {\r\n\t\tthis.group.renderOrder = renderOrder;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('ModelComponent.onInit');\r\n\t\t// console.log('item', this.item, 'host', this.host);\r\n\t\tif (!this.host) {\r\n\t\t\tthrow ('ModelComponent host is undefined');\r\n\t\t}\r\n\t\tthis.scale = new THREE.Vector3(1.0, 1.0, 1.0);\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\tconst group = this.group = new THREE.Group();\r\n\t\tgroup.name = this.getName();\r\n\t\tgroup.userData.render = (time, tick) => {\r\n\t\t\t// if (this.intersection) {\r\n\t\t\tthis.render(this, time, tick);\r\n\t\t\t// }\r\n\t\t};\r\n\t\tthis.getContainer().add(group);\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item)\r\n\t\t);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tconst group = this.group;\r\n\t\tthis.getContainer().remove(group);\r\n\t\tdelete group.userData.render;\r\n\t\tthis.disposeObject(group);\r\n\t\tthis.group = null;\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.objects;\r\n\t}\r\n\r\n\tgetName(name) {\r\n\t\treturn `${this.constructor.meta.selector}-${this.rxcompId}${name ? `-${name}` : ''}`;\r\n\t}\r\n\r\n\tonCreate(mounth, dismount) {\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tcolor: new THREE.Color('#ffcc00'),\r\n\t\t\troughness: 0.4,\r\n\t\t\tmetalness: 0.01,\r\n\t\t\tflatShading: true,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = new THREE.Mesh(GEOMETRY, material);\r\n\t\tif (typeof mounth === 'function') {\r\n\t\t\tmounth(mesh);\r\n\t\t}\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tonMount(mesh, item) {\r\n\t\tif (this.mesh) {\r\n\t\t\t// console.log('ModelComponent.dismount.mesh');\r\n\t\t\tthis.onDismount(this.mesh);\r\n\t\t}\r\n\t\tmesh.name = this.getName('mesh');\r\n\t\tthis.mesh = mesh;\r\n\t\tif (item) {\r\n\t\t\titem.mesh = mesh;\r\n\t\t\titem.onUpdate = () => {\r\n\t\t\t\tthis.onUpdate(item, mesh);\r\n\t\t\t};\r\n\t\t\titem.onUpdateAsset = () => {\r\n\t\t\t\tthis.onUpdateAsset(item, mesh);\r\n\t\t\t};\r\n\t\t}\r\n\t\tthis.group.add(mesh);\r\n\t\t// this.host.render(); !!!\r\n\t\t/*\r\n\t\tconst node = this.node;\r\n\t\tDomService.scrollIntersection$(node).subscribe(event => {\r\n\t\t\tthis.scroll = event.scroll;\r\n\t\t\tthis.intersection = event.intersection;\r\n\t\t\tthis.calculateScaleAndPosition();\r\n\t\t});\r\n\t\t*/\r\n\t\t// console.log('Model.loaded', mesh);\r\n\t}\r\n\r\n\tonDismount(mesh, item) {\r\n\t\tthis.group.remove(mesh);\r\n\t\tif (typeof mesh.dispose === 'function') {\r\n\t\t\tmesh.dispose();\r\n\t\t}\r\n\t\tthis.disposeObject(mesh);\r\n\t\tthis.mesh = null;\r\n\t\tif (item) {\r\n\t\t\tdelete item.mesh;\r\n\t\t\tdelete item.onUpdate;\r\n\t\t\tdelete item.onUpdateAsset;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeObject(object) {\r\n\t\tobject.traverse(child => {\r\n\t\t\tif (child.isInteractiveMesh || child.isInteractiveSprite) {\r\n\t\t\t\tInteractive.dispose(child);\r\n\t\t\t}\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t\tchild.geometry.dispose();\r\n\t\t\t} else if (child.isSprite) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t}\r\n\t\t});\r\n\t\t// console.log('ModelComponent.disposeObject', object);\r\n\t}\r\n\r\n\tcalculateScaleAndPosition() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.host.repos(this, node.getBoundingClientRect());\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\t/*\r\n\t\tthis.calculateScaleAndPosition();\r\n\t\tconst group = this.group;\r\n\t\tconst scale = this.scale;\r\n\t\t// group.scale.set(scale.x, scale.y, scale.z);\r\n\t\tconst position = this.position;\r\n\t\tgroup.position.set(position.x, 0, 0);\r\n\t\t// const tween = this.tween();\r\n\t\t// group.rotation.x = deg(180) * tween;\r\n\t\t// group.rotation.y = deg(360) * tween;\r\n\t\t*/\r\n\t}\r\n\r\n\tgetScroll(offset) {\r\n\t\tconst scroll = this.intersection.scroll(offset);\r\n\t\t// console.log(scroll);\r\n\t\treturn scroll;\r\n\t}\r\n\r\n\tgetTween(offset) {\r\n\t\tlet tween = Math.min(0.0, this.intersection.offset(offset)) + 1;\r\n\t\ttween = Math.max(0.0, tween);\r\n\t\t// tween = Ease.Sine.InOut(tween);\r\n\t\ttween -= 1;\r\n\t\treturn tween;\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) { }\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) { }\r\n\r\n}\r\n\r\nModelComponent.meta = {\r\n\tselector: '[model]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport { PANORAMA_RADIUS } from '../panorama/panorama';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\nconst ORIGIN = new THREE.Vector3();\r\n\r\nexport default class ModelBannerComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tconst init = this.title_ != null;\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (!init) {\r\n\t\t\t\tthis.createBanner();\r\n\t\t\t} else {\r\n\t\t\t\tthis.updateBanner();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconsole.log('ModelBannerComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\tconsole.log('ModelBannerComponent.onView', this.item);\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\t// this.createBanner();\r\n\t}\r\n\t*/\r\n\r\n\tonChanges() {\r\n\t\t// console.log('ModelBannerComponent.onChanges', this.item);\r\n\t\tthis.title = this.item.title;\r\n\t}\r\n\r\n\tcreateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 24;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(1).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\t// !!!\r\n\t\t\t\t// mesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tupdateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelBannerComponent.updateBanner', result);\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonViewBak() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 3;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 45;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 20, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(4).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\tmesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.2;\r\n\t\t\t\t\ttexture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 128;\r\n\t\t\tconst F = Math.floor(H * 0.8);\r\n\t\t\tconst L = Math.floor(H * 0.075);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.item.title;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tgetCanvasTexture_() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (this.item.bannerTexture) {\r\n\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t} else {\r\n\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\tbackgroundColor: '#00000000', // '#000000ff',\r\n\t\t\t\t\t\tscale: 2,\r\n\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\tthis.item.bannerTexture = {\r\n\t\t\t\t\t\t\ttexture: texture,\r\n\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t}, 1);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t*/\r\n}\r\n\r\nModelBannerComponent.ORIGIN = new THREE.Vector3();\r\n\r\nModelBannerComponent.meta = {\r\n\tselector: '[model-banner]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelEditableComponent extends ModelComponent {\r\n\r\n\tget editing() {\r\n\t\treturn this.editing_;\r\n\t}\r\n\tset editing(editing) {\r\n\t\tif (this.editing_ !== editing) {\r\n\t\t\tthis.editing_ = editing;\r\n\t\t\tthis.setHelper(editing);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.RADIUS = 100;\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.editing = false;\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tsetHelper(showHelper) {\r\n\t\tif (showHelper) {\r\n\t\t\tif (!this.helper) {\r\n\t\t\t\tthis.helper = new THREE.BoxHelper(this.mesh, 0x00ff00);\r\n\t\t\t}\r\n\t\t\tthis.host.scene.add(this.helper);\r\n\t\t} else if (this.helper) {\r\n\t\t\tthis.host.scene.remove(this.helper);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateHelper() {\r\n\t\tif (this.helper) {\r\n\t\t\tthis.helper.setFromObject(this.mesh);\r\n\t\t\t// this.helper.update();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelEditableComponent.meta = {\r\n\tselector: '[model-editable]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelCurvedPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelCurvedPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('ModelCurvedPanel', streamId, item.asset)\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = new MediaMesh(item, items, geometry);\r\n\t\t\t\t\tmesh.name = 'curved-plane';\r\n\t\t\t\t\tif (item.position) {\r\n\t\t\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.rotation) {\r\n\t\t\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.scale) {\r\n\t\t\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\t// console.log('ModelCurvedPanelComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\t// console.log('ModelCurvedPanelComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdate', item);\r\n\t\tif (item.position) {\r\n\t\t\tmesh.position.fromArray(item.position);\r\n\t\t}\r\n\t\tif (item.rotation) {\r\n\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t}\r\n\t\tif (item.scale) {\r\n\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t}\r\n\t\t// !!! deactivated\r\n\t\tif (true && (item.radius !== this.radius_ || item.height !== this.height_ || item.arc !== this.arc_)) {\r\n\t\t\tthis.mesh.geometry.dispose();\r\n\t\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\t\tthis.mesh.geometry = geometry;\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdateAsset', item);\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tthis.mesh.load(() => {\r\n\t\t\t\t// console.log('ModelCurvedPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(20);\r\n\t\tthis.mesh.lookAt(ModelCurvedPlaneComponent.ORIGIN);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tgetCurvedPanelGeometry(item) {\r\n\t\tthis.radius_ = item.radius;\r\n\t\tthis.height_ = item.height;\r\n\t\tthis.arc_ = item.arc;\r\n\t\tconst arc = Math.PI / 180 * item.arc;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(item.radius, item.radius, item.height, 36, 2, true, 0, arc);\r\n\t\tgeometry.rotateY(-Math.PI - arc / 2);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n}\r\n\r\nModelCurvedPlaneComponent.ORIGIN = new THREE.Vector3();\r\nModelCurvedPlaneComponent.textures = {};\r\n\r\nModelCurvedPlaneComponent.meta = {\r\n\tselector: '[model-curved-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item', 'items'],\r\n};\r\n","import { BehaviorSubject } from \"rxjs\";\n\nexport const XRStatus = {\n\tWaiting: 'waiting',\n\tEnabled: 'enabled',\n\tEnded: 'ended',\n\tStarted: 'started',\n\tDisabled: 'disabled',\n\tNeedsHttps: 'needs-https',\n\tUnavailable: 'unavailable',\n};\n\nexport default class DebugService {\n\n\tstatic getService() {\n\t\tif (!this.service_) {\n\t\t\tthis.service_ = new DebugService();\n\t\t}\n\t\treturn this.service_;\n\t}\n\n\tget message() {\n\t\treturn this.message$.getValue();\n\t}\n\n\tconstructor() {\n\t\tif (DebugService.service_) {\n\t\t\tthrow ('DebugService is a singleton class!');\n\t\t}\n\t\tthis.message$ = new BehaviorSubject(null);\n\t}\n\n\tsetMessage(message) {\n\t\tif (this.message !== message) {\n\t\t\tthis.message$.next(message);\n\t\t}\n\t}\n\n}\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport DebugService from '../debug.service';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelDebugComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelDebugComponent.loader || (ModelDebugComponent.loader = new THREE.FontLoader());\r\n\t}\r\n\r\n\tstatic getFontLoader(callback) {\r\n\t\treturn ModelDebugComponent.fontLoader || (ModelDebugComponent.fontLoader = ModelDebugComponent.getLoader().load(environment.getPath('fonts/helvetiker/helvetiker_regular.typeface.json'), callback));\r\n\t}\r\n\r\n\tget message() {\r\n\t\treturn this.message_;\r\n\t}\r\n\r\n\tset message(message) {\r\n\t\tmessage = message && message !== '' ? message : null;\r\n\t\tif (this.message_ !== message) {\r\n\t\t\tthis.message_ = message;\r\n\t\t\t// console.log('ModelDebugComponent.set.message', message);\r\n\t\t\tthis.setText(message);\r\n\t\t\t/*\r\n\t\t\tif (this.font) {\r\n\t\t\t\tthis.setText(message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelDebugComponent.onInit');\r\n\t\t// this.loadFont();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.textGroup.add(this.text);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.text.parent.remove(this.text);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tconst debugService = this.debugService = DebugService.getService();\r\n\t\tdebugService.message$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => this.message = message);\r\n\t}\r\n\r\n\tcreateText() {\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = ModelDebugComponent.W;\r\n\t\tcanvas.height = ModelDebugComponent.H;\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(4, 1, 2, 2);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\t// blending: THREE.AdditiveBlending,\r\n\t\t\t// side: THREE.DoubleSide\r\n\t\t});\r\n\t\tconst text = new THREE.Mesh(geometry, material);\r\n\t\ttext.renderer = environment.renderOrder.debug;\r\n\t\ttext.position.y = 0;\r\n\t\treturn text;\r\n\t}\r\n\r\n\tloadFont() {\r\n\t\tthis.fontLoader = ModelDebugComponent.getFontLoader((font) => {\r\n\t\t\tthis.font = font;\r\n\t\t\tif (this.message_) {\r\n\t\t\t\tthis.setText(this.message_);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst textGroup = this.textGroup = new THREE.Group();\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\tside: THREE.DoubleSide\r\n\t\t});\r\n\t\tconst text = this.text = this.createText();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(textGroup);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\t// camera.updateMatrixWorld(); // make sure the camera matrix is updated\r\n\t\t\t// camera.matrixWorldInverse.getInverse(camera.matrixWorld);\r\n\t\t}\r\n\t\tcamera.getWorldDirection(position);\r\n\t\t// console.log(position);\r\n\t\t// if (position.lengthSq() > 0.01) {\r\n\t\t// normalize so we can get a constant speed\r\n\t\t// position.normalize();\r\n\t\tposition.multiplyScalar(3);\r\n\t\t// move body, not the camera\r\n\t\t// VR.body.position.add(lookDirection);\r\n\t\t// console.log(position.x + '|' + position.y + '|' + position.z);\r\n\t\tgroup.position.copy(position);\r\n\t\tgroup.lookAt(ModelDebugComponent.ORIGIN);\r\n\t\t// }\r\n\t}\r\n\r\n\tsetText(message) {\r\n\t\tconst text = this.text;\r\n\t\tif (text) {\r\n\t\t\tif (this.host.renderer.xr.isPresenting && message != null) {\r\n\t\t\t\t// draw\r\n\t\t\t\tconst ctx = text.material.map.image.getContext('2d');\r\n\t\t\t\tctx.clearRect(0, 0, ModelDebugComponent.W, ModelDebugComponent.H);\r\n\t\t\t\t// ctx.fillRect(0, 0, 10, 10);\r\n\t\t\t\t// ctx.fillRect(ModelDebugComponent.W - 10, ModelDebugComponent.H - 10, 10, 10);\r\n\t\t\t\tctx.font = `30px ${environment.fontFamily}`;\r\n\t\t\t\tctx.textBaseline = 'middle';\r\n\t\t\t\tctx.textAlign = \"center\";\r\n\t\t\t\tctx.fillStyle = '#FFFFFF';\r\n\t\t\t\tctx.strokeStyle = '#000000';\r\n\t\t\t\tctx.lineWidth = 5;\r\n\t\t\t\tctx.fillText(message, ModelDebugComponent.W / 2, ModelDebugComponent.H / 2, ModelDebugComponent.W - 20);\r\n\t\t\t\ttext.material.map.needsUpdate = true;\r\n\t\t\t\t// draw\r\n\t\t\t\tthis.textGroup.add(text);\r\n\t\t\t} else if (text.parent) {\r\n\t\t\t\ttext.parent.remove(text);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nModelDebugComponent.ORIGIN = new THREE.Vector3();\r\nModelDebugComponent.W = 1024;\r\nModelDebugComponent.H = 256;\r\n\r\nModelDebugComponent.meta = {\r\n\tselector: '[model-debug]',\r\n\thosts: { host: WorldComponent },\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform float opacity;\r\nuniform float tween;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = mix(colorA, colorB, tween);\r\n\tcolor.a = clamp(color.a * opacity, 0.0, 1.0);\r\n\tcolor.rgb /= color.a;\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class ModelGridComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelGridComponent.loader || (ModelGridComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexture() {\r\n\t\treturn ModelGridComponent.texture || (ModelGridComponent.texture = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav.png')));\r\n\t}\r\n\r\n\tstatic getOverTexture() {\r\n\t\treturn ModelGridComponent.textureOver || (ModelGridComponent.textureOver = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav-over.png')));\r\n\t}\r\n\r\n\tset coords(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst previousUniforms = previousTile.uniforms;\r\n\t\t\t\tgsap.to(previousUniforms, {\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.uniforms.tween.value = previousUniforms.tween;\r\n\t\t\t\t\t\tpreviousTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst currentUniforms = currentTile.uniforms;\r\n\t\t\t\tgsap.to(currentUniforms, {\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.uniforms.tween.value = currentUniforms.tween;\r\n\t\t\t\t\t\tcurrentTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tset coords__(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst from = { tween: 1 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// previousTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst from = { tween: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// currentTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tgetCoords(point) {\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst col = Math.ceil((point.x + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst row = Math.ceil((point.z + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\tconst ci = Math.min(dx, Math.abs(col)) * (col ? Math.abs(col) / col : 1);\r\n\t\tconst ri = Math.min(dy, Math.abs(row)) * (row ? Math.abs(row) / row : 1);\r\n\t\tif (this.view.hasTile(this.indices.x + ci, this.indices.y + ri)) {\r\n\t\t\t// console.log('col', col, 'row', row, 'ci', ci, 'ri', ri);\r\n\t\t\treturn new THREE.Vector2(ci, ri);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.indices = new THREE.Vector2();\r\n\t\t// console.log('ModelGridComponent.onInit', this.view);\r\n\t\tthis.view.index$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(index => {\r\n\t\t\tthis.moveToIndex(index);\r\n\t\t});\r\n\t}\r\n\r\n\taddTiles(mesh) {\r\n\t\t// console.log('addTiles');\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(innerTileSize, innerTileSize, 2, 2);\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\tconst map = ModelGridComponent.getTexture();\r\n\t\tmap.disposable = false;\r\n\t\tmap.encoding = THREE.sRGBEncoding;\r\n\t\tconst mapOver = ModelGridComponent.getOverTexture();\r\n\t\tmapOver.disposable = false;\r\n\t\tmapOver.encoding = THREE.sRGBEncoding;\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst tileMap = this.tileMap = {};\r\n\t\tconst tiles = this.tiles = new Array(ModelGridComponent.COLS * ModelGridComponent.ROWS).fill(0).map((x, i) => {\r\n\t\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\t\tfragmentShader: FRAGMENT_SHADER,\r\n\t\t\t\tuniforms: {\r\n\t\t\t\t\ttextureA: { type: \"t\", value: map },\r\n\t\t\t\t\ttextureB: { type: \"t\", value: mapOver },\r\n\t\t\t\t\ttween: { value: 0 },\r\n\t\t\t\t\topacity: { value: 0 },\r\n\t\t\t\t},\r\n\t\t\t\t// side: THREE.DoubleSide\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\tmap: map,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tconst tile = new THREE.Mesh(geometry, material);\r\n\t\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\t\tconst row = Math.floor(i / ModelGridComponent.COLS);\r\n\t\t\tconst col = i % ModelGridComponent.COLS;\r\n\t\t\tconst ci = -dx + col;\r\n\t\t\tconst ri = -dy + row;\r\n\t\t\t// console.log(ci, ri);\r\n\t\t\ttile.position.set(ci * outerTileSize, -ModelGridComponent.RADIUS * 0.15, ri * outerTileSize);\r\n\t\t\ttile.name = this.getName(`tile_${ci}_${ri}`);\r\n\t\t\tconst uniforms = tile.uniforms = {\r\n\t\t\t\ttween: 0,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tci: ci,\r\n\t\t\t\tri: ri,\r\n\t\t\t};\r\n\t\t\ttileMap[`${ci}_${ri}`] = tile;\r\n\t\t\tmesh.add(tile);\r\n\t\t\treturn tile;\r\n\t\t});\r\n\t\tthis.showTiles();\r\n\t}\r\n\r\n\tshowTiles() {\r\n\t\tthis.tiles.forEach((tile, i) => {\r\n\t\t\tconst ix = this.indices ? this.indices.x : 0;\r\n\t\t\tconst iy = this.indices ? this.indices.y : 0;\r\n\t\t\tconst visible = this.view.hasTile(ix + tile.uniforms.ci, iy + tile.uniforms.ri);\r\n\t\t\tconst uniforms = tile.uniforms;\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\topacity: visible ? 1 : 0,\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\t// delay: 0 + i * 0.02,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ttile.material.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\ttile.material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\taddHitArea(mesh) {\r\n\t\tthis.onGroundOver = this.onGroundOver.bind(this);\r\n\t\tthis.onGroundMove = this.onGroundMove.bind(this);\r\n\t\tthis.onGroundDown = this.onGroundDown.bind(this);\r\n\t\tthis.onGroundOut = this.onGroundOut.bind(this);\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(ModelGridComponent.RADIUS, ModelGridComponent.RADIUS, 20, 20);\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst ground = this.ground = new InteractiveMesh(geometry, material);\r\n\t\tground.name = this.getName('ground');\r\n\t\tground.position.set(0, -ModelGridComponent.RADIUS * 0.15, 0);\r\n\t\tground.on('over', this.onGroundOver);\r\n\t\tground.on('move', this.onGroundMove);\r\n\t\tground.on('out', this.onGroundOut);\r\n\t\tground.on('down', this.onGroundDown);\r\n\t\tmesh.add(ground);\r\n\t}\r\n\r\n\tonGroundOver() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundMove() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundDown() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t\tif (coords) {\r\n\t\t\tconst index = this.view.getTileIndex(this.indices.x + coords.x, this.indices.y + coords.y);\r\n\t\t\tthis.view.index = index;\r\n\t\t\tthis.nav.next(index);\r\n\t\t\t/*\r\n\t\t\tthis.indices.x += coords.x;\r\n\t\t\tthis.indices.y += coords.y;\r\n\t\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\t\tthis.move.next({\r\n\t\t\t\tindices: this.indices,\r\n\t\t\t\tcoords,\r\n\t\t\t\tposition: coords.clone().multiplyScalar(outerTileSize)\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonGroundOut() {\r\n\t\tthis.coords = null;\r\n\t}\r\n\r\n\tmoveToIndex(index) {\r\n\t\t// console.log('ModelGridComponent.moveToIndex', index);\r\n\t\tthis.coords = null;\r\n\t\tconst tile = this.view.tiles[index];\r\n\t\tconst coords = new THREE.Vector2(tile.indices.x - this.indices.x, tile.indices.y - this.indices.y);\r\n\t\tthis.indices.x = tile.indices.x;\r\n\t\tthis.indices.y = tile.indices.y;\r\n\t\tthis.showTiles();\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tthis.move.next({\r\n\t\t\tindices: this.indices,\r\n\t\t\tcoords,\r\n\t\t\tposition: coords.clone().multiplyScalar(outerTileSize)\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.tile;\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tthis.addTiles(mesh);\r\n\t\tthis.addHitArea(mesh);\r\n\t\t/*\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\r\n\t\t\t}\r\n\t\t};\r\n\t\t*/\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tconst ground = this.ground;\r\n\t\tground.off('over', this.onGroundOver);\r\n\t\tground.off('move', this.onGroundMove);\r\n\t\tground.off('down', this.onGroundDown);\r\n\t\tground.off('out', this.onGroundOut);\r\n\t}\r\n\r\n}\r\n\r\nModelGridComponent.ORIGIN = new THREE.Vector3();\r\nModelGridComponent.RADIUS = 101;\r\nModelGridComponent.COLS = 11;\r\nModelGridComponent.ROWS = 11;\r\n\r\nModelGridComponent.meta = {\r\n\tselector: '[model-grid]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['move', 'nav'],\r\n\tinputs: ['view'],\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { of } from 'rxjs';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport MessageService from '../../message/message.service';\r\nimport StateService from '../../state/state.service';\r\n// import DebugService from '../debug.service';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport OrbitService, { OrbitMode } from '../orbit/orbit';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport class MenuButton extends InteractiveMesh {\r\n\r\n\tstatic getGrid(total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\treturn [rows, cols];\r\n\t}\r\n\r\n\tstatic getX(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst w = (1 / MenuButton.W * (MenuButton.W + MenuButton.G));\r\n\t\treturn (w / 2 - cols * w / 2) + c * w;\r\n\t}\r\n\r\n\tstatic getY(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst r = Math.floor(index / cols);\r\n\t\tconst h = (1 / MenuButton.W * (MenuButton.H + MenuButton.G));\r\n\t\treturn (rows * h / 2 - h / 2) + r * -h; // y flipped\r\n\t}\r\n\r\n\tstatic get geometry() {\r\n\t\tif (this.geometry_) {\r\n\t\t\treturn this.geometry_;\r\n\t\t}\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1, 1 / MenuButton.W * MenuButton.H, 2, 2);\r\n\t\t// geometry.rotateX(-Math.PI);\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tthis.geometry_ = geometry;\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tstatic get material() {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: ModelMenuComponent.VERTEX_SHADER,\r\n\t\t\tfragmentShader: ModelMenuComponent.FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\ttween: { value: 0 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t});\r\n\t\t/*\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.8,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\t*/\r\n\t\treturn material;\r\n\t}\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tconst geometry = MenuButton.geometry;\r\n\t\tconst material = MenuButton.material;\r\n\t\tsuper(geometry, material);\r\n\t\t// this.userData.item = item;\r\n\t\t// this.userData.index = index;\r\n\t\tthis.renderOrder = environment.renderOrder.menu;\r\n\t\tthis.name = item.name;\r\n\t\tthis.item = item;\r\n\t\tthis.index = index;\r\n\t\tthis.total = total;\r\n\t\tthis.tween = 0;\r\n\t\tthis.opacity = 0;\r\n\t\tconst textureA = this.textureA = this.getTextureA(item.name);\r\n\t\t// material.map = textureA;\r\n\t\tmaterial.uniforms.textureA.value = textureA;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureA.width, textureA.height);\r\n\t\tconst textureB = this.textureB = this.getTextureB(item.name);\r\n\t\t// material.map = textureB;\r\n\t\tmaterial.uniforms.textureB.value = textureB;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureB.width, textureB.height);\r\n\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\tmaterial.uniforms.opacity.value = this.opacity;\r\n\t\tmaterial.needsUpdate = true;\r\n\t\tthis.position.set(MenuButton.getX(index, total), MenuButton.getY(index, total), 0);\r\n\t\tthis.onOver = this.onOver.bind(this);\r\n\t\tthis.onOut = this.onOut.bind(this);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuOverForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tonOver() {\r\n\t\t// DebugService.getService().setMessage('over ' + this.name);\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 1,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 0,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tInteractive.dispose(this);\r\n\t\tthis.textureA.dispose();\r\n\t\tthis.textureB.dispose();\r\n\t\tthis.material.dispose();\r\n\t\tthis.geometry.dispose();\r\n\t}\r\n}\r\n\r\nMenuButton.W = 256;\r\nMenuButton.H = 64;\r\nMenuButton.G = 2;\r\nMenuButton.ROWS = 6;\r\n\r\nexport class BackButton extends MenuButton {\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tsuper(item, index, total);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuBackForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuBackOverForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n}\r\n\r\nexport default class ModelMenuComponent extends ModelComponent {\r\n\r\n\tget loading() {\r\n\t\treturn this.loading_;\r\n\t}\r\n\tset loading(loading) {\r\n\t\tif (this.loading_ !== loading) {\r\n\t\t\tthis.loading_ = loading;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst btn = node.querySelector('.btn--menu');\r\n\t\t\tbtn.classList.toggle('loading', loading);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.onDown = this.onDown.bind(this);\r\n\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\t// console.log('ModelMenuComponent.onInit');\r\n\t\t/*\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeMenu();\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t\tLoaderService.progress$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(progress => this.loading = progress.count > 0);\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// DebugService.getService().setMessage('ModelMenuComponent.MessageService ' + message.type);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.MenuToggle:\r\n\t\t\t\t\tthis.onToggle();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t// this.buildMenu();\r\n\t}\r\n\r\n\tbuildMenu() {\r\n\t\tif (!this.items) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.getModelMenu$(this.items, this.editor).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.groups = menu);\r\n\t\t/*\r\n\t\tconst menu = {};\r\n\t\tthis.items.forEach(item => {\r\n\t\t\tif (item.type.name !== ViewType.WaitingRoom.name && (!item.hidden || this.editor)) {\r\n\t\t\t\tlet group = menu[item.type.name];\r\n\t\t\t\tif (!group) {\r\n\t\t\t\t\tgroup = menu[item.type.name] = [];\r\n\t\t\t\t}\r\n\t\t\t\tgroup.push(item);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.groups = Object.keys(menu).map(typeName => {\r\n\t\t\tlet name = 'Button';\r\n\t\t\tswitch (typeName) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\tname = 'Waiting Room';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\tname = 'Experience';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\tname = 'Virtual Tour';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\tname = 'Stanze 3D';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tname = 'Modelli 3D';\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\treturn { name, type: { name: 'menu-group' }, items: this.items.filter(x => x.type.name === typeName && (!x.hidden || this.editor)) };\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tif (this.buttons) {\r\n\t\t\tthis.buttons.forEach(x => Interactive.dispose(x));\r\n\t\t}\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.cameraGroup;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.menu;\r\n\t\tconst menuGroup = this.menuGroup = new THREE.Group();\r\n\t\t// menuGroup.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(menuGroup);\r\n\t\t}\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tposition.y += 0.5;\r\n\t\t\tposition.multiplyScalar(3);\r\n\t\t\tthis.host.cameraGroup.worldToLocal(position);\r\n\t\t\tposition.y += this.host.cameraGroup.position.y;\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tgroup.scale.set(1, 1, 1);\r\n\t\t\tgroup.lookAt(camera.position);\r\n\t\t\t// group.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\t} else {\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tif (OrbitService.mode === OrbitMode.Model) {\r\n\t\t\t\tposition.multiplyScalar(0.01);\r\n\t\t\t} else {\r\n\t\t\t\tposition.multiplyScalar(3);\r\n\t\t\t}\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tconst s = 1 / camera.zoom;\r\n\t\t\tgroup.scale.set(s, s, s);\r\n\t\t\tgroup.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\t}\r\n\t}\r\n\r\n\titems$(item = null) {\r\n\t\tif (item) {\r\n\t\t\treturn of(item.items);\r\n\t\t} else {\r\n\t\t\treturn MenuService.getModelMenu$(this.items, this.editor).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\taddMenu(item = null) {\r\n\t\tthis.removeMenu();\r\n\t\t// nav to view\r\n\t\tif (item && item.type.name !== 'menu-group') {\r\n\t\t\t/*\r\n\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.nav.next(item);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.active = true;\r\n\t\tthis.items$(item).subscribe(items => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems = items.slice();\r\n\t\t\t\tconst back = {\r\n\t\t\t\t\ttype: { name: 'back' },\r\n\t\t\t\t\tname: item ? 'Back' : 'Close',\r\n\t\t\t\t\tbackItem: item,\r\n\t\t\t\t};\r\n\t\t\t\titems.push(back);\r\n\t\t\t\tconst buttons = this.buttons = items.map((x, i, a) => {\r\n\t\t\t\t\tx.backItem = item;\r\n\t\t\t\t\treturn (x.type.name === 'back') ? new BackButton(x, i, a.length) : new MenuButton(x, i, a.length);\r\n\t\t\t\t});\r\n\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\tbutton.depthTest = false;\r\n\t\t\t\t\tbutton.on('over', button.onOver);\r\n\t\t\t\t\tbutton.on('out', button.onOut);\r\n\t\t\t\t\tbutton.on('down', this.onDown);\r\n\t\t\t\t\tthis.menuGroup.add(button);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tvar box = new THREE.BoxHelper(button, 0xffff00);\r\n\t\t\t\t\tthis.host.scene.add(box);\r\n\t\t\t\t\t*/\r\n\t\t\t\t});\r\n\t\t\t\tgsap.to(buttons, {\r\n\t\t\t\t\tduration: 0.3,\r\n\t\t\t\t\topacity: 0.8,\r\n\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\tstagger: {\r\n\t\t\t\t\t\tgrid: MenuButton.getGrid(buttons.length),\r\n\t\t\t\t\t\tfrom: 0, // index\r\n\t\t\t\t\t\tamount: 0.02 * buttons.length\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\t\t\tbutton.material.uniforms.opacity.value = (button.opacity * (button.item.hidden ? 0.5 : 1));\r\n\t\t\t\t\t\t\t// button.material.needsUpdate = true;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tremoveMenu() {\r\n\t\tMenuService.active = false;\r\n\t\tthis.removeButtons();\r\n\t\tthis.removeToggler();\r\n\t}\r\n\r\n\tremoveButtons() {\r\n\t\tconst buttons = this.buttons;\r\n\t\tif (buttons) {\r\n\t\t\tbuttons.forEach(button => {\r\n\t\t\t\tthis.menuGroup.remove(button);\r\n\t\t\t\tbutton.off('over', button.onOver);\r\n\t\t\t\tbutton.off('out', button.onOut);\r\n\t\t\t\tbutton.off('down', this.onDown);\r\n\t\t\t\tbutton.dispose();\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.buttons = null;\r\n\t}\r\n\r\n\taddToggler() {\r\n\t\tthis.removeMenu();\r\n\t\tconst toggler = this.toggler = new MenuButton({\r\n\t\t\ttype: { name: 'menu' },\r\n\t\t\tname: 'Menu'\r\n\t\t}, 0, 1);\r\n\t\t// toggler.position.y = -0.5;\r\n\t\ttoggler.opacity = 0.8;\r\n\t\ttoggler.material.uniforms.opacity.value = toggler.opacity;\r\n\t\ttoggler.material.needsUpdate = true;\r\n\t\ttoggler.on('over', toggler.onOver);\r\n\t\ttoggler.on('out', toggler.onOut);\r\n\t\ttoggler.on('down', this.onToggle);\r\n\t\tthis.menuGroup.add(toggler);\r\n\t}\r\n\r\n\tremoveToggler() {\r\n\t\tconst toggler = this.toggler;\r\n\t\tif (toggler) {\r\n\t\t\tthis.menuGroup.remove(toggler);\r\n\t\t\ttoggler.off('over', toggler.onOver);\r\n\t\t\ttoggler.off('out', toggler.onOut);\r\n\t\t\ttoggler.off('down', this.onToggle);\r\n\t\t\ttoggler.dispose();\r\n\t\t}\r\n\t\tthis.toggler = null;\r\n\t}\r\n\r\n\tonDown(button) {\r\n\t\t// this.down.next(this.item);\r\n\t\tif (button.item && button.item.type.name === 'back') {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tif (button.item.backItem) {\r\n\t\t\t\tthis.addMenu(button.item.backItem.backItem);\r\n\t\t\t} else {\r\n\t\t\t\t/*\r\n\t\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\t\tthis.addToggler();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tthis.toggle.next();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.addMenu(button.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\tif (StateService.state.locked || StateService.state.spying) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (MenuService.active) {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tthis.toggle.next();\r\n\t\t} else {\r\n\t\t\tthis.addMenu();\r\n\t\t\tthis.toggle.next(this);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelMenuComponent.ORIGIN = new THREE.Vector3();\r\nModelMenuComponent.VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\nModelMenuComponent.FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform float opacity;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = vec4(mix(colorA.rgb, colorB.rgb, tween), opacity);\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nModelMenuComponent.meta = {\r\n\tselector: '[model-menu]',\r\n\thosts: { host: WorldComponent },\r\n\t// outputs: ['over', 'out', 'down', 'nav'],\r\n\toutputs: ['nav', 'toggle'],\r\n\tinputs: ['items', 'editor'],\r\n};\r\n","// import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport EmittableMesh from '../interactive/emittable.mesh';\r\nimport FreezableMesh from '../interactive/freezable.mesh';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelModelComponent extends ModelEditableComponent {\r\n\r\n\t/*\r\n\tstatic getInteractiveGeometry() {\r\n\t\treturn ModelModelComponent.interactiveGeometry || (ModelModelComponent.interactiveGeometry = new THREE.SphereBufferGeometry(1, 8, 8));\r\n\t}\r\n\t*/\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\tset freezed(freezed) {\r\n\t\tif (this.freezed_ !== freezed) {\r\n\t\t\tthis.freezed_ = freezed;\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tif (mesh) {\r\n\t\t\t\tmesh.traverse((child) => {\r\n\t\t\t\t\tif (child.isInteractiveMesh) {\r\n\t\t\t\t\t\tchild.freezed = freezed;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.progress = null;\r\n\t\tthis.isPresenting = false;\r\n\t\t/*\r\n\t\tif (this.view.type.name === ViewType.Model.name) {\r\n\t\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\t\tvrService.session$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe((session) => {\r\n\t\t\t\tthis.onUpdateVRSession(session);\r\n\t\t\t});\r\n\t\t}\r\n\t\t*/\r\n\t\tMenuService.active$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(active => this.freezed = active);\r\n\t\t// console.log('ModelModelComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.model;\r\n\t\tthis.loadGlb(environment.getPath(this.item.asset.folder), this.item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, mount, dismount);\r\n\t\t});\r\n\t}\r\n\r\n\tloadGlb(path, file, callback) {\r\n\t\tconst renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('progressRef');\r\n\t\tconst loader = new THREE.GLTFLoader().setPath(path);\r\n\t\t// Optional: Provide a DRACOLoader instance to decode compressed mesh data\r\n\t\tconst decoderPath = `${environment.assets}js/draco/`;\r\n\t\t// console.log(decoderPath);\r\n\t\tconst dracoLoader = new THREE.DRACOLoader();\r\n\t\tdracoLoader.setDecoderPath(decoderPath);\r\n\t\tloader.setDRACOLoader(dracoLoader);\r\n\t\tloader.load(file, (glb) => {\r\n\t\t\t/*\r\n\t\t\tglb.scene.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(glb.scene, glb.animations);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t// this.progress = null;\r\n\t\t\t// this.pushChanges();\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\t/*\r\n\t\t\tlet value = this.progress ? this.progress.value : 0;\r\n\t\t\tif (progressEvent.lengthComputable) {\r\n\t\t\t\tvalue = Math.round(progressEvent.loaded / progressEvent.total * 100);\r\n\t\t\t} else {\r\n\t\t\t\tvalue = Math.floor(Math.min(100, value + 0.1));\r\n\t\t\t}\r\n\t\t\tthis.progress = { value, title: `${value}%` };\r\n\t\t\t// console.log('progressEvent', progressEvent.loaded, progressEvent.total);\r\n\t\t\tthis.pushChanges();\r\n\t\t\t*/\r\n\t\t\tLoaderService.setProgress(progressRef, progressEvent.loaded, progressEvent.total);\r\n\t\t});\r\n\t}\r\n\r\n\tparseAnimations(mesh, animations) {\r\n\t\t// animations\r\n\t\t// console.log('ModelModelComponent.onGlbLoaded', 'animations', animations);\r\n\t\tconst actionIndex = this.actionIndex = -1;\r\n\t\tconst actions = this.actions = [];\r\n\t\tif (animations && animations.length) {\r\n\t\t\tconst clock = this.clock = new THREE.Clock();\r\n\t\t\tconst mixer = this.mixer = new THREE.AnimationMixer(mesh);\r\n\t\t\tmixer.timeScale = 1;\r\n\t\t\tanimations.forEach(animation => {\r\n\t\t\t\tconst action = mixer.clipAction(animation);\r\n\t\t\t\taction.enabled = true;\r\n\t\t\t\taction.setEffectiveTimeScale(1);\r\n\t\t\t\taction.setEffectiveWeight(1);\r\n\t\t\t\t// action.setLoop(THREE.LoopPingPong);\r\n\t\t\t\taction.setLoop(THREE.LoopRepeat);\r\n\t\t\t\t// action.clampWhenFinished = true; // pause on last frame\r\n\t\t\t\tactions.push(action);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonClipToggle() {\r\n\t\tconst actions = this.actions;\r\n\t\tif (actions.length === 1) {\r\n\t\t\tconst action = actions[0];\r\n\t\t\tif (this.actionIndex === -1) {\r\n\t\t\t\tthis.actionIndex = 0;\r\n\t\t\t\tif (action.paused || action.timeScale === 0) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\taction.play();\r\n\t\t\t\t}\r\n\t\t\t} else if (this.actionIndex === 0) {\r\n\t\t\t\tthis.actionIndex = -1;\r\n\t\t\t\taction.halt(0.3);\r\n\t\t\t}\r\n\t\t} else if (actions.length > 1) {\r\n\t\t\tif (this.actionIndex > -1 && this.actionIndex < actions.length) {\r\n\t\t\t\tconst previousClip = actions[this.actionIndex];\r\n\t\t\t\tpreviousClip.halt(0.3);\r\n\t\t\t}\r\n\t\t\tthis.actionIndex ++;\r\n\t\t\tif (this.actionIndex === actions.length) {\r\n\t\t\t\tthis.actionIndex = -1;\r\n\t\t\t\t// nothing\r\n\t\t\t} else {\r\n\t\t\t\tconst action = actions[this.actionIndex];\r\n\t\t\t\t// console.log(this.actionIndex, action);\r\n\t\t\t\tif (action.paused) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (action.timeScale === 0) {\r\n\t\t\t\t\taction.timeScale = 1;\r\n\t\t\t\t}\r\n\t\t\t\taction.play();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonGlbLoaded(mesh, animations, mount, dismount) {\r\n\t\t// animations\r\n\t\tthis.parseAnimations(mesh, animations);\r\n\t\t// scale\r\n\t\tconst box = new THREE.Box3().setFromObject(mesh);\r\n\t\tconst size = box.max.clone().sub(box.min);\r\n\t\tconst max = Math.max(size.x, size.y, size.z);\r\n\t\tconst scale = 1.7 / max;\r\n\t\tmesh.scale.set(scale, scale, scale);\r\n\t\t// repos\r\n\t\tlet dummy;\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t// this.onUpdateVRSession(this.vrService.currentSession);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tbox.setFromObject(dummy);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tdummy.position.set(\r\n\t\t\t\tmesh.position.x - center.x,\r\n\t\t\t\tmesh.position.y - center.y,\r\n\t\t\t\tmesh.position.z - center.z + (this.host.renderer.xr.isPresenting ? -2 : 0),\r\n\t\t\t\t// mesh.position.z - center.z,\r\n\t\t\t);\r\n\t\t\tconst endY = dummy.position.y;\r\n\t\t\tconst from = { tween: 1 };\r\n\t\t\tconst onUpdate = () => {\r\n\t\t\t\tdummy.position.y = endY + 3 * from.tween;\r\n\t\t\t\tdummy.rotation.y = 0 + Math.PI * from.tween;\r\n\t\t\t};\r\n\t\t\tonUpdate();\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 1.5,\r\n\t\t\t\ttween: 0,\r\n\t\t\t\tdelay: 0.1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: onUpdate,\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tthis.updateHelper();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tbox.setFromObject(mesh);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tmesh.position.set(\r\n\t\t\t\t- center.x,\r\n\t\t\t\t- center.y,\r\n\t\t\t\t- center.z,\r\n\t\t\t);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tif (item.position) {\r\n\t\t\t\tdummy.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tdummy.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tdummy.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\t/*\r\n\t\t\tconst geometry = ModelModelComponent.getInteractiveGeometry();\r\n\t\t\tconst sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\t// wireframe: true,\r\n\t\t\t\t// opacity: 1.0,\r\n\t\t\t\topacity: 0.0,\r\n\t\t\t\tcolor: 0x00ffff,\r\n\t\t\t}));\r\n\t\t\tconst radius = max * scale / 1.7;\r\n\t\t\tsphere.scale.set(radius, radius, radius);\r\n\t\t\tsphere.name = `[model] ${this.item.id}`;\r\n\t\t\t// sphere.depthTest = false;\r\n\t\t\tsphere.renderOrder = 0;\r\n\t\t\tdummy.add(sphere);\r\n\t\t\tsphere.on('down', () => {\r\n\t\t\t\t// console.log('ModelModelComponent.down');\r\n\t\t\t\tthis.down.next(this);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.updateHelper();\r\n\t\t}\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(dummy, this.item);\r\n\t\t\tthis.freezed = MenuService.active;\r\n\t\t}\r\n\t\t/*\r\n\t\tthis.progress = null;\r\n\t\tthis.pushChanges();\r\n\t\t*/\r\n\t}\r\n\r\n\t/*\r\n\tonUpdateVRSession(session) {\r\n\t\tconst mesh = this.mesh;\r\n\t\tif (session && mesh) {\r\n\t\t\tmesh.position.z = -2;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\trender(time, tick) {\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\tconst isPresenting = this.host.renderer.xr.isPresenting;\r\n\t\tconst group = this.group;\r\n\t\tif (mesh) {\r\n\t\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t\tif (this.isPresenting !== isPresenting) {\r\n\t\t\t\t\tthis.isPresenting = isPresenting;\r\n\t\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = -2;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = 0;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst mixer = this.mixer;\r\n\t\tconst clock = this.clock;\r\n\t\tif (mixer) {\r\n\t\t\tconst delta = clock.getDelta();\r\n\t\t\tmixer.update(delta);\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdate', item);\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tif (item.position) {\r\n\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdateAsset', item);\r\n\t\tthis.loadGlb(environment.getPath(item.asset.folder), item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, (mesh, item) => this.onMount(mesh, item), (mesh, item) => this.onDismount(mesh, item));\r\n\t\t});\r\n\t\t/*\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tthis.mesh.load(() => {\r\n\t\t\t// console.log('ModelModelComponent.mesh.load.complete');\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\t// console.log('ModelModelComponent.onDragMove', position);\r\n\t\tthis.editing = true;\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(4);\r\n\t\t\t// this.mesh.lookAt(ModelModelComponent.ORIGIN);\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelModelComponent.onDragEnd');\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\t}\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tstatic getInteractiveDescriptors() {\r\n\t\tlet descriptors = ModelModelComponent.interactiveDescriptors;\r\n\t\tif (!descriptors) {\r\n\t\t\tconst freezableDescriptors = Object.getOwnPropertyDescriptors(FreezableMesh.prototype);\r\n\t\t\tconst emittableDescriptors = Object.getOwnPropertyDescriptors(EmittableMesh.prototype);\r\n\t\t\tconst interactiveDescriptors = Object.getOwnPropertyDescriptors(InteractiveMesh.prototype);\r\n\t\t\tdescriptors = Object.assign({}, freezableDescriptors, emittableDescriptors, interactiveDescriptors);\r\n\t\t\tModelModelComponent.interactiveDescriptors = descriptors;\r\n\t\t}\r\n\t\treturn descriptors;\r\n\t}\r\n\r\n\tmakeInteractive(mesh) {\r\n\t\tconst interactiveDescriptors = ModelModelComponent.getInteractiveDescriptors();\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tObject.keys(interactiveDescriptors).forEach(key => {\r\n\t\t\t\t\tif (key !== 'constructor') {\r\n\t\t\t\t\t\tObject.defineProperty(child, key, interactiveDescriptors[key]);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tchild.freezed = false;\r\n\t\t\t\tchild.events = {};\r\n\t\t\t\tchild.depthTest = true;\r\n\t\t\t\tchild.over_ = false;\r\n\t\t\t\tchild.down_ = false;\r\n\t\t\t\tInteractive.items.push(child);\r\n\t\t\t\tchild.on('down', () => {\r\n\t\t\t\t\t// console.log('ModelModelComponent.down', child);\r\n\t\t\t\t\tthis.onClipToggle();\r\n\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tmakeInteractive__(mesh) {\r\n\t\tlet newChild = null;\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (newChild === null && child.isMesh && !(child.isInteractiveMesh)) {\r\n\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\tconst parent = child.parent;\r\n\t\t\t\tnewChild = new InteractiveMesh(child.geometry, child.material);\r\n\t\t\t\t// newChild.depthTest = true;\r\n\t\t\t\t// newChild.renderOrder = 0;\r\n\t\t\t\tnewChild.name = child.name;\r\n\t\t\t\tnewChild.position.copy(child.position);\r\n\t\t\t\tnewChild.rotation.copy(child.rotation);\r\n\t\t\t\tnewChild.scale.copy(child.scale);\r\n\t\t\t\tnewChild.on('down', () => {\r\n\t\t\t\t\t// console.log('ModelModelComponent.down');\r\n\t\t\t\t\tthis.onClipToggle();\r\n\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t});\r\n\t\t\t\tparent.remove(child);\r\n\t\t\t\tparent.add(newChild);\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (newChild !== null) {\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n}\r\n\r\nModelModelComponent.ORIGIN = new THREE.Vector3();\r\n\r\nModelModelComponent.meta = {\r\n\tselector: '[model-model]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport const NavModeType = {\r\n\tNone: 'none',\r\n\tMove: 'move',\r\n\tInfo: 'info',\r\n\tPoint: 'point',\r\n\tTitle: 'title',\r\n};\r\n\r\nexport default class ModelNavComponent extends ModelEditableComponent {\r\n\r\n\tstatic getNavGeometry() {\r\n\t\t// const geometry = new THREE.PlaneBufferGeometry(3, 2, 2, 2);\r\n\t\t// const geometry = new THREE.SphereBufferGeometry(3, 12, 12);\r\n\t\treturn ModelNavComponent.navGeometry || (ModelNavComponent.navGeometry = new THREE.SphereBufferGeometry(3, 12, 12));\r\n\t}\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelNavComponent.loader || (ModelNavComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexturePoint() {\r\n\t\treturn ModelNavComponent.texturePoint || (ModelNavComponent.texturePoint = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-point.png')));\r\n\t}\r\n\r\n\tstatic getTextureMove() {\r\n\t\treturn ModelNavComponent.textureMove || (ModelNavComponent.textureMove = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-more.png')));\r\n\t}\r\n\r\n\tstatic getTextureInfo() {\r\n\t\treturn ModelNavComponent.textureInfo || (ModelNavComponent.textureInfo = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-info.png')));\r\n\t}\r\n\r\n\tstatic getTexture(mode) {\r\n\t\tlet texture;\r\n\t\tswitch (mode) {\r\n\t\t\tcase NavModeType.Move:\r\n\t\t\t\ttexture = this.getTextureMove();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Info:\r\n\t\t\t\ttexture = this.getTextureInfo();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Point:\r\n\t\t\tcase NavModeType.Title:\r\n\t\t\t\ttexture = this.getTexturePoint();\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getTitleTexture(item, mode) {\r\n\t\tlet texture;\r\n\t\tif (mode === NavModeType.Title) {\r\n\t\t\tconst text = item.title;\r\n\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\tcanvas.width = 512;\r\n\t\t\tcanvas.height = 32;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `28px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tlet w = metrics.width + 8;\r\n\t\t\tw = Math.pow(2, Math.ceil(Math.log(w) / Math.log(2)));\r\n\t\t\tconst x = w / 2;\r\n\t\t\tconst y = 16;\r\n\t\t\tcanvas.width = w;\r\n\t\t\tctx.font = `28px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = 6;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, x, y);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, x, y);\r\n\t\t\ttexture = new THREE.CanvasTexture(canvas);\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getNavMode(item, view) {\r\n\t\tlet mode = NavModeType.None;\r\n\t\tif (item.viewId !== view.id) {\r\n\t\t\tmode = NavModeType.Move;\r\n\t\t\tif (this.isValidText(item.title)) {\r\n\t\t\t\tmode = NavModeType.Title;\r\n\t\t\t}\r\n\t\t\tif (this.isValidText(item.abstract) ||\r\n\t\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t\t(item.link && item.link.href)) {\r\n\t\t\t\tmode = NavModeType.Point;\r\n\t\t\t}\r\n\t\t} else if (this.isValidText(item.title) ||\r\n\t\t\tthis.isValidText(item.abstract) ||\r\n\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t(item.link && item.link.href)) {\r\n\t\t\tmode = NavModeType.Info;\r\n\t\t}\r\n\t\treturn mode;\r\n\t}\r\n\r\n\tstatic isValidText(text) {\r\n\t\treturn text && text.length > 0;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t/*\r\n\t\tthis.debouncedOver$ = new ReplaySubject(1).pipe(\r\n\t\t\tauditTime(250),\r\n\t\t\ttap(event => this.over.next(event)),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t);\r\n\t\tthis.debouncedOver$.subscribe();\r\n\t\t*/\r\n\t\t// console.log('ModelNavComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.nav;\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(this.item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst nav = new THREE.Group();\r\n\t\tconst position = new THREE.Vector3().set(...this.item.position).normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tnav.position.set(position.x, position.y, position.z);\r\n\r\n\t\tthis.onCreateSprites(nav);\r\n\r\n\t\tconst geometry = ModelNavComponent.getNavGeometry();\r\n\t\tconst sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.0,\r\n\t\t\tcolor: 0x00ffff,\r\n\t\t}));\r\n\t\tsphere.name = `[nav] ${this.item.id}`;\r\n\t\tsphere.lookAt(ModelNavComponent.ORIGIN);\r\n\t\tsphere.depthTest = false;\r\n\t\tsphere.renderOrder = 0;\r\n\t\tnav.add(sphere);\r\n\t\tsphere.on('over', () => {\r\n\t\t\t// console.log('ModelNavComponent.over');\r\n\t\t\t/*\r\n\t\t\tif ((mode !== NavModeType.Move && mode !== NavModeType.Title) && !this.editing) {\r\n\t\t\t\tthis.over.next(this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.over.next(this);\r\n\t\t\tconst icon = this.icon;\r\n\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.35,\r\n\t\t\t\tscale: 0.04,\r\n\t\t\t\tdelay: 0,\r\n\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (!this.editing) {\r\n\t\t\t\t\t\tthis.over.next(this);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\tsphere.on('out', () => {\r\n\t\t\tthis.out.next(this);\r\n\t\t\tconst icon = this.icon;\r\n\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.35,\r\n\t\t\t\tscale: 0.03,\r\n\t\t\t\tdelay: 0,\r\n\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tthis.out.next(this);\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\tsphere.on('down', () => {\r\n\t\t\tthis.down.next(this);\r\n\t\t});\r\n\t\tconst from = { opacity: 0 };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.7,\r\n\t\t\topacity: 1,\r\n\t\t\tdelay: 0.5 + 0.1 * this.item.index,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: true,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.materials.forEach(material => {\r\n\t\t\t\t\tmaterial.opacity = from.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(nav, this.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonCreateSprites(mesh, opacity = 0) {\r\n\t\tthis.onRemoveSprite(this.icon);\r\n\t\tthis.onRemoveSprite(this.title);\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(this.item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst map = ModelNavComponent.getTexture(mode);\r\n\t\tmap.disposable = false;\r\n\t\tmap.encoding = THREE.sRGBEncoding;\r\n\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tmap: map,\r\n\t\t\tsizeAttenuation: false,\r\n\t\t\topacity: opacity,\r\n\t\t\t// color: 0xff0000,\r\n\t\t});\r\n\t\tconst materials = [material];\r\n\t\tconst icon = this.icon = new THREE.Sprite(material);\r\n\t\ticon.scale.set(0.03, 0.03, 0.03);\r\n\t\tmesh.add(icon);\r\n\t\tlet titleMaterial;\r\n\t\tconst titleTexture = ModelNavComponent.getTitleTexture(this.item, mode);\r\n\t\tif (titleTexture) {\r\n\t\t\ttitleMaterial = new THREE.SpriteMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\tmap: titleTexture,\r\n\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\topacity: opacity,\r\n\t\t\t\t// color: 0xff0000,\r\n\t\t\t});\r\n\t\t\t// console.log(titleTexture);\r\n\t\t\tconst image = titleTexture.image;\r\n\t\t\tconst title = this.title = new THREE.Sprite(titleMaterial);\r\n\t\t\ttitle.scale.set(0.03 * image.width / image.height, 0.03, 0.03);\r\n\t\t\ttitle.position.set(0, -3.5, 0);\r\n\t\t\tmesh.add(title);\r\n\t\t\tmaterials.push(titleMaterial);\r\n\t\t}\r\n\t\tthis.materials = materials;\r\n\t}\r\n\r\n\tonRemoveSprite(sprite) {\r\n\t\tif (sprite) {\r\n\t\t\tif (sprite.parent) {\r\n\t\t\t\tsprite.parent.remove(sprite);\r\n\t\t\t}\r\n\t\t\tif (sprite.material.map && sprite.material.map.disposable !== false) {\r\n\t\t\t\tsprite.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tsprite.material.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tInteractive.dispose(this.sphere);\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tshouldShowPanel() {\r\n\t\treturn (!this.editing && this.mode !== NavModeType.Move && this.mode !== NavModeType.Title);\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\tthis.item = item;\r\n\t\tthis.onCreateSprites(this.mesh, 1);\r\n\t\tconst position = new THREE.Vector3().set(...item.position).normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t// console.log('onUpdate', item, mesh.position);\r\n\t\tthis.updateHelper();\r\n\t\t/*\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item)\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\tthis.editing = true;\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tthis.item.position = new THREE.Vector3().copy(this.mesh.position).normalize().toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n}\r\n\r\nModelNavComponent.ORIGIN = new THREE.Vector3();\r\nModelNavComponent.RADIUS = 100;\r\n\r\nModelNavComponent.meta = {\r\n\tselector: '[model-nav]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import EmittableSprite from './emittable.sprite';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveSprite extends EmittableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tsuper(material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveSprite() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import FreezableSprite from \"./freezable.sprite\";\r\n\r\nexport default class EmittableSprite extends FreezableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","\r\nexport default class FreezableSprite extends THREE.Sprite {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import html2canvas from 'html2canvas';\r\nimport { getContext } from 'rxcomp';\r\nimport DragService from '../../drag/drag.service';\r\nimport { environment } from '../../environment';\r\nimport InteractiveSprite from '../interactive/interactive.sprite';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelPanelComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPanelComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.getCanvasTexture(node).then(texture => {\r\n\t\t\tif (this.mesh) {\r\n\t\t\t\tconst scale = 0.2 * (this.item.asset ? 1.5 : 1.0);\r\n\t\t\t\tconst aspect = texture.width / texture.height;\r\n\t\t\t\tconst width = ModelPanelComponent.PANEL_RADIUS * scale;\r\n\t\t\t\tconst height = ModelPanelComponent.PANEL_RADIUS * scale / aspect;\r\n\t\t\t\tconst dy = width * 0.25;\r\n\t\t\t\tconst position = this.item.mesh.position.normalize().multiplyScalar(ModelPanelComponent.PANEL_RADIUS);\r\n\t\t\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\t\t\tdepthTest: false,\r\n\t\t\t\t\ttransparent: true,\r\n\t\t\t\t\topacity: 0,\r\n\t\t\t\t\tmap: texture.map,\r\n\t\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\t});\r\n\t\t\t\tconst panel = this.panel = new InteractiveSprite(material);\r\n\t\t\t\tpanel.renderOrder = environment.renderOrder.panel;\r\n\t\t\t\tpanel.scale.set(0.02 * width, 0.02 * height, 1);\r\n\t\t\t\tpanel.position.set(position.x, position.y + (height + dy * 2), position.z);\r\n\t\t\t\tpanel.on('down', (event) => {\r\n\t\t\t\t\tconst xy = { x: parseInt(event.intersection.uv.x * node.offsetWidth), y: parseInt((1 - event.intersection.uv.y) * node.offsetHeight) };\r\n\t\t\t\t\t// console.log('ModelPanelComponent.down.xy', xy);\r\n\t\t\t\t\tconst link = Array.prototype.slice.call(node.querySelectorAll('.panel__link')).find(link => {\r\n\t\t\t\t\t\treturn xy.x >= link.offsetLeft && xy.y >= link.offsetTop && xy.x <= (link.offsetLeft + link.offsetWidth) && xy.y <= (link.offsetTop + link.offsetHeight);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('ModelPanelComponent.down.link', link);\r\n\t\t\t\t\tif (link) {\r\n\t\t\t\t\t\tthis.down.next(link);\r\n\t\t\t\t\t\tconst rect = node.getBoundingClientRect();\r\n\t\t\t\t\t\tconst event = new MouseEvent('mouseup', {\r\n\t\t\t\t\t\t\tbutton: 0,\r\n\t\t\t\t\t\t\tbuttons: 0,\r\n\t\t\t\t\t\t\tclientX: xy.x + rect.left,\r\n\t\t\t\t\t\t\tclientY: xy.y + rect.top,\r\n\t\t\t\t\t\t\tmovementX: 0,\r\n\t\t\t\t\t\t\tmovementY: 0,\r\n\t\t\t\t\t\t\trelatedTarget: link,\r\n\t\t\t\t\t\t\tscreenX: xy.x,\r\n\t\t\t\t\t\t\tscreenY: xy.y,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.dispatchEvent', event);\r\n\t\t\t\t\t\tlink.dispatchEvent(event);\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tDragService.dismissEvent(event, DragService.events$, DragService.dismiss$, DragService.downEvent);\r\n\t\t\t\t\t\t}, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tthis.mesh.add(panel);\r\n\t\t\t\tconst from = { value: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\tvalue: 1,\r\n\t\t\t\t\tdelay: 0.0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpanel.position.set(position.x, position.y + (height + dy * 2) - dy * from.value, position.z);\r\n\t\t\t\t\t\tpanel.lookAt(ModelPanelComponent.ORIGIN);\r\n\t\t\t\t\t\tpanel.material.opacity = from.value;\r\n\t\t\t\t\t\tpanel.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}, error => {\r\n\t\t\tconsole.log('ModelPanelComponent.getCanvasTexture.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelPanelComponent.onDestroy');\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\timagesLoaded() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (node) {\r\n\t\t\tconst images = Array.prototype.slice.call(node.querySelectorAll('img'));\r\n\t\t\tconst promises = images.map(x => new Promise(function(resolve, reject) {\r\n\t\t\t\tconst cors = x.src && x.src.indexOf(location.origin) === -1;\r\n\t\t\t\tif (x.complete) {\r\n\t\t\t\t\treturn setTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t}\r\n\t\t\t\tconst removeListeners = () => {\r\n\t\t\t\t\tx.removeEventListener('load', onLoad);\r\n\t\t\t\t\tx.removeEventListener('error', onError);\r\n\t\t\t\t};\r\n\t\t\t\tconst onLoad = () => {\r\n\t\t\t\t\t// console.log('loaded!');\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t};\r\n\t\t\t\tconst onError = () => {\r\n\t\t\t\t\t// console.log('error!');\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t};\r\n\t\t\t\tconst addListeners = () => {\r\n\t\t\t\t\tx.addEventListener('load', onLoad);\r\n\t\t\t\t\tx.addEventListener('error', onError);\r\n\t\t\t\t};\r\n\t\t\t\taddListeners();\r\n\t\t\t}));\r\n\t\t\tif (promises.length) {\r\n\t\t\t\treturn Promise.all(promises);\r\n\t\t\t} else {\r\n\t\t\t\treturn Promise.resolve();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture(node) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tif (this.item.panelTexture) {\r\n\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.imagesLoaded().then((results) => {\r\n\t\t\t\t\t\tconst context = getContext(this);\r\n\t\t\t\t\t\tif (context && context.node) {\r\n\t\t\t\t\t\t\tnode = context.node;\r\n\t\t\t\t\t\t\tconst useCORS = results && (results.find(x => x === true) != null); // !!! keep loose equality\r\n\t\t\t\t\t\t\t// console.log('ModelPanelComponent.getCanvasTexture.useCORS', useCORS);\r\n\t\t\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\t\t\tbackgroundColor: '#ffffff00',\r\n\t\t\t\t\t\t\t\tscale: 2,\r\n\t\t\t\t\t\t\t\tuseCORS,\r\n\t\t\t\t\t\t\t\t// logging: true,\r\n\t\t\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\t\t\tconst map = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\t\t\t// console.log(canvas.width, canvas.height);\r\n\t\t\t\t\t\t\t\tthis.item.panelTexture = {\r\n\t\t\t\t\t\t\t\t\tmap: map,\r\n\t\t\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}, 1); // keep it for childnode images to be compiled\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelPanelComponent.ORIGIN = new THREE.Vector3();\r\nModelPanelComponent.PANEL_RADIUS = 99;\r\n\r\nModelPanelComponent.meta = {\r\n\tselector: '[model-panel]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down'],\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelPictureComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPictureComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelPictureComponent.meta = {\r\n\tselector: '[model-picture]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1, 1, 2, 2);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = new MediaMesh(item, items, geometry);\r\n\t\t\t\t\tif (item.position) {\r\n\t\t\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.rotation) {\r\n\t\t\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.scale) {\r\n\t\t\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdate', item);\r\n\t\tif (item.position) {\r\n\t\t\tmesh.position.fromArray(item.position);\r\n\t\t}\r\n\t\tif (item.rotation) {\r\n\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t}\r\n\t\tif (item.scale) {\r\n\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdateAsset', item);\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tthis.mesh.load(() => {\r\n\t\t\t\t// console.log('ModelPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\t// console.log('ModelPlaneComponent.onDragMove', position);\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(20);\r\n\t\tthis.mesh.lookAt(ModelPlaneComponent.ORIGIN);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelPlaneComponent.onDragEnd');\r\n\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n}\r\n\r\nModelPlaneComponent.ORIGIN = new THREE.Vector3();\r\nModelPlaneComponent.textures = {};\r\n\r\nModelPlaneComponent.meta = {\r\n\tselector: '[model-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item', 'items'],\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport { PANORAMA_RADIUS } from '../panorama/panorama';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport const LOADING_BANNER = { title: LabelPipe.transform('loading') };\r\nexport const WAITING_BANNER = { title: LabelPipe.transform('waiting_host') };\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\n\r\nexport default class ModelProgressComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (title === WAITING_BANNER.title || (title !== '' && this.visible_)) {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget visible() {\r\n\t\treturn this.visible_;\r\n\t}\r\n\tset visible(visible) {\r\n\t\tif (this.visible_ !== visible) {\r\n\t\t\tthis.visible_ = visible;\r\n\t\t\tif (visible && this.title_ !== '') {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.title_ = '';\r\n\t\tthis.visible_ = this.host.renderer.xr.isPresenting;\r\n\t\tsuper.onInit();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => this.visible = session != null); // loose\r\n\t\t// this.progress = LoaderService.progress;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// console.log('ModelProgressComponent.onCreate');\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst mesh = this.createMesh(result);\r\n\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\tmount(mesh);\r\n\t\t\t}\r\n\t\t\tLoaderService.progress$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(progress => {\r\n\t\t\t\tif (progress.count) {\r\n\t\t\t\t\tthis.title = progress.value === 0 ? LOADING_BANNER.title : progress.title;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.title = this.getTitle();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tgetTitle() {\r\n\t\tif (this.view && this.view.type.name === ViewType.WaitingRoom.name) {\r\n\t\t\treturn WAITING_BANNER.title;\r\n\t\t} else {\r\n\t\t\treturn '';\r\n\t\t}\r\n\t}\r\n\r\n\tshow() {\r\n\t\tthis.mesh.add(this.banner);\r\n\t\tthis.material.opacity = 1;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst material = this.material;\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 1,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\thide() {\r\n\t\tthis.mesh.remove(this.banner);\r\n\t\tthis.material.opacity = 0;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 0,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\tthis.mesh.remove(this.banner);\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tcreateMesh(result) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\t// const repeat = 24;\r\n\t\t// const aspect = (result.width * repeat) / result.height;\r\n\t\tconst arc = Math.PI / 180 * 360;\r\n\t\tconst width = PANEL_RADIUS * arc;\r\n\t\tconst height = width / 360 * 2.4;\r\n\t\tconst w = result.width * height / result.height;\r\n\t\tconst repeat = width / w;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\tconst texture = result.texture;\r\n\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\ttexture.repeat.x = repeat;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst banner = this.banner = new THREE.Mesh(geometry, material);\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t}\r\n\t\t};\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tupdateProgress() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelProgressComponent.updateProgress', result);\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / 360 * 2.4;\r\n\t\t\tconst w = result.width * height / result.height;\r\n\t\t\tconst repeat = width / w;\r\n\t\t\tthis.texture.repeat.x = repeat;\r\n\t\t});\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 64;\r\n\t\t\tconst F = Math.floor(H * 0.75);\r\n\t\t\tconst L = Math.floor(H * 0.05);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.title_;\r\n\t\t\t// console.log('ModelProgressComponent.getCanvasTexture', text);\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.35)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelProgressComponent.meta = {\r\n\tselector: '[model-progress]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['view'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst USE_SHADOW = false;\r\n\r\nexport default class ModelRoomComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.progress = 0;\r\n\t\t// console.log('ModelRoomComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tthis.loadModel(environment.getPath(this.item.modelFolder), this.item.modelFile, (mesh) => {\r\n\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\tmount(mesh);\r\n\t\t\t}\r\n\t\t\tthis.progress = 0;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\tgetLoader(path, file) {\r\n\t\tlet loader;\r\n\t\tif (file.indexOf('.fbx') !== -1) {\r\n\t\t\tloader = new THREE.FBXLoader();\r\n\t\t} else {\r\n\t\t\tloader = new THREE.GLTFLoader();\r\n\t\t}\r\n\t\tloader.setPath(path);\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tloadModel(path, file, callback) {\r\n\t\t// const renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst loader = this.getLoader(path, file);\r\n\t\tloader.load(file, (model) => {\r\n\t\t\tlet mesh;\r\n\t\t\tconst scene = model.scene;\r\n\t\t\tif (scene) {\r\n\t\t\t\tmesh = scene;\r\n\t\t\t} else {\r\n\t\t\t\tmesh = model;\r\n\t\t\t}\r\n\t\t\tconst items = this.item.items;\r\n\t\t\tmesh.scale.set(0.05, 0.05, 0.05);\r\n\t\t\t// mesh.scale.set(10, 10, 10);\r\n\t\t\tmesh.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t\tconst item = items.find(x => x.id === child.name);\r\n\t\t\t\t\tif (item) {\r\n\t\t\t\t\t\titem.mesh = child;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tif (USE_SHADOW) {\r\n\t\t\t\t\t\t\tchild.castShadow = true;\r\n\t\t\t\t\t\t\tchild.receiveShadow = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tchild.material.dispose();\r\n\t\t\t\t\t\t// child.renderOrder = environment.renderOrder.model;\r\n\t\t\t\t\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t\t\t\t\tcolor: 0x111111,\r\n\t\t\t\t\t\t\troughness: 0.6,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tchild.material = material;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.position.y = -1.66 * 3;\r\n\t\t\titems.forEach(item => {\r\n\t\t\t\tconst previous = item.mesh;\r\n\t\t\t\tif (previous) {\r\n\t\t\t\t\tif (previous.material) {\r\n\t\t\t\t\t\tprevious.material.color.setHex(0x000000);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst parent = previous.parent;\r\n\t\t\t\t\tconst mesh = item.mesh = new MediaMesh(item, items, previous.geometry);\r\n\t\t\t\t\tmesh.depthTest = false;\r\n\t\t\t\t\tmesh.renderOrder = 0;\r\n\t\t\t\t\tmesh.name = previous.name;\r\n\t\t\t\t\tmesh.position.copy(previous.position);\r\n\t\t\t\t\tmesh.rotation.copy(previous.rotation);\r\n\t\t\t\t\tmesh.scale.copy(previous.scale);\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\t// mesh.material = new THREE.MeshStandardMaterial({ color: 0xff0000 });\r\n\t\t\t\t\t\tparent.add(mesh);\r\n\t\t\t\t\t\tparent.remove(previous);\r\n\t\t\t\t\t\tif (previous.material) {\r\n\t\t\t\t\t\t\tprevious.material.dispose();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\tconsole.log('ModelRoomComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\tconsole.log('ModelRoomComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tconst lights = new Array(3).fill(0).map((x, i) => {\r\n\t\t\t\tconst light = new THREE.PointLight(0xffffff, 0.1, 1000, 2);\r\n\t\t\t\tif (USE_SHADOW) {\r\n\t\t\t\t\tlight.castShadow = true;\r\n\t\t\t\t\tlight.shadow.mapSize.width = 1024;\r\n\t\t\t\t\tlight.shadow.mapSize.height = 1024;\r\n\t\t\t\t\tlight.shadow.camera.near = 0.1;\r\n\t\t\t\t\tlight.shadow.camera.far = 500;\r\n\t\t\t\t}\r\n\t\t\t\tconst radians = Math.PI / 180 * 45 + Math.PI / 180 * 120 * i;\r\n\t\t\t\tlight.position.set(Math.cos(radians) * 5, 1, Math.sin(radians) * 5);\r\n\t\t\t\t/*\r\n\t\t\t\tconst helper = new THREE.PointLightHelper(light, 0.1);\r\n\t\t\t\tthis.group.add(helper);\r\n\t\t\t\t*/\r\n\t\t\t\tthis.group.add(light);\r\n\t\t\t\treturn light;\r\n\t\t\t});\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(mesh);\r\n\t\t\t}\r\n\t\t\tthis.progress = 0;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\tif (progressEvent.lengthComputable) {\r\n\t\t\t\tthis.progress = Math.round(progressEvent.loaded / progressEvent.total * 100);\r\n\t\t\t} else {\r\n\t\t\t\tthis.progress = this.progress || 0;\r\n\t\t\t\tthis.progress = Math.min(100, this.progress + 1);\r\n\t\t\t}\r\n\t\t\t// console.log('progressEvent', progressEvent.loaded, progressEvent.total);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tconst item = this.item;\r\n\t\tif (item) {\r\n\t\t\tconst items = item.items;\r\n\t\t\tif (items) {\r\n\t\t\t\titems.forEach(item => {\r\n\t\t\t\t\tif (item.mesh) {\r\n\t\t\t\t\t\titem.mesh.dispose();\r\n\t\t\t\t\t\tdelete item.mesh;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nModelRoomComponent.textures = {};\r\n\r\nModelRoomComponent.meta = {\r\n\tselector: '[model-room]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelTextComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelTextComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelTextComponent.meta = {\r\n\tselector: '[model-text]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { CoreModule, Module } from 'rxcomp';\r\nimport { FormModule } from 'rxcomp-form';\r\nimport AccessCodeComponent from './access/access-code.component';\r\nimport AccessComponent from './access/access.component';\r\nimport AgoraChatComponent from './agora/agora-chat.component';\r\nimport AgoraCheckComponent from './agora/agora-check.component';\r\nimport AgoraChecklistComponent from './agora/agora-checklist.component';\r\nimport AgoraDevicePreviewComponent from './agora/agora-device-preview.component';\r\nimport AgoraDeviceComponent from './agora/agora-device.component';\r\nimport AgoraLinkComponent from './agora/agora-link.component';\r\nimport AgoraLoginComponent from './agora/agora-login.component';\r\nimport AgoraNameComponent from './agora/agora-name.component';\r\nimport AgoraStreamComponent from './agora/agora-stream.component';\r\nimport AgoraComponent from './agora/agora.component';\r\nimport AppComponent from './app.component';\r\nimport AssetPipe from './asset/asset.pipe';\r\nimport ControlRequestModalComponent from './control-request/control-request-modal.component';\r\nimport DropDirective from './drop/drop.directive';\r\nimport DropdownItemDirective from './dropdown/dropdown-item.directive';\r\nimport DropdownDirective from './dropdown/dropdown.directive';\r\nimport { EditorModule } from './editor/editor.module';\r\nimport FlagPipe from './flag/flag.pipe';\r\nimport ControlAssetComponent from './forms/control-asset.component';\r\nimport ControlAssetsComponent from './forms/control-assets.component';\r\nimport ControlCheckboxComponent from './forms/control-checkbox.component';\r\nimport ControlCustomSelectComponent from './forms/control-custom-select.component';\r\nimport ControlLinkComponent from './forms/control-link.component';\r\nimport ControlLocalizedAssetComponent from './forms/control-localized-asset.component';\r\nimport ControlMenuComponent from './forms/control-menu.component';\r\nimport ControlModelComponent from './forms/control-model.component';\r\nimport ControlNumberComponent from './forms/control-number.component';\r\nimport ControlPasswordComponent from './forms/control-password.component';\r\nimport ControlSelectComponent from './forms/control-select.component';\r\nimport ControlTextComponent from './forms/control-text.component';\r\nimport ControlTextareaComponent from './forms/control-textarea.component';\r\nimport ControlVectorComponent from './forms/control-vector.component';\r\nimport ControlsComponent from './forms/controls.component';\r\nimport DisabledDirective from './forms/disabled.directive';\r\nimport ErrorsComponent from './forms/errors.component';\r\nimport InputValueComponent from './forms/input-value.component';\r\nimport TestComponent from './forms/test.component';\r\nimport ValueDirective from './forms/value.directive';\r\nimport HtmlPipe from './html/html.pipe';\r\nimport IdDirective from './id/id.directive';\r\nimport LabelPipe from './label/label.pipe';\r\nimport LayoutComponent from './layout/layout.component';\r\nimport LazyDirective from './lazy/lazy.directive';\r\nimport ModalOutletComponent from './modal/modal-outlet.component';\r\nimport ModalComponent from './modal/modal.component';\r\nimport SlugPipe from './slug/slug.pipe';\r\nimport SvgIconStructure from './svg/svg-icon.structure';\r\nimport TryInARModalComponent from './try-in-ar/try-in-ar-modal.component';\r\nimport TryInARComponent from './try-in-ar/try-in-ar.component';\r\nimport UploadItemComponent from './upload/upload-item.component';\r\nimport HlsDirective from './video/hls.directive';\r\nimport VirtualStructure from './virtual/virtual.structure';\r\nimport ModelBannerComponent from './world/model/model-banner.component';\r\nimport ModelCurvedPlaneComponent from './world/model/model-curved-plane.component';\r\nimport ModelDebugComponent from './world/model/model-debug.component';\r\nimport ModelGridComponent from './world/model/model-grid.component';\r\nimport ModelMenuComponent from './world/model/model-menu.component';\r\nimport ModelModelComponent from './world/model/model-model.component';\r\nimport ModelNavComponent from './world/model/model-nav.component';\r\nimport ModelPanelComponent from './world/model/model-panel.component';\r\nimport ModelPictureComponent from './world/model/model-picture.component';\r\nimport ModelPlaneComponent from './world/model/model-plane.component';\r\nimport ModelProgressComponent from './world/model/model-progress.component';\r\nimport ModelRoomComponent from './world/model/model-room.component';\r\nimport ModelTextComponent from './world/model/model-text.component';\r\nimport ModelComponent from './world/model/model.component';\r\nimport WorldComponent from './world/world.component';\r\n\r\nexport class AppModule extends Module { }\r\n\r\nAppModule.meta = {\r\n\timports: [\r\n\t\tCoreModule,\r\n\t\tFormModule,\r\n\t\tEditorModule,\r\n\t],\r\n\tdeclarations: [\r\n\t\tAccessCodeComponent,\r\n\t\tAccessComponent,\r\n\t\tAgoraChatComponent,\r\n\t\tAgoraCheckComponent,\r\n\t\tAgoraChecklistComponent,\r\n\t\tAgoraComponent,\r\n\t\tAgoraDeviceComponent,\r\n\t\tAgoraDevicePreviewComponent,\r\n\t\tAgoraLinkComponent,\r\n\t\tAgoraLoginComponent,\r\n\t\tAgoraNameComponent,\r\n\t\tAgoraStreamComponent,\r\n\t\tAssetPipe,\r\n\t\tControlAssetComponent,\r\n\t\tControlAssetsComponent,\r\n\t\tControlCheckboxComponent,\r\n\t\tControlCustomSelectComponent,\r\n\t\tControlLinkComponent,\r\n\t\tControlLocalizedAssetComponent,\r\n\t\tControlMenuComponent,\r\n\t\tControlModelComponent,\r\n\t\tControlNumberComponent,\r\n\t\tControlPasswordComponent,\r\n\t\tControlRequestModalComponent,\r\n\t\tControlsComponent,\r\n\t\tControlSelectComponent,\r\n\t\tControlTextareaComponent,\r\n\t\tControlTextComponent,\r\n\t\tControlVectorComponent,\r\n\t\tDisabledDirective,\r\n\t\tDropDirective,\r\n\t\tDropdownDirective,\r\n\t\tDropdownItemDirective,\r\n\t\tErrorsComponent,\r\n\t\tFlagPipe,\r\n\t\tHlsDirective,\r\n\t\tHtmlPipe,\r\n\t\tIdDirective,\r\n\t\tInputValueComponent,\r\n\t\tLabelPipe,\r\n\t\tLayoutComponent,\r\n\t\tLazyDirective,\r\n\t\tModalComponent,\r\n\t\tModalOutletComponent,\r\n\t\tModelBannerComponent,\r\n\t\tModelComponent,\r\n\t\tModelCurvedPlaneComponent,\r\n\t\tModelDebugComponent,\r\n\t\tModelGridComponent,\r\n\t\tModelMenuComponent,\r\n\t\tModelModelComponent,\r\n\t\tModelNavComponent,\r\n\t\tModelPanelComponent,\r\n\t\tModelPictureComponent,\r\n\t\tModelPlaneComponent,\r\n\t\tModelProgressComponent,\r\n\t\tModelRoomComponent,\r\n\t\tModelTextComponent,\r\n\t\tSlugPipe,\r\n\t\tSvgIconStructure,\r\n\t\tTestComponent,\r\n\t\tTryInARComponent,\r\n\t\tTryInARModalComponent,\r\n\t\tUploadItemComponent,\r\n\t\tValueDirective,\r\n\t\tVirtualStructure,\r\n\t\tWorldComponent\r\n\t],\r\n\tbootstrap: AppComponent,\r\n};\r\n","import { Browser } from 'rxcomp';\r\nimport { AppModule } from './app.module';\r\n\r\nBrowser.bootstrap(AppModule);\r\n"]}