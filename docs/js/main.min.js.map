{"version":3,"sources":["src/js/main.js","../../src/js/agora/agora.component.chunks.js","../../src/js/utils/utils.js","../../src/js/environment.js","../../src/js/environment.static.js","../../src/js/environment.served.js","../../node_modules/route-node/node_modules/tslib/tslib.es6.js","../../node_modules/path-parser/node_modules/tslib/tslib.es6.js","../../node_modules/search-params/src/encode.ts","../../node_modules/search-params/src/utils.ts","../../node_modules/search-params/src/index.ts","../../node_modules/path-parser/src/encoding.ts","../../node_modules/path-parser/src/rules.ts","../../node_modules/path-parser/src/tokeniser.ts","../../node_modules/path-parser/src/Path.ts","../../node_modules/route-node/src/helpers.ts","../../node_modules/route-node/src/matchChildren.ts","../../node_modules/route-node/src/sortChildren.ts","../../node_modules/route-node/src/RouteNode.ts","../../node_modules/symbol-observable/es/index.js","../../node_modules/symbol-observable/es/ponyfill.js","../../node_modules/router5-transition-path/dist/index.es.js","../../node_modules/router5/dist/index.es.js","../../node_modules/router5-plugin-browser/dist/index.es.js","../../src/js/router/router.service.js","../../src/js/state/state.service.js","../../src/js/user/user.js","../../src/js/meeting/meeting-id.js","../../src/js/meeting/meeting-url.js","../../src/js/router/router-outlet.structure.js","../../src/js/access/access-code.component.js","../../src/js/forms/controls.component.js","../../src/js/label/label.pipe.js","../../src/js/location/location.service.js","../../src/js/language/language.service.js","../../src/js/router/route.pipe.js","../../src/js/agora/agora.types.js","../../src/js/http/http.service.js","../../src/js/user/user.service.js","../../src/js/webhook/webhook.service.js","../../src/js/access/access.component.js","../../src/js/emoji/emoji.service.js","../../src/js/agora/agora-chat-emoji.component.js","../../src/js/message/message.service.js","../../src/js/device/device.service.js","../../src/js/logger/logger.js","../../src/js/storage/session-storage.service.js","../../src/js/stream/stream.service.js","../../src/js/agora/agora.service.js","../../src/js/emittable/emittable.js","../../src/js/agora/agora-chat.component.js","../../src/js/agora/agora-check.component.js","../../src/js/modal/modal.service.js","../../src/js/storage/local-storage.service.js","../../src/js/agora/agora-checklist.service.js","../../src/js/agora/agora-configure-firewall-modal.component.js","../../src/js/agora/agora-checklist.component.js","../../src/js/audio/audio-stream.service.js","../../src/js/agora/agora-device-preview.component.js","../../src/js/agora/agora-device.component.js","../../src/js/editor/path/path.js","../../src/js/editor/path/path.service.js","../../src/js/agora/agora-link.component.js","../../src/js/agora/agora-login.component.js","../../src/js/agora/agora-name.component.js","../../src/js/agora/agora-stream.component.js","../../src/js/view/view.js","../../src/js/editor/navmap/navmap.js","../../src/js/editor/navmap/navmap.service.js","../../src/js/gtm/gtm.service.js","../../src/js/toast/toast.service.js","../../src/js/modal/modal-outlet.component.js","../../src/js/try-in-ar/try-in-ar-modal.component.js","../../src/js/asset/asset.js","../../src/js/view/view.service.js","../../src/js/wishlist/wishlist.service.js","../../src/js/world/media/media-loader.js","../../src/js/world/geometry/geometry.js","../../src/js/world/host/host.js","../../src/js/world/interactive/interactive.js","../../src/js/world/interactive/freezable.mesh.js","../../src/js/world/interactive/emittable.mesh.js","../../src/js/world/interactive/interactive.mesh.js","../../node_modules/three/examples/jsm/loaders/RGBELoader.js","../../src/js/keyboard/keyboard.service.js","../../src/js/loader/loader.service.js","../../src/js/prefetch/prefetch.service.js","../../src/js/rect/rect.js","../../src/js/world/avatar/avatar-element.js","../../src/js/world/texture/texture.js","../../src/js/world/media/media-play-mesh.js","../../src/js/world/media/media-zoom-mesh.js","../../src/js/world/media/media-mesh.js","../../src/js/drag/drag.service.js","../../src/js/world/orbit/orbit.service.js","../../src/js/image/image.service.js","../../src/js/world/panorama/panorama-loader.js","../../src/js/world/panorama/panorama.js","../../src/js/world/phone/phone.element.js","../../src/js/world/pointer/pointer.element.js","../../src/js/world/teleport/teleport.element.js","../../src/js/world/vr.service.js","../../src/js/world/webxr/gamepad.js","../../src/js/world/interactive/emittable.js","../../node_modules/three/examples/jsm/loaders/GLTFLoader.js","../../src/js/world/webxr/motion-controllers.module.js","../../src/js/world/webxr/xr-controller-model.factory.js","../../src/js/world/world.component.js","../../src/js/world/model/model.component.js","../../src/js/world/model/model-editable.component.js","../../src/js/world/model/model-nav.component.js","../../src/js/agora/agora.component.js","../../src/js/asset/asset.service.js","../../src/js/editor/editor.service.js","../../src/js/editor/modals/curved-plane-modal.component.js","../../src/js/editor/modals/item-model-modal.component.js","../../src/js/editor/modals/media-modal.component.js","../../src/js/editor/modals/model-modal.component.js","../../src/js/editor/modals/nav-modal.component.js","../../src/js/editor/modals/panorama-grid-modal.component.js","../../src/js/editor/modals/panorama-modal.component.js","../../src/js/editor/modals/path-add-modal.component.js","../../src/js/editor/modals/path-edit-modal.component.js","../../src/js/editor/modals/plane-modal.component.js","../../src/js/editor/modals/remove-modal.component.js","../../src/js/editor/modals/room-3d-modal.component.js","../../src/js/editor/editor.component.js","../../src/js/generic/generic.service.js","../../src/js/generic/generic.component.js","../../src/js/layout/layout.component.js","../../src/js/try-in-ar/try-in-ar.component.js","../../src/js/app.routes.js","../../src/js/app.component.js","../../src/js/asset/asset.pipe.js","../../src/js/control-request/control-request-modal.component.js","../../src/js/drop/drop.directive.js","../../src/js/dropdown/dropdown.directive.js","../../src/js/dropdown/dropdown-item.directive.js","../../src/js/toast/toast-outlet.component.js","../../src/js/editor/aside/aside.component.js","../../src/js/editor/menu/menu.service.js","../../src/js/drop/drop.service.js","../../src/js/forms/control.component.js","../../src/js/forms/control-asset.component.js","../../src/js/forms/control-menu.component.js","../../src/js/editor/menu/menu-builder.component.js","../../src/js/editor/modals/navmap-item-modal.component.js","../../src/js/editor/modals/navmap-modal.component.js","../../src/js/editor/navmap/navmap-builder.component.js","../../src/js/editor/navmap/navmap-edit.component.js","../../src/js/editor/update/update-view-item.component.js","../../src/js/editor/update/update-view-tile.component.js","../../src/js/editor/update/update-view.component.js","../../src/js/editor/editor.module.js","../../src/js/editor/modals/iframe-modal.component.js","../../src/js/env/env.pipe.js","../../src/js/flag/flag.pipe.js","../../src/js/upload/upload.service.js","../../src/js/forms/control-assets.component.js","../../src/js/generic/generic-modal.component.js","../../src/js/forms/control-checkbox.component.js","../../src/js/forms/control-custom-select.component.js","../../src/js/forms/control-link.component.js","../../src/js/forms/control-localized-asset.component.js","../../src/js/forms/control-model.component.js","../../src/js/forms/control-number.component.js","../../src/js/forms/control-password.component.js","../../src/js/forms/control-select.component.js","../../src/js/forms/control-text.component.js","../../src/js/forms/control-textarea.component.js","../../src/js/forms/control-vector.component.js","../../src/js/forms/disabled.directive.js","../../src/js/forms/errors.component.js","../../src/js/forms/input-value.component.js","../../src/js/forms/test.component.js","../../src/js/forms/value.directive.js","../../src/js/html/html.pipe.js","../../src/js/id/id.directive.js","../../src/js/language/language.component.js","../../src/js/lazy/lazy.cache.js","../../src/js/lazy/lazy.directive.js","../../src/js/intersection/intersection.service.js","../../src/js/message/message.pipe.js","../../src/js/modal/modal.component.js","../../src/js/router/router-link.directive.js","../../src/js/support-request/support-request-modal.component.js","../../src/js/svg/svg-icon.structure.js","../../src/js/title/title.directive.js","../../src/js/upload/upload-item.component.js","../../src/js/video/hls.directive.js","../../src/js/virtual/virtual.item.js","../../src/js/virtual/virtual.structure.js","../../src/js/world/media/media-player.component.js","../../src/js/world/model/model-banner.component.js","../../src/js/world/model/model-curved-plane.component.js","../../src/js/world/debug.service.js","../../src/js/world/model/model-debug.component.js","../../src/js/world/model/model-grid.component.js","../../src/js/world/model/model-menu.component.js","../../node_modules/three/examples/jsm/loaders/DRACOLoader.js","../../src/js/world/model/model-model.component.js","../../src/js/world/interactive/freezable.sprite.js","../../src/js/world/interactive/emittable.sprite.js","../../src/js/world/interactive/interactive.sprite.js","../../src/js/world/model/model-panel.component.js","../../src/js/world/model/model-picture.component.js","../../src/js/world/model/model-plane.component.js","../../src/js/world/model/model-progress.component.js","../../src/js/world/model/model-room.component.js","../../src/js/world/model/model-text.component.js","../../src/js/app.module.js","../../src/js/main.js"],"names":["g","f","exports","module","require","define","amd","globalThis","self","rxcomp","form","rxjs","operators","THREE","html2canvas","this","rxcompForm","three","_interopDefaultLegacy","e","default","html2canvas__default","CHUNK_SERVICE","CHUNK_CONTROLS","CHUNK_MEDIA","CHUNK_AR_VR","CHUNK_LIKE","CHUNK_CHAT","CHUNK_LOCK","CHUNK_NAVMAP","CHUNK_BACKGROUND","CHUNK_LOGO","CHUNK_CREDITS","CHUNK_COPYRIGHT","CHUNK_LANGUAGE","CHUNK_VIRTUAL_TOUR","CHUNK_SELF_SERVICE_TOUR","CHUNK_EMBED","Utils","static","target","source","Object","keys","forEach","key","value","Array","isArray","merge","assign","NODE","DEBUG","get","URLSearchParams","window","location","search","document","querySelector","getAttribute","HEROKU","host","indexOf","VERCEL","DEPLOYED","STATIC","port","DEVELOPMENT","split","ENV","PRODUCTION","defaultAppOptions","channelName","flags","heroku","vercel","deployed","navs","iconMinScale","iconMaxScale","url","languages","defaultLanguage","labels","data","fields","environmentOptions","appKey","production","useProxy","useToken","usePrefetch","useExtendedUserInfo","useEncryptedUrl","gdprRoutes","selfService","guidedTourRequest","guidedTourAccess","ssoLogin","ssoRegister","editor","editorAssetScreen","menu","menuEmbed","navmaps","screenShare","chat","ar","like","hideNavInfo","useIframe","attendee","streamer","viewer","smartDevice","selfServiceProposition","navInfoAnimated","navInfoImportantAnimated","navMoveAnimated","navMoveImportantAnimated","navPointAnimated","navPointImportantAnimated","navTitleAnimated","navTitleImportantAnimated","navTransparentAnimated","navTransparentImportantAnimated","useTextureEnvironment","usePaths","antialias","alpha","premultipliedAlpha","sso","issuer","origin","loginUrl","logoutUrl","registerUrl","verifyTokenUrl","profiles","publisher","screen","logo","selfServiceAudio","colors","menuBackground","menuForeground","menuOverBackground","menuOverForeground","menuBackBackground","menuBackForeground","menuBackOverBackground","menuBackOverForeground","disabledViewTypes","disabledViewItemTypes","assets","dist","workers","image","prefetch","textures","envMap","grid","toneMappingExposure","githubDocs","template","email","supportRequest","options","fontFamily","renderOrder","panorama","room","plane","tile","model","banner","nav","panel","debug","pointer","bhere","environment","console","log","href","getAbsoluteUrl","path","params","replace","getPath","isLocal","constructor","__assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","makeOptions","opts","arrayFormat","booleanFormat","nullFormat","encodeValue","encodeURIComponent","decodeValue","decodeURIComponent","encode","name","encodeNull","toString","encodeBoolean","arr","encodeName","index","getNameEncoder","map","val","join","encodeArray","getSearch","pos","slice","parseName","bracketPosition","hasBrackets","parse","reduce","param","_a","rawName","_b","currentValue","decodedValue","undefined","decode","concat","build","filter","paramName","isSerialisable","Boolean","excludeSubDelimiters","encodeURIComponentExcludingSubDelims","segment","match","encodingMethods","uri","encodeURI","uriComponent","none","legacy","decodingMethods","decodeURI","encodeParam","encoding","isSpatParam","encoder","String","defaultOrConstrained","rules","pattern","regex","RegExp","tokenise","str","tokens","some","rule","push","type","otherVal","Function","substr","Error","exists","defaultOptions","urlParamsEncoding","Path","hasUrlParams","test","hasSpatParam","hasMatrixParams","hasQueryParams","spatParams","getParams","urlParams","queryParams","isQueryParam","_this","caseSensitive","strictTrailingSlash","optTrailingSlash","urlTest","parseQueryParams","unexpectedQueryParams","partialTest","delimited","delimiter","upToDelimiter","existingVal","appendQueryParam","ignoreConstraints","ignoreSearch","encodedUrlParams","acc","v","missingParameters","every","base","searchParams","sparams","searchPart","buildQueryParams","predicate","m","getMetaFromSegments","segments","accName","meta","_c","_d","parser","allParams","matchChildren","nodes","pathSegment","currentMatch","consumedBefore","queryParamsMode","strongMatching","isRoot","child","remainingPath","children","consumedPath","toLowerCase","querystring","paramsToOmit","removedParams","left","right","chunk","kept","removed","omit","remainingQueryParams_1","getNonAbsoluteChildren","_i","nodes_1","state_1","sortPredicate","originalChildren","_e","_f","leftPath","rightPath","leftSegments","rightSegments","leftParamsCount","rightParamsCount","leftParamLength","rightParamLength","RouteNode","childRoutes","absolute","parent","checkParents","add","onAdd","finalSort","sort","sortDescendants","getParentSegments","reverse","setParent","setPath","route","cb","r","addRouteNode","routeNode","fullName","_","addNode","routeName","segmentsByName","getSegmentsByName","sortChildren","buildPath","buildPathFromSegments","trailingSlashMode","nonSearchParams","segments_1","extraParams","searchParamsObject","segmentPath","finalPath","buildState","matchPath","getSegmentsMatchingPath","matchedSegments","firstSegmentParams","lastSegmentSlashChild","findSlashChild","buildStateFromMatch","names","hasParentsParams","hasParams","findAbsoluteChildren","absoluteChildren","findSegmentByName","routes","matched","filteredRoutes","startingNodes","node","finalMatch","result","root","Symbol","observable","ponyfill","global","nameToIDs","ids","hasMetaParams","state","extractSegmentParams","autoCleanUp","allowNotFound","rewritePathOnMatch","errorCodes","constants","withState","router","stateId","routerState","getState","setState","makeState","forceId","config","defaultParams","id","makeNotFoundState","areStatesEqual","state1","state2","ignoreQueryParams","getUrlParams","rootNode","state1Params","state2Params","areStatesDescendants","parentState","childState","forwardState","routeParams","forwardMap","eventsMap","onStart","onStop","onTransitionSuccess","onTransitionStart","onTransitionError","onTransitionCancel","withPlugins","routerPlugins","startPlugin","plugin","appliedPlugin","executeFactory","removeEventListeners","methodName","addEventListener","removeListener","teardown","getPlugins","usePlugin","plugins","removePluginFns","removePlugin","withMiddleware","middlewareFactories","middlewareFunctions","useMiddleware","middlewares","middleware","middlewareFunction","fn","clearMiddleware","getMiddlewareFactories","getMiddlewareFunctions","withObservability","callbacks","subscribe","listener","isObject","finalListener","next","bind","unsubscribeHandler","toState","fromState","previousRoute","unsubscribe","observer","TypeError","$$observable","invokeEventListeners","eventName","args","removeEventListener","_cb","resolve","functions","callback","isCancelled","errorKey","remainingFunctions","isState","obj","processFn","stepFn","errBase","_done","done","err","newState","hasStateChanged","error","mergeStates","res","then","resVal","stack","promiseError","isMapped","transition","cancelled","completed","getOptions","getLifecycleFunctions","canDeactivateFunctions","canActivateFunctions","makeError","isUnknownRoute","asyncBase","toStateOptions","fromStateIds","toStateIds","maxI","Math","min","reload","_loop_1","leftParams","rightParams","pointOfDifference","toDeactivate","toActivate","intersection","transitionPath","canDeactivate","forceDeactivate","canDeactivateFunctionMap","fnMap","code","canActivate","canActivateFunctionMap","activeSegments_1","clearCanDeactivate","noop","withNavigation","cancelCurrentTransition","navigate","lastArg","isStarted","sameStates","force","skipTransition","transitionToState","redirect","redirected","navigateToDefault","defaultRoute","cancel","noop$1","withRouterLifecycle","started","start","startPath","startState","startPathOrState","invokeErrCb","navigateToDefault_1","redirect_1","stop","toFunction","withRouteLifecycle","canDeactivateFactories","canActivateFactories","getLifecycleFactories","canDeactivateHandler","factory","canActivateHandler","createRouter$1","dependencies","fns","arg","prev","pipe","routerOptions","setOption","option","withOptions","routerDependencies","setDependency","dependencyName","dependency","setDependencies","deps","getDependencies","getInjectables","factoryFunction","withDependencies","forward","fromRoute","toRoute","onRouteAdded","forwardTo","decodeParams","decoders","encodeParams","encoders","isActive","strictEquality","activeState","paramsWithDefault","encodedParams","name_1","decodedParams","builtPath","setRootPath","rootPath","withRoutes","__spreadArrays","il","k","a","j","jl","isBrowser","history","safelyEncodePath","safeBrowser","getBase","pathname","pushState","title","replaceState","addPopstateListener","shouldAddHashChangeListener","useHash","navigator","userAgent","getLocation","hash","hashPrefix","getHash","mergeState","preserveHash","browserPluginFactory","browser","removePopStateListener","transitionOptions","routerStart","buildUrl","updateBrowserState","trimmedState","finalState","onPopState","evt","matchUrl","pathParts","urlToPath","replaceHistoryState","lastKnownState","historyState","hasState","statesAreEqual","RouterService","router_","event$","EMPTY","createRouter","browserPlugin","from","startWith","useBrowser","routerLink","active","StateService","state$","getValue","BehaviorSubject","RoleType","Publisher","Attendee","Streamer","Viewer","SmartDevice","SelfService","Embed","User","MEETING_ID_VALIDATOR","MeetingId","roleIndex","getRoleIndex","role","userId","user","timestamp","Date","valueOf","pathId","warn","decompose","compose","toRoles","idAttendee","idStreamer","idViewer","idSmartDevice","idSelfService","padded","meetingId","components","parseInt","c","num","size","MeetingUrl","link","getName","firstName","getFirstName","lastName","getLastName","getEmail","viewId","embedViewId","support","toParams","shareable","encrypt","toUrl","getCurrentUrl","toAccessCodeUrl","getAccessCodeUrl","toGuidedTourUrl","getGuidedTourUrl","copyToClipBoard","asAccessCode","input","createElement","style","position","top","appendChild","focus","select","setSelectionRange","execCommand","parentNode","removeChild","alert","replaceUrl","setCurrentParams","currentOptions","meetingUrl","replaceWithOptions","lang","x","has","decrypt","JSON","atob","btoa","stringify","RouterOutletStructure","Structure","getFactory","originalRoute","find","onInit","route$","switchMap","factory$","takeUntil","unsubscribe$","event","getContext","factory_","of","tap","element","remove","instance","innerHTML","firstElementChild","makeInstance","selector","compile","onChanges","hosts","AccessCodeComponent","Component","QRious","ownKeys","getOwnPropertySymbols","o","getOwnPropertyDescriptor","enumerable","_objectSpread2","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","hint","prim","toPrimitive","Number","_toPrimitive","_toPropertyKey","configurable","writable","ControlsComponent","group","formGroup","control","getControl","fieldsToFormGroup","FormGroup","controls","validators","required","Validators","RequiredTrueValidator","RequiredValidator","EmailValidator","PatternValidator","FormControl","unshift","fieldsToFormControls","patchFields","testValues","patch","inputs","FormAbstractCollectionDirective","LabelPipe","Pipe","getCopy","label","_len","_key","transform","getFullYear","LocationService","keyOrValue","set","pushParams","delete","to","encoded","deserialize","decoded","json","LanguageService","lang$","language","alternates","alternateName","g1","g2","offset","alternate","setAlternates","hasLanguages","activeLanguage","fetch","response","text","html","labelsMatch","exec","setLabels","bhereMatch","showLanguages","pushChanges","getDefaultLanguages","getDefaultLanguage","RoutePipe","StreamQualities","profile","resolution","width","height","frameRate","max","bitrate","compatible","getStreamQuality","AgoraStatus","MessageType","UIMode","AgoraEvent","AgoraPeerEvent","AgoraRemoteEvent","AgoraMuteVideoEvent","AgoraUnmuteVideoEvent","AgoraMuteAudioEvent","AgoraUnmuteAudioEvent","AgoraVolumeLevelsEvent","HttpService","method","format","response_","headers","Accept","body","contentType","typedResponse","ok","Promise","reject","catchError","throwError","getError","query","http$","object","status","statusCode","statusMessage","statusText","UserService","user$","get$","mapUser","setUser","payload","post$","newDocument","DOMParser","parseFromString","setTimeout","newWindow","open","head","login$","guidedTour$","selfServiceTour$","roleType","uuid","username","me$","temporaryUser$","getTime","mode","UID","WebhookEvent","toJson","action","extra","userSessionId","uid","userRole","message","WebhookService","postMessage","event$_","first","handleResponse_","handleError_","enabled","newEvent","observables","webhook","uris","internal$_","send$_","forkJoin","remoteResponse","remoteStatus","remoteError","methods","fromEvent","parseEvent","shareReplay","AccessComponent","onSSOPopupClose","routeUrl","pathMapper","setRouterLink","validateParams","onSelfServiceTourRequest","initRequestForm","onSubmit","onGuidedTourRequest","onSSOLogin","protocol","preventDefault","onSSORegister","onGuidedTourAccess","logout$","onLogin","initLoginForm","formSubscription","roles","antiforgery","changes$","changes","password","checkRequest","checkField","reset","onBack","valid","submitted","webhookPayload","_objectSpread","resolve$","onHandleHook","touched","isValid","values","send$","EmojiService","items_","items","AgoraChatEmojiComponent","emoji$","onSelect","item","emoji","onClose","close","outputs","MessageService","message$","in$","remoteId","clientId","out$","ReplaySubject","send","in","DevicePlatform","DeviceService","platform","platform_","getDevicePlatform","isIOS","isVRHeadset","vendor","opera","LoggerLevel","Logger","level","level_","getLevel","info","SessionStorageService","isSessionStorageSupported","sessionStorage","removeItem","cache","setItem","supported","StreamServiceMode","StreamService","editorStreams","editorStreams$","editorScreens","editorScreens$","local","local$","screen$","remotes","remotes$","peers","peers$","combineLatest","interval","datas","orderedRemotes","remote","screenUid","audioLevel","peekAudioLevel","order","clientInfo","getAudioLevel","b","av","distinctUntilChanged","mediaDevices","getUserMedia","media","video","setAttribute","stream","srcObject","src","URL","createObjectURL","oncanplay","fakePublisherStream","getId","fakeAttendeeStream","fakeSmartDeviceStream","play","catch","getDisplayMedia","fakePublisherScreen","fakeAttendeeScreen","publisherStreamId","streams","publisherStream","streams$","attendeeStreamId","attendeeStream","streamId","isPlaying","splice","getEditorStreams$","getEditorScreens$","AgoraService","events","on","off","once","emit","broadcast","defaultDevices","AGORA","super","previousMuteAudio_","channelState","channelSnapshot","onStreamPublished","onStreamUnpublished","onStreamAdded","onStreamRemoved","onStreamSubscribed","onMuteVideo","onUnmuteVideo","onMuteAudio","onUnmuteAudio","onVolumeIndicator","onPeerConnect","onPeerLeaved","onConnectionStateChange","onTokenPrivilegeWillExpire","onTokenPrivilegeDidExpire","onMessage","patchState","devices","videos","audios","quality","membersCount","isHostRole","isAudienceRole","addStreamDevice","removeStreamDevice","deviceId","kind","audio","devices$","defaultVideos","defaultAudios","tempStream","getDevices","device","AgoraRTC","createStream","init","connect$","preferences","connecting","createClient","channelNameLink","getChannelNameLink","rtcToken$","token","membersCount$","channelId","messageClient","getChannelMemberCount","counters","observeMemberCount","unobserveMemberCount","membersCountSubscription","client","setLogLevel","NONE","codec","clientInit","startProxyServer","setClientRole","onError","AgoraRTM","createInstance","logFilter","LOG_FILTER_OFF","setParameters","floor","random","now","channel","getUniqueUserId","connected","rtmToken$","joinMessageChannel","success","autoDetectDevice","createMediaStream","login","createChannel","getMembers","members","broadcastMessage","detectDevices","getVideoOptions","crossOrigin","hls","Hls","attachMedia","Events","MEDIA_ATTACHED","loadSource","MANIFEST_PARSED","captureStream","videoSource","getVideoTracks","cameraId","getAudioOptions","loadLevel","levels","audioSource","getAudioTracks","microphoneId","inputDevices","streamID","all","createLocalStreamWithOptions","setVideoProfile","publishLocalStream","setUserState","publish","unpublishLocalStream","unpublish","clearLocalUserAttributes","leaveChannel","unpublishScreenStream","leaveMessageChannel","leaveClient","leaveScreenClient","leave","stopProxyServer","logout","toggleCamera","userMuteVideo","unmuteVideo","cameraMuted","broadcastEvent","muteVideo","toggleAudio","userMuteAudio","unmuteAudio","audioMuted","muteAudio","setAudio","toggleMode","setChannelState","toggleNavInfo","showNavInfo","requestControl","controllingId","sendRequestControl","controlling","spying","requestSpy","spyingId","sendRequestSpy","dismissControl","skipAttributes","sendRequestControlDismiss","dismissSpy","sendRequestSpyDismiss","toggleControl","dismissedControllingId","toggleSpy","dismissedSpyingId","sendMessage","toggleSilence","silencing","newMessageId","navToView","keepOrientation","useLastOrientation","getSessionStats","stats","Duration","UserCount","SendBytes","RecvBytes","SendBitrate","RecvBitrate","getSystemStats","BatteryLevel","onMessageSent","setChannelSnapshot","messageId","getChannelAttributes","attributes","getChannelAttributesByKeys","mappedAttributes","getChannelMessages","lastUpdateTs","messages","attribute","addOrUpdateChannelAttributes","enableNotificationToChannelMembers","finally","getInitialSession","getChannelSession","session","snapshot","dispatchEvent","Event","channelSession","getChannelState","partialState","getChannelSnapshot","partialSnapshot","padStart","count","char","addOrUpdateChannelMessages","date","deleteChannelAttributesByKeys","addOrUpdateLocalUserAttributes","getUserState","getUserAttributes","checkBroadcastMessage","out","container","classList","remoteRemove","remoteAdd","peerAdd","hosted","peerRemove","peer","peerId","remoteSetClientInfo","attr","renewToken","toggleScreen","screenClient","createScreenStream","createScreenClient","screenJoin","onScreenError","onScreenStreamPublished","onScreenStreamUnpublished","screenClientId","setScreenProfile","onStopScreenSharing","publishScreenStream","checkRtcTryJoin","devices_","constraints","facingMode","enumerateDevices","getTracks","track","prefix","getOwnPropertyNames","legacyKey","ChatMessage","clientId_","shortName","toUpperCase","me","getPayload","AgoraChatComponent","typings_","rows","showEmoji","demo","checkTypings","pushMessage","typingBegin","typingEnd","groupedMessages","getFakeList","updateMessages","agora","getSingleton","onView","onDestroy","clearTimeout","secureMessage","secureText","createMessage","onKeyDown","shiftKey","onToggleEmoji","onSelectEmoji","unsecureText","textContent","scrollToBottom","scrollView","scrollTop","scrollHeight","removeTyping","recursive","typings","lastMessage","typing","randomMessage","createRandomMessage","others","getRandomMessage","AgoraCheckComponent","ModalEvent","ModalResolveEvent","ModalRejectEvent","ModalService","hasModal","hasModal_","modal","busy$","iframe","getTemplate$","getNode","modal$","events$","div","Subject","LocalStorageService","isLocalStorageSupported","localStorage","TIMEOUT","AgoraChecklistService","shouldCheckAudio","shouldCheckVideo","checklist","https","rtc","rtm","errors","checked","checklist$","isChecked","check$","delay","checkBrowserEvent$","checkHttpsEvent$","checkAudioEvent$","checkVideoEvent$","checkRtcEvent$","checkRtmEvent$","checkSystemRequirements","checkBrowser$","checkHttps$","checkAudio$","checkVideo$","checkRtcConnection","checkRtc$","checkRtmConnection","checkRtm$","AgoraConfigureFirewallModalComponent","AgoraChecklistComponent","busy","checkEvent$","onNext","openHttps","showFirewallConfiguration","open$","AudioStreamService","context","context_","AudioContext","analyser","analyser_","createAnalyser","streamOrElement","MediaStream","sources_","createMediaStreamSource","clone","createMediaElementSource","removeSourceKey","disconnect","fftSize","Uint8Array","addSource","connect","frame$","withLatestFrom","_ref","deltaTime","getByteFrequencyData","finalize","removeSource","volume","clipped","meter","audioMeterCreate","_ref2","checkClipping","clipLevel","averaging","clipLag","processor","createScriptProcessor","onaudioprocess","audioMeterProcess","audioMeterClip","dispose","audioMeterDispose","clipping","lastClip","destination","buffer","inputBuffer","getChannelData","bufferLength","sum","abs","performance","rms","sqrt","previous","Observable","create","requestAnimationFrame","startTime","frame","expand","step$","share","AgoraDevicePreviewComponent","video_","change","initStream","audio_","hasPreview","initialized_","onLoadedMetadata","preview","bars","fill","bar","ideal","analyzeData","loadingStream_","frequencySubscription","frequency$","frequency","pow","opacity","AgoraDeviceComponent","isHttps","initForm","videoOptions","audioOptions","onStreamDidChange","onStream","onEnter","enter","originalItems","View","allowedProps","mapPath","DEFAULT_PATH","PathService","paths","paths$","path$","pathGet$","selectedPath","currentPath","put$","delete$","AgoraLinkComponent","selfServiceTourRoute","getCurrentPath$","onLoad","pathOptions","onGenerateMeetingId","$event","meetingIdRoles","onInputDidChange","onCopyToClipBoard","replaceWithLink","AgoraLoginComponent","friendlyMessage","replaceWithUser","AgoraNameComponent","AgoraStreamComponent","videoMuted","videoMuted_","audioMuted_","streamId_","stream_","player","childElementCount","shouldUseResumeGesture","fit","removeAttribute","vrContainer","vrContainer_","videoNode","videoNode_","setMediaStream","mediaStream","onToggleControl","onToggleSpy","ViewType","WaitingRoom","Panorama","PanoramaGrid","Room3d","Model","Media","ViewItemType","Nav","Plane","CurvedPlane","Texture","updateIndices","flag","isValidText","abstract","isNavMove","navigable","filterViewItem","mapViewItem","tiles","mapViewTile","lastOrientation","latitude","longitude","pathItems","shortType","substring","publisherStreamIndex","attendeeStreamIndex","smartDeviceStream","publisherScreenIndex","attendeeScreenIndex","asset","file","PanoramaView","PanoramaGridView","flipAxes","invertAxes","folder","axes","indices","Vector2","y","index_","selected","updateCurrentItems","index$","mapTiles","getTileIndex","hasTile","getTile","Room3DView","ModelView","MediaView","ViewItem","links","firstLink","hasPanel","NavViewItem","ViewTile","mapView","view","Navmap","mapNavmap","NavmapService","active$","navmap","GtmService","dataLayer","push_","ToastType","ToastPosition","ToastEvent","toast","ToastResolveEvent","ToastRejectEvent","ToastService","acceptMessage","rejectMessage","toast$","duration","ModalOutletComponent","modal_","modalNode","busy_","TryInARModalComponent","parentInstance","getUrl","EXT_IMAGE","EXT_VIDEO","EXT_MODEL","AssetType","Image","Video","PublisherStream","AttendeeStream","PublisherScreen","AttendeeScreen","SmartDeviceStream","AssetGroupType","ImageOrVideo","STREAM_TYPES","assetIsStream","assetGroupTypeFromItem","assetPayloadFromGroupTypeId","groupTypeId","groupType","assetTypeById","Asset","assetTypeFromPath","extension","pop","defaultMediaAsset","mapAsset","DEFAULT_WAITING_ROOM","likes","liked","orientation","ViewService","dataViews","views","validViews","pathViews","validPathViews","action$_","currentView","getDataView","data$_","dataUrl","getValidPathId","initialViewId","getFirstPathId","getWaitingRoom","setDataAndPath","waitingRoom","view$","hosted$","prefetchAssets","getPrefetchAssets","data$","viewById$","items$_","WishlistService","items$","getItems","itemId","MediaLoaderEvent","loader","MediaLoaderPlayEvent","MediaLoaderPauseEvent","MediaLoaderDisposeEvent","MediaLoaderTimeUpdateEvent","MediaLoaderTimeSetEvent","MediaLoader","TextureLoader","getLoader","load","isMutedStream","isVideo","isStream","isPublisherStream","isAttendeeStream","isSmartDeviceStream","isPublisherScreen","isAttendeeScreen","isPlayableVideo","isAutoplayVideo","muted","muted_","toggle","subscription","volumeMuted","texture","onCanPlay","disposed","VideoTexture","minFilter","LinearFilter","magFilter","mapping","UVMapping","needsUpdate","readyState","HAVE_FUTURE_DATA","autoplay","loop","preload","playsInline","silent","pause","onTimeUpdate","onEnded","ontimeupdate","onended","loadTexture","wrapS","RepeatWrapping","wrapT","progress","currentTime","seekable","paused","Geometry","defaultGeometry","defaultGeometry_","BoxBufferGeometry","planeGeometry","planeGeometry_","PlaneBufferGeometry","sphereGeometry","sphereGeometry_","SphereBufferGeometry","panoramaGeometry","panoramaGeometry_","Vector3","Host","origin_","renderer","xr","isPresenting","getCamera","camera","localToWorld","fov","aspect","fitOffset","factor","atan","PI","heightDistance","zoom","widthDistance","Interactive","hittest","raycaster","down","dirty","lock","freezed","intersections","intersectObjects","hit","lastIntersectedObject","point","over","depthTest","FreezableMesh","Mesh","freezed_","__lookupGetter__","geometry","material","MeshBasicMaterial","color","freeze","unfreeze","EmittableMesh","InteractiveMesh","over_","down_","isInteractiveMesh","RGBELoader","DataTextureLoader","manager","HalfFloatType","rgbe_error","rgbe_error_code","msg","fgets","lineLimit","consume","len","fromCharCode","Uint16Array","subarray","byteLength","RGBEByteToRGBFloat","sourceArray","sourceOffset","destArray","destOffset","scale","RGBEByteToRGBHalf","DataUtils","toHalfFloat","byteArray","rgbe_header_info","gamma_re","exposure_re","format_re","dimensions_re","header","string","comments","programtype","gamma","exposure","line","charAt","parseFloat","RGBE_ReadHeader","w","h","image_rgba_data","scanline_width","data_rgba","ptr_end","rgbeStart","scanline_buffer","num_scanlines","ptr","isEncodedRun","byteValue","l","RGBE_ReadPixels_RLE","numElements","FloatType","floatArray","Float32Array","halfArray","setDataType","onProgress","texData","LinearEncoding","generateMipmaps","flipY","KeyboardService","keydown$_","keyup$_","keys$_","keydown$","keyup$","key$_","regexp","typing$_","key$","LOADER_UID","LoaderService","progress$","ref","loaded","total","switchLoaders","switchAll","subject","round","PrefetchServiceEvent","PrefetchService","worker_","Worker","worker","takeWhile","load$","Rect","rect","bottom","r1","r2","rect_","getClientRects","boundingRect","getBoundingClientRect","setCenter","setSize","center","contains","intersect","intersectRect","intersection_","scroll","COLORS","AvatarElement","headGeometry","headGeometry_","WebGLRenderer","setClearColor","setPixelRatio","devicePixelRatio","toneMapping","ACESFilmicToneMapping","outputEncoding","sRGBEncoding","domElement","PerspectiveCamera","lookAt","scene","Scene","light","PointLight","addHead","getRemoteById","canvas","ctx","CanvasTexture","MeshStandardMaterial","chalk","render","tick_","update","quaternion","vol","sin","smile","cos","fillStyle","fillRect","beginPath","arc","closePath","moveTo","bezierCurveTo","defaultTexture","defaultTexture_","gridTexture","gridTexture_","MediaPlayMesh","textureOff","textureOn","getTextureOff","transparent","playing","playing_","getTextureOn","onOut","getMaterial","colorOff","Color","getHex","colorOn","parentRatio","disposeMaterial","disposable","onOver","gsap","ease","Power2","easeInOut","MediaZoomMesh","zoomed","zoomed_","Object3D","onToggle","VERTEX_SHADER","FRAGMENT_CHROMA_KEY_SHADER","MediaMesh","useChromaKey","ShaderMaterial","depthWrite","toneMapped","vertexShader","fragmentShader","uniforms","mapResolution","mapTween","playMap","playMapResolution","playMapTween","playMapColor","extensions","fragDepth","chromaKeyColor","assetType","matcher","matchType","getTypeMatcher","getChromaKeyMaterial","editing","editing_","getMaterialByItem","getUniformsByItem","tempPosition","tempRotation","isAutoplayLoop","mediaLoader","onZoomed","addPlayBtn","addZoomBtn","userData","time","tick","playBtn","zoomBtn","onAppear","videoWidth","videoHeight","makePlayMap","aw","ah","imageSmoothingEnabled","imageSmoothingQuality","onload","br","drawImage","linkedPlayId","onUpdate","onDisappear","overwrite","setPlayingState","setZoomedState","setCurrentTime","disposeMediaLoader","removePlayBtn","removeZoomBtn","z","updateByItem","updateFromItem","fromArray","rotation","updateZoom","originalPosition","originalScale","originalQuaternion","copy","ratio","updateObjectMatrix","mat","projectionMatrix","elements","multiplyScalar","distance","getDistanceToCamera","getWorldDirection","DragPoint","DragEvent","DragDownEvent","strength","speed","DragMoveEvent","DragUpEvent","upEvent","DragService","MouseEvent","clientX","clientY","TouchEvent","touches","pageX","pageY","downEvent","button","originalEvent","getPosition","dismiss$","moveEvent","innerWidth","innerHeight","stopImmediatePropagation","dismissEvent","down$","move$","up$","OrbitMode","OrbitEvent","OrbitMoveEvent","orbitMoveEvent","orbitDragEvent","orbitResizeEvent","OrbitService","dolly","dolly_","clampedDolly","clamp","markAsDirty","getDollyValue","zoom_","getZoomValue","ZOOM_MAX","mode_","controlled","silenced","spyed","isMediaView","locked","direction","radius","inertia","Euler","updatePosition","updateTarget","setLongitudeLatitude","setOrientation","getOrientation","phi","degToRad","theta","observe$","keys$","Shift","Control","flip","walk","heading","normalize","headingTheta","atan2","headingLongitude","MathUtils","radToDeg","differenceLongitude","differenceLatitude","tween","onComplete","walkComplete","headingLatitude","worldToLocal","acos","setVRCamera","Quaternion","applyQuaternion","isDirty","cameraGroup","updateProjectionMatrix","ImageServiceEvent","ImageService","isBlob","isCors","auditTime","Blob","PanoramaLoader","cubeRenderTarget","cubeRenderTarget_","texture_","loadPublisherStreamBackground","loadAttendeeStreamBackground","loadVideoBackground","loadHlslVideoBackground","loadRgbeBackground","loadBackgroundImageService","progressRef","getRef","setProgress","revokeObjectURL","request","UnsignedByteType","onPlaying","isSupported","onPublisherStreamId","getPublisherStreamId$","onAttendeeStreamId","getAttendeeStreamId$","onStreamId","getStreamId$","onCubeMapDispose","BoxGeometry","getBlackMaterial","mesh","matrixWorld","copyPosition","cubeMap","isVideoTexture","updateCubeMapEquirectangularTexture","side","BackSide","fog","getShaderMaterial","cloneUniforms","ShaderLib","cube","EquirectangularReflectionMapping","toCubeMap","flipEnvMap","isCubeTexture","_needsFlipEnvMap","deleteAttribute","makeEnvMap","WebGLCubeRenderTarget","CubeUVReflectionMapping","RGBAFormat","setCubeMapEquirectangularTexture","mapTextureMapping","shader","tEquirect","blending","NoBlending","CubeCamera","previousMinFilter","LinearMipmapLinearFilter","dst","u","property","isColor","isMatrix3","isMatrix4","isVector2","isVector3","isVector4","isTexture","isQuaternion","CubeReflectionMapping","EquirectangularRefractionMapping","CubeRefractionMapping","onexit","uTween","crossfade","getLocalizedAsset","locale","localizedAsset","currentAsset","rgbe","R","PhoneStreamElement","setRemote","sx","sy","ceil","addStreamTexture","PhoneElement","phone","Group","PointerElement","sub","setPosition","TeleportElement","gravity","controllerPosition","controllerDirection","currentPosition","targetPosition","BufferGeometry","vertices","BufferAttribute","lineMaterial","LineBasicMaterial","vertexColors","AdditiveBlending","Line","addToController","controller","currentController","removeFromController","getWorldPosition","T","getPositionT","addScaledVector","vertex","toArray","XRStatus","VRService","service_","status$","state_","array","onSessionStarted","onSessionEnded","session$","currentSession","isSessionSupported","isSecureContext","toggleVR","sessionInit","optionalFeatures","requestSession","end","isDisabled","getLabel","updateState","world","Gamepad","gamepad","buttons","updateButtons","updateAxes","pressed","GamepadButton","axis","GamepadAxis","up","feedback","actuators","hapticActuators","pulse","GLTFLoader","Loader","dracoLoader","ktx2Loader","meshoptDecoder","pluginCallbacks","register","GLTFMaterialsClearcoatExtension","GLTFTextureBasisUExtension","GLTFTextureWebPExtension","GLTFMaterialsSheenExtension","GLTFMaterialsTransmissionExtension","GLTFMaterialsVolumeExtension","GLTFMaterialsIorExtension","GLTFMaterialsSpecularExtension","GLTFLightsExtension","GLTFMeshoptCompression","scope","resourcePath","LoaderUtils","extractUrlBase","itemStart","_onError","itemError","itemEnd","FileLoader","setResponseType","setRequestHeader","requestHeader","setWithCredentials","withCredentials","gltf","setDRACOLoader","setDDSLoader","setKTX2Loader","setMeshoptDecoder","unregister","content","decodeText","BINARY_EXTENSION_HEADER_MAGIC","EXTENSIONS","KHR_BINARY_GLTF","GLTFBinaryExtension","version","GLTFParser","fileLoader","extensionsUsed","extensionName","extensionsRequired","KHR_MATERIALS_UNLIT","GLTFMaterialsUnlitExtension","KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS","GLTFMaterialsPbrSpecularGlossinessExtension","KHR_DRACO_MESH_COMPRESSION","GLTFDracoMeshCompressionExtension","KHR_TEXTURE_TRANSFORM","GLTFTextureTransformExtension","KHR_MESH_QUANTIZATION","GLTFMeshQuantizationExtension","setExtensions","setPlugins","parseAsync","GLTFRegistry","objects","removeAll","KHR_LIGHTS_PUNCTUAL","KHR_MATERIALS_CLEARCOAT","KHR_MATERIALS_IOR","KHR_MATERIALS_SHEEN","KHR_MATERIALS_SPECULAR","KHR_MATERIALS_TRANSMISSION","KHR_MATERIALS_VOLUME","KHR_TEXTURE_BASISU","EXT_TEXTURE_WEBP","EXT_MESHOPT_COMPRESSION","refs","uses","_markDefs","nodeDefs","nodeIndex","nodeLength","nodeDef","_addNodeRef","_loadLight","lightIndex","cacheKey","lightDef","lights","lightNode","range","DirectionalLight","SpotLight","spot","innerConeAngle","outerConeAngle","angle","penumbra","decay","intensity","createUniqueName","createNodeAttachment","_getNodeRef","getMaterialType","extendParams","materialParams","materialDef","pending","metallicRoughness","pbrMetallicRoughness","baseColorFactor","baseColorTexture","assignTexture","materialIndex","materials","MeshPhysicalMaterial","extendMaterialParams","clearcoatFactor","clearcoat","clearcoatTexture","clearcoatRoughnessFactor","clearcoatRoughness","clearcoatRoughnessTexture","clearcoatNormalTexture","clearcoatNormalScale","sheenColor","sheenRoughness","sheen","sheenColorFactor","sheenRoughnessFactor","sheenColorTexture","sheenRoughnessTexture","transmissionFactor","transmission","transmissionTexture","thickness","thicknessFactor","thicknessTexture","attenuationDistance","colorArray","attenuationColor","ior","specularIntensity","specularFactor","specularTexture","specularColorFactor","specularColor","specularColorTexture","textureIndex","textureDef","loadTextureImage","images","textureLoader","handler","getHandler","detectSupport","onerror","loadBufferView","bufferView","bufferViews","extensionDef","getDependency","decoder","ready","byteOffset","stride","byteStride","ArrayBuffer","decodeGltfBuffer","BINARY_EXTENSION_CHUNK_TYPES","headerView","DataView","magic","getUint32","chunkContentsLength","chunkView","chunkIndex","chunkLength","chunkType","contentArray","decodePrimitive","primitive","bufferViewIndex","gltfAttributeMap","threeAttributeMap","attributeNormalizedMap","attributeTypeMap","attributeName","threeAttributeName","ATTRIBUTES","accessorDef","accessors","componentType","WEBGL_COMPONENT_TYPES","normalized","decodeDracoFile","extendTexture","texCoord","repeat","GLTFMeshStandardSGMaterial","isGLTFSpecularGlossinessMaterial","specularMapParsFragmentChunk","glossinessMapParsFragmentChunk","specularMapFragmentChunk","glossinessMapFragmentChunk","lightPhysicalFragmentChunk","specular","setHex","glossiness","specularMap","glossinessMap","_extraUniforms","onBeforeCompile","uniformName","defines","USE_SPECULARMAP","USE_GLOSSINESSMAP","USE_UV","metalness","roughness","metalnessMap","roughnessMap","setValues","specularGlossinessParams","pbrSpecularGlossiness","diffuseFactor","diffuseTexture","emissive","glossinessFactor","specularGlossinessTexture","specGlossMapDef","createMaterial","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","TangentSpaceNormalMap","normalScale","displacementMap","displacementScale","displacementBias","alphaMap","envMapIntensity","refractionRatio","GLTFCubicSplineInterpolant","Interpolant","parameterPositions","sampleValues","sampleSize","resultBuffer","copySampleValue_","valueSize","beforeStart_","afterEnd_","interpolate_","i1","t0","t1","stride2","stride3","td","pp","ppp","offset1","offset0","s2","s3","s0","s1","p0","m0","p1","m1","_q","GLTFCubicSplineQuaternionInterpolant","WEBGL_CONSTANTS","Int8Array","Int16Array","Uint32Array","WEBGL_FILTERS","NearestFilter","NearestMipmapNearestFilter","LinearMipmapNearestFilter","NearestMipmapLinearFilter","WEBGL_WRAPPINGS","ClampToEdgeWrapping","MirroredRepeatWrapping","WEBGL_TYPE_SIZES","SCALAR","VEC2","VEC3","VEC4","MAT2","MAT3","MAT4","POSITION","NORMAL","TANGENT","TEXCOORD_0","TEXCOORD_1","COLOR_0","WEIGHTS_0","JOINTS_0","PATH_PROPERTIES","translation","weights","INTERPOLATION","CUBICSPLINE","LINEAR","InterpolateLinear","STEP","InterpolateDiscrete","ALPHA_MODES","addUnknownExtensionsToUserData","knownExtensions","objectDef","gltfExtensions","assignExtrasToUserData","gltfDef","extras","updateMorphTargets","meshDef","morphTargetInfluences","targetNames","morphTargetDictionary","createPrimitiveKey","primitiveDef","dracoExtension","geometryKey","createAttributesKey","attributesKey","getNormalizedComponentScale","associations","Map","primitiveCache","meshCache","cameraCache","lightCache","sourceCache","textureCache","nodeNamesUsed","createImageBitmap","ImageBitmapLoader","setCrossOrigin","_invokeAll","ext","beforeRoot","scenes","animations","cameras","afterRoot","skinDefs","skins","meshDefs","meshes","skinIndex","skinLength","joints","isBone","skin","isSkinnedMesh","updateMappings","original","mappings","entries","_invokeOne","func","loadScene","loadNode","loadMesh","loadAccessor","loadBuffer","loadMaterial","loadSkin","loadAnimation","loadCamera","defs","def","bufferIndex","bufferDef","buffers","resolveURL","bufferViewDef","accessorIndex","sparse","pendingBufferViews","itemSize","TypedArray","elementBytes","BYTES_PER_ELEMENT","itemBytes","bufferAttribute","ibSlice","ibCacheKey","ib","InterleavedBuffer","InterleavedBufferAttribute","itemSizeIndices","TypedArrayIndices","byteOffsetIndices","byteOffsetValues","sparseIndices","sparseValues","setX","setY","setZ","setW","sourceIndex","sourceDef","sampler","promise","loadImageSource","samplers","webkitURL","sourceURI","isObjectURL","blob","mimeType","isImageBitmapLoader","imageBitmap","mapName","mapDef","gltfReference","assignFinalMaterial","useDerivativeTangents","tangent","useVertexColors","useFlatShading","normal","isPoints","pointsMaterial","PointsMaterial","Material","sizeAttenuation","isLine","cachedMaterial","flatShading","uv2","uv","materialType","materialExtensions","sgExtension","kmuExtension","metallicFactor","roughnessFactor","metallicRoughnessTexture","doubleSided","DoubleSide","alphaMode","alphaTest","alphaCutoff","normalTexture","occlusionTexture","emissiveFactor","emissiveTexture","sheenColorMap","specularColorMap","originalName","sanitizedName","PropertyBinding","sanitizeNodeName","loadGeometries","primitives","createDracoPrimitive","addPrimitiveAttributes","cached","geometryPromise","meshIndex","FrontSide","results","geometries","SkinnedMesh","skinWeight","normalizeSkinWeights","toTrianglesDrawMode","TriangleStripDrawMode","TriangleFanDrawMode","LineSegments","LineLoop","Points","morphAttributes","cameraIndex","cameraDef","yfov","aspectRatio","znear","zfar","OrthographicCamera","xmag","ymag","skinDef","skinEntry","inverseBindMatrices","accessor","animationIndex","animationDef","pendingNodes","pendingInputAccessors","pendingOutputAccessors","pendingSamplers","pendingTargets","channels","parameters","output","inputAccessors","outputAccessors","targets","tracks","inputAccessor","outputAccessor","TypedKeyframeTrack","updateMatrix","matrixAutoUpdate","NumberKeyframeTrack","QuaternionKeyframeTrack","VectorKeyframeTrack","targetName","interpolation","traverse","outputArray","scaled","createInterpolant","times","getValueSize","isInterpolantFactoryMethodGLTFCubicSpline","AnimationClip","createNodeMesh","isMesh","nodeName","meshPromise","Bone","matrix","Matrix4","applyMatrix4","sceneIndex","sceneDef","nodeIds","buildNodeHierarchy","reducedAssociations","reduceAssociations","nodeId","parentObject","pendingJoints","jointNodes","bones","boneInverses","jointNode","Skeleton","assignAttributeAccessor","gltfAttributeName","setIndex","box","Box3","boxScale","maxDisplacement","vector","expandByVector","boundingBox","sphere","Sphere","getCenter","distanceTo","boundingSphere","computeBounds","hasMorphPosition","hasMorphNormal","hasMorphColor","pendingPositionAccessors","pendingNormalAccessors","pendingColorAccessors","pendingAccessor","morphPositions","morphNormals","morphColors","morphTargetsRelative","addMorphTargets","drawMode","getIndex","numberOfTriangles","newIndices","getX","newGeometry","Constants","Handedness","LEFT","RIGHT","ComponentState","DEFAULT","TOUCHED","PRESSED","ComponentProperty","BUTTON","X_AXIS","Y_AXIS","STATE","ComponentType","TRIGGER","SQUEEZE","TOUCHPAD","THUMBSTICK","ButtonTouchThreshold","AxisTouchThreshold","VisualResponseProperty","TRANSFORM","VISIBILITY","defaultComponentValues","xAxis","yAxis","async","fetchJsonFile","fetchProfile","xrInputSource","basePath","defaultProfile","getAssetPath","supportedProfilesList","fetchProfilesList","profileId","supportedProfile","profilePath","deprecated","assetPath","layout","handedness","layouts","VisualResponse","visualResponseDescription","componentProperty","states","valueNodeName","valueNodeProperty","minNodeName","maxNodeName","updateFromComponent","normalizedXAxis","normalizedYAxis","normalizeAxes","includes","componentId","componentDescription","visualResponses","gamepadIndices","rootNodeName","touchPointNodeName","responseName","visualResponse","updateFromGamepad","gamepadButton","MotionController","assetUrl","layoutDescription","gripSpace","targetRaySpace","component","XRControllerModel","motionController","setEnvironmentMap","updateMatrixWorld","valueNode","minNode","maxNode","MotionControllerConstants","visible","slerpQuaternions","lerpVectors","addAssetSceneToControllerModel","controllerModel","touchPointNode","getObjectByName","SphereGeometry","findNodes","XRControllerModelFactory","gltfLoader","_assetCache","createControllerModel","targetRayMode","cachedAsset","ZERO","DOWN","CONTROL_INFO","WorldComponent","error_","view_","setView","debugging","lockedOrXR","showMenu","showPointer","menu_","loading","waiting","avatars","createScene","addListeners","animate","removeListeners","setAnimationLoop","mouse","controllerMatrix_","controllerWorldPosition_","controllerWorldDirection_","worldRect","fromNode","cameraRect","offsetWidth","offsetHeight","orbitService","logarithmicDepthBuffer","powerPreference","insertBefore","Raycaster","setFromCamera","addEnvironment","panoramaIntersectObjects","indicator","light1","light2","light3","light4","ambient","AmbientLight","addControllers","resize","complete","toggleLights","direct","filename","isHdr","background","setBackground","addOffCanvasScene","avatar","removeOffCanvasScene","updateOffCanvasScene","zoomedId","onUpdateAsset","requestInfoResult","gridIndex","onViewAssetDidChange","setViewOrientation","controllerGroup","teleport","controllers","controllerModelFactory","addController","showPhone","live","getController","setController","onPress","onRelease","onModelUp","onLeft","onRight","onAxis","onModelDistance","isSelecting","buildController","controllerGrip","getControllerGrip","Float32BufferAttribute","RingBufferGeometry","translate","updateRaycasterXR","identity","extractRotation","ray","setFromMatrixPosition","repos","tx","ty","delta","ticker","navWithKeys","vrService","raycasterXRHitTest","velocity","ArrowUp","ArrowDown","d","ArrowRight","axisY","applyAxisAngle","ArrowLeft","manhattanLength","navIntersectObjects","lerp","tan","updateRaycasterMouse","w2","h2","raycasterDesktopHitTest","dragItem","onDragMove","intersectionPoint","intersectionNormal","face","resizeItem","controlEvent$","onMouseDown","viewHit","spherical","isTouchDevice","showPanel","onMouseMove","onMouseUp","onDragEnd","dragEnd","onResizeEnd","resizeEnd","checkSelectedItem","onMouseWheel","deltaY","wheelDeltaY","Power4","easeOut","onOrientationDidChange","onVRStarted","onVREnded","onVRStateDidChange","onMenuNav","navTo","onMenuToggle","onNavOver","shouldShowPanel","onNavOut","onNavDown","onNavLink","linkIndex","navLink","maxTouchPoints","msMaxTouchPoints","onModelDown","onObjectDown","tempTarget","tempParent","onPanelDown","onPlayMedia","onZoomMedia","onCurrentTimeMedia","onPlayModel","actionIndex","onGridMove","onGridNav","setSnapshot","getSnapshot","sendSetSnapshot","control$","getService","setSession","removeMenu","ModelComponent","getContainer","onCreate","onMount","onDismount","disposeObject","rxcompId","mounth","dismount","setVisible","isInteractiveSprite","isSprite","calculateScaleAndPosition","getScroll","getTween","ModelEditableComponent","setHelper","RADIUS","showHelper","helper","BoxHelper","updateHelper","setFromObject","NavModeType","ModelNavComponent","hidden_","isMobile_","texturePoint","texturePointImportant","textureMove","textureMoveImportant","textureInfo","textureInfoImportant","textureWishlist","textureWishlistAdded","important","getTextureMoveImportant","getTextureMove","getTextureInfoImportant","getTextureInfo","getTexturePointImportant","getTexturePoint","added","getTextureWishlistAdded","getTextureWishlist","font","measureText","textAlign","textBaseline","strokeStyle","lineWidth","lineJoin","miterLimit","strokeText","fillText","hook","getNavMode","hidden","updateVisibility","isHidden","isAnimated","isMobile","setScale","icon","onCreateSprites","mount","opacityIdle","opacityOver","opacityDown","yoyo","shouldNavToLink","normalizedPosition","distanceToSquared","onRemoveSprite","getTexture","SpriteMaterial","Sprite","titleMaterial","titleTexture","getTitleTexture","sprite","AgoraComponent","meetingUrl_","isVirtualTourUser","isEmbed","isSelfServiceTour","isNavigable","isBackButtonVisible","isSelfServiceProposition","isSelfServiceSupport","showNavInfoToggler","hasNavInfo","uiClass","remoteScreen","hasScreenViewItem","remoteClass","remoteScreen_","previousView","resolveUser","getLinkRole","linkRole","initWithUser","overrideUser$","userGuard","userGuardRedirect","setNextStatus","getPathId","getMode","getMeetingName","initAgora","viewObserver$","hostedView$","setNavmap","userType","loadNavmaps","navmapGet$","toggleNavmap","showNavmap","onNavmapItem","onNavTo","loadAndConnect","checkSelfServiceProposition","checkSelfServiceAudio","isChecked$","orderedRemotes$","openSupportRequestDialog","onRemoteNavTo","hidePanels","setViewLike$","showLove","chatDirty","fullscreen$","onChecked","onLink","onName","sharedMeetingId","log$","toggle$","toggleVolume","toggleFullScreen","fullScreen","requestFullscreen","webkitRequestFullscreen","msRequestFullscreen","exitFullscreen","webkitExitFullscreen","msExitFullscreen","fullscreenElement","toggleChat","onChatClose","onToggleSilence","addLike","viewLike$","skipTimeout","tryInAr","openInAR","selfServiceSupportRequest$","AssetService","lg","files","formData","FormData","append","xhr","XMLHttpRequest","upload","responseText","uploads","fromUrl","assetUpdate$","assetCreate$","localizedAssetUpdate$","localizedAssetCreate$","current","previousId","previousFile","currentId","currentFile","EditorService","tileItemCreate$","itemCreate$","tileItemUpdate$","itemUpdate$","tileItemDelete$","itemDelete$","currentItem","CurvedPlaneModalComponent","inferItemCreate$","ItemModelModalComponent","MediaModalComponent","viewCreate$","ModelModalComponent","NavModalComponent","useHooks","hookExtra","viewIdOptions$","onViewIdDidChange","navAutoUpdateTitle","selectedOption","currentTitle","PanoramaGridModalComponent","PanoramaModalComponent","PathAddModalComponent","pathCreate$","PathEditModalComponent","parseViews","onToggleView","pathUpdate$","onSelectAll","onSelectNone","PlaneModalComponent","RemoveModalComponent","onRemove","onCancel","Room3DModalComponent","SETTINGS","EditorComponent","settings","getSettings","aside","initState","editorView$","onAddPath","addPath","onEditPath","editPath","onDuplicatePath","onDeletePath","pathDelete$","deletePath","onSelectPath","isPathSelected","onToggleAside","onToggleSettings","onSelectSetting","onViewHit","onViewHitted","viewHitSubscription","inferItemUpdate$","onWorldSelect","selectedItem","onOpenModal","addView","onAsideSelect","currentTile","onAsideUpdate","assetDidChange","onAsideDelete","inferItemDelete$","inferItemDeleteResult$","viewDelete$","deleteView","GenericService","page$","GenericComponent","page","currentLanguagePage$","LayoutComponent","languageService","setLanguage","setLanguage$","toggleLanguages","TryInARComponent","missingAr","missingUsdz","missingGltf","usdzSrc","getUsdzSrc","getGltfSrc","modelViewerNode","getModelViewerNode","addARScripts","script","usdz","getViewId","environmentImage","skyboxImage","gltfSrc","AppComponent","setRoute","MIME_IMAGE","MIME_VIDEO","MIME_MODEL","MIME_STREAM","AssetPipe","isModel","ControlRequestModalComponent","onAccept","onReject","DropDirective","Directive","expression","outputFunction","makeFunction","DROPDOWN_ID","DropdownDirective","dropdown","id_","nextId","trigger","opened","onClick","onDocumentClick","openDropdown","closeDropdown","dropdown$","addDocumentListeners","dropped","removeDocumentListeners","DropdownItemDirective","ToastOutletComponent","lastToast","getClass","AsideComponent","viewTypes","getKeys","disabled","viewItemTypes","setSupportedViewTypes","setSupportedViewItemTypes","supportedViewTypes","supportedViewType","supportedViewItemTypes","supportedViewItemType","setMode","viewTypeName","viewItemTypeName","onDelete","MENU_UID","MenuService","getMenu$","menu$_","parentId","menu$","mapMenuItems","typeName","mapMenuItem","DropService","isPlatformBrowser","dataTransfer","previews","change$","uploads$","read$","upload$","reader","FileReader","reader$","resize$","resized","readAsDataURL","resize_","img","toDataURL","ControlComponent","ControlAssetComponent","accept","drop$","createOrUpdateAsset$","ControlMenuComponent","FormArray","dropdownId","onAddItem","createMenuItem$","itemToFormGroup","onRemoveItem","onRemoveControl","deleteMenuItem$","onLinkItem","onLinkControl","onItemUp","onItemDown","onUpControl","insert","onDownControl","updateMenuItem$","switchSubjects_","onTextDidChange","hasOption","onDropped","MenuBuilderComponent","menuToControls","controlsToMenu","updateMenu$","subitems","pushItem","menuItem","NavmapItemModalComponent","NavmapModalComponent","navmapCreate$","NavmapBuilderComponent","onSet","NavmapModes","ControlEvent","ControlDownEvent","ControlMoveEvent","ControlUpEvent","NavmapEditComponent","insert$","onToggleMode","onMoveItem","diff","item_","navmapUpdate$","navmapDelete$","UpdateViewItemComponent","originalItem","hasChromaKeyColor","doUpdateForm","doUpdateItem","getFlagsDidChange","getAssetDidChange","flagsDidChange","formArray","removeKey","optional","onAssetTypeDidChange","currentType","asset$","inferItemUpdateResult$","getTitle","onAddLink","onRemoveLink","msec","UpdateViewTileComponent","UpdateViewComponent","doUpdateView","orbit$","didChange","usdzDidChange","gltfDidChange","viewUpdate$","factories","pipes","EditorModule","Module","imports","declarations","IframeModalComponent","EnvPipe","keypath","env","shift","FlagPipe","UploadItem","uploading","UploadEvent","UploadStartEvent","UploadCompleteEvent","UploadAssetEvent","UploadService","concurrent$","uploadItems","uploadItem$","delayWhen","addItems","newItems","dropArea","files$","file$","uploadFile$","ControlAssetsComponent","uploadCount","multiple","hasFiles","service","onUpload","onItemPause","onItemResume","onItemCancel","onItemRemove","GenericModalComponent","ControlCheckboxComponent","linksSubject","links$","querySelectorAll","ControlCustomSelectComponent","typing$","word","scrollToWord","scrollTo","offsetTop","isMultiple","ControlLinkComponent","onInputDidBlur","ControlLocalizedAssetComponent","localizedValue","currentLanguage","createOrUpdateLocalizedAsset$","ControlModelComponent","assetDelete$","ControlNumberComponent","precision","increment","updateValue","ControlPasswordComponent","ControlSelectComponent","ControlTextComponent","ControlTextareaComponent","ControlVectorComponent","DisabledDirective","ErrorsComponent","InputValueComponent","increment$","keyCode","NaN","sign","race","toFixed","setValue","TestComponent","onTest","onReset","ValueDirective","HtmlPipe","unescapes","rx","IdDirective","LanguageComponent","LazyCache","cache_","LazyDirective","input$","lazy$","lazy","observer_","readySubject_","observerSubject_","IntersectionObserver","observe","entry","isIntersecting","unobserve","intersection$","MessagePipe","urlify","breakLines","ModalComponent","RouterLinkDirective","routerLink_","routerLink$","getSegments","regExp","matches","matchAll","RouteSegment","SupportRequestModalComponent","SvgIconStructure","name_","xmlns","createElementNS","setAttributeNS","replaceChild","TitleDirective","title_","UploadItemComponent","onPause","onResume","resume","HlsDirective","hls_","VirtualItem","Context","$key","$value","last","even","odd","VirtualMode","VirtualStructure","getExpressionTokens","virtualFunction","iterable","gutter","containerWidth","containerHeight","cols","cachedRects","cachedInstances","cacheNodes","update$","visibleItems","updateView","scroll$","updateForward","highestHeight","getWidth","getGutter","col","getCol","getHeight","getLeft","cachedNode","removeNode","removeIndex","parentContainer","getCols","updateNode","createNode","clonedNode","cloneNode","forItemContext","top1","bottom1","top2","bottom2","getComputedStyle","overflowY","trim","expressions","virtualExpressions","keyValueMatches","indexExpressions","MediaPlayerComponent","media$","drag$","dragging","initialProgress","onPlay","onTrack","currentTarget","screenX","PANEL_RADIUS","PANORAMA_RADIUS","ModelBannerComponent","updateBanner","createBanner","getCanvasTexture","wrapY","CylinderBufferGeometry","banners","W","H","F","L","clearRect","ModelCurvedPlaneComponent","getCurvedPanelGeometry","onMeshDown","onMeshPlaying","onMeshZoomed","onMeshCurrentTime","disposableMesh","addMeshListeners","removeMeshListeners","radius_","height_","arc_","take","rotateY","DebugService","setMessage","ModelDebugComponent","FontLoader","fontLoader","message_","setText","textGroup","debugService","createText","loadFont","getFontLoader","ModelGridComponent","textureOver","coords","coords_","tileMap","previousTile","previousUniforms","currentUniforms","coords__","getCoords","outerTileSize","row","dx","COLS","dy","ROWS","ci","ri","moveToIndex","addTiles","innerTileSize","rotateX","mapOver","getOverTexture","textureA","textureB","showTiles","ix","iy","addHitArea","onGroundOver","onGroundMove","onGroundDown","onGroundOut","ground","move","MenuButton","G","geometry_","ModelMenuComponent","FRAGMENT_SHADER","resolutionA","resolutionB","getTextureA","getTextureB","getY","writeText","setFont","lineHeight","FONT_SIZE","LINE_HEIGHT","lines","getLines","lineCount","maxWidth","words","currentLine","BackButton","loading_","onDown","progressIndicator","strokeDashoffset","menuGroup","rootItems","getModelMenu$","addMenu","back","backItem","stagger","getGrid","amount","removeButtons","removeToggler","addToggler","toggler","_taskCache","WeakMap","DRACOLoader","decoderPath","decoderConfig","decoderBinary","decoderPending","workerLimit","workerPool","workerNextTaskID","workerSourceURL","defaultAttributeIDs","defaultAttributeTypes","setDecoderPath","setDecoderConfig","setWorkerLimit","taskConfig","attributeIDs","attributeTypes","useUniqueIDs","decodeGeometry","taskKey","cachedTask","taskID","taskCost","geometryPending","_getWorker","_worker","_callbacks","_createGeometry","_releaseTask","geometryData","_loadLibrary","responseType","_initDecoder","useJS","WebAssembly","librariesPending","libraries","jsContent","wasmBinary","DRACOWorker","lastIndexOf","_taskCosts","_taskLoad","onmessage","terminate","decodeAttribute","draco","dracoGeometry","attributeType","numComponents","num_components","numValues","num_points","dataType","DT_FLOAT32","DT_INT8","DT_INT16","Int32Array","DT_INT32","DT_UINT8","DT_UINT16","DT_UINT32","getDracoDataType","_malloc","GetAttributeDataArrayForAllPoints","HEAPF32","_free","onModuleLoaded","DracoDecoderModule","Decoder","decoderBuffer","DecoderBuffer","Init","decodingStatus","geometryType","GetEncodedGeometryType","TRIANGULAR_MESH","DecodeBufferToMesh","POINT_CLOUD","PointCloud","DecodeBufferToPointCloud","error_msg","attributeID","GetAttributeByUniqueId","GetAttributeId","GetAttribute","numIndices","num_faces","GetTrianglesUInt32Array","decodeIndex","destroy","ModelModelComponent","loadGlb","onGlbLoaded","glb","progressEvent","parseAnimations","dummy","endY","makeInteractive","actions","clock","Clock","mixer","AnimationMixer","timeScale","animation","clipAction","setEffectiveTimeScale","setEffectiveWeight","setLoop","LoopRepeat","onClipToggle","setSingleAction","setMultiAction","halt","previousClip","getDelta","descriptors","interactiveDescriptors","freezableDescriptors","emittableDescriptors","getInteractiveDescriptors","FreezableSprite","EmittableSprite","InteractiveSprite","ModelPanelComponent","textureWidth","textureHeight","viewed","xy","linkNodes","linkNode","offsetLeft","mouseEvent","movementX","movementY","relatedTarget","screenY","imagesLoaded","promises","cors","panelTexture","useCORS","backgroundColor","ModelPictureComponent","ModelPlaneComponent","ModelProgressComponent","visible_","updateProgress","show","hide","inner","createMesh","ModelRoomComponent","transparentMaterial","transparentMaterial_","makeTransparent","ModelTextComponent","fixLegacy","AppModule","CoreModule","FormModule","bootstrap","Browser"],"mappings":"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","file":"docs\\js\\main.min.js","sourcesContent":[null,"export const CHUNK_REMOTE = /* html */`\r\n<!-- remote sidebar -->\r\n<div class=\"group--remote\" [class]=\"remoteClass\" *if=\"state.live\">\r\n\t<div class=\"agora-stream\" (toggleControl)=\"onToggleControl($event)\" (toggleSpy)=\"onToggleSpy($event)\" agora-stream [stream]=\"remote\" type=\"remote\" *for=\"let remote of remotes\">\r\n\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t<div class=\"agora-stream__info\" [class]=\"{ spyed: state.spying == streamId, controlling: state.controlling == streamId }\">\r\n\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t\t<div class=\"id\" [innerHTML]=\"stream.clientInfo.name || streamId\" *if=\"stream.clientInfo\"></div>\r\n\t\t\t<button type=\"button\" class=\"btn--control\" [title]=\"'title_control' | label\" (click)=\"onToggleControl(streamId)\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t<svg class=\"control\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#control\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"btn--spy\" [title]=\"'title_spy' | label\" (click)=\"onToggleSpy(streamId)\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#spy\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"group--members\" *if=\"state.mode == 'virtual-tour'\">\r\n\t\t<div class=\"members\" *if=\"state.role === 'publisher'\">\r\n\t\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#users\"></use></svg>\r\n\t\t\t<span class=\"members__count\" [innerHTML]=\"state.membersCount\"></span>\r\n\t\t</div>\r\n\t\t<div class=\"credits\">\r\n\t\t\t<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\">\r\n\t\t\t\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t\t</a>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n<!-- remote screen -->\r\n<div class=\"group--remote-screen\" *if=\"remoteScreen\">\r\n\t<div class=\"agora-stream\" agora-stream [stream]=\"remoteScreen\" type=\"remote\">\r\n\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t<div class=\"agora-stream__info\">\r\n\t\t\t<div class=\"id\" [innerHTML]=\"stream.clientInfo.name || streamId\" *if=\"stream.clientInfo\"></div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_SERVICE = /* html */`\r\n<!-- service -->\r\n<div class=\"group--service\">\r\n\t<button type=\"button\" class=\"btn--back\" [title]=\"'title_back' | label\" (click)=\"onBack($event)\" *if=\"isBackButtonVisible\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#arrow-prev\"></use></svg>\r\n\t</button>\r\n\t<button type=\"button\" class=\"btn--view-mode\" [title]=\"'title_view_mode' | label\" (click)=\"toggleMode($event)\" *if=\"state.mode != 'embed'\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.mode == 'virtual-tour'\"><use xlink:href=\"#live-meeting\"></use></svg>\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.mode == 'live-meeting'\"><use xlink:href=\"#virtual-tour\"></use></svg>\r\n\t</button>\r\n\t<button type=\"button\" class=\"btn--volume\" [title]=\"'title_volume' | label\" [class]=\"{ muted: state.volumeMuted }\" (click)=\"toggleVolume($event)\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.volumeMuted\"><use xlink:href=\"#volume-on\"></use></svg>\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.volumeMuted\"><use xlink:href=\"#volume-off\"></use></svg>\r\n\t</button>\r\n\t<button type=\"button\" class=\"btn--fullscreen\" [title]=\"'title_fullscreen' | label\" [class]=\"{ muted: state.fullScreen }\" (click)=\"toggleFullScreen($event)\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.fullScreen\"><use xlink:href=\"#fullscreen-on\"></use></svg>\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.fullScreen\"><use xlink:href=\"#fullscreen-off\"></use></svg>\r\n\t</button>\r\n\t<button type=\"button\" class=\"btn--navmap\" [title]=\"'title_navmap' | label\" [class]=\"{ active: state.showNavmap }\" (click)=\"toggleNavmap($event)\" *if=\"navmap && state.mode != 'live-meeting'\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#navmap\"></use></svg>\r\n\t</button>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_LOCAL = /* html */`\r\n<!-- local streams -->\r\n<div class=\"group--local\" [class]=\"{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }\" *if=\"state.live\">\r\n\t<button type=\"button\" class=\"btn--silence\" [title]=\"'title_silence' | label\" [class]=\"{ active: state.silencing }\" (click)=\"onToggleSilence()\" *if=\"state.role === 'publisher'\">\r\n\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t</button>\r\n\t<button type=\"button\" class=\"btn--control\" [title]=\"'title_control' | label\" [class]=\"{ active: state.controlling == state.uid }\" (click)=\"onToggleControl(state.uid)\" *if=\"state.role == 'publisher'\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#control\"></use></svg>\r\n\t</button>\r\n\t<div class=\"agora-stream\" *if=\"!local\"></div>\r\n\t<div class=\"agora-stream\" agora-stream [stream]=\"local\" type=\"local\" *if=\"local\">\r\n\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t<div class=\"agora-stream__info\">\r\n\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"agora-stream agora-stream--screen\" agora-stream [stream]=\"screen\" type=\"local\" *if=\"screen && hasScreenViewItem\">\r\n\t\t<div class=\"agora-stream__player\"></div>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_LOCAL_SMART_DEVICE = /* html */`\r\n<!-- local streams -->\r\n<div class=\"group--local\" [class]=\"{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }\" *if=\"state.live\">\r\n\t<div class=\"agora-stream\" agora-stream [stream]=\"local\" type=\"local\" *if=\"local\">\r\n\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t<div class=\"agora-stream__info\">\r\n\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_CONTROLS = /* html */`\r\n<!-- controls -->\r\n<div class=\"group--controls\" *if=\"state.live\">\r\n\t<div class=\"group--actions\">\r\n\t\t<button type=\"button\" class=\"btn--call\" [title]=\"'title_disconnect' | label\" (click)=\"disconnect()\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#call\"></use></svg>\r\n\t\t</button>\r\n\t\t<button type=\"button\" class=\"btn--cam\" [title]=\"'title_mute_camera' | label\" [class]=\"{ muted: state.cameraMuted, disabled: !local }\" (click)=\"toggleCamera()\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam\"></use></svg>\r\n\t\t</button>\r\n\t\t<button type=\"button\" class=\"btn--mic\" [title]=\"'title_mute_mic' | label\" [class]=\"{ muted: state.audioMuted, disabled: !local || silenced }\" (click)=\"toggleAudio()\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic\"></use></svg>\r\n\t\t</button>\r\n\t\t<button type=\"button\" class=\"btn--screen\" [title]=\"'title_share_screen' | label\" [class]=\"{ active: screen }\" (click)=\"toggleScreen()\" *if=\"('screenShare' | flag) && (state.role == 'publisher' || state.role == 'attendee' || controlling)\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#screen\"></use></svg>\r\n\t\t</button>\r\n\t\t<button type=\"button\" class=\"btn--chat\" [title]=\"'title_chat' | label\" [class]=\"{ active: state.chatDirty }\" (click)=\"toggleChat()\" *if=\"('chat' | flag)\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#chat\"></use></svg>\r\n\t\t</button>\r\n\t\t<button type=\"button\" class=\"btn--navinfo\" [title]=\"'title_navinfo' | label\" [class]=\"{ active: state.showNavInfo }\" (click)=\"toggleNavInfo()\" *if=\"showNavInfoToggler\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#navinfo\"></use></svg>\r\n\t\t</button>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_CONTROLS_SMART_DEVICE = /* html */`\r\n<!-- controls -->\r\n<div class=\"group--controls\" *if=\"state.live\">\r\n\t<div class=\"group--actions\">\r\n\t\t<button type=\"button\" class=\"btn--call\" [title]=\"'title_disconnect' | label\" (click)=\"disconnect()\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#call\"></use></svg>\r\n\t\t</button>\r\n\t\t<button type=\"button\" class=\"btn--cam\" [title]=\"'title_mute_camera' | label\" [class]=\"{ muted: state.cameraMuted, disabled: !local }\" (click)=\"toggleCamera()\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam\"></use></svg>\r\n\t\t</button>\r\n\t\t<button type=\"button\" class=\"btn--mic\" [title]=\"'title_mute_mic' | label\" [class]=\"{ muted: state.audioMuted, disabled: !local || silenced }\" (click)=\"toggleAudio()\">\r\n\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic\"></use></svg>\r\n\t\t</button>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_MEMBERS = /* html */`\r\n<!-- members -->\r\n<div class=\"group--members\" *if=\"state.mode == 'live-meeting'\">\r\n\t<div class=\"members\" *if=\"state.role === 'publisher'\">\r\n\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#users\"></use></svg>\r\n\t\t<span class=\"members__count\" [innerHTML]=\"state.membersCount\"></span>\r\n\t</div>\r\n\t<div class=\"credits\">\r\n\t\t<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\">\r\n\t\t\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t</a>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_MEMBERS_SMART_DEVICE = /* html */`\r\n<!-- members -->\r\n<div class=\"group--members\">\r\n\t<div class=\"members\" *if=\"state.role === 'publisher'\">\r\n\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#users\"></use></svg>\r\n\t\t<span class=\"members__count\" [innerHTML]=\"state.membersCount\"></span>\r\n\t</div>\r\n\t<div class=\"credits\">\r\n\t\t<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\">\r\n\t\t\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t</a>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_MEDIA = /* html */`\r\n<!-- media -->\r\n<div class=\"group--media\" media-player>\r\n\t<button type=\"button\" class=\"btn--play\" [title]=\"'title_play' | label\" (click)=\"onPlay()\" *if=\"!playing\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#play\"></use></svg>\r\n\t</button>\r\n\t<button type=\"button\" class=\"btn--pause\" [title]=\"'title_pause' | label\" (click)=\"onPause()\" *if=\"playing\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#pause\"></use></svg>\r\n\t</button>\r\n\t<div class=\"track\" (click)=\"onTrack($event)\">\r\n\t\t<div class=\"track__progress\" [style]=\"{ transform: 'scale(' + this.progress + ', 1)'}\"></div>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_AR_VR = /* html */`\r\n<!-- ar-vr -->\r\n<div class=\"group--ar-vr\">\r\n\t<button type=\"button\" class=\"btn--ar\" [title]=\"'title_ar' | label\" [href]=\"view?.ar\" (click)=\"tryInAr()\" *if=\"view?.ar\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#ar\"></use></svg> <span>Try in AR</span>\r\n\t</button>\r\n\t<button type=\"button\" class=\"btn--vr\" [title]=\"'title_vr' | label\" [class]=\"{ disabled: vrService.isDisabled() }\" (click)=\"vrService.toggleVR()\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#vr\"></use></svg> <span [innerHTML]=\"vrService.getLabel()\"></span>\r\n\t</button>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_LIKE = /* html */`\r\n<!-- like -->\r\n<div class=\"group--heart\" *if=\"view && ('like' | flag)\">\r\n\t<svg class=\"love\" [class]=\"{ active: view.showLove }\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#heart\"></use></svg>\r\n\t<button type=\"button\" class=\"btn--heart\" [class]=\"{ active: view.showLove }\" (click)=\"addLike($event)\">\r\n\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#heart\"></use></svg>\r\n\t\t<span class=\"badge\" [innerHTML]=\"view.likes\" *if=\"view.likes\"></span>\r\n\t</button>\r\n</div>\r\n<div class=\"group--spacer\" *if=\"!view || !('like' | flag)\"></div>\r\n`;\r\n\r\nexport const CHUNK_CHAT = /* html */`\r\n<!-- chat -->\r\n<div class=\"group--chat\" *if=\"state.chat\" agora-chat (close)=\"onChatClose()\"></div>\r\n`;\r\n\r\nexport const CHUNK_LOCK = /* html */`\r\n<!-- lock -->\r\n<div class=\"ui__lock\" [class]=\"{ spying: spying }\" *if=\"locked || controlling\"></div>\r\n`;\r\n\r\nexport const CHUNK_NAVMAP = /* html */`\r\n<!-- navmap -->\r\n<div class=\"group--navmap\" *if=\"navmap && state.showNavmap && state.mode != 'live-meeting'\">\r\n\t<img draggable=\"false\" [src]=\"navmap.asset | asset\" *if=\"navmap.asset\" />\r\n\t<div class=\"navmap__item\" [style]=\"{ left: item.position[0] * 100 + '%', top: item.position[1] * 100 + '%' }\" (click)=\"onNavmapItem(item)\" *for=\"let item of navmap.items\">\r\n\t\t<img draggable=\"false\" [src]=\"'textures/ui/nav-point.png' | asset\" />\r\n\t\t<div class=\"title\" [innerHTML]=\"item.title\" *if=\"item.title\"></div>\r\n\t</div>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_BACKGROUND = /* html */`\r\n<!-- background -->\r\n<div class=\"background\" [class]=\"{ 'background--image': ('background.image' | env), 'background--video': ('background.video' | env) }\" *if=\"state.status != 'connected'\">\r\n\t<img [src]=\"'background.image' | env | asset\" *if=\"'background.image' | env\" />\r\n\t<video [src]=\"'background.video' | env | asset\" *if=\"'background.video' | env\" oncanplay=\"this.muted = true; this.classList.add('ready');\" playsinline autoplay muted loop></video>\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_LOGO = /* html */`\r\n<!-- logo -->\r\n<a class=\"btn--logo\" [routerLink]=\"':lang.access' | route\" *if=\"state.status != 'connected'\">\r\n\t<img [src]=\"'logo' | env\" *if=\"'logo' | env\" />\r\n\t<svg viewBox=\"0 0 270 98\" *if=\"!('logo' | env)\"><use xlink:href=\"#b-here\"></use></svg>\r\n</a>\r\n`;\r\n\r\nexport const CHUNK_CREDITS = /* html */`\r\n<!-- credits -->\r\n<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\" *if=\"state.status != 'connected'\">\r\n\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n</a>\r\n`;\r\n\r\nexport const CHUNK_COPYRIGHT = /* html */`\r\n<!-- copyright -->\r\n<span *if=\"'gdprRoutes' | flag\"> <span [innerHTML]=\"'copyright' | label\"></span> <span *if=\"'privacy_policy' | label\">-</span> <a [routerLink]=\"':lang.privacy' | route\" class=\"btn--colophon\" [innerHTML]=\"'privacy_policy' | label\"></a> <span *if=\"'terms_of_service' | label\">-</span> <a [routerLink]=\"':lang.terms' | route\" class=\"btn--colophon\" [innerHTML]=\"'terms_of_service' | label\"></a></span>\r\n`;\r\n\r\nexport const CHUNK_LANGUAGE = /* html */`\r\n<!-- language -->\r\n<div class=\"group--language\" language *if=\"state.status != 'connected'\"></div>\r\n`;\r\n\r\nexport const CHUNK_VIRTUAL_TOUR = /* html */`\r\n<!-- Virtual Tour -->\r\n<div class=\"ui virtual-tour\" [class]=\"uiClass\" *if=\"state.status == 'connected' && isVirtualTourUser\">\r\n\t<!-- world -->\r\n\t<div class=\"ui__body\">\r\n\t\t<div class=\"world\" world [view]=\"view\" [views]=\"pathViews\" (navTo)=\"onNavTo($event)\" (navLink)=\"onNavLink($event)\"></div>\r\n\t</div>\r\n\t${CHUNK_REMOTE}\r\n\t<div class=\"group--header\">\r\n\t\t${CHUNK_SERVICE}\r\n\t\t${CHUNK_LOCAL}\r\n\t</div>\r\n\t<div class=\"group--footer\">\r\n\t\t${CHUNK_CONTROLS}\r\n\t\t${CHUNK_MEDIA}\r\n\t\t${CHUNK_AR_VR}\r\n\t\t${CHUNK_LIKE}\r\n\t</div>\r\n\t${CHUNK_MEMBERS}\r\n\t${CHUNK_CHAT}\r\n\t${CHUNK_LOCK}\r\n\t${CHUNK_NAVMAP}\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_SMART_DEVICE = /* html */`\r\n<!-- Smart Device -->\r\n<div class=\"ui remotes\" [class]=\"uiClass\" *if=\"state.status == 'connected' && state.role == 'smart-device'\">\r\n\t<div class=\"ui__body\"></div>\r\n\t<!-- remote sidebar -->\r\n\t<div class=\"group--remote\" [class]=\"'group--remote--' + remotes.length\" *if=\"state.live\">\r\n\t\t<div class=\"agora-stream\" (toggleSpy)=\"onToggleSpy($event)\" agora-stream [stream]=\"remote\" type=\"remote\" *for=\"let remote of remotes\">\r\n\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t<div class=\"agora-stream__info\">\r\n\t\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t\t\t<div class=\"id\" [innerHTML]=\"stream.clientInfo.name || streamId\" *if=\"stream.clientInfo\"></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<!-- remote screen -->\r\n\t<div class=\"group--remote-screen\" *if=\"remoteScreen && !hasScreenViewItem\">\r\n\t\t<div class=\"agora-stream\" agora-stream [stream]=\"remoteScreen\" type=\"remote\">\r\n\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t<div class=\"agora-stream__info\">\r\n\t\t\t\t<div class=\"id\" [innerHTML]=\"stream.clientInfo.name || streamId\" *if=\"stream.clientInfo\"></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"group--header\">\r\n\t\t${CHUNK_LOCAL_SMART_DEVICE}\r\n\t</div>\r\n\t<div class=\"group--footer\">\r\n\t\t${CHUNK_CONTROLS_SMART_DEVICE}\r\n\t</div>\r\n\t${CHUNK_MEMBERS_SMART_DEVICE}\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_SELF_SERVICE_TOUR = /* html */`\r\n<!-- Self Service Tour -->\r\n<div class=\"ui\" [class]=\"uiClass\" *if=\"state.status == 'connected' && state.mode == 'self-service-tour'\">\r\n\t<!-- world -->\r\n\t<div class=\"ui__body\">\r\n\t\t<div class=\"world\" world [view]=\"view\" [views]=\"pathViews\" (navTo)=\"onNavTo($event)\" (navLink)=\"onNavLink($event)\"></div>\r\n\t</div>\r\n\t<div class=\"group--header\">\r\n\t\t${CHUNK_SERVICE}\r\n\t</div>\r\n\t<div class=\"group--footer\">\r\n\t\t<div class=\"group--spacer\"></div>\r\n\t\t${CHUNK_MEDIA}\r\n\t\t${CHUNK_AR_VR}\r\n\t\t${CHUNK_LIKE}\r\n\t</div>\r\n\t${CHUNK_NAVMAP}\r\n</div>\r\n`;\r\n\r\nexport const CHUNK_EMBED = /* html */`\r\n<!-- Embed -->\r\n<div class=\"ui\" [class]=\"uiClass\" *if=\"state.status == 'connected' && state.mode == 'embed'\">\r\n\t<!-- world -->\r\n\t<div class=\"ui__body\">\r\n\t\t<div class=\"world\" world [view]=\"view\" [views]=\"pathViews\" (navTo)=\"onNavTo($event)\" (navLink)=\"onNavLink($event)\"></div>\r\n\t</div>\r\n\t<div class=\"group--header\">\r\n\t\t${CHUNK_SERVICE}\r\n\t</div>\r\n\t<div class=\"group--footer\">\r\n\t\t<div class=\"group--spacer\"></div>\r\n\t\t${CHUNK_MEDIA}\r\n\t\t${CHUNK_AR_VR}\r\n\t\t${CHUNK_LIKE}\r\n\t</div>\r\n</div>\r\n`;\r\n","\r\nexport class Utils {\r\n\r\n\tstatic merge(target, source) {\r\n\t\t// override null values\r\n\t\tif (source === null) {\r\n\t\t\treturn source;\r\n\t\t}\r\n\t\t// assign new values\r\n\t\tif (!target) {\r\n\t\t\tif (source && typeof source === 'object') {\r\n\t\t\t\treturn Object.assign({}, source);\r\n\t\t\t} else {\r\n\t\t\t\treturn source;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// merge objects\r\n\t\tif (source && typeof source === 'object') {\r\n\t\t\tObject.keys(source).forEach(key => {\r\n\t\t\t\tconst value = source[key];\r\n\t\t\t\tif (typeof value === 'object' && !Array.isArray(value)) {\r\n\t\t\t\t\ttarget[key] = this.merge(target[key], value);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttarget[key] = value;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn target;\r\n\t}\r\n\r\n}\r\n","import { environmentServed } from './environment.served';\r\nimport { environmentStatic } from './environment.static';\r\nimport { Utils } from './utils/utils';\r\n\r\nexport const NODE = (typeof module !== 'undefined' && module.exports);\r\nexport const PARAMS = NODE ? { get: () => { } } : new URLSearchParams(window.location.search);\r\nexport const DEBUG = false || (PARAMS.get('debug') != null);\r\nexport const BASE_HREF = NODE ? null : document.querySelector('base').getAttribute('href');\r\nexport const HEROKU = NODE ? false : (window && window.location.host.indexOf('herokuapp') !== -1);\r\nexport const VERCEL = NODE ? false : (window && window.location.host.indexOf('vercel.app') !== -1);\r\nexport const DEPLOYED = HEROKU || VERCEL;\r\nexport const STATIC = NODE ? false : (DEPLOYED || (window && (window.location.port === '41789' || window.location.port === '5000' || window.location.port === '6443' || window.location.host === 'actarian.github.io')));\r\nexport const DEVELOPMENT = NODE ? false : (window && ['localhost', '127.0.0.1', '0.0.0.0'].indexOf(window.location.host.split(':')[0]) !== -1);\r\nexport const PRODUCTION = !DEVELOPMENT;\r\nexport const ENV = {\r\n\tSTATIC,\r\n\tDEVELOPMENT,\r\n\tPRODUCTION,\r\n};\r\n\r\nexport class Environment {\r\n\r\n\tget STATIC() {\r\n\t\treturn ENV.STATIC;\r\n\t}\r\n\tset STATIC(STATIC) {\r\n\t\tENV.STATIC = (STATIC === true || STATIC === 'true');\r\n\t\tconsole.log('Environment.STATIC.set', ENV.STATIC);\r\n\t}\r\n\r\n\tget href() {\r\n\t\tif (DEPLOYED) {\r\n\t\t\treturn this.githubDocs;\r\n\t\t} else {\r\n\t\t\treturn this.assets;\r\n\t\t}\r\n\t}\r\n\r\n\tgetAbsoluteUrl(path, params) {\r\n\t\tlet url = `${window.location.origin}${path}`;\r\n\t\t// let url = `${window.location.protocol}//${window.location.host}${path}`;\r\n\t\tObject.keys(params).forEach(key => {\r\n\t\t\turl = url.replace(`$${key}`, params[key]);\r\n\t\t});\r\n\t\treturn url;\r\n\t}\r\n\r\n\tgetPath(path) {\r\n\t\treturn this.isLocal(path) ? (this.href + path) : path;\r\n\t}\r\n\r\n\tisLocal(path) {\r\n\t\treturn path.indexOf('://') === -1;\r\n\t}\r\n\r\n\tmerge(options) {\r\n\t\tif (options) {\r\n\t\t\tUtils.merge(this, options);\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst defaultOptions = {\r\n\tport: 5000,\r\n\t// fontFamily: 'GT Walsheim, sans-serif',\r\n\tfontFamily: 'Work Sans, sans-serif',\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d', 'media'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\trenderOrder: {\r\n\t\tpanorama: 0,\r\n\t\troom: 10,\r\n\t\tplane: 20,\r\n\t\ttile: 30,\r\n\t\tmodel: 40,\r\n\t\tbanner: 50,\r\n\t\tnav: 60,\r\n\t\tpanel: 70,\r\n\t\tmenu: 80,\r\n\t\tdebug: 90,\r\n\t\tpointer: 100,\r\n\t},\r\n};\r\n\r\nconst defaultAppOptions = {\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\theroku: HEROKU,\r\n\t\tvercel: VERCEL,\r\n\t\tdeployed: DEPLOYED,\r\n\t},\r\n\tnavs: {\r\n\t\ticonMinScale: 1,\r\n\t\ticonMaxScale: 1.4,\r\n\t},\r\n\turl: {},\r\n\tlanguages: ['it', 'en'],\r\n\tdefaultLanguage: 'it',\r\n\tlabels: {},\r\n\tdata: {},\r\n\tfields: [],\r\n};\r\n\r\nconst environmentOptions = window.STATIC ? environmentStatic : environmentServed;\r\n\r\nlet options = Object.assign(defaultOptions, defaultAppOptions, environmentOptions);\r\noptions = Utils.merge(options, window.bhere);\r\n\r\nexport const environment = new Environment(options);\r\n\r\nconsole.log('environment', environment);\r\n","\r\nexport const environmentStatic = {\r\n\tappKey: '8b0cae93d47a44e48e97e7fd0404be4e',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: false,\r\n\t\tuseProxy: true,\r\n\t\tuseToken: false,\r\n\t\tusePrefetch: true,\r\n\t\tuseExtendedUserInfo: true,\r\n\t\tuseEncryptedUrl: true,\r\n\t\tgdprRoutes: true,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\tguidedTourAccess: true,\r\n\t\tssoLogin: false,\r\n\t\tssoRegister: false,\r\n\t\teditor: true,\r\n\t\teditorAssetScreen: true,\r\n\t\tmenu: true,\r\n\t\tmenuEmbed: true,\r\n\t\tnavmaps: true,\r\n\t\tscreenShare: true,\r\n\t\tchat: true,\r\n\t\tar: true,\r\n\t\tlike: true,\r\n\t\thideNavInfo: true,\r\n\t\tuseIframe: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tselfServiceProposition: false,\r\n\t\tnavInfoAnimated: false,\r\n\t\tnavInfoImportantAnimated: false,\r\n\t\tnavMoveAnimated: true,\r\n\t\tnavMoveImportantAnimated: true,\r\n\t\tnavPointAnimated: false,\r\n\t\tnavPointImportantAnimated: false,\r\n\t\tnavTitleAnimated: false,\r\n\t\tnavTitleImportantAnimated: false,\r\n\t\tnavTransparentAnimated: true,\r\n\t\tnavTransparentImportantAnimated: true,\r\n\t\tuseTextureEnvironment: true,\r\n\t\tusePaths: true,\r\n\t\tantialias: true,\r\n\t\talpha: false,\r\n\t\tpremultipliedAlpha: false,\r\n\t},\r\n\tsso: {\r\n\t\tissuer: 'bhere-sso',\r\n\t\torigin: 'http://localhost:3010',\r\n\t\tloginUrl: 'http://localhost:3010/sso/login?redirectUrl={redirectUrl}',\r\n\t\tlogoutUrl: 'http://localhost:3010/sso/logout?redirectUrl={redirectUrl}',\r\n\t\tregisterUrl: 'http://localhost:3010/sso/register?redirectUrl={redirectUrl}',\r\n\t\tverifyTokenUrl: 'http://localhost:3010/sso/verifytoken?verifyToken={verifytoken}',\r\n\t},\r\n\tnavs: {\r\n\t\ticonMinScale: 1,\r\n\t\ticonMaxScale: 1.4,\r\n\t},\r\n\tprofiles: {\r\n\t\t// streamer: \"480p_1\", // 640 x 480 x 15\r\n\t\tstreamer: '480p_2', // 640 x 480 x 30\r\n\t\t// streamer: \"480p_3\", // 480 x 480 x 15\r\n\t\t// streamer: \"480p_4\", // 640 x 480 x 30\r\n\t\t// streamer: \"480p_6\", // 480 x 480 x 30\r\n\t\t// streamer: \"480p_8\", // 848, 480 x 15\r\n\t\t// streamer: \"480p_9\", // 848, 480 x 30\r\n\t\t// streamer: \"480p_10\", // 640 x 480 x 10\r\n\t\t// streamer: \"720p_1\", // 1280 x 720 x 15\r\n\t\t// streamer: \"720p_2\", // 1280 x 720 x 30\r\n\t\t// streamer: \"720p_3\", // 1280 x 720 x 30\r\n\t\t// streamer: \"720p_5\", // 960 x 720 x 15\r\n\t\t// streamer: \"720p_6\", // 960 x 720 x 30\r\n\t\t// streamer: \"1080p_1\", // 1920 x 1080 x 15\r\n\t\t// streamer: \"1080p_2\", // 1920 x 1080 x 30\r\n\t\t// streamer: \"1080p_3\", // 1920 x 1080 x 30\r\n\t\t// streamer: \"1080p_5\", // 1920 x 1080 x 60\r\n\r\n\t\t// attendee: \"720p_2\", // 1920 x 1080 x 30\r\n\t\tattendee: '1080p_2', // 1920 x 1080 x 30\r\n\r\n\t\t// publisher: \"720p_2\", // 1920 x 1080 x 30\r\n\t\tpublisher: '1080p_2', // 1920 x 1080 x 30\r\n\r\n\t\t// screen: \"480p_1\", // 640  480 x 5\r\n\t\t// screen: \"480p_2\", // 640  480 x 30\r\n\t\t// screen: \"720p_1\", // 1280  720 x 5\r\n\t\t// screen: \"720p_2\", // 1280  720 x 30\r\n\t\t// screen: \"1080p_1\", // 1920  1080 x 5\r\n\t\tscreen: '1080p_2', // 1920  1080 30\r\n\t},\r\n\tlogo: null,\r\n\t/*\r\n\tbackground: {\r\n\t\t// image: 'img/background.jpg',\r\n\t\tvideo: 'img/background.mp4',\r\n\t},\r\n\t*/\r\n\tselfServiceAudio: null, // 'audio/self-service.mp3',\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/docs/',\r\n\tdist: '/dist/',\r\n\tworkers: {\r\n\t\timage: './js/workers/image.service.worker.js',\r\n\t\tprefetch: './js/workers/prefetch.service.worker.js',\r\n\t},\r\n\ttextures: {\r\n\t\tenvMap: 'textures/envMap/studio_small_03_2k.hdr',\r\n\t\tgrid: 'textures/grid/grid.jpg',\r\n\t},\r\n\ttoneMappingExposure: 1,\r\n\tgithubDocs: 'https://raw.githubusercontent.com/actarian/b-here/beta-bhere-sso/docs/',\r\n\ttemplate: {\r\n\t\temail: {\r\n\t\t\tsupportRequest: '/email/support-request.html',\r\n\t\t},\r\n\t},\r\n};\r\n","\r\nexport const environmentServed = {\r\n\tappKey: '8b0cae93d47a44e48e97e7fd0404be4e',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: true,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tusePrefetch: true,\r\n\t\tuseExtendedUserInfo: false,\r\n\t\tuseEncryptedUrl: false,\r\n\t\tgdprRoutes: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\tguidedTourAccess: true,\r\n\t\tssoLogin: false,\r\n\t\tssoRegister: false,\r\n\t\teditor: false,\r\n\t\teditorAssetScreen: false,\r\n\t\tmenu: true,\r\n\t\tmenuEmbed: false,\r\n\t\tnavmaps: false,\r\n\t\tscreenShare: false,\r\n\t\tchat: false,\r\n\t\tar: true,\r\n\t\tlike: true,\r\n\t\thideNavInfo: true,\r\n\t\tuseIframe: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tselfServiceProposition: false,\r\n\t\tnavInfoAnimated: false,\r\n\t\tnavInfoImportantAnimated: false,\r\n\t\tnavMoveAnimated: false,\r\n\t\tnavMoveImportantAnimated: false,\r\n\t\tnavPointAnimated: false,\r\n\t\tnavPointImportantAnimated: false,\r\n\t\tnavTitleAnimated: false,\r\n\t\tnavTitleImportantAnimated: false,\r\n\t\tnavTransparentAnimated: false,\r\n\t\tnavTransparentImportantAnimated: false,\r\n\t\tuseTextureEnvironment: true,\r\n\t\tusePaths: false,\r\n\t\tantialias: true,\r\n\t\talpha: false,\r\n\t\tpremultipliedAlpha: false,\r\n\t\t// maxQuality: false,\r\n\t},\r\n\tnavs: {\r\n\t\ticonMinScale: 1,\r\n\t\ticonMaxScale: 1.4,\r\n\t},\r\n\tprofiles: {\r\n\t\t// streamer: \"480p_1\", // 640 x 480 x 15\r\n\t\tstreamer: '480p_2', // 640 x 480 x 30\r\n\t\t// streamer: \"480p_3\", // 480 x 480 x 15\r\n\t\t// streamer: \"480p_4\", // 640 x 480 x 30\r\n\t\t// streamer: \"480p_6\", // 480 x 480 x 30\r\n\t\t// streamer: \"480p_8\", // 848, 480 x 15\r\n\t\t// streamer: \"480p_9\", // 848, 480 x 30\r\n\t\t// streamer: \"480p_10\", // 640 x 480 x 10\r\n\t\t// streamer: \"720p_1\", // 1280 x 720 x 15\r\n\t\t// streamer: \"720p_2\", // 1280 x 720 x 30\r\n\t\t// streamer: \"720p_3\", // 1280 x 720 x 30\r\n\t\t// streamer: \"720p_5\", // 960 x 720 x 15\r\n\t\t// streamer: \"720p_6\", // 960 x 720 x 30\r\n\t\t// streamer: \"1080p_1\", // 1920 x 1080 x 15\r\n\t\t// streamer: \"1080p_2\", // 1920 x 1080 x 30\r\n\t\t// streamer: \"1080p_3\", // 1920 x 1080 x 30\r\n\t\t// streamer: \"1080p_5\", // 1920 x 1080 x 60\r\n\r\n\t\t// attendee: \"720p_2\", // 1920 x 1080 x 30\r\n\t\tattendee: '1080p_2', // 1920 x 1080 x 30\r\n\r\n\t\t// publisher: \"720p_2\", // 1920 x 1080 x 30\r\n\t\tpublisher: '1080p_2', // 1920 x 1080 x 30\r\n\r\n\t\t// screen: \"480p_1\", // 640  480 x 5\r\n\t\t// screen: \"480p_2\", // 640  480 x 30\r\n\t\t// screen: \"720p_1\", // 1280  720 x 5\r\n\t\tscreen: '720p_2', // 1280  720 x 30\r\n\t\t// screen: \"1080p_1\", // 1920  1080 x 5\r\n\t\t// screen: \"1080p_2\", // 1920  1080 30\r\n\t},\r\n\tlogo: null,\r\n\t/*\r\n\tbackground: {\r\n\t\t// image: 'img/background.jpg',\r\n\t\tvideo: 'img/background.mp4',\r\n\t},\r\n\t*/\r\n\tselfServiceAudio: null, // 'audio/self-service.mp3',\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d', 'media'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/Modules/B-Here/Client/docs/',\r\n\tdist: '/Modules/B-Here/Client/dist/',\r\n\tworkers: {\r\n\t\timage: '/Modules/B-Here/Client/docs/js/workers/image.service.worker.js',\r\n\t\tprefetch: '/Modules/B-Here/Client/docs/js/workers/prefetch.service.worker.js',\r\n\t},\r\n\ttextures: {\r\n\t\tenvMap: 'textures/envMap/studio_small_03_2k.hdr',\r\n\t\tgrid: 'textures/grid/grid.jpg',\r\n\t},\r\n\ttoneMappingExposure: 1,\r\n\tgithubDocs: 'https://raw.githubusercontent.com/actarian/b-here/beta-bhere-sso/docs/',\r\n\ttemplate: {\r\n\t\temail: {\r\n\t\t\tsupportRequest: '/template/modules/b-here/email/support-request.cshtml',\r\n\t\t},\r\n\t},\r\n};\r\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __createBinding(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (p !== \"default\" && !exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, privateMap) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to get private field on non-instance\");\r\n    }\r\n    return privateMap.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, privateMap, value) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to set private field on non-instance\");\r\n    }\r\n    privateMap.set(receiver, value);\r\n    return value;\r\n}\r\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __createBinding(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (p !== \"default\" && !exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, privateMap) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to get private field on non-instance\");\r\n    }\r\n    return privateMap.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, privateMap, value) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to set private field on non-instance\");\r\n    }\r\n    privateMap.set(receiver, value);\r\n    return value;\r\n}\r\n","export type arrayFormat = 'none' | 'brackets' | 'index'\nexport type booleanFormat = 'none' | 'string' | 'unicode' | 'empty-true'\nexport type nullFormat = 'default' | 'string' | 'hidden'\n\nexport interface IOptions {\n  arrayFormat?: arrayFormat\n  booleanFormat?: booleanFormat\n  nullFormat?: nullFormat\n}\n\nexport interface IFinalOptions {\n  arrayFormat: arrayFormat\n  booleanFormat: booleanFormat\n  nullFormat: nullFormat\n}\n\nexport const makeOptions = (opts: IOptions = {}): IFinalOptions => ({\n  arrayFormat: opts.arrayFormat || 'none',\n  booleanFormat: opts.booleanFormat || 'none',\n  nullFormat: opts.nullFormat || 'default'\n})\n\nconst encodeValue = (value: any): string => encodeURIComponent(value)\n\nconst decodeValue = (value: string): string => decodeURIComponent(value)\n\nconst encodeBoolean = (\n  name: string,\n  value: boolean,\n  opts: IFinalOptions\n): string => {\n  if (opts.booleanFormat === 'empty-true' && value) {\n    return name\n  }\n\n  let encodedValue\n\n  if (opts.booleanFormat === 'unicode') {\n    encodedValue = value ? '' : ''\n  } else {\n    encodedValue = value.toString()\n  }\n\n  return `${name}=${encodedValue}`\n}\n\nconst encodeNull = (name: string, opts: IFinalOptions): string => {\n  if (opts.nullFormat === 'hidden') {\n    return ''\n  }\n\n  if (opts.nullFormat === 'string') {\n    return `${name}=null`\n  }\n\n  return name\n}\n\ntype nameEncoder = (val: string, index: number) => string\n\nconst getNameEncoder = (opts: IFinalOptions): nameEncoder => {\n  if (opts.arrayFormat === 'index') {\n    return (name: string, index: number): string => `${name}[${index}]`\n  }\n\n  if (opts.arrayFormat === 'brackets') {\n    return (name: string): string => `${name}[]`\n  }\n\n  return (name: string): string => name\n}\n\nexport const encodeArray = (\n  name: string,\n  arr: any[],\n  opts: IFinalOptions\n): string => {\n  const encodeName = getNameEncoder(opts)\n\n  return arr\n    .map((val, index) => `${encodeName(name, index)}=${encodeValue(val)}`)\n    .join('&')\n}\n\nexport const encode = (\n  name: string,\n  value: any,\n  opts: IFinalOptions\n): string => {\n  if (value === null) {\n    return encodeNull(name, opts)\n  }\n\n  if (typeof value === 'boolean') {\n    return encodeBoolean(name, value, opts)\n  }\n\n  if (Array.isArray(value)) {\n    return encodeArray(name, value, opts)\n  }\n\n  return `${name}=${encodeValue(value)}`\n}\n\nexport const decode = (\n  value: any,\n  opts: IFinalOptions\n): boolean | string | null => {\n  if (value === undefined) {\n    return opts.booleanFormat === 'empty-true' ? true : null\n  }\n\n  if (opts.booleanFormat === 'string') {\n    if (value === 'true') {\n      return true\n    }\n    if (value === 'false') {\n      return false\n    }\n  }\n\n  if (opts.booleanFormat === 'unicode') {\n    if (decodeValue(value) === '') {\n      return true\n    }\n    if (decodeValue(value) === '') {\n      return false\n    }\n  }\n\n  if (opts.nullFormat === 'string') {\n    if (value === 'null') {\n      return null\n    }\n  }\n\n  return decodeValue(value)\n}\n","export const getSearch = (path: string): string => {\n  const pos = path.indexOf('?')\n\n  if (pos === -1) {\n    return path\n  }\n\n  return path.slice(pos + 1)\n}\n\nexport const isSerialisable = (val: any): boolean => val !== undefined\n\nexport interface IParsedName {\n  hasBrackets: boolean\n  name: string\n}\n\nexport const parseName = (name: string): IParsedName => {\n  const bracketPosition = name.indexOf('[')\n  const hasBrackets = bracketPosition !== -1\n\n  return {\n    hasBrackets,\n    name: hasBrackets ? name.slice(0, bracketPosition) : name\n  }\n}\n","import { decode, encode, IOptions, makeOptions } from './encode'\nimport { getSearch, isSerialisable, parseName } from './utils'\n\nexport { IOptions }\n\nexport type SearchParams = Record<\n  string,\n  string | boolean | null | Array<string | boolean | null> | undefined\n>\n\n/**\n * Parse a querystring and return an object of parameters\n */\nexport const parse = <T extends Record<string, any> = SearchParams>(\n  path: string,\n  opts?: IOptions\n): T => {\n  const options = makeOptions(opts)\n\n  return getSearch(path)\n    .split('&')\n    .reduce<Record<string, any>>((params, param) => {\n      const [rawName, value] = param.split('=')\n      const { hasBrackets, name } = parseName(rawName)\n      const currentValue = params[name]\n      const decodedValue = decode(value, options)\n\n      if (currentValue === undefined) {\n        params[name] = hasBrackets ? [decodedValue] : decodedValue\n      } else {\n        params[name] = (Array.isArray(currentValue)\n          ? currentValue\n          : [currentValue]\n        ).concat(decodedValue)\n      }\n\n      return params\n    }, {}) as T\n}\n\n/**\n * Build a querystring from an object of parameters\n */\nexport const build = <T extends Record<string, any> = SearchParams>(\n  params: T,\n  opts?: IOptions\n): string => {\n  const options = makeOptions(opts)\n\n  return Object.keys(params)\n    .filter(paramName => isSerialisable(params[paramName]))\n    .map(paramName => encode(paramName, params[paramName], options))\n    .filter(Boolean)\n    .join('&')\n}\n\nexport interface IOmitResponse {\n  querystring: string\n  removedParams: object\n}\n\n/**\n * Remove a list of parameters from a querystring\n */\nexport const omit = (\n  path: string,\n  paramsToOmit: string[],\n  opts?: IOptions\n): IOmitResponse => {\n  const options = makeOptions(opts)\n  const searchPart = getSearch(path)\n  if (searchPart === '') {\n    return {\n      querystring: '',\n      removedParams: {}\n    }\n  }\n\n  const [kept, removed] = path.split('&').reduce<[string[], string[]]>(\n    ([left, right]: [string[], string[]], chunk: string) => {\n      const rawName = chunk.split('=')[0]\n      const { name } = parseName(rawName)\n\n      return paramsToOmit.indexOf(name) === -1\n        ? [left.concat(chunk), right]\n        : [left, right.concat(chunk)]\n    },\n    [[], []]\n  )\n\n  return {\n    querystring: kept.join('&'),\n    removedParams: parse(removed.join('&'), options)\n  }\n}\n\nexport interface IKeepResponse {\n  querystring: string\n  keptParams: object\n}\n\n/**\n * Remove a list of parameters from a querystring\n */\nexport const keep = (\n  path: string,\n  paramsToKeep: string[],\n  opts?: IOptions\n): IKeepResponse => {\n  const options = makeOptions(opts)\n  const searchPart = getSearch(path)\n  if (searchPart === '') {\n    return {\n      keptParams: {},\n      querystring: ''\n    }\n  }\n\n  const kept = path.split('&').reduce<string[]>((acc, chunk: string) => {\n    const rawName = chunk.split('=')[0]\n    const { name } = parseName(rawName)\n\n    if (paramsToKeep.includes(name)) {\n      acc.push(chunk)\n    }\n\n    return acc\n  }, [])\n\n  return {\n    keptParams: parse(kept.join('&'), options),\n    querystring: kept.join('&')\n  }\n}\n","/**\n * We encode using encodeURIComponent but we want to\n * preserver certain characters which are commonly used\n * (sub delimiters and ':')\n * \n * https://www.ietf.org/rfc/rfc3986.txt\n * \n * reserved    = gen-delims / sub-delims\n * \n * gen-delims  = \":\" / \"/\" / \"?\" / \"#\" / \"[\" / \"]\" / \"@\"\n * \n * sub-delims  = \"!\" / \"$\" / \"&\" / \"'\" / \"(\" / \")\"\n              / \"*\" / \"+\" / \",\" / \";\" / \"=\"\n */\n\nconst excludeSubDelimiters = /[^!$'()*+,;|:]/g\n\nexport type URLParamsEncodingType =\n  | 'default'\n  | 'uri'\n  | 'uriComponent'\n  | 'none'\n  | 'legacy'\n\nexport const encodeURIComponentExcludingSubDelims = (segment: string): string =>\n  segment.replace(excludeSubDelimiters, match => encodeURIComponent(match))\n\nconst encodingMethods: Record<\n  URLParamsEncodingType,\n  (param: string) => string\n> = {\n  default: encodeURIComponentExcludingSubDelims,\n  uri: encodeURI,\n  uriComponent: encodeURIComponent,\n  none: val => val,\n  legacy: encodeURI\n}\n\nconst decodingMethods: Record<\n  URLParamsEncodingType,\n  (param: string) => string\n> = {\n  default: decodeURIComponent,\n  uri: decodeURI,\n  uriComponent: decodeURIComponent,\n  none: val => val,\n  legacy: decodeURIComponent\n}\n\nexport const encodeParam = (\n  param: string | number | boolean,\n  encoding: URLParamsEncodingType,\n  isSpatParam: boolean\n): string => {\n  const encoder =\n    encodingMethods[encoding] || encodeURIComponentExcludingSubDelims\n\n  if (isSpatParam) {\n    return String(param)\n      .split('/')\n      .map(encoder)\n      .join('/')\n  }\n\n  return encoder(String(param))\n}\n\nexport const decodeParam = (\n  param: string,\n  encoding: URLParamsEncodingType\n): string => (decodingMethods[encoding] || decodeURIComponent)(param)\n","export const defaultOrConstrained = (match: string): string =>\n  '(' +\n  (match ? match.replace(/(^<|>$)/g, '') : \"[a-zA-Z0-9-_.~%':|=+\\\\*@$]+\") +\n  ')'\n\nexport type RegExpFactory = (match: any) => RegExp\n\nexport interface IRule {\n  /* The name of the rule */\n  name: string\n  /* The regular expression used to find a token in a path definition */\n  pattern: RegExp\n  /* The derived regular expression to match a path */\n  regex?: RegExp | RegExpFactory\n}\n\nconst rules: IRule[] = [\n  {\n    name: 'url-parameter',\n    pattern: /^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,\n    regex: (match: RegExpMatchArray) =>\n      new RegExp(defaultOrConstrained(match[2]))\n  },\n  {\n    name: 'url-parameter-splat',\n    pattern: /^\\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,\n    regex: /([^?]*)/\n  },\n  {\n    name: 'url-parameter-matrix',\n    pattern: /^;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,\n    regex: (match: RegExpMatchArray) =>\n      new RegExp(';' + match[1] + '=' + defaultOrConstrained(match[2]))\n  },\n  {\n    name: 'query-parameter',\n    pattern: /^(?:\\?|&)(?::)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/\n  },\n  {\n    name: 'delimiter',\n    pattern: /^(\\/|\\?)/,\n    regex: (match: RegExpMatchArray) => new RegExp('\\\\' + match[0])\n  },\n  {\n    name: 'sub-delimiter',\n    pattern: /^(!|&|-|_|\\.|;)/,\n    regex: (match: RegExpMatchArray) => new RegExp(match[0])\n  },\n  {\n    name: 'fragment',\n    pattern: /^([0-9a-zA-Z]+)/,\n    regex: (match: RegExpMatchArray) => new RegExp(match[0])\n  }\n]\n\nexport default rules\n","import rules from './rules'\n\nexport interface Token {\n  type: string\n  match: string\n  val: any\n  otherVal: any\n  regex?: RegExp\n}\n\nconst tokenise = (str: string, tokens: Token[] = []): Token[] => {\n  // Look for a matching rule\n  const matched = rules.some(rule => {\n    const match = str.match(rule.pattern)\n    if (!match) {\n      return false\n    }\n\n    tokens.push({\n      type: rule.name,\n      match: match[0],\n      val: match.slice(1, 2),\n      otherVal: match.slice(2),\n      regex: rule.regex instanceof Function ? rule.regex(match) : rule.regex\n    })\n\n    if (match[0].length < str.length) {\n      tokens = tokenise(str.substr(match[0].length), tokens)\n    }\n    return true\n  })\n\n  // If no rules matched, throw an error (possible malformed path)\n  if (!matched) {\n    throw new Error(`Could not parse path '${str}'`)\n  }\n\n  return tokens\n}\n\nexport default tokenise\n","import {\n  build as buildQueryParams,\n  IOptions,\n  parse as parseQueryParams\n} from 'search-params'\n\nimport { URLParamsEncodingType, decodeParam, encodeParam } from './encoding'\nimport { defaultOrConstrained } from './rules'\nimport tokenise, { Token } from './tokeniser'\n\nexport { URLParamsEncodingType }\n\nconst exists = (val: any) => val !== undefined && val !== null\n\nconst optTrailingSlash = (source: string, strictTrailingSlash: boolean) => {\n  if (strictTrailingSlash) {\n    return source\n  }\n\n  if (source === '\\\\/') {\n    return source\n  }\n\n  return source.replace(/\\\\\\/$/, '') + '(?:\\\\/)?'\n}\n\nconst upToDelimiter = (source: string, delimiter?: boolean) => {\n  if (!delimiter) {\n    return source\n  }\n\n  return /(\\/)$/.test(source) ? source : source + '(\\\\/|\\\\?|\\\\.|;|$)'\n}\n\nconst appendQueryParam = (\n  params: Record<string, any>,\n  param: string,\n  val = ''\n) => {\n  const existingVal = params[param]\n\n  if (existingVal === undefined) {\n    params[param] = val\n  } else {\n    params[param] = Array.isArray(existingVal)\n      ? existingVal.concat(val)\n      : [existingVal, val]\n  }\n\n  return params\n}\n\nexport interface PathOptions {\n  /**\n   * Query parameters buiding and matching options, see\n   * https://github.com/troch/search-params#options\n   */\n  queryParams?: IOptions\n  /**\n   * Specifies the method used to encode URL parameters:\n   *   - `'default': `encodeURIComponent` and `decodeURIComponent`\n   *      are used but some characters to encode and decode URL parameters,\n   *      but some characters are preserved when encoding\n   *      (sub-delimiters: `+`, `:`, `'`, `!`, `,`, `;`, `'*'`).\n   *   - `'uriComponent'`: use `encodeURIComponent` and `decodeURIComponent`\n   *      for encoding and decoding URL parameters.\n   *   - `'uri'`: use `encodeURI` and `decodeURI for encoding amd decoding\n   *      URL parameters.\n   *   - `'none'`: no encoding or decoding is performed\n   *   - `'legacy'`: the approach for version 5.x and below (not recoomended)\n   */\n  urlParamsEncoding?: URLParamsEncodingType\n}\n\nexport interface InternalPathOptions {\n  queryParams?: IOptions\n  urlParamsEncoding: URLParamsEncodingType\n}\n\nconst defaultOptions: InternalPathOptions = {\n  urlParamsEncoding: 'default'\n}\n\nexport interface PathPartialTestOptions extends PathOptions {\n  caseSensitive?: boolean\n  delimited?: boolean\n}\n\nexport interface PathTestOptions extends PathOptions {\n  caseSensitive?: boolean\n  strictTrailingSlash?: boolean\n}\n\nexport interface PathBuildOptions extends PathOptions {\n  ignoreConstraints?: boolean\n  ignoreSearch?: boolean\n}\n\nexport type TestMatch<\n  T extends Record<string, any> = Record<string, any>\n> = T | null\n\nexport class Path<T extends Record<string, any> = Record<string, any>> {\n  public static createPath<T extends Record<string, any> = Record<string, any>>(\n    path: string,\n    options?: PathOptions\n  ) {\n    return new Path<T>(path, options)\n  }\n\n  public path: string\n  public tokens: Token[]\n  public hasUrlParams: boolean\n  public hasSpatParam: boolean\n  public hasMatrixParams: boolean\n  public hasQueryParams: boolean\n  public options: InternalPathOptions\n  public spatParams: string[]\n  public urlParams: string[]\n  public queryParams: string[]\n  public params: string[]\n  public source: string\n\n  constructor(path: string, options?: PathOptions) {\n    if (!path) {\n      throw new Error('Missing path in Path constructor')\n    }\n    this.path = path\n    this.options = {\n      ...defaultOptions,\n      ...options\n    }\n    this.tokens = tokenise(path)\n\n    this.hasUrlParams =\n      this.tokens.filter(t => /^url-parameter/.test(t.type)).length > 0\n    this.hasSpatParam =\n      this.tokens.filter(t => /splat$/.test(t.type)).length > 0\n    this.hasMatrixParams =\n      this.tokens.filter(t => /matrix$/.test(t.type)).length > 0\n    this.hasQueryParams =\n      this.tokens.filter(t => /^query-parameter/.test(t.type)).length > 0\n    // Extract named parameters from tokens\n    this.spatParams = this.getParams('url-parameter-splat')\n    this.urlParams = this.getParams(/^url-parameter/)\n    // Query params\n    this.queryParams = this.getParams('query-parameter')\n    // All params\n    this.params = this.urlParams.concat(this.queryParams)\n    // Check if hasQueryParams\n    // Regular expressions for url part only (full and partial match)\n    this.source = this.tokens\n      .filter(t => t.regex !== undefined)\n      .map(t => t.regex!.source)\n      .join('')\n  }\n\n  public isQueryParam(name: string): boolean {\n    return this.queryParams.indexOf(name) !== -1\n  }\n\n  public isSpatParam(name: string): boolean {\n    return this.spatParams.indexOf(name) !== -1\n  }\n\n  public test(path: string, opts?: PathTestOptions): TestMatch<T> {\n    const options = {\n      caseSensitive: false,\n      strictTrailingSlash: false,\n      ...this.options,\n      ...opts\n    } as const\n    // trailingSlash: falsy => non optional, truthy => optional\n    const source = optTrailingSlash(this.source, options.strictTrailingSlash)\n    // Check if exact match\n    const match = this.urlTest(\n      path,\n      source + (this.hasQueryParams ? '(\\\\?.*$|$)' : '$'),\n      options.caseSensitive,\n      options.urlParamsEncoding\n    )\n    // If no match, or no query params, no need to go further\n    if (!match || !this.hasQueryParams) {\n      return match\n    }\n    // Extract query params\n    const queryParams = parseQueryParams(path, options.queryParams)\n    const unexpectedQueryParams = Object.keys(queryParams).filter(\n      p => !this.isQueryParam(p)\n    )\n\n    if (unexpectedQueryParams.length === 0) {\n      // Extend url match\n      Object.keys(queryParams).forEach(\n        // @ts-ignore\n        p => (match[p] = (queryParams as any)[p])\n      )\n\n      return match\n    }\n\n    return null\n  }\n\n  public partialTest(\n    path: string,\n    opts?: PathPartialTestOptions\n  ): TestMatch<T> {\n    const options = {\n      caseSensitive: false,\n      delimited: true,\n      ...this.options,\n      ...opts\n    } as const\n    // Check if partial match (start of given path matches regex)\n    // trailingSlash: falsy => non optional, truthy => optional\n    const source = upToDelimiter(this.source, options.delimited)\n    const match = this.urlTest(\n      path,\n      source,\n      options.caseSensitive,\n      options.urlParamsEncoding\n    )\n\n    if (!match) {\n      return match\n    }\n\n    if (!this.hasQueryParams) {\n      return match\n    }\n\n    const queryParams = parseQueryParams(path, options.queryParams)\n\n    Object.keys(queryParams)\n      .filter(p => this.isQueryParam(p))\n      .forEach(p => appendQueryParam(match, p, (queryParams as any)[p]))\n\n    return match\n  }\n\n  public build(params: T = {} as T, opts?: PathBuildOptions): string {\n    const options = {\n      ignoreConstraints: false,\n      ignoreSearch: false,\n      queryParams: {},\n      ...this.options,\n      ...opts\n    } as const\n    const encodedUrlParams = Object.keys(params)\n      .filter(p => !this.isQueryParam(p))\n      .reduce<Record<string, any>>((acc, key) => {\n        if (!exists(params[key])) {\n          return acc\n        }\n\n        const val = params[key]\n        const isSpatParam = this.isSpatParam(key)\n\n        if (typeof val === 'boolean') {\n          acc[key] = val\n        } else if (Array.isArray(val)) {\n          acc[key] = val.map(v =>\n            encodeParam(v, options.urlParamsEncoding, isSpatParam)\n          )\n        } else {\n          acc[key] = encodeParam(val, options.urlParamsEncoding, isSpatParam)\n        }\n\n        return acc\n      }, {})\n\n    // Check all params are provided (not search parameters which are optional)\n    if (this.urlParams.some(p => !exists(params[p]))) {\n      const missingParameters = this.urlParams.filter(p => !exists(params[p]))\n      throw new Error(\n        \"Cannot build path: '\" +\n          this.path +\n          \"' requires missing parameters { \" +\n          missingParameters.join(', ') +\n          ' }'\n      )\n    }\n\n    // Check constraints\n    if (!options.ignoreConstraints) {\n      const constraintsPassed = this.tokens\n        .filter(t => /^url-parameter/.test(t.type) && !/-splat$/.test(t.type))\n        .every(t =>\n          new RegExp('^' + defaultOrConstrained(t.otherVal[0]) + '$').test(\n            encodedUrlParams[t.val]\n          )\n        )\n\n      if (!constraintsPassed) {\n        throw new Error(\n          `Some parameters of '${this.path}' are of invalid format`\n        )\n      }\n    }\n\n    const base = this.tokens\n      .filter(t => /^query-parameter/.test(t.type) === false)\n      .map(t => {\n        if (t.type === 'url-parameter-matrix') {\n          return `;${t.val}=${encodedUrlParams[t.val[0]]}`\n        }\n\n        return /^url-parameter/.test(t.type)\n          ? encodedUrlParams[t.val[0]]\n          : t.match\n      })\n      .join('')\n\n    if (options.ignoreSearch) {\n      return base\n    }\n\n    const searchParams = this.queryParams\n      .filter(p => Object.keys(params).indexOf(p) !== -1)\n      .reduce<Record<string, any>>((sparams, paramName) => {\n        sparams[paramName] = params[paramName]\n        return sparams\n      }, {})\n    const searchPart = buildQueryParams(searchParams, options.queryParams)\n\n    return searchPart ? base + '?' + searchPart : base\n  }\n\n  private getParams(type: string | RegExp): string[] {\n    const predicate =\n      type instanceof RegExp\n        ? (t: Token) => type.test(t.type)\n        : (t: Token) => t.type === type\n\n    return this.tokens.filter(predicate).map(t => t.val[0])\n  }\n\n  private urlTest(\n    path: string,\n    source: string,\n    caseSensitive: boolean,\n    urlParamsEncoding: URLParamsEncodingType\n  ): TestMatch<T> {\n    const regex = new RegExp('^' + source, caseSensitive ? '' : 'i')\n    const match = path.match(regex)\n    if (!match) {\n      return null\n    } else if (!this.urlParams.length) {\n      return {} as T\n    }\n    // Reduce named params to key-value pairs\n    return match\n      .slice(1, this.urlParams.length + 1)\n      .reduce<Record<string, any>>((params, m, i) => {\n        params[this.urlParams[i]] = decodeParam(m, urlParamsEncoding)\n        return params\n      }, {}) as T\n  }\n}\n\nexport default Path\n","import { build } from 'search-params'\nimport {\n  BuildOptions,\n  MatchResponse,\n  RouteNode,\n  RouteNodeState,\n  RouteNodeStateMeta\n} from './RouteNode'\n\nexport const getMetaFromSegments = (\n  segments: RouteNode[]\n): RouteNodeStateMeta => {\n  let accName = ''\n\n  return segments.reduce<RouteNodeStateMeta>((meta, segment) => {\n    const urlParams =\n      segment.parser?.urlParams.reduce<Record<string, any>>((params, p) => {\n        params[p] = 'url'\n        return params\n      }, {}) ?? {}\n\n    const allParams =\n      segment.parser?.queryParams.reduce<Record<string, any>>((params, p) => {\n        params[p] = 'query'\n        return params\n      }, urlParams) ?? {}\n\n    if (segment.name !== undefined) {\n      accName = accName ? accName + '.' + segment.name : segment.name\n      meta[accName] = allParams\n    }\n    return meta\n  }, {})\n}\n\nexport const buildStateFromMatch = (\n  match: MatchResponse\n): RouteNodeState | null => {\n  if (!match || !match.segments || !match.segments.length) {\n    return null\n  }\n\n  const name = match.segments\n    .map(segment => segment.name)\n    .filter(name => name)\n    .join('.')\n  const params = match.params\n\n  return {\n    name,\n    params,\n    meta: getMetaFromSegments(match.segments)\n  }\n}\n\nexport const buildPathFromSegments = (\n  segments: RouteNode[],\n  params: Record<string, any> = {},\n  options: BuildOptions = {}\n) => {\n  const { queryParamsMode = 'default', trailingSlashMode = 'default' } = options\n  const searchParams: string[] = []\n  const nonSearchParams: string[] = []\n\n  for (const segment of segments) {\n    const { parser } = segment\n\n    if (parser) {\n      searchParams.push(...parser.queryParams)\n      nonSearchParams.push(...parser.urlParams)\n      nonSearchParams.push(...parser.spatParams)\n    }\n  }\n\n  if (queryParamsMode === 'loose') {\n    const extraParams = Object.keys(params).reduce<string[]>(\n      (acc, p) =>\n        searchParams.indexOf(p) === -1 && nonSearchParams.indexOf(p) === -1\n          ? acc.concat(p)\n          : acc,\n      []\n    )\n    searchParams.push(...extraParams)\n  }\n\n  const searchParamsObject = searchParams.reduce<Record<string, any>>(\n    (acc, paramName) => {\n      if (Object.keys(params).indexOf(paramName) !== -1) {\n        acc[paramName] = params[paramName]\n      }\n\n      return acc\n    },\n    {}\n  )\n\n  const searchPart = build(searchParamsObject, options.queryParams)\n\n  const path = segments\n    .reduce<string>((path, segment) => {\n      const segmentPath =\n        segment.parser?.build(params, {\n          ignoreSearch: true,\n          queryParams: options.queryParams,\n          urlParamsEncoding: options.urlParamsEncoding\n        }) ?? ''\n\n      return segment.absolute ? segmentPath : path + segmentPath\n    }, '')\n    // remove repeated slashes\n    .replace(/\\/\\/{1,}/g, '/')\n\n  let finalPath = path\n\n  if (trailingSlashMode === 'always') {\n    finalPath = /\\/$/.test(path) ? path : `${path}/`\n  } else if (trailingSlashMode === 'never' && path !== '/') {\n    finalPath = /\\/$/.test(path) ? path.slice(0, -1) : path\n  }\n\n  return finalPath + (searchPart ? '?' + searchPart : '')\n}\n\nexport const getPathFromSegments = (segments: RouteNode[]): string | null =>\n  segments ? segments.map(segment => segment.path).join('') : null\n","import { omit, parse } from 'search-params'\nimport { MatchOptions, MatchResponse, RouteNode } from './RouteNode'\nimport { TestMatch } from 'path-parser'\n\nconst getPath = (path: string): string => path.split('?')[0]\n\nconst getSearch = (path: string): string => path.split('?')[1] || ''\n\nconst matchChildren = (\n  nodes: RouteNode[],\n  pathSegment: string,\n  currentMatch: MatchResponse,\n  options: MatchOptions = {},\n  consumedBefore?: string\n): MatchResponse | null => {\n  const {\n    queryParamsMode = 'default',\n    strictTrailingSlash = false,\n    strongMatching = true,\n    caseSensitive = false\n  } = options\n  const isRoot = nodes.length === 1 && nodes[0].name === ''\n  // for (child of node.children) {\n  for (const child of nodes) {\n    // Partially match path\n    let match: TestMatch | null = null\n    let remainingPath\n    let segment = pathSegment\n\n    if (consumedBefore === '/' && child.path === '/') {\n      // when we encounter repeating slashes we add the slash\n      // back to the URL to make it de facto pathless\n      segment = '/' + pathSegment\n    }\n\n    if (!child.children.length) {\n      match = child.parser!.test(segment, {\n        caseSensitive,\n        strictTrailingSlash,\n        queryParams: options.queryParams,\n        urlParamsEncoding: options.urlParamsEncoding\n      })\n    }\n\n    if (!match) {\n      match = child.parser!.partialTest(segment, {\n        delimited: strongMatching,\n        caseSensitive,\n        queryParams: options.queryParams,\n        urlParamsEncoding: options.urlParamsEncoding\n      })\n    }\n\n    if (match) {\n      // Remove consumed segment from path\n      let consumedPath = child.parser!.build(match, {\n        ignoreSearch: true,\n        urlParamsEncoding: options.urlParamsEncoding\n      })\n\n      if (!strictTrailingSlash && !child.children.length) {\n        consumedPath = consumedPath.replace(/\\/$/, '')\n      }\n\n      // Can't create a regexp from the path because it might contain a\n      // regexp character.\n      if (segment.toLowerCase().indexOf(consumedPath.toLowerCase()) === 0) {\n        remainingPath = segment.slice(consumedPath.length)\n      } else {\n        remainingPath = segment\n      }\n\n      if (!strictTrailingSlash && !child.children.length) {\n        remainingPath = remainingPath.replace(/^\\/\\?/, '?')\n      }\n\n      const { querystring } = omit(\n        getSearch(segment.replace(consumedPath, '')),\n        child.parser!.queryParams,\n        options.queryParams\n      )\n      remainingPath =\n        getPath(remainingPath) + (querystring ? `?${querystring}` : '')\n      if (\n        !strictTrailingSlash &&\n        !isRoot &&\n        remainingPath === '/' &&\n        !/\\/$/.test(consumedPath)\n      ) {\n        remainingPath = ''\n      }\n\n      currentMatch.segments.push(child)\n      Object.keys(match).forEach(\n        param => (currentMatch.params[param] = match![param])\n      )\n\n      if (!isRoot && !remainingPath.length) {\n        // fully matched\n        return currentMatch\n      }\n      if (\n        !isRoot &&\n        queryParamsMode !== 'strict' &&\n        remainingPath.indexOf('?') === 0\n      ) {\n        // unmatched queryParams in non strict mode\n        const remainingQueryParams = parse(\n          remainingPath.slice(1),\n          options.queryParams\n        ) as any\n\n        Object.keys(remainingQueryParams).forEach(\n          name => (currentMatch.params[name] = remainingQueryParams[name])\n        )\n        return currentMatch\n      }\n      // Continue matching on non absolute children\n      const children = child.getNonAbsoluteChildren()\n      // If no children to match against but unmatched path left\n      if (!children.length) {\n        return null\n      }\n      // Else: remaining path and children\n      return matchChildren(\n        children,\n        remainingPath,\n        currentMatch,\n        options,\n        consumedPath\n      )\n    }\n  }\n\n  return null\n}\n\nexport default matchChildren\n","import { RouteNode } from './RouteNode'\n\nexport default function sortChildren(children: RouteNode[]) {\n  const originalChildren = children.slice(0)\n\n  return children.sort(sortPredicate(originalChildren))\n}\n\nconst sortPredicate = (originalChildren: RouteNode[]) => (\n  left: RouteNode,\n  right: RouteNode\n): number => {\n  const leftPath = left.path\n    .replace(/<.*?>/g, '')\n    .split('?')[0]\n    .replace(/(.+)\\/$/, '$1')\n  const rightPath = right.path\n    .replace(/<.*?>/g, '')\n    .split('?')[0]\n    .replace(/(.+)\\/$/, '$1')\n\n  // '/' last\n  if (leftPath === '/') {\n    return 1\n  }\n  if (rightPath === '/') {\n    return -1\n  }\n  // Spat params last\n  if (left.parser?.hasSpatParam) {\n    return 1\n  }\n  if (right.parser?.hasSpatParam) {\n    return -1\n  }\n  // No spat, number of segments (less segments last)\n  const leftSegments = (leftPath.match(/\\//g) || []).length\n  const rightSegments = (rightPath.match(/\\//g) || []).length\n  if (leftSegments < rightSegments) {\n    return 1\n  }\n  if (leftSegments > rightSegments) {\n    return -1\n  }\n  // Same number of segments, number of URL params ascending\n  const leftParamsCount = left.parser?.urlParams.length ?? 0\n  const rightParamsCount = right.parser?.urlParams.length ?? 0\n  if (leftParamsCount < rightParamsCount) {\n    return -1\n  }\n  if (leftParamsCount > rightParamsCount) {\n    return 1\n  }\n  // Same number of segments and params, last segment length descending\n  const leftParamLength = (leftPath.split('/').slice(-1)[0] || '').length\n  const rightParamLength = (rightPath.split('/').slice(-1)[0] || '').length\n  if (leftParamLength < rightParamLength) {\n    return 1\n  }\n  if (leftParamLength > rightParamLength) {\n    return -1\n  }\n  // Same last segment length, preserve definition order. Note that we\n  // cannot just return 0, as sort is not guaranteed to be a stable sort.\n  return originalChildren.indexOf(left) - originalChildren.indexOf(right)\n}\n","import { Path, URLParamsEncodingType } from 'path-parser'\nimport { IOptions as QueryParamsOptions } from 'search-params'\n\nimport {\n  buildPathFromSegments,\n  buildStateFromMatch,\n  getMetaFromSegments,\n  getPathFromSegments\n} from './helpers'\nimport matchChildren from './matchChildren'\nimport sortChildren from './sortChildren'\n\nexport interface RouteDefinition {\n  name: string\n  path: string\n  [key: string]: any\n}\nexport type Route = RouteNode | RouteDefinition\nexport type Callback = (...args: any[]) => void\nexport type TrailingSlashMode = 'default' | 'never' | 'always'\nexport type QueryParamsMode = 'default' | 'strict' | 'loose'\n\nexport interface BuildOptions {\n  trailingSlashMode?: TrailingSlashMode\n  queryParamsMode?: QueryParamsMode\n  queryParams?: QueryParamsOptions\n  urlParamsEncoding?: URLParamsEncodingType\n}\n\nexport interface MatchOptions {\n  caseSensitive?: boolean\n  trailingSlashMode?: TrailingSlashMode\n  queryParamsMode?: QueryParamsMode\n  queryParams?: QueryParamsOptions\n  strictTrailingSlash?: boolean\n  strongMatching?: boolean\n  urlParamsEncoding?: URLParamsEncodingType\n}\n\nexport { QueryParamsOptions }\n\nexport interface MatchResponse {\n  segments: RouteNode[]\n  params: Record<string, any>\n}\n\nexport interface RouteNodeStateMeta {\n  [routeName: string]: {\n    [routeParams: string]: 'query' | 'url'\n  }\n}\n\nexport interface RouteNodeState {\n  name: string\n  params: Record<string, any>\n  meta: RouteNodeStateMeta\n}\n\nexport interface RouteNodeOptions {\n  finalSort?: boolean\n  onAdd?: Callback\n  parent?: RouteNode\n  sort?: boolean\n}\n\nexport class RouteNode {\n  public name: string\n  public absolute: boolean\n  public path: string\n  public parser: Path | null\n  public children: RouteNode[]\n  public parent?: RouteNode\n\n  constructor(\n    name: string = '',\n    path: string = '',\n    childRoutes: Route[] = [],\n    options: RouteNodeOptions = {}\n  ) {\n    this.name = name\n    this.absolute = /^~/.test(path)\n    this.path = this.absolute ? path.slice(1) : path\n\n    this.parser = this.path ? new Path(this.path) : null\n    this.children = []\n    this.parent = options.parent\n\n    this.checkParents()\n\n    this.add(\n      childRoutes,\n      options.onAdd,\n      options.finalSort ? false : options.sort !== false\n    )\n\n    if (options.finalSort) {\n      this.sortDescendants()\n    }\n\n    return this\n  }\n\n  public getParentSegments(segments: RouteNode[] = []): RouteNode[] {\n    return this.parent && this.parent.parser\n      ? this.parent.getParentSegments(segments.concat(this.parent))\n      : segments.reverse()\n  }\n\n  public setParent(parent: RouteNode) {\n    this.parent = parent\n    this.checkParents()\n  }\n\n  public setPath(path: string = '') {\n    this.path = path\n    this.parser = path ? new Path(path) : null\n  }\n\n  public add(\n    route: Route | Route[],\n    cb?: Callback,\n    sort: boolean = true\n  ): this {\n    if (route === undefined || route === null) {\n      return this\n    }\n\n    if (route instanceof Array) {\n      route.forEach(r => this.add(r, cb, sort))\n      return this\n    }\n\n    if (!(route instanceof RouteNode) && !(route instanceof Object)) {\n      throw new Error(\n        'RouteNode.add() expects routes to be an Object or an instance of RouteNode.'\n      )\n    } else if (route instanceof RouteNode) {\n      route.setParent(this)\n      this.addRouteNode(route, sort)\n    } else {\n      if (!route.name || !route.path) {\n        throw new Error(\n          'RouteNode.add() expects routes to have a name and a path defined.'\n        )\n      }\n\n      const routeNode = new RouteNode(route.name, route.path, route.children, {\n        finalSort: false,\n        onAdd: cb,\n        parent: this,\n        sort\n      })\n      const fullName = routeNode\n        .getParentSegments([routeNode])\n        .map(_ => _.name)\n        .join('.')\n      if (cb) {\n        cb({\n          ...route,\n          name: fullName\n        })\n      }\n      this.addRouteNode(routeNode, sort)\n    }\n\n    return this\n  }\n\n  public addNode(name: string, path: string) {\n    this.add(new RouteNode(name, path))\n    return this\n  }\n\n  public getPath(routeName: string): string | null {\n    const segmentsByName = this.getSegmentsByName(routeName)\n\n    return segmentsByName ? getPathFromSegments(segmentsByName) : null\n  }\n\n  public getNonAbsoluteChildren(): RouteNode[] {\n    return this.children.filter(child => !child.absolute)\n  }\n\n  public sortChildren() {\n    if (this.children.length) {\n      sortChildren(this.children)\n    }\n  }\n\n  public sortDescendants() {\n    this.sortChildren()\n    this.children.forEach(child => child.sortDescendants())\n  }\n\n  public buildPath(\n    routeName: string,\n    params: Record<string, any> = {},\n    options: BuildOptions = {}\n  ): string {\n    const segments = this.getSegmentsByName(routeName)\n\n    if (!segments) {\n      throw new Error(`[route-node][buildPath] '{routeName}' is not defined`)\n    }\n\n    return buildPathFromSegments(segments, params, options)\n  }\n\n  public buildState(\n    name: string,\n    params: Record<string, any> = {}\n  ): RouteNodeState | null {\n    const segments = this.getSegmentsByName(name)\n\n    if (!segments || !segments.length) {\n      return null\n    }\n\n    return {\n      name,\n      params,\n      meta: getMetaFromSegments(segments)\n    }\n  }\n\n  public matchPath(\n    path: string,\n    options: MatchOptions = {}\n  ): RouteNodeState | null {\n    if (path === '' && !options.strictTrailingSlash) {\n      path = '/'\n    }\n\n    const match = this.getSegmentsMatchingPath(path, options)\n\n    if (!match) {\n      return null\n    }\n\n    const matchedSegments = match.segments\n\n    if (matchedSegments[0].absolute) {\n      const firstSegmentParams = matchedSegments[0].getParentSegments()\n\n      matchedSegments.reverse()\n      matchedSegments.push(...firstSegmentParams)\n      matchedSegments.reverse()\n    }\n\n    const lastSegment = matchedSegments[matchedSegments.length - 1]\n    const lastSegmentSlashChild = lastSegment.findSlashChild()\n\n    if (lastSegmentSlashChild) {\n      matchedSegments.push(lastSegmentSlashChild)\n    }\n\n    return buildStateFromMatch(match)\n  }\n\n  private addRouteNode(route: RouteNode, sort: boolean = true): this {\n    const names = route.name.split('.')\n\n    if (names.length === 1) {\n      // Check duplicated routes\n      if (this.children.map(child => child.name).indexOf(route.name) !== -1) {\n        throw new Error(\n          `Alias \"${route.name}\" is already defined in route node`\n        )\n      }\n\n      // Check duplicated paths\n      if (this.children.map(child => child.path).indexOf(route.path) !== -1) {\n        throw new Error(`Path \"${route.path}\" is already defined in route node`)\n      }\n\n      this.children.push(route)\n\n      if (sort) {\n        this.sortChildren()\n      }\n    } else {\n      // Locate parent node\n      const segments = this.getSegmentsByName(names.slice(0, -1).join('.'))\n      if (segments) {\n        route.name = names[names.length - 1]\n        segments[segments.length - 1].add(route)\n      } else {\n        throw new Error(\n          `Could not add route named '${route.name}', parent is missing.`\n        )\n      }\n    }\n\n    return this\n  }\n\n  private checkParents() {\n    if (this.absolute && this.hasParentsParams()) {\n      throw new Error(\n        '[RouteNode] A RouteNode with an abolute path cannot have parents with route parameters'\n      )\n    }\n  }\n\n  private hasParentsParams(): boolean {\n    if (this.parent && this.parent.parser) {\n      const parser = this.parent.parser\n      const hasParams =\n        parser.hasUrlParams ||\n        parser.hasSpatParam ||\n        parser.hasMatrixParams ||\n        parser.hasQueryParams\n\n      return hasParams || this.parent.hasParentsParams()\n    }\n\n    return false\n  }\n\n  private findAbsoluteChildren(): RouteNode[] {\n    return this.children.reduce<RouteNode[]>(\n      (absoluteChildren, child) =>\n        absoluteChildren\n          .concat(child.absolute ? child : [])\n          .concat(child.findAbsoluteChildren()),\n      []\n    )\n  }\n\n  private findSlashChild(): RouteNode | undefined {\n    const slashChildren = this.getNonAbsoluteChildren().filter(\n      child => child.parser && /^\\/(\\?|$)/.test(child.parser.path)\n    )\n\n    return slashChildren[0]\n  }\n\n  private getSegmentsByName(routeName: string): RouteNode[] | null {\n    const findSegmentByName = (name: string, routes: RouteNode[]) => {\n      const filteredRoutes = routes.filter(r => r.name === name)\n      return filteredRoutes.length ? filteredRoutes[0] : undefined\n    }\n    const segments: RouteNode[] = []\n    let routes = this.parser ? [this] : this.children\n    const names = (this.parser ? [''] : []).concat(routeName.split('.'))\n\n    const matched = names.every(name => {\n      const segment = findSegmentByName(name, routes)\n      if (segment) {\n        routes = segment.children\n        segments.push(segment)\n        return true\n      }\n      return false\n    })\n\n    return matched ? segments : null\n  }\n\n  private getSegmentsMatchingPath(\n    path: string,\n    options: MatchOptions\n  ): MatchResponse | null {\n    const topLevelNodes = this.parser ? [this] : this.children\n    const startingNodes = topLevelNodes.reduce<RouteNode[]>(\n      (nodes, node) => nodes.concat(node, node.findAbsoluteChildren()),\n      []\n    )\n\n    const currentMatch = {\n      segments: [],\n      params: {}\n    }\n\n    const finalMatch = matchChildren(startingNodes, path, currentMatch, options)\n\n    if (\n      finalMatch &&\n      finalMatch.segments.length === 1 &&\n      finalMatch.segments[0].name === ''\n    ) {\n      return null\n    }\n\n    return finalMatch\n  }\n}\n","/* global window */\nimport ponyfill from './ponyfill.js';\n\nvar root;\n\nif (typeof self !== 'undefined') {\n  root = self;\n} else if (typeof window !== 'undefined') {\n  root = window;\n} else if (typeof global !== 'undefined') {\n  root = global;\n} else if (typeof module !== 'undefined') {\n  root = module;\n} else {\n  root = Function('return this')();\n}\n\nvar result = ponyfill(root);\nexport default result;\n","export default function symbolObservablePonyfill(root) {\n\tvar result;\n\tvar Symbol = root.Symbol;\n\n\tif (typeof Symbol === 'function') {\n\t\tif (Symbol.observable) {\n\t\t\tresult = Symbol.observable;\n\t\t} else {\n\t\t\tresult = Symbol('observable');\n\t\t\tSymbol.observable = result;\n\t\t}\n\t} else {\n\t\tresult = '@@observable';\n\t}\n\n\treturn result;\n};\n","var nameToIDs = function (name) {\r\n    return name\r\n        .split('.')\r\n        .reduce(function (ids, name) {\r\n        return ids.concat(ids.length ? ids[ids.length - 1] + '.' + name : name);\r\n    }, []);\r\n};\r\nvar exists = function (val) { return val !== undefined && val !== null; };\r\nvar hasMetaParams = function (state) { return state && state.meta && state.meta.params; };\r\nvar extractSegmentParams = function (name, state) {\r\n    if (!hasMetaParams(state) || !exists(state.meta.params[name]))\r\n        return {};\r\n    return Object.keys(state.meta.params[name]).reduce(function (params, p) {\r\n        params[p] = state.params[p];\r\n        return params;\r\n    }, {});\r\n};\r\nfunction transitionPath(toState, fromState) {\r\n    var toStateOptions = (toState.meta && toState.meta && toState.meta.options) || {};\r\n    var fromStateIds = fromState ? nameToIDs(fromState.name) : [];\r\n    var toStateIds = nameToIDs(toState.name);\r\n    var maxI = Math.min(fromStateIds.length, toStateIds.length);\r\n    function pointOfDifference() {\r\n        var i;\r\n        var _loop_1 = function () {\r\n            var left = fromStateIds[i];\r\n            var right = toStateIds[i];\r\n            if (left !== right)\r\n                return { value: i };\r\n            var leftParams = extractSegmentParams(left, toState);\r\n            var rightParams = extractSegmentParams(right, fromState);\r\n            if (Object.keys(leftParams).length !==\r\n                Object.keys(rightParams).length)\r\n                return { value: i };\r\n            if (Object.keys(leftParams).length === 0)\r\n                return \"continue\";\r\n            var different = Object.keys(leftParams).some(function (p) { return rightParams[p] !== leftParams[p]; });\r\n            if (different) {\r\n                return { value: i };\r\n            }\r\n        };\r\n        for (i = 0; i < maxI; i += 1) {\r\n            var state_1 = _loop_1();\r\n            if (typeof state_1 === \"object\")\r\n                return state_1.value;\r\n        }\r\n        return i;\r\n    }\r\n    var i;\r\n    if (!fromState || toStateOptions.reload) {\r\n        i = 0;\r\n    }\r\n    else if (!hasMetaParams(fromState) && !hasMetaParams(toState)) {\r\n        i = 0;\r\n    }\r\n    else {\r\n        i = pointOfDifference();\r\n    }\r\n    var toDeactivate = fromStateIds.slice(i).reverse();\r\n    var toActivate = toStateIds.slice(i);\r\n    var intersection = fromState && i > 0 ? fromStateIds[i - 1] : '';\r\n    return {\r\n        intersection: intersection,\r\n        toDeactivate: toDeactivate,\r\n        toActivate: toActivate\r\n    };\r\n}\n\n/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n\r\nfunction __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\n\nfunction shouldUpdateNode(nodeName) {\r\n    return function (toState, fromSate) {\r\n        var _a = transitionPath(toState, fromSate), intersection = _a.intersection, toActivate = _a.toActivate, toDeactivateReversed = _a.toDeactivate;\r\n        var toDeactivate = __spreadArrays(toDeactivateReversed).reverse();\r\n        if (toState.meta.options && toState.meta.options.reload) {\r\n            return true;\r\n        }\r\n        if (nodeName === intersection) {\r\n            return true;\r\n        }\r\n        if (toActivate.indexOf(nodeName) === -1) {\r\n            return false;\r\n        }\r\n        var matching = true;\r\n        for (var i = 0; i < toActivate.length; i += 1) {\r\n            var activatedSegment = toActivate[i];\r\n            var sameLevelDeactivatedSegment = toDeactivate[i];\r\n            matching = activatedSegment === sameLevelDeactivatedSegment;\r\n            if (matching && activatedSegment === nodeName) {\r\n                return true;\r\n            }\r\n            if (!matching) {\r\n                return false;\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n}\n\nexport default transitionPath;\nexport { nameToIDs, shouldUpdateNode };\n","import { RouteNode } from 'route-node';\nexport { RouteNode } from 'route-node';\nimport $$observable from 'symbol-observable';\nimport transitionPath, { nameToIDs } from 'router5-transition-path';\nexport { default as transitionPath } from 'router5-transition-path';\n\n/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n\r\nvar __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\n\nvar defaultOptions = {\r\n    trailingSlashMode: 'default',\r\n    queryParamsMode: 'default',\r\n    strictTrailingSlash: false,\r\n    autoCleanUp: true,\r\n    allowNotFound: false,\r\n    strongMatching: true,\r\n    rewritePathOnMatch: true,\r\n    caseSensitive: false,\r\n    urlParamsEncoding: 'default'\r\n};\r\nfunction withOptions(options) {\r\n    return function (router) {\r\n        var routerOptions = __assign(__assign({}, defaultOptions), options);\r\n        router.getOptions = function () { return routerOptions; };\r\n        router.setOption = function (option, value) {\r\n            routerOptions[option] = value;\r\n            return router;\r\n        };\r\n        return router;\r\n    };\r\n}\n\nvar errorCodes = {\r\n    ROUTER_NOT_STARTED: 'NOT_STARTED',\r\n    NO_START_PATH_OR_STATE: 'NO_START_PATH_OR_STATE',\r\n    ROUTER_ALREADY_STARTED: 'ALREADY_STARTED',\r\n    ROUTE_NOT_FOUND: 'ROUTE_NOT_FOUND',\r\n    SAME_STATES: 'SAME_STATES',\r\n    CANNOT_DEACTIVATE: 'CANNOT_DEACTIVATE',\r\n    CANNOT_ACTIVATE: 'CANNOT_ACTIVATE',\r\n    TRANSITION_ERR: 'TRANSITION_ERR',\r\n    TRANSITION_CANCELLED: 'CANCELLED'\r\n};\r\nvar constants = {\r\n    UNKNOWN_ROUTE: '@@router5/UNKNOWN_ROUTE',\r\n    ROUTER_START: '$start',\r\n    ROUTER_STOP: '$stop',\r\n    TRANSITION_START: '$$start',\r\n    TRANSITION_CANCEL: '$$cancel',\r\n    TRANSITION_SUCCESS: '$$success',\r\n    TRANSITION_ERROR: '$$error'\r\n};\n\nfunction withRoutes(routes) {\r\n    return function (router) {\r\n        router.forward = function (fromRoute, toRoute) {\r\n            router.config.forwardMap[fromRoute] = toRoute;\r\n            return router;\r\n        };\r\n        var rootNode = routes instanceof RouteNode\r\n            ? routes\r\n            : new RouteNode('', '', routes, { onAdd: onRouteAdded });\r\n        function onRouteAdded(route) {\r\n            if (route.canActivate)\r\n                router.canActivate(route.name, route.canActivate);\r\n            if (route.forwardTo)\r\n                router.forward(route.name, route.forwardTo);\r\n            if (route.decodeParams)\r\n                router.config.decoders[route.name] = route.decodeParams;\r\n            if (route.encodeParams)\r\n                router.config.encoders[route.name] = route.encodeParams;\r\n            if (route.defaultParams)\r\n                router.config.defaultParams[route.name] = route.defaultParams;\r\n        }\r\n        router.rootNode = rootNode;\r\n        router.add = function (routes, finalSort) {\r\n            rootNode.add(routes, onRouteAdded, !finalSort);\r\n            if (finalSort) {\r\n                rootNode.sortDescendants();\r\n            }\r\n            return router;\r\n        };\r\n        router.addNode = function (name, path, canActivateHandler) {\r\n            rootNode.addNode(name, path);\r\n            if (canActivateHandler)\r\n                router.canActivate(name, canActivateHandler);\r\n            return router;\r\n        };\r\n        router.isActive = function (name, params, strictEquality, ignoreQueryParams) {\r\n            if (params === void 0) { params = {}; }\r\n            if (strictEquality === void 0) { strictEquality = false; }\r\n            if (ignoreQueryParams === void 0) { ignoreQueryParams = true; }\r\n            var activeState = router.getState();\r\n            if (!activeState)\r\n                return false;\r\n            if (strictEquality || activeState.name === name) {\r\n                return router.areStatesEqual(router.makeState(name, params), activeState, ignoreQueryParams);\r\n            }\r\n            return router.areStatesDescendants(router.makeState(name, params), activeState);\r\n        };\r\n        router.buildPath = function (route, params) {\r\n            if (route === constants.UNKNOWN_ROUTE) {\r\n                return params.path;\r\n            }\r\n            var paramsWithDefault = __assign(__assign({}, router.config.defaultParams[route]), params);\r\n            var _a = router.getOptions(), trailingSlashMode = _a.trailingSlashMode, queryParamsMode = _a.queryParamsMode, queryParams = _a.queryParams;\r\n            var encodedParams = router.config.encoders[route]\r\n                ? router.config.encoders[route](paramsWithDefault)\r\n                : paramsWithDefault;\r\n            return router.rootNode.buildPath(route, encodedParams, {\r\n                trailingSlashMode: trailingSlashMode,\r\n                queryParamsMode: queryParamsMode,\r\n                queryParams: queryParams,\r\n                urlParamsEncoding: router.getOptions().urlParamsEncoding\r\n            });\r\n        };\r\n        router.matchPath = function (path, source) {\r\n            var options = router.getOptions();\r\n            var match = router.rootNode.matchPath(path, options);\r\n            if (match) {\r\n                var name_1 = match.name, params = match.params, meta = match.meta;\r\n                var decodedParams = router.config.decoders[name_1]\r\n                    ? router.config.decoders[name_1](params)\r\n                    : params;\r\n                var _a = router.forwardState(name_1, decodedParams), routeName = _a.name, routeParams = _a.params;\r\n                var builtPath = options.rewritePathOnMatch === false\r\n                    ? path\r\n                    : router.buildPath(routeName, routeParams);\r\n                return router.makeState(routeName, routeParams, builtPath, {\r\n                    params: meta,\r\n                    source: source\r\n                });\r\n            }\r\n            return null;\r\n        };\r\n        router.setRootPath = function (rootPath) {\r\n            router.rootNode.setPath(rootPath);\r\n        };\r\n        return router;\r\n    };\r\n}\n\nfunction withDependencies(dependencies) {\r\n    return function (router) {\r\n        var routerDependencies = dependencies;\r\n        router.setDependency = function (dependencyName, dependency) {\r\n            routerDependencies[dependencyName] = dependency;\r\n            return router;\r\n        };\r\n        router.setDependencies = function (deps) {\r\n            Object.keys(deps).forEach(function (name) {\r\n                return router.setDependency(name, deps[name]);\r\n            });\r\n            return router;\r\n        };\r\n        router.getDependencies = function () { return routerDependencies; };\r\n        router.getInjectables = function () { return [router, router.getDependencies()]; };\r\n        router.executeFactory = function (factoryFunction) {\r\n            return factoryFunction.apply(void 0, router.getInjectables());\r\n        };\r\n        return router;\r\n    };\r\n}\n\nfunction withState(router) {\r\n    var stateId = 0;\r\n    var routerState = null;\r\n    router.getState = function () { return routerState; };\r\n    router.setState = function (state) {\r\n        routerState = state;\r\n    };\r\n    router.makeState = function (name, params, path, meta, forceId) { return ({\r\n        name: name,\r\n        params: __assign(__assign({}, router.config.defaultParams[name]), params),\r\n        path: path,\r\n        meta: meta\r\n            ? __assign(__assign({}, meta), { id: forceId === undefined ? ++stateId : forceId }) : undefined\r\n    }); };\r\n    router.makeNotFoundState = function (path, options) {\r\n        return router.makeState(constants.UNKNOWN_ROUTE, { path: path }, path, {\r\n            options: options\r\n        });\r\n    };\r\n    router.areStatesEqual = function (state1, state2, ignoreQueryParams) {\r\n        if (ignoreQueryParams === void 0) { ignoreQueryParams = true; }\r\n        if (state1.name !== state2.name)\r\n            return false;\r\n        var getUrlParams = function (name) {\r\n            return router.rootNode\r\n                //@ts-ignore\r\n                .getSegmentsByName(name)\r\n                .map(function (segment) { return segment.parser['urlParams']; })\r\n                .reduce(function (params, p) { return params.concat(p); }, []);\r\n        };\r\n        var state1Params = ignoreQueryParams\r\n            ? getUrlParams(state1.name)\r\n            : Object.keys(state1.params);\r\n        var state2Params = ignoreQueryParams\r\n            ? getUrlParams(state2.name)\r\n            : Object.keys(state2.params);\r\n        return (state1Params.length === state2Params.length &&\r\n            state1Params.every(function (p) { return state1.params[p] === state2.params[p]; }));\r\n    };\r\n    router.areStatesDescendants = function (parentState, childState) {\r\n        var regex = new RegExp('^' + parentState.name + '\\\\.(.*)$');\r\n        if (!regex.test(childState.name))\r\n            return false;\r\n        // If child state name extends parent state name, and all parent state params\r\n        // are in child state params.\r\n        return Object.keys(parentState.params).every(function (p) { return parentState.params[p] === childState.params[p]; });\r\n    };\r\n    router.forwardState = function (routeName, routeParams) {\r\n        var name = router.config.forwardMap[routeName] || routeName;\r\n        var params = __assign(__assign(__assign({}, router.config.defaultParams[routeName]), router.config.defaultParams[name]), routeParams);\r\n        return {\r\n            name: name,\r\n            params: params\r\n        };\r\n    };\r\n    router.buildState = function (routeName, routeParams) {\r\n        var _a = router.forwardState(routeName, routeParams), name = _a.name, params = _a.params;\r\n        return router.rootNode.buildState(name, params);\r\n    };\r\n    return router;\r\n}\n\nvar eventsMap = {\r\n    onStart: constants.ROUTER_START,\r\n    onStop: constants.ROUTER_STOP,\r\n    onTransitionSuccess: constants.TRANSITION_SUCCESS,\r\n    onTransitionStart: constants.TRANSITION_START,\r\n    onTransitionError: constants.TRANSITION_ERROR,\r\n    onTransitionCancel: constants.TRANSITION_CANCEL\r\n};\r\nfunction withPlugins(router) {\r\n    var routerPlugins = [];\r\n    router.getPlugins = function () { return routerPlugins; };\r\n    router.usePlugin = function () {\r\n        var plugins = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            plugins[_i] = arguments[_i];\r\n        }\r\n        var removePluginFns = plugins.map(function (plugin) {\r\n            routerPlugins.push(plugin);\r\n            return startPlugin(plugin);\r\n        });\r\n        return function () {\r\n            routerPlugins = routerPlugins.filter(function (plugin) { return plugins.indexOf(plugin) === -1; });\r\n            removePluginFns.forEach(function (removePlugin) { return removePlugin(); });\r\n        };\r\n    };\r\n    function startPlugin(plugin) {\r\n        var appliedPlugin = router.executeFactory(plugin);\r\n        var removeEventListeners = Object.keys(eventsMap)\r\n            .map(function (methodName) {\r\n            if (appliedPlugin[methodName]) {\r\n                return router.addEventListener(eventsMap[methodName], appliedPlugin[methodName]);\r\n            }\r\n        })\r\n            .filter(Boolean);\r\n        return function () {\r\n            removeEventListeners.forEach(function (removeListener) { return removeListener(); });\r\n            if (appliedPlugin.teardown) {\r\n                appliedPlugin.teardown();\r\n            }\r\n        };\r\n    }\r\n    return router;\r\n}\n\nfunction withMiddleware(router) {\r\n    var middlewareFactories = [];\r\n    var middlewareFunctions = [];\r\n    router.useMiddleware = function () {\r\n        var middlewares = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            middlewares[_i] = arguments[_i];\r\n        }\r\n        var removePluginFns = middlewares.map(function (middleware) {\r\n            var middlewareFunction = router.executeFactory(middleware);\r\n            middlewareFactories.push(middleware);\r\n            middlewareFunctions.push(middlewareFunction);\r\n            return function () {\r\n                middlewareFactories = middlewareFactories.filter(function (m) { return m !== middleware; });\r\n                middlewareFunctions = middlewareFunctions.filter(function (m) { return m !== middlewareFunction; });\r\n            };\r\n        });\r\n        return function () { return removePluginFns.forEach(function (fn) { return fn(); }); };\r\n    };\r\n    router.clearMiddleware = function () {\r\n        middlewareFactories = [];\r\n        middlewareFunctions = [];\r\n        return router;\r\n    };\r\n    router.getMiddlewareFactories = function () { return middlewareFactories; };\r\n    router.getMiddlewareFunctions = function () { return middlewareFunctions; };\r\n    return router;\r\n}\n\nfunction withObservability(router) {\r\n    var callbacks = {};\r\n    router.invokeEventListeners = function (eventName) {\r\n        var args = [];\r\n        for (var _i = 1; _i < arguments.length; _i++) {\r\n            args[_i - 1] = arguments[_i];\r\n        }\r\n        (callbacks[eventName] || []).forEach(function (cb) { return cb.apply(void 0, args); });\r\n    };\r\n    router.removeEventListener = function (eventName, cb) {\r\n        callbacks[eventName] = callbacks[eventName].filter(function (_cb) { return _cb !== cb; });\r\n    };\r\n    router.addEventListener = function (eventName, cb) {\r\n        callbacks[eventName] = (callbacks[eventName] || []).concat(cb);\r\n        return function () { return router.removeEventListener(eventName, cb); };\r\n    };\r\n    function subscribe(listener) {\r\n        var isObject = typeof listener === 'object';\r\n        var finalListener = isObject ? listener.next.bind(listener) : listener;\r\n        var unsubscribeHandler = router.addEventListener(constants.TRANSITION_SUCCESS, function (toState, fromState) {\r\n            finalListener({\r\n                route: toState,\r\n                previousRoute: fromState\r\n            });\r\n        });\r\n        return isObject\r\n            ? { unsubscribe: unsubscribeHandler }\r\n            : unsubscribeHandler;\r\n    }\r\n    function observable() {\r\n        var _a;\r\n        return _a = {\r\n                subscribe: function (observer) {\r\n                    if (typeof observer !== 'object' || observer === null) {\r\n                        throw new TypeError('Expected the observer to be an object.');\r\n                    }\r\n                    return subscribe(observer);\r\n                }\r\n            },\r\n            _a[$$observable] = function () {\r\n                return this;\r\n            },\r\n            _a;\r\n    }\r\n    router.subscribe = subscribe;\r\n    //@ts-ignore\r\n    router[$$observable] = observable;\r\n    //@ts-ignore\r\n    router['@@observable'] = observable;\r\n    return router;\r\n}\n\nfunction resolve(functions, _a, callback) {\r\n    var isCancelled = _a.isCancelled, toState = _a.toState, fromState = _a.fromState, _b = _a.errorKey, errorKey = _b === void 0 ? undefined : _b;\r\n    var remainingFunctions = Array.isArray(functions)\r\n        ? functions\r\n        : Object.keys(functions);\r\n    var isState = function (obj) {\r\n        return typeof obj === 'object' &&\r\n            obj.name !== undefined &&\r\n            obj.params !== undefined &&\r\n            obj.path !== undefined;\r\n    };\r\n    var hasStateChanged = function (toState, fromState) {\r\n        return fromState.name !== toState.name ||\r\n            fromState.params !== toState.params ||\r\n            fromState.path !== toState.path;\r\n    };\r\n    var mergeStates = function (toState, fromState) { return (__assign(__assign(__assign({}, fromState), toState), { meta: __assign(__assign({}, fromState.meta), toState.meta) })); };\r\n    var processFn = function (stepFn, errBase, state, _done) {\r\n        var done = function (err, newState) {\r\n            if (err) {\r\n                _done(err);\r\n            }\r\n            else if (newState && newState !== state && isState(newState)) {\r\n                if (hasStateChanged(newState, state)) {\r\n                    console.error('[router5][transition] Warning: state values (name, params, path) were changed during transition process.');\r\n                }\r\n                _done(null, mergeStates(newState, state));\r\n            }\r\n            else {\r\n                _done(null, state);\r\n            }\r\n        };\r\n        var res = stepFn.call(null, state, fromState, done);\r\n        if (isCancelled()) {\r\n            done(null);\r\n        }\r\n        else if (typeof res === 'boolean') {\r\n            done(res ? null : errBase);\r\n        }\r\n        else if (isState(res)) {\r\n            done(null, res);\r\n        }\r\n        else if (res && typeof res.then === 'function') {\r\n            res.then(function (resVal) {\r\n                if (resVal instanceof Error)\r\n                    done({ error: resVal }, null);\r\n                else\r\n                    done(null, resVal);\r\n            }, function (err) {\r\n                if (err instanceof Error) {\r\n                    console.error(err.stack || err);\r\n                    done(__assign(__assign({}, errBase), { promiseError: err }), null);\r\n                }\r\n                else {\r\n                    done(typeof err === 'object'\r\n                        ? __assign(__assign({}, errBase), err) : errBase, null);\r\n                }\r\n            });\r\n        }\r\n        // else: wait for done to be called\r\n    };\r\n    var next = function (err, state) {\r\n        var _a;\r\n        if (isCancelled()) {\r\n            callback();\r\n        }\r\n        else if (err) {\r\n            callback(err);\r\n        }\r\n        else {\r\n            if (!remainingFunctions.length) {\r\n                callback(null, state);\r\n            }\r\n            else {\r\n                var isMapped = typeof remainingFunctions[0] === 'string';\r\n                var errBase = errorKey && isMapped\r\n                    ? (_a = {}, _a[errorKey] = remainingFunctions[0], _a) : {};\r\n                var stepFn = isMapped\r\n                    ? functions[remainingFunctions[0]]\r\n                    : remainingFunctions[0];\r\n                remainingFunctions = remainingFunctions.slice(1);\r\n                processFn(stepFn, errBase, state, next);\r\n            }\r\n        }\r\n    };\r\n    next(null, toState);\r\n}\n\nfunction transition(router, toState, fromState, opts, callback) {\r\n    var cancelled = false;\r\n    var completed = false;\r\n    var options = router.getOptions();\r\n    var _a = router.getLifecycleFunctions(), canDeactivateFunctions = _a[0], canActivateFunctions = _a[1];\r\n    var middlewareFunctions = router.getMiddlewareFunctions();\r\n    var isCancelled = function () { return cancelled; };\r\n    var cancel = function () {\r\n        if (!cancelled && !completed) {\r\n            cancelled = true;\r\n            callback({ code: errorCodes.TRANSITION_CANCELLED }, null);\r\n        }\r\n    };\r\n    var done = function (err, state) {\r\n        completed = true;\r\n        if (isCancelled()) {\r\n            return;\r\n        }\r\n        if (!err && options.autoCleanUp) {\r\n            var activeSegments_1 = nameToIDs(toState.name);\r\n            Object.keys(canDeactivateFunctions).forEach(function (name) {\r\n                if (activeSegments_1.indexOf(name) === -1)\r\n                    router.clearCanDeactivate(name);\r\n            });\r\n        }\r\n        callback(err, state || toState);\r\n    };\r\n    var makeError = function (base, err) { return (__assign(__assign({}, base), (err instanceof Object ? err : { error: err }))); };\r\n    var isUnknownRoute = toState.name === constants.UNKNOWN_ROUTE;\r\n    var asyncBase = { isCancelled: isCancelled, toState: toState, fromState: fromState };\r\n    var _b = transitionPath(toState, fromState), toDeactivate = _b.toDeactivate, toActivate = _b.toActivate;\r\n    var canDeactivate = !fromState || opts.forceDeactivate\r\n        ? []\r\n        : function (toState, fromState, cb) {\r\n            var canDeactivateFunctionMap = toDeactivate\r\n                .filter(function (name) { return canDeactivateFunctions[name]; })\r\n                .reduce(function (fnMap, name) {\r\n                var _a;\r\n                return (__assign(__assign({}, fnMap), (_a = {}, _a[name] = canDeactivateFunctions[name], _a)));\r\n            }, {});\r\n            resolve(canDeactivateFunctionMap, __assign(__assign({}, asyncBase), { errorKey: 'segment' }), function (err) {\r\n                return cb(err\r\n                    ? makeError({ code: errorCodes.CANNOT_DEACTIVATE }, err)\r\n                    : null);\r\n            });\r\n        };\r\n    var canActivate = isUnknownRoute\r\n        ? []\r\n        : function (toState, fromState, cb) {\r\n            var canActivateFunctionMap = toActivate\r\n                .filter(function (name) { return canActivateFunctions[name]; })\r\n                .reduce(function (fnMap, name) {\r\n                var _a;\r\n                return (__assign(__assign({}, fnMap), (_a = {}, _a[name] = canActivateFunctions[name], _a)));\r\n            }, {});\r\n            resolve(canActivateFunctionMap, __assign(__assign({}, asyncBase), { errorKey: 'segment' }), function (err) {\r\n                return cb(err\r\n                    ? makeError({ code: errorCodes.CANNOT_ACTIVATE }, err)\r\n                    : null);\r\n            });\r\n        };\r\n    var middleware = !middlewareFunctions.length\r\n        ? []\r\n        : function (toState, fromState, cb) {\r\n            return resolve(middlewareFunctions, __assign({}, asyncBase), function (err, state) {\r\n                return cb(err\r\n                    ? makeError({ code: errorCodes.TRANSITION_ERR }, err)\r\n                    : null, state || toState);\r\n            });\r\n        };\r\n    var pipeline = []\r\n        .concat(canDeactivate)\r\n        .concat(canActivate)\r\n        .concat(middleware);\r\n    resolve(pipeline, asyncBase, done);\r\n    return cancel;\r\n}\n\nvar noop = function () { };\r\nfunction withNavigation(router) {\r\n    var cancelCurrentTransition;\r\n    router.navigate = navigate;\r\n    router.navigate = navigate;\r\n    router.navigateToDefault = function () {\r\n        var args = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            args[_i] = arguments[_i];\r\n        }\r\n        var opts = typeof args[0] === 'object' ? args[0] : {};\r\n        var done = args.length === 2\r\n            ? args[1]\r\n            : typeof args[0] === 'function'\r\n                ? args[0]\r\n                : noop;\r\n        var options = router.getOptions();\r\n        if (options.defaultRoute) {\r\n            return navigate(options.defaultRoute, options.defaultParams, opts, done);\r\n        }\r\n        return function () { };\r\n    };\r\n    router.cancel = function () {\r\n        if (cancelCurrentTransition) {\r\n            cancelCurrentTransition('navigate');\r\n            cancelCurrentTransition = null;\r\n        }\r\n        return router;\r\n    };\r\n    function navigate() {\r\n        var args = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            args[_i] = arguments[_i];\r\n        }\r\n        var name = args[0];\r\n        var lastArg = args[args.length - 1];\r\n        var done = typeof lastArg === 'function' ? lastArg : noop;\r\n        var params = typeof args[1] === 'object' ? args[1] : {};\r\n        var opts = typeof args[2] === 'object' ? args[2] : {};\r\n        if (!router.isStarted()) {\r\n            done({ code: errorCodes.ROUTER_NOT_STARTED });\r\n            return;\r\n        }\r\n        var route = router.buildState(name, params);\r\n        if (!route) {\r\n            var err = { code: errorCodes.ROUTE_NOT_FOUND };\r\n            done(err);\r\n            router.invokeEventListeners(constants.TRANSITION_ERROR, null, router.getState(), err);\r\n            return;\r\n        }\r\n        var toState = router.makeState(route.name, route.params, router.buildPath(route.name, route.params), { params: route.meta, options: opts });\r\n        var sameStates = router.getState()\r\n            ? router.areStatesEqual(router.getState(), toState, false)\r\n            : false;\r\n        // Do not proceed further if states are the same and no reload\r\n        // (no deactivation and no callbacks)\r\n        if (sameStates && !opts.reload && !opts.force) {\r\n            var err = { code: errorCodes.SAME_STATES };\r\n            done(err);\r\n            router.invokeEventListeners(constants.TRANSITION_ERROR, toState, router.getState(), err);\r\n            return;\r\n        }\r\n        var fromState = router.getState();\r\n        if (opts.skipTransition) {\r\n            done(null, toState);\r\n            return noop;\r\n        }\r\n        // Transition\r\n        return router.transitionToState(toState, fromState, opts, function (err, state) {\r\n            if (err) {\r\n                if (err.redirect) {\r\n                    var _a = err.redirect, name_1 = _a.name, params_1 = _a.params;\r\n                    navigate(name_1, params_1, __assign(__assign({}, opts), { force: true, redirected: true }), done);\r\n                }\r\n                else {\r\n                    done(err);\r\n                }\r\n            }\r\n            else {\r\n                router.invokeEventListeners(constants.TRANSITION_SUCCESS, state, fromState, opts);\r\n                done(null, state);\r\n            }\r\n        });\r\n    }\r\n    router.transitionToState = function (toState, fromState, options, done) {\r\n        if (options === void 0) { options = {}; }\r\n        if (done === void 0) { done = noop; }\r\n        router.cancel();\r\n        router.invokeEventListeners(constants.TRANSITION_START, toState, fromState);\r\n        cancelCurrentTransition = transition(router, toState, fromState, options, function (err, state) {\r\n            cancelCurrentTransition = null;\r\n            state = state || toState;\r\n            if (err) {\r\n                if (err.code === errorCodes.TRANSITION_CANCELLED) {\r\n                    router.invokeEventListeners(constants.TRANSITION_CANCEL, toState, fromState);\r\n                }\r\n                else {\r\n                    router.invokeEventListeners(constants.TRANSITION_ERROR, toState, fromState, err);\r\n                }\r\n                done(err);\r\n            }\r\n            else {\r\n                router.setState(state);\r\n                done(null, state);\r\n            }\r\n        });\r\n        return cancelCurrentTransition;\r\n    };\r\n    return router;\r\n}\n\nvar noop$1 = function () { };\r\nfunction withRouterLifecycle(router) {\r\n    var started = false;\r\n    router.isStarted = function () { return started; };\r\n    //@ts-ignore\r\n    router.start = function () {\r\n        var args = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            args[_i] = arguments[_i];\r\n        }\r\n        var options = router.getOptions();\r\n        var lastArg = args[args.length - 1];\r\n        var done = typeof lastArg === 'function' ? lastArg : noop$1;\r\n        var startPathOrState = typeof args[0] !== 'function' ? args[0] : undefined;\r\n        if (started) {\r\n            done({ code: errorCodes.ROUTER_ALREADY_STARTED });\r\n            return router;\r\n        }\r\n        var startPath, startState;\r\n        started = true;\r\n        router.invokeEventListeners(constants.ROUTER_START);\r\n        // callback\r\n        var cb = function (err, state, invokeErrCb) {\r\n            if (invokeErrCb === void 0) { invokeErrCb = true; }\r\n            if (!err)\r\n                router.invokeEventListeners(constants.TRANSITION_SUCCESS, state, null, { replace: true });\r\n            if (err && invokeErrCb)\r\n                router.invokeEventListeners(constants.TRANSITION_ERROR, state, null, err);\r\n            done(err, state);\r\n        };\r\n        if (startPathOrState === undefined && !options.defaultRoute) {\r\n            return cb({ code: errorCodes.NO_START_PATH_OR_STATE });\r\n        }\r\n        if (typeof startPathOrState === 'string') {\r\n            startPath = startPathOrState;\r\n        }\r\n        else if (typeof startPathOrState === 'object') {\r\n            startState = startPathOrState;\r\n        }\r\n        if (!startState) {\r\n            // If no supplied start state, get start state\r\n            startState =\r\n                startPath === undefined ? null : router.matchPath(startPath);\r\n            // Navigate to default function\r\n            var navigateToDefault_1 = function () {\r\n                return router.navigateToDefault({ replace: true }, done);\r\n            };\r\n            var redirect_1 = function (route) {\r\n                return router.navigate(route.name, route.params, { replace: true, reload: true, redirected: true }, done);\r\n            };\r\n            var transitionToState = function (state) {\r\n                router.transitionToState(state, router.getState(), {}, function (err, state) {\r\n                    if (!err)\r\n                        cb(null, state);\r\n                    else if (err.redirect)\r\n                        redirect_1(err.redirect);\r\n                    else if (options.defaultRoute)\r\n                        navigateToDefault_1();\r\n                    else\r\n                        cb(err, null, false);\r\n                });\r\n            };\r\n            // If matched start path\r\n            if (startState) {\r\n                transitionToState(startState);\r\n            }\r\n            else if (options.defaultRoute) {\r\n                // If default, navigate to default\r\n                navigateToDefault_1();\r\n            }\r\n            else if (options.allowNotFound) {\r\n                transitionToState(router.makeNotFoundState(startPath, { replace: true }));\r\n            }\r\n            else {\r\n                // No start match, no default => do nothing\r\n                cb({ code: errorCodes.ROUTE_NOT_FOUND, path: startPath }, null);\r\n            }\r\n        }\r\n        else {\r\n            // Initialise router with provided start state\r\n            router.setState(startState);\r\n            cb(null, startState);\r\n        }\r\n        return router;\r\n    };\r\n    router.stop = function () {\r\n        if (started) {\r\n            router.setState(null);\r\n            started = false;\r\n            router.invokeEventListeners(constants.ROUTER_STOP);\r\n        }\r\n        return router;\r\n    };\r\n    return router;\r\n}\n\nvar toFunction = function (val) { return (typeof val === 'function' ? val : function () { return function () { return val; }; }); };\r\nfunction withRouteLifecycle(router) {\r\n    var canDeactivateFactories = {};\r\n    var canActivateFactories = {};\r\n    var canDeactivateFunctions = {};\r\n    var canActivateFunctions = {};\r\n    router.getLifecycleFactories = function () {\r\n        return [canDeactivateFactories, canActivateFactories];\r\n    };\r\n    router.getLifecycleFunctions = function () {\r\n        return [canDeactivateFunctions, canActivateFunctions];\r\n    };\r\n    router.canDeactivate = function (name, canDeactivateHandler) {\r\n        var factory = toFunction(canDeactivateHandler);\r\n        canDeactivateFactories[name] = factory;\r\n        canDeactivateFunctions[name] = router.executeFactory(factory);\r\n        return router;\r\n    };\r\n    router.clearCanDeactivate = function (name) {\r\n        canDeactivateFactories[name] = undefined;\r\n        canDeactivateFunctions[name] = undefined;\r\n        return router;\r\n    };\r\n    router.canActivate = function (name, canActivateHandler) {\r\n        var factory = toFunction(canActivateHandler);\r\n        canActivateFactories[name] = factory;\r\n        canActivateFunctions[name] = router.executeFactory(factory);\r\n        return router;\r\n    };\r\n    return router;\r\n}\n\nvar pipe = function () {\r\n    var fns = [];\r\n    for (var _i = 0; _i < arguments.length; _i++) {\r\n        fns[_i] = arguments[_i];\r\n    }\r\n    return function (arg) {\r\n        return fns.reduce(function (prev, fn) { return fn(prev); }, arg);\r\n    };\r\n};\r\nvar createRouter = function (routes, options, dependencies) {\r\n    if (routes === void 0) { routes = []; }\r\n    if (options === void 0) { options = {}; }\r\n    if (dependencies === void 0) { dependencies = {}; }\r\n    var config = {\r\n        decoders: {},\r\n        encoders: {},\r\n        defaultParams: {},\r\n        forwardMap: {}\r\n    };\r\n    return pipe(withOptions(options), withDependencies(dependencies), withObservability, withState, withRouterLifecycle, withRouteLifecycle, withNavigation, withPlugins, withMiddleware, withRoutes(routes))({ config: config });\r\n};\n\nfunction cloneRouter(router, dependencies) {\r\n    var clonedRouter = createRouter(router.rootNode, router.getOptions(), dependencies);\r\n    clonedRouter.useMiddleware.apply(clonedRouter, router.getMiddlewareFactories());\r\n    clonedRouter.usePlugin.apply(clonedRouter, router.getPlugins());\r\n    clonedRouter.config = router.config;\r\n    var _a = router.getLifecycleFactories(), canDeactivateFactories = _a[0], canActivateFactories = _a[1];\r\n    Object.keys(canDeactivateFactories).forEach(function (name) {\r\n        return clonedRouter.canDeactivate(name, canDeactivateFactories[name]);\r\n    });\r\n    Object.keys(canActivateFactories).forEach(function (name) {\r\n        return clonedRouter.canActivate(name, canActivateFactories[name]);\r\n    });\r\n    return clonedRouter;\r\n}\n\nexport default createRouter;\nexport { cloneRouter, constants, createRouter, errorCodes };\n","import { errorCodes, constants } from 'router5';\n\n/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation. All rights reserved.\r\nLicensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\nthis file except in compliance with the License. You may obtain a copy of the\r\nLicense at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nTHIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\nWARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\nMERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\nSee the Apache Version 2.0 License for specific language governing permissions\r\nand limitations under the License.\r\n***************************************************************************** */\r\n\r\nvar __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\n\r\nfunction __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\n\nvar value = function (arg) { return function () { return arg; }; };\r\nvar noop = function () { };\r\nvar isBrowser = typeof window !== 'undefined' && window.history;\r\nvar getBase = function () { return window.location.pathname; };\r\nvar supportsPopStateOnHashChange = function () {\r\n    return window.navigator.userAgent.indexOf('Trident') === -1;\r\n};\r\nvar pushState = function (state, title, path) {\r\n    return window.history.pushState(state, title, path);\r\n};\r\nvar replaceState = function (state, title, path) {\r\n    return window.history.replaceState(state, title, path);\r\n};\r\nvar addPopstateListener = function (fn, opts) {\r\n    var shouldAddHashChangeListener = opts.useHash && !supportsPopStateOnHashChange();\r\n    window.addEventListener('popstate', fn);\r\n    if (shouldAddHashChangeListener) {\r\n        window.addEventListener('hashchange', fn);\r\n    }\r\n    return function () {\r\n        window.removeEventListener('popstate', fn);\r\n        if (shouldAddHashChangeListener) {\r\n            window.removeEventListener('hashchange', fn);\r\n        }\r\n    };\r\n};\r\nvar getLocation = function (opts) {\r\n    var path = opts.useHash\r\n        ? window.location.hash.replace(new RegExp('^#' + opts.hashPrefix), '')\r\n        : window.location.pathname.replace(new RegExp('^' + opts.base), '');\r\n    // Fix issue with browsers that don't URL encode characters (Edge)\r\n    var correctedPath = safelyEncodePath(path);\r\n    return (correctedPath || '/') + window.location.search;\r\n};\r\nvar safelyEncodePath = function (path) {\r\n    try {\r\n        return encodeURI(decodeURI(path));\r\n    }\r\n    catch (_) {\r\n        return path;\r\n    }\r\n};\r\nvar getState = function () { return window.history.state; };\r\nvar getHash = function () { return window.location.hash; };\r\nvar browser = {};\r\nif (isBrowser) {\r\n    browser = {\r\n        getBase: getBase,\r\n        pushState: pushState,\r\n        replaceState: replaceState,\r\n        addPopstateListener: addPopstateListener,\r\n        getLocation: getLocation,\r\n        getState: getState,\r\n        getHash: getHash\r\n    };\r\n}\r\nelse {\r\n    browser = {\r\n        getBase: value(''),\r\n        pushState: noop,\r\n        replaceState: noop,\r\n        addPopstateListener: noop,\r\n        getLocation: value(''),\r\n        getState: value(null),\r\n        getHash: value('')\r\n    };\r\n}\r\nvar safeBrowser = browser;\n\nvar defaultOptions = {\r\n    forceDeactivate: true,\r\n    useHash: false,\r\n    hashPrefix: '',\r\n    base: '',\r\n    mergeState: false,\r\n    preserveHash: true\r\n};\r\nvar source = 'popstate';\r\nfunction browserPluginFactory(opts, browser) {\r\n    if (browser === void 0) { browser = safeBrowser; }\r\n    var options = __assign(__assign({}, defaultOptions), opts);\r\n    var transitionOptions = {\r\n        forceDeactivate: options.forceDeactivate,\r\n        source: source\r\n    };\r\n    var removePopStateListener;\r\n    return function browserPlugin(router) {\r\n        var routerOptions = router.getOptions();\r\n        var routerStart = router.start;\r\n        router.buildUrl = function (route, params) {\r\n            var base = options.base || '';\r\n            var prefix = options.useHash ? \"#\" + options.hashPrefix : '';\r\n            var path = router.buildPath(route, params);\r\n            return base + prefix + path;\r\n        };\r\n        var urlToPath = function (url) {\r\n            var match = url.match(/^(?:http|https):\\/\\/(?:[0-9a-z_\\-.:]+?)(?=\\/)(.*)$/);\r\n            var path = match ? match[1] : url;\r\n            var pathParts = path.match(/^(.+?)(#.+?)?(\\?.+)?$/);\r\n            if (!pathParts)\r\n                throw new Error(\"[router5] Could not parse url \" + url);\r\n            var pathname = pathParts[1];\r\n            var hash = pathParts[2] || '';\r\n            var search = pathParts[3] || '';\r\n            return ((options.useHash\r\n                ? hash.replace(new RegExp('^#' + options.hashPrefix), '')\r\n                : options.base\r\n                    ? pathname.replace(new RegExp('^' + options.base), '')\r\n                    : pathname) + search);\r\n        };\r\n        router.matchUrl = function (url) { return router.matchPath(urlToPath(url)); };\r\n        router.start = function () {\r\n            var args = [];\r\n            for (var _i = 0; _i < arguments.length; _i++) {\r\n                args[_i] = arguments[_i];\r\n            }\r\n            if (args.length === 0 || typeof args[0] === 'function') {\r\n                routerStart.apply(void 0, __spreadArrays([browser.getLocation(options)], args));\r\n            }\r\n            else {\r\n                routerStart.apply(void 0, args);\r\n            }\r\n            return router;\r\n        };\r\n        router.replaceHistoryState = function (name, params, title) {\r\n            if (params === void 0) { params = {}; }\r\n            if (title === void 0) { title = ''; }\r\n            var route = router.buildState(name, params);\r\n            var state = router.makeState(route.name, route.params, router.buildPath(route.name, route.params), { params: route.meta });\r\n            var url = router.buildUrl(name, params);\r\n            router.lastKnownState = state;\r\n            browser.replaceState(state, title, url);\r\n        };\r\n        function updateBrowserState(state, url, replace) {\r\n            var trimmedState = state\r\n                ? {\r\n                    meta: state.meta,\r\n                    name: state.name,\r\n                    params: state.params,\r\n                    path: state.path\r\n                }\r\n                : state;\r\n            var finalState = options.mergeState === true\r\n                ? __assign(__assign({}, browser.getState()), trimmedState) : trimmedState;\r\n            if (replace)\r\n                browser.replaceState(finalState, '', url);\r\n            else\r\n                browser.pushState(finalState, '', url);\r\n        }\r\n        function onPopState(evt) {\r\n            var routerState = router.getState();\r\n            // Do nothing if no state or if last know state is poped state (it should never happen)\r\n            var newState = !evt.state || !evt.state.name;\r\n            var state = newState\r\n                ? router.matchPath(browser.getLocation(options), source)\r\n                : router.makeState(evt.state.name, evt.state.params, evt.state.path, __assign(__assign({}, evt.state.meta), { source: source }), evt.state.meta.id);\r\n            var defaultRoute = routerOptions.defaultRoute, defaultParams = routerOptions.defaultParams;\r\n            if (!state) {\r\n                // If current state is already the default route, we will have a double entry\r\n                // Navigating back and forth will emit SAME_STATES error\r\n                defaultRoute &&\r\n                    router.navigateToDefault(__assign(__assign({}, transitionOptions), { reload: true, replace: true }));\r\n                return;\r\n            }\r\n            if (routerState &&\r\n                router.areStatesEqual(state, routerState, false)) {\r\n                return;\r\n            }\r\n            router.transitionToState(state, routerState, transitionOptions, function (err, toState) {\r\n                if (err) {\r\n                    if (err.redirect) {\r\n                        var _a = err.redirect, name_1 = _a.name, params = _a.params;\r\n                        router.navigate(name_1, params, __assign(__assign({}, transitionOptions), { replace: true, force: true, redirected: true }));\r\n                    }\r\n                    else if (err.code === errorCodes.CANNOT_DEACTIVATE) {\r\n                        var url = router.buildUrl(routerState.name, routerState.params);\r\n                        if (!newState) {\r\n                            // Keep history state unchanged but use current URL\r\n                            updateBrowserState(state, url, true);\r\n                        }\r\n                        // else do nothing or history will be messed up\r\n                        // TODO: history.back()?\r\n                    }\r\n                    else {\r\n                        // Force navigation to default state\r\n                        defaultRoute &&\r\n                            router.navigate(defaultRoute, defaultParams, __assign(__assign({}, transitionOptions), { reload: true, replace: true }));\r\n                    }\r\n                }\r\n                else {\r\n                    router.invokeEventListeners(constants.TRANSITION_SUCCESS, toState, routerState, { replace: true });\r\n                }\r\n            });\r\n        }\r\n        function onStart() {\r\n            if (options.useHash && !options.base) {\r\n                // Guess base\r\n                options.base = browser.getBase();\r\n            }\r\n            removePopStateListener = browser.addPopstateListener(onPopState, options);\r\n        }\r\n        function teardown() {\r\n            if (removePopStateListener) {\r\n                removePopStateListener();\r\n                removePopStateListener = undefined;\r\n            }\r\n        }\r\n        function onTransitionSuccess(toState, fromState, opts) {\r\n            var historyState = browser.getState();\r\n            var hasState = historyState &&\r\n                historyState.meta &&\r\n                historyState.name &&\r\n                historyState.params;\r\n            var statesAreEqual = fromState && router.areStatesEqual(fromState, toState, false);\r\n            var replace = opts.replace || !hasState || statesAreEqual;\r\n            var url = router.buildUrl(toState.name, toState.params);\r\n            if (fromState === null &&\r\n                options.useHash === false &&\r\n                options.preserveHash === true) {\r\n                url += browser.getHash();\r\n            }\r\n            updateBrowserState(toState, url, replace);\r\n        }\r\n        return {\r\n            onStart: onStart,\r\n            onStop: teardown,\r\n            teardown: teardown,\r\n            onTransitionSuccess: onTransitionSuccess,\r\n            onPopState: onPopState\r\n        };\r\n    };\r\n}\n\nexport default browserPluginFactory;\n","import createRouter from 'router5';\r\nimport browserPlugin from 'router5-plugin-browser';\r\nimport { EMPTY, from } from 'rxjs';\r\nimport { startWith } from 'rxjs/operators';\r\n\r\nexport class RouterService {\r\n\r\n\tstatic routes = [];\r\n\r\n\tstatic router_ = null;\r\n\tstatic get router() {\r\n\t\treturn this.router_;\r\n\t}\r\n\r\n\tstatic get route() {\r\n\t\tlet route = null;\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\troute = router.getState();\r\n\t\t\t// console.log('RouterService.get.route', route);\r\n\t\t}\r\n\t\treturn route;\r\n\t}\r\n\r\n\t/*\r\n\tstatic event$_ = new Subject();\r\n\tstatic event$() {\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\treturn from(router).pipe(\r\n\t\t\t\tstartWith({ route: router.getState(), previousRoute: null }),\r\n\t\t\t\ttap(event => {\r\n\t\t\t\t\t// console.log('RouterService.event$', event);\r\n\t\t\t\t\tthis.event$_.next(event);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tstatic useBrowser(routes) {\r\n\t\tif (!(Array.isArray(routes) && routes.length)) {\r\n\t\t\tthis.event$ = EMPTY;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.routes = routes;\r\n\t\tconst router = createRouter(routes, {\r\n\t\t\tallowNotFound: false,\r\n\t\t\tautoCleanUp: true,\r\n\t\t\tdefaultRoute: 'index',\r\n\t\t\tdefaultParams: {},\r\n\t\t\tqueryParams: {\r\n\t\t\t\tarrayFormat: 'default',\r\n\t\t\t\tnullFormat: 'default',\r\n\t\t\t\tbooleanFormat: 'default'\r\n\t\t\t},\r\n\t\t\tqueryParamsMode: 'default',\r\n\t\t\ttrailingSlashMode: 'default',\r\n\t\t\tstrictTrailingSlash: false,\r\n\t\t\tcaseSensitive: false,\r\n\t\t\turlParamsEncoding: 'default'\r\n\t\t});\r\n\t\tthis.router_ = router;\r\n\t\trouter.usePlugin(browserPlugin({\r\n\t\t\tuseHash: false\r\n\t\t}));\r\n\t\trouter.start();\r\n\t\tthis.event$ = from(router).pipe(\r\n\t\t\tstartWith({ route: router.getState(), previousRoute: null }),\r\n\t\t\t// tap(event => { console.log('RouterService.event$', event); }),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic useBrowser$(routes) {\r\n\t\tthis.useBrowser(routes);\r\n\t\treturn this.event$;\r\n\t}\r\n\r\n\tstatic setRouterLink(routerLink = 'it.access', routeParams = null, options = { reload: true }) {\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\t// router.matchUrl(routerLink);\r\n\t\t\ttry {\r\n\t\t\t\trouter.navigate(routerLink, routeParams, options);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('RouterService.setRouterLink.error', error);\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log('RouterService.setRouterLink', router, routerLink, routeParams, options);\r\n\t}\r\n\r\n\tstatic replaceHistoryState(name, params) {\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\t// router.matchUrl(routerLink);\r\n\t\t\ttry {\r\n\t\t\t\trouter.replaceHistoryState(name, params);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('RouterService.replaceHistoryState.error', error);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic setCurrentParams(params) {\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\ttry {\r\n\t\t\t\tconst route = this.route;\r\n\t\t\t\tif (route) {\r\n\t\t\t\t\trouter.replaceHistoryState(route.name, params);\r\n\t\t\t\t}\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('RouterService.setCurrentParams.error', error);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic buildPath(route, params = null) {\r\n\t\tlet path = null;\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\ttry {\r\n\t\t\t\tpath = router.buildPath(route, params);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('RouterService.buildPath.error', error);\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log('RouterService.buildPath', path, route, params);\r\n\t\t// router.buildUrl(routeName, routeParams)\r\n\t\treturn path;\r\n\t}\r\n\r\n\tstatic buildUrl(routeName, routeParams = null) {\r\n\t\tlet url = null;\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\ttry {\r\n\t\t\t\turl = router.buildUrl(routeName, routeParams);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('RouterService.buildUrl.error', error);\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log('RouterService.buildUrl', url, routeName, routeParams);\r\n\t\treturn url;\r\n\t}\r\n\r\n\tstatic isActive(name, params, strictEquality = false, ignoreQueryParams = true) {\r\n\t\tlet active = false;\r\n\t\tconst router = this.router_;\r\n\t\tif (router) {\r\n\t\t\ttry {\r\n\t\t\t\tactive = router.isActive(name, params, strictEquality, ignoreQueryParams);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('RouterService.isActive.error', error);\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log('RouterService.isActive', active, name, params, strictEquality, ignoreQueryParams);\r\n\t\treturn active;\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nexport default class StateService {\r\n\tstatic state$ = new BehaviorSubject({});\r\n\tstatic set state(state) {\r\n\t\tthis.state$.next(state);\r\n\t}\r\n\tstatic get state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\tstatic patchState(state) {\r\n\t\tstate = Object.assign({}, this.state, state);\r\n\t\tthis.state = state;\r\n\t}\r\n}\r\n","\r\nexport const RoleType = {\r\n\tPublisher: 'publisher',\r\n\tAttendee: 'attendee',\r\n\tStreamer: 'streamer',\r\n\tViewer: 'viewer',\r\n\tSmartDevice: 'smart-device',\r\n\tSelfService: 'self-service',\r\n\tEmbed: 'embed',\r\n};\r\n\r\nexport class User {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n","import StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport const MEETING_ID_VALIDATOR = /^\\d{9}-\\d{4}-\\d{13}(-\\d+)?$/;\r\n\r\nexport class MeetingId {\r\n\r\n\tget roleIndex() {\r\n\t\treturn MeetingId.getRoleIndex(this.role);\r\n\t}\r\n\tset roleIndex(roleIndex) {\r\n\t\tconst roleIndex_ = MeetingId.getRoleIndex(this.role);\r\n\t\tif (roleIndex_ !== roleIndex) {\r\n\t\t\tconst key = Object.keys(RoleType)[roleIndex];\r\n\t\t\tthis.role = RoleType[key];\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tthis.userId = StateService.state.user ? StateService.state.user.id : 0;\r\n\t\tthis.role = StateService.state.role || RoleType.Viewer;\r\n\t\tthis.timestamp = new Date().valueOf().toString();\r\n\t\tthis.pathId = null;\r\n\t\t// this.timestamp = (performance.now() * 10000000000000).toString();\r\n\t\tif (typeof options === 'string') {\r\n\t\t\tif (options.match(MEETING_ID_VALIDATOR)) {\r\n\t\t\t\toptions = MeetingId.decompose(options);\r\n\t\t\t} else {\r\n\t\t\t\tconsole.warn('MeetingId', 'invalid meetingId', options);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (typeof options === 'object') {\r\n\t\t\tif (options.id) {\r\n\t\t\t\tthis.id = options.id;\r\n\t\t\t}\r\n\t\t\tif (options.userId) {\r\n\t\t\t\tthis.userId = options.userId;\r\n\t\t\t}\r\n\t\t\tif (options.role) {\r\n\t\t\t\tthis.role = options.role;\r\n\t\t\t}\r\n\t\t\tif (options.roleIndex) {\r\n\t\t\t\tthis.roleIndex = options.roleIndex;\r\n\t\t\t}\r\n\t\t\tif (options.timestamp) {\r\n\t\t\t\tthis.timestamp = options.timestamp;\r\n\t\t\t}\r\n\t\t\tif (options.pathId) {\r\n\t\t\t\tthis.pathId = options.pathId;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log('MeetingId', this);\r\n\t}\r\n\r\n\ttoString() {\r\n\t\treturn MeetingId.compose(this.userId, this.roleIndex, this.timestamp, this.pathId);\r\n\t}\r\n\r\n\ttoRoles() {\r\n\t\tconst userId = this.userId;\r\n\t\tconst timestamp = this.timestamp;\r\n\t\tconst pathId = this.pathId;\r\n\t\treturn {\r\n\t\t\tid: MeetingId.compose(userId, MeetingId.getRoleIndex(RoleType.Publisher), timestamp, pathId),\r\n\t\t\tidAttendee: MeetingId.compose(userId, MeetingId.getRoleIndex(RoleType.Attendee), timestamp, pathId),\r\n\t\t\tidStreamer: MeetingId.compose(userId, MeetingId.getRoleIndex(RoleType.Streamer), timestamp, pathId),\r\n\t\t\tidViewer: MeetingId.compose(userId, MeetingId.getRoleIndex(RoleType.Viewer), timestamp, pathId),\r\n\t\t\tidSmartDevice: MeetingId.compose(userId, MeetingId.getRoleIndex(RoleType.SmartDevice), timestamp, pathId),\r\n\t\t\tidSelfService: MeetingId.compose(userId, MeetingId.getRoleIndex(RoleType.SelfService), timestamp, pathId),\r\n\t\t};\r\n\t}\r\n\r\n\tstatic compose(userId, roleIndex, timestamp, pathId) {\r\n\t\treturn `${MeetingId.padded(userId, 9)}-${MeetingId.padded(roleIndex, 4)}-${timestamp}${pathId ? `-${pathId}` : ''}`;\r\n\t}\r\n\r\n\tstatic decompose(meetingId) {\r\n\t\tconst components = meetingId.split('-');\r\n\t\treturn {\r\n\t\t\tuserId: parseInt(components[0]),\r\n\t\t\troleIndex: parseInt(components[1]),\r\n\t\t\ttimestamp: parseInt(components[2]),\r\n\t\t\tpathId: components[3] ? parseInt(components[3]) : null,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic generateMeetingId() {\r\n\t\tconst meetingId = new MeetingId();\r\n\t\treturn meetingId.toRoles();\r\n\t}\r\n\r\n\tstatic getRoleIndex(role) {\r\n\t\treturn Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\treturn RoleType[c] === role ? i : p;\r\n\t\t}, -1);\r\n\t}\r\n\r\n\tstatic padded(num, size) {\r\n\t\tconst s = '000000000' + num;\r\n\t\treturn s.substr(s.length - size);\r\n\t}\r\n}\r\n","import { environment } from '../environment';\r\nimport { RouterService } from '../router/router.service';\r\nimport { MeetingId } from './meeting-id';\r\n\r\nexport class MeetingUrl {\r\n\r\n\tget meetingId() {\r\n\t\treturn this.link ? new MeetingId(this.link) : null;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\t/*\r\n\t\tthis.link = LocationService.get('link') || null;\r\n\t\tthis.name = LocationService.get('name') || null;\r\n\t\tthis.firstName = LocationService.get('firstName') || null;\r\n\t\tthis.lastName = LocationService.get('lastName') || null;\r\n\t\tthis.email = LocationService.get('email') || null;\r\n\t\tthis.role = LocationService.get('role') || null;\r\n\t\tthis.viewId = LocationService.has('viewId') ? parseInt(LocationService.get('viewId')) : null;\r\n\t\tthis.pathId = LocationService.has('pathId') ? parseInt(LocationService.get('pathId')) : null;\r\n\t\tthis.embedViewId = LocationService.has('embedViewId') ? parseInt(LocationService.get('embedViewId')) : null;\r\n\t\tthis.support = LocationService.has('support') ? (LocationService.get('support') === 'true') : false;\r\n\t\t*/\r\n\t\toptions = options || window.location.href;\r\n\t\tif (typeof options === 'string') {\r\n\t\t\toptions = MeetingUrl.decompose(options);\r\n\t\t}\r\n\t\tif (typeof options === 'object') {\r\n\t\t\tObject.assign(this, options);\r\n\t\t\tif (options.user) {\r\n\t\t\t\tconst name = MeetingUrl.getName(options.user);\r\n\t\t\t\tif (name) {\r\n\t\t\t\t\tthis.name = name;\r\n\t\t\t\t}\r\n\t\t\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\t\t\tconst firstName = MeetingUrl.getFirstName(options.user);\r\n\t\t\t\t\tif (firstName) {\r\n\t\t\t\t\t\tthis.firstName = firstName;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst lastName = MeetingUrl.getLastName(options.user);\r\n\t\t\t\t\tif (lastName) {\r\n\t\t\t\t\t\tthis.lastName = lastName;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst email = MeetingUrl.getEmail(options.user);\r\n\t\t\t\t\tif (email) {\r\n\t\t\t\t\t\tthis.email = email;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (options.name) {\r\n\t\t\t\tthis.name = options.name;\r\n\t\t\t}\r\n\t\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\t\tif (options.firstName) {\r\n\t\t\t\t\tthis.firstName = options.firstName;\r\n\t\t\t\t}\r\n\t\t\t\tif (options.lastName) {\r\n\t\t\t\t\tthis.lastName = options.lastName;\r\n\t\t\t\t}\r\n\t\t\t\tif (options.email) {\r\n\t\t\t\t\tthis.email = options.email;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.link = this.link || null;\r\n\t\tthis.name = this.name || null;\r\n\t\tthis.firstName = this.firstName || null;\r\n\t\tthis.lastName = this.lastName || null;\r\n\t\tthis.email = this.email || null;\r\n\t\tthis.role = this.role || null;\r\n\t\tthis.viewId = this.viewId || null;\r\n\t\tthis.pathId = this.pathId || null;\r\n\t\tthis.embedViewId = this.embedViewId || null;\r\n\t\tthis.support = this.support || false;\r\n\t\t// console.log('MeetingUrl', this);\r\n\t}\r\n\r\n\ttoParams(shareable = false) {\r\n\t\tlet params = {};\r\n\t\tif (this.link) {\r\n\t\t\tparams.link = this.link;\r\n\t\t}\r\n\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\tif (this.firstName) {\r\n\t\t\t\tparams.firstName = this.firstName;\r\n\t\t\t}\r\n\t\t\tif (this.lastName) {\r\n\t\t\t\tparams.lastName = this.lastName;\r\n\t\t\t}\r\n\t\t\tif (this.email) {\r\n\t\t\t\tparams.email = this.email;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (this.name) {\r\n\t\t\t\tparams.name = this.name;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this.role && !shareable) {\r\n\t\t\tparams.role = this.role;\r\n\t\t}\r\n\t\tif (this.viewId) {\r\n\t\t\tparams.viewId = this.viewId;\r\n\t\t}\r\n\t\tif (this.pathId) {\r\n\t\t\tparams.pathId = this.pathId;\r\n\t\t}\r\n\t\tif (this.support) {\r\n\t\t\tparams.support = this.support;\r\n\t\t}\r\n\t\tif (environment.flags.useEncryptedUrl) {\r\n\t\t\tparams = {\r\n\t\t\t\tp: MeetingUrl.encrypt(params),\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn params;\r\n\t}\r\n\r\n\ttoString(shareable = false) {\r\n\t\tlet components;\r\n\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\tcomponents = {\r\n\t\t\t\tlink: this.link,\r\n\t\t\t\tfirstName: this.firstName,\r\n\t\t\t\tlastName: this.lastName,\r\n\t\t\t\temail: this.email,\r\n\t\t\t\trole: shareable ? null : this.role,\r\n\t\t\t\tviewId: this.viewId,\r\n\t\t\t\tpathId: this.pathId,\r\n\t\t\t\tsupport: this.support\r\n\t\t\t};\r\n\t\t} else {\r\n\t\t\tcomponents = {\r\n\t\t\t\tlink: this.link,\r\n\t\t\t\tname: this.name,\r\n\t\t\t\trole: shareable ? null : this.role,\r\n\t\t\t\tviewId: this.viewId,\r\n\t\t\t\tpathId: this.pathId,\r\n\t\t\t\tsupport: this.support\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn MeetingUrl.compose(components);\r\n\t}\r\n\r\n\ttoUrl() {\r\n\t\tconst params = this.toParams();\r\n\t\treturn MeetingUrl.getCurrentUrl(params);\r\n\t}\r\n\r\n\ttoAccessCodeUrl() {\r\n\t\tconst params = this.toParams();\r\n\t\treturn MeetingUrl.getAccessCodeUrl(params);\r\n\t}\r\n\r\n\ttoGuidedTourUrl() {\r\n\t\tconst params = this.toParams();\r\n\t\treturn MeetingUrl.getGuidedTourUrl(params);\r\n\t}\r\n\r\n\tcopyToClipBoard(asAccessCode = false) {\r\n\t\tconst input = document.createElement('input');\r\n\t\tinput.style.position = 'absolute';\r\n\t\tinput.style.top = '1000vh';\r\n\t\t// input.style.visibility = 'hidden';\r\n\t\tdocument.querySelector('body').appendChild(input);\r\n\t\tconst params = this.toParams(true);\r\n\t\tinput.value = window.location.origin + (asAccessCode ? MeetingUrl.getAccessCodeUrl(params) : MeetingUrl.getGuidedTourUrl(params));\r\n\t\tinput.focus();\r\n\t\tinput.select();\r\n\t\tinput.setSelectionRange(0, 99999);\r\n\t\tdocument.execCommand('copy');\r\n\t\tinput.parentNode.removeChild(input);\r\n\t\talert(`link copiato!\\n ${input.value}`);\r\n\t}\r\n\r\n\treplaceUrl() {\r\n\t\tRouterService.setCurrentParams(this.toParams());\r\n\t}\r\n\r\n\tstatic replaceWithOptions(options) {\r\n\t\tconst currentOptions = MeetingUrl.decompose(window.location.href);\r\n\t\tconst meetingUrl = new MeetingUrl(Object.assign(currentOptions, options));\r\n\t\tmeetingUrl.replaceUrl();\r\n\t\treturn meetingUrl;\r\n\t}\r\n\r\n\tstatic replaceWithUser(user) {\r\n\t\treturn this.replaceWithOptions({ user });\r\n\t}\r\n\r\n\tstatic replaceWithName(name) {\r\n\t\treturn this.replaceWithOptions({ name });\r\n\t}\r\n\r\n\tstatic replaceWithLink(link) {\r\n\t\treturn this.replaceWithOptions({ link });\r\n\t}\r\n\r\n\tstatic getCurrentUrl(params = null) {\r\n\t\tconst route = RouterService.route;\r\n\t\tif (route) {\r\n\t\t\tconst routeName = route.name;\r\n\t\t\t// console.log('MeetingUrl.getCurrentUrl', routeName);\r\n\t\t\treturn RouterService.buildUrl(routeName, params);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getAccessCodeUrl(params = null) {\r\n\t\tconst route = RouterService.route;\r\n\t\tif (route) {\r\n\t\t\tconst routeName = `${route.params.lang}.accessCode`;\r\n\t\t\t// console.log('MeetingUrl.getAccessCodeUrl', routeName);\r\n\t\t\treturn RouterService.buildUrl(routeName, params);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getGuidedTourUrl(params = null) {\r\n\t\tconst route = RouterService.route;\r\n\t\tif (route) {\r\n\t\t\tconst routeName = `${route.params.lang}.guidedTour`;\r\n\t\t\t// console.log('MeetingUrl.getGuidedTourUrl', routeName);\r\n\t\t\treturn RouterService.buildUrl(routeName, params);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getName(user) {\r\n\t\treturn (user && user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t}\r\n\r\n\tstatic getFirstName(user) {\r\n\t\treturn (user && user.firstName ? user.firstName : null);\r\n\t}\r\n\r\n\tstatic getLastName(user) {\r\n\t\treturn (user && user.lastName ? user.lastName : null);\r\n\t}\r\n\r\n\tstatic getEmail(user) {\r\n\t\treturn (user && user.email ? user.email : null);\r\n\t}\r\n\r\n\tstatic compose(components) {\r\n\t\tif (environment.flags.useEncryptedUrl) {\r\n\t\t\tconst p = MeetingUrl.encrypt(components);\r\n\t\t\treturn `?p=${p}`;\r\n\t\t} else {\r\n\t\t\tcomponents = Object.keys(components).map(key => {\r\n\t\t\t\treturn { key, value: components[key] }\r\n\t\t\t}).filter(x => x.value != null && x.value !== false).map(x => `${x.key}=${x.value}`);\r\n\t\t\treturn `?${components.join('&')}`;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic decompose(url) {\r\n\t\tlet components = {};\r\n\t\tif (environment.flags.useEncryptedUrl) {\r\n\t\t\tconst params = new URLSearchParams(url.split('?')[1]);\r\n\t\t\tif (params.has('p')) {\r\n\t\t\t\tcomponents = MeetingUrl.decrypt(params.get('p'));\r\n\t\t\t}\r\n\t\t} else if (url.indexOf('?') > -1) {\r\n\t\t\tconst params = new URLSearchParams(url.split('?')[1]);\r\n\t\t\tparams.forEach((value, key) => {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'viewId':\r\n\t\t\t\t\tcase 'pathId':\r\n\t\t\t\t\tcase 'embedViewId':\r\n\t\t\t\t\t\tvalue = value ? parseInt(value) : null;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'support':\r\n\t\t\t\t\t\tvalue = value ? (value === 'true') : false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcomponents[key] = value;\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn components;\r\n\t}\r\n\r\n\tstatic decrypt(p) {\r\n\t\treturn JSON.parse(window.atob(p));\r\n\t}\r\n\r\n\tstatic encrypt(params) {\r\n\t\treturn window.btoa(JSON.stringify(params));\r\n\t}\r\n\r\n\tstatic validateParams(components) {\r\n\t\tif (environment.flags.useEncryptedUrl) {\r\n\t\t\tconst p = MeetingUrl.encrypt(components);\r\n\t\t\treturn { p };\r\n\t\t} else {\r\n\t\t\treturn components;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { getContext, Structure } from 'rxcomp';\r\nimport { EMPTY, of } from 'rxjs';\r\nimport { map, switchMap, takeUntil, tap } from 'rxjs/operators';\r\n// import View, { EnterTransition, LeaveTransition, OnceTransition } from '../core/view';\r\n// import { transitionOnce, transitionOnced } from '../transition/transition';\r\nimport { RouterService } from './router.service';\r\n\r\nexport class RouterOutletStructure extends Structure {\r\n\r\n\t// host;\r\n\t// outlet;\r\n\t// element;\r\n\t// instance;\r\n\t// route$_ = new ReplaySubject(1);\r\n\r\n\tgetFactory(route) {\r\n\t\tlet factory = null;\r\n\t\tconst routes = RouterService.routes;\r\n\t\tconst originalRoute = routes.find(x => x.name === route.name);\r\n\t\tif (originalRoute) {\r\n\t\t\tfactory = originalRoute.factory;\r\n\t\t}\r\n\t\t// console.log('RouterOutletStructure.getFactory', originalRoute, routes, route);\r\n\t\treturn factory;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.route$().pipe(\r\n\t\t\tswitchMap(route => this.factory$(route)),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// console.log('RouterOutletStructure.route$', event);\r\n\t\t});\r\n\t\t/*\r\n\t\tthis.route$().pipe(\r\n\t\t\tswitchMap(snapshot => this.factory$(snapshot)),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(() => {\r\n\t\t\t// console.log(`RouterOutletStructure ActivatedRoutes: [\"${RouterService.flatRoutes.filter(x => x.snapshot).map(x => x.snapshot?.extractedUrl).join('\", \"')}\"]`);\r\n\t\t});\r\n\t\tif (this.host) {\r\n\t\t\tthis.route$_.next(this.host.route.childRoute);\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\troute$() {\r\n\t\treturn RouterService.event$.pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tconst route = event.route;\r\n\t\t\t\tthis.route = route;\r\n\t\t\t\t// console.log('RouterOutletStructure.route', route);\r\n\t\t\t\treturn route;\r\n\t\t\t}),\r\n\t\t);\r\n\t\t/*\r\n\t\tconst routes = this.routes;\r\n\t\t// console.log('RouterOutletStructure.route$', routes);\r\n\t\tif (routes) {\r\n\t\t\treturn RouterService.useBrowser$(routes).pipe(\r\n\t\t\t\tmap(event => {\r\n\t\t\t\t\t// console.log('RouterOutletStructure.route$', event);\r\n\t\t\t\t\treturn event.route;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tfactory$(route) {\r\n\t\tconst factory = this.getFactory(route);\r\n\t\t// console.log('RouterOutletStructure.factory$', route, factory);\r\n\t\tconst { module, node } = getContext(this);\r\n\t\tif (true || this.factory_ !== factory) {\r\n\t\t\tthis.factory_ = factory;\r\n\t\t\treturn of(factory).pipe(\r\n\t\t\t\ttap(() => {\r\n\t\t\t\t\tif (this.element) {\r\n\t\t\t\t\t\tthis.element.parentNode.removeChild(this.element);\r\n\t\t\t\t\t\tmodule.remove(this.element, this);\r\n\t\t\t\t\t\tthis.element = undefined;\r\n\t\t\t\t\t\tthis.instance = undefined;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tmap(() => {\r\n\t\t\t\t\tif (factory && factory.meta.template) {\r\n\t\t\t\t\t\tlet element = document.createElement('div');\r\n\t\t\t\t\t\telement.innerHTML = factory.meta.template;\r\n\t\t\t\t\t\tif (element.children.length === 1) {\r\n\t\t\t\t\t\t\telement = element.firstElementChild;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tnode.appendChild(element);\r\n\t\t\t\t\t\tconst instance = module.makeInstance(element, factory, factory.meta.selector, this, undefined, { route });\r\n\t\t\t\t\t\tmodule.compile(element, instance);\r\n\t\t\t\t\t\tthis.instance = instance;\r\n\t\t\t\t\t\tthis.element = element;\r\n\t\t\t\t\t\treturn { element, instance };\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t/*\r\n\t\tif (this.host) {\r\n\t\t\tthis.route$_.next(this.host.route.childRoute);\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\t/*\r\n\troute$() {\r\n\t\tconst source = this.host ? this.route$_ : RouterService.route$;\r\n\t\treturn source.pipe(\r\n\t\t\tfilter((snapshot) => {\r\n\t\t\t\tthis.route_ = snapshot; // !!!\r\n\t\t\t\tif (this.snapshot_ && snapshot && this.snapshot_.component === snapshot.component) {\r\n\t\t\t\t\tthis.snapshot_.next(snapshot);\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.snapshot_ = snapshot;\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\t/*\r\n\tfactory$(snapshot) {\r\n\t\tconst { module, node } = getContext(this);\r\n\t\tconst factory = snapshot.component;\r\n\t\tif (this.factory_ !== factory) {\r\n\t\t\tthis.factory_ = factory;\r\n\t\t\treturn this.onLeave$_(snapshot, this.element, this.instance).pipe(\r\n\t\t\t\ttap(() => {\r\n\t\t\t\t\tif (this.element) {\r\n\t\t\t\t\t\tthis.element.parentNode.removeChild(this.element);\r\n\t\t\t\t\t\tmodule.remove(this.element, this);\r\n\t\t\t\t\t\tthis.element = undefined;\r\n\t\t\t\t\t\tthis.instance = undefined;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tswitchMap(() => {\r\n\t\t\t\t\tif (snapshot && factory && factory.meta.template) {\r\n\t\t\t\t\t\tlet element = document.createElement('div');\r\n\t\t\t\t\t\telement.innerHTML = factory.meta.template;\r\n\t\t\t\t\t\tif (element.children.length === 1) {\r\n\t\t\t\t\t\t\telement = element.firstElementChild;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tnode.appendChild(element);\r\n\t\t\t\t\t\tconst instance = module.makeInstance(element, factory, factory.meta.selector, this, undefined, { route: snapshot });\r\n\t\t\t\t\t\tmodule.compile(element, instance);\r\n\t\t\t\t\t\tthis.instance = instance;\r\n\t\t\t\t\t\tthis.element = element;\r\n\t\t\t\t\t\tsnapshot.element = element;\r\n\t\t\t\t\t\treturn this.onOnce$_(snapshot, element, instance).pipe(\r\n\t\t\t\t\t\t\tswitchMap(() => {\r\n\t\t\t\t\t\t\t\treturn this.onEnter$_(snapshot, element, instance);\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn of(void 0);\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(void 0);\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\t/*\r\n\tonOnce$_(snapshot, element, instance) {\r\n\t\tif (!transitionOnced() && instance instanceof View && element) {\r\n\t\t\ttransitionOnce();\r\n\t\t\tconst factory = instance.constructor;\r\n\t\t\tconst transition = factory.transitions.find((x) => x instanceof OnceTransition && x.matcher(snapshot.previousRoute?.path));\r\n\t\t\treturn transition ? asObservable([element, snapshot.previousRoute], transition.callback.bind(instance)) : of(void 0);\r\n\t\t} else {\r\n\t\t\treturn of(void 0);\r\n\t\t}\r\n\t}\r\n\r\n\tonEnter$_(snapshot, element, instance) {\r\n\t\tif (instance instanceof View && element) {\r\n\t\t\tconst factory = instance.constructor;\r\n\t\t\tconst transition = factory.transitions.find((x) => x instanceof EnterTransition && x.matcher(snapshot.previousRoute?.path));\r\n\t\t\treturn transition ? asObservable([element, snapshot.previousRoute], transition.callback.bind(instance)) : of(void 0);\r\n\t\t} else {\r\n\t\t\treturn of(void 0);\r\n\t\t}\r\n\t}\r\n\r\n\tonLeave$_(snapshot, element, instance) {\r\n\t\tif (instance instanceof View && element) {\r\n\t\t\tconst factory = instance.constructor;\r\n\t\t\tconst transition = factory.transitions.find((x) => x instanceof LeaveTransition && x.matcher(snapshot?.path));\r\n\t\t\treturn transition ? asObservable([element, snapshot], transition.callback.bind(instance)) : of(void 0);\r\n\t\t} else {\r\n\t\t\treturn of(void 0);\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tstatic meta = {\r\n\t\tselector: 'router-outlet,[router-outlet]',\r\n\t\thosts: { host: RouterOutletStructure },\r\n\t};\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { CHUNK_BACKGROUND, CHUNK_CREDITS, CHUNK_LANGUAGE, CHUNK_LOGO } from '../agora/agora.component.chunks';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { RouterOutletStructure } from '../router/router-outlet.structure';\r\n// import { RouterService } from '../router/router.service';\r\n\r\nexport default class AccessCodeComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.state = {};\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\tif (!meetingUrl.link) {\r\n\t\t\t// !!!\r\n\t\t\t// RouterService.setRouterLink(MeetingUrl.getGuidedTourUrl());\r\n\t\t\twindow.location.href = window.location.origin + MeetingUrl.getGuidedTourUrl();\r\n\t\t} else {\r\n\t\t\tconst url = meetingUrl.toGuidedTourUrl();\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst qrcode = new QRious({\r\n\t\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\t\tvalue: url,\r\n\t\t\t\tsize: 256\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nAccessCodeComponent.meta = {\r\n\tselector: '[access-code-component]',\r\n\thosts: { host: RouterOutletStructure },\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"page page--access-code\">\r\n\t\t\t${CHUNK_BACKGROUND}\r\n\t\t\t<!-- access-code -->\r\n\t\t\t<div class=\"ui ui--info ui--info-centered\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"'access_code_title' | label\"></div>\r\n\t\t\t\t\t\t<div class=\"picture\">\r\n\t\t\t\t\t\t\t<canvas class=\"qrcode\"></canvas>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t${CHUNK_LOGO}\r\n\t\t\t${CHUNK_CREDITS}\r\n\t\t\t${CHUNK_LANGUAGE}\r\n\t\t</div>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormAbstractCollectionDirective, FormControl, FormGroup, Validators } from 'rxcomp-form';\r\n\r\nexport default class ControlsComponent extends Component {\r\n\r\n\tget group() {\r\n\t\tif (this.formGroup) {\r\n\t\t\treturn this.formGroup;\r\n\t\t} else {\r\n\t\t\tif (!this.host) {\r\n\t\t\t\tthrow ('missing form collection');\r\n\t\t\t}\r\n\t\t\treturn this.host.control;\r\n\t\t}\r\n\t}\r\n\r\n\tgetControl(name) {\r\n\t\treturn this.group.get(name);\r\n\t}\r\n}\r\n\r\nControlsComponent.meta = {\r\n\tselector: '[controls]',\r\n\tinputs: ['formGroup', 'fields'],\r\n\thosts: { host: FormAbstractCollectionDirective },\r\n\ttemplate: /* html */`\r\n\t\t<div *for=\"let field of fields\">\r\n\t\t\t<div *if=\"['text', 'email', 'url'].indexOf(field.type) !== -1\" control-text [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'select'\" control-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'custom-select'\" control-custom-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'textarea'\" control-textarea [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'checkbox'\" control-checkbox [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<input *if=\"field.type == 'hidden'\" [name]=\"field.name\" [formControl]=\"getControl(field.name)\" value=\"\" type=\"text\" style=\"display:none !important;\" />\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nexport function fieldsToFormControls(fields) {\r\n\tconst controls = fields.reduce((p, c, i) => {\r\n\t\tconst validators = [];\r\n\t\tif (c.required) {\r\n\t\t\tvalidators.push(c.type === 'checkbox' ? Validators.RequiredTrueValidator() : Validators.RequiredValidator());\r\n\t\t}\r\n\t\tif (c.type === 'email') {\r\n\t\t\tvalidators.push(Validators.EmailValidator());\r\n\t\t}\r\n\t\tif (c.type === 'url') {\r\n\t\t\tvalidators.push(Validators.PatternValidator('(https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|www\\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9]+\\.[^\\s]{2,}|www\\.[a-zA-Z0-9]+\\.[^\\s]{2,})'));\r\n\t\t}\r\n\t\tif (c.pattern != null) {\r\n\t\t\tvalidators.push(Validators.PatternValidator(c.pattern));\r\n\t\t}\r\n\t\tp[c.name] = new FormControl((c.value != null ? c.value : null), validators);\r\n\t\tif (c.type === 'select' || c.type === 'custom-select') {\r\n\t\t\tconst options = (c.options || []).slice();\r\n\t\t\toptions.unshift({ id: null, name: 'select', }); // LabelPipe.transform('select')\r\n\t\t\tp[c.name].options = options;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\treturn controls;\r\n}\r\n\r\nexport function fieldsToFormGroup(fields) {\r\n\treturn new FormGroup(fieldsToFormControls(fields));\r\n}\r\n\r\nexport function patchFields(fields, form) {\r\n\tconst testValues = fields.reduce((p, c, i) => {\r\n\t\tif (c.test) {\r\n\t\t\tp[c.name] = c.test;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\tform.patch(testValues);\r\n}\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\n\r\nexport class LabelPipe extends Pipe {\r\n\r\n\tstatic get labels() {\r\n\t\treturn environment.labels;\r\n\t}\r\n\r\n\tstatic transform(key) {\r\n\t\tswitch (key) {\r\n\t\t\tcase '@copy':\r\n\t\t\t\treturn this.getCopy();\r\n\t\t}\r\n\t\tconst labels = LabelPipe.labels;\r\n\t\tlet label = labels[key] != null ? labels[key] : key; // `#${key}#`;\r\n\t\tif (typeof label === 'string' && label.indexOf('@copy') !== -1) {\r\n\t\t\tlabel = label.replace('@copy', this.getCopy());\r\n\t\t}\r\n\t\treturn label;\r\n\t}\r\n\r\n\tstatic getKeys(...keys) {\r\n\t\treturn LabelPipe.transform(keys.map(x => x.replace('-', '_')).join('_'));\r\n\t}\r\n\r\n\tstatic getCopy() {\r\n\t\treturn `${new Date().getFullYear()}`;\r\n\t}\r\n}\r\n\r\nLabelPipe.meta = {\r\n\tname: 'label',\r\n};\r\n","export default class LocationService {\r\n\r\n\tstatic has(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.has', params);\r\n\t\treturn params.has(key);\r\n\t}\r\n\r\n\tstatic get(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.get', params);\r\n\t\treturn params.get(key);\r\n\t}\r\n\r\n\tstatic set(keyOrValue, value) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams.set(keyOrValue, value);\r\n\t\t} else {\r\n\t\t\tparams.set(keyOrValue, '');\r\n\t\t}\r\n\t\tthis.pushParams(params);\r\n\t\t// console.log('LocationService.set', params, keyOrValue, value);\r\n\t}\r\n\r\n\tstatic delete(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.has', params);\r\n\t\tif (params.has(key)) {\r\n\t\t\tparams.delete(key);\r\n\t\t\tthis.pushParams(params);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic pushParams(params) {\r\n\t\tif (window.history && window.history.pushState) {\r\n\t\t\tconst title = document.title;\r\n\t\t\tconst url = `${window.location.href.split('?')[0]}?${params.toString()}`;\r\n\t\t\twindow.history.pushState(params.toString(), title, url);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic replace(from, to) {\r\n\t\tconst history = window.history;\r\n\t\tif (history && history.replaceState) {\r\n\t\t\tconst location = window.location;\r\n\t\t\tconst title = document.title;\r\n\t\t\tif (location.pathname === '/') {\r\n\t\t\t\tconst url = location.origin + to + location.search;\r\n\t\t\t\thistory.replaceState(history.state, title, url);\r\n\t\t\t} else if (location.href.indexOf(from) !== -1) {\r\n\t\t\t\tconst url = location.href.replace(from, to);\r\n\t\t\t\thistory.replaceState(history.state, title, url);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic deserialize(key) {\r\n\t\tconst encoded = this.get('params');\r\n\t\treturn this.decode(key, encoded);\r\n\t}\r\n\r\n\tstatic serialize(keyOrValue, value) {\r\n\t\tconst params = this.deserialize();\r\n\t\tconst encoded = this.encode(keyOrValue, value, params);\r\n\t\tthis.set('params', encoded);\r\n\t}\r\n\r\n\tstatic decode(key, encoded) {\r\n\t\tlet decoded = null;\r\n\t\tif (encoded) {\r\n\t\t\tconst json = window.atob(encoded);\r\n\t\t\tdecoded = JSON.parse(json);\r\n\t\t}\r\n\t\tif (key && decoded) {\r\n\t\t\tdecoded = decoded[key];\r\n\t\t}\r\n\t\treturn decoded || null;\r\n\t}\r\n\r\n\tstatic encode(keyOrValue, value, params) {\r\n\t\tparams = params || {};\r\n\t\tlet encoded = null;\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams[keyOrValue] = value;\r\n\t\t} else {\r\n\t\t\tparams = keyOrValue;\r\n\t\t}\r\n\t\tconst json = JSON.stringify(params);\r\n\t\tencoded = window.btoa(json);\r\n\t\treturn encoded;\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject, from } from 'rxjs';\r\nimport { tap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport { LabelPipe } from '../label/label.pipe';\r\nimport LocationService from '../location/location.service';\r\nimport { RouterService } from '../router/router.service';\r\nimport { Utils } from '../utils/utils';\r\n\r\nexport class LanguageService {\r\n\r\n\tstatic languages = this.getDefaultLanguages();\r\n\tstatic lang$ = new BehaviorSubject(this.getDefaultLanguage());\r\n\tstatic get lang() {\r\n\t\treturn this.lang$.getValue();\r\n\t}\r\n\tstatic set lang(lang) {\r\n\t\tif (this.lang !== lang) {\r\n\t\t\tthis.lang$.next(lang);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic setAlternates(language, alternates) {\r\n\t\tthis.languages = alternates;\r\n\t\tthis.lang = language;\r\n\t\t// console.log('LanguageService.setAlternates', language, alternates);\r\n\t}\r\n\r\n\tstatic setRoute(route, routes) {\r\n\t\tconst language = route.params.lang;\r\n\t\t// console.log('LanguageService.setRoute', route, route.path, language);\r\n\t\tconst alternates = environment.languages.map(lang => {\r\n\t\t\tconst title = lang === 'it' ? 'Italiano' : 'English';\r\n\t\t\tconst alternateName = route.name.replace(new RegExp(`(^${language}$)|(^${language}\\.)`), (match, g1, g2, offset) => {\r\n\t\t\t\t// console.log('LanguageService.match', match, g1, g2, offset);\r\n\t\t\t\treturn g1 ? lang : `${lang}.`;\r\n\t\t\t});\r\n\t\t\tconst alternate = routes.find(x => x.name === alternateName);\r\n\t\t\t// console.log('LanguageService.alternate', lang, alternateName, alternate);\r\n\t\t\tif (alternate) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tname: alternate.name,\r\n\t\t\t\t\tparams: route.params,\r\n\t\t\t\t\thref: alternate.path,\r\n\t\t\t\t\tlang: alternate.defaultParams.lang,\r\n\t\t\t\t\ttitle,\r\n\t\t\t\t};\r\n\t\t\t} else {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t}).filter(x => x !== null);\r\n\t\tthis.setAlternates(language, alternates);\r\n\t}\r\n\r\n\tstatic get hasLanguages() {\r\n\t\treturn this.languages.length > 1;\r\n\t}\r\n\r\n\tstatic get activeLanguage() {\r\n\t\treturn this.languages.find(language => language.lang === this.lang);\r\n\t}\r\n\r\n\tstatic getDefaultLanguages() {\r\n\t\treturn environment.alternates || [];\r\n\t}\r\n\r\n\tstatic getDefaultLanguage() {\r\n\t\treturn environment.defaultLanguage || (this.languages ? this.languages[0].lang : null);\r\n\t}\r\n\r\n\tstatic setLanguage(language) {\r\n\t\tthis.lang = language.lang;\r\n\t}\r\n\r\n\tstatic setLanguage$(language) {\r\n\t\tif (typeof language === 'string') {\r\n\t\t\tlanguage = this.languages.find(x => x.lang === language);\r\n\t\t}\r\n\t\tif (!language) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst url = (environment.flags.production ? `/api/${language.lang}/labels/` : `./api/${language.lang}/labels.json`);\r\n\t\treturn from(fetch(url).then(response => {\r\n\t\t\treturn response.json();\r\n\t\t})).pipe(\r\n\t\t\ttap(labels => {\r\n\t\t\t\tenvironment.labels = labels;\r\n\t\t\t\tRouterService.replaceHistoryState(language.name, language.params);\r\n\t\t\t\tconst from = this.activeLanguage.href.split('?')[0];\r\n\t\t\t\tconst to = language.href.split('?')[0];\r\n\t\t\t\tLocationService.replace(from, to);\r\n\t\t\t\tthis.lang = language.lang;\r\n\t\t\t}),\r\n\t\t);\r\n\t\t/*\r\n\t\treturn of(language).pipe(\r\n\t\t\ttap(language => {\r\n\t\t\t\t// LabelPipe.setLabels();\r\n\t\t\t\tLocationService.replace(this.activeLanguage.href, language.href);\r\n\t\t\t\tthis.lang = language.lang;\r\n\t\t\t}),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\tstatic setLanguage$_(language) {\r\n\t\treturn from(fetch(language.href).then(response => {\r\n\t\t\treturn response.text();\r\n\t\t})).pipe(\r\n\t\t\ttap(html => {\r\n\t\t\t\t// console.log('html', html);\r\n\t\t\t\tconst labelsMatch = /(window\\.labels\\s*=\\s*\\n*\\s*\\{((\\{.+?\\})|.)+?\\})/gms.exec(html);\r\n\t\t\t\tif (labelsMatch) {\r\n\t\t\t\t\t// console.log('labels', labelsMatch[0]);\r\n\t\t\t\t\tnew Function(labelsMatch[0]).call(window);\r\n\t\t\t\t\tLabelPipe.setLabels();\r\n\t\t\t\t}\r\n\t\t\t\tconst bhereMatch = /(window\\.bhere\\s*=\\s*\\n*\\s*\\{((\\{.+?\\})|.)+?\\})/gms.exec(html);\r\n\t\t\t\tif (bhereMatch) {\r\n\t\t\t\t\t// console.log('bhere', bhereMatch[0]);\r\n\t\t\t\t\tconst data = {};\r\n\t\t\t\t\tnew Function(bhereMatch[0].replace('window', 'this')).call(data);\r\n\t\t\t\t\tif (data.bhere) {\r\n\t\t\t\t\t\tUtils.merge(environment, data.bhere);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tLocationService.replace(this.activeLanguage.href, language.href);\r\n\t\t\t\t// console.log(environment.labels);\r\n\t\t\t\tthis.lang = language.lang;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic toggleLanguages() {\r\n\t\tthis.showLanguages = !this.showLanguages;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n}\r\n","import { Pipe } from 'rxcomp';\r\nimport { LanguageService } from '../language/language.service';\r\n\r\nexport class RoutePipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\treturn key.replace(':lang', LanguageService.lang);\r\n\t}\r\n\r\n}\r\n\r\nRoutePipe.meta = {\r\n\tname: 'route',\r\n};\r\n","import { environment } from '../environment';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport const USE_AUTODETECT = false;\r\nexport const USE_VOLUME_INDICATOR = false;\r\nexport const USE_RTM = true;\r\n\r\nexport const VIDEO_PROFILES = [\r\n\t/*\r\n\t['120p_1', 160, 120, 15, 65, false]],\r\n\t['120p_3', 120, 120, 15, 50, false]],\r\n\t['180p_1', 320, 180, 15, 140, false]],\r\n\t['180p_3', 180, 180, 15, 100, false]],\r\n\t['180p_4', 240, 180, 15, 120, false]],\r\n\t['240p_1', 320, 240, 15, 200, false]],\r\n\t['240p_3', 240, 240, 15, 140, false]],\r\n\t['240p_4', 424, 240, 15, 220, false]],\r\n\t['360p_1', 640, 360, 15, 400, false]],\r\n\t['360p_3', 360, 360, 15, 260, false]],\r\n\t['360p_4', 640, 360, 30, 600, false]],\r\n\t['360p_6', 360, 360, 30, 400, false]],\r\n\t['360p_7', 480, 360, 15, 320, false]],\r\n\t['360p_8', 480, 360, 30, 490, false]],\r\n\t['360p_9', 640, 360, 15, 800, false]],\r\n\t['360p_10', 640, 360, 24, 800, false]],\r\n\t['360p_11', 640, 360, 24, 1000, false]],\r\n\t*/\r\n\t['480p_1', 640, 480, 15, 500, true],\r\n\t['480p_2', 640, 480, 30, 1000, true],\r\n\t['480p_3', 480, 480, 15, 400, true],\r\n\t['480p_4', 640, 480, 30, 750, true],\r\n\t['480p_6', 480, 480, 30, 600, true],\r\n\t['480p_8', 848, 480, 15, 610, true],\r\n\t['480p_9', 848, 480, 30, 930, true],\r\n\t['480p_10', 640, 480, 10, 400, true],\r\n\t['720p_1', 1280, 720, 15, 1130, true],\r\n\t['720p_2', 1280, 720, 30, 2000, true],\r\n\t['720p_3', 1280, 720, 30, 1710, true],\r\n\t['720p_5', 960, 720, 15, 910, true],\r\n\t['720p_6', 960, 720, 30, 1380, true],\r\n\t['1080p_1', 1920, 1080, 15, 2080, false],\r\n\t['1080p_2', 1920, 1080, 30, 3000, false],\r\n\t['1080p_3', 1920, 1080, 30, 3150, false],\r\n\t['1080p_5', 1920, 1080, 60, 4780, false],\r\n];\r\n\r\nexport const StreamQualities = VIDEO_PROFILES.map(a => {\r\n\treturn {\r\n\t\tprofile: a[0],\r\n\t\tresolution: {\r\n\t\t\twidth: a[1],\r\n\t\t\theight: a[2],\r\n\t\t},\r\n\t\tframeRate: {\r\n\t\t\tmin: a[3],\r\n\t\t\tmax: a[3],\r\n\t\t},\r\n\t\tbitrate: {\r\n\t\t\tmin: a[4],\r\n\t\t\tmax: a[4],\r\n\t\t},\r\n\t\tcompatible: a[5],\r\n\t};\r\n});\r\n\r\n/*\r\nexport const StreamQualities = [{\r\n\t// id: 1,\r\n\t// name: '4K 2160p 3840x2160',\r\n\tprofile: '4K',\r\n\tresolution: {\r\n\t\twidth: 3840,\r\n\t\theight: 2160\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 8910,\r\n\t\tmax: 13500\r\n\t}\r\n}, {\r\n\t// id: 2,\r\n\t// name: 'HD 1440p 25601440',\r\n\tprofile: '1440p',\r\n\tresolution: {\r\n\t\twidth: 2560,\r\n\t\theight: 1440\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 4850,\r\n\t\tmax: 7350\r\n\t}\r\n}, {\r\n\t// id: 3,\r\n\t// name: 'HD 1080p 1920x1080',\r\n\tprofile: '1080p',\r\n\tresolution: {\r\n\t\twidth: 1920,\r\n\t\theight: 1080\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 2080,\r\n\t\tmax: 4780\r\n\t}\r\n}, {\r\n\t// id: 4,\r\n\t// name: 'LOW 720p 1280x720',\r\n\tprofile: '720p_3',\r\n\tresolution: {\r\n\t\twidth: 1280,\r\n\t\theight: 720\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 1130,\r\n\t\tmax: 1710\r\n\t}\r\n}, {\r\n\t// id: 5,\r\n\t// name: 'LOWEST 240p 320x240',\r\n\tprofile: '240p_1',\r\n\tresolution: {\r\n\t\twidth: 320,\r\n\t\theight: 240\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 15\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 140,\r\n\t\tmax: 200\r\n\t}\r\n}];\r\n*/\r\n\r\nexport function getStreamQuality(state) {\r\n\tlet profile = environment.profiles.streamer;\r\n\tswitch (state.role) {\r\n\t\tcase RoleType.Publisher:\r\n\t\tcase RoleType.SmartDevice:\r\n\t\t\tprofile = environment.profiles.publisher || environment.profiles.streamer;\r\n\t\t\tbreak;\r\n\t\tcase RoleType.Attendee:\r\n\t\t\tprofile = environment.profiles.attendee || environment.profiles.streamer;\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t}\r\n\treturn StreamQualities.find(x => x.profile === profile);\r\n}\r\n\r\n/*\r\nexport function getStreamQuality(state) {\r\n\tconst lowestQuality = StreamQualities[StreamQualities.length - 1];\r\n\tconst highestQuality = environment.flags.maxQuality ? StreamQualities[0] : StreamQualities[StreamQualities.length - 2];\r\n\treturn (state.role === RoleType.Publisher || state.role === RoleType.SmartDevice) ? highestQuality : lowestQuality;\r\n}\r\n*/\r\n\r\nexport const AgoraStatus = {\r\n\tIdle: 'idle',\r\n\tChecklist: 'checklist',\r\n\tLink: 'link',\r\n\tLogin: 'login',\r\n\tName: 'name',\r\n\tDevice: 'device',\r\n\tShouldConnect: 'should-connect',\r\n\tConnecting: 'connecting',\r\n\tConnected: 'connected',\r\n\tDisconnected: 'disconnected',\r\n};\r\n\r\nexport const MessageType = {\r\n\tAddLike: 'addLike',\r\n\tAgoraEvent: 'agoraEvent',\r\n\tChannelMembers: 'channelMembers',\r\n\tChatMessage: 'chatMessage',\r\n\tChatTypingBegin: 'chatTypingBegin',\r\n\tChatTypingEnd: 'chatTypingEnd',\r\n\tControlInfo: 'controlInfo',\r\n\tCurrentTimeMedia: 'currentTimeMedia',\r\n\tMenuToggle: 'menuToggle',\r\n\tMode: 'mode',\r\n\tNavInfo: 'navInfo',\r\n\tNavLink: 'navLink',\r\n\tNavLinkClose: 'navLinkClose',\r\n\tNavToGrid: 'navToGrid',\r\n\tNavToView: 'navToView',\r\n\tPing: 'ping',\r\n\tPlayMedia: 'playMedia',\r\n\tPlayModel: 'playModel',\r\n\tRemoteSilencing: 'remoteSilencing',\r\n\tRequestControl: 'requestControl',\r\n\tRequestControlDismiss: 'requestControlDismiss',\r\n\tRequestSpy: 'requestSpy',\r\n\tRequestSpyDismiss: 'requestSpyDismiss',\r\n\tSelectItem: 'selectItem',\r\n\tSetSnapshot: 'setSnapshot',\r\n\tShowPanel: 'showPanel',\r\n\tSlideChange: 'slideChange',\r\n\tSupportRequest: 'supportRequest',\r\n\tSupportRequestAccepted: 'supportRequestAccepted',\r\n\tSupportRequestRejected: 'supportRequestRejected',\r\n\tVREnded: 'vrEnded',\r\n\tVRStarted: 'vrStarted',\r\n\tVRState: 'vrState',\r\n\tZoomMedia: 'zoomMedia',\r\n};\r\n\r\nexport const UIMode = {\r\n\tVirtualTour: 'virtual-tour',\r\n\tLiveMeeting: 'live-meeting',\r\n\tSelfServiceTour: 'self-service-tour',\r\n\tEmbed: 'embed',\r\n\tNone: 'none',\r\n};\r\n\r\nexport class AgoraEvent {\r\n\tconstructor(options) {\r\n\t\tObject.assign(this, options);\r\n\t}\r\n}\r\nexport class AgoraPeerEvent extends AgoraEvent { }\r\nexport class AgoraRemoteEvent extends AgoraEvent { }\r\nexport class AgoraMuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraMuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraVolumeLevelsEvent extends AgoraEvent { }\r\n","import { from, throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nexport class HttpResponse {\r\n\r\n\tget static() {\r\n\t\treturn this.url.indexOf('.json') === this.url.length - 5;\r\n\t}\r\n\r\n\tconstructor(response) {\r\n\t\tthis.data = null;\r\n\t\tif (response) {\r\n\t\t\tthis.url = response.url;\r\n\t\t\tthis.status = response.status;\r\n\t\t\tthis.statusText = response.statusText;\r\n\t\t\tthis.ok = response.ok;\r\n\t\t\tthis.redirected = response.redirected;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class HttpService {\r\n\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tlet response_ = null;\r\n\t\t// url = this.getUrl(url, format);\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: methods.indexOf(method) !== -1 ? JSON.stringify(data) : undefined\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = response;\r\n\t\t\t// console.log(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\treturn typedResponse;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\t\treturn Promise.reject(data);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} catch (error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve();\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(error);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\t// !!! todo mapping response.data\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tconst body = (data && methods.indexOf(method) !== -1) ? JSON.stringify(data) : undefined;\r\n\t\tconst queryString = (data && methods.indexOf(method) !== -1) ? Object.keys(data).map(function(key) {\r\n\t\t\treturn key + '=' + encodeURI(data[key]);\r\n\t\t}).join('&') : undefined;\r\n\t\tif (queryString) {\r\n\t\t\turl = `${url}?${queryString}`;\r\n\t\t}\r\n\t\tlet response_ = null;\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: body,\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = new HttpResponse(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && format === 'json' && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else if (format === 'blob') {\r\n\t\t\t\t\ttypedResponse = response.blob();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\tresponse_.data = data;\r\n\t\t\t\t\tif (response.ok) {\r\n\t\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn Promise.reject(response_);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} catch(error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(this.getError(error, response_));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic get$(url, data, format) {\r\n\t\tconst query = this.query(data);\r\n\t\treturn this.http$('GET', `${url}${query}`, undefined, format);\r\n\t}\r\n\r\n\tstatic delete$(url) {\r\n\t\treturn this.http$('DELETE', url);\r\n\t}\r\n\r\n\tstatic post$(url, data) {\r\n\t\treturn this.http$('POST', url, data);\r\n\t}\r\n\r\n\tstatic put$(url, data) {\r\n\t\treturn this.http$('PUT', url, data);\r\n\t}\r\n\r\n\tstatic patch$(url, data) {\r\n\t\treturn this.http$('PATCH', url, data);\r\n\t}\r\n\r\n\tstatic query(data) {\r\n\t\treturn ''; // todo\r\n\t}\r\n\r\n\tstatic getError(object, response) {\r\n\t\tlet error = typeof object === 'object' ? object : {};\r\n\t\tif (!error.status) {\r\n\t\t\terror.status = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusCode) {\r\n\t\t\terror.statusCode = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusMessage) {\r\n\t\t\terror.statusMessage = response ? response.statusText : object;\r\n\t\t}\r\n\t\t// console.log('HttpService.getError', error, object);\r\n\t\treturn error;\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject, of } from 'rxjs';\r\nimport { catchError, map, switchMap, tap } from 'rxjs/operators';\r\nimport { UIMode } from '../agora/agora.types';\r\nimport { environment } from '../environment';\r\nimport { HttpService } from '../http/http.service';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { RoleType, User } from './user';\r\n\r\nexport class UserService {\r\n\r\n\tstatic setUser(user) {\r\n\t\tthis.user$.next(user);\r\n\t}\r\n\r\n\tstatic me$() {\r\n\t\treturn HttpService.get$('/api/user/me').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\t// console.log('UserService.me$.error', error);\r\n\t\t\t\tif (error.status === 404 || error.statusCode === 404) {\r\n\t\t\t\t\treturn of(null);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow (error);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tswitchMap(user => {\r\n\t\t\t\tthis.setUser(user);\r\n\t\t\t\treturn this.user$;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic login$(payload) {\r\n\t\treturn HttpService.post$('/api/user/login', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic logout$() {\r\n\t\treturn HttpService.get$('/api/user/logout').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(null)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic guidedTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/guided-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic selfServiceTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/self-service-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic selfServiceSupportRequest$(user, meetingId, link) {\r\n\t\tconst payload = { user, meetingId, link };\r\n\t\treturn HttpService.post$('/api/user/self-service-support-request', payload).pipe(\r\n\t\t\ttap(_ => {\r\n\t\t\t\tif (!environment.flags.production) {\r\n\t\t\t\t\tfetch(environment.template.email.supportRequest)\r\n\t\t\t\t\t\t.then(response => response.text())\r\n\t\t\t\t\t\t.then(html => {\r\n\t\t\t\t\t\t\thtml = html.replace('{{username}}', MeetingUrl.getName(user));\r\n\t\t\t\t\t\t\thtml = html.replace('{{href}}', link);\r\n\t\t\t\t\t\t\tconst parser = new DOMParser();\r\n\t\t\t\t\t\t\tconst newDocument = parser.parseFromString(html, 'text/html');\r\n\t\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\t\t// const newWindow = window.open(window.location.origin + environment.template.email.supportRequest, '_blank');\r\n\t\t\t\t\t\t\t\tconst newWindow = window.open();\r\n\t\t\t\t\t\t\t\tnewWindow.document.head.innerHTML = newDocument.querySelector('head').innerHTML;\r\n\t\t\t\t\t\t\t\tnewWindow.document.body.innerHTML = newDocument.querySelector('body').innerHTML;\r\n\t\t\t\t\t\t\t}, 3000);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic resolve$(payload, status) {\r\n\t\tif (status === 'login') {\r\n\t\t\treturn this.login$(payload);\r\n\t\t}\r\n\t\tif (status === 'guided-tour') {\r\n\t\t\treturn this.guidedTour$(payload);\r\n\t\t}\r\n\t\tif (status === 'self-service-tour') {\r\n\t\t\treturn this.selfServiceTour$(payload);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic log$(payload) {\r\n\t\treturn HttpService.post$('/api/user/log', payload);\r\n\t}\r\n\r\n\tstatic temporaryUser$(roleType = RoleType.Embed) {\r\n\t\treturn of({\r\n\t\t\tid: this.uuid(),\r\n\t\t\ttype: roleType,\r\n\t\t\tusername: roleType,\r\n\t\t\t// firstName: 'Jhon',\r\n\t\t\t// lastName: 'Appleseed',\r\n\t\t}).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\tswitchMap(user => {\r\n\t\t\t\t// console.log('UserService.temporaryUser$', user);\r\n\t\t\t\tthis.setUser(user);\r\n\t\t\t\treturn this.user$;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic overrideUser$(roleType = RoleType.Embed) {\r\n\t\treturn this.me$().pipe(\r\n\t\t\tswitchMap(user => {\r\n\t\t\t\tif (user) {\r\n\t\t\t\t\tuser.type = roleType;\r\n\t\t\t\t\tuser.username = roleType;\r\n\t\t\t\t\treturn this.user$;\r\n\t\t\t\t}\r\n\t\t\t\treturn this.temporaryUser$(roleType);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic uuid() {\r\n\t\treturn new Date().getTime();\r\n\t\t// return parseInt(process.hrtime.bigint().toString());\r\n\t}\r\n\r\n\t/*\r\n\tstatic retrieve$(payload) {\r\n\t\treturn HttpService.post$('/api/user/retrievepassword', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic register$(payload) {\r\n\t\treturn HttpService.post$('/api/user/register', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic update(payload) {\r\n\t\treturn HttpService.post$('/api/user/updateprofile', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic mapUser(user) {\r\n\t\treturn new User(user);\r\n\t}\r\n\r\n\tstatic getMode(role) {\r\n\t\tlet mode;\r\n\t\tswitch (role) {\r\n\t\t\tcase RoleType.Attendee:\r\n\t\t\tcase RoleType.Streamer:\r\n\t\t\tcase RoleType.Viewer:\r\n\t\t\tcase RoleType.Publisher:\r\n\t\t\t\tmode = UIMode.VirtualTour;\r\n\t\t\t\tbreak;\r\n\t\t\tcase RoleType.SelfService:\r\n\t\t\t\tmode = UIMode.SelfServiceTour;\r\n\t\t\t\tbreak;\r\n\t\t\tcase RoleType.SmartDevice:\r\n\t\t\t\tmode = UIMode.LiveMeeting;\r\n\t\t\t\tbreak;\r\n\t\t\tcase RoleType.Embed:\r\n\t\t\t\tmode = UIMode.Embed;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tmode = UIMode.None;\r\n\t\t}\r\n\t\t// console.log('UserService.getMode', role, mode);\r\n\t\treturn mode;\r\n\t}\r\n\r\n}\r\n\r\nUserService.user$ = new BehaviorSubject(null);\r\n","import { combineLatest, forkJoin, fromEvent, merge, of } from 'rxjs';\r\nimport { catchError, filter, first, map, shareReplay, switchMap, tap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport { HttpService } from '../http/http.service';\r\nimport StateService from '../state/state.service';\r\n\r\nlet UID = 0;\r\n\r\nexport class WebhookEvent {\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\r\n\ttoJson() {\r\n\t\treturn JSON.stringify(this);\r\n\t}\r\n\r\n\tstatic newEvent(action, data, extra) {\r\n\t\tconsole.log('WebhookEvent.newEvent', action, data, extra);\r\n\t\tconst event = new WebhookEvent();\r\n\t\tconst timestamp = new Date().getTime();\r\n\t\tevent.timestamp = timestamp;\r\n\t\tevent.id = `${timestamp}-${++UID}`;\r\n\t\tevent.action = action;\r\n\t\tevent.data = data;\r\n\t\tif (extra) {\r\n\t\t\tevent.extra = typeof extra === 'string' ? JSON.parse(extra) : extra;\r\n\t\t}\r\n\t\tif (StateService.state.link) {\r\n\t\t\t// ( meetingId, userSessionId, userRole, fullName, itemId, skuId, action:InfoPoint  )\r\n\t\t\tevent.meetingId = StateService.state.link;\r\n\t\t\tevent.userSessionId = StateService.state.uid;\r\n\t\t\tevent.userRole = StateService.state.role;\r\n\t\t\tevent.fullName = StateService.state.name;\r\n\t\t}\r\n\t\treturn event;\r\n\t}\r\n\r\n\tstatic parseEvent(event) {\r\n\t\tif (event && 'data' in event) {\r\n\t\t\tconst message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;\r\n\t\t\tif ('action' in message) {\r\n\t\t\t\treturn new WebhookEvent(message);\r\n\t\t\t} else {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n}\r\nexport class WebhookService {\r\n\r\n\tstatic event$_ = fromEvent(window, 'message').pipe(\r\n\t\tmap(event => {\r\n\t\t\tconst parsedEvent = WebhookEvent.parseEvent(event);\r\n\t\t\treturn parsedEvent;\r\n\t\t}),\r\n\t\tfilter(x => x !== null),\r\n\t\tshareReplay(1),\r\n\t);\r\n\r\n\tstatic internal$_(event) {\r\n\t\treturn of(event).pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tconsole.log('WebhookService.internal$_.postMessage', event);\r\n\t\t\t\tif (window.parent) {\r\n\t\t\t\t\twindow.parent.postMessage(event.action, event.toJson());\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\treturn this.event$_.pipe(\r\n\t\t\t\t\tfilter(event => event.id === event.id),\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t\tmap(response => {\r\n\t\t\t\tconsole.log('WebhookService.internal$_.handleResponse_', event, response);\r\n\t\t\t\treturn this.handleResponse_(event, response);\r\n\t\t\t}),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn this.handleError_(event, error);\r\n\t\t\t}),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic send$_(uri, event) {\r\n\t\treturn HttpService.post$(uri, event).pipe(\r\n\t\t\tmap(response => {\r\n\t\t\t\treturn this.handleResponse_(event, response);\r\n\t\t\t}),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn this.handleError_(event, error);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic send$(action, payload, extra) {\r\n\t\tconsole.log('WebhookService.send$', action, payload, extra);\r\n\t\tif (this.enabled) {\r\n\t\t\tconst event = WebhookEvent.newEvent(action, payload, extra);\r\n\t\t\tconst uris = environment.webhook.uris;\r\n\t\t\tconst observables = uris.map(x => x === 'internal' ? this.internal$_(event) : this.send$_(x, event));\r\n\t\t\treturn forkJoin(observables);\r\n\t\t\treturn combineLatest(observables).pipe(\r\n\t\t\t\tmap(results => {\r\n\t\t\t\t\tconst result = results.find((x, i) => uris[i] !== 'internal');\r\n\t\t\t\t\treturn result;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t\treturn merge(observables);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic handleResponse_(event, remoteResponse) {\r\n\t\tconsole.log('WebhookService.handleResponse_', remoteResponse);\r\n\t\tconst response = Object.assign({}, event);\r\n\t\tresponse.remoteStatus = 1;\r\n\t\tresponse.remoteResponse = remoteResponse;\r\n\t\treturn response;\r\n\t}\r\n\r\n\tstatic handleError_(event, error) {\r\n\t\tconst response = Object.assign({}, event);\r\n\t\tresponse.remoteStatus = 0;\r\n\t\tresponse.remoteError = error;\r\n\t\treturn of(response);\r\n\t}\r\n\r\n\tstatic get enabled() {\r\n\t\tconst webhook = environment.webhook;\r\n\t\tconst enabled = webhook && webhook.uris && webhook.uris.length > 0;\r\n\t\tif (enabled) {\r\n\t\t\twebhook.methods = webhook.methods || {};\r\n\t\t\twebhook.methods.nav = webhook.methods.nav || [];\r\n\t\t}\r\n\t\treturn enabled;\r\n\t}\r\n\r\n}\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { CHUNK_COPYRIGHT, CHUNK_CREDITS, CHUNK_LANGUAGE } from '../agora/agora.component.chunks';\r\nimport { environment, STATIC } from '../environment';\r\nimport { fieldsToFormGroup, patchFields } from '../forms/controls.component';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { RoutePipe } from '../router/route.pipe';\r\nimport { RouterOutletStructure } from '../router/router-outlet.structure';\r\nimport { RouterService } from '../router/router.service';\r\nimport { UserService } from '../user/user.service';\r\nimport { WebhookService } from '../webhook/webhook.service';\r\n\r\nexport default class AccessComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\t// console.log('AccessComponent.onInit');\r\n\t\tthis.state = {\r\n\t\t\tstatus: 'access',\r\n\t\t};\r\n\r\n\t\twindow.onSSOPopupClose = (status) => {\r\n\t\t\tif (status === 'success') {\r\n\t\t\t\talert('Login Successful');\r\n\t\t\t\tUserService.me$().pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe((user) => {\r\n\t\t\t\t\t// console.log('AccessComponent.onInit.onSSOPopupClose', user);\r\n\t\t\t\t\tconst routeUrl = RoutePipe.transform(':lang.selfServiceTour');\r\n\t\t\t\t\tconst pathId = environment.pathMapper && environment.pathMapper.ssoLogin ? environment.pathMapper.ssoLogin(user) : null;\r\n\t\t\t\t\tif (pathId) {\r\n\t\t\t\t\t\tRouterService.setRouterLink(routeUrl, MeetingUrl.validateParams({ pathId }));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tRouterService.setRouterLink(routeUrl);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\talert('Login Failed');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonSelfServiceTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'self-service-tour';\r\n\t\tthis.pushChanges();\r\n\t\tif (STATIC && window.navigator.userAgent.indexOf('OculusBrowser') !== -1) {\r\n\t\t\tthis.test();\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tonGuidedTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'guided-tour';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSSOLogin(event) {\r\n\t\tconst loginUrl = `${location.protocol}//${location.host}/sso/login`;\r\n\t\twindow.open(loginUrl, 'BHere | SSO Login', 'left=20,top=20,width=600,height=600,toolbar=1,resizable=0');\r\n\t\tevent.preventDefault();\r\n\t\treturn false;\r\n\t}\r\n\r\n\tonSSORegister(event) {\r\n\t\tconst loginUrl = `${location.protocol}//${location.host}/sso/register`;\r\n\t\twindow.open(loginUrl, 'BHere | SSO Register', 'left=20,top=20,width=600,height=600,toolbar=1,resizable=0');\r\n\t\tevent.preventDefault();\r\n\t\treturn false;\r\n\t}\r\n\r\n\tonGuidedTourAccess() {\r\n\t\tUserService.logout$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tRouterService.setRouterLink(RoutePipe.transform(':lang.guidedTour'));\r\n\t\t});\r\n\t}\r\n\r\n\tonLogin() {\r\n\t\tthis.initLoginForm();\r\n\t\tthis.state.status = 'login';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tinitRequestForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst data = this.data = environment.data || {\r\n\t\t\troles: [\r\n\t\t\t\t{ id: 1, name: 'Show room' },\r\n\t\t\t\t{ id: 2, name: 'Architetto' },\r\n\t\t\t\t{ id: 3, name: 'Interior designer' },\r\n\t\t\t\t{ id: 4, name: 'Privato' },\r\n\t\t\t\t{ id: 5, name: 'Altro' }\r\n\t\t\t],\r\n\t\t};\r\n\r\n\t\tconst fields = this.fields = environment.fields || [\r\n\t\t\t{ type: 'text', name: 'firstName', label: 'access_first_name', required: true, test: 'Jhon' },\r\n\t\t\t{ type: 'text', name: 'lastName', label: 'access_last_name', required: true, test: 'Appleseed' },\r\n\t\t\t{ type: 'email', name: 'email', label: 'access_email', required: true, test: 'jhonappleseed@gmail.com' },\r\n\t\t\t{ type: 'custom-select', name: 'role', label: 'access_role', required: true, options: data.roles, test: data.roles[0].id },\r\n\t\t\t{ type: 'checkbox', name: 'privacy', label: 'access_privacy_disclaimer', required: true, test: true },\r\n\t\t];\r\n\r\n\t\tfields.push(\r\n\t\t\t{ type: 'hidden', name: 'checkField', value: '', test: '' },\r\n\t\t);\r\n\r\n\t\tif (environment.antiforgery) {\r\n\t\t\tfields.push(\r\n\t\t\t\t{ type: 'none', name: 'checkRequest', value: environment.antiforgery, test: environment.antiforgery },\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tconst form = this.form = fieldsToFormGroup(fields);\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\tinitLoginForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tif (this.state.status === 'login') {\r\n\t\t\tthis.form.patch({\r\n\t\t\t\tusername: 'publisher',\r\n\t\t\t\tpassword: 'publisher',\r\n\t\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\t\tcheckField: ''\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tpatchFields(this.fields, this.form);\r\n\t\t}\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonBack() {\r\n\t\tthis.state.status = 'access';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tconst webhookPayload = { ...payload };\r\n\t\t\tconst controls = this.controls;\r\n\t\t\tObject.keys(webhookPayload).forEach(key => {\r\n\t\t\t\tif (controls[key].options) {\r\n\t\t\t\t\tconst options = controls[key].options;\r\n\t\t\t\t\twebhookPayload[key] = options.find(option => option.id === webhookPayload[key]).name;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tconst status = this.state.status;\r\n\t\t\tUserService.resolve$(payload, status).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('AccessComponent.onSubmit', response);\r\n\t\t\t\tswitch (status) {\r\n\t\t\t\t\tcase 'guided-tour':\r\n\t\t\t\t\t\tthis.onHandleHook('GuidedTour', webhookPayload).pipe(\r\n\t\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t\t).subscribe(response => {\r\n\t\t\t\t\t\t\tthis.state.status = 'guided-tour-success';\r\n\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'self-service-tour':\r\n\t\t\t\t\t\tthis.onHandleHook('SelfServiceTour', webhookPayload).pipe(\r\n\t\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t\t).subscribe(response => {\r\n\t\t\t\t\t\t\tconst routeUrl = RoutePipe.transform(':lang.selfServiceTour');\r\n\t\t\t\t\t\t\tconst pathId = environment.pathMapper && environment.pathMapper.selfService ? environment.pathMapper.selfService(user) : null;\r\n\t\t\t\t\t\t\tif (pathId) {\r\n\t\t\t\t\t\t\t\tRouterService.setRouterLink(routeUrl, MeetingUrl.validateParams({ pathId }));\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tRouterService.setRouterLink(routeUrl);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'login':\r\n\t\t\t\t\t\tRouterService.setRouterLink(RoutePipe.transform(':lang.guidedTour'));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonHandleHook(action, values) {\r\n\t\tconst payload = values;\r\n\t\tconst extra = null;\r\n\t\treturn WebhookService.send$(action, payload, extra);\r\n\t}\r\n\r\n}\r\n\r\nAccessComponent.meta = {\r\n\tselector: '[access-component]',\r\n\thosts: { host: RouterOutletStructure },\r\n\ttemplate: /*html*/ `\r\n\t\t<div class=\"page page--access\">\r\n\t\t\t<!-- background -->\r\n\t\t\t<div class=\"background\" [class]=\"{ 'background--image': ('background.image' | env), 'background--video': ('background.video' | env) }\" *if=\"state.status != 'connected'\">\r\n\t\t\t\t<img [src]=\"'background.image' | env | asset\" *if=\"'background.image' | env\" />\r\n\t\t\t\t<video [src]=\"'background.video' | env | asset\" *if=\"'background.video' | env\" oncanplay=\"this.muted = true; this.classList.add('ready');\" playsinline autoplay muted loop></video>\r\n\t\t\t</div>\r\n\t\t\t<!-- access -->\r\n\t\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'access'\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"'access_title' | label\"></div>\r\n\t\t\t\t\t\t<div *if=\"'selfService' | flag\">\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--next\" (click)=\"onSelfServiceTourRequest($event)\">\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_tour' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div *if=\"'guidedTourRequest' | flag\">\r\n\t\t\t\t\t\t\t<div class=\"info\" [innerHTML]=\"'access_or' | label\"></div>\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--next\" (click)=\"onGuidedTourRequest($event)\">\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_guided_tour' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div *if=\"'guidedTourAccess' | flag\">\r\n\t\t\t\t\t\t\t<div class=\"info\" [innerHTML]=\"'access_has_meeting_id' | label\"></div>\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--next\" (click)=\"onGuidedTourAccess($event)\">\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_guided_tour_cta' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div *if=\"'ssoLogin' | flag\">\r\n\t\t\t\t\t\t\t<div class=\"info\" [innerHTML]=\"'access_sso_login_info' | label\"></div>\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--next\" (click)=\"onSSOLogin($event)\">\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_sso_login_cta' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div *if=\"'ssoRegister' | flag\">\r\n\t\t\t\t\t\t\t<div class=\"info\" [innerHTML]=\"'access_sso_register_info' | label\"></div>\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--next\" (click)=\"onSSORegister($event)\">\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_sso_register_cta' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- guided-tour -->\r\n\t\t\t<div class=\"ui ui--info\" *if=\"state.status == 'self-service-tour' || state.status == 'guided-tour'\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t\t\t\t<div class=\"title\" *if=\"state.status == 'self-service-tour'\" [innerHTML]=\"'access_fill_fields' | label\"></div>\r\n\t\t\t\t\t\t\t<div class=\"title\" *if=\"state.status == 'guided-tour'\" [innerHTML]=\"'access_guided_tour_request' | label\"></div>\r\n\t\t\t\t\t\t\t<!-- controls -->\r\n\t\t\t\t\t\t\t<div controls [formGroup]=\"form\" [fields]=\"fields\"></div>\r\n\t\t\t\t\t\t\t<div class=\"group--error\" *if=\"error\">\r\n\t\t\t\t\t\t\t\t<span class=\"status-code\" [innerHTML]=\"error.statusCode\"></span>\r\n\t\t\t\t\t\t\t\t<span class=\"status-message\" [innerHTML]=\"error.statusMessage\"></span>\r\n\t\t\t\t\t\t\t\t<span class=\"friendly-message\" [innerHTML]=\"error.friendlyMessage\"></span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<!-- <div class=\"info\" *if=\"isValid()\" [innerHTML]=\"'access_take_part' | label\"></div> -->\r\n\t\t\t\t\t\t\t<button type=\"submit\" class=\"btn--next\" [class]=\"{ disabled: !isValid() }\">\r\n\t\t\t\t\t\t\t\t<span *if=\"!form.submitted\" [innerHTML]=\"'access_send' | label\"></span>\r\n\t\t\t\t\t\t\t\t<span *if=\"form.submitted\" [innerHTML]=\"'access_sent' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onBack($event)\">\r\n\t\t\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#arrow-prev\"></use></svg>\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_back' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t<test-component [form]=\"form\" (test)=\"test($event)\" (reset)=\"reset($event)\"></test-component>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- guided-tour success -->\r\n\t\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'guided-tour-success'\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"'access_request_sent' | label\"></div>\r\n\t\t\t\t\t\t<div class=\"info\" [innerHTML]=\"'access_info_request' | label\"></div>\r\n\t\t\t\t\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onBack($event)\">\r\n\t\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#arrow-prev\"></use></svg>\r\n\t\t\t\t\t\t\t<span [innerHTML]=\"'access_back' | label\"></span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- login -->\r\n\t\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'login'\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"'access_login' | label\"></div>\r\n\t\t\t\t\t\t\t<input name=\"checkField\" [formControl]=\"controls.checkField\" value=\"\" type=\"text\" style=\"display:none !important;\" />\r\n\t\t\t\t\t\t\t<div control-text [control]=\"controls.username\" [label]=\"'access_username' | label\"></div>\r\n\t\t\t\t\t\t\t<div control-password [control]=\"controls.password\" [label]=\"'access_password' | label\"></div>\r\n\t\t\t\t\t\t\t<div class=\"group--error\" *if=\"error\">\r\n\t\t\t\t\t\t\t\t<span class=\"status-code\" [innerHTML]=\"error.statusCode\"></span>\r\n\t\t\t\t\t\t\t\t<span class=\"status-message\" [innerHTML]=\"error.statusMessage\"></span>\r\n\t\t\t\t\t\t\t\t<span class=\"friendly-message\" [innerHTML]=\"error.friendlyMessage\"></span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div class=\"info\" *if=\"isValid()\" [innerHTML]=\"'access_cta' | label\"></div>\r\n\t\t\t\t\t\t\t<button type=\"submit\" class=\"btn--next\" [class]=\"{ disabled: !isValid() }\">\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_cta' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onBack($event)\">\r\n\t\t\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#arrow-prev\"></use></svg>\r\n\t\t\t\t\t\t\t\t<span [innerHTML]=\"'access_back' | label\"></span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t<test-component [form]=\"form\" (test)=\"test($event)\" (reset)=\"reset($event)\"></test-component>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</form>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<header>\r\n\t\t\t\t<!-- logo -->\r\n\t\t\t\t<div class=\"btn--logo\" (click)=\"onBack($event)\">\r\n\t\t\t\t\t<img [src]=\"'logo' | env\" *if=\"'logo' | env\" />\r\n\t\t\t\t\t<svg viewBox=\"0 0 270 98\" *if=\"!('logo' | env)\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t\t\t</div>\r\n\t\t\t\t${CHUNK_LANGUAGE}\r\n\t\t\t</header>\r\n\t\t\t<footer>\r\n\t\t\t\t<span class=\"group--colophon\" *if=\"state.status != 'connected'\">\r\n\t\t\t\t\t${CHUNK_CREDITS}\r\n\t\t\t\t\t${CHUNK_COPYRIGHT}\r\n\t\t\t\t</span>\r\n\t\t\t\t<!-- login -->\r\n\t\t\t\t<button type=\"button\" class=\"btn--absolute\" (click)=\"onLogin($event)\" *if=\"state.status == 'access'\">\r\n\t\t\t\t\t<span [innerHTML]=\"'access_cta' | label\"></span> <svg class=\"lock\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#lock\"></use></svg>\r\n\t\t\t\t</button>\r\n\t\t\t</footer>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport { HttpService } from '../http/http.service';\r\n\r\nexport class EmojiService {\r\n\r\n\tstatic emoji$() {\r\n\t\tif (EmojiService.items_ != null) {\r\n\t\t\treturn of(EmojiService.items_);\r\n\t\t}\r\n\t\treturn HttpService.get$(`${environment.assets}api/emoji/emoji.json`).pipe(\r\n\t\t\tmap(items => {\r\n\t\t\t\t// items = items.slice(0, Math.min(80, items.length));\r\n\t\t\t\tEmojiService.items_ = items;\r\n\t\t\t\treturn items;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n","import { Component } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { EmojiService } from '../emoji/emoji.service';\r\n\r\nexport default class AgoraChatEmojiComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.items = [];\r\n\t\tEmojiService.emoji$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(items => {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.items = items;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, 1);\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(item) {\r\n\t\tthis.emoji.next(item);\r\n\t}\r\n\r\n\tonClose(_) {\r\n\t\tthis.close.next();\r\n\t}\r\n\r\n}\r\n\r\nAgoraChatEmojiComponent.meta = {\r\n\tselector: '[agora-chat-emoji]',\r\n\toutputs: ['emoji', 'close'],\r\n};\r\n","import { ReplaySubject } from 'rxjs';\r\n\r\nexport class MessageService {\r\n\tstatic message$ = new ReplaySubject(1);\r\n\tstatic message(message) {\r\n\t\tthis.message$.next(message);\r\n\t}\r\n\r\n\tstatic in$ = new ReplaySubject(1);\r\n\tstatic in(message) {\r\n\t\t// console.log('MessageService.in', message);\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\tstatic send = MessageService.in;\r\n\tstatic sendBack(message) {\r\n\t\tmessage = Object.assign({}, message, { remoteId: message.clientId });\r\n\t\t// console.log('MessageService.sendBack', message);\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\r\n\tstatic out$ = new ReplaySubject(1);\r\n\tstatic out(message) {\r\n\t\tthis.out$.next(message);\r\n\t}\r\n}\r\n","\r\nexport const DevicePlatform = {\r\n\tUnknown: 'unknown',\r\n\tIOS: 'ios',\r\n\tAndroid: 'android',\r\n\tWindowsPhone: 'windowsPhone',\r\n\tVRHeadset: 'vrHeadset',\r\n};\r\n\r\nexport class DeviceService {\r\n\r\n\tstatic get platform() {\r\n\t\tif (!this.platform_) {\r\n\t\t\tthis.platform_ = this.getDevicePlatform();\r\n\t\t}\r\n\t\treturn this.platform_;\r\n\t}\r\n\r\n\tstatic get isIOS() {\r\n\t\treturn ['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'].indexOf(navigator.platform) !== -1\r\n\t\t\t// iPad on iOS 13 detection\r\n\t\t\t|| (navigator.userAgent.indexOf('Mac') !== -1 && 'ontouchend' in document);\r\n\t}\r\n\r\n\tstatic get isVRHeadset() {\r\n\t\treturn navigator.userAgent.indexOf('VR') !== -1 || navigator.userAgent.indexOf('Quest') !== -1 || navigator.userAgent.indexOf('Oculus') !== -1;\r\n\t}\r\n\r\n\tstatic getDevicePlatform() {\r\n\t\tconst userAgent = navigator.userAgent || navigator.vendor || window.opera;\r\n\t\t// Windows Phone must come first because its UA also contains 'Android'\r\n\t\tif (/windows phone/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.WindowsPhone;\r\n\t\t}\r\n\t\tif (/android/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.Android;\r\n\t\t}\r\n\t\t// iOS detection from: http://stackoverflow.com/a/9039885/177710\r\n\t\t// if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {\r\n\t\tif (this.isIOS) {\r\n\t\t\treturn DevicePlatform.IOS;\r\n\t\t}\r\n\t\tif (this.isVRHeadset) {\r\n\t\t\treturn DevicePlatform.VRHeadset;\r\n\t\t}\r\n\t\treturn DevicePlatform.Unknown;\r\n\t}\r\n\r\n}\r\n","import { environment } from '../environment.js';\r\n\r\nexport const LoggerLevel = {\r\n\tNONE: 0,\r\n\tERROR: 1,\r\n\tWARN: 2,\r\n\tINFO: 3,\r\n\tLOG: 4,\r\n\tALL: 5,\r\n};\r\n\r\nexport class Logger {\r\n\r\n\tstatic level_ = LoggerLevel.ALL;\r\n\r\n\tstatic setLevel(level) {\r\n\t\tthis.level_ = level;\r\n\t}\r\n\r\n\tstatic getLevel() {\r\n\t\tif (environment.flags.production) {\r\n\t\t\treturn LoggerLevel.ERROR;\r\n\t\t} else {\r\n\t\t\treturn this.level_;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic error(...args) {\r\n\t\tif (this.getLevel() >= LoggerLevel.ERROR) {\r\n\t\t\tconsole.error(...args);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic warn(...args) {\r\n\t\tif (this.getLevel() >= LoggerLevel.WARN) {\r\n\t\t\tconsole.warn(...args);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic info(...args) {\r\n\t\tif (this.getLevel() >= LoggerLevel.INFO) {\r\n\t\t\tconsole.info(...args);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic log(...args) {\r\n\t\tif (this.getLevel() >= LoggerLevel.LOG) {\r\n\t\t\tconsole.log(...args);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","export default class SessionStorageService {\r\n\r\n\tstatic delete(name) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\twindow.sessionStorage.removeItem(name);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic exist(name) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\treturn window.sessionStorage[name] !== undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get(name) {\r\n\t\tlet value = null;\r\n\t\tif (this.isSessionStorageSupported() && window.sessionStorage[name] !== undefined) {\r\n\t\t\ttry {\r\n\t\t\t\tvalue = JSON.parse(window.sessionStorage[name]);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('SessionStorageService.get.error parsing', name, e);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic set(name, value) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\ttry {\r\n\t\t\t\tconst cache = [];\r\n\t\t\t\tconst json = JSON.stringify(value, function(key, value) {\r\n\t\t\t\t\tif (typeof value === 'object' && value !== null) {\r\n\t\t\t\t\t\tif (cache.indexOf(value) !== -1) {\r\n\t\t\t\t\t\t\t// Circular reference found, discard key\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcache.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value;\r\n\t\t\t\t});\r\n\t\t\t\twindow.sessionStorage.setItem(name, json);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('SessionStorageService.set.error serializing', name, value, e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic isSessionStorageSupported() {\r\n\t\tif (this.supported) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tlet supported = false;\r\n\t\ttry {\r\n\t\t\tsupported = 'sessionStorage' in window && window.sessionStorage !== null;\r\n\t\t\tif (supported) {\r\n\t\t\t\twindow.sessionStorage.setItem('test', '1');\r\n\t\t\t\twindow.sessionStorage.removeItem('test');\r\n\t\t\t} else {\r\n\t\t\t\tsupported = false;\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tsupported = false;\r\n\t\t}\r\n\t\tthis.supported = supported;\r\n\t\treturn supported;\r\n\t}\r\n}\r\n","import { BehaviorSubject, combineLatest, interval, of } from 'rxjs';\r\nimport { distinctUntilChanged, filter, map, shareReplay, switchMap } from 'rxjs/operators';\r\nimport { RoleType } from '../user/user';\r\n\r\nconst MAX_VISIBLE_STREAMS = 8;\r\n\r\nexport const StreamServiceMode = {\r\n\tClient: 'client',\r\n\tEditor: 'editor',\r\n};\r\n\r\nexport default class StreamService {\r\n\r\n\tstatic mode = StreamServiceMode.Client;\r\n\r\n\tstatic editorStreams$ = new BehaviorSubject(null);\r\n\tstatic set editorStreams(editorStreams) {\r\n\t\tthis.editorStreams$.next(editorStreams);\r\n\t}\r\n\tstatic get editorStreams() {\r\n\t\treturn this.editorStreams$.getValue();\r\n\t}\r\n\r\n\tstatic editorScreens$ = new BehaviorSubject(null);\r\n\tstatic set editorScreens(editorScreens) {\r\n\t\tthis.editorScreens$.next(editorScreens);\r\n\t}\r\n\tstatic get editorScreens() {\r\n\t\treturn this.editorScreens$.getValue();\r\n\t}\r\n\r\n\tstatic local$ = new BehaviorSubject(null);\r\n\tstatic set local(local) {\r\n\t\tthis.local$.next(local);\r\n\t}\r\n\tstatic get local() {\r\n\t\treturn this.local$.getValue();\r\n\t}\r\n\r\n\tstatic screen$ = new BehaviorSubject(null);\r\n\tstatic set screen(screen) {\r\n\t\tthis.screen$.next(screen);\r\n\t}\r\n\tstatic get screen() {\r\n\t\treturn this.screen$.getValue();\r\n\t}\r\n\r\n\tstatic remotes$ = new BehaviorSubject([]);\r\n\tstatic set remotes(remotes) {\r\n\t\tthis.remotes$.next(remotes);\r\n\t}\r\n\tstatic get remotes() {\r\n\t\treturn this.remotes$.getValue();\r\n\t}\r\n\r\n\tstatic peers$ = new BehaviorSubject([]);\r\n\tstatic set peers(peers) {\r\n\t\tthis.peers$.next(peers);\r\n\t}\r\n\tstatic get peers() {\r\n\t\treturn this.peers$.getValue();\r\n\t}\r\n\r\n\tstatic orderedRemotes$() {\r\n\t\treturn combineLatest([StreamService.remotes$, interval(1000)]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst orderedRemotes = [];\r\n\t\t\t\tconst remotes = datas[0];\r\n\t\t\t\tremotes.forEach(remote => {\r\n\t\t\t\t\t// const audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t// console.log('audioLevel', audioLevel, remote);\r\n\t\t\t\t\tlet role = null, uid = null, screenUid = null, audioLevel = 0, peekAudioLevel = 0, order = 0;\r\n\t\t\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t\t\taudioLevel = remote.clientInfo.audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t\tpeekAudioLevel = remote.clientInfo.peekAudioLevel = Math.max(remote.clientInfo.audioLevel, 0.2);\r\n\t\t\t\t\t\torder = remote.clientInfo.order;\r\n\t\t\t\t\t\trole = remote.clientInfo.role || null;\r\n\t\t\t\t\t\tuid = remote.clientInfo.uid || null;\r\n\t\t\t\t\t\tscreenUid = remote.clientInfo.screenUid || null;\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tif (remote.clientInfo.screenUid !== remote.getId()) {\r\n\t\t\t\t\t\t\torderedRemotes.push(remote);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t}\r\n\t\t\t\t\torderedRemotes.push({ role, uid, screenUid, audioLevel, peekAudioLevel, order, remote });\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.sort((a, b) => {\r\n\t\t\t\t\tconst av = a.role === RoleType.Publisher ? 2 : (a.role === RoleType.Attendee ? 1 : 0);\r\n\t\t\t\t\tconst bv = b.role === RoleType.Publisher ? 2 : (b.role === RoleType.Attendee ? 1 : 0);\r\n\t\t\t\t\treturn (bv - av) ||\r\n\t\t\t\t\t\t(b.peekAudioLevel - a.peekAudioLevel) ||\r\n\t\t\t\t\t\t((a.order || 0) - (b.order || 0));\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.forEach((x, i) => {\r\n\t\t\t\t\tif (x.remote.clientInfo) {\r\n\t\t\t\t\t\tx.remote.clientInfo.order = i;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// !!! hard limit max visible stream\r\n\t\t\t\t// orderedRemotes.length = Math.min(orderedRemotes.length, MAX_VISIBLE_STREAMS);\r\n\t\t\t\t// console.log('StreamService.orderedRemotes$', orderedRemotes);\r\n\t\t\t\treturn orderedRemotes;\r\n\t\t\t}),\r\n\t\t\tdistinctUntilChanged((a, b) => {\r\n\t\t\t\tconst auid = a.map(x => `${x.uid}-${x.screenUid}`).join('|');\r\n\t\t\t\tconst buid = b.map(x => `${x.uid}-${x.screenUid}`).join('|');\r\n\t\t\t\t// console.log('StreamService.orderedRemotes$', auid, buid);\r\n\t\t\t\treturn auid === buid;\r\n\t\t\t}),\r\n\t\t\tmap(remotes => remotes.map(x => x.remote)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic streams$ = combineLatest([StreamService.local$, StreamService.screen$, StreamService.remotes$, StreamService.getEditorStreams$(), StreamService.getEditorScreens$()]).pipe(\r\n\t\tmap(data => {\r\n\t\t\tconst local = data[0];\r\n\t\t\tconst screen = data[1];\r\n\t\t\tconst remotes = data[2];\r\n\t\t\tconst editorStreams = data[3];\r\n\t\t\tconst editorScreens = data[4];\r\n\t\t\tlet streams = remotes;\r\n\t\t\tif (local) { // my stream\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(local);\r\n\t\t\t}\r\n\t\t\tif (screen) { // my screen\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(screen);\r\n\t\t\t}\r\n\t\t\tif (editorStreams) { // editor streams\r\n\t\t\t\tstreams.push(...editorStreams);\r\n\t\t\t}\r\n\t\t\tif (editorScreens) { // editor screens\r\n\t\t\t\tstreams.push(...editorScreens);\r\n\t\t\t}\r\n\t\t\treturn streams;\r\n\t\t}),\r\n\t\tshareReplay(1),\r\n\t);\r\n\r\n\tstatic getEditorStreams$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia({\r\n\t\t\t\t\t\tvideo: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeSmartDeviceStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.SmartDevice,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorStreams$.next([fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeSmartDeviceStream]);\r\n\t\t\t\t\t\t\t// StreamService.editorStreams = [fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream];\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorStreams$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getEditorScreens$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor-screen');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getDisplayMedia({\r\n\t\t\t\t\t\tscreen: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t\tscreenUid: 'editor-screen',\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t\tscreenUid: 'editor-screen',\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorScreens$.next([fakePublisherScreen, fakeAttendeeScreen]);\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorScreens$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic get publisherStreamId() {\r\n\t\tconst streams = this.remotes.slice();\r\n\t\tconst local = this.local;\r\n\t\tif (local) {\r\n\t\t\tstreams.unshift(local);\r\n\t\t}\r\n\t\tconst publisherStream = streams.find(x => x.clientInfo && x.clientInfo.role === RoleType.Publisher && x.clientInfo.uid === x.getId());\r\n\t\tif (publisherStream) {\r\n\t\t\treturn publisherStream.getId();\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tstatic getPublisherStreamId$() {\r\n\t\tconst publisherStreamId = this.publisherStreamId;\r\n\t\tif (publisherStreamId) {\r\n\t\t\treturn of(publisherStreamId);\r\n\t\t} else {\r\n\t\t\treturn this.streams$.pipe(\r\n\t\t\t\tmap(() => this.publisherStreamId),\r\n\t\t\t\tfilter(x => x),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get attendeeStreamId() {\r\n\t\tconst streams = this.remotes.slice();\r\n\t\tconst local = this.local;\r\n\t\tif (local) {\r\n\t\t\tstreams.unshift(local);\r\n\t\t}\r\n\t\tconst attendeeStream = streams.find(x => x.clientInfo && x.clientInfo.role === RoleType.Attendee && x.clientInfo.uid === x.getId());\r\n\t\tif (attendeeStream) {\r\n\t\t\treturn attendeeStream.getId();\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tstatic getAttendeeStreamId$() {\r\n\t\tconst attendeeStreamId = this.attendeeStreamId;\r\n\t\tif (attendeeStreamId) {\r\n\t\t\treturn of(attendeeStreamId);\r\n\t\t} else {\r\n\t\t\treturn this.streams$.pipe(\r\n\t\t\t\tmap(() => this.attendeeStreamId),\r\n\t\t\t\tfilter(x => x),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getRemoteById(streamId) {\r\n\t\t// console.log('StreamService.getRemoteById', streamId);\r\n\t\tconst remotes = StreamService.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\tif (remote) {\r\n\t\t\treturn remote;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remoteAdd(stream) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tremotes.push(stream);\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n\r\n\tstatic remoteRemove(streamId) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\t// console.log('StreamService.remoteRemove', streamId, remote);\r\n\t\tif (remote) {\r\n\t\t\tif (remote.isPlaying()) {\r\n\t\t\t\tremote.stop();\r\n\t\t\t}\r\n\t\t\tremotes.splice(remotes.indexOf(remote), 1);\r\n\t\t\tthis.remotes = remotes;\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tstatic remoteSetClientInfo(remoteId, clientInfo) {\r\n\t\tconst remotes = this.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === remoteId);\r\n\t\tif (remote) {\r\n\t\t\tremote.clientInfo = clientInfo;\r\n\t\t}\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n}\r\n","import { from, interval, of } from 'rxjs';\r\nimport { catchError, distinctUntilChanged, map, switchMap } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport Emittable from '../emittable/emittable';\r\nimport { DEBUG, environment } from '../environment';\r\nimport { HttpService } from '../http/http.service';\r\nimport { Logger } from '../logger/logger';\r\nimport { MessageService } from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport SessionStorageService from '../storage/session-storage.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport { RoleType } from '../user/user';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraPeerEvent, AgoraRemoteEvent, AgoraStatus, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, AgoraVolumeLevelsEvent, MessageType, UIMode, USE_AUTODETECT, USE_RTM, USE_VOLUME_INDICATOR, getStreamQuality } from './agora.types';\r\n\r\nexport default class AgoraService extends Emittable {\r\n\r\n\tstatic getSingleton(defaultDevices) {\r\n\t\tif (DEBUG) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!this.AGORA) {\r\n\t\t\tthis.AGORA = new AgoraService(defaultDevices);\r\n\t\t}\r\n\t\treturn this.AGORA;\r\n\t}\r\n\r\n\tconstructor(defaultDevices) {\r\n\t\tif (AgoraService.AGORA) {\r\n\t\t\tthrow ('AgoraService is a singleton');\r\n\t\t}\r\n\t\tsuper();\r\n\t\tthis.channelState = {};\r\n\t\tthis.channelSnapshot = {};\r\n\t\tthis.onStreamPublished = this.onStreamPublished.bind(this);\r\n\t\tthis.onStreamUnpublished = this.onStreamUnpublished.bind(this);\r\n\t\tthis.onStreamAdded = this.onStreamAdded.bind(this);\r\n\t\tthis.onStreamRemoved = this.onStreamRemoved.bind(this);\r\n\t\tthis.onStreamSubscribed = this.onStreamSubscribed.bind(this);\r\n\t\tthis.onMuteVideo = this.onMuteVideo.bind(this);\r\n\t\tthis.onUnmuteVideo = this.onUnmuteVideo.bind(this);\r\n\t\tthis.onMuteAudio = this.onMuteAudio.bind(this);\r\n\t\tthis.onUnmuteAudio = this.onUnmuteAudio.bind(this);\r\n\t\tthis.onVolumeIndicator = this.onVolumeIndicator.bind(this);\r\n\t\tthis.onPeerConnect = this.onPeerConnect.bind(this);\r\n\t\tthis.onPeerLeaved = this.onPeerLeaved.bind(this);\r\n\t\tthis.onConnectionStateChange = this.onConnectionStateChange.bind(this);\r\n\t\tthis.onTokenPrivilegeWillExpire = this.onTokenPrivilegeWillExpire.bind(this);\r\n\t\tthis.onTokenPrivilegeDidExpire = this.onTokenPrivilegeDidExpire.bind(this);\r\n\t\tthis.onMessage = this.onMessage.bind(this);\r\n\t\tconst state = StateService.state;\r\n\t\tStateService.patchState({\r\n\t\t\tdevices: (state.role !== RoleType.Attendee && defaultDevices) ? defaultDevices : { videos: [], audios: [] },\r\n\t\t\tquality: getStreamQuality(state),\r\n\t\t\tmembersCount: 0,\r\n\t\t});\r\n\t}\r\n\r\n\tget isHostRole() {\r\n\t\treturn StateService.state.role === RoleType.Publisher || StateService.state.role === RoleType.Attendee;\r\n\t}\r\n\r\n\tget isAudienceRole() {\r\n\t\treturn StateService.state.role === RoleType.Viewer || StateService.state.role === RoleType.SelfService;\r\n\t}\r\n\r\n\taddStreamDevice(src) {\r\n\t\tthis.removeStreamDevice();\r\n\t\tconst video = {\r\n\t\t\tdeviceId: 'video-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst audio = {\r\n\t\t\tdeviceId: 'audio-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos.push(video);\r\n\t\tdevices.audios.push(audio);\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tremoveStreamDevice() {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos = devices.videos.filter(x => x.kind !== 'videostream');\r\n\t\tdevices.audios = devices.audios.filter(x => x.kind !== 'videostream');\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tdevices$() {\r\n\t\tconst inputs = StateService.state.devices;\r\n\t\tconst defaultVideos = this.defaultVideos = (this.defaultVideos || inputs.videos.slice());\r\n\t\tconst defaultAudios = this.defaultAudios = (this.defaultAudios || inputs.videos.slice());\r\n\t\tinputs.videos = defaultVideos.slice();\r\n\t\tinputs.audios = defaultAudios.slice();\r\n\t\treturn from(new Promise((resolve, reject) => {\r\n\t\t\tlet tempStream;\r\n\t\t\tconst getDevices = () => {\r\n\t\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t\t// Logger.log('AgoraService.devices$.getDevices', devices);\r\n\t\t\t\t\tif (tempStream) {\r\n\t\t\t\t\t\ttempStream.close();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\t\t\tconst device = devices[i];\r\n\t\t\t\t\t\t// Logger.log('AgoraService.devices$', device.deviceId);\r\n\t\t\t\t\t\tif (device.kind === 'videoinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.videos.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'camera-' + inputs.videos.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (device.kind === 'audioinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.audios.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'microphone-' + inputs.audios.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (inputs.videos.length > 0 || inputs.audios.length > 0) {\r\n\t\t\t\t\t\tresolve(inputs);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(inputs);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t};\r\n\t\t\ttempStream = AgoraRTC.createStream({ audio: true, video: true });\r\n\t\t\ttempStream.init(() => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t}, () => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t});\r\n\t\t}));\r\n\t}\r\n\r\n\tconnect$(preferences) {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tif (preferences) {\r\n\t\t\tdevices.video = preferences.video;\r\n\t\t\tdevices.audio = preferences.audio;\r\n\t\t}\r\n\t\t// Logger.log('AgoraService.connect$', preferences, devices);\r\n\t\tif (!StateService.state.connecting) {\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connecting, connecting: true, devices });\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.createClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\t// Logger.log('AgoraService.rtcToken$', token);\r\n\t\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}, 250);\r\n\t\t}\r\n\t\treturn StateService.state$;\r\n\t}\r\n\r\n\tmembersCount$(channelId) {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\treturn interval(3000).pipe(\r\n\t\t\tswitchMap(() => from(messageClient.getChannelMemberCount([channelId]))),\r\n\t\t\tmap(counters => counters[channelId]),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\tLogger.error('AgoraService.membersCount$.error', error);\r\n\t\t\t\treturn of(0);\r\n\t\t\t}),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tobserveMemberCount() {\r\n\t\tthis.unobserveMemberCount();\r\n\t\t// !!! perf\r\n\t\t// only host roles collect membersCount to reduce call/sec.\r\n\t\tif (this.isHostRole) {\r\n\t\t\tthis.membersCountSubscription = this.membersCount$(StateService.state.channelNameLink).subscribe(\r\n\t\t\t\tmembersCount => {\r\n\t\t\t\t\tStateService.patchState({ membersCount: membersCount });\r\n\t\t\t\t},\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tunobserveMemberCount() {\r\n\t\tif (this.membersCountSubscription) {\r\n\t\t\tthis.membersCountSubscription.unsubscribe();\r\n\t\t\tthis.membersCountSubscription = null;\r\n\t\t\tStateService.patchState({ membersCount: 0 });\r\n\t\t}\r\n\t}\r\n\r\n\tcreateClient(next) {\r\n\t\tif (this.client) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\t// Logger.log('agora rtc sdk version: ' + AgoraRTC.VERSION + ' compatible: ' + AgoraRTC.checkSystemRequirements());\r\n\t\t// AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.ERROR);\r\n\t\tAgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.NONE);\r\n\t\tconst client = this.client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t\tLogger.log('AgoraService.createClient.startProxyServer');\r\n\t\t\t}\r\n\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\tLogger.log('AgoraService.createClient', 'initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\tLogger.error('AgoraService.createClient.error', error);\r\n\t\t\t\tthis.client = null;\r\n\t\t\t});\r\n\t\t};\r\n\t\tif (this.isAudienceRole) {\r\n\t\t\tclient.setClientRole('audience', function(error) {\r\n\t\t\t\tif (!error) {\r\n\t\t\t\t\tclientInit();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tclientInit();\r\n\t\t}\r\n\t\tclient.on('error', this.onError);\r\n\t\tclient.on('stream-published', this.onStreamPublished);\r\n\t\tclient.on('stream-unpublished', this.onStreamUnpublished);\r\n\t\t//subscribe remote stream\r\n\t\tclient.on('stream-added', this.onStreamAdded);\r\n\t\tclient.on('stream-removed', this.onStreamRemoved);\r\n\t\tclient.on('stream-subscribed', this.onStreamSubscribed);\r\n\t\tclient.on('mute-video', this.onMuteVideo);\r\n\t\tclient.on('unmute-video', this.onUnmuteVideo);\r\n\t\tclient.on('mute-audio', this.onMuteAudio);\r\n\t\tclient.on('unmute-audio', this.onUnmuteAudio);\r\n\t\tif (USE_VOLUME_INDICATOR) {\r\n\t\t\tclient.enableAudioVolumeIndicator(); // Triggers the 'volume-indicator' callback event every two seconds.\r\n\t\t\tclient.on('volume-indicator', this.onVolumeIndicator);\r\n\t\t}\r\n\t\tclient.on('peer-online', this.onPeerConnect);\r\n\t\t// Occurs when the peer user leaves the channel; for example, the peer user calls Client.leave.\r\n\t\tclient.on('peer-leave', this.onPeerLeaved);\r\n\t\t// client.on('connection-state-change', this.onConnectionStateChange);\r\n\t\tclient.on('onTokenPrivilegeWillExpire', this.onTokenPrivilegeWillExpire);\r\n\t\tclient.on('onTokenPrivilegeDidExpire', this.onTokenPrivilegeDidExpire);\r\n\t\t// Logger.log('AgoraService.createClient', 'agora rtm sdk version: ' + AgoraRTM.VERSION + ' compatible');\r\n\t\tif (USE_RTM) {\r\n\t\t\t/*\r\n\t\t\tAgoraRTM.LOG_FILTER_OFF\r\n\t\t\tAgoraRTM.LOG_FILTER_ERROR\r\n\t\t\tAgoraRTM.LOG_FILTER_INFO (Default)\r\n\t\t\tAgoraRTM.LOG_FILTER_WARNING\r\n\t\t\t*/\r\n\t\t\tconst messageClient = this.messageClient = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF }); // LOG_FILTER_DEBUG\r\n\t\t\tmessageClient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\tLogger.log('AgoraService.createClient', 'client initialized');\r\n\t\t\t// messageClient.on('ConnectionStateChanged', Logger.warn);\r\n\t\t\t// messageClient.on('MessageFromPeer', Logger.log);\r\n\t\t}\r\n\t}\r\n\r\n\tgetChannelNameLink() {\r\n\t\tlet link = StateService.state.link || '';\r\n\t\tconst match = link.match(/(\\d{9})-(\\d{4})-(\\d{13})/);\r\n\t\tif (match) {\r\n\t\t\tlink = `${match[1]}-${match[3]}`;\r\n\t\t}\r\n\t\tconst channelName = StateService.state.channelName;\r\n\t\tconst channelNameLink = `${channelName}-${link}`;\r\n\t\t// Logger.log('AgoraService.getChannelNameLink', channelNameLink);\r\n\t\treturn channelNameLink;\r\n\t}\r\n\r\n\tstatic getUniqueUserId() {\r\n\t\t// max safe integer 9007199254740991 length 16\r\n\t\t// max allowed integer 4294967296 2^32\r\n\t\tconst m = 9007199254740991;\r\n\t\tconst mult = 10000000000000;\r\n\t\tconst a = (1 + Math.floor(Math.random() * 8)) * 100;\r\n\t\tconst b = (1 + Math.floor(Math.random() * 8)) * 10;\r\n\t\tconst c = (1 + Math.floor(Math.random() * 8)) * 1;\r\n\t\tconst combo = (a + b + c);\r\n\t\tconst date = Date.now();\r\n\t\tconst uid = combo * mult + date;\r\n\t\t// Logger.log('AgoraService.getUniqueUserId', combo);\r\n\t\t// Logger.log('AgoraService.getUniqueUserId', date);\r\n\t\t// Logger.log('AgoraService.getUniqueUserId', m);\r\n\t\t// Logger.log('AgoraService.getUniqueUserId', uid);\r\n\t\treturn uid.toString();\r\n\t}\r\n\r\n\tjoin(token, channelNameLink) {\r\n\t\tthis.channel = null;\r\n\t\tconst client = this.client;\r\n\t\tconst clientId = SessionStorageService.get('bHereClientId') || AgoraService.getUniqueUserId();\r\n\t\tLogger.log('AgoraService.join', { token, channelNameLink, clientId });\r\n\t\tclient.join(token, channelNameLink, clientId, (uid) => {\r\n\t\t\t// Logger.log('AgoraService.join', uid);\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connected, channelNameLink, connected: true, uid: uid });\r\n\t\t\tSessionStorageService.set('bHereClientId', uid);\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t\t// Logger.log('AgoraService.join.rtmToken$', token);\r\n\t\t\t\t\tthis.joinMessageChannel(token.token, uid).then((success) => {\r\n\t\t\t\t\t\t// Logger.log('AgoraService.join.joinMessageChannel.success', success);\r\n\t\t\t\t\t\tif (!this.isAudienceRole) {\r\n\t\t\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.observeMemberCount();\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\tLogger.error('AgoraService.join.joinMessageChannel.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tif (!this.isAudienceRole) {\r\n\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, (error) => {\r\n\t\t\tLogger.error('AgoraService.join.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\t// https://console.agora.io/invite?sign=YXBwSWQlM0RhYjQyODlhNDZjZDM0ZGE2YTYxZmQ4ZDY2Nzc0YjY1ZiUyNm5hbWUlM0RaYW1wZXR0aSUyNnRpbWVzdGFtcCUzRDE1ODY5NjM0NDU=// join link expire in 30 minutes\r\n\t}\r\n\r\n\tjoinMessageChannel(token, uid) {\r\n\t\tlet channel;\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tLogger.log('AgoraService.joinMessageChannel', messageClient);\r\n\t\t\tmessageClient.login({ token: token, uid: uid.toString() }).then(() => {\r\n\t\t\t\tLogger.log('AgoraService.joinMessageChannel.login.success');\r\n\t\t\t\tchannel = messageClient.createChannel(StateService.state.channelNameLink);\r\n\t\t\t\treturn channel.join();\r\n\t\t\t}).then(() => {\r\n\t\t\t\tthis.channel = channel;\r\n\t\t\t\tchannel.on('ChannelMessage', this.onMessage);\r\n\t\t\t\tthis.emit('channel', channel);\r\n\t\t\t\t// Logger.log('AgoraService.joinMessageChannel.success');\r\n\t\t\t\tresolve(uid);\r\n\t\t\t\tLogger.log('AgoraService.joinMessageChannel.join.success');\r\n\t\t\t\tchannel.getMembers().then(members => {\r\n\t\t\t\t\tmembers = members.filter(x => x !== uid.toString());\r\n\t\t\t\t\tconst message = { type: MessageType.ChannelMembers, members };\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t\tLogger.log('AgoraService.joinMessageChannel.members', message);\r\n\t\t\t\t});\r\n\t\t\t\tLogger.log('AgoraService.joinMessageChannel', StateService.state.channelNameLink);\r\n\t\t\t}).catch(error => {\r\n\t\t\t\tLogger.error('AgoraService.joinMessageChannel.error', error);\r\n\t\t\t\treject(error);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tdetectDevices(next) {\r\n\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\tconst videos = [];\r\n\t\t\tconst audios = [];\r\n\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\tconst device = devices[i];\r\n\t\t\t\tif ('videoinput' == device.kind) {\r\n\t\t\t\t\tvideos.push({\r\n\t\t\t\t\t\tlabel: device.label || 'camera-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tif ('audioinput' == device.kind) {\r\n\t\t\t\t\taudios.push({\r\n\t\t\t\t\t\tlabel: device.label || 'microphone-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tnext({ videos: videos, audios: audios });\r\n\t\t}).catch((error) => {\r\n\t\t\tLogger.error('AgoraService.detectDevices', error);\r\n\t\t});\r\n\t}\r\n\r\n\tgetVideoOptions(options, video) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (video) {\r\n\t\t\t\tif (video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(video.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// Logger.log('AgoraService.getVideoOptions.hls', data.levels);\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t\t\t// Logger.log('AgoraService.getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tLogger.error('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (video.kind === 'videoplayer' || video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t// Logger.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t// Logger.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// Logger.error('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.cameraId = video.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tgetAudioOptions(options, audio) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (audio) {\r\n\t\t\t\tif (audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// !!! try hls.service;\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(audio.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// Logger.log('AgoraService.getAudioOptions.hls', data.levels);\r\n\t\t\t\t\t\t\thls.loadLevel = data.levels.length - 1;\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t\t\t// Logger.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tLogger.error('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (audio.kind === 'videoplayer' || audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t// Logger.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t// Logger.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// Logger.error('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.microphoneId = audio.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tautoDetectDevice() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst state = StateService.state;\r\n\t\t\tif (state.role === RoleType.SmartDevice || USE_AUTODETECT) {\r\n\t\t\t\tAgoraService.getDevices().then(inputDevices => {\r\n\t\t\t\t\tconst devices = { videos: [], audios: [], video: null, audio: null };\r\n\t\t\t\t\tinputDevices.forEach(x => {\r\n\t\t\t\t\t\tif (x.kind === 'videoinput') {\r\n\t\t\t\t\t\t\tdevices.videos.push(x);\r\n\t\t\t\t\t\t} else if (x.kind === 'audioinput') {\r\n\t\t\t\t\t\t\tdevices.audios.push(x);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tdevices.video = devices.videos[0] || null;\r\n\t\t\t\t\tdevices.audio = devices.audios[0] || null;\r\n\t\t\t\t\tStateService.patchState({ devices });\r\n\t\t\t\t\tresolve(devices);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve(state.devices);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateMediaStream(uid, video, audio) {\r\n\t\t// this.releaseStream('_mediaVideoStream')\r\n\t\tconst options = {\r\n\t\t\tstreamID: uid,\r\n\t\t\tvideo: Boolean(video),\r\n\t\t\taudio: Boolean(audio),\r\n\t\t\tscreen: false,\r\n\t\t};\r\n\t\tPromise.all([\r\n\t\t\tthis.getVideoOptions(options, video),\r\n\t\t\tthis.getAudioOptions(options, audio),\r\n\t\t]).then(success => {\r\n\t\t\tconst quality = Object.assign({}, StateService.state.quality);\r\n\t\t\tthis.createLocalStreamWithOptions(options, quality);\r\n\t\t});\r\n\t}\r\n\r\n\t// If you prefer video smoothness to sharpness, use setVideoProfile\r\n\t// to set the video resolution and Agora self-adapts the video bitrate according to the network condition.\r\n\t// If you prefer video sharpness to smoothness, use setVideoEncoderConfiguration,\r\n\t// and set min in bitrate as 0.4 - 0.5 times the bitrate value in the video profile table.\r\n\tcreateLocalStreamWithOptions(options, quality) {\r\n\t\tconst local = AgoraRTC.createStream(options);\r\n\t\tif (quality) {\r\n\t\t\tlocal.setVideoProfile(quality.profile);\r\n\t\t\t// local.setVideoEncoderConfiguration(quality);\r\n\t\t}\r\n\t\t// Logger.log('AgoraService.createLocalStreamWithOptions', options, quality, local.attributes);\r\n\t\tlocal.init(() => {\r\n\t\t\tStreamService.local = local;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishLocalStream();\r\n\t\t\t}, 1);\r\n\t\t}, (error) => {\r\n\t\t\tLogger.error('AgoraService.createLocalStreamWithOptions.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tpublishLocalStream() {\r\n\t\tLogger.log('AgoraService.publishLocalStream');\r\n\t\tthis.setUserState().then((clientInfo) => {\r\n\t\t\tconst client = this.client;\r\n\t\t\tconst local = StreamService.local;\r\n\t\t\t// publish local stream\r\n\t\t\tclient.publish(local, (error) => {\r\n\t\t\t\tLogger.error('AgoraService.publishLocalStream.error', local.getId(), error);\r\n\t\t\t});\r\n\t\t\tlocal.clientInfo = clientInfo;\r\n\t\t\tStreamService.local = local;\r\n\t\t});\r\n\t}\r\n\r\n\tunpublishLocalStream() {\r\n\t\tconst client = this.client;\r\n\t\tconst local = StreamService.local;\r\n\t\tif (local) {\r\n\t\t\tclient.unpublish(local, (error) => {\r\n\t\t\t\tLogger.error('AgoraService.unpublishLocalStream.error', local.getId(), error);\r\n\t\t\t});\r\n\t\t\tthis.clearLocalUserAttributes();\r\n\t\t}\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tleaveChannel() {\r\n\t\tStateService.patchState({ connecting: false });\r\n\t\tthis.unpublishLocalStream();\r\n\t\tthis.unpublishScreenStream();\r\n\t\tStreamService.remotes = [];\r\n\t\tStreamService.peers = [];\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.leaveMessageChannel().then(() => {\r\n\t\t\t\tPromise.all([this.leaveClient(), this.leaveScreenClient()]).then(() => {\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t}).catch(error => {\r\n\t\t\t\treject(error);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tleaveClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst client = this.client;\r\n\t\t\tif (client) {\r\n\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\tthis.client = null;\r\n\t\t\t\t\t// Logger.log('AgoraService.leaveClient', 'Leave channel successfully');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\tLogger.log('AgoraService.leaveClient.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tLogger.error('AgoraService.leaveClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tleaveMessageChannel() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tthis.unobserveMemberCount();\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tif (!channel) {\r\n\t\t\t\t\treturn resolve();\r\n\t\t\t\t}\r\n\t\t\t\tconst messageClient = this.messageClient;\r\n\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\tthis.channel = null;\r\n\t\t\t\t\tmessageClient.logout().then(() => {\r\n\t\t\t\t\t\tthis.messageClient = null;\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t}, reject);\r\n\t\t\t\t}, reject);\r\n\t\t\t} else {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// Logger.log('AgoraService.toggleCamera', local);\r\n\t\tif (local && local.video) {\r\n\t\t\tif (local.userMuteVideo) {\r\n\t\t\t\tlocal.unmuteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t\tthis.setUserState();\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t\tthis.setUserState();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// Logger.log('AgoraService.toggleAudio', local);\r\n\t\tif (local && local.audio) {\r\n\t\t\tif (local.userMuteAudio) {\r\n\t\t\t\tlocal.unmuteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t\tthis.setUserState();\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t\tthis.setUserState();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpreviousMuteAudio_ = false;\r\n\tsetAudio(audioMuted) {\r\n\t\tconst local = StreamService.local;\r\n\t\tif (local && local.audio) {\r\n\t\t\tif (audioMuted) {\r\n\t\t\t\tthis.previousMuteAudio_ = local.userMuteAudio;\r\n\t\t\t\tif (!local.userMuteAudio) {\r\n\t\t\t\t\tlocal.muteAudio();\r\n\t\t\t\t\tStateService.patchState({ audioMuted: true });\r\n\t\t\t\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t\t\tthis.setUserState();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (local.userMuteAudio && !this.previousMuteAudio_) {\r\n\t\t\t\t\tlocal.unmuteAudio();\r\n\t\t\t\t\tStateService.patchState({ audioMuted: false });\r\n\t\t\t\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t\t\tthis.setUserState();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleMode() {\r\n\t\tconst mode = StateService.state.mode === UIMode.VirtualTour ? UIMode.LiveMeeting : UIMode.VirtualTour;\r\n\t\tStateService.patchState({ mode });\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.Mode,\r\n\t\t\tmode: mode,\r\n\t\t});\r\n\t\tthis.setChannelState({ mode });\r\n\t}\r\n\r\n\ttoggleNavInfo() {\r\n\t\tconst showNavInfo = !StateService.state.showNavInfo;\r\n\t\tStateService.patchState({ showNavInfo });\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.NavInfo,\r\n\t\t\tshowNavInfo: showNavInfo,\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * controllingId is the uid of the controller user.\r\n\t */\r\n\trequestControl(controllingId) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tthis.sendRequestControl(controllingId).then((controllingId) => {\r\n\t\t\t\tStateService.patchState({ controlling: controllingId, spying: false });\r\n\t\t\t\tresolve(controllingId);\r\n\t\t\t\tthis.setChannelState({ controlling: controllingId, spying: '' });\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\trequestSpy(spyingId) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tthis.sendRequestSpy(spyingId).then((spyingId) => {\r\n\t\t\t\tStateService.patchState({ spying: spyingId, controlling: false });\r\n\t\t\t\tresolve(spyingId);\r\n\t\t\t\tthis.setChannelState({ spying: spyingId, controlling: '' });\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * controllingId is the uid of the controller user.\r\n\t */\r\n\tdismissControl(skipAttributes = false) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tconst controllingId = StateService.state.controlling;\r\n\t\t\tif (controllingId) {\r\n\t\t\t\tthis.sendRequestControlDismiss(controllingId).then(() => {\r\n\t\t\t\t\tStateService.patchState({ controlling: false });\r\n\t\t\t\t\tresolve(controllingId);\r\n\t\t\t\t\tif (!skipAttributes) {\r\n\t\t\t\t\t\tthis.setChannelState({ controlling: '' });\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve(false);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tdismissSpy(skipAttributes = false) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tconst spyingId = StateService.state.spying;\r\n\t\t\tif (spyingId) {\r\n\t\t\t\tthis.sendRequestSpyDismiss(spyingId).then(() => {\r\n\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t\tresolve(spyingId);\r\n\t\t\t\t\tif (!skipAttributes) {\r\n\t\t\t\t\t\tthis.setChannelState({ spying: '' });\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve(false);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * controllingId is the uid of the controller user.\r\n\t */\r\n\ttoggleControl(controllingId) {\r\n\t\tthis.dismissSpy(true).then(() => {\r\n\t\t\tthis.dismissControl(true).then((dismissedControllingId) => {\r\n\t\t\t\tif (dismissedControllingId !== controllingId) {\r\n\t\t\t\t\tthis.requestControl(controllingId).then((controllingId) => {\r\n\t\t\t\t\t\tLogger.log('AgoraService.toggleControl', controllingId);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.setChannelState({ controlling: '' });\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleSpy(spyingId) {\r\n\t\tthis.dismissControl(true).then(() => {\r\n\t\t\tthis.dismissSpy(true).then((dismissedSpyingId) => {\r\n\t\t\t\tif (dismissedSpyingId !== spyingId) {\r\n\t\t\t\t\tthis.requestSpy(spyingId).then((spyingId) => {\r\n\t\t\t\t\t\tLogger.log('AgoraService.toggleSpy', spyingId);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.setChannelState({ spying: '' });\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRequestControl(controllingId) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControl,\r\n\t\t\t\tcontrollingId: controllingId,\r\n\t\t\t}).then(() => {\r\n\t\t\t\tresolve(controllingId);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRequestSpy(spyingId) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestSpy,\r\n\t\t\t\tspyingId: spyingId,\r\n\t\t\t}).then(() => {\r\n\t\t\t\tresolve(spyingId);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRequestControlDismiss(controllingId) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControlDismiss,\r\n\t\t\t\tcontrollingId: controllingId,\r\n\t\t\t}).then(() => {\r\n\t\t\t\tresolve(controllingId);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRequestSpyDismiss(spyingId) {\r\n\t\treturn new Promise((resolve, _) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestSpyDismiss,\r\n\t\t\t\tspyingId: spyingId,\r\n\t\t\t}).then(() => {\r\n\t\t\t\tresolve(spyingId);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleSilence() {\r\n\t\tconst silencing = !StateService.state.silencing;\r\n\t\tthis.sendMessage({\r\n\t\t\ttype: MessageType.RemoteSilencing,\r\n\t\t\tsilencing: silencing,\r\n\t\t});\r\n\t\tStateService.patchState({ silencing });\r\n\t\t// !!! todo silencing\r\n\t\t// this.setChannelState({ silencing });\r\n\t}\r\n\r\n\tnewMessageId() {\r\n\t\treturn `${StateService.state.uid}-${Date.now().toString()}`;\r\n\t}\r\n\r\n\tnavToView(viewId, keepOrientation = false, useLastOrientation = false) {\r\n\t\tif (StateService.state.controlling === StateService.state.uid || StateService.state.spying === StateService.state.uid) {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.NavToView,\r\n\t\t\t\tviewId: viewId,\r\n\t\t\t\tkeepOrientation: keepOrientation,\r\n\t\t\t\tuseLastOrientation: useLastOrientation,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tgetSessionStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSessionStats((stats) => {\r\n\t\t\tLogger.log(`\r\nAgoraService.getSessionStats\r\n\tDuration: ${stats.Duration}\r\n\tUserCount: ${stats.UserCount}\r\n\tSendBytes: ${stats.SendBytes}\r\n\tRecvBytes: ${stats.RecvBytes}\r\n\tSendBitrate: ${stats.SendBitrate}\r\n\tRecvBitrate: ${stats.RecvBitrate}\r\n`);\r\n\t\t});\r\n\t}\r\n\r\n\tgetSystemStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSystemStats((stats) => {\r\n\t\t\tLogger.log(`\r\nAgoraService.getSystemStats\r\n\t\t\tBatteryLevel: ${stats.BatteryLevel}\r\n`);\r\n\t\t});\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (StateService.state.connected) {\r\n\t\t\t\tmessage.clientId = StateService.state.uid;\r\n\t\t\t\t// Logger.log('AgoraService.sendMessage');\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tcase MessageType.CurrentTimeMedia:\r\n\t\t\t\t\tcase MessageType.MenuToggle:\r\n\t\t\t\t\tcase MessageType.Mode:\r\n\t\t\t\t\tcase MessageType.NavInfo:\r\n\t\t\t\t\tcase MessageType.NavLink:\r\n\t\t\t\t\tcase MessageType.NavLinkClose:\r\n\t\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\tcase MessageType.NavToView:\r\n\t\t\t\t\tcase MessageType.PlayMedia:\r\n\t\t\t\t\tcase MessageType.PlayModel:\r\n\t\t\t\t\tcase MessageType.SelectItem:\r\n\t\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tcase MessageType.SlideChange:\r\n\t\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\tcase MessageType.VRState:\r\n\t\t\t\t\tcase MessageType.ZoomMedia:\r\n\t\t\t\t\tcase MessageType.SetSnapshot:\r\n\t\t\t\t\t\t// Logger.log('AgoraService.sendMessage', StateService.state.uid, StateService.state.controlling, StateService.state.spying, StateService.state.controlling !== StateService.state.uid && StateService.state.spying !== StateService.state.uid);\r\n\t\t\t\t\t\tif (\r\n\t\t\t\t\t\t\tStateService.state.controlling !== StateService.state.uid &&\r\n\t\t\t\t\t\t\tStateService.state.spying !== StateService.state.uid\r\n\t\t\t\t\t\t) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\t// message.wrc_version = 'beta';\r\n\t\t\t\t// message.uid = StateService.state.uid;\r\n\t\t\t\tconst onMessageSent = (message) => {\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t\t// rewire inner messages\r\n\t\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\t\tcase MessageType.RequestControl:\r\n\t\t\t\t\t\t\t// !!! rewire inner message\r\n\t\t\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase MessageType.SetSnapshot:\r\n\t\t\t\t\t\t\t// !!! saving channel snapshot\r\n\t\t\t\t\t\t\tthis.setChannelSnapshot(message);\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tconst send = (message, channel) => {\r\n\t\t\t\t\tLogger.log('AgoraService.sendMessage', message);\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst text = JSON.stringify(message);\r\n\t\t\t\t\t\tif (message.messageId) {\r\n\t\t\t\t\t\t\tthis.once(`message-${message.messageId}`, (message) => {\r\n\t\t\t\t\t\t\t\tonMessageSent(message);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// Logger.log('AgoraService.sendMessage.sending', message.type);\r\n\t\t\t\t\t\tchannel.sendMessage({ text: text }).then(() => {\r\n\t\t\t\t\t\t\t// Logger.log('AgoraService.sendMessage', text);\r\n\t\t\t\t\t\t\tif (!message.messageId) {\r\n\t\t\t\t\t\t\t\tonMessageSent(message);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}).catch(error => {\r\n\t\t\t\t\t\t\tLogger.error('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\tLogger.error('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t// reject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tif (channel) {\r\n\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tthis.once('channel', (channel) => {\r\n\t\t\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\tLogger.error('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tLogger.error('AgoraService.sendMessage.error', 'not connected');\r\n\t\t\t\t// reject();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @description getChannelAttributes\r\n\t * @returns Record<string, { lastUpdateTs: number, value: string }>\r\n\t */\r\n\tgetChannelAttributes() {\r\n\t\tLogger.log('AgoraService.getChannelAttributes');\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tif (messageClient) {\r\n\t\t\t\tconst promise = messageClient.getChannelAttributes(StateService.state.channelNameLink);\r\n\t\t\t\tpromise.then((attributes) => {\r\n\t\t\t\t\tLogger.log('AgoraService.getChannelAttributes', attributes);\r\n\t\t\t\t\tresolve(attributes);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\tLogger.error('AgoraService.getChannelAttributes.error', error);\r\n\t\t\t\t\tresolve({});\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tLogger.error('AgoraService.getChannelAttributes.noop');\r\n\t\t\t\tresolve({});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @description getChannelAttributesByKeys\r\n\t * @params string[]\r\n\t * @returns Record<string, string>\r\n\t */\r\n\tgetChannelAttributesByKeys(...keys) {\r\n\t\tLogger.log('AgoraService.getChannelAttributesByKeys', keys);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tif (messageClient) {\r\n\t\t\t\tconst promise = messageClient.getChannelAttributes(StateService.state.channelNameLink, keys);\r\n\t\t\t\tpromise.then((attributes) => {\r\n\t\t\t\t\tLogger.log('AgoraService.getChannelAttributesByKeys', attributes);\r\n\t\t\t\t\tconst mappedAttributes = {};\r\n\t\t\t\t\tObject.keys(attributes).forEach(key => {\r\n\t\t\t\t\t\tmappedAttributes[key] = attributes[key].value;\r\n\t\t\t\t\t});\r\n\t\t\t\t\tresolve(mappedAttributes);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\tLogger.error('AgoraService.getChannelAttributesByKeys.error', error);\r\n\t\t\t\t\tresolve({});\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tLogger.error('AgoraService.getChannelAttributesByKeys.noop', keys);\r\n\t\t\t\tresolve({});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @description getChannelMessages\r\n\t * @returns { date: number, clientId: string, name: string, message: string }[]\r\n\t */\r\n\tgetChannelMessages() {\r\n\t\tLogger.log('AgoraService.getChannelMessages');\r\n\t\treturn from(this.getChannelAttributes()).pipe(\r\n\t\t\tmap(attributes => Object.keys(attributes)\r\n\t\t\t\t.filter(key => key.indexOf('message-') === 0)\r\n\t\t\t\t.map(key => attributes[key]),\r\n\t\t\t),\r\n\t\t\tmap(attributes => {\r\n\t\t\t\tattributes.sort((a, b) => {\r\n\t\t\t\t\treturn a.lastUpdateTs - b.lastUpdateTs;\r\n\t\t\t\t});\r\n\t\t\t\tconst messages = attributes.map(attribute => {\r\n\t\t\t\t\tconst message = JSON.parse(attribute.value);\r\n\t\t\t\t\treturn message;\r\n\t\t\t\t});\r\n\t\t\t\tLogger.log('AgoraService.getChannelMessages', messages);\r\n\t\t\t\treturn messages;\r\n\t\t\t}),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\tLogger.error('AgoraService.getChannelMessages.error', error);\r\n\t\t\t\treturn of([]);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\t/**\r\n\t * @description addOrUpdateChannelAttributes\r\n\t * @params attributes: Record<string, string>\r\n\t */\r\n\taddOrUpdateChannelAttributes(attributes) {\r\n\t\tLogger.log('AgoraService.addOrUpdateChannelAttributes', attributes);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tif (messageClient && Object.keys(attributes).length > 0) {\r\n\t\t\t\tconst promise = messageClient.addOrUpdateChannelAttributes(StateService.state.channelNameLink, attributes, { enableNotificationToChannelMembers: false });\r\n\t\t\t\tpromise.then(() => {\r\n\t\t\t\t\tLogger.log('AgoraService.addOrUpdateChannelAttributes', attributes);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\tLogger.error('AgoraService.addOrUpdateChannelAttributes.error', error);\r\n\t\t\t\t}).finally(() => {\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tLogger.error('AgoraService.addOrUpdateChannelAttributes.noop', attributes);\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * this method is called after remote stream of the publisher has been added.\r\n\t */\r\n\tgetInitialSession() {\r\n\t\tthis.getChannelSession().then(session => {\r\n\t\t\tStateService.patchState(session.state);\r\n\t\t\tif (session.state.controlling && session.snapshot) {\r\n\t\t\t\t// !!! rewire inner message to update view snapshot\r\n\t\t\t\tthis.broadcastMessage(session.snapshot);\r\n\t\t\t}\r\n\t\t\t// handle window mode changes\r\n\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @description getChannelSession\r\n\t * @returns { state: State, snapshot: Snapshot }\r\n\t */\r\n\tgetChannelSession() {\r\n\t\tLogger.log('AgoraService.getChannelSession');\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.getChannelAttributesByKeys('channelState', 'channelSnapshot').then(attributes => {\r\n\t\t\t\tconst channelSession = {\r\n\t\t\t\t\tstate: {},\r\n\t\t\t\t\tsnapshot: {},\r\n\t\t\t\t};\r\n\t\t\t\tif (attributes.channelState) {\r\n\t\t\t\t\tconst channelState = JSON.parse(attributes.channelState);\r\n\t\t\t\t\tthis.channelState = channelState;\r\n\t\t\t\t\tchannelSession.state = channelState;\r\n\t\t\t\t}\r\n\t\t\t\tif (attributes.channelSnapshot) {\r\n\t\t\t\t\tconst channelSnapshot = JSON.parse(attributes.channelSnapshot);\r\n\t\t\t\t\tthis.channelSnapshot = channelSnapshot;\r\n\t\t\t\t\tchannelSession.snapshot = channelSnapshot;\r\n\t\t\t\t}\r\n\t\t\t\tLogger.log('AgoraService.getChannelSession', channelSession);\r\n\t\t\t\tresolve(channelSession);\r\n\t\t\t}).catch(error => {\r\n\t\t\t\tLogger.error('AgoraService.getChannelSession.error', error);\r\n\t\t\t\tresolve({});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @description getChannelState\r\n\t * @returns State\r\n\t */\r\n\tgetChannelState() {\r\n\t\tLogger.log('AgoraService.getChannelState');\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.getChannelAttributesByKeys('channelState').then(attributes => {\r\n\t\t\t\tif (attributes.channelState) {\r\n\t\t\t\t\tconst channelState = JSON.parse(attributes.channelState);\r\n\t\t\t\t\tthis.channelState = channelState;\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tconst channelState = {\r\n\t\t\t\t\t\trole: StateService.state.role,\r\n\t\t\t\t\t\tname: StateService.state.name,\r\n\t\t\t\t\t\tuid: StateService.state.uid,\r\n\t\t\t\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t\t\t\t\tcontrolling: StateService.state.controlling,\r\n\t\t\t\t\t\tspying: StateService.state.spying,\r\n\t\t\t\t\t\tmode: StateService.state.mode,\r\n\t\t\t\t\t};\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tLogger.log('AgoraService.getChannelState', channelState);\r\n\t\t\t\t\tresolve(channelState);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tresolve({});\r\n\t\t\t\t}\r\n\t\t\t}).catch(error => {\r\n\t\t\t\tLogger.error('AgoraService.getChannelState.error', error);\r\n\t\t\t\tresolve({});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @description setChannelState\r\n\t * @params partialState: Record<string, string>\r\n\t */\r\n\tsetChannelState(partialState) {\r\n\t\tconst channelState = { ...(this.channelState || {}), ...partialState };\r\n\t\tLogger.log('AgoraService.setChannelState', partialState, channelState);\r\n\t\treturn this.addOrUpdateChannelAttributes({ channelState: JSON.stringify(channelState) });\r\n\t}\r\n\r\n\t/**\r\n\t * @description getChannelSnapshot\r\n\t * @returns Snapshot\r\n\t */\r\n\tgetChannelSnapshot() {\r\n\t\tLogger.log('AgoraService.getChannelSnapshot');\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.getChannelAttributesByKeys('channelSnapshot').then(attributes => {\r\n\t\t\t\tif (attributes.channelSnapshot) {\r\n\t\t\t\t\tconst channelSnapshot = JSON.parse(attributes.channelSnapshot);\r\n\t\t\t\t\tthis.channelSnapshot = channelSnapshot;\r\n\t\t\t\t\tLogger.log('AgoraService.getChannelSnapshot', channelSnapshot);\r\n\t\t\t\t\tresolve(channelSnapshot);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tresolve({});\r\n\t\t\t\t}\r\n\t\t\t}).catch(error => {\r\n\t\t\t\tLogger.error('AgoraService.getChannelSnapshot.error', error);\r\n\t\t\t\tresolve({});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * @description setChannelSnapshot\r\n\t * @params partialSnapshot: Record<string, string>\r\n\t */\r\n\tsetChannelSnapshot(partialSnapshot) {\r\n\t\tconst channelSnapshot = { ...(this.channelSnapshot || {}), ...partialSnapshot };\r\n\t\tLogger.log('AgoraService.setChannelSnapshot', partialSnapshot, channelSnapshot);\r\n\t\treturn this.addOrUpdateChannelAttributes({ channelSnapshot: JSON.stringify(channelSnapshot) });\r\n\t}\r\n\r\n\tpadStart(num, count = 5, char = '0') {\r\n\t\tconst s = String(num);\r\n\t\treturn s.length >= count ? s : new Array(count - s.length + 1).join(char) + s;\r\n\t}\r\n\r\n\t/**\r\n\t * @description addOrUpdateChannelMessages\r\n\t * @params messages: { date: number, clientId: string, name: string, message: string }[]\r\n\t */\r\n\taddOrUpdateChannelMessages(messages) {\r\n\t\tconst attributes = {};\r\n\t\tmessages.forEach(message => {\r\n\t\t\tconst num = Math.floor(Math.random() * 10000);\r\n\t\t\tconst key = `message-${message.date}-${this.padStart(num)}`;\r\n\t\t\tattributes[key] = JSON.stringify(message);\r\n\t\t});\r\n\t\treturn this.addOrUpdateChannelAttributes(attributes);\r\n\t}\r\n\r\n\tdeleteChannelAttributesByKeys(keys) {\r\n\t\tLogger.log('AgoraService.deleteChannelAttributesByKeys', keys);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tif (messageClient && keys.length > 0) {\r\n\t\t\t\tconst promise = messageClient.deleteChannelAttributesByKeys(StateService.state.channelNameLink, keys, { enableNotificationToChannelMembers: false });\r\n\t\t\t\tpromise.then(() => {\r\n\t\t\t\t\tLogger.log('AgoraService.deleteChannelAttributesByKeys', keys);\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\tLogger.error('AgoraService.deleteChannelAttributesByKeys.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tLogger.error('AgoraService.deleteChannelAttributesByKeys.noop', keys);\r\n\t\t\t\treject('missing rtm client or keys');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetUserState() {\r\n\t\tconst clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t\tcameraMuted: StateService.state.cameraMuted,\r\n\t\t\taudioMuted: StateService.state.audioMuted,\r\n\t\t};\r\n\t\tLogger.log('AgoraService.setUserState', clientInfo);\r\n\t\treturn this.addOrUpdateLocalUserAttributes({ clientInfo: JSON.stringify(clientInfo) }).then(() => {\r\n\t\t\treturn clientInfo;\r\n\t\t});\r\n\t}\r\n\r\n\tgetUserState(remoteId) {\r\n\t\treturn this.getUserAttributes(remoteId).then(attributes => {\r\n\t\t\tconst clientInfo = JSON.parse(attributes.clientInfo || '');\r\n\t\t\tLogger.log('AgoraService.getUserState', clientInfo);\r\n\t\t\treturn clientInfo;\r\n\t\t});\r\n\t}\r\n\r\n\taddOrUpdateLocalUserAttributes(attributes) {\r\n\t\tLogger.log('AgoraService.addOrUpdateLocalUserAttributes', attributes);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tif (messageClient && Object.keys(attributes).length > 0) {\r\n\t\t\t\tconst promise = messageClient.addOrUpdateLocalUserAttributes(attributes);\r\n\t\t\t\tpromise.then(() => {\r\n\t\t\t\t\tLogger.log('AgoraService.addOrUpdateLocalUserAttributes', attributes);\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\tLogger.error('AgoraService.addOrUpdateLocalUserAttributes.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tLogger.error('AgoraService.addOrUpdateLocalUserAttributes.noop', attributes);\r\n\t\t\t\treject('missing rtm client or attributes');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tgetUserAttributes(userId) {\r\n\t\tLogger.log('AgoraService.getUserAttributes', userId);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tif (messageClient) {\r\n\t\t\t\tconst promise = messageClient.getUserAttributes(userId);\r\n\t\t\t\tpromise.then((attributes) => {\r\n\t\t\t\t\tLogger.log('AgoraService.getUserAttributes', attributes);\r\n\t\t\t\t\tresolve(attributes);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\tLogger.error('AgoraService.getUserAttributes.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tLogger.error('AgoraService.getUserAttributes', 'missing rtm client');\r\n\t\t\t\treject('missing rtm client');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tclearLocalUserAttributes() {\r\n\t\tLogger.log('AgoraService.clearLocalUserAttributes');\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tif (messageClient) {\r\n\t\t\t\tconst promise = messageClient.clearLocalUserAttributes();\r\n\t\t\t\tpromise.then(() => {\r\n\t\t\t\t\tLogger.log('AgoraService.clearLocalUserAttributes');\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\tLogger.error('AgoraService.clearLocalUserAttributes.error', error);\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcheckBroadcastMessage(message) {\r\n\t\t// filter for broadcast\r\n\t\t// !!! filter events here\r\n\t\tswitch (message.type) {\r\n\t\t\tcase MessageType.RequestControlDismiss:\r\n\t\t\t\tStateService.patchState({ controlling: false });\r\n\t\t\t\tif (message.controllingId === StateService.state.uid) {\r\n\t\t\t\t\tthis.unpublishScreenStream();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RequestSpyDismiss:\r\n\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.SetSnapshot:\r\n\t\t\t\t// Logger.log('AgoraService.checkBroadcastMessage.SetSnapshot', message);\r\n\t\t\t\tif (StateService.state.role === RoleType.Publisher) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t} else if (StateService.state.controlling && StateService.state.controlling !== StateService.state.uid) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RemoteSilencing:\r\n\t\t\t\t// only streamers can be silenced\r\n\t\t\t\tif (StateService.state.role === RoleType.Streamer) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.ControlInfo:\r\n\t\t\tcase MessageType.CurrentTimeMedia:\r\n\t\t\tcase MessageType.MenuToggle:\r\n\t\t\tcase MessageType.Mode:\r\n\t\t\tcase MessageType.NavInfo:\r\n\t\t\tcase MessageType.NavLink:\r\n\t\t\tcase MessageType.NavLinkClose:\r\n\t\t\tcase MessageType.NavToGrid:\r\n\t\t\tcase MessageType.NavToView:\r\n\t\t\tcase MessageType.PlayMedia:\r\n\t\t\tcase MessageType.PlayModel:\r\n\t\t\tcase MessageType.SelectItem:\r\n\t\t\tcase MessageType.ShowPanel:\r\n\t\t\tcase MessageType.SlideChange:\r\n\t\t\tcase MessageType.VREnded:\r\n\t\t\tcase MessageType.VRStarted:\r\n\t\t\tcase MessageType.VRState:\r\n\t\t\tcase MessageType.ZoomMedia:\r\n\t\t\t\tif (\r\n\t\t\t\t\t(StateService.state.controlling && StateService.state.controlling !== StateService.state.uid) ||\r\n\t\t\t\t\t(StateService.state.spying && StateService.state.spying !== StateService.state.uid)) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// send dismiss request info\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthis.broadcastMessage(message);\r\n\t\t}\r\n\t}\r\n\r\n\tbroadcastMessage(message) {\r\n\t\tMessageService.out(message);\r\n\t}\r\n\r\n\tbroadcastEvent(event) {\r\n\t\tMessageService.out({\r\n\t\t\ttype: MessageType.AgoraEvent,\r\n\t\t\tevent,\r\n\t\t});\r\n\t}\r\n\r\n\tonMessage(data, uid) {\r\n\t\t// Logger.log('AgoraService.onMessage', data.text, uid, StateService.state.uid);\r\n\t\t// discard message delivered by current state uid;\r\n\t\tif (uid !== StateService.state.uid) {\r\n\t\t\tLogger.log('AgoraService.onMessage', data.text, uid);\r\n\t\t\tconst message = JSON.parse(data.text);\r\n\t\t\tif (message.messageId && this.has(`message-${message.messageId}`)) {\r\n\t\t\t\t// !!! removed return\r\n\t\t\t\tthis.emit(`message-${message.messageId}`, message);\r\n\t\t\t}\r\n\t\t\t// discard message delivered to specific remoteId when differs from current state uid;\r\n\t\t\tif (message.remoteId && message.remoteId !== StateService.state.uid && message.remoteId !== StateService.state.screenUid) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// !!! check position !!!\r\n\t\t\tif (message.type === MessageType.VRStarted) {\r\n\t\t\t\tconst container = document.createElement('div');\r\n\t\t\t\tcontainer.classList.add('player__vr');\r\n\t\t\t\tmessage.container = container;\r\n\t\t\t}\r\n\t\t\t/*\r\n\t\t\tif (message.type === MessageType.VRStarted || message.type === MessageType.VREnded) {\r\n\t\t\t\t// Logger.log('AgoraService.onMessage', message.type, message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.checkBroadcastMessage(message);\r\n\t\t} else {\r\n\t\t\tLogger.log('AgoraService.onMessage', data.text);\r\n\t\t}\r\n\t}\r\n\r\n\tonError(error) {\r\n\t\tLogger.error('AgoraService.onError', error);\r\n\t}\r\n\r\n\tonStreamPublished(event) {\r\n\t\tLogger.log('AgoraService.onStreamPublished', event);\r\n\t\tconst clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tconst local = StreamService.local;\r\n\t\tlocal.clientInfo = clientInfo;\r\n\t\tStreamService.local = local;\r\n\t}\r\n\r\n\tonStreamUnpublished(event) {\r\n\t\t// Logger.log('AgoraService.onStreamUnpublished');\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tonStreamAdded(event) {\r\n\t\tLogger.log('AgoraService.onStreamAdded', event);\r\n\t\tconst client = this.client;\r\n\t\tconst stream = event.stream;\r\n\t\tif (!stream) {\r\n\t\t\tLogger.error('AgoraService.onStreamAdded.error', 'stream is undefined');\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tLogger.log('AgoraService.onStreamAdded', event.stream.getId());\r\n\t\tconst streamId = stream.getId();\r\n\t\t// Logger.log('AgoraService.onStreamAdded', streamId, StateService.state.uid, StateService.state.screenUid);\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\tclient.subscribe(stream, (error) => {\r\n\t\t\t\tLogger.error('AgoraService.onStreamAdded.subscribe.error', error);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamRemoved(event) {\r\n\t\tconst stream = event.stream;\r\n\t\tconst streamId = stream.getId();\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\t// !!! this happen on oculus removed timeout\r\n\t\t\t// Logger.log('AgoraService.onStreamRemoved', streamId);\r\n\t\t\tthis.remoteRemove(streamId);\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamSubscribed(event) {\r\n\t\tLogger.log('AgoraService.onStreamSubscribed', event.stream.getId());\r\n\t\tthis.remoteAdd(event.stream);\r\n\t}\r\n\r\n\tonPeerConnect(event) {\r\n\t\tLogger.log('AgoraService.onPeerConnect', event);\r\n\t\tthis.peerAdd(event);\r\n\t}\r\n\r\n\tonPeerLeaved(event) {\r\n\t\tconst remoteId = event.uid;\r\n\t\tif (remoteId !== StateService.state.uid) {\r\n\t\t\t// Logger.log('AgoraService.onPeerLeaved', event.uid);\r\n\t\t\tconst remote = this.remoteRemove(remoteId);\r\n\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t// !!! remove screenRemote?\r\n\t\t\t\tif (remote.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\tif (StateService.state.role === RoleType.SelfService) {\r\n\t\t\t\t\t\tStateService.patchState({ hosted: true, controlling: false, spying: false, silencing: false });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tStateService.patchState({ hosted: false, controlling: false, spying: false, silencing: false });\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (StateService.state.controlling === remoteId) {\r\n\t\t\t\t\t\tStateService.patchState({ controlling: false });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (StateService.state.spying === remoteId) {\r\n\t\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.peerRemove(remoteId);\r\n\t}\r\n\r\n\tpeerAdd(event) {\r\n\t\tconst peer = {\r\n\t\t\tuid: event.uid,\r\n\t\t};\r\n\t\tLogger.log('AgoraService.peerAdd', peer);\r\n\t\tconst peers = StreamService.peers;\r\n\t\tpeers.push(peer);\r\n\t\tStreamService.peers = peers;\r\n\t\tthis.broadcastEvent(new AgoraPeerEvent({ peer }));\r\n\t}\r\n\r\n\tpeerRemove(peerId) {\r\n\t\t// Logger.log('AgoraService.peerRemove', peerId);\r\n\t\tconst peers = StreamService.peers;\r\n\t\tconst peer = peers.find(x => x.uid === peerId);\r\n\t\tif (peer) {\r\n\t\t\tpeers.splice(peers.indexOf(peer), 1);\r\n\t\t\tStreamService.peers = peers;\r\n\t\t}\r\n\t}\r\n\r\n\tremoteAdd(stream) {\r\n\t\tLogger.log('AgoraService.remoteAdd', stream);\r\n\t\tStreamService.remoteAdd(stream);\r\n\t\tthis.broadcastEvent(new AgoraRemoteEvent({ stream }));\r\n\t\tconst remoteId = stream.getId();\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.getUserState(remoteId).then(clientInfo => {\r\n\t\t\t\tLogger.log('AgoraService.remoteAdd.getUserState', clientInfo);\r\n\t\t\t\tStreamService.remoteSetClientInfo(remoteId, clientInfo);\r\n\t\t\t\tif (clientInfo.cameraMuted) {\r\n\t\t\t\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: remoteId }));\r\n\t\t\t\t}\r\n\t\t\t\tif (clientInfo.audioMuted) {\r\n\t\t\t\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: remoteId }));\r\n\t\t\t\t}\r\n\t\t\t\tif (clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\tconst state = { hosted: true };\r\n\t\t\t\t\tStateService.patchState(state);\r\n\t\t\t\t\tthis.getInitialSession();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}, 100);\r\n\t}\r\n\r\n\tremoteRemove(streamId) {\r\n\t\t// Logger.log('AgoraService.remoteRemove', streamId);\r\n\t\tconst remote = StreamService.remoteRemove(streamId);\r\n\t\tif (remote && remote.clientInfo && remote.clientInfo.role === RoleType.Publisher && remote.clientInfo.screenUid !== streamId) {\r\n\t\t\tStateService.patchState({ hosted: false });\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tonMuteVideo(event) {\r\n\t\t// Logger.log('AgoraService.onMuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteVideo(event) {\r\n\t\t// Logger.log('AgoraService.onUnmuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonMuteAudio(event) {\r\n\t\t// Logger.log('AgoraService.onMuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteAudio(event) {\r\n\t\t// Logger.log('AgoraService.onUnmuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonVolumeIndicator(event) {\r\n\t\t// Logger.log('AgoraService.onVolumeIndicator', event);\r\n\t\tconst streams = event.attr.map(x => {\r\n\t\t\treturn { streamId: x.uid, level: x.level };\r\n\t\t});\r\n\t\tthis.broadcastEvent(new AgoraVolumeLevelsEvent({ streams: streams }));\r\n\t}\r\n\r\n\tonConnectionStateChange(event) {\r\n\t\tLogger.log('AgoraService.onConnectionStateChange', event);\r\n\t}\r\n\r\n\tonTokenPrivilegeWillExpire(event) {\r\n\t\tLogger.log('AgoraService.onTokenPrivilegeWillExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tLogger.log('AgoraService.onTokenPrivilegeWillExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonTokenPrivilegeDidExpire(event) {\r\n\t\tLogger.log('AgoraService.onTokenPrivilegeDidExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tLogger.log('AgoraService.onTokenPrivilegeDidExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t// screen\r\n\r\n\ttoggleScreen() {\r\n\t\tconst screen = StreamService.screen;\r\n\t\tif (screen) {\r\n\t\t\tthis.unpublishScreenStream();\r\n\t\t} else {\r\n\t\t\tif (this.screenClient) {\r\n\t\t\t\tthis.createScreenStream(StateService.state.screenUid);\r\n\t\t\t} else {\r\n\t\t\t\tthis.createScreenClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\tLogger.log('AgoraService.toggleScreen.rtcToken$', token);\r\n\t\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tcreateScreenClient(next) {\r\n\t\tif (this.screenClient) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\tconst screenClient = this.screenClient = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc, vp8\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tscreenClient.startProxyServer(3);\r\n\t\t\t\tLogger.log('AgoraService.createScreenClient.startProxyServer');\r\n\t\t\t}\r\n\t\t\tscreenClient.init(environment.appKey, () => {\r\n\t\t\t\t// Logger.log('AgoraService.createScreenClient', screenClient initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\tLogger.error('AgoraService.createScreenClient.error', error);\r\n\t\t\t\tthis.screenClient = null;\r\n\t\t\t});\r\n\t\t};\r\n\t\tclientInit();\r\n\t\tscreenClient.on('error', this.onScreenError);\r\n\t\tscreenClient.on('stream-published', this.onScreenStreamPublished);\r\n\t\tscreenClient.on('stream-unpublished', this.onScreenStreamUnpublished);\r\n\t\t// only for remotes\r\n\t\t// screenClient.on('stream-added', this.onScreenStreamAdded);\r\n\t\t// screenClient.on('stream-removed', this.onScreenStreamRemoved);\r\n\t\t// screenClient.on('stream-subscribed', this.onScreenStreamSubscribed);\r\n\t\t// screenClient.on('peer-online', this.onScreenPeerConnect);\r\n\t\t// screenClient.on('peer-leave', this.onScreenPeerLeaved);\r\n\t\t// screenClient.on('onTokenPrivilegeWillExpire', this.onScreenTokenPrivilegeWillExpire);\r\n\t\t// screenClient.on('onTokenPrivilegeDidExpire', this.onScreenTokenPrivilegeDidExpire);\r\n\t}\r\n\r\n\tscreenJoin(token, channelNameLink) {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screenClientId = AgoraService.getUniqueUserId();\r\n\t\tscreenClient.join(token, channelNameLink, screenClientId, (screenUid) => {\r\n\t\t\t// Logger.log('AgoraService.screenJoin', screenUid);\r\n\t\t\tStateService.patchState({ screenUid });\r\n\t\t\tthis.createScreenStream(screenUid);\r\n\t\t}, (error) => {\r\n\t\t\tLogger.error('AgoraService.screenJoin.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateScreenStream(screenUid) {\r\n\t\tconst options = {\r\n\t\t\tstreamID: screenUid,\r\n\t\t\taudio: false,\r\n\t\t\tvideo: false,\r\n\t\t\tscreen: true,\r\n\t\t\t// extensionId: 'minllpmhdgpndnkomcoccfekfegnlikg', // Google Chrome:\r\n\t\t\t// mediaSource:  'screen', // Firefox: 'screen', 'application', 'window' (select one)\r\n\t\t};\r\n\t\tconst stream = AgoraRTC.createStream(options);\r\n\t\tstream.setScreenProfile(environment.profiles.screen);\r\n\t\tLogger.log('AgoraService.createScreenStream', options);\r\n\t\tconst onStopScreenSharing = () => {\r\n\t\t\tthis.unpublishScreenStream();\r\n\t\t};\r\n\t\t// Initialize the stream.\r\n\t\tstream.init(() => {\r\n\t\t\tStreamService.screen = stream;\r\n\t\t\tstream.on('stopScreenSharing', onStopScreenSharing);\r\n\t\t\tstream.muteAudio();\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishScreenStream();\r\n\t\t\t}, 1);\r\n\t\t}, function(error) {\r\n\t\t\tLogger.error('AgoraService.createScreenStream.screen.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tpublishScreenStream() {\r\n\t\tLogger.log('AgoraService.publishScreenStream');\r\n\t\tthis.setUserState().then((clientInfo) => {\r\n\t\t\tconst screenClient = this.screenClient;\r\n\t\t\tconst screen = StreamService.screen;\r\n\t\t\t// publish screen stream\r\n\t\t\tscreenClient.publish(screen, (error) => {\r\n\t\t\t\tLogger.error('AgoraService.publishScreenStream.error', screen.getId(), error);\r\n\t\t\t});\r\n\t\t\tscreen.clientInfo = clientInfo;\r\n\t\t\tStreamService.screen = screen;\r\n\t\t});\r\n\t}\r\n\r\n\tunpublishScreenStream() {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screen = StreamService.screen;\r\n\t\t// Logger.log('AgoraService.unpublishScreenStream', screen, screenClient);\r\n\t\tif (screenClient && screen) {\r\n\t\t\tscreenClient.unpublish(screen, (error) => {\r\n\t\t\t\tLogger.error('AgoraService.unpublishScreenStream.error', screen.getId(), error);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\tleaveScreenClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst screenClient = this.screenClient;\r\n\t\t\tif (screenClient) {\r\n\t\t\t\tscreenClient.leave(() => {\r\n\t\t\t\t\tthis.screenClient = null;\r\n\t\t\t\t\t// Logger.log(AgoraService.leaveScreenClient');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tscreenClient.stopProxyServer();\r\n\t\t\t\t\t\tLogger.log('AgoraService.leaveScreenClient.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tLogger.error('AgoraService.leaveScreenClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonScreenError(error) {\r\n\t\tLogger.error('AgoraService.onScreenError', error);\r\n\t}\r\n\r\n\tonScreenStreamPublished(event) {\r\n\t\t// Logger.log('AgoraService.onScreenStreamPublished');\r\n\t\tconst screen = StreamService.screen;\r\n\t\tscreen.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.screen = screen;\r\n\t}\r\n\r\n\tonScreenStreamUnpublished(event) {\r\n\t\t// Logger.log('AgoraService.onScreenStreamUnpublished');\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\t// tokens\r\n\r\n\tstatic rtcToken$(channelNameLink) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtc', { channelName: channelNameLink, uid: null });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\tstatic rtmToken$(uid) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtm', { uid: uid });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\t// checks\r\n\r\n\tstatic checkRtcConnection() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\ttry {\r\n\t\t\t\tconst client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' });\r\n\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t\t}\r\n\t\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\t\tAgoraService.checkRtcTryJoin(client).then(uid => {\r\n\t\t\t\t\t\tresolve(uid);\r\n\t\t\t\t\t}).catch(error => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t\t// clear\r\n\t\t\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}, () => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} catch (error) {\r\n\t\t\t\treject(error);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtcTryJoin(client) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\tAgoraService.rtcToken$(channelName).subscribe(token => {\r\n\t\t\t\tclient.join(token.token, channelName, null, (uid) => {\r\n\t\t\t\t\t// this.createMediaStream(uid, StateService.state.devices.video, StateService.state.devices.audio);\r\n\t\t\t\t\tresolve(uid);\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\t\t\treturn AgoraService.checkRtcTryJoin(client);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tLogger.error('AgoraService.checkRtcConnection.error', error);\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}, error => reject(error));\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtmConnection(uid) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (!USE_RTM) {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t\ttry {\r\n\t\t\t\tlet client = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\t\tclient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\t\tlet channel;\r\n\t\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t\t// Logger.log('AgoraService.rtmToken$', token);\r\n\t\t\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\t\t\tclient.login({ token: token.token, uid: uid.toString() }).then(() => {\r\n\t\t\t\t\t\tchannel = client.createChannel(channelName);\r\n\t\t\t\t\t\tchannel.join().then(() => {\r\n\t\t\t\t\t\t\tresolve(uid);\r\n\t\t\t\t\t\t\tchannel.leave();\r\n\t\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t\t\t// clear\r\n\t\t\t\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\t\t\t\tchannel = null;\r\n\t\t\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t\t\t}).catch(() => { });\r\n\t\t\t\t\t\t\t}).catch(() => { });\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tLogger.error('checkRtmConnection.error', error);\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t\t// clear\r\n\t\t\t\t\t\tif (client) {\r\n\t\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t\t}).catch(() => { });\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}, error => reject(error));\r\n\t\t\t} catch (error) {\r\n\t\t\t\treject(error);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tstatic getDevices() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tlet devices_ = AgoraService.devices_;\r\n\t\t\tif (devices_) {\r\n\t\t\t\tresolve(devices_);\r\n\t\t\t} else {\r\n\t\t\t\tdevices_ = AgoraService.devices_ = [];\r\n\t\t\t\tconst constraints = {\r\n\t\t\t\t\taudio: true,\r\n\t\t\t\t\tvideo: true,\r\n\t\t\t\t};\r\n\t\t\t\tif (DeviceService.platform === DevicePlatform.IOS) {\r\n\t\t\t\t\tconstraints.video = { facingMode: 'user' };\r\n\t\t\t\t}\r\n\t\t\t\tif (DeviceService.platform === DevicePlatform.VRHeadset) {\r\n\t\t\t\t\tconstraints.video = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia(constraints).then((stream) => {\r\n\t\t\t\t\t\tnavigator.mediaDevices.enumerateDevices().then((devices) => {\r\n\t\t\t\t\t\t\tstream.getTracks().forEach((track) => {\r\n\t\t\t\t\t\t\t\ttrack.stop();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tdevices.forEach((device) => {\r\n\t\t\t\t\t\t\t\tdevices_.push(device);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tresolve(devices_);\r\n\t\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\treject('Media device not available');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tstatic fixLegacy() {\r\n\t\tconst prefixes = ['moz', 'webkit'];\r\n\t\tprefixes.forEach(prefix => {\r\n\t\t\tLogger.log('AgoraService.fixLegacy', `${prefix}RTC`);\r\n\t\t\tObject.getOwnPropertyNames(window).filter(key => key.indexOf('RTC') === 0).map(key => {\r\n\t\t\t\tconst legacyKey = `${prefix}${key}`;\r\n\t\t\t\tif (typeof window[key] !== 'undefined' && typeof window[legacyKey] === 'undefined') {\r\n\t\t\t\t\twindow[legacyKey] = window[key];\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\tonce(type, callback) {\r\n\t\tconst once = (data) => {\r\n\t\t\tcallback(data);\r\n\t\t\tthis.off(type, once);\r\n\t\t};\r\n\t\tthis.on(type, once);\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\thas(type) {\r\n\t\tconst callbacks = this.events[type];\r\n\t\treturn callbacks && callbacks.length;\r\n\t}\r\n\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { MessageService } from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\nimport { MessageType } from './agora.types';\r\n\r\nconst USE_RANDOM_MESSAGE = false;\r\nconst USE_GROUPED_MESSAGE = true;\r\n\r\nexport class ChatMessage {\r\n\r\n\tconstructor(message, clientId, name) {\r\n\t\tthis.type = MessageType.ChatMessage;\r\n\t\tthis.clientId_ = clientId;\r\n\t\tif (typeof message === 'string') {\r\n\t\t\tthis.date = Date.now();\r\n\t\t\tthis.clientId = clientId;\r\n\t\t\tthis.name = name;\r\n\t\t\tthis.message = message;\r\n\t\t} else if (typeof message === 'object') {\r\n\t\t\tthis.date = message.date;\r\n\t\t\tthis.clientId = message.clientId;\r\n\t\t\tthis.name = message.name;\r\n\t\t\tthis.message = message.message;\r\n\t\t}\r\n\t\tconst names = this.name.split(' ');\r\n\t\tthis.shortName = names[0].substr(0, 1).toUpperCase() + (names.length > 1 ? names[1] : names[0]).substr(0, 1).toUpperCase();\r\n\t}\r\n\r\n\tget me() {\r\n\t\treturn this.clientId === this.clientId_;\r\n\t}\r\n\r\n\tgetPayload() {\r\n\t\treturn {\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t};\r\n\t}\r\n\r\n\tgetCopy() {\r\n\t\treturn new ChatMessage({\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t}, this.clientId_);\r\n\t}\r\n}\r\nexport default class AgoraChatComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.rows = 1;\r\n\t\tthis.showEmoji = false;\r\n\t\tthis.demo = window.location.pathname.indexOf('layout') !== -1;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tmessage: null,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraChatComponent.changes$', form.value);\r\n\t\t\tthis.checkTypings(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraChatComponent.state', state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraChatComponent.MessageService', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tthis.pushMessage(new ChatMessage(message, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\tthis.typingBegin(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\tthis.typingEnd(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.messages = [];\r\n\t\tthis.groupedMessages = [];\r\n\t\tif (this.demo) {\r\n\t\t\t// !!! only for demo\r\n\t\t\tconst messages = AgoraChatComponent.getFakeList().map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\tthis.updateMessages(messages.slice(0, 5));\r\n\t\t\tMessageService.in$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe(message => {\r\n\t\t\t\tmessage.clientId = message.clientId || StateService.state.uid;\r\n\t\t\t\t// console.log('AgoraChatComponent.MessageService.in$', message);\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tif (USE_RANDOM_MESSAGE) {\r\n\t\t\t\tAgoraChatComponent.randomMessage(this, messages);\r\n\t\t\t}\r\n\t\t\t// !!! only for demo\r\n\t\t} else {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.getChannelMessages().pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(messages => {\r\n\t\t\t\t\tmessages = messages.map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\t// console.log('AgoraChatComponent.getChannelAttributes.messages', messages);\r\n\t\t\t\t\tthis.updateMessages(messages);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonView() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tif (AgoraChatComponent.to) {\r\n\t\t\tclearTimeout(AgoraChatComponent.to);\r\n\t\t\tAgoraChatComponent.to = null;\r\n\t\t}\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tconst secureMessage = this.secureText(this.form.value.message);\r\n\t\t// console.log('secureMessage', secureMessage);\r\n\t\tconst message = this.createMessage(secureMessage);\r\n\t\tthis.sendMessage(message);\r\n\t\tthis.form.get('message').value = null;\r\n\t\tif (this.demo && USE_RANDOM_MESSAGE) {\r\n\t\t\tthis.randomMessage();\r\n\t\t}\r\n\t}\r\n\r\n\tonKeyDown(event) {\r\n\t\t// console.log('onKeyDown', event);\r\n\t\tif (event.key === 'Enter') {\r\n\t\t\tif (event.shiftKey) {\r\n\t\t\t\tthis.rows = Math.min(4, this.rows + 1);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t} else {\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\tthis.onSubmit();\r\n\t\t\t\tthis.rows = 1;\r\n\t\t\t}\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst textareaNode = node.querySelector('textarea');\r\n\t\t\ttextareaNode.setAttribute('rows', this.rows);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggleEmoji() {\r\n\t\tthis.showEmoji = !this.showEmoji;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSelectEmoji(emoji) {\r\n\t\tthis.showEmoji = false;\r\n\t\tthis.form.get('message').value = (this.form.get('message').value || '') + emoji.char;\r\n\t\t// this.pushChanges();\r\n\t}\r\n\r\n\tsecureText(unsecureText) {\r\n\t\tlet newDocument = new DOMParser().parseFromString(unsecureText, 'text/html');\r\n\t\treturn newDocument.body.textContent || '';\r\n\t}\r\n\r\n\tcreateMessage(text) {\r\n\t\tconst message = new ChatMessage(text, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\tthis.pushMessage(message);\r\n\t\tconst agora = this.agora;\r\n\t\tif (agora) {\r\n\t\t\tagora.addOrUpdateChannelMessages([message.getPayload()]);\r\n\t\t}\r\n\t\tMessageService.send(message);\r\n\t}\r\n\r\n\tonClose(event) {\r\n\t\tthis.close.next();\r\n\t}\r\n\r\n\tscrollToBottom() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst scrollView = node.querySelector('.group--scrollview');\r\n\t\tscrollView.scrollTop = scrollView.scrollHeight;\r\n\t}\r\n\r\n\tpushMessage(message) {\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, this.messages);\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingBegin(message) {\r\n\t\t// console.log('AgoraChatComponent.typingBegin', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingEnd(message) {\r\n\t\t// console.log('AgoraChatComponent.typingEnd', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, messages);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\tremoveTyping(message, messages, recursive = true) {\r\n\t\tconst index = messages.reduce((p, c, i) => {\r\n\t\t\treturn (c.type === message.type && c.clientId === message.clientId) ? i : p;\r\n\t\t}, -1);\r\n\t\tif (index !== -1) {\r\n\t\t\tmessages.splice(index, 1);\r\n\t\t\tif (recursive === true) {\r\n\t\t\t\tthis.removeTyping(message, messages, true);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn index;\r\n\t}\r\n\r\n\ttypings_ = false;\r\n\tcheckTypings(changes) {\r\n\t\tconst typings = (changes.message && changes.message.length > 0) || false;\r\n\t\t// console.log('AgoraChatComponent.checkTypings', typings, this.typings_);\r\n\t\tif (this.typings_ !== typings) {\r\n\t\t\tthis.typings_ = typings;\r\n\t\t\tif (typings) {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingBegin });\r\n\t\t\t} else {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingEnd });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tupdateMessages(messages) {\r\n\t\tthis.messages = messages;\r\n\t\tif (USE_GROUPED_MESSAGE) {\r\n\t\t\tthis.groupedMessages = [];\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t\tconst groupedMessages = [];\r\n\t\tmessages.forEach(message => {\r\n\t\t\tif (message.type === MessageType.ChatMessage) {\r\n\t\t\t\t// ChatMessage\r\n\t\t\t\tconst lastMessage = groupedMessages.length ? groupedMessages[groupedMessages.length - 1] : null;\r\n\t\t\t\tif (lastMessage && lastMessage.clientId === message.clientId) {\r\n\t\t\t\t\tlastMessage.message += `<p>${message.message}</p>`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tgroupedMessages.push(message.getCopy());\r\n\t\t\t\t}\r\n\t\t\t} else if (message.type === MessageType.ChatTypingBegin) {\r\n\t\t\t\t// ChatTypingBegin\r\n\t\t\t\tconst lastMessage = groupedMessages.reduce((p, c, i) => {\r\n\t\t\t\t\treturn (c.clientId === message.clientId) ? c : p;\r\n\t\t\t\t}, null);\r\n\t\t\t\tif (lastMessage) {\r\n\t\t\t\t\tlastMessage.typing = true;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('MessageType.ChatTypingBegin', lastMessage, message);\r\n\t\t\t}\r\n\t\t});\r\n\t\t// setTimeout(() => {\r\n\t\tthis.groupedMessages = groupedMessages;\r\n\t\tthis.pushChanges();\r\n\t\t// console.log('AgoraChatComponent.updateMessages', messages, groupedMessages);\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.scrollToBottom();\r\n\t\t}, 1);\r\n\t\t// }, 1);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid && this.form.value.message && this.form.value.message.length > 0;\r\n\t}\r\n\r\n\t// demo\r\n\r\n\trandomMessage() {\r\n\t\tif (AgoraChatComponent.to) {\r\n\t\t\tclearTimeout(AgoraChatComponent.to);\r\n\t\t\tAgoraChatComponent.to = null;\r\n\t\t}\r\n\t\tAgoraChatComponent.to = setTimeout(() => {\r\n\t\t\tconst message = AgoraChatComponent.createRandomMessage();\r\n\t\t\tthis.sendMessage(message);\r\n\t\t}, (2 + Math.random() * 6) * 1000);\r\n\t}\r\n\r\n}\r\nAgoraChatComponent.meta = {\r\n\tselector: '[agora-chat]',\r\n\toutputs: ['close'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--scrollview\" [class]=\"'rows--' + rows\">\r\n\t\t\t<div class=\"group--virtual\" *virtual=\"let item of groupedMessages\" [mode]=\"4\" [width]=\"350\" [gutter]=\"0\" [reverse]=\"true\">\r\n\t\t\t\t<!-- serve un nodo figlio -->\r\n\t\t\t\t<div class=\"listing__item message\" [class]=\"{ me: item.me, typing: item.typing }\">\r\n\t\t\t\t\t<div class=\"message__avatar\" [title]=\"item.name\"><span [innerHTML]=\"item.shortName\"></span></div>\r\n\t\t\t\t\t<div class=\"message__content\">\r\n\t\t\t\t\t\t<div [innerHTML]=\"item.message | message\"></div>\r\n\t\t\t\t\t\t<div class=\"typing-indicator\">\r\n\t\t\t\t\t\t\t<span></span>\r\n\t\t\t\t\t\t\t<span></span>\r\n\t\t\t\t\t\t\t<span></span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div class=\"group--message\" [class]=\"'rows--' + rows\">\r\n\t\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onSubmit($event)\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t<div class=\"group--form group--form--addon\" [class]=\"{ required: controls.message.validators.length, 'addon': controls.message.valid }\">\r\n\t\t\t\t\t<!-- <input type=\"text\" class=\"control--text\" [formControl]=\"controls.message\" [placeholder]=\"'bhere_write_a_message' | label\" /> -->\r\n\t\t\t\t\t<button type=\"button\" class=\"control--pre\" (click)=\"onToggleEmoji()\">\r\n\t\t\t\t\t\t<svg class=\"emoji\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#emoji\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<textarea class=\"control--text\" [formControl]=\"controls.message\" [placeholder]=\"'bhere_write_a_message' | label\" rows=\"1\" (keydown)=\"onKeyDown($event)\"></textarea>\r\n\t\t\t\t\t<button type=\"submit\" class=\"control--addon\">\r\n\t\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#send\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</form>\r\n\t\t</div>\r\n\t\t<div class=\"group--close\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" [title]=\"'title_close' | label\" (click)=\"onClose($event)\">\r\n\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"group--emoji\" [class]=\"'rows--' + rows\" agora-chat-emoji (emoji)=\"onSelectEmoji($event)\" (close)=\"onToggleEmoji()\" *if=\"showEmoji\">\r\n\t\t\t<div class=\"group--virtual\" *virtual=\"let item of items\" [mode]=\"1\" [width]=\"40\" [gutter]=\"10\" [reverse]=\"true\">\r\n\t\t\t\t<!-- serve un nodo figlio -->\r\n\t\t\t\t<div class=\"listing__item emoji\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--emoji\" (click)=\"onSelect(item)\"><span [innerHTML]=\"item.char\"></span></button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--close\">\r\n\t\t\t\t<button type=\"button\" class=\"btn--close\" [title]=\"'title_close' | label\" (click)=\"onClose($event)\">\r\n\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nAgoraChatComponent.getFakeList = () => {\r\n\tlet messages = [\r\n\t\t{\r\n\t\t\t'date': 1614592230000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Function-based web-enabled benchmark',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592240000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Customizable exuding superstructure',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592250000,\r\n\t\t\t'name': 'Gilles Pitkins',\r\n\t\t\t'message': 'Synergistic interactive archive',\r\n\t\t\t'clientId': 'cfe9ff5b-f7da-449d-bf5a-3184b5eba6ea',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592260000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Digitized client-server initiative',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592270000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Quality-focused tertiary open system',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592280000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Exclusive uniform middleware',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592290000,\r\n\t\t\t'name': 'John Pruckner',\r\n\t\t\t'message': 'Decentralized disintermediate extranet',\r\n\t\t\t'clientId': 'ae51e846-d043-41e9-bb5c-3189181e5b43',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592300000,\r\n\t\t\t'name': 'Lamont Georgievski',\r\n\t\t\t'message': 'Enhanced static approach',\r\n\t\t\t'clientId': '1961cd9e-93aa-4bd0-b96a-89fcbd36b257',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592310000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Ergonomic clear-thinking info-mediaries',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592320000,\r\n\t\t\t'name': 'Jeri Pedroni',\r\n\t\t\t'message': 'Grass-roots dynamic encryption',\r\n\t\t\t'clientId': '13d69bba-3656-449b-8fe3-d7a87062b044',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592330000,\r\n\t\t\t'name': 'Frederik Dechelle',\r\n\t\t\t'message': 'Compatible disintermediate policy',\r\n\t\t\t'clientId': '9151ebe0-efa8-40b4-a341-b8fd489e9c88',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592340000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Inverse user-facing adapter',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592350000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Future-proofed even-keeled application',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592360000,\r\n\t\t\t'name': 'Cassie Jonathon',\r\n\t\t\t'message': 'Profit-focused content-based budgetary management',\r\n\t\t\t'clientId': '5b3dc6f3-2a3d-493d-aac5-66ddfce2d709',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592370000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Managed intermediate monitoring',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592380000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Exclusive client-server encoding',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592390000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Cross-group system-worthy matrices',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592400000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Upgradable encompassing benchmark',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592410000,\r\n\t\t\t'name': 'Emelen Beevors',\r\n\t\t\t'message': 'Function-based full-range knowledge base',\r\n\t\t\t'clientId': 'c93aea47-ebd8-4e5e-88fd-52053dd35cd1',\r\n\t\t},\r\n\t\t{\r\n\t\t\t'date': 1614592420000,\r\n\t\t\t'name': 'Jhon Appleseed',\r\n\t\t\t'message': 'Synergistic system-worthy capability',\r\n\t\t\t'clientId': '7341614597544882',\r\n\t\t},\r\n\t];\r\n\twhile (messages.length < 100) {\r\n\t\tmessages = messages.concat(messages);\r\n\t}\r\n\treturn messages;\r\n\t// return messages.slice(0, 5);\r\n};\r\n\r\nAgoraChatComponent.createRandomMessage = (text) => {\r\n\tconst message = new ChatMessage({\r\n\t\tdate: Date.now(),\r\n\t\tclientId: '9fe0e1b9-6a6b-418b-b916-4bbff3eeb123',\r\n\t\tname: 'Herman frederick',\r\n\t\tmessage: 'Lorem ipsum dolor',\r\n\t}, StateService.state.uid, StateService.state.name);\r\n\treturn message;\r\n};\r\n\r\nAgoraChatComponent.randomMessage = (instance, messages) => {\r\n\tconst getRandomMessage = function() {\r\n\t\tconst others = messages.filter(x => x.id !== '7341614597544882');\r\n\t\tlet message = others[Math.floor(others.length * Math.random())];\r\n\t\tmessage = new ChatMessage({\r\n\t\t\tdate: Date.now(),\r\n\t\t\tclientId: '9fe0e1b9-6a6b-418b-b916-4bbff3eeb123',\r\n\t\t\tname: message.name,\r\n\t\t\tmessage: message.message,\r\n\t\t}, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t};\r\n\tif (AgoraChatComponent.to) {\r\n\t\tclearTimeout(AgoraChatComponent.to);\r\n\t\tAgoraChatComponent.to = null;\r\n\t}\r\n\tAgoraChatComponent.to = setTimeout(() => {\r\n\t\tconst message = getRandomMessage();\r\n\t\tinstance.sendMessage(message);\r\n\t\tAgoraChatComponent.randomMessage(instance, messages);\r\n\t}, (2 + Math.random() * 6) * 1000);\r\n};\r\n","import { Component } from 'rxcomp';\r\n\r\nexport default class AgoraCheckComponent extends Component {}\r\n\r\nAgoraCheckComponent.meta = {\r\n\tselector: '[agora-check]',\r\n\tinputs: ['value'],\r\n\ttemplate: /* html */ `\r\n\t\t<svg *if=\"value == null\" class=\"checkmark idle\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === true\" class=\"checkmark success\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" fill=\"none\" d=\"M14.1 27.2l7.1 7.2 16.7-16.8\" stroke-linecap=\"round\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === false\" class=\"checkmark error\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" stroke-linecap=\"round\" fill=\"none\" d=\"M16 16 36 36 M36 16 16 36\"/>\r\n\t\t</svg>\r\n\t`\r\n};\r\n","import { from, of, Subject } from 'rxjs';\r\nimport { map, switchMap, tap } from 'rxjs/operators';\r\n\r\nexport class ModalEvent {\r\n\r\n\tconstructor(data) {\r\n\t\tthis.data = data;\r\n\t}\r\n\r\n}\r\n\r\nexport class ModalResolveEvent extends ModalEvent { }\r\nexport class ModalRejectEvent extends ModalEvent { }\r\n\r\nexport class ModalService {\r\n\r\n\tstatic get hasModal() {\r\n\t\treturn this.hasModal_;\r\n\t}\r\n\tstatic set hasModal(hasModal) {\r\n\t\tif (this.hasModal_ !== hasModal) {\r\n\t\t\tthis.hasModal_ = hasModal;\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\thasModal ? body.classList.add('modal-open') : body.classList.remove('modal-open');\r\n\t\t}\r\n\t}\r\n\r\n\tstatic open$(modal) {\r\n\t\tthis.busy$.next(true);\r\n\t\treturn (\r\n\t\t\tmodal.iframe ? of(/* html */`<div class=\"iframe-modal\" iframe-modal src=\"${modal.iframe}\"></div>`) : this.getTemplate$(modal)\r\n\t\t).pipe(\r\n\t\t\t// startWith(new ModalLoadEvent(Object.assign({}, modal.data, { $src: modal.src }))),\r\n\t\t\tmap(template => {\r\n\t\t\t\treturn { node: this.getNode(template), data: modal.data, modal: modal };\r\n\t\t\t}),\r\n\t\t\ttap(node => {\r\n\t\t\t\tthis.modal$.next(node);\r\n\t\t\t\tthis.hasModal = true;\r\n\t\t\t\tthis.busy$.next(false);\r\n\t\t\t\t// this.events$.next(new ModalLoadedEvent(Object.assign({}, modal.data, { $src: modal.src })));\r\n\t\t\t}),\r\n\t\t\tswitchMap(node => this.events$),\r\n\t\t\ttap(_ => this.hasModal = false)\r\n\t\t)\r\n\t}\r\n\r\n\tstatic getTemplate$(modal) {\r\n\t\tif (modal.src) {\r\n\t\t\treturn from(fetch(modal.src).then(response => {\r\n\t\t\t\treturn response.text();\r\n\t\t\t}));\r\n\t\t} else if (modal.template) {\r\n\t\t\treturn of(modal.template);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getNode(template) {\r\n\t\tconst div = document.createElement('div');\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tstatic reject(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalRejectEvent(data));\r\n\t}\r\n\r\n\tstatic resolve(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalResolveEvent(data));\r\n\t}\r\n\r\n}\r\n\r\nModalService.modal$ = new Subject();\r\nModalService.events$ = new Subject();\r\nModalService.busy$ = new Subject();\r\n","export class LocalStorageService {\r\n\r\n\tstatic delete(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\twindow.localStorage.removeItem(name);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic exist(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\treturn window.localStorage[name] !== undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get(name) {\r\n\t\tlet value = null;\r\n\t\tif (this.isLocalStorageSupported() && window.localStorage[name] !== undefined) {\r\n\t\t\ttry {\r\n\t\t\t\tvalue = JSON.parse(window.localStorage[name]);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.get.error parsing', name, e);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic set(name, value) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\ttry {\r\n\t\t\t\tconst cache = [];\r\n\t\t\t\tconst json = JSON.stringify(value, function(key, value) {\r\n\t\t\t\t\tif (typeof value === 'object' && value !== null) {\r\n\t\t\t\t\t\tif (cache.indexOf(value) !== -1) {\r\n\t\t\t\t\t\t\t// Circular reference found, discard key\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcache.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value;\r\n\t\t\t\t});\r\n\t\t\t\twindow.localStorage.setItem(name, json);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.set.error serializing', name, value, e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic isLocalStorageSupported() {\r\n\t\tif (this.supported) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tlet supported = false;\r\n\t\ttry {\r\n\t\t\tsupported = 'localStorage' in window && window.localStorage !== null;\r\n\t\t\tif (supported) {\r\n\t\t\t\twindow.localStorage.setItem('test', '1');\r\n\t\t\t\twindow.localStorage.removeItem('test');\r\n\t\t\t} else {\r\n\t\t\t\tsupported = false;\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tsupported = false;\r\n\t\t}\r\n\t\tthis.supported = supported;\r\n\t\treturn supported;\r\n\t}\r\n}\r\n","import { from, merge, of, Subject, throwError } from 'rxjs';\r\nimport { catchError, delay, first, map, switchMap, tap } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { LabelPipe } from '../label/label.pipe';\r\nimport StateService from '../state/state.service';\r\nimport { LocalStorageService } from '../storage/local-storage.service';\r\nimport { RoleType } from '../user/user';\r\nimport AgoraService from './agora.service';\r\n\r\nconst TIMEOUT = 100;\r\nconst FORCE_ERROR = false;\r\n\r\nexport class AgoraChecklistService {\r\n\r\n\tstatic checklist$() {\r\n\t\treturn StateService.state$.pipe(\r\n\t\t\tfirst(),\r\n\t\t\tmap(state => {\r\n\t\t\t\tconst event = {\r\n\t\t\t\t\tshouldCheckAudio: true,\r\n\t\t\t\t\tshouldCheckVideo: true,\r\n\t\t\t\t\tkey: 'checklist_audio_video',\r\n\t\t\t\t\tuid: null,\r\n\t\t\t\t\tchecklist: {\r\n\t\t\t\t\t\tbrowser: null,\r\n\t\t\t\t\t\thttps: null,\r\n\t\t\t\t\t\tvideo: null,\r\n\t\t\t\t\t\taudio: null,\r\n\t\t\t\t\t\trtc: null,\r\n\t\t\t\t\t\trtm: null,\r\n\t\t\t\t\t},\r\n\t\t\t\t\terrors: {},\r\n\t\t\t\t};\r\n\t\t\t\tif (state.role === RoleType.Viewer) {\r\n\t\t\t\t\tevent.shouldCheckAudio = false;\r\n\t\t\t\t\tevent.shouldCheckVideo = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (DeviceService.platform === DevicePlatform.VRHeadset) {\r\n\t\t\t\t\tevent.shouldCheckAudio = true;\r\n\t\t\t\t\tevent.shouldCheckVideo = false;\r\n\t\t\t\t}\r\n\t\t\t\tevent.key = `checklist${event.shouldCheckAudio ? '_audio' : ''}${event.shouldCheckVideo ? '_video' : ''}`;\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst checklist = LocalStorageService.get(event.key);\r\n\t\t\t\tif (checklist === true) {\r\n\t\t\t\t\tObject.keys(event.checklist).forEach(key => {\r\n\t\t\t\t\t\tevent.checklist[key] = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn of(event);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic isChecked(event) {\r\n\t\tconst isChecked = Object.keys(event.checklist).reduce((p, c, i) => {\r\n\t\t\tconst checked = p && event.checklist[c];\r\n\t\t\tswitch (c) {\r\n\t\t\t\tcase 'audio':\r\n\t\t\t\t\treturn checked || !event.shouldCheckAudio;\r\n\t\t\t\tcase 'video':\r\n\t\t\t\t\treturn checked || !event.shouldCheckVideo;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\treturn checked;\r\n\t\t\t}\r\n\t\t}, true);\r\n\t\treturn isChecked;\r\n\t}\r\n\r\n\tstatic isChecked$() {\r\n\t\treturn this.checklist$().pipe(\r\n\t\t\tmap(event => this.isChecked(event)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic checkEvent$() {\r\n\t\treturn this.checklist$().pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst checklist = Object.keys(event.checklist).reduce((p, c, i) => {\r\n\t\t\t\t\treturn p && event.checklist[c];\r\n\t\t\t\t}, true);\r\n\t\t\t\tif (checklist === true) {\r\n\t\t\t\t\treturn of(event);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tLocalStorageService.set(event.key, false);\r\n\t\t\t\t\tconst event$ = new Subject();\r\n\t\t\t\t\tconst check$ = of(event).pipe(\r\n\t\t\t\t\t\tdelay(1000),\r\n\t\t\t\t\t\tswitchMap(event => {\r\n\t\t\t\t\t\t\tevent$.next(event);\r\n\t\t\t\t\t\t\treturn this.checkBrowserEvent$(event);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tswitchMap(event => {\r\n\t\t\t\t\t\t\tevent$.next(event);\r\n\t\t\t\t\t\t\treturn this.checkHttpsEvent$(event);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tswitchMap(event => {\r\n\t\t\t\t\t\t\tevent$.next(event);\r\n\t\t\t\t\t\t\treturn this.checkAudioEvent$(event);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tswitchMap(event => {\r\n\t\t\t\t\t\t\tevent$.next(event);\r\n\t\t\t\t\t\t\treturn this.checkVideoEvent$(event);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tswitchMap(event => {\r\n\t\t\t\t\t\t\tevent$.next(event);\r\n\t\t\t\t\t\t\treturn this.checkRtcEvent$(event);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tswitchMap(event => {\r\n\t\t\t\t\t\t\tevent$.next(event);\r\n\t\t\t\t\t\t\treturn this.checkRtmEvent$(event);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\ttap(event => {\r\n\t\t\t\t\t\t\t// console.log('AgoraChecklistService', event);\r\n\t\t\t\t\t\t\tLocalStorageService.set(event.key, true);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t);\r\n\t\t\t\t\treturn merge(event$, check$);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic check$() {\r\n\t\treturn this.checklist$().pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst checklist = Object.keys(event.checklist).reduce((p, c, i) => {\r\n\t\t\t\t\treturn p && event.checklist[c];\r\n\t\t\t\t}, true);\r\n\t\t\t\tif (checklist === true) {\r\n\t\t\t\t\treturn of(event);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tLocalStorageService.set(event.key, false);\r\n\t\t\t\t\treturn of(event).pipe(\r\n\t\t\t\t\t\tdelay(1000),\r\n\t\t\t\t\t\tswitchMap(event => this.checkBrowserEvent$(event)),\r\n\t\t\t\t\t\tswitchMap(event => this.checkHttpsEvent$(event)),\r\n\t\t\t\t\t\tswitchMap(event => this.checkAudioEvent$(event)),\r\n\t\t\t\t\t\tswitchMap(event => this.checkVideoEvent$(event)),\r\n\t\t\t\t\t\tswitchMap(event => this.checkRtcEvent$(event)),\r\n\t\t\t\t\t\tswitchMap(event => this.checkRtmEvent$(event)),\r\n\t\t\t\t\t\ttap(event => {\r\n\t\t\t\t\t\t\t// console.log('AgoraChecklistService', event);\r\n\t\t\t\t\t\t\tLocalStorageService.set(event.key, true);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t)\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic checkBrowser$() {\r\n\t\tif (FORCE_ERROR) {\r\n\t\t\treturn of(false);\r\n\t\t}\r\n\t\tconst browser = AgoraRTC.checkSystemRequirements();\r\n\t\treturn of(browser);\r\n\t}\r\n\r\n\tstatic checkBrowserEvent$(event) {\r\n\t\treturn this.checkBrowser$().pipe(\r\n\t\t\tswitchMap(browser => {\r\n\t\t\t\tevent.checklist.browser = browser;\r\n\t\t\t\tif (browser) {\r\n\t\t\t\t\treturn of(event).pipe(delay(TIMEOUT));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tevent.errors.browser = LabelPipe.transform('bhere_browser_error');\r\n\t\t\t\t\treturn this.checkHttpsEvent$(event).pipe(\r\n\t\t\t\t\t\tswitchMap(event => {\r\n\t\t\t\t\t\t\tif (FORCE_ERROR) {\r\n\t\t\t\t\t\t\t\treturn of(event);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\tconsole.log('checkBrowserEvent$.error', error);\r\n\t\t\t\tevent.checklist.browser = false;\r\n\t\t\t\tevent.errors.browser = LabelPipe.transform('bhere_browser_error');\r\n\t\t\t\treturn throwError(event);\r\n\t\t\t}),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic checkHttps$() {\r\n\t\tif (FORCE_ERROR) {\r\n\t\t\treturn of(false);\r\n\t\t}\r\n\t\tconst https = window.location.protocol === 'https:';\r\n\t\treturn of(https);\r\n\t}\r\n\r\n\tstatic checkHttpsEvent$(event) {\r\n\t\treturn this.checkHttps$().pipe(\r\n\t\t\tswitchMap(https => {\r\n\t\t\t\tevent.checklist.https = https;\r\n\t\t\t\tif (https) {\r\n\t\t\t\t\treturn of(event).pipe(delay(TIMEOUT));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tevent.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\t\t\tif (FORCE_ERROR) {\r\n\t\t\t\t\t\treturn of(event);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\tconsole.log('checkHttpsEvent$.error', error);\r\n\t\t\t\tevent.checklist.https = false;\r\n\t\t\t\tevent.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\t\treturn throwError(event);\r\n\t\t\t}),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic checkAudio$() {\r\n\t\tif (FORCE_ERROR) {\r\n\t\t\treturn of(false);\r\n\t\t}\r\n\t\treturn from(AgoraService.getDevices()).pipe(\r\n\t\t\tmap(devices => {\r\n\t\t\t\tconst audioinput = devices.find(x => x.kind === 'audioinput' && x.deviceId);\r\n\t\t\t\treturn audioinput != null;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic checkAudioEvent$(event) {\r\n\t\t// console.log('checkAudioEvent$', event);\r\n\t\tif (event.shouldCheckAudio) {\r\n\t\t\treturn this.checkAudio$().pipe(\r\n\t\t\t\tswitchMap(audio => {\r\n\t\t\t\t\tevent.checklist.audio = audio;\r\n\t\t\t\t\tif (audio) {\r\n\t\t\t\t\t\treturn of(event).pipe(delay(TIMEOUT));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tevent.errors.audio = LabelPipe.transform('bhere_audio_error');\r\n\t\t\t\t\t\t// console.log('checkAudioEvent$.error', event);\r\n\t\t\t\t\t\tif (FORCE_ERROR) {\r\n\t\t\t\t\t\t\treturn of(event);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tcatchError(error => {\r\n\t\t\t\t\tconsole.log('checkAudioEvent$.error', error);\r\n\t\t\t\t\tevent.checklist.audio = false;\r\n\t\t\t\t\tevent.errors.audio = LabelPipe.transform('bhere_audio_error');\r\n\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t}),\r\n\t\t\t)\r\n\t\t} else {\r\n\t\t\treturn of(event);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic checkVideo$() {\r\n\t\tif (FORCE_ERROR) {\r\n\t\t\treturn of(false);\r\n\t\t}\r\n\t\treturn from(AgoraService.getDevices()).pipe(\r\n\t\t\tmap(devices => {\r\n\t\t\t\tconst videoinput = devices.find(x => x.kind === 'videoinput' && x.deviceId);\r\n\t\t\t\treturn videoinput != null;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic checkVideoEvent$(event) {\r\n\t\tif (event.shouldCheckVideo) {\r\n\t\t\treturn this.checkVideo$().pipe(\r\n\t\t\t\tswitchMap(video => {\r\n\t\t\t\t\tevent.checklist.video = video;\r\n\t\t\t\t\tif (video) {\r\n\t\t\t\t\t\treturn of(event).pipe(delay(TIMEOUT));\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tevent.errors.video = LabelPipe.transform('bhere_video_error');\r\n\t\t\t\t\t\tif (FORCE_ERROR) {\r\n\t\t\t\t\t\t\treturn of(event);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tcatchError(error => {\r\n\t\t\t\t\tconsole.log('checkVideoEvent$.error', error);\r\n\t\t\t\t\tevent.checklist.video = false;\r\n\t\t\t\t\tevent.errors.video = LabelPipe.transform('bhere_video_error');\r\n\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(event);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic checkRtc$() {\r\n\t\tif (FORCE_ERROR) {\r\n\t\t\treturn of(false);\r\n\t\t}\r\n\t\treturn from(AgoraService.checkRtcConnection());\r\n\t}\r\n\r\n\tstatic checkRtcEvent$(event) {\r\n\t\treturn this.checkRtc$().pipe(\r\n\t\t\tswitchMap(uid => {\r\n\t\t\t\tevent.uid = uid;\r\n\t\t\t\tevent.checklist.rtc = uid !== false;\r\n\t\t\t\tif (uid) {\r\n\t\t\t\t\treturn of(event).pipe(delay(TIMEOUT));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tevent.errors.rtc = LabelPipe.transform('bhere_rtc_error');\r\n\t\t\t\t\tif (FORCE_ERROR) {\r\n\t\t\t\t\t\treturn of(event);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\tconsole.log('checkRtcEvent$.error', error);\r\n\t\t\t\tevent.checklist.rtc = false;\r\n\t\t\t\tevent.errors.rtc = LabelPipe.transform('bhere_rtc_error');\r\n\t\t\t\treturn throwError(event);\r\n\t\t\t}),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic checkRtm$(uid) {\r\n\t\tif (FORCE_ERROR) {\r\n\t\t\treturn of(false);\r\n\t\t}\r\n\t\treturn from(AgoraService.checkRtmConnection(uid));\r\n\t}\r\n\r\n\tstatic checkRtmEvent$(event) {\r\n\t\treturn this.checkRtm$(event.uid).pipe(\r\n\t\t\tswitchMap(uid => {\r\n\t\t\t\tevent.checklist.rtm = uid !== false;\r\n\t\t\t\tif (uid) {\r\n\t\t\t\t\treturn of(event);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tevent.errors.rtm = LabelPipe.transform('bhere_rtm_error');\r\n\t\t\t\t\treturn throwError(event);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\tconsole.log('checkRtmEvent$.error', error);\r\n\t\t\t\tevent.checklist.rtm = false;\r\n\t\t\t\tevent.errors.rtm = LabelPipe.transform('bhere_rtm_error');\r\n\t\t\t\treturn throwError(event);\r\n\t\t\t}),\r\n\t\t)\r\n\t}\r\n\r\n}\r\n","import { Component } from 'rxcomp';\r\nimport { ModalService } from '../modal/modal.service';\r\n\r\nexport default class AgoraConfigureFirewallModalComponent extends Component {\r\n\r\n\tonClose() {\r\n\t\tModalService.resolve();\r\n\t}\r\n}\r\n\r\nAgoraConfigureFirewallModalComponent.meta = {\r\n\tselector: '[agora-configure-firewall-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\" [innerHTML]=\"'bhere_configure_firewall' | label\"></div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"button\" class=\"btn--accept\" (click)=\"onClose()\">\r\n\t\t\t\t\t<span>Chiudi</span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nAgoraConfigureFirewallModalComponent.chunk = () => /* html */`<div class=\"configure-firewall-modal\" agora-configure-firewall-modal></div>`;\r\n","import { Component } from 'rxcomp';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { DeviceService } from '../device/device.service';\r\nimport { ModalService } from '../modal/modal.service';\r\nimport { RoleType } from '../user/user';\r\nimport { AgoraChecklistService } from './agora-checklist.service';\r\nimport AgoraConfigureFirewallModalComponent from './agora-configure-firewall-modal.component';\r\n\r\nexport default class AgoraChecklistComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.checklist = {};\r\n\t\tthis.errors = {};\r\n\t\tthis.state = {};\r\n\t\tthis.busy = true;\r\n\t\tthis.shouldCheckAudio = false;\r\n\t\tthis.shouldCheckVideo = false;\r\n\t\tAgoraChecklistService.checkEvent$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// console.log('AgoraChecklistService', event, event.errors);\r\n\t\t\tthis.shouldCheckAudio = event.shouldCheckAudio;\r\n\t\t\tthis.shouldCheckVideo = event.shouldCheckVideo;\r\n\t\t\tthis.checklist = event.checklist;\r\n\t\t\tthis.errors = event.errors || {};\r\n\t\t\t// console.log(JSON.stringify(event.errors));\r\n\t\t\tconst success = AgoraChecklistService.isChecked(event);\r\n\t\t\tif (success) {\r\n\t\t\t\tthis.checklist.success = success;\r\n\t\t\t\tthis.busy = false;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tif (this.state.role === RoleType.SmartDevice) {\r\n\t\t\t\t\tthis.onNext();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}\r\n\t\t\t// console.log(event);\r\n\t\t}, error => {\r\n\t\t\t// console.log('AgoraChecklistService.error', error);\r\n\t\t\tthis.errors = error.errors || {};\r\n\t\t\tthis.checklist.error = true;\r\n\t\t\tthis.busy = false;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonNext() {\r\n\t\tthis.checked.next(this.checklist);\r\n\t}\r\n\r\n\topenHttps() {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n\r\n\tshowFirewallConfiguration() {\r\n\t\tModalService.open$({ template: AgoraConfigureFirewallModalComponent.chunk() }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe();\r\n\t}\r\n}\r\n\r\nAgoraChecklistComponent.meta = {\r\n\tselector: '[agora-checklist]',\r\n\toutputs: ['checked'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"group--info\">\r\n\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t<div class=\"title\" *if=\"busy\" [innerHTML]=\"'bhere_checklist_busy' | label\"></div>\r\n\t\t\t<div class=\"title\" *if=\"checklist.success\" [innerHTML]=\"'bhere_checklist_success' | label\"></div>\r\n\t\t\t<div class=\"title\" *if=\"checklist.error\" [innerHTML]=\"'bhere_checklist_error' | label\"></div>\r\n\t\t\t<ul class=\"group--checklist stagger--childs\">\r\n\t\t\t\t<li class=\"checklist__item check\"><span>Browser</span> <span agora-check [value]=\"checklist.browser\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item error\" *if=\"errors.browser\"><a class=\"btn--link\" href=\"https://browsehappy.com/\" target=\"_blank\" rel=\"noopener\" [innerHTML]=\"errors.browser\"></a></li>\r\n\t\t\t\t<li class=\"checklist__item check\"><span>Https</span> <span agora-check [value]=\"checklist.https\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item error\" *if=\"errors.https\"><a class=\"btn--link\" (click)=\"openHttps()\" [innerHTML]=\"errors.https\"></a></li>\r\n\t\t\t\t<li class=\"checklist__item check\" *if=\"shouldCheckAudio\"><span>Audio</span> <span agora-check [value]=\"checklist.audio\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item error\" *if=\"errors.audio\"><span [innerHTML]=\"errors.audio\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item check\" *if=\"shouldCheckVideo\"><span>Video</span> <span agora-check [value]=\"checklist.video\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item error\" *if=\"errors.video\"><span [innerHTML]=\"errors.video\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item check\"><span>Realtime Communication</span> <span agora-check [value]=\"checklist.rtc\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item error\" *if=\"errors.rtc\"><a class=\"btn--link\" (click)=\"showFirewallConfiguration()\" [innerHTML]=\"errors.rtc\"></a></li>\r\n\t\t\t\t<li class=\"checklist__item check\"><span>Realtime Messaging</span> <span agora-check [value]=\"checklist.rtm\"></span></li>\r\n\t\t\t\t<li class=\"checklist__item error\" *if=\"errors.rtm\"><a class=\"btn--link\" (click)=\"showFirewallConfiguration()\" [innerHTML]=\"errors.rtm\"></a></li>\r\n\t\t\t</ul>\r\n\t\t\t<button type=\"submit\" class=\"btn--next\" [class]=\"{ disabled: !checklist.success, ready: checklist.success }\" (click)=\"onNext()\">\r\n\t\t\t\t<span [innerHTML]=\"'bhere_proceed' | label\"></span>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { BehaviorSubject, Observable, of } from 'rxjs';\r\nimport { expand, filter, finalize, map, share, tap, withLatestFrom } from 'rxjs/operators';\r\n\r\nconst BUFF_SIZE = 512;\r\n\r\nexport default class AudioStreamService {\r\n\r\n\tstatic get context() {\r\n\t\tif (!this.context_ && 'AudioContext' in window) {\r\n\t\t\tthis.context_ = new AudioContext();\r\n\t\t}\r\n\t\treturn this.context_;\r\n\t}\r\n\r\n\t/*\r\n\tstatic get processorNode() {\r\n\t\tif (!this.processorNode_) {\r\n\t\t\tthis.processorNode_ = this.context.createScriptProcessor(BUFF_SIZE, 1, 1);\r\n\t\t}\r\n\t\treturn this.processorNode_;\r\n\t}\r\n\t*/\r\n\r\n\t/*\r\n\tstatic get gain() {\r\n\t\tif (!this.gain_) {\r\n\t\t\tthis.gain_ = this.context.createGain();\r\n\t\t}\r\n\t\treturn this.gain_;\r\n\t}\r\n\t*/\r\n\r\n\tstatic get analyser() {\r\n\t\tif (!this.analyser_) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.analyser_ = this.context.createAnalyser();\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('AudioStreamService.analyser', error);\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn this.analyser_;\r\n\t}\r\n\r\n\tstatic addSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\tif (!this.sources_[key]) {\r\n\t\t\tif (streamOrElement instanceof MediaStream) {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaStreamSource(streamOrElement.clone());\r\n\t\t\t} else {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaElementSource(streamOrElement);\r\n\t\t\t}\r\n\t\t\t// this.sources_[key] = streamOrElement instanceof MediaStream ? this.context.createMediaStreamSource(streamOrElement) : this.context.createMediaElementSource(streamOrElement);\r\n\t\t}\r\n\t\treturn this.sources_[key];\r\n\t}\r\n\r\n\tstatic removeSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\treturn this.removeSourceKey(key);\r\n\t}\r\n\r\n\tstatic removeSourceKey(key) {\r\n\t\t// console.log('AudioStreamService.removeSourceKey', key);\r\n\t\tlet source;\r\n\t\tif (this.sources_[key]) {\r\n\t\t\tsource = this.sources_[key];\r\n\t\t\t/*\r\n\t\t\tif (source.mediaStream) {\r\n\t\t\t\tsource.mediaStream.stop();\r\n\t\t\t}\r\n\t\t\tsource.stop();\r\n\t\t\t*/\r\n\t\t\tif (this.analyser) {\r\n\t\t\t\tsource.disconnect(this.analyser);\r\n\t\t\t}\r\n\t\t\tsource.disconnect();\r\n\t\t\tdelete this.sources_[key];\r\n\t\t}\r\n\t\treturn source;\r\n\t}\r\n\r\n\tstatic frequency$(streamOrElement, fftSize = 64) {\r\n\t\tif (fftSize % 2 === 1) {\r\n\t\t\tthrow ('AudioStreamService.error', 'wrong fftSize', fftSize);\r\n\t\t}\r\n\t\tconst state = new Uint8Array(fftSize / 2);\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst analyser = this.analyser;\r\n\t\t\tif (analyser) {\r\n\t\t\t\t// Connect the output of the analyser to the destination\r\n\t\t\t\t// analyser.connect(context.destination); // no audio !\r\n\t\t\t\t// console.log(analyser.fftSize); // 2048 by default\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // will give us 1024 data points\r\n\t\t\t\tanalyser.fftSize = fftSize; // 64\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // fftSize/2 = 32 data points\r\n\t\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\t\t// source.connect(context.destination); // no audio!\r\n\t\t\t\t// Connect the output of the source to the input of the analyser\r\n\t\t\t\tsource.connect(analyser);\r\n\t\t\t}\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tif (analyser) {\r\n\t\t\t\t\t\t// Get the new frequency data\r\n\t\t\t\t\t\tanalyser.getByteFrequencyData(state);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tconst max = state.reduce((p, c, i) => {\r\n\t\t\t\t\t\t\treturn Math.max(c, p);\r\n\t\t\t\t\t\t}, 0);\r\n\t\t\t\t\t\tif (max > 0) {\r\n\t\t\t\t\t\t\t// console.log(max);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t// Update the visualisation\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic volume$(streamOrElement) {\r\n\t\tconst state = { volume: 0, clipped: false };\r\n\t\tconst context = this.context;\r\n\t\t// console.log('AudioStreamService.volume$', context, state);\r\n\t\tif (context) {\r\n\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\tconst meter = AudioStreamService.audioMeterCreate();\r\n\t\t\tsource.connect(meter);\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tstate.clipped = meter.checkClipping();\r\n\t\t\t\t\tstate.volume = meter.volume;\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic audioMeterCreate(clipLevel = 0.98, averaging = 0.95, clipLag = 750) {\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst processor = context.createScriptProcessor(512);\r\n\t\t\tprocessor.onaudioprocess = this.audioMeterProcess;\r\n\t\t\tprocessor.checkClipping = this.audioMeterClip;\r\n\t\t\tprocessor.dispose = this.audioMeterDispose;\r\n\t\t\tprocessor.clipping = false;\r\n\t\t\tprocessor.lastClip = 0;\r\n\t\t\tprocessor.volume = 0;\r\n\t\t\tprocessor.clipLevel = clipLevel;\r\n\t\t\tprocessor.averaging = averaging;\r\n\t\t\tprocessor.clipLag = clipLag;\r\n\t\t\t// this will have no effect, since we don't copy the input to the output,\r\n\t\t\t// but works around a current Chrome bug.\r\n\t\t\tprocessor.connect(context.destination);\r\n\t\t\treturn processor;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic audioMeterProcess(event) {\r\n\t\tconst buffer = event.inputBuffer.getChannelData(0);\r\n\t\tconst bufferLength = buffer.length;\r\n\t\tlet sum = 0;\r\n\t\tlet x;\r\n\r\n\t\t// Do a root-mean-square on the samples: sum up the squares...\r\n\t\tfor (let i = 0; i < bufferLength; i++) {\r\n\t\t\tx = buffer[i];\r\n\t\t\tif (Math.abs(x) >= this.clipLevel) {\r\n\t\t\t\tthis.clipping = true;\r\n\t\t\t\tthis.lastClip = window.performance.now();\r\n\t\t\t}\r\n\t\t\tsum += x * x;\r\n\t\t}\r\n\r\n\t\t// ... then take the square root of the sum.\r\n\t\tconst rms = Math.sqrt(sum / bufferLength);\r\n\r\n\t\t// Now smooth this out with the averaging factor applied\r\n\t\t// to the previous sample - take the max here because we\r\n\t\t// want 'fast attack, slow release.'\r\n\t\tthis.volume = Math.max(rms, this.volume * this.averaging);\r\n\t}\r\n\r\n\tstatic audioMeterClip() {\r\n\t\tif (!this.clipping) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif ((this.lastClip + this.clipLag) < window.performance.now()) {\r\n\t\t\tthis.clipping = false;\r\n\t\t}\r\n\t\treturn this.clipping;\r\n\t}\r\n\r\n\tstatic audioMeterDispose() {\r\n\t\tthis.disconnect();\r\n\t\tthis.onaudioprocess = null;\r\n\t}\r\n\r\n\tstatic step$(previous) {\r\n\t\t/**\r\n\t\t * This function returns an observable that will emit the next frame once the\r\n\t\t * browser has returned an animation frame step. Given the previous frame it calculates\r\n\t\t * the delta time, and we also clamp it to 30FPS in case we get long frames.\r\n\t\t */\r\n\t\treturn Observable.create((observer) => {\r\n\t\t\trequestAnimationFrame((startTime) => {\r\n\t\t\t\t// Millis to seconds\r\n\t\t\t\tconst deltaTime = previous ? (startTime - previous.startTime) / 1000 : 0;\r\n\t\t\t\tobserver.next({\r\n\t\t\t\t\tstartTime,\r\n\t\t\t\t\tdeltaTime\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}).pipe(\r\n\t\t\tmap(frame => {\r\n\t\t\t\tif (frame.deltaTime > (1 / 30)) {\r\n\t\t\t\t\tframe.deltaTime = 1 / 30;\r\n\t\t\t\t}\r\n\t\t\t\treturn frame;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dispose() {\r\n\t\tObject.keys(this.sources_).forEach(key => {\r\n\t\t\tthis.removeSourceKey(key);\r\n\t\t});\r\n\t\tconst analyser = this.analyser;\r\n\t\tif (analyser) {\r\n\t\t\tanalyser.disconnect();\r\n\t\t}\r\n\t\tthis.sources_ = {};\r\n\t\t// this.context_.close().then(() => console.log('AudioStreamService.dispose'));\r\n\t\t// this.context_ = null;\r\n\t}\r\n\r\n}\r\n\r\nAudioStreamService.sources_ = {};\r\nAudioStreamService.frame$ = of(undefined).pipe(\r\n\texpand((value) => AudioStreamService.step$(value)),\r\n\t// Expand emits the first value provided to it, and in this\r\n\t//  case we just want to ignore the undefined input frame\r\n\tfilter(frame => frame !== undefined),\r\n\tmap(frame => frame.deltaTime),\r\n\tshare()\r\n);\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport AudioStreamService from '../audio/audio-stream.service';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport StateService from '../state/state.service';\r\nimport { getStreamQuality } from './agora.types';\r\n\r\nexport default class AgoraDevicePreviewComponent extends Component {\r\n\r\n\tget video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tset video(video) {\r\n\t\tif (this.video_ !== video) {\r\n\t\t\tthis.video_ = video;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget audio() {\r\n\t\treturn this.audio_;\r\n\t}\r\n\r\n\tset audio(audio) {\r\n\t\tif (this.audio_ !== audio) {\r\n\t\t\tthis.audio_ = audio;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.init();\r\n\t}\r\n\r\n\tinit() {\r\n\t\tif (this.initialized_) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.initialized_ = true;\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\tconst preview = this.preview = node.querySelector('video');\r\n\t\tpreview.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tconst audio = node.querySelector('.audio');\r\n\t\tif (this.hasPreview) {\r\n\t\t\tconst bars = this.bars = new Array(32).fill(0).map(x => {\r\n\t\t\t\tconst bar = document.createElement('div');\r\n\t\t\t\tbar.classList.add('bar');\r\n\t\t\t\taudio.appendChild(bar);\r\n\t\t\t\treturn bar;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tconst preview = this.preview;\r\n\t\tpreview.removeEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tif (this.hasPreview) {\r\n\t\t\tAudioStreamService.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tinitStream() {\r\n\t\tconst preview = this.preview;\r\n\t\tif (!this.preview) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// console.log(this.video_, this.audio_);\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (this.video_ || this.audio_) {\r\n\t\t\tnode.classList.add('ready');\r\n\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\tconst state = StateService.state;\r\n\t\t\t\tconst quality = getStreamQuality(state);\r\n\t\t\t\tconst options = {\r\n\t\t\t\t\tvideo: this.video_ ? {\r\n\t\t\t\t\t\tdeviceId: this.video_,\r\n\t\t\t\t\t\twidth: { ideal: quality.resolution.width },\r\n\t\t\t\t\t\theight: { ideal: quality.resolution.height },\r\n\t\t\t\t\t\tframeRate: { ideal: quality.frameRate.min, max: quality.frameRate.max },\r\n\t\t\t\t\t} : false,\r\n\t\t\t\t\taudio: this.audio_ ? { deviceId: this.audio_ } : false,\r\n\t\t\t\t};\r\n\t\t\t\tif (this.platform === DevicePlatform.IOS) {\r\n\t\t\t\t\toptions.video.facingMode = 'user';\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('AgoraDevicePreviewComponent.initStream.getUserMedia', options);\r\n\t\t\t\tnavigator.mediaDevices.getUserMedia(options).then((stream) => {\r\n\t\t\t\t\tif (this.hasPreview) {\r\n\t\t\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\t\t\tpreview.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpreview.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.audio_) {\r\n\t\t\t\t\t\t\tthis.analyzeData(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.loadingStream_ = stream;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.stream.next(stream);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\tconsole.log('AgoraDevicePreviewComponent.initStream.error', error.name, error.message);\r\n\t\t\t\t\tthis.stream.next(null);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tnode.classList.remove('ready');\r\n\t\t\tif (this.hasPreview) {\r\n\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\tpreview.srcObject = null;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpreview.src = null;\r\n\t\t\t\t}\r\n\t\t\t\tthis.analyzeData(null);\r\n\t\t\t}\r\n\t\t\tthis.stream.next(null);\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraDevicePreview.onLoadedMetadata', event);\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('loaded');\r\n\t\tthis.preview.play();\r\n\t\tthis.stream.next(this.loadingStream_);\r\n\t}\r\n\r\n\tanalyzeData(stream) {\r\n\t\tif (this.frequencySubscription) {\r\n\t\t\tthis.frequencySubscription.unsubscribe();\r\n\t\t}\r\n\t\t// console.log('AgoraDevicePreviewComponent.analyzeData', stream);\r\n\t\tif (stream) {\r\n\t\t\tthis.frequencySubscription = AudioStreamService.frequency$(stream, 64).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(frequency => {\r\n\t\t\t\t// 32 data points\r\n\t\t\t\t// console.log(frequency);\r\n\t\t\t\tconst spacing = 100 / 32;\r\n\t\t\t\tconst bars = this.bars;\r\n\t\t\t\tbars.forEach((bar, i) => {\r\n\t\t\t\t\tconst pow = Math.min(100, (5 + frequency[i])) / 100;\r\n\t\t\t\t\tbar.style.left = i * spacing + '%';\r\n\t\t\t\t\tbar.style.transform = `scale(1,${pow})`;\r\n\t\t\t\t\tbar.style.opacity = pow;\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nAgoraDevicePreviewComponent.meta = {\r\n\tselector: '[agora-device-preview]',\r\n\toutputs: ['stream', 'change'],\r\n\tinputs: ['video', 'audio']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\n\r\nexport default class AgoraDeviceComponent extends Component {\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset; // && this.form && this.form.value.video;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.isHttps = window.location.protocol === 'https:';\r\n\t\tthis.state = {};\r\n\t\tthis.devices = { videos: [], audios: [] };\r\n\t\tthis.stream = null;\r\n\t\tthis.form = null;\r\n\t\tif (this.isHttps) {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tStateService.state$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(state => {\r\n\t\t\t\t// console.log('AgoraDeviceComponent.state', state);\r\n\t\t\t\tthis.state = state;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.devices$().subscribe(devices => {\r\n\t\t\t\t\t// console.log(devices);\r\n\t\t\t\t\tthis.devices = devices;\r\n\t\t\t\t\tthis.initForm(devices);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, error => {\r\n\t\t\t\t\tconsole.log('AgoraDeviceComponent.devices$.error', error);\r\n\t\t\t\t\t// alert('AgoraDeviceComponent ' + error); // !!!\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\topenHttps(event) {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n\r\n\tinitForm(devices) {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tvideo: new FormControl(null, devices.videos.length ? Validators.RequiredValidator() : undefined),\r\n\t\t\taudio: new FormControl(null, devices.audios.length ? Validators.RequiredValidator() : undefined),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tconst videoOptions = devices.videos.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (videoOptions.length > 0) {\r\n\t\t\tvideoOptions.unshift({\r\n\t\t\t\tid: null, name: 'bhere_select_video', // LabelPipe.transform('bhere_select_video')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.video.options = videoOptions;\r\n\t\tconst audioOptions = devices.audios.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (audioOptions.length > 0) {\r\n\t\t\taudioOptions.unshift({\r\n\t\t\t\tid: null, name: 'bhere_select_audio', // LabelPipe.transform('bhere_select_audio')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.audio.options = audioOptions;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraDeviceComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonStreamDidChange(event) {\r\n\t\tthis.stream = null;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonStream(stream) {\r\n\t\tthis.stream = stream;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid && (this.stream || !this.hasPreview);\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonEnter(event) {\r\n\t\tconst preferences = this.form.value;\r\n\t\tconst devices = this.devices;\r\n\t\tdevices.video = devices.videos.find(x => x.deviceId === preferences.video);\r\n\t\tdevices.audio = devices.audios.find(x => x.deviceId === preferences.audio);\r\n\t\tthis.enter.next(devices);\r\n\t}\r\n\r\n}\r\n\r\nAgoraDeviceComponent.meta = {\r\n\tselector: '[agora-device]',\r\n\toutputs: ['enter'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"group--info\" *if=\"!isHttps\">\r\n\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t<div class=\"title\" [innerHTML]=\"'bhere_invalid_protocol' | label\"></div>\r\n\t\t\t<div class=\"info\" [innerHTML]=\"'bhere_reload_in_https' | label\"></div>\r\n\t\t\t<button type=\"button\" class=\"btn--connect\" (click)=\"openHttps($event)\">\r\n\t\t\t\t<span [innerHTML]=\"'bhere_reload' | label\"></span>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"group--info\" *if=\"form\">\r\n\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onEnter($event)\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t<!-- PREVIEW -->\r\n\t\t\t<div class=\"agora-device-preview\" agora-device-preview [video]=\"controls.video.value\" [audio]=\"controls.audio.value\" (stream)=\"onStream($event)\" (change)=\"onStreamDidChange($event)\" *if=\"this.hasPreview\">\r\n\t\t\t\t<video class=\"video\" muted></video>\r\n\t\t\t\t<div class=\"audio\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t<!-- VIDEO -->\r\n\t\t\t\t<div control-custom-select [control]=\"controls.video\" label=\"Video\" *if=\"devices.videos.length\"></div>\r\n\t\t\t\t<!-- AUDIO -->\r\n\t\t\t\t<div control-custom-select [control]=\"controls.audio\" label=\"Audio\" *if=\"devices.audios.length\"></div>\r\n\t\t\t\t<div class=\"info\" *if=\"!isValid()\" [innerHTML]=\"'bhere_select_video_audio' | label\"></div>\r\n\t\t\t\t<div class=\"info\" *if=\"isValid()\" [innerHTML]=\"'bhere_video_audio_connected' | label\"></div>\r\n\t\t\t\t<button type=\"submit\" class=\"btn--connect\" [class]=\"{ disabled: !isValid() }\">\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#call\"></use></svg>\r\n\t\t\t\t\t<span *if=\"!state.connecting\" [innerHTML]=\"'bhere_enter' | label\"></span>\r\n\t\t\t\t\t<span *if=\"state.connecting\" [innerHTML]=\"'bhere_connecting' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t</div>\r\n\t`\r\n};\r\n","\r\nexport class Path {\r\n\r\n\tstatic allowedProps = ['id', 'name', 'items'];\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t\tthis.items = (this.items || []);\r\n\t\tthis.originalItems = this.items.slice();\r\n\t}\r\n\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (View.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n}\r\n\r\nexport function mapPath(map) {\r\n\tmap = new Path(map);\r\n\treturn map;\r\n}\r\n","import { BehaviorSubject, of } from 'rxjs';\r\nimport { map, switchMap } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport { HttpService } from '../../http/http.service';\r\nimport { mapPath } from './path';\r\n\r\nexport const DEFAULT_PATH = {\r\n\tid: null,\r\n\tname: \"Principale\",\r\n\titems: [],\r\n};\r\n\r\nexport default class PathService {\r\n\r\n\tstatic paths$ = new BehaviorSubject([DEFAULT_PATH]);\r\n\tstatic set paths(paths) {\r\n\t\tthis.paths$.next(paths);\r\n\t}\r\n\tstatic get paths() {\r\n\t\treturn this.paths$.getValue();\r\n\t}\r\n\r\n\tstatic path$ = new BehaviorSubject(DEFAULT_PATH);\r\n\tstatic set path(path) {\r\n\t\tthis.path$.next(path);\r\n\t}\r\n\tstatic get path() {\r\n\t\treturn this.path$.getValue();\r\n\t}\r\n\r\n\tstatic getCurrentPath$(pathId = null) {\r\n\t\treturn this.pathGet$().pipe(\r\n\t\t\tswitchMap(paths => {\r\n\t\t\t\tthis.paths = paths;\r\n\t\t\t\tlet path = DEFAULT_PATH;\r\n\t\t\t\tif (pathId) {\r\n\t\t\t\t\tconst selectedPath = paths.find(x => x.id === pathId);\r\n\t\t\t\t\tif (selectedPath) {\r\n\t\t\t\t\t\tpath = selectedPath;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.path = path;\r\n\t\t\t\treturn this.path$;\r\n\t\t\t}),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic pathGet$() {\r\n\t\tif (environment.flags.usePaths) {\r\n\t\t\treturn HttpService.get$(`/api/path`).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.paths = data.paths.map(path => mapPath(path));\r\n\t\t\t\t\tdata.paths.unshift(DEFAULT_PATH);\r\n\t\t\t\t\treturn data.paths;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of([]);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic addPath(path) {\r\n\t\tconst paths = this.paths.slice();\r\n\t\tpaths.push(path);\r\n\t\tthis.paths = paths;\r\n\t\tthis.path = path;\r\n\t}\r\n\r\n\tstatic editPath(path) {\r\n\t\t// console.log('PathService.editPath', path);\r\n\t\tconst paths = this.paths.slice();\r\n\t\tconst index = paths.reduce((p, c, i) => {\r\n\t\t\treturn c.id === path.id ? i : p;\r\n\t\t}, -1);\r\n\t\t// console.log('PathService.editPath', paths, index);\r\n\t\tif (index > 0) {\r\n\t\t\tlet currentPath = this.path;\r\n\t\t\tif (currentPath.id === path.id) {\r\n\t\t\t\tcurrentPath = path;\r\n\t\t\t}\r\n\t\t\t// console.log('PathService.editPath', currentPath);\r\n\t\t\tpaths.splice(index, 1, path);\r\n\t\t\tthis.paths = paths;\r\n\t\t\tthis.path = currentPath;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic deletePath(path) {\r\n\t\tconst paths = this.paths.slice();\r\n\t\tconst index = paths.indexOf(path);\r\n\t\tif (index > 0) {\r\n\t\t\tpaths.splice(index, 1);\r\n\t\t\tthis.paths = paths;\r\n\t\t\tlet currentPath = this.path;\r\n\t\t\tif (currentPath.id === path.id) {\r\n\t\t\t\tcurrentPath = paths[0];\r\n\t\t\t}\r\n\t\t\tthis.path = currentPath;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic pathCreate$(path) {\r\n\t\treturn HttpService.post$(`/api/path`, path).pipe(\r\n\t\t\tmap(path => mapPath(path)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic pathUpdate$(path) {\r\n\t\treturn HttpService.put$(`/api/path/${path.id}`, path).pipe(\r\n\t\t\tmap(x => mapPath(x)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic pathDelete$(path) {\r\n\t\treturn HttpService.delete$(`/api/path/${path.id}`);\r\n\t}\r\n\r\n\t/*\r\n\tstatic itemCreate$(path, item) {\r\n\t\treturn HttpService.post$(`/api/path/${path.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic itemUpdate$(path, item) {\r\n\t\titem = mapViewItem(item); // !!! ??\r\n\t\treturn HttpService.put$(`/api/path/${path.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic itemDelete$(path, item) {\r\n\t\treturn HttpService.delete$(`/api/path/${path.id}/item/${item.id}`);\r\n\t}\r\n\t*/\r\n}\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil, tap } from 'rxjs/operators';\r\nimport PathService from '../editor/path/path.service';\r\nimport { environment } from '../environment';\r\nimport { MeetingId, MEETING_ID_VALIDATOR } from '../meeting/meeting-id';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { RoutePipe } from '../router/route.pipe';\r\nimport StateService from '../state/state.service';\r\n\r\nexport default class AgoraLinkComponent extends Component {\r\n\r\n\tget selfServiceTourRoute() {\r\n\t\tconst pathId = this.form.get('path').value;\r\n\t\tconst route = [RoutePipe.transform(':lang.selfServiceTour')];\r\n\t\tif (pathId) {\r\n\t\t\troute.push(MeetingUrl.validateParams({ pathId }));\r\n\t\t}\r\n\t\treturn route;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.state = {};\r\n\t\tthis.paths = [];\r\n\t\tthis.pathId = null;\r\n\t\tthis.form = null;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraLinkComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tif (environment.flags.usePaths) {\r\n\t\t\tPathService.getCurrentPath$().pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t\ttap(),\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe(path => {\r\n\t\t\t\tthis.paths = PathService.paths;\r\n\t\t\t\tthis.pathId = path.id || '';\r\n\t\t\t\tthis.onLoad();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.onLoad();\r\n\t\t}\r\n\t}\r\n\r\n\tonLoad() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tpath: this.pathId,\r\n\t\t\tid: new FormControl(null, [Validators.PatternValidator(MEETING_ID_VALIDATOR), Validators.RequiredValidator()]),\r\n\t\t\tidAttendee: null,\r\n\t\t\tidStreamer: null,\r\n\t\t\tidViewer: null,\r\n\t\t\tidSmartDevice: null,\r\n\t\t\t// id: new FormControl(null),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tconst pathOptions = this.paths.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.id || '',\r\n\t\t\t\tname: x.name,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (pathOptions.length > 0) {\r\n\t\t\tpathOptions.unshift({\r\n\t\t\t\tid: null, name: 'bhere_select_path', // LabelPipe.transform('bhere_select_path')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.path.options = pathOptions;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraLinkComponent.changes$', form.value);\r\n\t\t\t// console.log(changes.path, changes.id);\r\n\t\t\tif (this.pathId !== changes.path && changes.id !== null) {\r\n\t\t\t\tthis.pathId = changes.path;\r\n\t\t\t\tthis.onGenerateMeetingId();\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonGenerateMeetingId($event) {\r\n\t\tlet pathId = this.pathId ? String(this.pathId) : null;\r\n\t\tpathId = pathId && pathId.length ? pathId : null;\r\n\t\t// console.log('onGenerateMeetingId', this.pathId, pathId);\r\n\t\tconst meetingId = new MeetingId({ pathId });\r\n\t\tconst meetingIdRoles = meetingId.toRoles();\r\n\t\tthis.form.patch(meetingIdRoles);\r\n\t}\r\n\r\n\tonInputDidChange($event) {\r\n\t\t// console.log('onInputDidChange', this.form.get('id').value, this.form.get('id').valid);\r\n\t\tif (this.state.role !== 'publisher') {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsetTimeout(() => {\r\n\t\t\tif (this.form.get('id').valid) {\r\n\t\t\t\tconst value = this.form.get('id').value;\r\n\t\t\t\tconst meetingId = new MeetingId(value);\r\n\t\t\t\tconst meetingIdRoles = meetingId.toRoles();\r\n\t\t\t\tthis.form.patch(meetingIdRoles);\r\n\t\t\t} else {\r\n\t\t\t\tthis.form.get('idAttendee').reset();\r\n\t\t\t\tthis.form.get('idStreamer').reset();\r\n\t\t\t\tthis.form.get('idViewer').reset();\r\n\t\t\t\tthis.form.get('idSmartDevice').reset();\r\n\t\t\t}\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tonCopyToClipBoard(id, asAccessCode = false) {\r\n\t\tconst meetingUrl = new MeetingUrl({ link: id });\r\n\t\tmeetingUrl.copyToClipBoard(asAccessCode);\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tlet meetingId = this.controls.id.value;\r\n\t\tMeetingUrl.replaceWithLink(meetingId);\r\n\t\tthis.link.next(meetingId);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n}\r\n\r\nAgoraLinkComponent.meta = {\r\n\tselector: '[agora-link]',\r\n\toutputs: ['link'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"group--info\" *if=\"form\">\r\n\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onNext($event)\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t<div class=\"stagger--childs\" *if=\"state.role !== 'publisher'\">\r\n\t\t\t\t\t<div class=\"group--form group--form--addon\" [class]=\"{ required: controls.id.validators.length, 'addon': controls.id.valid }\">\r\n\t\t\t\t\t\t<label [innerHTML]=\"'bhere_insert_meeting_id' | label\"></label>\r\n\t\t\t\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"controls.id\" [placeholder]=\"'bhere_meeting_id' | label\" />\r\n\t\t\t\t\t\t<div class=\"control--addon\" (click)=\"onCopyToClipBoard(controls.id.value)\" *if=\"controls.id.valid\">\r\n\t\t\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"stagger--childs\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t<!-- PATH -->\r\n\t\t\t\t\t<div control-custom-select [control]=\"controls.path\" [label]=\"'bhere_path' | label\" *if=\"('usePaths' | flag) && paths.length\"></div>\r\n\t\t\t\t\t<!--IDS -->\r\n\t\t\t\t\t<div class=\"group--form group--form--addon\" [class]=\"{ required: controls.id.validators.length, 'addon': controls.id.valid }\">\r\n\t\t\t\t\t\t<label><svg class=\"lock\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#lock\"></use></svg> <span [innerHTML]=\"'bhere_insert_meeting_id' | label\"></span></label>\r\n\t\t\t\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"controls.id\" [placeholder]=\"'bhere_meeting_id' | label\" (change)=\"onInputDidChange($event)\" />\r\n\t\t\t\t\t\t<div class=\"control--addon\" (click)=\"onCopyToClipBoard(controls.id.value)\" *if=\"controls.id.valid\">\r\n\t\t\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--form group--form--addon addon\" *if=\"('attendee' | flag) && controls.idAttendee.valid && controls.idAttendee.value !== null\">\r\n\t\t\t\t\t\t<label><svg class=\"lock\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#lock\"></use></svg> <span [innerHTML]=\"'bhere_attendee_meeting_id' | label\"></span></label>\r\n\t\t\t\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"controls.idAttendee\" [placeholder]=\"'bhere_attendee_meeting_id' | label\" readonly />\r\n\t\t\t\t\t\t<div class=\"control--addon\" (click)=\"onCopyToClipBoard(controls.idAttendee.value)\" *if=\"controls.idAttendee.valid\">\r\n\t\t\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--form group--form--addon addon\" *if=\"('streamer' | flag) && controls.idStreamer.valid && controls.idStreamer.value !== null\">\r\n\t\t\t\t\t\t<label [innerHTML]=\"'bhere_streamer_meeting_id' | label\"></label>\r\n\t\t\t\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"controls.idStreamer\" [placeholder]=\"'bhere_streamer_meeting_id' | label\" readonly />\r\n\t\t\t\t\t\t<div class=\"control--addon\" (click)=\"onCopyToClipBoard(controls.idStreamer.value)\" *if=\"controls.idStreamer.valid\">\r\n\t\t\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--form group--form--addon addon\" *if=\"('viewer' | flag) && controls.idViewer.valid && controls.idViewer.value !== null\">\r\n\t\t\t\t\t\t<label [innerHTML]=\"'bhere_viewer_meeting_id' | label\"></label>\r\n\t\t\t\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"controls.idViewer\" [placeholder]=\"'bhere_viewer_meeting_id' | label\" readonly />\r\n\t\t\t\t\t\t<div class=\"control--addon\" (click)=\"onCopyToClipBoard(controls.idViewer.value)\" *if=\"controls.idViewer.valid\">\r\n\t\t\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--form group--form--addon addon\" *if=\"('smartDevice' | flag) && controls.idSmartDevice.valid && controls.idSmartDevice.value !== null\">\r\n\t\t\t\t\t\t<label [innerHTML]=\"'bhere_smart_device_meeting_id' | label\"></label>\r\n\t\t\t\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"controls.idSmartDevice\" [placeholder]=\"'bhere_smart_device_meeting_id' | label\" readonly />\r\n\t\t\t\t\t\t<div class=\"control--addon\" (click)=\"onCopyToClipBoard(controls.idSmartDevice.value, true)\" *if=\"controls.idSmartDevice.valid\">\r\n\t\t\t\t\t\t\t<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"info\" *if=\"controls.id.errors.required\" [innerHTML]=\"'bhere_insert_meeting_id' | label\"></div>\r\n\t\t\t\t<div class=\"info\" *if=\"controls.id.errors.pattern\" [innerHTML]=\"'bhere_invalid_meeting_id' | label\"></div>\r\n\t\t\t\t<div class=\"info\" *if=\"isValid()\" [innerHTML]=\"'bhere_take_part_meeting' | label\"></div>\r\n\t\t\t\t<button type=\"button\" class=\"btn--generate\" *if=\"state.role == 'publisher'\" (click)=\"onGenerateMeetingId($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'bhere_generate_meeting_id' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"submit\" class=\"btn--next\" [class]=\"{ disabled: !isValid() }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'bhere_take_part' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<a [routerLink]=\"selfServiceTourRoute\" class=\"btn--secondary\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t<span [innerHTML]=\"'bhere_self_service' | label\"></span>\r\n\t\t\t\t</a>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { LabelPipe } from '../label/label.pipe';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport StateService from '../state/state.service';\r\nimport { UserService } from '../user/user.service';\r\n\r\nexport default class AgoraLoginComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tthis.form.patch({\r\n\t\t\tusername: 'publisher',\r\n\t\t\tpassword: 'publisher',\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: ''\r\n\t\t});\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tthis.error = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tUserService.login$(payload).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(user => {\r\n\t\t\t\tif (StateService.state.role === user.type) {\r\n\t\t\t\t\t// this.login.next(user);\r\n\t\t\t\t\tthis.onNext(user);\r\n\t\t\t\t\tthis.form.reset();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.error = { friendlyMessage: LabelPipe.transform('error_credentials') };\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(user) {\r\n\t\tMeetingUrl.replaceWithUser(user);\r\n\t\tthis.login.next(user);\r\n\t}\r\n}\r\n\r\nAgoraLoginComponent.meta = {\r\n\tselector: '[agora-login]',\r\n\toutputs: ['login'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"group--info\">\r\n\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t<div class=\"title\" [innerHTML]=\"'bhere_login' | label\"></div>\r\n\t\t\t\t<input name=\"checkField\" [formControl]=\"controls.checkField\" value=\"\" type=\"text\" style=\"display:none !important;\" />\r\n\t\t\t\t<div control-text [control]=\"controls.username\" [label]=\"'bhere_username' | label\"></div>\r\n\t\t\t\t<div control-password [control]=\"controls.password\" [label]=\"'bhere_password' | label\"></div>\r\n\t\t\t\t<div class=\"group--error\" *if=\"error\">\r\n\t\t\t\t\t<span class=\"status-code\" [innerHTML]=\"error.statusCode\"></span>\r\n\t\t\t\t\t<span class=\"status-message\" [innerHTML]=\"error.statusMessage\"></span>\r\n\t\t\t\t\t<span class=\"friendly-message\" [innerHTML]=\"error.friendlyMessage\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"info\" *if=\"isValid()\" [innerHTML]=\"'bhere_cta' | label\"></div>\r\n\t\t\t\t<button type=\"submit\" class=\"btn--next\" [class]=\"{ disabled: !isValid() }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'bhere_cta' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<test-component [form]=\"form\" (test)=\"test($event)\" (reset)=\"reset($event)\"></test-component>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport { fieldsToFormGroup, patchFields } from '../forms/controls.component';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport StateService from '../state/state.service';\r\n\r\nexport default class AgoraNameComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\tthis.state = {};\r\n\r\n\t\tconst fields = this.fields = [];\r\n\r\n\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\tconst firstName = meetingUrl.firstName;\r\n\t\t\tconst lastName = meetingUrl.lastName;\r\n\t\t\tconst email = meetingUrl.email;\r\n\t\t\tfields.push(\r\n\t\t\t\t{ type: 'text', name: 'firstName', label: 'access_first_name', required: true, value: firstName, test: 'Jhon' },\r\n\t\t\t\t{ type: 'text', name: 'lastName', label: 'access_last_name', required: true, value: lastName, test: 'Appleseed' },\r\n\t\t\t\t{ type: 'email', name: 'email', label: 'access_email', required: true, value: email, test: 'jhonappleseed@gmail.com' },\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tconst name = meetingUrl.name;\r\n\t\t\tfields.push(\r\n\t\t\t\t{ type: 'text', name: 'name', label: 'bhere_name_and_surname', pattern: /^\\w{2,}\\s\\w{2,}/, required: true, value: name, test: 'Jhon Appleseed' },\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tfields.push(\r\n\t\t\t{ type: 'checkbox', name: 'privacy', label: 'access_privacy_disclaimer', required: true, test: true },\r\n\t\t\t{ type: 'hidden', name: 'checkField', value: '', test: '' },\r\n\t\t\t{ type: 'none', name: 'checkRequest', value: environment.antiforgery || '', test: environment.antiforgery || '' }\r\n\t\t);\r\n\r\n\t\tconst form = this.form = fieldsToFormGroup(fields);\r\n\r\n\t\t/*\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(name, [Validators.PatternValidator(/^\\w{2,}\\s\\w{2,}/), Validators.RequiredValidator()]),\r\n\t\t});\r\n\t\t*/\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraNameComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraNameComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\ttest() {\r\n\t\tpatchFields(this.fields, this.form);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tlet name;\r\n\t\tlet options;\r\n\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\toptions = {\r\n\t\t\t\tfirstName: this.controls.firstName.value,\r\n\t\t\t\tlastName: this.controls.lastName.value,\r\n\t\t\t\temail: this.controls.email.value,\r\n\t\t\t};\r\n\t\t\tname = `${options.firstName} ${options.lastName}`;\r\n\t\t} else {\r\n\t\t\toptions = {\r\n\t\t\t\tname: this.controls.name.value,\r\n\t\t\t};\r\n\t\t\tname = options.name;\r\n\t\t}\r\n\t\tMeetingUrl.replaceWithOptions(options);\r\n\t\tthis.name.next(name);\r\n\t}\r\n\r\n}\r\n\r\nAgoraNameComponent.meta = {\r\n\tselector: '[agora-name]',\r\n\toutputs: ['name'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"group--info\" *if=\"form\">\r\n\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onNext($event)\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t<div class=\"group--info__content stagger--childs\">\r\n\t\t\t\t<!-- controls -->\r\n\t\t\t\t<div controls [formGroup]=\"form\" [fields]=\"fields\"></div>\r\n\t\t\t\t<!-- NAME -->\r\n\t\t\t\t<!--\r\n\t\t\t\t<div class=\"group--form group--form--addon\" [class]=\"{ required: controls.name.validators.length }\">\r\n\t\t\t\t\t<label [innerHTML]=\"'bhere_fill_fullname' | label\"></label>\r\n\t\t\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"controls.name\" [placeholder]=\"'bhere_name_and_surname' | label\" />\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"info\" *if=\"!controls.name.valid\" [innerHTML]=\"'bhere_fill_name_and_surname' | label\"></div>\r\n\t\t\t\t-->\r\n\t\t\t\t<div class=\"info\" *if=\"!isValid()\"><span [innerHTML]=\"'bhere_fill_name_and_surname' | label\"></span></div>\r\n\t\t\t\t<div class=\"info\" *if=\"isValid()\"><span [innerHTML]=\"'bhere_proceed_as' | label\"></span> <span [innerHTML]=\"controls.name.value\"></span></div>\r\n\t\t\t\t<button type=\"submit\" class=\"btn--next\" [class]=\"{ disabled: !isValid() }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'bhere_proceed' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<test-component [form]=\"form\" (test)=\"test($event)\" (reset)=\"reset($event)\"></test-component>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { MessageService } from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, MessageType } from './agora.types';\r\n\r\nexport default class AgoraStreamComponent extends Component {\r\n\r\n\tset videoMuted(videoMuted) {\r\n\t\tif (this.videoMuted_ !== videoMuted) {\r\n\t\t\tthis.videoMuted_ = videoMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tvideoMuted ? node.classList.add('video--muted') : node.classList.remove('video--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tset audioMuted(audioMuted) {\r\n\t\tif (this.audioMuted_ !== audioMuted) {\r\n\t\t\tthis.audioMuted_ = audioMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\taudioMuted ? node.classList.add('audio--muted') : node.classList.remove('audio--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tget streamId() {\r\n\t\treturn this.streamId_;\r\n\t}\r\n\r\n\tset streamId(streamId) {\r\n\t\tthis.streamId_ = streamId;\r\n\t}\r\n\r\n\tget stream() {\r\n\t\treturn this.stream_;\r\n\t}\r\n\r\n\tset stream(stream) {\r\n\t\tif (this.stream_ !== stream) {\r\n\t\t\t// console.log('AgoraStreamComponent set stream', stream);\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst player = this.player = node.querySelector('.agora-stream__player');\r\n\t\t\twhile (player.childElementCount > 0) {\r\n\t\t\t\tplayer.removeChild(player.firstElementChild);\r\n\t\t\t}\r\n\t\t\t// player.textContent = '';\r\n\t\t\t// !!!\r\n\t\t\tif (this.stream_ && this.stream_.isPlaying() && this.stream_.player.div.parentNode === player) {\r\n\t\t\t\tconsole.log('AgoraStreamComponent stopping stream', this.stream_.getId(), 'on', this.stream_.player.div.parentNode);\r\n\t\t\t\tthis.stream_.stop();\r\n\t\t\t}\r\n\t\t\tthis.stream_ = stream;\r\n\t\t\tif (stream) {\r\n\t\t\t\tthis.videoMuted = stream.userMuteVideo;\r\n\t\t\t\tthis.audioMuted = stream.userMuteAudio;\r\n\t\t\t}\r\n\t\t\tconst streamId = stream ? stream.getId() : null;\r\n\t\t\tthis.streamId = streamId;\r\n\t\t\t// console.log('AgoraStreamComponent streamId', streamId);\r\n\t\t\tif (streamId) {\r\n\t\t\t\t// const name = `stream-${node.getAttribute('type')}-${streamId}`;\r\n\t\t\t\tconst name = `stream-${streamId}`;\r\n\t\t\t\tplayer.setAttribute('id', name);\r\n\t\t\t\tconst self = this;\r\n\t\t\t\tif (stream.isPlaying()) {\r\n\t\t\t\t\tplayer.appendChild(stream.player.div);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.shouldUseResumeGesture = false;\r\n\t\t\t\t\tstream.play(name, { fit: 'cover' }, (error) => {\r\n\t\t\t\t\t\tif (error && error.status !== 'aborted') {\r\n\t\t\t\t\t\t\t// The playback fails, probably due to browser policy. You can resume the playback by user gesture.\r\n\t\t\t\t\t\t\tself.shouldUseResumeGesture = true;\r\n\t\t\t\t\t\t\tself.pushChanges();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tplayer.removeAttribute('id');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tset vrContainer(vrContainer) {\r\n\t\tif (this.vrContainer_ !== vrContainer) {\r\n\t\t\tthis.vrContainer_ = vrContainer;\r\n\t\t\tif (vrContainer) {\r\n\t\t\t\tthis.stream_.vrContainer = vrContainer;\r\n\t\t\t\tthis.player.appendChild(vrContainer);\r\n\t\t\t} else if (this.stream_.vrContainer && this.stream_.vrContainer.parentNode) {\r\n\t\t\t\tthis.stream_.vrContainer.parentNode.removeChild(this.stream_.vrContainer);\r\n\t\t\t\tthis.stream_.vrContainer = null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget videoNode() {\r\n\t\tlet videoNode = this.videoNode_;\r\n\t\tif (!videoNode) {\r\n\t\t\tconst player = getContext(this).node.querySelector('.agora-stream__player');\r\n\t\t\tvideoNode = document.createElement('video');\r\n\t\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\t\tvideoNode.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\t\tplayer.appendChild(videoNode);\r\n\t\t\tthis.videoNode_ = videoNode;\r\n\t\t}\r\n\t\treturn videoNode;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.videoMuted = false;\r\n\t\tthis.audioMuted = false;\r\n\t\tthis.shouldUseResumeGesture = false;\r\n\t\tthis.state = {};\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log('AgoraStreamComponent.StateService.state$', this.streamId, state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraStreamComponent.MessageService.out$', this.streamId, message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.AgoraEvent:\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tconst event = message.event;\r\n\t\t\t\t\t\t// console.log('AgoraStreamComponent.AgoraEvent', message.event);\r\n\t\t\t\t\t\tif (this.streamId && event.streamId === this.streamId) {\r\n\t\t\t\t\t\t\tif (event instanceof AgoraMuteVideoEvent) {\r\n\t\t\t\t\t\t\t\tthis.videoMuted = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (event instanceof AgoraUnmuteVideoEvent) {\r\n\t\t\t\t\t\t\t\tthis.videoMuted = false;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (event instanceof AgoraMuteAudioEvent) {\r\n\t\t\t\t\t\t\t\tthis.audioMuted = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (event instanceof AgoraUnmuteAudioEvent) {\r\n\t\t\t\t\t\t\t\tthis.audioMuted = false;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VRStarted', this.streamId, message.clientId, message.container);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = message.container;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VREnded', this.streamId, message.clientId);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetMediaStream(mediaStream) {\r\n\t\tconst videoNode = this.videoNode;\r\n\t\tif ('srcObject' in videoNode) {\r\n\t\t\tvideoNode.srcObject = mediaStream;\r\n\t\t} else {\r\n\t\t\tvideoNode.src = mediaStream ? window.URL.createObjectURL(mediaStream) : null;\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraStreamComponent.onLoadedMetadata', event);\r\n\t\tthis.videoNode.play().then(success => {\r\n\t\t\t// console.log('AgoraStreamComponent.play.success', success);\r\n\t\t}, error => {\r\n\t\t\tconsole.log('AgoraStreamComponent.play.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonToggleControl($event) {\r\n\t\tthis.toggleControl.next($event);\r\n\t}\r\n\r\n\tonToggleSpy($event) {\r\n\t\tthis.toggleSpy.next($event);\r\n\t}\r\n}\r\n\r\nAgoraStreamComponent.meta = {\r\n\tselector: '[agora-stream]',\r\n\toutputs: ['toggleControl', 'toggleSpy'],\r\n\tinputs: ['stream'],\r\n};\r\n","import { Subject } from 'rxjs';\r\nimport StateService from '../state/state.service';\r\n\r\nexport const ViewType = {\r\n\tWaitingRoom: { id: 1, name: 'waiting-room' },\r\n\tPanorama: { id: 2, name: 'panorama' },\r\n\tPanoramaGrid: { id: 3, name: 'panorama-grid' },\r\n\tRoom3d: { id: 4, name: 'room-3d' },\r\n\tModel: { id: 5, name: 'model' },\r\n\tMedia: { id: 6, name: 'media' },\r\n};\r\n\r\nexport const ViewItemType = {\r\n\tNav: { id: 1, name: 'nav' },\r\n\tPlane: { id: 2, name: 'plane' },\r\n\tCurvedPlane: { id: 3, name: 'curved-plane' },\r\n\tModel: { id: 4, name: 'model' },\r\n\tTexture: { id: 5, name: 'texture' },\r\n};\r\n\r\nexport class View {\r\n\t// 'liked'\r\n\tstatic allowedProps = ['id', 'type', 'name', 'hidden', 'likes', 'asset', 'items', 'orientation', 'zoom', 'ar', 'tiles', 'invertAxes', 'flipAxes'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t\tthis.updateIndices(options.items);\r\n\t\t}\r\n\t\tthis.items = (this.items || []).filter(item => filterViewItem(item)).map(item => mapViewItem(item));\r\n\t\tif (this.tiles) {\r\n\t\t\tthis.tiles = this.tiles.map(tile => mapViewTile(tile));\r\n\t\t}\r\n\t\tthis.originalItems = this.items.slice();\r\n\t\tthis.lastOrientation = { latitude: 0, longitude: 0 };\r\n\t\tthis.path = true;\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (View.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'items':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(item => mapViewItem(item).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'tiles':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(tile => mapViewTile(tile).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\r\n\tget pathItems() {\r\n\t\treturn this.items.filter(x => x.path);\r\n\t}\r\n\r\n\tget shortType() {\r\n\t\treturn this.type ? this.type.split('-').map(x => x.substring(0, 1).toUpperCase()).join('') : '??';\r\n\t}\r\n\r\n\tupdateIndices(items) {\r\n\t\tif (items) {\r\n\t\t\tlet publisherStreamIndex = 0;\r\n\t\t\tlet attendeeStreamIndex = 0;\r\n\t\t\tlet smartDeviceStream = 0;\r\n\t\t\tlet publisherScreenIndex = 0;\r\n\t\t\tlet attendeeScreenIndex = 0;\r\n\t\t\titems.forEach((item, index) => {\r\n\t\t\t\titem.index = index;\r\n\t\t\t\tif (item.asset) {\r\n\t\t\t\t\tswitch (item.asset.file) {\r\n\t\t\t\t\t\tcase 'publisherStream':\r\n\t\t\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'nextAttendeeStream':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'smartDeviceStream':\r\n\t\t\t\t\t\t\titem.asset.index = smartDeviceStream++;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'publisherScreen':\r\n\t\t\t\t\t\t\titem.asset.index = publisherScreenIndex++;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'attendeeScreen':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeScreenIndex++;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t/*\r\n\t\t\t\tif (item.asset && item.asset.file === 'publisherStream') {\r\n\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\tif (item.asset && item.asset.file === 'nextAttendeeStream') {\r\n\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class PanoramaView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class PanoramaGridView extends View {\r\n\r\n\tstatic mapTiles(tiles = [], flipAxes = false, invertAxes = false, folder = '') {\r\n\t\tconst axes = flipAxes ? -1 : 1;\r\n\t\treturn tiles.map((tile, i) => {\r\n\t\t\tconst indices = new THREE.Vector2();\r\n\t\t\ttile = typeof tile === 'string' ? { id: i + 1, asset: { folder: folder, file: tile }, navs: [] } : tile;\r\n\t\t\ttile.asset.file.replace(/_x([-|\\d]+)_y([-|\\d]+)/g, (a, b, c) => {\r\n\t\t\t\tif (invertAxes) {\r\n\t\t\t\t\tindices.y = parseInt(b);\r\n\t\t\t\t\tindices.x = parseInt(c) * axes;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tindices.x = parseInt(b);\r\n\t\t\t\t\tindices.y = parseInt(c) * axes;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn {\r\n\t\t\t\tid: tile.id,\r\n\t\t\t\ttype: Object.assign({}, ViewType.PanoramaGrid),\r\n\t\t\t\tasset: tile.asset,\r\n\t\t\t\tnavs: tile.navs || [],\r\n\t\t\t\tindices,\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tset index(index) {\r\n\t\tif (this.index_ !== index) {\r\n\t\t\tthis.index_ = index;\r\n\t\t\tthis.tiles.forEach((tile, i) => tile.selected = i === index);\r\n\t\t\tthis.updateCurrentItems();\r\n\t\t\t// console.log('PanoramaGridView.index.set', index, this.items);\r\n\t\t\tthis.index$.next(index);\r\n\t\t}\r\n\t}\r\n\tget index() {\r\n\t\treturn this.index_;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\toptions.tiles = PanoramaGridView.mapTiles(options.tiles, options.flipAxes, options.invertAxes, options.asset ? options.asset.folder : '');\r\n\t\tsuper(options);\r\n\t\t/*\r\n\t\tif (!this.tiles.length) {\r\n\t\t\tthrow new Error('PanoramaGridView.constructor tile list is empty!');\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.index_ = 0;\r\n\t\tthis.index$ = new Subject();\r\n\t\tthis.tiles.forEach((tile, i) => tile.selected = i === 0);\r\n\t\tif (this.tiles.length) {\r\n\t\t\tthis.items = this.originalItems.concat(this.tiles[0].navs);\r\n\t\t\tthis.asset = this.tiles[0].asset;\r\n\t\t}\r\n\t}\r\n\r\n\tupdateCurrentItems() {\r\n\t\tthis.items = this.originalItems.concat(this.tiles[this.index_].navs);\r\n\t}\r\n\r\n\tgetTileIndex(x, y) {\r\n\t\treturn this.tiles.reduce((p, c, i) => {\r\n\t\t\tif (c.indices.x === x && c.indices.y === y) {\r\n\t\t\t\treturn i;\r\n\t\t\t} else {\r\n\t\t\t\treturn p;\r\n\t\t\t}\r\n\t\t}, -1);\r\n\t}\r\n\thasTile(x, y) {\r\n\t\treturn this.getTileIndex(x, y) !== -1;\r\n\t}\r\n\tgetTile(x, y) {\r\n\t\tconst index = this.getTileIndex(x, y);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.index = index;\r\n\t\t\treturn this.tiles[index];\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class Room3DView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class ModelView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class MediaView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class ViewItem {\r\n\tstatic allowedProps = ['id', 'type', 'title', 'abstract', 'asset', 'link', 'links', 'viewId', 'hook', 'hookExtra', 'keepOrientation', 'important', 'transparent', 'position', 'rotation', 'scale', 'radius', 'height', 'arc'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t\tthis.path = true;\r\n\t\tconst links = this.links || (this.link ? [this.link] : []);\r\n\t\tthis.links = links;\r\n\t}\r\n\tget firstLink() {\r\n\t\treturn (this.links && this.links.length) ? this.links[0] : null;\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewItem.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (payload.link && (!payload.link.title || !payload.link.href)) {\r\n\t\t\tdelete payload.link;\r\n\t\t}\r\n\t\treturn payload;\r\n\t}\r\n\tget hasPanel() {\r\n\t\treturn this.type.name === ViewItemType.Nav.name && (\r\n\t\t\t(this.title && this.title !== '') ||\r\n\t\t\t(this.abstract && this.abstract !== '') ||\r\n\t\t\tthis.asset ||\r\n\t\t\tthis.link\r\n\t\t);\r\n\t}\r\n}\r\n\r\nexport class NavViewItem extends ViewItem {\r\n\r\n}\r\n\r\nexport class ViewTile {\r\n\tstatic allowedProps = ['id', 'asset', 'navs'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t\tthis.navs = (this.navs || []).map(nav => mapViewItem(nav));\r\n\t\tthis.originalItems = this.navs.slice();\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewTile.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'navs':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(nav => mapViewItem(nav).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n}\r\n\r\nexport function mapView(view) {\r\n\tswitch (view.type.name) {\r\n\t\tcase ViewType.Panorama.name:\r\n\t\t\tview = new PanoramaView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\tview = new PanoramaGridView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.Room3d.name:\r\n\t\t\tview = new Room3DView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.Model.name:\r\n\t\t\tview = new ModelView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.Media.name:\r\n\t\t\tview = new MediaView(view);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tview = new View(view);\r\n\t}\r\n\treturn view;\r\n}\r\n\r\nexport function filterViewItem(item) {\r\n\tlet flag;\r\n\tswitch (item.type.name) {\r\n\t\tcase ViewItemType.Nav.name:\r\n\t\t\tflag = item.viewId == null || isNavMove(item) || StateService.state.navigable;\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tflag = true;\r\n\t}\r\n\treturn flag;\r\n}\r\n\r\nexport function mapViewItem(item) {\r\n\tswitch (item.type.name) {\r\n\t\tcase ViewItemType.Nav.name:\r\n\t\t\titem = new NavViewItem(item);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\titem = new ViewItem(item);\r\n\t}\r\n\treturn item;\r\n}\r\n\r\nexport function mapViewTile(tile) {\r\n\treturn new ViewTile(tile);\r\n}\r\n\r\nexport function isNavMove(item) {\r\n\treturn !isValidText(item.title) && !isValidText(item.abstract);\r\n}\r\n\r\nexport function isValidText(text) {\r\n\treturn text && text.length > 0;\r\n}\r\n","import { mapViewItem } from '../../view/view';\r\n\r\nexport class Navmap {\r\n\r\n\tstatic allowedProps = ['id', 'name', 'asset', 'items'];\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t\tthis.items = (this.items || []).map(item => mapViewItem(item));\r\n\t\tthis.originalItems = this.items.slice();\r\n\t}\r\n\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (View.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'items':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(item => mapViewItem(item).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n}\r\n\r\nexport function mapNavmap(map) {\r\n\tmap = new Navmap(map);\r\n\treturn map;\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\nimport { HttpService } from '../../http/http.service';\r\nimport { mapViewItem } from '../../view/view';\r\nimport { mapNavmap } from './navmap';\r\n\r\nexport default class NavmapService {\r\n\r\n\tstatic active$ = new BehaviorSubject(false);\r\n\tstatic set active(active) {\r\n\t\tthis.active$.next(active);\r\n\t}\r\n\tstatic get active() {\r\n\t\treturn this.active$.getValue();\r\n\t}\r\n\r\n\tstatic navmapGet$() {\r\n\t\treturn HttpService.get$(`/api/navmap`).pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tdata.navmaps.map(navmap => mapNavmap(navmap));\r\n\t\t\t\treturn data.navmaps;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic navmapCreate$(navmap) {\r\n\t\treturn HttpService.post$(`/api/navmap`, navmap).pipe(\r\n\t\t\tmap(navmap => mapNavmap(navmap)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic navmapUpdate$(navmap) {\r\n\t\treturn HttpService.put$(`/api/navmap/${navmap.id}`, navmap).pipe(\r\n\t\t\tmap(x => mapNavmap(x)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic navmapDelete$(navmap) {\r\n\t\treturn HttpService.delete$(`/api/navmap/${navmap.id}`);\r\n\t}\r\n\r\n\tstatic itemCreate$(navmap, item) {\r\n\t\treturn HttpService.post$(`/api/navmap/${navmap.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic itemUpdate$(navmap, item) {\r\n\t\titem = mapViewItem(item); // !!! ??\r\n\t\treturn HttpService.put$(`/api/navmap/${navmap.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic itemDelete$(navmap, item) {\r\n\t\treturn HttpService.delete$(`/api/navmap/${navmap.id}/item/${item.id}`);\r\n\t}\r\n}\r\n","function push_(event) {\r\n\tconst dataLayer = window.dataLayer || [];\r\n\tdataLayer.push(event);\r\n\tconsole.log('GtmService.dataLayer', event);\r\n}\r\n\r\nexport default class GtmService {\r\n\r\n\tstatic push(event) {\r\n\t\treturn push_(event);\r\n\t}\r\n\r\n}\r\n","import { Subject } from 'rxjs';\r\n\r\nexport const ToastType = {\r\n\tInfo: 'info',\r\n\tAlert: 'alert',\r\n\tDialog: 'dialog',\r\n}\r\n\r\nexport const ToastPosition = {\r\n\tCentered: 'centered',\r\n\tTopLeft: 'top-left',\r\n\tTop: 'top',\r\n\tTopRight: 'top-right',\r\n\tRight: 'right',\r\n\tBottomRight: 'bottom-right',\r\n\tBottom: 'bottom',\r\n\tBottomLeft: 'bottom-left',\r\n\tLeft: 'left',\r\n}\r\n\r\nexport class ToastEvent {\r\n\tconstructor(toast) {\r\n\t\tthis.toast = toast;\r\n\t}\r\n}\r\n\r\nexport class ToastResolveEvent extends ToastEvent { }\r\nexport class ToastRejectEvent extends ToastEvent { }\r\n\r\nexport default class ToastService {\r\n\tstatic open$(toast) {\r\n\t\ttoast.id = new Date().getTime();\r\n\t\ttoast.type = toast.type || ToastType.Info;\r\n\t\ttoast.position = toast.position || ToastPosition.Centered;\r\n\t\tswitch (toast.type) {\r\n\t\t\tcase ToastType.Alert:\r\n\t\t\t\ttoast.acceptMessage = toast.acceptMessage || `Ok`;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ToastType.Dialog:\r\n\t\t\t\ttoast.acceptMessage = toast.acceptMessage || `Accept`;\r\n\t\t\t\ttoast.rejectMessage = toast.rejectMessage || `Reject`;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tthis.toast$.next(toast);\r\n\t\tif (toast.type === ToastType.Info) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.resolve(toast);\r\n\t\t\t}, toast.duration || 4000);\r\n\t\t}\r\n\t\treturn this.events$;\r\n\t\t/*\r\n\t\treturn of(toast).pipe(\r\n\t\t\ttap(toast => this.toast$.next(toast)),\r\n\t\t\tswitchMap(toast => this.events$),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\tstatic resolve(toast) {\r\n\t\tthis.toast$.next(null);\r\n\t\tthis.events$.next(new ToastResolveEvent(toast));\r\n\t}\r\n\r\n\tstatic reject(toast) {\r\n\t\tthis.toast$.next(null);\r\n\t\tthis.events$.next(new ToastRejectEvent(toast));\r\n\t}\r\n}\r\n\r\nToastService.toast$ = new Subject();\r\nToastService.events$ = new Subject();\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { ModalService } from './modal.service';\r\n\r\nexport default class ModalOutletComponent extends Component {\r\n\r\n\tget modal() {\r\n\t\treturn this.modal_;\r\n\t}\r\n\r\n\tset modal(modal) {\r\n\t\t// console.log('ModalOutletComponent set modal', modal, this);\r\n\t\tconst { module } = getContext(this);\r\n\t\tif (this.modal_ && this.modal_.node) {\r\n\t\t\tmodule.remove(this.modal_.node, this);\r\n\t\t\tthis.modalNode.removeChild(this.modal_.node);\r\n\t\t}\r\n\t\tif (modal && modal.node) {\r\n\t\t\tthis.modal_ = modal;\r\n\t\t\tthis.modalNode.appendChild(modal.node);\r\n\t\t\tconst instances = module.compile(modal.node);\r\n\t\t}\r\n\t\tthis.modal_ = modal;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tget busy() {\r\n\t\treturn this.busy_;\r\n\t}\r\n\r\n\tset busy(busy) {\r\n\t\t// console.log('ModalOutletComponent set busy', busy, this);\r\n\t\tif (this.busy_ !== busy) {\r\n\t\t\tthis.busy_ = busy;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.busy_ = false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.modalNode = node.querySelector('.modal-outlet__modal');\r\n\t\tModalService.modal$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(modal => this.modal = modal);\r\n\t\tModalService.busy$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(busy => this.busy = busy);\r\n\t}\r\n\r\n\treject(event) {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nModalOutletComponent.meta = {\r\n\tselector: '[modal-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"modal-outlet__container\" [class]=\"{ active: modal, busy: busy }\">\r\n\t\t<div class=\"modal-outlet__background\" (click)=\"reject($event)\"></div>\r\n\t\t<div class=\"modal-outlet__modal\"></div>\r\n\t\t<!-- spinner -->\r\n\t\t<div class=\"spinner spinner--contrasted\" *if=\"busy\"></div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport { ModalService } from '../modal/modal.service';\r\nimport { RoutePipe } from '../router/route.pipe';\r\nimport { RouterService } from '../router/router.service';\r\n\r\nexport default class TryInARModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance, node } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tconst data = this.data = parentInstance.modal.data;\r\n\t\t\t// console.log('data', data);\r\n\t\t\tif (data && data.ar) {\r\n\t\t\t\tconst url = TryInARModalComponent.getUrl(data);\r\n\t\t\t\tconst qrcode = new QRious({\r\n\t\t\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\t\t\tvalue: url,\r\n\t\t\t\t\tsize: 256,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tstatic getUrl(data) {\r\n\t\tconst path = RouterService.buildUrl(RoutePipe.transform(':lang.tryInAr'), { viewId: data.id });\r\n\t\tconst url = window.location.origin + path;\r\n\t\tconsole.log('TryInARModalComponent.getUrl', url);\r\n\t\treturn url;\r\n\t}\r\n\r\n\tstatic openInAR(data) {\r\n\t\tconst url = this.getUrl(data);\r\n\t\twindow.open(url, '_blank');\r\n\t}\r\n\r\n}\r\n\r\nTryInARModalComponent.meta = {\r\n\tselector: '[try-in-ar-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\" [innerHTML]=\"'bhere_ar' | label\"></div>\r\n\t\t\t\t<div class=\"picture\">\r\n\t\t\t\t\t<canvas class=\"qrcode\"></canvas>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--accept\" (click)=\"onClose()\">\r\n\t\t\t\t\t\t<span [innerHTML]=\"'close' | label\"></span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nTryInARModalComponent.chunk = () => /* html */'<div class=\"try-in-ar-modal\" try-in-ar-modal></div>';\r\n\r\n","import { environment } from '../environment';\r\n\r\nexport const EXT_IMAGE = [\r\n\t'jpeg', 'jpg', 'png', 'hdr'\r\n];\r\nexport const EXT_VIDEO = [\r\n\t'mp4', 'webm',\r\n];\r\nexport const EXT_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'usdz'\r\n];\r\n\r\nexport const AssetType = {\r\n\tImage: { id: 1, name: 'image' }, // jpg, png, ...\r\n\tVideo: { id: 2, name: 'video' }, // mp4, webm, ...\r\n\tModel: { id: 3, name: 'model' }, // fbx, gltf, glb, usdz ...\r\n\tPublisherStream: { id: 4, name: 'publisher-stream', file: 'publisherStream' }, // valore fisso di file a publisherStream e folder string.empty\r\n\tAttendeeStream: { id: 5, name: 'next-attendee-stream', file: 'nextAttendeeStream' }, // valore fisso di file a nextAttendeeStream e folder string.empty\r\n\tPublisherScreen: { id: 6, name: 'publisher-screen', file: 'publisherScreen' }, // valore fisso di file a publisherScreen e folder string.empty\r\n\tAttendeeScreen: { id: 7, name: 'attendee-screen', file: 'attendeeScreen' }, // valore fisso di file a attendeeScreen e folder string.empty\r\n\tSmartDeviceStream: { id: 8, name: 'smart-device-stream', file: 'smartDeviceStream' }, // valore fisso di file a smartDeviceStream e folder string.empty\r\n};\r\n\r\nexport const AssetGroupType = {\r\n\tImageOrVideo: { id: 1, name: 'Image or Video', ids: [1, 2] },\r\n\t// Model: { id: 2, name: 'Model 3D', ids: [3] },\r\n\tPublisher: { id: 3, name: 'Publisher', ids: [4] },\r\n\tAttendee: { id: 4, name: 'Attendee', ids: [5] },\r\n\t// PublisherScreen: { id: 5, name: 'PublisherScreen', ids: [6] },\r\n\t// AttendeeScreen: { id: 6, name: 'AttendeeScreen', ids: [7] },\r\n};\r\n\r\nexport function AssetGroupTypeInit() {\r\n\t// console.log('environment.flags.editorAssetScreen', environment.flags.editorAssetScreen, environment);\r\n\tif (environment.flags.editorAssetScreen) {\r\n\t\tAssetGroupType.PublisherScreen = { id: 5, name: 'PublisherScreen', ids: [6] };\r\n\t\tAssetGroupType.AttendeeScreen = { id: 6, name: 'AttendeeScreen', ids: [7] };\r\n\t}\r\n\tAssetGroupType.SmartDevice = { id: 7, name: 'Smart Device', ids: [8] };\r\n}\r\n\r\nexport const STREAM_TYPES = [\r\n\tAssetType.PublisherStream.name,\r\n\tAssetType.AttendeeStream.name,\r\n\tAssetType.PublisherScreen.name,\r\n\tAssetType.AttendeeScreen.name,\r\n\tAssetType.SmartDeviceStream.name,\r\n];\r\n\r\nexport function assetIsStream(asset) {\r\n\t// console.log('assetIsStream', asset.type.name, STREAM_TYPES);\r\n\treturn asset && STREAM_TYPES.indexOf(asset.type.name) !== -1;\r\n}\r\n\r\nexport function assetTypeById(id) {\r\n\tconst type = Object.keys(AssetType).reduce((p, key) => {\r\n\t\tconst type = AssetType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetType).map(x => AssetType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeById(id) {\r\n\tconst type = Object.keys(AssetGroupType).reduce((p, key) => {\r\n\t\tconst type = AssetGroupType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetGroupType).map(x => AssetGroupType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeFromItem(item) {\r\n\tlet key;\r\n\tif (item && item.asset) {\r\n\t\tkey = Object.keys(AssetGroupType).find(key => {\r\n\t\t\t// console.log(key, AssetGroupType[key].ids, item.asset.type.id);\r\n\t\t\treturn AssetGroupType[key].ids.indexOf(item.asset.type.id) !== -1;\r\n\t\t});\r\n\t}\r\n\treturn AssetGroupType[key || 'ImageOrVideo'];\r\n}\r\n\r\nexport function assetPayloadFromGroupTypeId(groupTypeId) {\r\n\tconst groupType = assetGroupTypeById(groupTypeId);\r\n\tconst type = assetTypeById(groupType.ids[0]);\r\n\tconst file = type.file;\r\n\tconst asset = {\r\n\t\ttype: type,\r\n\t\tfolder: '',\r\n\t\tfile: file,\r\n\t}\r\n\t// console.log('assetPayloadFromGroupTypeId', asset);\r\n\treturn new Asset(asset);\r\n}\r\n\r\nexport function assetTypeFromPath(path) {\r\n\tconst extension = path.split('.').pop().toLowerCase();\r\n\tif (EXT_IMAGE.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Image;\r\n\t} else if (EXT_VIDEO.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Video;\r\n\t} else if (EXT_MODEL.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Model;\r\n\t}\r\n}\r\n\r\nexport function isAssetType(path, type) {\r\n\tconst assetType = assetTypeFromPath(path);\r\n\treturn assetType === type;\r\n}\r\n\r\nexport class Asset {\r\n\r\n\tstatic allowedProps = ['id', 'type', 'folder', 'file', 'linkedPlayId', 'chromaKeyColor', 'autoplay', 'loop'];\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (Asset.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\r\n\tstatic fromUrl(url) {\r\n\t\tconst segments = url.split('/');\r\n\t\tconst file = segments.pop();\r\n\t\tconst folder = segments.join('/') + '/';\r\n\t\tconst type = assetTypeFromPath(file);\r\n\t\treturn new Asset({\r\n\t\t\ttype: type,\r\n\t\t\tfolder: folder,\r\n\t\t\tfile: file,\r\n\t\t});\r\n\t}\r\n\r\n\tstatic get defaultMediaAsset() {\r\n\t\tconst asset = {\r\n\t\t\tid: -1,\r\n\t\t\ttype: { id: AssetType.Image, name: 'image' },\r\n\t\t\tfolder: '/textures/grid/',\r\n\t\t\tfile: 'grid.jpg',\r\n\t\t};\r\n\t\treturn asset;\r\n\t}\r\n}\r\n\r\nexport function mapAsset(asset) {\r\n\tswitch (asset.type.name) {\r\n\t\tdefault:\r\n\t\t\tasset = new Asset(asset);\r\n\t}\r\n\treturn asset;\r\n}\r\n","import { BehaviorSubject, combineLatest, of } from 'rxjs';\r\nimport { distinctUntilChanged, map, shareReplay, tap } from 'rxjs/operators';\r\nimport { AssetType } from '../asset/asset';\r\nimport { environment } from '../environment';\r\nimport { HttpService } from '../http/http.service';\r\nimport { LanguageService } from '../language/language.service';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport StateService from '../state/state.service';\r\nimport { mapView, ViewItemType, ViewType } from '../view/view';\r\n\r\nexport const DEFAULT_WAITING_ROOM = {\r\n\tid: 'waiting-room',\r\n\ttype: { id: 1, name: 'waiting-room' },\r\n\tname: 'Waiting Room',\r\n\tlikes: 0,\r\n\tliked: false,\r\n\tasset: {\r\n\t\ttype: { id: 1, name: 'image' },\r\n\t\tfolder: '/textures/waiting-room/',\r\n\t\tfile: 'waiting-room.jpg',\r\n\t},\r\n\titems: [],\r\n\torientation: {\r\n\t\tlatitude: 0,\r\n\t\tlongitude: 0\r\n\t}\r\n};\r\nexport class ViewService {\r\n\r\n\tstatic get dataViews() {\r\n\t\treturn this.data ? this.data.views : [];\r\n\t}\r\n\r\n\tstatic get validViews() {\r\n\t\treturn this.data ? this.data.views.filter(x => x.type.name !== ViewType.WaitingRoom.name) : [];\r\n\t}\r\n\r\n\tstatic get pathViews() {\r\n\t\tconst views = this.validViews;\r\n\t\treturn views.filter(x => x.path);\r\n\t}\r\n\r\n\tstatic get validPathViews() {\r\n\t\tconst views = this.editor ? this.data.views : this.validViews;\r\n\t\treturn views.filter(x => x.path);\r\n\t}\r\n\r\n\t// action: { viewId:number, keepOrientation:boolean, useLastOrientation:boolean };\r\n\tstatic action$_ = new BehaviorSubject(null);\r\n\tstatic set action(action) {\r\n\t\tthis.action$_.next(action);\r\n\t}\r\n\tstatic get action() {\r\n\t\treturn this.action$_.getValue();\r\n\t}\r\n\r\n\t// static viewId$_ = new BehaviorSubject(null);\r\n\tstatic set viewId(viewId) {\r\n\t\tthis.action$_.next({ viewId, keepOrientation: false, useLastOrientation: false });\r\n\t}\r\n\tstatic get viewId() {\r\n\t\tconst action = this.action$_.getValue();\r\n\t\treturn action ? action.viewId : null;\r\n\t}\r\n\r\n\tstatic getDataView(viewId) {\r\n\t\tconst views = this.dataViews;\r\n\t\treturn views.find(x => x.id === viewId) || null;\r\n\t}\r\n\r\n\tstatic get currentView() {\r\n\t\tconst viewId = this.viewId;\r\n\t\tif (viewId !== null) {\r\n\t\t\treturn this.getDataView(viewId);\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tstatic getValidPathId(viewId) {\r\n\t\tif (!viewId) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tconst views = this.validPathViews;\r\n\t\tif (views.find(x => x.id === viewId) == null) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\treturn viewId;\r\n\t}\r\n\r\n\tstatic getFirstPathId() {\r\n\t\tconst views = (this.editor && this.path.id === null) ? this.dataViews : this.pathViews;\r\n\t\t// console.log('ViewService.getFirstPathId', this.editor, this.path, views);\r\n\t\treturn views.length ? views[0].id : null;\r\n\t}\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tconst dataUrl = (environment.flags.production ? '/api/view' : `${environment.assets}api/data.json`) + '?lang=' + LanguageService.lang;\r\n\t\t\tthis.data$_ = HttpService.get$(dataUrl).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\tthis.data = data;\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic view$() {\r\n\t\t// const editor = this.editor;\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\t// const pathId = meetingUrl.pathId;\r\n\t\tconst viewId = this.getValidPathId(meetingUrl.viewId);\r\n\t\tconst embedViewId = this.getValidPathId(meetingUrl.embedViewId);\r\n\t\tconst initialViewId = embedViewId || viewId || this.getFirstPathId();\r\n\t\t// console.log('ViewService.view$', viewId, embedViewId, initialViewId);\r\n\t\tthis.action$_.next({ viewId: initialViewId });\r\n\t\treturn this.action$_.pipe(\r\n\t\t\tdistinctUntilChanged((a, b) => a.viewId === b.viewId),\r\n\t\t\tmap(action => {\r\n\t\t\t\t// const view = data.views.find(view => view.id === action.viewId);\r\n\t\t\t\t// console.log('ViewService.view$', 'path', path);\r\n\t\t\t\t// filter path\r\n\t\t\t\tlet view = this.dataViews.find(view => view.id === action.viewId);\r\n\t\t\t\t/*\r\n\t\t\t\tif (path && !editor) {\r\n\t\t\t\t\tif (path.items.indexOf(view.id) === -1) {\r\n\t\t\t\t\t\tconst newView = Object.assign({}, view);\r\n\t\t\t\t\t\tnewView.items = view.items.filter(x => {\r\n\t\t\t\t\t\t\tif (x.type.name === ViewItemType.Nav.name) {\r\n\t\t\t\t\t\t\t\treturn path.items.indexOf(x.viewId) === -1;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tview = mapView(newView);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tview = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('ViewService.view$', view, path);\r\n\t\t\t\t*/\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.keepOrientation = action.keepOrientation || false;\r\n\t\t\t\t\tview.useLastOrientation = action.useLastOrientation || false;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('ViewService.view$', action.viewId, action.keepOrientation, action.useLastOrientation);\r\n\t\t\t\treturn view || this.getWaitingRoom();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic setDataAndPath(data, path) {\r\n\t\tthis.data = data;\r\n\t\tdata.views.forEach(view => {\r\n\t\t\tview.path = !path || path.items.indexOf(view.id) === -1;\r\n\t\t\tview.items.forEach(item => {\r\n\t\t\t\tlet valid = true;\r\n\t\t\t\tif (path) {\r\n\t\t\t\t\tif (item.type.name === ViewItemType.Nav.name) {\r\n\t\t\t\t\t\tvalid = path.items.indexOf(item.viewId) === -1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\titem.path = valid;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\tthis.path = path;\r\n\t}\r\n\r\n\tstatic hostedView$(data, path) {\r\n\t\tthis.setDataAndPath(data, path);\r\n\t\tthis.editor = false;\r\n\t\tconst waitingRoom = this.getWaitingRoom();\r\n\t\treturn combineLatest([this.view$(), this.hosted$()]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst view = datas[0];\r\n\t\t\t\tconst hosted = datas[1];\r\n\t\t\t\treturn hosted ? view : waitingRoom;\r\n\t\t\t}),\r\n\t\t\tdistinctUntilChanged((a, b) => {\r\n\t\t\t\treturn a.id === b.id;\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\tMeetingUrl.replaceWithOptions({ viewId: view.id });\r\n\t\t\t\t\tconst prefetchAssets = ViewService.getPrefetchAssets(view);\r\n\t\t\t\t\tview.prefetchAssets = prefetchAssets;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic editorView$(data, path) {\r\n\t\tthis.setDataAndPath(data, path);\r\n\t\tthis.editor = true;\r\n\t\tconst waitingRoom = this.getWaitingRoom();\r\n\t\treturn this.view$().pipe(\r\n\t\t\tmap(view => {\r\n\t\t\t\t// console.log('ViewService.editorView$.view', view.updateIndices);\r\n\t\t\t\tconst options = {\r\n\t\t\t\t\tpathId: null,\r\n\t\t\t\t};\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\toptions.viewId = view.id;\r\n\t\t\t\t}\r\n\t\t\t\tif (path && path.id !== null) {\r\n\t\t\t\t\toptions.pathId = path.id;\r\n\t\t\t\t}\r\n\t\t\t\tMeetingUrl.replaceWithOptions(options);\r\n\t\t\t\treturn view;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic hosted$() {\r\n\t\treturn StateService.state$.pipe(\r\n\t\t\tmap(state => state.hosted),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewById$(viewId) {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => this.dataViews.find(x => x.id === viewId))\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewLike$(view) {\r\n\t\tif (!view.liked) {\r\n\t\t\tview.liked = true;\r\n\t\t\tif (environment.flags.production) {\r\n\t\t\t\treturn HttpService.get$(`/api/view/${view.id}/like`);\r\n\t\t\t} else {\r\n\t\t\t\tview.likes = view.likes || 0;\r\n\t\t\t\tview.likes++;\r\n\t\t\t\treturn of(view);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic setViewLike$(message) {\r\n\t\treturn this.viewById$(message.viewId).pipe(\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.likes = message.likes;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getWaitingRoom() {\r\n\t\treturn this.dataViews.find(x => x.type.name === ViewType.WaitingRoom.name) || DEFAULT_WAITING_ROOM;\r\n\t}\r\n\r\n\tstatic getPrefetchAssets(view) {\r\n\t\tconst views = this.validPathViews;\r\n\t\tconst assets = view.items\r\n\t\t\t// filter nav items\r\n\t\t\t.filter(x => x.type.name === ViewItemType.Nav.name && x.viewId != null)\r\n\t\t\t// map to view\r\n\t\t\t.map(x => views.find(v => v.id === x.viewId))\r\n\t\t\t// filter view with image\r\n\t\t\t.filter(v => v && v.asset && v.asset.type.name === AssetType.Image.name)\r\n\t\t\t// map to asset\r\n\t\t\t.map(v => environment.getPath(v.asset.folder + v.asset.file));\r\n\t\t// console.log('ViewService.getPrefetchAssets', assets);\r\n\t\treturn assets;\r\n\t}\r\n\r\n\tstatic addView(view) {\r\n\t\tconst data = this.data;\r\n\t\tconst views = data.views.slice();\r\n\t\tviews.push(view);\r\n\t\tdata.views = views;\r\n\t\tthis.viewId = view.id;\r\n\t}\r\n\r\n\tstatic deleteView(view) {\r\n\t\tconst data = this.data;\r\n\t\tconst views = data.views.slice();\r\n\t\tconst index = views.reduce((p, c, i) => {\r\n\t\t\treturn c.id === view.id ? i : p;\r\n\t\t}, -1);\r\n\t\tif (index > 0) {\r\n\t\t\tviews.splice(index, 1);\r\n\t\t\tdata.views = views;\r\n\t\t\tconst dataViews = this.dataViews;\r\n\t\t\tif (dataViews.length > 0) {\r\n\t\t\t\tthis.viewId = dataViews[0].id;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// this.pushChanges();\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport { LocalStorageService } from '../storage/local-storage.service';\r\n\r\nlet items$_ = null;\r\n\r\nexport class WishlistService {\r\n\r\n\tstatic get items$() {\r\n\t\tif (!items$_) {\r\n\t\t\tconst items = LocalStorageService.get('wishlist') || [];\r\n\t\t\titems$_ = new BehaviorSubject(items);\r\n\t\t}\r\n\t\treturn items$_;\r\n\t}\r\n\r\n\tstatic getItems() {\r\n\t\treturn this.items$.getValue();\r\n\t}\r\n\r\n\tstatic indexOf(item) {\r\n\t\tconst items = this.getItems();\r\n\t\treturn items.reduce((p, c, i) => {\r\n\t\t\treturn (p === -1 && c.viewId === item.viewId && c.itemId === item.itemId) ? i : p;\r\n\t\t}, -1);\r\n\t}\r\n\r\n\tstatic has(item) {\r\n\t\treturn this.indexOf(item) !== -1;\r\n\t}\r\n\r\n\tstatic add$(item) {\r\n\t\tconst items = this.getItems();\r\n\t\tif (!this.has(item)) {\r\n\t\t\titems.push(item);\r\n\t\t\tLocalStorageService.set('wishlist', items);\r\n\t\t\tthis.items$.next(items);\r\n\t\t}\r\n\t\treturn this.items$;\r\n\t}\r\n\r\n\tstatic remove$(item) {\r\n\t\tconst items = this.getItems();\r\n\t\tconst index = this.indexOf(item);\r\n\t\tif (index !== -1) {\r\n\t\t\titems.splice(index, 1);\r\n\t\t\tLocalStorageService.set('wishlist', items);\r\n\t\t\tthis.items$.next(items);\r\n\t\t}\r\n\t\treturn this.items$;\r\n\t}\r\n\r\n\tstatic toggle$(item) {\r\n\t\tconst items = this.getItems();\r\n\t\tconst index = this.indexOf(item);\r\n\t\tif (index !== -1) {\r\n\t\t\titems.splice(index, 1);\r\n\t\t\tLocalStorageService.set('wishlist', items);\r\n\t\t\tthis.items$.next(items);\r\n\t\t} else {\r\n\t\t\titems.push(item);\r\n\t\t\tLocalStorageService.set('wishlist', items);\r\n\t\t\tthis.items$.next(items);\r\n\t\t}\r\n\t\treturn this.items$;\r\n\t}\r\n\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\nimport { assetIsStream, AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StateService from '../../state/state.service';\r\nimport { RoleType } from '../../user/user';\r\n\r\nexport class MediaLoaderEvent {\r\n\tconstructor(loader) {\r\n\t\tthis.loader = loader;\r\n\t}\r\n}\r\n\r\nexport class MediaLoaderPlayEvent extends MediaLoaderEvent { }\r\n\r\nexport class MediaLoaderPauseEvent extends MediaLoaderEvent { }\r\n\r\nexport class MediaLoaderDisposeEvent extends MediaLoaderEvent { }\r\n\r\nexport class MediaLoaderTimeUpdateEvent extends MediaLoaderEvent { }\r\n\r\nexport class MediaLoaderTimeSetEvent extends MediaLoaderEvent { }\r\n\r\nexport default class MediaLoader {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn MediaLoader.loader || (MediaLoader.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getPath(item) {\r\n\t\treturn environment.getPath(item.asset.folder + item.asset.file);\r\n\t}\r\n\r\n\tstatic loadTexture(item, callback) {\r\n\t\tconst path = MediaLoader.getPath(item);\r\n\t\treturn MediaLoader.getLoader().load(path, callback);\r\n\t}\r\n\r\n\tstatic isVideo(item) {\r\n\t\treturn item.asset && item.asset.file && (item.asset.file.indexOf('.mp4') !== -1 || item.asset.file.indexOf('.webm') !== -1);\r\n\t}\r\n\r\n\tstatic isStream(item) {\r\n\t\treturn assetIsStream(item.asset);\r\n\t}\r\n\r\n\tstatic isMutedStream(item) {\r\n\t\tlet isMutedStream = false;\r\n\t\tswitch (item.asset.type.name) {\r\n\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tisMutedStream = StateService.state.role === RoleType.Publisher;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tisMutedStream = StateService.state.role === RoleType.Attendee;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tisMutedStream = true;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tisMutedStream = true;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\tisMutedStream = StateService.state.role === RoleType.SmartDevice;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t}\r\n\t\t// console.log('isMutedStream', isMutedStream, item.asset.type.name, AssetType.PublisherStream.name, StateService.state.role, RoleType.Publisher);\r\n\t\treturn isMutedStream;\r\n\t}\r\n\r\n\tstatic isPublisherStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherStream.name;\r\n\t}\r\n\r\n\tstatic isAttendeeStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeStream.name;\r\n\t}\r\n\r\n\tstatic isSmartDeviceStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.SmartDeviceStream.name;\r\n\t}\r\n\r\n\tstatic isPublisherScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherScreen.name;\r\n\t}\r\n\r\n\tstatic isAttendeeScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeScreen.name;\r\n\t}\r\n\r\n\tget isVideo() {\r\n\t\treturn MediaLoader.isVideo(this.item);\r\n\t}\r\n\r\n\tget isStream() {\r\n\t\treturn MediaLoader.isStream(this.item);\r\n\t}\r\n\r\n\tget isMutedStream() {\r\n\t\treturn MediaLoader.isMutedStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherStream() {\r\n\t\treturn MediaLoader.isPublisherStream(this.item);\r\n\t}\r\n\r\n\tget isAttendeeStream() {\r\n\t\treturn MediaLoader.isAttendeeStream(this.item);\r\n\t}\r\n\r\n\tget isSmartDeviceStream() {\r\n\t\treturn MediaLoader.isSmartDeviceStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherScreen() {\r\n\t\treturn MediaLoader.isPublisherScreen(this.item);\r\n\t}\r\n\r\n\tget isAttendeeScreen() {\r\n\t\treturn MediaLoader.isAttendeeScreen(this.item);\r\n\t}\r\n\r\n\tget isPlayableVideo() {\r\n\t\treturn this.isVideo; // && !this.item.asset.autoplay;\r\n\t}\r\n\r\n\tget isAutoplayVideo() {\r\n\t\treturn this.isStream; // || (this.isVideo && (this.item.asset.autoplay != null));\r\n\t}\r\n\r\n\tget muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tset muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('MediaLoader.muted', muted, this.video);\r\n\t\tif (this.video && this.isVideo) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(item) {\r\n\t\tthis.item = item;\r\n\t\tthis.toggle = this.toggle.bind(this);\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => this.muted = state.volumeMuted);\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tconst item = this.item;\r\n\t\tlet texture;\r\n\t\t// console.log('MediaLoader.load', item, this.isStream);\r\n\t\tif (this.isStream && item.streamId) {\r\n\t\t\tconst streamId = item.streamId;\r\n\t\t\tconst video = document.querySelector(`#stream-${streamId} video`); // document.querySelector(`#stream-remote-${streamId} video`) || document.querySelector(`#stream-local-${streamId} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tif (this.disposed) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tvideo.removeEventListener('canplay', onCanPlay);\r\n\t\t\t\ttexture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tconst isMutedStream = this.isMutedStream;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tvideo.volume = isMutedStream ? 0 : 1;\r\n\t\t\tvideo.muted = isMutedStream;\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonCanPlay();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.addEventListener('canplay', onCanPlay);\r\n\t\t\t}\r\n\t\t} else if (this.isVideo) {\r\n\t\t\t// create the video element\r\n\t\t\tconst autoplay = (item.asset && item.asset.autoplay) || false;\r\n\t\t\tconst loop = (item.asset && item.asset.loop) || false;\r\n\t\t\tconst video = this.video = document.createElement('video');\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tvideo.preload = 'metadata';\r\n\t\t\tvideo.volume = 0.8;\r\n\t\t\tvideo.muted = autoplay;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.loop = loop;\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tif (this.disposed) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('MediaLoader', 'onCanPlay');\r\n\t\t\t\tvideo.oncanplay = null;\r\n\t\t\t\ttexture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.encoding = THREE.sRGBEncoding;\r\n\t\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t\tif (autoplay) {\r\n\t\t\t\t\tthis.play(item.silent);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvideo.pause();\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tconst onTimeUpdate = () => {\r\n\t\t\t\tif (this.disposed) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderTimeUpdateEvent(this));\r\n\t\t\t};\r\n\t\t\tconst onEnded = () => {\r\n\t\t\t\tif (this.disposed) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (!loop) {\r\n\t\t\t\t\tMediaLoader.events$.next(new MediaLoaderPauseEvent(this));\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.oncanplay = onCanPlay;\r\n\t\t\tvideo.ontimeupdate = onTimeUpdate;\r\n\t\t\tvideo.onended = onEnded;\r\n\t\t\tvideo.src = MediaLoader.getPath(item);\r\n\t\t\tvideo.load(); // must call after setting/changing source\r\n\t\t} else if (item.asset) {\r\n\t\t\tMediaLoader.loadTexture(item, (texture) => {\r\n\t\t\t\tif (this.disposed) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t\ttexture.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\ttexture.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tcallback(null, this);\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\r\n\tget progress() {\r\n\t\tif (this.video) {\r\n\t\t\treturn this.video.currentTime / this.video.duration;\r\n\t\t} else {\r\n\t\t\treturn 0;\r\n\t\t}\r\n\t}\r\n\tset progress(progress) {\r\n\t\tif (this.video) {\r\n\t\t\tconst currentTime = this.video.duration * progress;\r\n\t\t\tif (this.video.seekable.length > progress && this.video.currentTime !== currentTime) {\r\n\t\t\t\t// console.log('MediaLoader', 'progress', progress, 'currentTime', currentTime, 'duration', this.video.duration, 'seekable', this.video.seekable);\r\n\t\t\t\tthis.video.currentTime = currentTime;\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderTimeSetEvent(this));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tplay(silent) {\r\n\t\t// console.log('MediaLoader.play');\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = this.muted_;\r\n\t\t\tthis.video.play().then(() => {\r\n\t\t\t\t// console.log('MediaLoader.play.success', this.item.asset.file);\r\n\t\t\t\tif (!silent) {\r\n\t\t\t\t\tMediaLoader.events$.next(new MediaLoaderPlayEvent(this));\r\n\t\t\t\t}\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('MediaLoader.play.error', this.item.asset.file, error);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tpause(silent) {\r\n\t\t// console.log('MediaLoader.pause');\r\n\t\tif (this.video && this.isVideo) {\r\n\t\t\tthis.video.muted = true;\r\n\t\t\tthis.video.pause();\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPauseEvent(this));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggle() {\r\n\t\t// console.log('MediaLoader.toggle', this.video);\r\n\t\tif (this.video && this.isVideo) {\r\n\t\t\tif (this.video.paused) {\r\n\t\t\t\tthis.video.muted = this.muted_;\r\n\t\t\t\tthis.play();\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.pause();\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\t// console.log('MediaLoader.dispose');\r\n\t\tthis.subscription.unsubscribe();\r\n\t\tthis.pause(true);\r\n\t\tif (this.isVideo && this.video) {\r\n\t\t\tthis.video.ontimeupdate = null;\r\n\t\t\tthis.video.onended = null;\r\n\t\t\tMediaLoader.events$.next(new MediaLoaderDisposeEvent(this));\r\n\t\t}\r\n\t\tthis.disposed = true;\r\n\t\tdelete this.video;\r\n\t}\r\n\r\n}\r\n\r\nMediaLoader.events$ = new ReplaySubject(1);\r\n","export const PANORAMA_RADIUS = 101;\r\n\r\nexport class Geometry {\r\n\r\n\tstatic get defaultGeometry() {\r\n\t\treturn Geometry.defaultGeometry_ || (Geometry.defaultGeometry_ = new THREE.BoxBufferGeometry(1, 1, 1));\r\n\t}\r\n\r\n\tstatic get planeGeometry() {\r\n\t\treturn Geometry.planeGeometry_ || (Geometry.planeGeometry_ = new THREE.PlaneBufferGeometry(1, 1, 2, 2));\r\n\t}\r\n\r\n\tstatic get sphereGeometry() {\r\n\t\treturn Geometry.sphereGeometry_ || (Geometry.sphereGeometry_ = new THREE.SphereBufferGeometry(3, 12, 12));\r\n\t}\r\n\r\n\tstatic get panoramaGeometry() {\r\n\t\treturn Geometry.panoramaGeometry_ || (Geometry.panoramaGeometry_ = new THREE.SphereBufferGeometry(PANORAMA_RADIUS, 36, 36)); // 101, 44, 30\r\n\t\t// return Geometry.panoramaGeometry_ || (Geometry.panoramaGeometry_ = new THREE.IcosahedronBufferGeometry(PANORAMA_RADIUS, 4)); // 101, 44, 30\r\n\t\t// return Geometry.panoramaGeometry_ || (Geometry.panoramaGeometry_ = new THREE.SphereBufferGeometry(PANORAMA_RADIUS, 40, 40)); // 101, 44, 30\r\n\t}\r\n\r\n}\r\n","export const ORIGIN = new THREE.Vector3();\r\n\r\nexport class Host {\r\n\r\n\tstatic origin_ = new THREE.Vector3();\r\n\tstatic get origin() {\r\n\t\tconst host = this.host;\r\n\t\tif (host) {\r\n\t\t\tconst origin = this.origin_;\r\n\t\t\torigin.set(0, 0, 0);\r\n\t\t\tconst camera = host.renderer.xr.isPresenting ? host.renderer.xr.getCamera(host.camera) : host.camera;\r\n\t\t\tcamera.localToWorld(origin);\r\n\t\t\t// return host.cameraGroup.position;\r\n\t\t}\r\n\t\treturn this.origin_;\r\n\t}\r\n\r\n\tstatic getDistanceToCamera(camera, fov, aspect, size, fitOffset = 0.88) {\r\n\t\tconst factor = (2 * Math.atan(Math.PI * fov / 360));\r\n\t\tconst heightDistance = size.y * camera.zoom / factor;\r\n\t\tconst widthDistance = size.x * camera.zoom / factor / aspect;\r\n\t\tconst distance = fitOffset * Math.max(heightDistance, widthDistance);\r\n\t\treturn distance;\r\n\t}\r\n\r\n}\r\n","// import DebugService from '../debug.service';\r\n\r\nconst defaultEvent = {};\r\n\r\nexport default class Interactive { }\r\n\r\nInteractive.items = [];\r\nInteractive.hittest = interactiveHittest.bind(Interactive);\r\nInteractive.dispose = interactiveDispose.bind(Interactive);\r\n\r\nexport function interactiveHittest(raycaster, down = false, event = defaultEvent) {\r\n\t// const debugService = DebugService.getService();\r\n\tlet dirty = false;\r\n\tif (this.down !== down) {\r\n\t\tthis.down = down;\r\n\t\tthis.lock = false;\r\n\t\tdirty = true;\r\n\t}\r\n\tconst items = this.items.filter(x => x.parent && !x.freezed);\r\n\tconst intersections = raycaster.intersectObjects(items);\r\n\tlet key, hit;\r\n\tconst hash = {};\r\n\tintersections.forEach((intersection, i) => {\r\n\t\tconst object = intersection.object;\r\n\t\tkey = object.uuid;\r\n\t\tif (i === 0) {\r\n\t\t\tif (this.lastIntersectedObject !== object || dirty) {\r\n\t\t\t\tthis.lastIntersectedObject = object;\r\n\t\t\t\thit = object;\r\n\t\t\t\t// debugService.setMessage(hit.name || hit.id);\r\n\t\t\t\t// haptic feedback\r\n\t\t\t} else if (\r\n\t\t\t\tobject.intersection && (\r\n\t\t\t\t\tMath.abs(object.intersection.point.x - intersection.point.x) > 0.01 ||\r\n\t\t\t\t\tMath.abs(object.intersection.point.y - intersection.point.y) > 0.01\r\n\t\t\t\t)\r\n\t\t\t) {\r\n\t\t\t\tobject.intersection = intersection;\r\n\t\t\t\tobject.emit('move', object);\r\n\t\t\t}\r\n\t\t}\r\n\t\thash[key] = intersection;\r\n\t});\r\n\tif (intersections.length === 0) {\r\n\t\tthis.lastIntersectedObject = null;\r\n\t}\r\n\titems.forEach(x => {\r\n\t\tx.intersection = hash[x.uuid];\r\n\t\tx.over = (x === this.lastIntersectedObject) || (x.intersection && !x.depthTest && (!this.lastIntersectedObject || this.lastIntersectedObject.depthTest));\r\n\t\tx.down = down && x.over && !this.lock;\r\n\t\tif (x.down) {\r\n\t\t\tthis.lock = true;\r\n\t\t}\r\n\t});\r\n\treturn hit;\r\n}\r\n\r\nexport function interactiveDispose(object) {\r\n\tif (object) {\r\n\t\tconst index = this.items.indexOf(object);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.items.splice(index, 1);\r\n\t\t}\r\n\t}\r\n}\r\n","import { Mesh } from 'three';\r\nimport { Geometry } from '../geometry/geometry';\r\n\r\nexport default class FreezableMesh extends Mesh {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || Geometry.defaultGeometry;\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import { Geometry } from '../geometry/geometry';\r\nimport FreezableMesh from './freezable.mesh';\r\n\r\nexport default class EmittableMesh extends FreezableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || Geometry.defaultGeometry;\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import EmittableMesh from './emittable.mesh';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveMesh extends EmittableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tsuper(geometry, material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveMesh() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import {\n\tDataTextureLoader,\n\tDataUtils,\n\tFloatType,\n\tHalfFloatType,\n\tLinearEncoding,\n\tLinearFilter\n} from 'three';\n\n// https://github.com/mrdoob/three.js/issues/5552\n// http://en.wikipedia.org/wiki/RGBE_image_format\n\nclass RGBELoader extends DataTextureLoader {\n\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t\tthis.type = HalfFloatType;\n\n\t}\n\n\t// adapted from http://www.graphics.cornell.edu/~bjw/rgbe.html\n\n\tparse( buffer ) {\n\n\t\tconst\n\t\t\t/* return codes for rgbe routines */\n\t\t\t//RGBE_RETURN_SUCCESS = 0,\n\t\t\tRGBE_RETURN_FAILURE = - 1,\n\n\t\t\t/* default error routine.  change this to change error handling */\n\t\t\trgbe_read_error = 1,\n\t\t\trgbe_write_error = 2,\n\t\t\trgbe_format_error = 3,\n\t\t\trgbe_memory_error = 4,\n\t\t\trgbe_error = function ( rgbe_error_code, msg ) {\n\n\t\t\t\tswitch ( rgbe_error_code ) {\n\n\t\t\t\t\tcase rgbe_read_error: console.error( 'THREE.RGBELoader Read Error: ' + ( msg || '' ) );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase rgbe_write_error: console.error( 'THREE.RGBELoader Write Error: ' + ( msg || '' ) );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase rgbe_format_error: console.error( 'THREE.RGBELoader Bad File Format: ' + ( msg || '' ) );\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\tcase rgbe_memory_error: console.error( 'THREE.RGBELoader: Error: ' + ( msg || '' ) );\n\n\t\t\t\t}\n\n\t\t\t\treturn RGBE_RETURN_FAILURE;\n\n\t\t\t},\n\n\t\t\t/* offsets to red, green, and blue components in a data (float) pixel */\n\t\t\t//RGBE_DATA_RED = 0,\n\t\t\t//RGBE_DATA_GREEN = 1,\n\t\t\t//RGBE_DATA_BLUE = 2,\n\n\t\t\t/* number of floats per pixel, use 4 since stored in rgba image format */\n\t\t\t//RGBE_DATA_SIZE = 4,\n\n\t\t\t/* flags indicating which fields in an rgbe_header_info are valid */\n\t\t\tRGBE_VALID_PROGRAMTYPE = 1,\n\t\t\tRGBE_VALID_FORMAT = 2,\n\t\t\tRGBE_VALID_DIMENSIONS = 4,\n\n\t\t\tNEWLINE = '\\n',\n\n\t\t\tfgets = function ( buffer, lineLimit, consume ) {\n\n\t\t\t\tconst chunkSize = 128;\n\n\t\t\t\tlineLimit = ! lineLimit ? 1024 : lineLimit;\n\t\t\t\tlet p = buffer.pos,\n\t\t\t\t\ti = - 1, len = 0, s = '',\n\t\t\t\t\tchunk = String.fromCharCode.apply( null, new Uint16Array( buffer.subarray( p, p + chunkSize ) ) );\n\n\t\t\t\twhile ( ( 0 > ( i = chunk.indexOf( NEWLINE ) ) ) && ( len < lineLimit ) && ( p < buffer.byteLength ) ) {\n\n\t\t\t\t\ts += chunk; len += chunk.length;\n\t\t\t\t\tp += chunkSize;\n\t\t\t\t\tchunk += String.fromCharCode.apply( null, new Uint16Array( buffer.subarray( p, p + chunkSize ) ) );\n\n\t\t\t\t}\n\n\t\t\t\tif ( - 1 < i ) {\n\n\t\t\t\t\t/*for (i=l-1; i>=0; i--) {\n\t\t\t\t\t\tbyteCode = m.charCodeAt(i);\n\t\t\t\t\t\tif (byteCode > 0x7f && byteCode <= 0x7ff) byteLen++;\n\t\t\t\t\t\telse if (byteCode > 0x7ff && byteCode <= 0xffff) byteLen += 2;\n\t\t\t\t\t\tif (byteCode >= 0xDC00 && byteCode <= 0xDFFF) i--; //trail surrogate\n\t\t\t\t\t}*/\n\t\t\t\t\tif ( false !== consume ) buffer.pos += len + i + 1;\n\t\t\t\t\treturn s + chunk.slice( 0, i );\n\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\n\t\t\t},\n\n\t\t\t/* minimal header reading.  modify if you want to parse more information */\n\t\t\tRGBE_ReadHeader = function ( buffer ) {\n\n\n\t\t\t\t// regexes to parse header info fields\n\t\t\t\tconst magic_token_re = /^#\\?(\\S+)/,\n\t\t\t\t\tgamma_re = /^\\s*GAMMA\\s*=\\s*(\\d+(\\.\\d+)?)\\s*$/,\n\t\t\t\t\texposure_re = /^\\s*EXPOSURE\\s*=\\s*(\\d+(\\.\\d+)?)\\s*$/,\n\t\t\t\t\tformat_re = /^\\s*FORMAT=(\\S+)\\s*$/,\n\t\t\t\t\tdimensions_re = /^\\s*\\-Y\\s+(\\d+)\\s+\\+X\\s+(\\d+)\\s*$/,\n\n\t\t\t\t\t// RGBE format header struct\n\t\t\t\t\theader = {\n\n\t\t\t\t\t\tvalid: 0, /* indicate which fields are valid */\n\n\t\t\t\t\t\tstring: '', /* the actual header string */\n\n\t\t\t\t\t\tcomments: '', /* comments found in header */\n\n\t\t\t\t\t\tprogramtype: 'RGBE', /* listed at beginning of file to identify it after \"#?\". defaults to \"RGBE\" */\n\n\t\t\t\t\t\tformat: '', /* RGBE format, default 32-bit_rle_rgbe */\n\n\t\t\t\t\t\tgamma: 1.0, /* image has already been gamma corrected with given gamma. defaults to 1.0 (no correction) */\n\n\t\t\t\t\t\texposure: 1.0, /* a value of 1.0 in an image corresponds to <exposure> watts/steradian/m^2. defaults to 1.0 */\n\n\t\t\t\t\t\twidth: 0, height: 0 /* image dimensions, width/height */\n\n\t\t\t\t\t};\n\n\t\t\t\tlet line, match;\n\n\t\t\t\tif ( buffer.pos >= buffer.byteLength || ! ( line = fgets( buffer ) ) ) {\n\n\t\t\t\t\treturn rgbe_error( rgbe_read_error, 'no header found' );\n\n\t\t\t\t}\n\n\t\t\t\t/* if you want to require the magic token then uncomment the next line */\n\t\t\t\tif ( ! ( match = line.match( magic_token_re ) ) ) {\n\n\t\t\t\t\treturn rgbe_error( rgbe_format_error, 'bad initial token' );\n\n\t\t\t\t}\n\n\t\t\t\theader.valid |= RGBE_VALID_PROGRAMTYPE;\n\t\t\t\theader.programtype = match[ 1 ];\n\t\t\t\theader.string += line + '\\n';\n\n\t\t\t\twhile ( true ) {\n\n\t\t\t\t\tline = fgets( buffer );\n\t\t\t\t\tif ( false === line ) break;\n\t\t\t\t\theader.string += line + '\\n';\n\n\t\t\t\t\tif ( '#' === line.charAt( 0 ) ) {\n\n\t\t\t\t\t\theader.comments += line + '\\n';\n\t\t\t\t\t\tcontinue; // comment line\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( match = line.match( gamma_re ) ) {\n\n\t\t\t\t\t\theader.gamma = parseFloat( match[ 1 ] );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( match = line.match( exposure_re ) ) {\n\n\t\t\t\t\t\theader.exposure = parseFloat( match[ 1 ] );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( match = line.match( format_re ) ) {\n\n\t\t\t\t\t\theader.valid |= RGBE_VALID_FORMAT;\n\t\t\t\t\t\theader.format = match[ 1 ];//'32-bit_rle_rgbe';\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( match = line.match( dimensions_re ) ) {\n\n\t\t\t\t\t\theader.valid |= RGBE_VALID_DIMENSIONS;\n\t\t\t\t\t\theader.height = parseInt( match[ 1 ], 10 );\n\t\t\t\t\t\theader.width = parseInt( match[ 2 ], 10 );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( ( header.valid & RGBE_VALID_FORMAT ) && ( header.valid & RGBE_VALID_DIMENSIONS ) ) break;\n\n\t\t\t\t}\n\n\t\t\t\tif ( ! ( header.valid & RGBE_VALID_FORMAT ) ) {\n\n\t\t\t\t\treturn rgbe_error( rgbe_format_error, 'missing format specifier' );\n\n\t\t\t\t}\n\n\t\t\t\tif ( ! ( header.valid & RGBE_VALID_DIMENSIONS ) ) {\n\n\t\t\t\t\treturn rgbe_error( rgbe_format_error, 'missing image size specifier' );\n\n\t\t\t\t}\n\n\t\t\t\treturn header;\n\n\t\t\t},\n\n\t\t\tRGBE_ReadPixels_RLE = function ( buffer, w, h ) {\n\n\t\t\t\tconst scanline_width = w;\n\n\t\t\t\tif (\n\t\t\t\t\t// run length encoding is not allowed so read flat\n\t\t\t\t\t( ( scanline_width < 8 ) || ( scanline_width > 0x7fff ) ) ||\n\t\t\t\t\t// this file is not run length encoded\n\t\t\t\t\t( ( 2 !== buffer[ 0 ] ) || ( 2 !== buffer[ 1 ] ) || ( buffer[ 2 ] & 0x80 ) )\n\t\t\t\t) {\n\n\t\t\t\t\t// return the flat buffer\n\t\t\t\t\treturn new Uint8Array( buffer );\n\n\t\t\t\t}\n\n\t\t\t\tif ( scanline_width !== ( ( buffer[ 2 ] << 8 ) | buffer[ 3 ] ) ) {\n\n\t\t\t\t\treturn rgbe_error( rgbe_format_error, 'wrong scanline width' );\n\n\t\t\t\t}\n\n\t\t\t\tconst data_rgba = new Uint8Array( 4 * w * h );\n\n\t\t\t\tif ( ! data_rgba.length ) {\n\n\t\t\t\t\treturn rgbe_error( rgbe_memory_error, 'unable to allocate buffer space' );\n\n\t\t\t\t}\n\n\t\t\t\tlet offset = 0, pos = 0;\n\n\t\t\t\tconst ptr_end = 4 * scanline_width;\n\t\t\t\tconst rgbeStart = new Uint8Array( 4 );\n\t\t\t\tconst scanline_buffer = new Uint8Array( ptr_end );\n\t\t\t\tlet num_scanlines = h;\n\n\t\t\t\t// read in each successive scanline\n\t\t\t\twhile ( ( num_scanlines > 0 ) && ( pos < buffer.byteLength ) ) {\n\n\t\t\t\t\tif ( pos + 4 > buffer.byteLength ) {\n\n\t\t\t\t\t\treturn rgbe_error( rgbe_read_error );\n\n\t\t\t\t\t}\n\n\t\t\t\t\trgbeStart[ 0 ] = buffer[ pos ++ ];\n\t\t\t\t\trgbeStart[ 1 ] = buffer[ pos ++ ];\n\t\t\t\t\trgbeStart[ 2 ] = buffer[ pos ++ ];\n\t\t\t\t\trgbeStart[ 3 ] = buffer[ pos ++ ];\n\n\t\t\t\t\tif ( ( 2 != rgbeStart[ 0 ] ) || ( 2 != rgbeStart[ 1 ] ) || ( ( ( rgbeStart[ 2 ] << 8 ) | rgbeStart[ 3 ] ) != scanline_width ) ) {\n\n\t\t\t\t\t\treturn rgbe_error( rgbe_format_error, 'bad rgbe scanline format' );\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// read each of the four channels for the scanline into the buffer\n\t\t\t\t\t// first red, then green, then blue, then exponent\n\t\t\t\t\tlet ptr = 0, count;\n\n\t\t\t\t\twhile ( ( ptr < ptr_end ) && ( pos < buffer.byteLength ) ) {\n\n\t\t\t\t\t\tcount = buffer[ pos ++ ];\n\t\t\t\t\t\tconst isEncodedRun = count > 128;\n\t\t\t\t\t\tif ( isEncodedRun ) count -= 128;\n\n\t\t\t\t\t\tif ( ( 0 === count ) || ( ptr + count > ptr_end ) ) {\n\n\t\t\t\t\t\t\treturn rgbe_error( rgbe_format_error, 'bad scanline data' );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif ( isEncodedRun ) {\n\n\t\t\t\t\t\t\t// a (encoded) run of the same value\n\t\t\t\t\t\t\tconst byteValue = buffer[ pos ++ ];\n\t\t\t\t\t\t\tfor ( let i = 0; i < count; i ++ ) {\n\n\t\t\t\t\t\t\t\tscanline_buffer[ ptr ++ ] = byteValue;\n\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t//ptr += count;\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\t// a literal-run\n\t\t\t\t\t\t\tscanline_buffer.set( buffer.subarray( pos, pos + count ), ptr );\n\t\t\t\t\t\t\tptr += count; pos += count;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\n\t\t\t\t\t// now convert data from buffer into rgba\n\t\t\t\t\t// first red, then green, then blue, then exponent (alpha)\n\t\t\t\t\tconst l = scanline_width; //scanline_buffer.byteLength;\n\t\t\t\t\tfor ( let i = 0; i < l; i ++ ) {\n\n\t\t\t\t\t\tlet off = 0;\n\t\t\t\t\t\tdata_rgba[ offset ] = scanline_buffer[ i + off ];\n\t\t\t\t\t\toff += scanline_width; //1;\n\t\t\t\t\t\tdata_rgba[ offset + 1 ] = scanline_buffer[ i + off ];\n\t\t\t\t\t\toff += scanline_width; //1;\n\t\t\t\t\t\tdata_rgba[ offset + 2 ] = scanline_buffer[ i + off ];\n\t\t\t\t\t\toff += scanline_width; //1;\n\t\t\t\t\t\tdata_rgba[ offset + 3 ] = scanline_buffer[ i + off ];\n\t\t\t\t\t\toffset += 4;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tnum_scanlines --;\n\n\t\t\t\t}\n\n\t\t\t\treturn data_rgba;\n\n\t\t\t};\n\n\t\tconst RGBEByteToRGBFloat = function ( sourceArray, sourceOffset, destArray, destOffset ) {\n\n\t\t\tconst e = sourceArray[ sourceOffset + 3 ];\n\t\t\tconst scale = Math.pow( 2.0, e - 128.0 ) / 255.0;\n\n\t\t\tdestArray[ destOffset + 0 ] = sourceArray[ sourceOffset + 0 ] * scale;\n\t\t\tdestArray[ destOffset + 1 ] = sourceArray[ sourceOffset + 1 ] * scale;\n\t\t\tdestArray[ destOffset + 2 ] = sourceArray[ sourceOffset + 2 ] * scale;\n\t\t\tdestArray[ destOffset + 3 ] = 1;\n\n\t\t};\n\n\t\tconst RGBEByteToRGBHalf = function ( sourceArray, sourceOffset, destArray, destOffset ) {\n\n\t\t\tconst e = sourceArray[ sourceOffset + 3 ];\n\t\t\tconst scale = Math.pow( 2.0, e - 128.0 ) / 255.0;\n\n\t\t\t// clamping to 65504, the maximum representable value in float16\n\t\t\tdestArray[ destOffset + 0 ] = DataUtils.toHalfFloat( Math.min( sourceArray[ sourceOffset + 0 ] * scale, 65504 ) );\n\t\t\tdestArray[ destOffset + 1 ] = DataUtils.toHalfFloat( Math.min( sourceArray[ sourceOffset + 1 ] * scale, 65504 ) );\n\t\t\tdestArray[ destOffset + 2 ] = DataUtils.toHalfFloat( Math.min( sourceArray[ sourceOffset + 2 ] * scale, 65504 ) );\n\t\t\tdestArray[ destOffset + 3 ] = DataUtils.toHalfFloat( 1 );\n\n\t\t};\n\n\t\tconst byteArray = new Uint8Array( buffer );\n\t\tbyteArray.pos = 0;\n\t\tconst rgbe_header_info = RGBE_ReadHeader( byteArray );\n\n\t\tif ( RGBE_RETURN_FAILURE !== rgbe_header_info ) {\n\n\t\t\tconst w = rgbe_header_info.width,\n\t\t\t\th = rgbe_header_info.height,\n\t\t\t\timage_rgba_data = RGBE_ReadPixels_RLE( byteArray.subarray( byteArray.pos ), w, h );\n\n\t\t\tif ( RGBE_RETURN_FAILURE !== image_rgba_data ) {\n\n\t\t\t\tlet data, format, type;\n\t\t\t\tlet numElements;\n\n\t\t\t\tswitch ( this.type ) {\n\n\t\t\t\t\tcase FloatType:\n\n\t\t\t\t\t\tnumElements = image_rgba_data.length / 4;\n\t\t\t\t\t\tconst floatArray = new Float32Array( numElements * 4 );\n\n\t\t\t\t\t\tfor ( let j = 0; j < numElements; j ++ ) {\n\n\t\t\t\t\t\t\tRGBEByteToRGBFloat( image_rgba_data, j * 4, floatArray, j * 4 );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata = floatArray;\n\t\t\t\t\t\ttype = FloatType;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase HalfFloatType:\n\n\t\t\t\t\t\tnumElements = image_rgba_data.length / 4;\n\t\t\t\t\t\tconst halfArray = new Uint16Array( numElements * 4 );\n\n\t\t\t\t\t\tfor ( let j = 0; j < numElements; j ++ ) {\n\n\t\t\t\t\t\t\tRGBEByteToRGBHalf( image_rgba_data, j * 4, halfArray, j * 4 );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata = halfArray;\n\t\t\t\t\t\ttype = HalfFloatType;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\n\t\t\t\t\t\tconsole.error( 'THREE.RGBELoader: unsupported type: ', this.type );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\twidth: w, height: h,\n\t\t\t\t\tdata: data,\n\t\t\t\t\theader: rgbe_header_info.string,\n\t\t\t\t\tgamma: rgbe_header_info.gamma,\n\t\t\t\t\texposure: rgbe_header_info.exposure,\n\t\t\t\t\tformat: format,\n\t\t\t\t\ttype: type\n\t\t\t\t};\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn null;\n\n\t}\n\n\tsetDataType( value ) {\n\n\t\tthis.type = value;\n\t\treturn this;\n\n\t}\n\n\tload( url, onLoad, onProgress, onError ) {\n\n\t\tfunction onLoadCallback( texture, texData ) {\n\n\t\t\tswitch ( texture.type ) {\n\n\t\t\t\tcase FloatType:\n\n\t\t\t\t\ttexture.encoding = LinearEncoding;\n\t\t\t\t\ttexture.minFilter = LinearFilter;\n\t\t\t\t\ttexture.magFilter = LinearFilter;\n\t\t\t\t\ttexture.generateMipmaps = false;\n\t\t\t\t\ttexture.flipY = true;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase HalfFloatType:\n\n\t\t\t\t\ttexture.encoding = LinearEncoding;\n\t\t\t\t\ttexture.minFilter = LinearFilter;\n\t\t\t\t\ttexture.magFilter = LinearFilter;\n\t\t\t\t\ttexture.generateMipmaps = false;\n\t\t\t\t\ttexture.flipY = true;\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tif ( onLoad ) onLoad( texture, texData );\n\n\t\t}\n\n\t\treturn super.load( url, onLoadCallback, onProgress, onError );\n\n\t}\n\n}\n\nexport { RGBELoader };\n","import { fromEvent, merge } from 'rxjs';\r\nimport { filter, map, shareReplay, startWith } from 'rxjs/operators';\r\n\r\nexport default class KeyboardService {\r\n\r\n\tstatic keys = {};\r\n\r\n\tstatic keydown$() {\r\n\t\tif (!this.keydown$_) {\r\n\t\t\tthis.keydown$_ = fromEvent(window, 'keydown').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keydown$_;\r\n\t}\r\n\r\n\tstatic keyup$() {\r\n\t\tif (!this.keyup$_) {\r\n\t\t\tthis.keyup$_ = fromEvent(window, 'keyup').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keyup$_;\r\n\t}\r\n\r\n\tstatic keys$() {\r\n\t\tif (!this.keys$_) {\r\n\t\t\tthis.keys$_ = merge(this.keydown$(), this.keyup$()).pipe(\r\n\t\t\t\tmap(event => {\r\n\t\t\t\t\tconst keys = this.keys;\r\n\t\t\t\t\tif (event.type === 'keydown') {\r\n\t\t\t\t\t\tkeys[event.key] = true;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdelete keys[event.key];\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.keys;\r\n\t\t\t\t}),\r\n\t\t\t\tstartWith(this.keys),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.keys$_;\r\n\t}\r\n\r\n\tstatic key$() {\r\n\t\tif (!this.key$_) {\r\n\t\t\tconst regexp = /\\w/;\r\n\t\t\tthis.key$_ = this.keydown$().pipe(\r\n\t\t\t\tfilter(event => event.key && event.key.match(regexp)),\r\n\t\t\t\tmap(event => event.key),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.key$_;\r\n\t}\r\n\r\n\tstatic typing$() {\r\n\t\tif (!this.typing$_) {\r\n\t\t\tlet typing = '',\r\n\t\t\t\tto;\r\n\t\t\tthis.typing$_ = this.key$().pipe(\r\n\t\t\t\tmap(key => {\r\n\t\t\t\t\tif (to) {\r\n\t\t\t\t\t\tclearTimeout(to);\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttyping += key;\r\n\t\t\t\t\tto = setTimeout(() => {\r\n\t\t\t\t\t\ttyping = '';\r\n\t\t\t\t\t}, 1500);\r\n\t\t\t\t\treturn typing;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.typing$_;\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject, combineLatest, of, ReplaySubject } from 'rxjs';\r\nimport { map, switchAll } from 'rxjs/operators';\r\n\r\nlet LOADER_UID = 0;\r\n\r\nexport default class LoaderService {\r\n\r\n\tstatic progress = { value: 0, loaded: 0, total: 0, count: 0, title: '' };\r\n\r\n\tstatic items = {};\r\n\r\n\t// merge(this.statusSubject, this.validatorsSubject)\r\n\tstatic progress$ = new ReplaySubject(1).pipe(\r\n\t\tswitchAll(),\r\n\t\tmap(() => {\r\n\t\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\t\tconst progress = items.reduce((progress, subject, i, items) => {\r\n\t\t\t\tconst item = subject.getValue();\r\n\t\t\t\tconst loaded = item.loaded || 0;\r\n\t\t\t\tconst total = item.total || 1;\r\n\t\t\t\tconst value = loaded / total;\r\n\t\t\t\tprogress.value += value;\r\n\t\t\t\tprogress.loaded += loaded;\r\n\t\t\t\tprogress.total += total;\r\n\t\t\t\treturn progress;\r\n\t\t\t}, { value: 0, loaded: 0, total: 0 });\r\n\t\t\tprogress.count = items.length;\r\n\t\t\tif (items.length) {\r\n\t\t\t\tprogress.value /= progress.count;\r\n\t\t\t}\r\n\t\t\tprogress.title = `${Math.round(progress.value * 100)}%`;\r\n\t\t\tthis.progress = progress;\r\n\t\t\treturn progress;\r\n\t\t}),\r\n\t);\r\n\r\n\tstatic switchLoaders() {\r\n\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\tconst items$ = items.length ? combineLatest(items) : of(items);\r\n\t\tthis.progress$.next(items$);\r\n\t}\r\n\r\n\tstatic getRef() {\r\n\t\tconst ref = ++LOADER_UID;\r\n\t\tthis.items[ref] = new BehaviorSubject({ loaded: 0, total: 1 });\r\n\t\tthis.switchLoaders();\r\n\t\treturn ref;\r\n\t}\r\n\r\n\tstatic setProgress(ref, loaded, total = 1) {\r\n\t\t// console.log('LoaderService.setProgress');\r\n\t\tconst item = this.items[ref];\r\n\t\tif (item) {\r\n\t\t\titem.next({ loaded, total });\r\n\t\t}\r\n\t\tif (loaded >= total) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tdelete this.items[ref];\r\n\t\t\t\tthis.switchLoaders();\r\n\t\t\t}, 300);\r\n\t\t}\r\n\t\tthis.switchLoaders();\r\n\t}\r\n\r\n}\r\n","import { fromEvent, of } from 'rxjs';\r\nimport { filter, finalize, first, map, takeWhile, tap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\n\r\nlet UID = 0;\r\n\r\nexport const PrefetchServiceEvent = {\r\n\tProgress: 'progress',\r\n\tComplete: 'complete',\r\n};\r\nexport default class PrefetchService {\r\n\r\n\tstatic worker() {\r\n\t\tif (!this.worker_) {\r\n\t\t\tthis.worker_ = new Worker(environment.workers.prefetch);\r\n\t\t}\r\n\t\treturn this.worker_;\r\n\t}\r\n\r\n\tstatic events$(assets) {\r\n\t\tif (!('Worker' in window)) {\r\n\t\t\treturn of({ type: PrefetchServiceEvent.Complete, data: assets });\r\n\t\t}\r\n\t\tconst worker = this.worker();\r\n\t\tworker.postMessage({ id: UID });\r\n\t\tconst id = ++UID;\r\n\t\tworker.postMessage({ id, assets });\r\n\t\tlet lastEvent;\r\n\t\treturn fromEvent(worker, 'message').pipe(\r\n\t\t\tmap(event => event.data),\r\n\t\t\tfilter(event => event.assets === assets),\r\n\t\t\ttap(event => {\r\n\t\t\t\t// console.log('PrefetchService', event);\r\n\t\t\t\t/*\r\n\t\t\t\tif (event.type === PrefetchServiceEvent.Complete) {\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tlastEvent = event;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== PrefetchServiceEvent.Complete, true),\r\n\t\t\tfinalize(() => {\r\n\t\t\t\t// console.log('PrefetchService.finalize', lastEvent);\r\n\t\t\t\tworker.postMessage({ id });\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic load$(assets) {\r\n\t\treturn this.events$(assets).pipe(\r\n\t\t\tfilter(event => event.type === PrefetchServiceEvent.Complete),\r\n\t\t\tmap(event => event.data),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic prefetch(assets) {\r\n\t\tif (environment.flags.usePrefetch) {\r\n\t\t\tthis.load$(assets).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\t// console.log('PrefetchService.prefetch', event);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tstatic cancel() {\r\n\t\tif (!('Worker' in window)) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tconst worker = this.worker();\r\n\t\tworker.postMessage({ id: UID });\r\n\t\treturn worker;\r\n\t}\r\n}\r\n","export class Rect {\n\n\tconstructor(rect) {\n\t\tthis.x = 0;\n\t\tthis.y = 0;\n\t\tthis.top = 0;\n\t\tthis.right = 0;\n\t\tthis.bottom = 0;\n\t\tthis.left = 0;\n\t\tthis.width = 0;\n\t\tthis.height = 0;\n\t\tthis.set(rect);\n\t}\n\n\tstatic contains(rect, left, top) {\n\t\treturn rect.top <= top && top <= rect.bottom && rect.left <= left && left <= rect.right;\n\t}\n\n\tstatic intersectRect(r1, r2) {\n\t\treturn !(r2.left > r1.right ||\n\t\t\tr2.right < r1.left ||\n\t\t\tr2.top > r1.bottom ||\n\t\t\tr2.bottom < r1.top);\n\t}\n\n\tstatic fromNode(node) {\n\t\tif (!node) {\n\t\t\treturn;\n\t\t}\n\t\tconst rect = node.rect_ || (node.rect_ = new Rect());\n\t\tconst rects = node.getClientRects();\n\t\tif (!rects.length) {\n\t\t\t// console.log(rects, node);\n\t\t\treturn rect;\n\t\t}\n\t\tconst boundingRect = node.getBoundingClientRect();\n\t\t// rect.top: boundingRect.top + defaultView.pageYOffset,\n\t\t// rect.left: boundingRect.left + defaultView.pageXOffset,\n\t\trect.x = boundingRect.left;\n\t\trect.y = boundingRect.top;\n\t\trect.top = boundingRect.top;\n\t\trect.left = boundingRect.left;\n\t\trect.width = boundingRect.width;\n\t\trect.height = boundingRect.height;\n\t\trect.right = rect.left + rect.width;\n\t\trect.bottom = rect.top + rect.height;\n\t\trect.setCenter();\n\t\treturn rect;\n\t}\n\n\tset(rect) {\n\t\tif (rect) {\n\t\t\tObject.assign(this, rect);\n\t\t\tthis.right = this.left + this.width;\n\t\t\tthis.bottom = this.top + this.height;\n\t\t}\n\t\tthis.setCenter();\n\t}\n\n\tsetSize(w, h) {\n\t\tthis.width = w;\n\t\tthis.height = h;\n\t\tthis.right = this.left + this.width;\n\t\tthis.bottom = this.top + this.height;\n\t\tthis.setCenter();\n\t\t// console.log(w, h);\n\t}\n\n\tsetCenter() {\n\t\tconst center = this.center || (this.center = {});\n\t\tcenter.top = this.top + this.height / 2;\n\t\tcenter.left = this.left + this.width / 2;\n\t\tcenter.x = center.left;\n\t\tcenter.y = center.top;\n\t}\n\n\tcontains(left, top) {\n\t\treturn Rect.contains(this, left, top);\n\t}\n\n\tintersect(rect) {\n\t\treturn Rect.intersectRect(this, rect);\n\t}\n\n\tintersection(rect) {\n\t\tconst intersection = this.intersection_ || (this.intersection_ = {\n\t\t\tleft: 0,\n\t\t\ttop: 0,\n\t\t\twidth: 0,\n\t\t\theight: 0,\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\tpow: {\n\t\t\t\tx: -1,\n\t\t\t\ty: -1\n\t\t\t},\n\t\t\toffset: function(offset) {\n\t\t\t\toffset = offset || 0;\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\n\t\t\t\treturn pow;\n\t\t\t},\n\t\t\tscroll: function(offset) {\n\t\t\t\toffset = offset || 0;\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\n\t\t\t\treturn pow;\n\t\t\t}\n\t\t});\n\t\tintersection.left = this.left;\n\t\tintersection.top = this.top;\n\t\tintersection.width = this.width;\n\t\tintersection.height = this.height;\n\t\tintersection.x = this.left + this.width / 2;\n\t\tintersection.y = this.top + this.height / 2;\n\t\tintersection.rect = rect;\n\t\tconst pow = intersection.offset(0);\n\t\tintersection.pow.y = pow;\n\t\treturn intersection;\n\t}\n\n}\n","import StreamService from '../../stream/stream.service';\r\n\r\nexport const W = 320;\r\nexport const H = 240;\r\nexport const COLORS = [0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff, 0xffffff];\r\n\r\nexport default class AvatarElement {\r\n\r\n\tstatic get headGeometry() {\r\n\t\tif (!this.headGeometry_) {\r\n\t\t\tthis.headGeometry_ = new THREE.SphereBufferGeometry(0.2, 36, 24);\r\n\t\t}\r\n\t\treturn this.headGeometry_;\r\n\t}\r\n\r\n\tconstructor(message) {\r\n\t\tconst clientId = this.clientId = message.clientId;\r\n\t\tconst container = this.container = message.container;\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: true,\r\n\t\t\talpha: false,\r\n\t\t\tpremultipliedAlpha: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(W, H);\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = 0.8;\r\n\t\trenderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\tcontainer.appendChild(renderer.domElement);\r\n\r\n\t\tconst camera = this.camera = new THREE.PerspectiveCamera(70, W / H, 0.01, 1000);\r\n\t\tcamera.position.set(0, 0, -0.5);\r\n\t\tcamera.target = new THREE.Vector3();\r\n\t\tcamera.lookAt(camera.target);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\r\n\t\t/*\r\n\t\tconst ambient = this.ambient = new THREE.AmbientLight(0x202020);\r\n\t\tscene.add(ambient);\r\n\t\t*/\r\n\r\n\t\tconst light = this.light = new THREE.PointLight(0xffffff, 1, 100);\r\n\t\tlight.position.set(0, 2, -2);\r\n\t\tscene.add(light);\r\n\r\n\t\tconst head = this.head = this.addHead();\r\n\t\tscene.add(head);\r\n\r\n\t\tconst remote = this.remote = StreamService.getRemoteById(clientId);\r\n\t\t/*\r\n\t\tif (remote) {\r\n\t\t\tthis.subscription = AudioStreamService.volume$(remote.stream).pipe(\r\n\t\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t\t\ttap(meter => {\r\n\t\t\t\t\tthis.chalk(meter.volume);\r\n\t\t\t\t})\r\n\t\t\t);\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\taddHead() {\r\n\t\tconst geometry = AvatarElement.headGeometry;\r\n\t\tconst canvas = this.canvas = document.createElement('canvas');\r\n\t\tcanvas.width = 1024;\r\n\t\tcanvas.height = 512;\r\n\t\tconst ctx = this.ctx = this.canvas.getContext('2d');\r\n\t\tconst map = this.map = new THREE.CanvasTexture(canvas);\r\n\t\tmap.offset.x = -0.25;\r\n\t\tconst color = COLORS[this.clientId % COLORS.length];\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tmap: map,\r\n\t\t\tcolor: color,\r\n\t\t});\r\n\t\tthis.chalk(0);\r\n\t\treturn new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t// if (tick % 2 === 1) {\r\n\t\tif (this.remote) {\r\n\t\t\tconst audioLevel = this.remote.getAudioLevel() * 12;\r\n\t\t\tthis.chalk(audioLevel);\r\n\t\t}\r\n\t\tconst renderer = this.renderer,\r\n\t\t\tscene = this.scene,\r\n\t\t\tcamera = this.camera;\r\n\t\trenderer.render(scene, camera);\r\n\t\t// }\r\n\t}\r\n\r\n\tupdate(message) {\r\n\t\tconst camera = message.camera;\r\n\t\tconst head = this.head;\r\n\t\thead.quaternion.set(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t/*\r\n\t\thead.position.set(camera[0], camera[1], camera[2]);\r\n\t\t*/\r\n\t}\r\n\r\n\tdispose() {\r\n\t\t// !!! dispose threejs\r\n\t\tif (this.subscription) {\r\n\t\t\tthis.subscription.unsubscribe();\r\n\t\t}\r\n\t}\r\n\r\n\tchalk(i) {\r\n\t\ti = (i + Math.PI * 0.5) % (Math.PI * 2);\r\n\t\tconst vol = Math.sin(i) * 30;\r\n\t\tconst smile = Math.cos(i) * 10;\r\n\t\tconst x = 512;\r\n\t\tconst y = 256;\r\n\t\tconst ctx = this.ctx;\r\n\t\tctx.fillStyle = '#888888';\r\n\t\tctx.fillRect(0, 0, 1024, 512);\r\n\t\tctx.fillStyle = 'white';\r\n\t\tctx.beginPath();\r\n\t\tctx.arc(x - 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.arc(x + 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.beginPath();\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 30, x - 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 60, x, y + 60);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y + 60, x + 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y, x, y);\r\n\t\tctx.moveTo(x - 40 - smile, y + 30);\r\n\t\tctx.bezierCurveTo(x - 40 - smile, y + 60, x + 40 + smile, y + 60, x + 40 + smile, y + 30);\r\n\t\tctx.bezierCurveTo(x + 40 + smile, y + vol, x - 40 - smile, y + vol, x - 40 - smile, y + 30);\r\n\t\t// ctx.arc(x, 256 + 50, 50, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tthis.map.needsUpdate = true;\r\n\t}\r\n\r\n}\r\n","import { environment } from '../../environment';\r\n\r\nexport class Texture {\r\n\r\n\tstatic get defaultTexture() {\r\n\t\treturn Texture.defaultTexture_ || (Texture.defaultTexture_ = new THREE.TextureLoader().load('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyNpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDA2IDc5LjE2NDc1MywgMjAyMS8wMi8xNS0xMTo1MjoxMyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIyLjMgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjcyODFGQkE0QUMxODExRUJBQkRBQTEyMzUzMjUxRjg2IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjcyODFGQkE1QUMxODExRUJBQkRBQTEyMzUzMjUxRjg2Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzI4MUZCQTJBQzE4MTFFQkFCREFBMTIzNTMyNTFGODYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NzI4MUZCQTNBQzE4MTFFQkFCREFBMTIzNTMyNTFGODYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz55AlN+AAAAZUlEQVR42uzQAQEAAAQDMPTvfD3YIqyT1GdTzwkQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAgAtWgAEAVbYDfaostxgAAAAASUVORK5CYII='));\r\n\t}\r\n\r\n\tstatic get gridTexture() {\r\n\t\treturn Texture.gridTexture_ || (Texture.gridTexture_ = new THREE.TextureLoader().load(environment.getPath(environment.textures.grid)));\r\n\t}\r\n\r\n}\r\n","import { environment } from '../../environment';\r\nimport { Geometry } from '../geometry/geometry';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\n\r\nexport default class MediaPlayMesh extends InteractiveMesh {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn MediaPlayMesh.loader || (MediaPlayMesh.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTextureOff() {\r\n\t\treturn MediaPlayMesh.textureOff || (MediaPlayMesh.textureOff = MediaPlayMesh.getLoader().load(environment.getPath('textures/ui/play-off.png')));\r\n\t}\r\n\r\n\tstatic getTextureOn() {\r\n\t\treturn MediaPlayMesh.textureOn || (MediaPlayMesh.textureOn = MediaPlayMesh.getLoader().load(environment.getPath('textures/ui/play-on.png')));\r\n\t}\r\n\r\n\tstatic getMaterial() {\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tmap: MediaPlayMesh.getTextureOff(),\r\n\t\t\tcolor: 0xffffff,\r\n\t\t\topacity: 1,\r\n\t\t\ttransparent: true,\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tplaying_ = false;\r\n\tget playing() {\r\n\t\treturn this.playing_;\r\n\t}\r\n\tset playing(playing) {\r\n\t\tif (this.playing_ !== playing) {\r\n\t\t\tthis.playing_ = playing;\r\n\t\t\tconst material = this.material;\r\n\t\t\tmaterial.map = playing ? MediaPlayMesh.getTextureOn() : MediaPlayMesh.getTextureOff();\r\n\t\t\tthis.onOut();\r\n\t\t\t// material.needsUpdate = true;\r\n\t\t\t// this.emit('playing', playing);\r\n\t\t\t// console.log('MediaPlayMesh.playing', playing);\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(host) {\r\n\t\tconst geometry = Geometry.planeGeometry;\r\n\t\tconst material = MediaPlayMesh.getMaterial();\r\n\t\tsuper(geometry, material);\r\n\t\tthis.material = material;\r\n\t\tthis.host = host;\r\n\t\t// this.color = new THREE.Color(material.color.getHex());\r\n\t\tthis.colorOff = new THREE.Color(material.color.getHex());\r\n\t\tthis.colorOn = new THREE.Color('#888888'); // new THREE.Color('#0099ff');\r\n\t\tthis.addEventListener();\r\n\t}\r\n\r\n\tupdate(parent) {\r\n\t\tconst scale = this.scale;\r\n\t\tconst parentRatio = parent.scale.x / parent.scale.y;\r\n\t\tconst size = 0.3;\r\n\t\tscale.set(size / parentRatio, size, 1);\r\n\t\t// console.log('MediaPlayMesh.setParentScale', parent.scale, scale, position);\r\n\t}\r\n\r\n\tdisposeMaterial() {\r\n\t\tif (this.material) {\r\n\t\t\tif (this.material.map && this.material.map.disposable !== false) {\r\n\t\t\t\tthis.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tthis.material.dispose();\r\n\t\t\t// this.material = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.removeEventListener();\r\n\t\tthis.disposeMaterial();\r\n\t}\r\n\r\n\tonOver() {\r\n\t\tconst color = this.material.color;\r\n\t\tconst target = this.colorOn;\r\n\t\tconst material = this.material;\r\n\t\t// console.log('MediaPlayMesh.onOver');\r\n\t\tgsap.to(color, {\r\n\t\t\tr: target.r,\r\n\t\t\tg: target.g,\r\n\t\t\tb: target.b,\r\n\t\t\tduration: 0.2,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t});\r\n\t\tgsap.to(material, {\r\n\t\t\topacity: 1,\r\n\t\t\tduration: 0.2,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t});\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tconst color = this.material.color;\r\n\t\tconst target = this.colorOff;\r\n\t\tconst material = this.material;\r\n\t\t// console.log('MediaPlayMesh.onOut');\r\n\t\tgsap.to(color, {\r\n\t\t\tr: target.r,\r\n\t\t\tg: target.g,\r\n\t\t\tb: target.b,\r\n\t\t\tduration: 0.2,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t});\r\n\t\tgsap.to(material, {\r\n\t\t\topacity: this.playing ? 0 : 1,\r\n\t\t\tduration: 0.2,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t});\r\n\t}\r\n\r\n\taddEventListener() {\r\n\t\tthis.onOver = this.onOver.bind(this);\r\n\t\tthis.onOut = this.onOut.bind(this);\r\n\t\tthis.on('over', this.onOver);\r\n\t\tthis.on('out', this.onOut);\r\n\t}\r\n\r\n\tremoveEventListener() {\r\n\t\tthis.off('over', this.onOver);\r\n\t\tthis.off('out', this.onOut);\r\n\t}\r\n}\r\n","import { environment } from '../../environment';\r\nimport { Geometry } from '../geometry/geometry';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\n\r\nexport default class MediaZoomMesh extends InteractiveMesh {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn MediaZoomMesh.loader || (MediaZoomMesh.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTextureOff() {\r\n\t\treturn MediaZoomMesh.textureOff || (MediaZoomMesh.textureOff = MediaZoomMesh.getLoader().load(environment.getPath('textures/ui/zoom-off.png')));\r\n\t}\r\n\r\n\tstatic getTextureOn() {\r\n\t\treturn MediaZoomMesh.textureOn || (MediaZoomMesh.textureOn = MediaZoomMesh.getLoader().load(environment.getPath('textures/ui/zoom-on.png')));\r\n\t}\r\n\r\n\tstatic getMaterial() {\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tmap: MediaZoomMesh.getTextureOff(),\r\n\t\t\tcolor: 0xffffff,\r\n\t\t\topacity: 1,\r\n\t\t\ttransparent: true,\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tzoomed_ = false;\r\n\tget zoomed() {\r\n\t\treturn this.zoomed_;\r\n\t}\r\n\tset zoomed(zoomed) {\r\n\t\tif (this.zoomed_ !== zoomed) {\r\n\t\t\tthis.zoomed_ = zoomed;\r\n\t\t\tconst material = this.material;\r\n\t\t\tmaterial.map = zoomed ? MediaZoomMesh.getTextureOn() : MediaZoomMesh.getTextureOff();\r\n\t\t\t// material.needsUpdate = true;\r\n\t\t\t/*\r\n\t\t\tif (zoomed) {\r\n\t\t\t\t// this.originalPosition = this.parent.position.clone();\r\n\t\t\t\t// this.originalQuaternion = this.parent.rotation.clone();\r\n\t\t\t\t// this.originalScale = this.parent.scale.clone();\r\n\t\t\t} else {\r\n\t\t\t\tthis.object.position.copy(this.originalPosition);\r\n\t\t\t\tthis.object.scale.copy(this.originalScale);\r\n\t\t\t\tthis.object.quaternion.copy(this.originalQuaternion);\r\n\t\t\t}\r\n\t\t\tthis.updateObjectMatrix();\r\n\t\t\t*/\r\n\t\t\t// console.log('MediaZoomMesh.zoomed', zoomed);\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(host) {\r\n\t\tconst geometry = Geometry.planeGeometry;\r\n\t\tconst material = MediaZoomMesh.getMaterial();\r\n\t\tsuper(geometry, material);\r\n\t\tthis.material = material;\r\n\t\tthis.host = host;\r\n\t\t// this.color = new THREE.Color(material.color.getHex());\r\n\t\tthis.colorOff = new THREE.Color(material.color.getHex());\r\n\t\tthis.colorOn = new THREE.Color('#888888'); // new THREE.Color('#0099ff');\r\n\t\tthis.object = new THREE.Object3D();\r\n\t\tthis.addEventListener();\r\n\t}\r\n\r\n\tdisposeMaterial() {\r\n\t\tif (this.material) {\r\n\t\t\tif (this.material.map && this.material.map.disposable !== false) {\r\n\t\t\t\tthis.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tthis.material.dispose();\r\n\t\t\t// this.material = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.removeEventListener();\r\n\t\tthis.disposeMaterial();\r\n\t}\r\n\r\n\tonOver() {\r\n\t\tconst color = this.material.color;\r\n\t\tconst target = this.colorOn;\r\n\t\tconst material = this.material;\r\n\t\t// console.log('MediaZoomMesh.onOver');\r\n\t\tgsap.to(color, {\r\n\t\t\tr: target.r,\r\n\t\t\tg: target.g,\r\n\t\t\tb: target.b,\r\n\t\t\tduration: 0.2,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\t/*\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t},\r\n\t\t\t*/\r\n\t\t});\r\n\t\t// this.innerVisible = true;\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tconst color = this.material.color;\r\n\t\tconst target = this.colorOff;\r\n\t\tconst material = this.material;\r\n\t\t// console.log('MediaZoomMesh.onOut');\r\n\t\tgsap.to(color, {\r\n\t\t\tr: target.r,\r\n\t\t\tg: target.g,\r\n\t\t\tb: target.b,\r\n\t\t\tduration: 0.2,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\t/*\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t},\r\n\t\t\t*/\r\n\t\t});\r\n\t\t// this.innerVisible = false;\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\t// console.log('MediaZoomMesh.onToggle', !this.zoomed);\r\n\t\t// this.zoomed = !this.zoomed;\r\n\t\tthis.emit('zoomed', !this.zoomed);\r\n\t}\r\n\r\n\taddEventListener() {\r\n\t\tthis.onOver = this.onOver.bind(this);\r\n\t\tthis.onOut = this.onOut.bind(this);\r\n\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\tthis.on('over', this.onOver);\r\n\t\tthis.on('out', this.onOut);\r\n\t\tthis.on('down', this.onToggle);\r\n\t}\r\n\r\n\tremoveEventListener() {\r\n\t\tthis.off('over', this.onOver);\r\n\t\tthis.off('out', this.onOut);\r\n\t\tthis.off('down', this.onToggle);\r\n\t}\r\n}\r\n","import { of } from 'rxjs';\r\nimport { filter, map } from 'rxjs/operators';\r\nimport { AssetType, assetIsStream } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StreamService from '../../stream/stream.service';\r\nimport { RoleType } from '../../user/user';\r\nimport { Host } from '../host/host';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport { Texture } from '../texture/texture';\r\nimport MediaLoader, { MediaLoaderPauseEvent, MediaLoaderPlayEvent, MediaLoaderTimeSetEvent } from './media-loader';\r\nimport MediaPlayMesh from './media-play-mesh';\r\nimport MediaZoomMesh from './media-zoom-mesh';\r\n\r\nconst VERTEX_SHADER = `\r\nvarying vec2 vUvShader;\r\n\r\n#include <common>\r\n#include <uv_pars_vertex>\r\n#include <uv2_pars_vertex>\r\n#include <envmap_pars_vertex>\r\n#include <color_pars_vertex>\r\n#include <fog_pars_vertex>\r\n#include <morphtarget_pars_vertex>\r\n#include <skinning_pars_vertex>\r\n#include <logdepthbuf_pars_vertex>\r\n#include <clipping_planes_pars_vertex>\r\n\r\nvoid main() {\r\n\tvUvShader = uv;\r\n\r\n\t#include <uv_vertex>\r\n\t#include <uv2_vertex>\r\n\t#include <color_vertex>\r\n\t#include <morphcolor_vertex>\r\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\r\n\t\t#include <beginnormal_vertex>\r\n\t\t#include <morphnormal_vertex>\r\n\t\t#include <skinbase_vertex>\r\n\t\t#include <skinnormal_vertex>\r\n\t\t#include <defaultnormal_vertex>\r\n\t#endif\r\n\t#include <begin_vertex>\r\n\t#include <morphtarget_vertex>\r\n\t#include <skinning_vertex>\r\n\t#include <project_vertex>\r\n\t#include <logdepthbuf_vertex>\r\n\t#include <clipping_planes_vertex>\r\n\t#include <worldpos_vertex>\r\n\t#include <envmap_vertex>\r\n\t#include <fog_vertex>\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#define USE_MAP\r\n\r\nvarying vec2 vUvShader;\r\n\r\nuniform vec3 diffuse;\r\nuniform float opacity;\r\n\r\n#ifndef FLAT_SHADED\r\n\tvarying vec3 vNormal;\r\n#endif\r\n\r\n#include <common>\r\n#include <dithering_pars_fragment>\r\n#include <color_pars_fragment>\r\n#include <uv_pars_fragment>\r\n#include <uv2_pars_fragment>\r\n#include <map_pars_fragment>\r\n#include <alphamap_pars_fragment>\r\n#include <alphatest_pars_fragment>\r\n#include <aomap_pars_fragment>\r\n#include <lightmap_pars_fragment>\r\n#include <envmap_common_pars_fragment>\r\n#include <envmap_pars_fragment>\r\n#include <cube_uv_reflection_fragment>\r\n#include <fog_pars_fragment>\r\n#include <specularmap_pars_fragment>\r\n#include <logdepthbuf_pars_fragment>\r\n#include <clipping_planes_pars_fragment>\r\n\r\n// uniform sampler2D map;\r\nuniform sampler2D playMap;\r\nuniform vec2 mapResolution;\r\nuniform vec2 playMapResolution;\r\nuniform float mapTween;\r\nuniform float playMapTween;\r\nuniform vec3 playMapColor;\r\nuniform bool isVideo;\r\n\r\nvoid main() {\r\n\t#include <clipping_planes_fragment>\r\n\r\n\tvec4 diffuseColor = vec4(vec3(1.0), opacity);\r\n\r\n\t#include <logdepthbuf_fragment>\r\n\t#include <map_fragment>\r\n\t#include <color_fragment>\r\n\r\n\t// main\r\n\tvec4 mapRgba = texture2D(map, vUvShader);\r\n\tif (isVideo) {\r\n\t\tvec4 playMapRgba = texture2D(playMap, vUvShader);\r\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2) + (playMapRgba.rgb * mapTween * playMapRgba.a), opacity);\r\n\t} else {\r\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity);\r\n\t}\r\n\r\n\t#include <alphamap_fragment>\r\n\t#include <alphatest_fragment>\r\n\t#include <specularmap_fragment>\r\n\r\n\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\r\n\r\n\t// accumulation (baked indirect lighting only)\r\n\t#ifdef USE_LIGHTMAP\r\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\r\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\r\n\t#else\r\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\r\n\t#endif\r\n\r\n\t// modulation\r\n\t#include <aomap_fragment>\r\n\r\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\r\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\r\n\r\n\t#include <envmap_fragment>\r\n\t#include <output_fragment>\r\n\t#include <tonemapping_fragment>\r\n\t#include <encodings_fragment>\r\n\t#include <fog_fragment>\r\n\t#include <premultiplied_alpha_fragment>\r\n\t#include <dithering_fragment>\r\n}\r\n`;\r\n\r\nconst FRAGMENT_CHROMA_KEY_SHADER = `\r\n#define USE_MAP\r\n#define threshold 0.55\r\n#define padding 0.05\r\nvarying vec2 vUvShader;\r\n\r\nuniform vec3 diffuse;\r\nuniform float opacity;\r\n\r\n#ifndef FLAT_SHADED\r\n\tvarying vec3 vNormal;\r\n#endif\r\n\r\n#include <common>\r\n#include <dithering_pars_fragment>\r\n#include <color_pars_fragment>\r\n#include <uv_pars_fragment>\r\n#include <uv2_pars_fragment>\r\n#include <map_pars_fragment>\r\n#include <alphamap_pars_fragment>\r\n#include <alphatest_pars_fragment>\r\n#include <aomap_pars_fragment>\r\n#include <lightmap_pars_fragment>\r\n#include <envmap_common_pars_fragment>\r\n#include <envmap_pars_fragment>\r\n#include <cube_uv_reflection_fragment>\r\n#include <fog_pars_fragment>\r\n#include <specularmap_pars_fragment>\r\n#include <logdepthbuf_pars_fragment>\r\n#include <clipping_planes_pars_fragment>\r\n\r\n// uniform sampler2D map;\r\nuniform sampler2D playMap;\r\nuniform vec2 mapResolution;\r\nuniform vec2 playMapResolution;\r\nuniform float mapTween;\r\nuniform float playMapTween;\r\nuniform vec3 playMapColor;\r\nuniform vec3 chromaKeyColor;\r\nuniform bool isVideo;\r\n\r\nvoid main() {\r\n\t#include <clipping_planes_fragment>\r\n\r\n\tvec4 diffuseColor = vec4( diffuse, opacity );\r\n\r\n\t#include <logdepthbuf_fragment>\r\n\t#include <map_fragment>\r\n\t#include <color_fragment>\r\n\r\n\t// main\r\n\tvec4 mapRgba = texture2D(map, vUvShader);\r\n\tvec4 chromaKey = vec4(chromaKeyColor, 1.0);\r\n    vec3 chromaKeyDiff = mapRgba.rgb - chromaKey.rgb;\r\n    float chromaKeyValue = smoothstep(threshold - padding, threshold + padding, dot(chromaKeyDiff, chromaKeyDiff));\r\n\t/*\r\n\tif (isVideo) {\r\n\t\tvec4 playMapRgba = texture2D(playMap, vUvShader);\r\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2) + (playMapRgba.rgb * mapTween * playMapRgba.a), opacity * chromaKeyValue);\r\n\t} else {\r\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity * chromaKeyValue);\r\n\t}\r\n\t*/\r\n\t// diffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity * chromaKeyValue);\r\n\tdiffuseColor = vec4(mapRgba.rgb, opacity * chromaKeyValue);\r\n\r\n\t#include <alphamap_fragment>\r\n\t#include <alphatest_fragment>\r\n\t#include <specularmap_fragment>\r\n\r\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\r\n\t// accumulation (baked indirect lighting only)\r\n\t#ifdef USE_LIGHTMAP\r\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\r\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\r\n\t#else\r\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\r\n\t#endif\r\n\t// modulation\r\n\t#include <aomap_fragment>\r\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\r\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\r\n\r\n\t#include <envmap_fragment>\r\n\r\n\tgl_FragColor = vec4(outgoingLight, diffuseColor.a);\r\n\r\n\t#include <tonemapping_fragment>\r\n\t#include <encodings_fragment>\r\n\t#include <fog_fragment>\r\n\t#include <premultiplied_alpha_fragment>\r\n\t#include <dithering_fragment>\r\n}\r\n`;\r\n\r\nexport default class MediaMesh extends InteractiveMesh {\r\n\r\n\tstatic getMaterial(useChromaKey) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: true, // !!!\r\n\t\t\tdepthWrite: true,\r\n\t\t\ttransparent: true,\r\n\t\t\ttoneMapped: false,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t// blending: THREE.AdditiveBlending,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: useChromaKey ? FRAGMENT_CHROMA_KEY_SHADER : FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tmap: { type: 't', value: Texture.defaultTexture },\r\n\t\t\t\tmapResolution: { value: new THREE.Vector2() },\r\n\t\t\t\tmapTween: { value: 1 },\r\n\t\t\t\tcolor: { value: new THREE.Color('#FFFFFF') },\r\n\t\t\t\tplayMap: { type: 't', value: Texture.defaultTexture },\r\n\t\t\t\tplayMapResolution: { value: new THREE.Vector2() },\r\n\t\t\t\tplayMapTween: { value: 0 },\r\n\t\t\t\tplayMapColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t\tisVideo: { value: false },\r\n\t\t\t},\r\n\t\t\textensions: {\r\n\t\t\t\tfragDepth: true,\r\n\t\t\t},\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getChromaKeyMaterial(chromaKeyColor = [0.0, 1.0, 0.0]) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: true, // !!!\r\n\t\t\tdepthWrite: true,\r\n\t\t\ttransparent: true,\r\n\t\t\ttoneMapped: false,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t// blending: THREE.AdditiveBlending,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: FRAGMENT_CHROMA_KEY_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tmap: { type: 't', value: null }, // Texture.defaultTexture\r\n\t\t\t\tmapResolution: { value: new THREE.Vector2() },\r\n\t\t\t\tmapTween: { value: 1 },\r\n\t\t\t\tcolor: { value: new THREE.Color('#FFFFFF') },\r\n\t\t\t\tchromaKeyColor: { value: new THREE.Color(chromaKeyColor[0], chromaKeyColor[1], chromaKeyColor[2]) },\r\n\t\t\t\tplayMap: { type: 't', value: Texture.defaultTexture },\r\n\t\t\t\tplayMapResolution: { value: new THREE.Vector2() },\r\n\t\t\t\tplayMapTween: { value: 0 },\r\n\t\t\t\tplayMapColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t\tisVideo: { value: false },\r\n\t\t\t},\r\n\t\t\textensions: {\r\n\t\t\t\tfragDepth: true,\r\n\t\t\t},\r\n\t\t});\r\n\t\tmaterial.map = true;\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic isPublisherStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher && stream.clientInfo.uid === stream.getId();\r\n\t}\r\n\tstatic isAttendeeStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee && stream.clientInfo.uid === stream.getId();\r\n\t}\r\n\tstatic isSmartDeviceStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.SmartDevice && stream.clientInfo.uid === stream.getId();\r\n\t}\r\n\tstatic isPublisherScreen(stream) {\r\n\t\t// console.log(stream.clientInfo, stream.clientInfo ? [stream.clientInfo.role, stream.clientInfo.screenUid, stream.getId()] : null);\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher && stream.clientInfo.screenUid === stream.getId();\r\n\t}\r\n\tstatic isAttendeeScreen(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee && stream.clientInfo.screenUid === stream.getId();\r\n\t}\r\n\tstatic getTypeMatcher(assetType) {\r\n\t\tlet matcher;\r\n\t\tswitch (assetType.name) {\r\n\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tmatcher = this.isPublisherStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tmatcher = this.isAttendeeStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\tmatcher = this.isSmartDeviceStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tmatcher = this.isPublisherScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tmatcher = this.isAttendeeScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tmatcher = (stream) => { return false; };\r\n\t\t}\r\n\t\treturn matcher;\r\n\t}\r\n\r\n\tstatic getStreamId$(item) {\r\n\t\tif (!item.asset) {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t\tconst assetType = item.asset.type;\r\n\t\tconst file = item.asset.file;\r\n\t\t// console.log(item.asset, assetIsStream(item.asset));\r\n\t\tif (assetIsStream(item.asset)) {\r\n\t\t\t// console.log('MediaMesh.getStreamId$', item.asset.type.name);\r\n\t\t\treturn StreamService.streams$.pipe(\r\n\t\t\t\tmap((streams) => {\r\n\t\t\t\t\tlet stream;\r\n\t\t\t\t\tlet i = 0;\r\n\t\t\t\t\tconst matchType = this.getTypeMatcher(assetType);\r\n\t\t\t\t\tstreams.forEach(x => {\r\n\t\t\t\t\t\t// console.log('MediaMesh.getStreamId$', x.clientInfo, x.clientInfo ? [x.clientInfo.screenUid, x.getId()] : null);\r\n\t\t\t\t\t\tif (matchType(x)) {\r\n\t\t\t\t\t\t\tif (i === item.asset.index) {\r\n\t\t\t\t\t\t\t\tstream = x;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ti++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tif (stream) {\r\n\t\t\t\t\t\t// console.log('MediaMesh.getStreamId$', assetType.name, stream.clientInfo.role, stream.getId());\r\n\t\t\t\t\t\treturn stream.getId();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// console.log('MediaMesh.getStreamId$.notfound', assetType.name);\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(file);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getMaterialByItem(item) {\r\n\t\tlet material;\r\n\t\tif (item.asset && item.asset.chromaKeyColor) {\r\n\t\t\tmaterial = MediaMesh.getChromaKeyMaterial(item.asset.chromaKeyColor);\r\n\t\t} else if (item.asset) {\r\n\t\t\t// material = new THREE.MeshBasicMaterial({ color: 0x888888 });\r\n\t\t\t// material = new THREE.MeshBasicMaterial({ color: 0xffffff, toneMapped: false });\r\n\t\t\tmaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, toneMapped: false });\r\n\t\t\t// material = new THREE.MeshPhysicalMaterial({ clearcoat: 1, clearcoatRoughness: 0, toneMapped: false, encoding: THREE.sRGBEncoding });\r\n\t\t} else {\r\n\t\t\tmaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, toneMapped: false });\r\n\t\t}\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getUniformsByItem(item) {\r\n\t\tlet uniforms = null;\r\n\t\tif (item.asset) {\r\n\t\t\tuniforms = {\r\n\t\t\t\tmapTween: 1,\r\n\t\t\t\tplayMapTween: 0,\r\n\t\t\t\topacity: 0,\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn uniforms;\r\n\t}\r\n\r\n\tget editing() {\r\n\t\treturn this.editing_;\r\n\t}\r\n\tset editing(editing) {\r\n\t\tif (this.editing_ !== editing) {\r\n\t\t\tthis.editing_ = editing;\r\n\t\t\t// this.zoomed = editing ? false : (this.view.type.name === 'media' ? true : this.zoomed);\r\n\t\t\tthis.zoomed = this.view.type.name === 'media' ? true : (editing ? false : this.zoomed);\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(item, view, geometry, host) {\r\n\t\tconst material = MediaMesh.getMaterialByItem(item);\r\n\t\tsuper(geometry, material);\r\n\t\t// this.renderOrder = environment.renderOrder.plane;\r\n\t\tthis.item = item;\r\n\t\tthis.view = view;\r\n\t\tthis.items = view.items;\r\n\t\tthis.host = host;\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tthis.object = new THREE.Object3D();\r\n\t\tthis.tempPosition = new THREE.Vector3();\r\n\t\tthis.tempRotation = new THREE.Vector3();\r\n\t\titem.silent = this.isAutoplayLoop; // !!!\r\n\t\tconst mediaLoader = this.mediaLoader = new MediaLoader(item);\r\n\t\tthis.onOver = this.onOver.bind(this);\r\n\t\tthis.onOut = this.onOut.bind(this);\r\n\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\tthis.onZoomed = this.onZoomed.bind(this);\r\n\t\tthis.addPlayBtn();\r\n\t\tthis.addZoomBtn();\r\n\t\tthis.userData.render = (time, tick) => {\r\n\t\t\tthis.render(this, time, tick);\r\n\t\t};\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tif (this.playBtn) {\r\n\t\t\tthis.remove(this.playBtn);\r\n\t\t}\r\n\t\tif (this.zoomBtn) {\r\n\t\t\tthis.remove(this.zoomBtn);\r\n\t\t}\r\n\t\tif (!this.item.asset) {\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst material = this.material;\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tconst onMediaLoaderLoaded = (texture) => {\r\n\t\t\t// console.log('MediaMesh.texture', texture);\r\n\t\t\tconst loader = this.mediaLoader;\r\n\t\t\tif (!loader) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (texture) {\r\n\t\t\t\t// texture.encoding = THREE.sRGBEncoding;\r\n\t\t\t\tmaterial.map = texture; // !!! Enables USE_MAP\r\n\t\t\t\tif (material.uniforms) {\r\n\t\t\t\t\tmaterial.uniforms.map.value = texture;\r\n\t\t\t\t\t// material.uniforms.mapResolution.value.x = texture.image.width;\r\n\t\t\t\t\t// material.uniforms.mapResolution.value.y = texture.image.height;\r\n\t\t\t\t\tmaterial.uniforms.mapResolution.value = new THREE.Vector2(texture.image.width || texture.image.videoWidth, texture.image.height || texture.image.videoHeight);\r\n\t\t\t\t\tif (loader.isPlayableVideo) {\r\n\t\t\t\t\t\tthis.makePlayMap(texture, (playMap) => {\r\n\t\t\t\t\t\t\t// console.log('MediaMesh.playMap', playMap);\r\n\t\t\t\t\t\t\tplayMap.minFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\t\tplayMap.magFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\t\tplayMap.mapping = THREE.UVMapping;\r\n\t\t\t\t\t\t\t// playMap.format = THREE.RGBAFormat;\r\n\t\t\t\t\t\t\tplayMap.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\t\t\t\tplayMap.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\t\t\t\tmaterial.uniforms.playMap.value = playMap;\r\n\t\t\t\t\t\t\t// material.uniforms.playMapResolution.value.x = playMap.image.width;\r\n\t\t\t\t\t\t\t// material.uniforms.playMapResolution.value.y = playMap.image.height;\r\n\t\t\t\t\t\t\tmaterial.uniforms.playMapResolution.value = new THREE.Vector2(playMap.image.width, playMap.image.height);\r\n\t\t\t\t\t\t\t// console.log(material.uniforms.playMapResolution.value, playMap);\r\n\t\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (loader.isPlayableVideo && this.playBtn) {\r\n\t\t\t\tif (material.uniforms) {\r\n\t\t\t\t\tmaterial.uniforms.isVideo.value = true;\r\n\t\t\t\t}\r\n\t\t\t\tthis.on('over', this.onOver);\r\n\t\t\t\tthis.on('out', this.onOut);\r\n\t\t\t\tthis.on('down', this.onToggle);\r\n\t\t\t\tthis.add(this.playBtn);\r\n\t\t\t}\r\n\t\t\tif (this.zoomBtn) {\r\n\t\t\t\tthis.add(this.zoomBtn);\r\n\t\t\t}\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t};\r\n\t\t/*\r\n\t\tsetTimeout(() => {\r\n\t\t\tmediaLoader.load(onMediaLoaderLoaded);\r\n\t\t}, 5000);\r\n\t\t*/\r\n\t\tmediaLoader.load(onMediaLoaderLoaded);\r\n\t}\r\n\r\n\tmakePlayMap(texture, callback) {\r\n\t\tconst aw = texture.image.width || texture.image.videoWidth;\r\n\t\tconst ah = texture.image.height || texture.image.videoHeight;\r\n\t\tconst ar = aw / ah;\r\n\t\tconst scale = 0.32;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = aw;\r\n\t\tcanvas.height = ah;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.imageSmoothingEnabled = true;\r\n\t\tctx.imageSmoothingQuality = 'high';\r\n\t\tconst image = new Image();\r\n\t\timage.onload = function() {\r\n\t\t\tconst bw = image.width;\r\n\t\t\tconst bh = image.height;\r\n\t\t\tconst br = bw / bh;\r\n\t\t\tlet w;\r\n\t\t\tlet h;\r\n\t\t\tif (ar > br) {\r\n\t\t\t\tw = ah * scale;\r\n\t\t\t\th = w / br;\r\n\t\t\t} else {\r\n\t\t\t\th = aw * scale;\r\n\t\t\t\tw = h * br;\r\n\t\t\t}\r\n\t\t\tctx.drawImage(image, aw / 2 - w / 2, ah / 2 - h / 2, w, h);\r\n\t\t\tconst playMap = new THREE.CanvasTexture(canvas);\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(playMap);\r\n\t\t\t}\r\n\t\t};\r\n\t\timage.crossOrigin = 'anonymous';\r\n\t\timage.src = environment.getPath('textures/ui/play.png');\r\n\t}\r\n\r\n\tevents$() {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\tthis.freeze();\r\n\t\t}\r\n\t\treturn MediaLoader.events$.pipe(\r\n\t\t\tfilter(event => (event.loader.item && event.loader.item.id === item.id)),\r\n\t\t\tmap(event => {\r\n\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\tthis.playing = true;\r\n\t\t\t\t\tif (!this.isAutoplayLoop) {\r\n\t\t\t\t\t\tif (this.playBtn) {\r\n\t\t\t\t\t\t\tthis.playBtn.playing = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.emit('playing', true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.onOut();\r\n\t\t\t\t} else if (event instanceof MediaLoaderPauseEvent) {\r\n\t\t\t\t\tthis.playing = false;\r\n\t\t\t\t\tif (this.playBtn) {\r\n\t\t\t\t\t\tthis.playBtn.playing = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.emit('playing', false);\r\n\t\t\t\t\tthis.onOut();\r\n\t\t\t\t} else if (event instanceof MediaLoaderTimeSetEvent) {\r\n\t\t\t\t\tthis.emit('currentTime', event.loader.video.currentTime);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('MediaMesh', this.playing);\r\n\t\t\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\t\t\tconst eventItem = items.find(x => x.asset && event.src.indexOf(x.asset.file) !== -1 && event.id === item.asset.linkedPlayId);\r\n\t\t\t\t\tif (eventItem) {\r\n\t\t\t\t\t\t// console.log('MediaLoader.events$.eventItem', event, eventItem);\r\n\t\t\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\t\t\tthis.play();\r\n\t\t\t\t\t\t} else if (event instanceof MediaLoaderPauseEvent) {\r\n\t\t\t\t\t\t\tthis.pause();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tonAppear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.zoomed = this.view.type.name === 'media' ? true : (this.editing ? false : this.zoomed);\r\n\t}\r\n\r\n\tonDisappear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonOver() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\tmapTween: this.playing ? 0 : 1,\r\n\t\t\t\tplayMapTween: 1,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.mapTween.value = uniforms.mapTween;\r\n\t\t\t\t\tmaterial.uniforms.playMapTween.value = uniforms.playMapTween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (this.playBtn) {\r\n\t\t\tthis.playBtn.onOver();\r\n\t\t}\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\tmapTween: this.playing ? 0 : 1,\r\n\t\t\t\tplayMapTween: 0,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.mapTween.value = uniforms.mapTween;\r\n\t\t\t\t\tmaterial.uniforms.playMapTween.value = uniforms.playMapTween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (this.playBtn) {\r\n\t\t\tthis.playBtn.onOut();\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\tthis.playing = this.mediaLoader.toggle();\r\n\t\tif (this.playBtn) {\r\n\t\t\tthis.playBtn.playing = this.playing;\r\n\t\t}\r\n\t\tthis.emit('playing', this.playing);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tplay() {\r\n\t\tthis.mediaLoader.play();\r\n\t}\r\n\r\n\tpause() {\r\n\t\tthis.mediaLoader.pause();\r\n\t}\r\n\r\n\tsetPlayingState(playing) {\r\n\t\tif (this.playing !== playing) {\r\n\t\t\tthis.playing = playing;\r\n\t\t\tplaying ? this.mediaLoader.play() : this.mediaLoader.pause();\r\n\t\t\tthis.onOut();\r\n\t\t\tif (this.playBtn) {\r\n\t\t\t\tthis.playBtn.playing = playing;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tsetZoomedState(zoomed) {\r\n\t\tthis.zoomed = zoomed;\r\n\t}\r\n\r\n\tsetCurrentTime(currentTime) {\r\n\t\t// !!!\r\n\t\tif (this.mediaLoader.video) {\r\n\t\t\tthis.mediaLoader.video.currentTime = currentTime;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeMaterial() {\r\n\t\tif (this.material) {\r\n\t\t\tif (this.material.map && this.material.map.disposable !== false) {\r\n\t\t\t\tthis.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tthis.material.dispose();\r\n\t\t\t// this.material = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeMediaLoader() {\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tif (mediaLoader) {\r\n\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\tthis.off('over', this.onOver);\r\n\t\t\t\tthis.off('out', this.onOut);\r\n\t\t\t\tthis.off('down', this.onToggle);\r\n\t\t\t}\r\n\t\t\tmediaLoader.dispose();\r\n\t\t\tthis.mediaLoader = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\t// console.log('MediaMesh.dispose');\r\n\t\tthis.removePlayBtn();\r\n\t\tthis.removeZoomBtn();\r\n\t\tthis.disposeMediaLoader();\r\n\t}\r\n\r\n\tget isAutoplayLoop() {\r\n\t\tconst isAutoplayLoop = this.view.type.name !== 'media' && this.item.asset && this.item.asset.autoplay && this.item.asset.loop;\r\n\t\t// console.log('MediaMesh', isAutoplayLoop);\r\n\t\treturn isAutoplayLoop;\r\n\t}\r\n\r\n\taddPlayBtn() {\r\n\t\tthis.removePlayBtn();\r\n\t\tif (!this.isAutoplayLoop) {\r\n\t\t\tconst playBtn = this.playBtn = new MediaPlayMesh(this.host);\r\n\t\t\tplayBtn.on('over', this.onOver);\r\n\t\t\tplayBtn.on('out', this.onOut);\r\n\t\t\tplayBtn.on('down', this.onToggle);\r\n\t\t\tplayBtn.position.z = 0.01;\r\n\t\t}\r\n\t}\r\n\r\n\tremovePlayBtn() {\r\n\t\tif (this.playBtn) {\r\n\t\t\tthis.remove(this.playBtn);\r\n\t\t\tthis.playBtn.off('over', this.onOver);\r\n\t\t\tthis.playBtn.off('out', this.onOut);\r\n\t\t\tthis.playBtn.off('down', this.onToggle);\r\n\t\t\tthis.playBtn.dispose();\r\n\t\t\tdelete this.playBtn;\r\n\t\t}\r\n\t}\r\n\r\n\tonZoomed(zoomed) {\r\n\t\tthis.zoomed = zoomed;\r\n\t\tthis.emit('zoomed', zoomed);\r\n\t}\r\n\r\n\taddZoomBtn() {\r\n\t\tthis.removeZoomBtn();\r\n\t\tif (this.view.type.name !== 'media' && (!this.item.asset || !this.item.asset.chromaKeyColor)) {\r\n\t\t\tconst zoomBtn = this.zoomBtn = new MediaZoomMesh(this.host);\r\n\t\t\tzoomBtn.on('zoomed', this.onZoomed);\r\n\t\t}\r\n\t}\r\n\r\n\tremoveZoomBtn() {\r\n\t\tif (this.zoomBtn) {\r\n\t\t\tthis.remove(this.zoomBtn);\r\n\t\t\tthis.zoomBtn.off('zoomed', this.onZoomed);\r\n\t\t\tthis.zoomBtn.dispose();\r\n\t\t\tthis.zoomBtn = null;\r\n\t\t\tdelete this.zoomBtn;\r\n\t\t}\r\n\t}\r\n\r\n\tupdateByItem(item) {\r\n\t\tthis.disposeMaterial();\r\n\t\tthis.disposeMediaLoader();\r\n\t\tthis.material = MediaMesh.getMaterialByItem(item);\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tthis.addPlayBtn();\r\n\t\tthis.addZoomBtn();\r\n\t\titem.silent = this.isAutoplayLoop; // !!!\r\n\t\tthis.mediaLoader = new MediaLoader(item);\r\n\t}\r\n\r\n\tupdateFromItem(item) {\r\n\t\t// console.log('MediaMesh.updateFromItem', item);\r\n\t\tif (item.position) {\r\n\t\t\tthis.position.fromArray(item.position);\r\n\t\t}\r\n\t\tif (item.rotation) {\r\n\t\t\tthis.rotation.fromArray(item.rotation);\r\n\t\t}\r\n\t\tif (item.scale) {\r\n\t\t\tthis.scale.fromArray(item.scale);\r\n\t\t}\r\n\t\tif (this.playBtn) {\r\n\t\t\tthis.playBtn.update(this);\r\n\t\t}\r\n\t\t/*\r\n\t\tif (this.zoomBtn) {\r\n\t\t\tthis.zoomBtn.update(this);\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.updateZoom();\r\n\t}\r\n\r\n\tupdateZoom() {\r\n\t\tthis.originalPosition = this.position.clone();\r\n\t\tthis.originalScale = this.scale.clone();\r\n\t\tthis.originalQuaternion = this.quaternion.clone();\r\n\t\tthis.object.position.copy(this.originalPosition);\r\n\t\tthis.object.scale.copy(this.originalScale);\r\n\t\tthis.object.quaternion.copy(this.originalQuaternion);\r\n\t\tif (this.zoomBtn) {\r\n\t\t\tconst scale = this.zoomBtn.scale;\r\n\t\t\tconst position = this.zoomBtn.position;\r\n\t\t\tconst ratio = this.scale.x / this.scale.y;\r\n\t\t\tconst size = 0.1;\r\n\t\t\tscale.set(size / ratio, size, 1);\r\n\t\t\tposition.x = 0.5 - size / ratio / 2;\r\n\t\t\tposition.y = size / 2 - 0.5;\r\n\t\t\tposition.z = 0.01;\r\n\t\t}\r\n\t\t// console.log('MediaMesh.updateZoom', this.scale);\r\n\t}\r\n\r\n\t// zoom\r\n\r\n\trender(time, tick) {\r\n\t\t/*\r\n\t\tif (this.zoomBtn && !this.editing) {\r\n\t\t\tthis.zoomBtn.render(time, tick);\r\n\t\t}\r\n\t\t*/\r\n\t\tif (!this.editing) {\r\n\t\t\tconst object = this.object;\r\n\t\t\t/*\r\n\t\t\tparent.position.lerp(object.position, 0.2);\r\n\t\t\tparent.scale.lerp(object.scale, 0.2);\r\n\t\t\tparent.quaternion.slerp(object.quaternion, 0.2);\r\n\t\t\t*/\r\n\t\t\tif (this.zoomed && !this.host.renderer.xr.isPresenting) {\r\n\t\t\t\tthis.updateObjectMatrix();\r\n\t\t\t}\r\n\t\t\tthis.position.copy(object.position);\r\n\t\t\tthis.scale.copy(object.scale);\r\n\t\t\tthis.quaternion.copy(object.quaternion);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateObjectMatrix() {\r\n\t\tconst object = this.object;\r\n\t\tconst host = this.host;\r\n\t\tif (this.zoomed) {\r\n\t\t\t// const cameraGroup = host.cameraGroup;\r\n\t\t\tconst originalScale = this.originalScale;\r\n\t\t\tlet camera = host.camera, fov = camera.fov, aspect = camera.aspect, scale;\r\n\t\t\tconst position = this.tempPosition;\r\n\t\t\tconst rotation = this.tempRotation;\r\n\t\t\t// const aspect = originalScale.x / originalScale.y;\r\n\t\t\tscale = 0.01; // 0.01;\r\n\t\t\tconst xr = host.renderer.xr;\r\n\t\t\tif (xr.isPresenting) {\r\n\t\t\t\tcamera = xr.getCamera(camera);\r\n\t\t\t\tconst mat = camera.projectionMatrix.elements;\r\n\t\t\t\tconst a = mat[0];\r\n\t\t\t\tconst b = mat[5];\r\n\t\t\t\t// const c = mat[10];\r\n\t\t\t\t// const d = mat[14];\r\n\t\t\t\taspect = b / a;\r\n\t\t\t\t// const k = (c - 1) / (c + 1);\r\n\t\t\t\t// const clip_min = (d * (1 - k)) / (2 * k);\r\n\t\t\t\t// const clip_max = k * clip_min;\r\n\t\t\t\t// const RAD2DEG = 180 / 3.14159265358979323846;\r\n\t\t\t\tconst RAD2DEG = 180 / 3.141592653589793;\r\n\t\t\t\tfov = RAD2DEG * (2 * Math.atan(1 / b));\r\n\t\t\t\tscale = 1;\r\n\t\t\t}\r\n\t\t\tobject.scale.copy(originalScale).multiplyScalar(scale);\r\n\t\t\tconst distance = Host.getDistanceToCamera(camera, fov, aspect, object.scale);\r\n\t\t\tcamera.getWorldDirection(rotation);\r\n\t\t\trotation.multiplyScalar(distance);\r\n\t\t\tposition.set(0, 0, 0);\r\n\t\t\tcamera.localToWorld(position);\r\n\t\t\tposition.add(rotation);\r\n\t\t\tobject.position.copy(position);\r\n\t\t\tobject.lookAt(Host.origin);\r\n\t\t\tif (xr.isPresenting) {\r\n\t\t\t\tobject.position.y -= object.scale.y / 2;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tzoomed_ = false;\r\n\tget zoomed() {\r\n\t\treturn this.zoomed_;\r\n\t}\r\n\tset zoomed(zoomed) {\r\n\t\tif (this.zoomed_ !== zoomed) {\r\n\t\t\tthis.zoomed_ = zoomed;\r\n\t\t\tif (zoomed) {\r\n\t\t\t\tthis.renderOrder = environment.renderOrder.panel + 5;\r\n\t\t\t\tthis.material.depthTest = true; // !!! false\r\n\t\t\t\t// this.originalPosition = this.position.clone();\r\n\t\t\t\t// this.originalQuaternion = this.rotation.clone();\r\n\t\t\t\t// this.originalScale = this.scale.clone();\r\n\t\t\t} else {\r\n\t\t\t\tthis.renderOrder = 0;\r\n\t\t\t\tthis.material.depthTest = true;\r\n\t\t\t\tthis.object.position.copy(this.originalPosition);\r\n\t\t\t\tthis.object.scale.copy(this.originalScale);\r\n\t\t\t\tthis.object.quaternion.copy(this.originalQuaternion);\r\n\t\t\t}\r\n\t\t\tthis.material.needsUpdate = true;\r\n\t\t\tthis.updateObjectMatrix();\r\n\t\t\tif (this.zoomBtn) {\r\n\t\t\t\tthis.zoomBtn.zoomed = zoomed;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import { fromEvent, merge, ReplaySubject, Subject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, takeUntil } from 'rxjs/operators';\r\n\r\nexport class DragPoint {\r\n\tconstructor() {\r\n\t\tthis.x = 0;\r\n\t\tthis.y = 0;\r\n\t}\r\n}\r\n\r\nexport class DragEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class DragDownEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragMoveEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragUpEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nlet upEvent;\r\n\r\nexport default class DragService {\r\n\r\n\tstatic getPosition(event, point) {\r\n\t\tif (event instanceof MouseEvent) {\r\n\t\t\tpoint ? (\r\n\t\t\t\tpoint.x = event.clientX,\r\n\t\t\t\tpoint.y = event.clientY\r\n\t\t\t) : point = {\r\n\t\t\t\tx: event.clientX,\r\n\t\t\t\ty: event.clientY,\r\n\t\t\t};\r\n\t\t} else if (window.TouchEvent && event instanceof TouchEvent) {\r\n\t\t\tif (event.touches.length > 0) {\r\n\t\t\t\tpoint ? (\r\n\t\t\t\t\tpoint.x = event.touches[0].pageX,\r\n\t\t\t\t\tpoint.y = event.touches[0].pageY\r\n\t\t\t\t) : point = {\r\n\t\t\t\t\tx: event.touches[0].pageX,\r\n\t\t\t\t\ty: event.touches[0].pageY\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn point;\r\n\t}\r\n\r\n\tstatic down$(target, events$) {\r\n\t\tlet downEvent;\r\n\t\treturn merge(\r\n\t\t\tfromEvent(target, 'mousedown').pipe(filter(event => event.button === 0)),\r\n\t\t\tfromEvent(target, 'touchstart')\r\n\t\t).pipe(\r\n\t\t\tmap((event) => {\r\n\t\t\t\tdownEvent = downEvent || new DragDownEvent();\r\n\t\t\t\tdownEvent.node = target;\r\n\t\t\t\tdownEvent.target = event.target;\r\n\t\t\t\tdownEvent.originalEvent = event;\r\n\t\t\t\tdownEvent.down = this.getPosition(event, downEvent.down);\r\n\t\t\t\tif (downEvent.down) {\r\n\t\t\t\t\tdownEvent.distance = new DragPoint();\r\n\t\t\t\t\tdownEvent.strength = new DragPoint();\r\n\t\t\t\t\tdownEvent.speed = new DragPoint();\r\n\t\t\t\t\tevents$.next(downEvent);\r\n\t\t\t\t\treturn downEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== undefined),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic move$(target, events$, dismiss$, downEvent) {\r\n\t\tlet moveEvent;\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mousemove' : 'touchmove').pipe(\r\n\t\t\tstartWith(downEvent),\r\n\t\t\tmap((event) => {\r\n\t\t\t\tmoveEvent = moveEvent || new DragMoveEvent();\r\n\t\t\t\tmoveEvent.node = target;\r\n\t\t\t\tmoveEvent.target = event.target;\r\n\t\t\t\tmoveEvent.originalEvent = event;\r\n\t\t\t\tmoveEvent.position = this.getPosition(event, moveEvent.position);\r\n\t\t\t\tconst dragging = downEvent.down !== undefined && moveEvent.position !== undefined;\r\n\t\t\t\tif (dragging) {\r\n\t\t\t\t\tmoveEvent.distance.x = moveEvent.position.x - downEvent.down.x;\r\n\t\t\t\t\tmoveEvent.distance.y = moveEvent.position.y - downEvent.down.y;\r\n\t\t\t\t\tmoveEvent.strength.x = moveEvent.distance.x / window.innerWidth * 2;\r\n\t\t\t\t\tmoveEvent.strength.y = moveEvent.distance.y / window.innerHeight * 2;\r\n\t\t\t\t\tmoveEvent.speed.x = downEvent.speed.x + (moveEvent.strength.x - downEvent.strength.x) * 0.1;\r\n\t\t\t\t\tmoveEvent.speed.y = downEvent.speed.y + (moveEvent.strength.y - downEvent.strength.y) * 0.1;\r\n\t\t\t\t\tdownEvent.distance.x = moveEvent.distance.x;\r\n\t\t\t\t\tdownEvent.distance.y = moveEvent.distance.y;\r\n\t\t\t\t\tdownEvent.speed.x = moveEvent.speed.x;\r\n\t\t\t\t\tdownEvent.speed.y = moveEvent.speed.y;\r\n\t\t\t\t\tdownEvent.strength.x = moveEvent.strength.x;\r\n\t\t\t\t\tdownEvent.strength.y = moveEvent.strength.y;\r\n\t\t\t\t\tevents$.next(moveEvent);\r\n\t\t\t\t\treturn moveEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dismissEvent(event, events$, dismiss$, downEvent) {\r\n\t\t// console.log('DragService.dismissEvent', event);\r\n\t\tupEvent = upEvent || new DragUpEvent();\r\n\t\tevents$.next(upEvent);\r\n\t\tdismiss$.next();\r\n\t\t// console.log(downEvent.distance);\r\n\t\tif (downEvent && Math.abs(downEvent.distance.x) > 10) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopImmediatePropagation();\r\n\t\t}\r\n\t\treturn upEvent;\r\n\t}\r\n\r\n\tstatic up$(target, events$, dismiss$, downEvent) {\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mouseup' : 'touchend').pipe(\r\n\t\t\tmap(event => this.dismissEvent(event, events$, dismiss$, downEvent)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic observe$(target) {\r\n\t\ttarget = target || document;\r\n\t\tconst events$ = DragService.events$;\r\n\t\tconst dismiss$ = DragService.dismiss$;\r\n\t\treturn this.down$(target, events$).pipe(\r\n\t\t\tswitchMap((downEvent) => {\r\n\t\t\t\tDragService.downEvent = downEvent;\r\n\t\t\t\treturn merge(\r\n\t\t\t\t\tthis.move$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t\tthis.up$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t).pipe(\r\n\t\t\t\t\ttakeUntil(dismiss$),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t\tswitchMap(() => events$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n\r\nDragService.events$ = new ReplaySubject(1);\r\nDragService.dismiss$ = new Subject();\r\n","import { combineLatest, ReplaySubject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, tap } from 'rxjs/operators';\r\nimport DragService, { DragDownEvent, DragMoveEvent } from '../../drag/drag.service';\r\nimport KeyboardService from '../../keyboard/keyboard.service';\r\nimport StateService from '../../state/state.service';\r\nimport { RoleType } from '../../user/user';\r\nimport { ViewType } from '../../view/view';\r\nimport { ViewService } from '../../view/view.service';\r\n\r\n// https://github.com/google/model-viewer/blob/master/packages/model-viewer/src/three-components/SmoothControls.ts\r\n\r\nexport const OrbitMode = {\r\n\tPanorama: 'panorama',\r\n\tPanoramaGrid: 'panorama-grid',\r\n\tModel: 'model',\r\n};\r\n\r\nexport class OrbitEvent { }\r\nexport class OrbitDragEvent extends OrbitEvent { }\r\nexport class OrbitResizeEvent extends OrbitEvent { }\r\nexport class OrbitMoveEvent extends OrbitEvent { }\r\nconst orbitMoveEvent = new OrbitMoveEvent();\r\nconst orbitDragEvent = new OrbitDragEvent();\r\nconst orbitResizeEvent = new OrbitResizeEvent();\r\n\r\nexport const USE_DOLLY = false;\r\nexport const DOLLY_MIN = 1; // 15;\r\nexport const DOLLY_MAX = 75; // 115\r\nexport const ZOOM_MIN = 1; // 15;\r\nexport const ZOOM_MAX = 75;\r\n\r\nexport default class OrbitService {\r\n\r\n\tget dolly() {\r\n\t\treturn this.dolly_;\r\n\t}\r\n\tset dolly(dolly) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(dolly, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.dolly_ !== clampedDolly) {\r\n\t\t\tthis.dolly_ = clampedDolly;\r\n\t\t\tthis.markAsDirty();\r\n\t\t}\r\n\t}\r\n\tgetDollyValue() {\r\n\t\treturn (1 - (this.dolly_ - DOLLY_MIN) / (DOLLY_MAX - DOLLY_MIN)) - 0.5;\r\n\t}\r\n\r\n\tget zoom() {\r\n\t\treturn this.zoom_;\r\n\t}\r\n\tset zoom(zoom) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(zoom, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.zoom_ !== clampedDolly) {\r\n\t\t\tthis.zoom_ = clampedDolly;\r\n\t\t\tthis.markAsDirty();\r\n\t\t}\r\n\t}\r\n\tgetZoomValue() {\r\n\t\treturn 1 + 1 - (this.zoom_ - ZOOM_MIN) / (ZOOM_MAX - ZOOM_MIN);\r\n\t}\r\n\r\n\tget mode() {\r\n\t\treturn this.mode_;\r\n\t}\r\n\tset mode(mode) {\r\n\t\tif (this.mode_ !== mode) {\r\n\t\t\tthis.mode_ = mode;\r\n\t\t\tOrbitService.mode = mode;\r\n\t\t\tthis.markAsDirty();\r\n\t\t}\r\n\t}\r\n\r\n\tget controlled() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling !== StateService.state.uid);\r\n\t}\r\n\r\n\tget controlling() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling === StateService.state.uid);\r\n\t}\r\n\r\n\tget silencing() {\r\n\t\treturn StateService.state.silencing;\r\n\t}\r\n\r\n\tget silenced() {\r\n\t\treturn (StateService.state.silencing && StateService.state.role === RoleType.Streamer);\r\n\t}\r\n\r\n\tget spyed() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying === StateService.state.uid);\r\n\t}\r\n\r\n\tget spying() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying !== StateService.state.uid);\r\n\t}\r\n\r\n\tget isMediaView() {\r\n\t\tconst currentView = ViewService.currentView;\r\n\t\treturn currentView && currentView.type.name === ViewType.Media.name;\r\n\t}\r\n\r\n\tget locked() {\r\n\t\treturn this.controlled || this.spying || this.isMediaView;\r\n\t}\r\n\r\n\tconstructor(camera) {\r\n\t\tthis.mode_ = OrbitService.mode = OrbitMode.Panorama;\r\n\t\tthis.dolly_ = 70;\r\n\t\tthis.zoom_ = 70;\r\n\t\tthis.longitude = 0;\r\n\t\tthis.latitude = 0;\r\n\t\tthis.direction = 1;\r\n\t\tthis.radius = 101;\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\t// this.speed = 1;\r\n\t\tthis.inertia = new THREE.Vector2();\r\n\t\tthis.rotation = new THREE.Euler(0, 0, 0, 'XYZ');\r\n\t\tthis.target = new THREE.Vector3();\r\n\t\tthis.updatePosition = new THREE.Vector3();\r\n\t\tthis.updateTarget = new THREE.Vector3();\r\n\t\tthis.camera = camera;\r\n\t\tthis.setLongitudeLatitude(0, 0);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tsetOrientation(orientation) {\r\n\t\tif (orientation) {\r\n\t\t\tthis.setLongitudeLatitude(orientation.longitude, orientation.latitude);\r\n\t\t\tthis.markAsDirty();\r\n\t\t}\r\n\t}\r\n\r\n\tgetOrientation() {\r\n\t\treturn {\r\n\t\t\tlatitude: this.latitude,\r\n\t\t\tlongitude: this.longitude,\r\n\t\t};\r\n\t}\r\n\r\n\tsetLongitudeLatitude(longitude, latitude) {\r\n\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\tthis.longitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\tthis.latitude = latitude;\r\n\t\t// console.log(this.longitude);\r\n\t\tconst phi = THREE.Math.degToRad(90 - latitude);\r\n\t\tconst theta = THREE.Math.degToRad(longitude);\r\n\t\tthis.phi = phi;\r\n\t\tthis.theta = theta;\r\n\t}\r\n\r\n\tobserve$(node) {\r\n\t\t// const camera = this.camera;\r\n\t\tlet latitude, longitude;\r\n\t\treturn combineLatest([KeyboardService.keys$(), DragService.observe$(node)]).pipe(\r\n\t\t\tfilter(event => !this.locked),\r\n\t\t\tmap((datas) => {\r\n\t\t\t\tconst keys = datas[0];\r\n\t\t\t\tconst event = datas[1];\r\n\t\t\t\t// const group = this.objects.children[this.index];\r\n\t\t\t\tif (event instanceof DragDownEvent) {\r\n\t\t\t\t\tlatitude = this.latitude;\r\n\t\t\t\t\tlongitude = this.longitude;\r\n\t\t\t\t} else if (event instanceof DragMoveEvent) {\r\n\t\t\t\t\tif (keys.Shift) {\r\n\t\t\t\t\t\tthis.events$.next(orbitDragEvent);\r\n\t\t\t\t\t} else if (keys.Control) {\r\n\t\t\t\t\t\tthis.events$.next(orbitResizeEvent);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst flip = this.mode_ === OrbitMode.Model ? -1 : 1;\r\n\t\t\t\t\t\tthis.setLongitudeLatitude(longitude - event.distance.x * 0.1 * flip, latitude + event.distance.y * 0.1);\r\n\t\t\t\t\t}\r\n\t\t\t\t} /* else if (event instanceof DragUpEvent) {\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\tfilter(event => event instanceof DragMoveEvent),\r\n\t\t\tstartWith({ latitude: this.latitude, longitude: this.longitude }),\r\n\t\t\ttap(event => this.markAsDirty()),\r\n\t\t\tswitchMap(event => this.events$),\r\n\t\t);\r\n\t}\r\n\r\n\twalk(position, callback) {\r\n\t\tlet radius;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = 3;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t}\r\n\t\tconst heading = new THREE.Vector2(position.x, position.y).normalize().multiplyScalar(radius);\r\n\t\tconst headingTheta = Math.atan2(heading.y, heading.x);\r\n\t\tlet headingLongitude = THREE.MathUtils.radToDeg(headingTheta);\r\n\t\theadingLongitude = (headingLongitude < 0 ? 360 + headingLongitude : headingLongitude) % 360;\r\n\t\tconst headingLatitude = 0;\r\n\t\tconst latitude = this.latitude;\r\n\t\tconst longitude = this.longitude;\r\n\t\tlet differenceLongitude = (headingLongitude - longitude);\r\n\t\tdifferenceLongitude = Math.abs(differenceLongitude) > 180 ? (differenceLongitude - 360 * (differenceLongitude / Math.abs(differenceLongitude))) : differenceLongitude;\r\n\t\tlet differenceLatitude = (headingLatitude - latitude);\r\n\t\tdifferenceLatitude = Math.abs(differenceLatitude) > 90 ? (differenceLatitude - 90 * (differenceLatitude / Math.abs(differenceLatitude))) : differenceLatitude;\r\n\t\t// console.log('headingTheta', headingTheta, 'headingLongitude', headingLongitude, 'differenceLongitude', differenceLongitude);\r\n\t\tconst from = { tween: 0 };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.7,\r\n\t\t\ttween: 1,\r\n\t\t\tdelay: 0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.setLongitudeLatitude(longitude + differenceLongitude * from.tween, latitude + differenceLatitude * from.tween);\r\n\t\t\t\tthis.position.set(position.x * from.tween, 0, position.y * from.tween);\r\n\t\t\t\tthis.markAsDirty();\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\t// this.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(headingLongitude, headingLatitude);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\twalkComplete(headingLongitude, headingLatitude) {\r\n\t\tthis.setLongitudeLatitude(headingLongitude, headingLatitude);\r\n\t\tthis.position.set(0, 0, 0);\r\n\t\tthis.markAsDirty();\r\n\t}\r\n\r\n\tlookAt(object) {\r\n\t\t// console.log('OrbitService.lookAt', object);\r\n\t\tif (object) {\r\n\t\t\tlet position = object.position.clone();\r\n\t\t\tconst camera = this.camera;\r\n\t\t\tconst cameraGroup = camera.parent;\r\n\t\t\tposition = cameraGroup.worldToLocal(position);\r\n\t\t\tlet radius;\r\n\t\t\tswitch (this.mode_) {\r\n\t\t\t\tcase OrbitMode.Model:\r\n\t\t\t\t\tradius = 3;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tradius = this.radius;\r\n\t\t\t}\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.markAsDirty();\r\n\t\t}\r\n\t}\r\n\r\n\tsetVRCamera(camera) {\r\n\t\tif (camera) {\r\n\t\t\tconst radius = this.radius;\r\n\t\t\tconst position = new THREE.Vector3(0, 0, -radius);\r\n\t\t\tconst quaternion = new THREE.Quaternion(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t\tposition.applyQuaternion(quaternion);\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.markAsDirty();\r\n\t\t}\r\n\t}\r\n\r\n\trender() {\r\n\t\t// slowly rotate scene when not hosted\r\n\t\tif (!StateService.state.hosted) {\r\n\t\t\tthis.longitude += 0.025;\r\n\t\t\tthis.isDirty = true;\r\n\t\t}\r\n\t\tif (this.isDirty) {\r\n\t\t\tthis.isDirty = false;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tmarkAsDirty() {\r\n\t\tthis.isDirty = true;\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tlet radius, position = this.updatePosition, target = this.updateTarget;\r\n\t\tconst zoom = this.getZoomValue();\r\n\t\tconst dolly = this.getDollyValue();\r\n\t\t// console.log('dolly', dolly);\r\n\t\tconst phi = THREE.MathUtils.degToRad(90 - this.latitude);\r\n\t\tconst theta = THREE.MathUtils.degToRad(this.longitude);\r\n\t\tconst camera = this.camera;\r\n\t\tconst cameraGroup = camera.parent;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = USE_DOLLY ? 3 + 3 * dolly : 3;\r\n\t\t\t\tposition.copy(this.position);\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\t// position = cameraGroup.worldToLocal(position);\r\n\t\t\t\ttarget = cameraGroup.worldToLocal(target);\r\n\t\t\t\tcamera.target.copy(position);\r\n\t\t\t\tcamera.position.copy(target);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tif (USE_DOLLY) {\r\n\t\t\t\t\tposition.copy(target).position.multiplyScalar(-1 * dolly);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tposition.copy(this.position);\r\n\t\t\t\t}\r\n\t\t\t\t// !!! position for walking panorama-grid\r\n\t\t\t\t// position = cameraGroup.worldToLocal(position);\r\n\t\t\t\ttarget = cameraGroup.worldToLocal(target);\r\n\t\t\t\t// camera.position.copy(position);\r\n\t\t\t\tcamera.target.copy(target);\r\n\t\t\t\tcamera.position.copy(position);\r\n\t\t}\r\n\t\t// console.log(camera.position.x, camera.position.y, camera.position.z);\r\n\t\t// console.log(camera.target.x, camera.target.y, camera.target.z);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t\t// this.inverse();\r\n\t\tif (!USE_DOLLY) {\r\n\t\t\tcamera.zoom = zoom;\r\n\t\t}\r\n\t\tcamera.lookAt(camera.target);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tconst currentView = ViewService.currentView;\r\n\t\tif (currentView) {\r\n\t\t\tcurrentView.lastOrientation.longitude = this.longitude;\r\n\t\t\tcurrentView.lastOrientation.latitude = this.latitude;\r\n\t\t}\r\n\t\tthis.events$.next(orbitMoveEvent);\r\n\t}\r\n\r\n}\r\n\r\nOrbitService.orbitMoveEvent = orbitMoveEvent;\r\n","import { fromEvent, of } from 'rxjs';\r\nimport { auditTime, filter, finalize, map, takeWhile } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\n\r\nlet UID = 0;\r\n\r\nexport const ImageServiceEvent = {\r\n\tProgress: 'progress',\r\n\tComplete: 'complete',\r\n};\r\nexport default class ImageService {\r\n\r\n\tstatic worker() {\r\n\t\tif (!this.worker_) {\r\n\t\t\tthis.worker_ = new Worker(environment.workers.image);\r\n\t\t}\r\n\t\treturn this.worker_;\r\n\t}\r\n\r\n\tstatic events$(src, size) {\r\n\t\tif (!('Worker' in window) || this.isBlob(src) || this.isCors(src)) {\r\n\t\t\treturn of({ type: ImageServiceEvent.Complete, data: src });\r\n\t\t}\r\n\t\tconst id = ++UID;\r\n\t\tconst worker = this.worker();\r\n\t\tworker.postMessage({ src, id, size });\r\n\t\tlet lastEvent;\r\n\t\treturn fromEvent(worker, 'message').pipe(\r\n\t\t\tmap(event => event.data),\r\n\t\t\tfilter(event => event.src === src),\r\n\t\t\tauditTime(100),\r\n\t\t\tmap(event => {\r\n\t\t\t\t// console.log('ImageService', event);\r\n\t\t\t\tif (event.type === ImageServiceEvent.Complete && event.data instanceof Blob) {\r\n\t\t\t\t\tconst url = URL.createObjectURL(event.data);\r\n\t\t\t\t\tevent.data = url;\r\n\t\t\t\t}\r\n\t\t\t\tlastEvent = event;\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t\tfinalize(() => {\r\n\t\t\t\t// console.log('ImageService.finalize', lastEvent);\r\n\t\t\t\tworker.postMessage({ id });\r\n\t\t\t\t/*\r\n\t\t\t\tif (lastEvent && lastEvent.type === ImageServiceEvent.Complete && lastEvent.data) {\r\n\t\t\t\t\tURL.revokeObjectURL(lastEvent.data);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic load$(src, size) {\r\n\t\treturn this.events$(src, size).pipe(\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tmap(event => event.data),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic isCors(src) {\r\n\t\t// !!! handle cors environment flag\r\n\t\treturn false;\r\n\t\t// return src.indexOf('://') !== -1 && src.indexOf(window.location.host) === -1;\r\n\t}\r\n\r\n\tstatic isBlob(src) {\r\n\t\treturn src.indexOf('blob:') === 0;\r\n\t}\r\n\r\n}\r\n","import { fromEvent } from 'rxjs';\r\nimport { filter, first, map, switchMap, takeUntil, takeWhile, tap } from 'rxjs/operators';\r\nimport { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader.js';\r\nimport { AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport ImageService, { ImageServiceEvent } from '../../image/image.service';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport StreamService from '../../stream/stream.service';\r\nimport MediaLoader, { MediaLoaderDisposeEvent, MediaLoaderPauseEvent, MediaLoaderPlayEvent, MediaLoaderTimeSetEvent, MediaLoaderTimeUpdateEvent } from '../media/media-loader';\r\nimport MediaMesh from '../media/media-mesh';\r\n\r\nexport class PanoramaLoader {\r\n\r\n\tstatic get video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tstatic set video(video) {\r\n\t\tif (this.video_) {\r\n\t\t\tthis.video_.muted = true;\r\n\t\t\tthis.video_.pause();\r\n\t\t\tif (this.video_.parentNode) {\r\n\t\t\t\tthis.video_.parentNode.removeChild(this.video_);\r\n\t\t\t}\r\n\t\t\tthis.video_ = null;\r\n\t\t}\r\n\t\tif (video) {\r\n\t\t\tconst video = this.video_ = document.createElement('video');\r\n\t\t\tvideo.loop = true;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\t// document.querySelector('body').appendChild(video);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tstatic set muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('PanoramaLoader.muted', muted, this.video);\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic set cubeRenderTarget(cubeRenderTarget) {\r\n\t\tif (this.cubeRenderTarget_) {\r\n\t\t\tthis.cubeRenderTarget_.texture.dispose();\r\n\t\t\tthis.cubeRenderTarget_.dispose();\r\n\t\t}\r\n\t\tthis.cubeRenderTarget_ = cubeRenderTarget;\r\n\t}\r\n\r\n\tstatic set texture(texture) {\r\n\t\tif (this.texture_) {\r\n\t\t\tthis.texture_.dispose();\r\n\t\t}\r\n\t\tthis.texture_ = texture;\r\n\t}\r\n\r\n\tstatic load(asset, renderer, callback) {\r\n\t\tMediaLoader.events$.next(new MediaLoaderDisposeEvent(this));\r\n\t\tthis.video = null;\r\n\t\tif (!asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// console.log('PanoramaLoader.load', asset.type.name, AssetType);\r\n\t\tif (asset.type.name === AssetType.PublisherStream.name) {\r\n\t\t\treturn this.loadPublisherStreamBackground(renderer, callback);\r\n\t\t} else if (asset.type.name === AssetType.AttendeeStream.name) {\r\n\t\t\treturn this.loadAttendeeStreamBackground(renderer, callback);\r\n\t\t\t/*} else if (assetIsStream(asset)) {\r\n\t\t\t\treturn this.loadStreamBackground(renderer, callback, asset);\r\n\t\t\t\t*/\r\n\t\t} else if (asset.file.indexOf('.mp4') !== -1 || asset.file.indexOf('.webm') !== -1) {\r\n\t\t\treturn this.loadVideoBackground(environment.getPath(asset.folder), asset.file, renderer, callback);\r\n\t\t} else if (asset.file.indexOf('.m3u8') !== -1) {\r\n\t\t\treturn this.loadHlslVideoBackground(asset.file, renderer, callback);\r\n\t\t} else if (asset.file.indexOf('.hdr') !== -1) {\r\n\t\t\treturn this.loadRgbeBackground(environment.getPath(asset.folder), asset.file, renderer, callback);\r\n\t\t} else {\r\n\t\t\treturn this.loadBackgroundImageService(environment.getPath(asset.folder), asset.file, renderer, callback);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadBackgroundImageService(folder, file, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst image = new Image();\r\n\t\tImageService.events$(folder + file).pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tif (event.type === ImageServiceEvent.Progress) {\r\n\t\t\t\t\tLoaderService.setProgress(progressRef, event.data.loaded, event.data.total);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst load = fromEvent(image, 'load');\r\n\t\t\t\timage.crossOrigin = 'anonymous';\r\n\t\t\t\timage.src = event.data;\r\n\t\t\t\treturn load;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t).subscribe(event => {\r\n\t\t\tconst texture = new THREE.Texture(image);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t// console.log('texture', texture, THREE.RGBAFormat, THREE.LinearEncoding);\r\n\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t// texture.encoding = THREE.LinearEncoding;\r\n\t\t\ttexture.toneMapped = false;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t\tURL.revokeObjectURL(event.data);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic loadBackground(folder, file, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tloader.setPath(folder).load(file, (texture) => {\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t// texture.encoding = THREE.LinearEncoding;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t}, (request) => {\r\n\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadRgbeBackground(folder, file, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst loader = new RGBELoader();\r\n\t\tloader.setDataType(THREE.UnsignedByteType).setPath(folder).load(file, (texture) => {\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture, true);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t}, (request) => {\r\n\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadHlslVideoBackground(src, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst video = document.createElement('video');\r\n\t\tconst onPlaying = () => {\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t// texture.encoding = THREE.LinearEncoding;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t};\r\n\t\tvideo.oncanplay = () => {\r\n\t\t\t// console.log('videoReady', videoReady);\r\n\t\t\tonPlaying();\r\n\t\t};\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\thls.attachMedia(video);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\tvideo.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t// !!! implementing medialoader interface\r\n\t// static get progress\r\n\t// static set progress\r\n\t// static play\r\n\t// static pause\r\n\r\n\tstatic get progress() {\r\n\t\tconst video = this.video;\r\n\t\tif (video) {\r\n\t\t\treturn video.currentTime / video.duration;\r\n\t\t} else {\r\n\t\t\treturn 0;\r\n\t\t}\r\n\t}\r\n\tstatic set progress(progress) {\r\n\t\tconst video = this.video;\r\n\t\tif (video) {\r\n\t\t\tconst currentTime = video.duration * progress;\r\n\t\t\tif (video.seekable.length > progress && video.currentTime !== currentTime) {\r\n\t\t\t\t// console.log('PanoramaLoader', 'progress', progress, 'currentTime', currentTime, 'duration', this.video.duration, 'seekable', this.video.seekable);\r\n\t\t\t\tvideo.currentTime = currentTime;\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderTimeSetEvent(this));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tstatic play(silent) {\r\n\t\t// console.log('PanoramaLoader.play');\r\n\t\tconst video = this.video;\r\n\t\tif (video) {\r\n\t\t\tvideo.muted = this.muted_;\r\n\t\t\tvideo.play().then(() => {\r\n\t\t\t\t// console.log('PanoramaLoader.play.success', this.video.src);\r\n\t\t\t\tif (!silent) {\r\n\t\t\t\t\tMediaLoader.events$.next(new MediaLoaderPlayEvent(this));\r\n\t\t\t\t}\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaLoader.play.error', video.src, error);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\tstatic pause(silent) {\r\n\t\t// console.log('PanoramaLoader.pause');\r\n\t\tconst video = this.video;\r\n\t\tif (video) {\r\n\t\t\tvideo.muted = true;\r\n\t\t\tvideo.pause();\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPauseEvent(this));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadVideoBackground(folder, file, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tthis.video = true;\r\n\t\tconst video = this.video;\r\n\t\tconst loop = true;\r\n\t\tconst autoplay = true;\r\n\t\tconst onCanPlay = () => {\r\n\t\t\t// console.log('PanoramaLoader', 'onPlaying');\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t// texture.encoding = THREE.LinearEncoding;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t}\r\n\t\t\t// console.log('loadVideoBackground.loaded');\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\tif (autoplay) {\r\n\t\t\t\tthis.play();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.pause();\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst onTimeUpdate = () => {\r\n\t\t\tMediaLoader.events$.next(new MediaLoaderTimeUpdateEvent(this));\r\n\t\t};\r\n\t\tconst onEnded = () => {\r\n\t\t\tif (!loop) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPauseEvent(this));\r\n\t\t\t}\r\n\t\t};\r\n\t\tvideo.oncanplay = onCanPlay;\r\n\t\tvideo.ontimeupdate = onTimeUpdate;\r\n\t\tvideo.onended = onEnded;\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tvideo.src = folder + file;\r\n\t\tvideo.load();\r\n\t}\r\n\r\n\tstatic loadPublisherStreamBackground(renderer, callback) {\r\n\t\tconst onPublisherStreamId = (publisherStreamId) => {\r\n\t\t\tconst video = document.querySelector(`#stream-${publisherStreamId} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t\t// texture.encoding = THREE.LinearEncoding;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonPlaying();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\tonPlaying();\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t};\r\n\t\tStreamService.getPublisherStreamId$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(publisherStreamId => onPublisherStreamId(publisherStreamId));\r\n\t}\r\n\r\n\tstatic loadAttendeeStreamBackground(renderer, callback) {\r\n\t\tconst onAttendeeStreamId = (attendeeStreamId) => {\r\n\t\t\tconst video = document.querySelector(`#stream-${attendeeStreamId} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t\t// texture.encoding = THREE.LinearEncoding;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonPlaying();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\tonPlaying();\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t};\r\n\t\tStreamService.getAttendeeStreamId$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(attendeeStreamId => onAttendeeStreamId(attendeeStreamId));\r\n\t}\r\n\r\n\tstatic loadStreamBackground(renderer, callback, asset) {\r\n\t\tconst onStreamId = (streamId) => {\r\n\t\t\tconst video = document.querySelector(`#stream-${streamId} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t\t// texture.encoding = THREE.LinearEncoding;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonPlaying();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\tonPlaying();\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t};\r\n\t\tPanoramaLoader.getStreamId$(asset).pipe(\r\n\t\t\ttakeUntil(MediaLoader.events$.pipe(\r\n\t\t\t\tfilter(event => event instanceof MediaLoaderDisposeEvent),\r\n\t\t\t)),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tonStreamId(streamId);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic getStreamId$(asset) {\r\n\t\tconst assetType = asset.type;\r\n\t\treturn StreamService.streams$.pipe(\r\n\t\t\tmap((streams) => {\r\n\t\t\t\t// console.log('streams', streams);\r\n\t\t\t\tlet stream;\r\n\t\t\t\tlet i = 0;\r\n\t\t\t\tconst matchType = MediaMesh.getTypeMatcher(assetType);\r\n\t\t\t\tstreams.forEach(x => {\r\n\t\t\t\t\t// console.log('streams', matchType(x), x, asset);\r\n\t\t\t\t\tif (matchType(x)) {\r\n\t\t\t\t\t\tif (i === asset.index) {\r\n\t\t\t\t\t\t\tstream = x;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\ti++;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif (stream) {\r\n\t\t\t\t\treturn stream.getId();\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n","import { Asset, AssetType } from '../../asset/asset';\r\nimport { LanguageService } from '../../language/language.service';\r\nimport StateService from '../../state/state.service';\r\nimport { PanoramaGridView, ViewType } from '../../view/view';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport { PanoramaLoader } from './panorama-loader';\r\n\r\nexport default class Panorama {\r\n\r\n\tconstructor(renderer) {\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => PanoramaLoader.muted = state.volumeMuted);\r\n\t\tthis.tween = 0;\r\n\t\tthis.create(renderer);\r\n\t}\r\n\r\n\tcreate(renderer) {\r\n\t\tthis.renderer = renderer;\r\n\t\tthis.onCubeMapDispose = this.onCubeMapDispose.bind(this);\r\n\t\tconst geometry = new THREE.BoxGeometry(202, 202, 202);\r\n\t\tconst material = this.getBlackMaterial();\r\n\t\tconst mesh = new InteractiveMesh(geometry, material);\r\n\t\tmesh.userData = {\r\n\t\t\trender: (time, tick, renderer, scene, camera) => {\r\n\t\t\t\tmesh.matrixWorld.copyPosition(camera.matrixWorld);\r\n\t\t\t\tconst cubeMap = this.cubeMap;\r\n\t\t\t\tconst texture = this.texture;\r\n\t\t\t\tif (cubeMap && texture && texture.isVideoTexture) {\r\n\t\t\t\t\tthis.updateCubeMapEquirectangularTexture(cubeMap, renderer, texture);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t};\r\n\t\tmesh.name = '[panorama]';\r\n\t\tthis.mesh = mesh;\r\n\t}\r\n\r\n\tgetBlackMaterial() {\r\n\t\treturn new THREE.MeshBasicMaterial({\r\n\t\t\tname: 'PanoramaStandardMaterial',\r\n\t\t\tcolor: 0x000000,\r\n\t\t\tside: THREE.BackSide,\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tfog: false,\r\n\t\t});\r\n\t}\r\n\r\n\tgetShaderMaterial(texture) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tname: 'PanoramaCubeMaterial',\r\n\t\t\tuniforms: this.cloneUniforms(THREE.ShaderLib.cube.uniforms),\r\n\t\t\tvertexShader: THREE.ShaderLib.cube.vertexShader,\r\n\t\t\tfragmentShader: THREE.ShaderLib.cube.fragmentShader,\r\n\t\t\tside: THREE.BackSide,\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tfog: false,\r\n\t\t\ttoneMapped: false,\r\n\t\t});\r\n\t\ttexture.mapping = THREE.EquirectangularReflectionMapping;\r\n\t\tconst cubeMap = this.toCubeMap(texture, this.renderer);\r\n\t\tmaterial.map = cubeMap;\r\n\t\tmaterial.uniforms.envMap.value = cubeMap;\r\n\t\tmaterial.uniforms.flipEnvMap.value = cubeMap.isCubeTexture && cubeMap._needsFlipEnvMap ? -1 : 1;\r\n\t\tmaterial.needsUpdate = true;\r\n\t\tthis.mesh.geometry.deleteAttribute('normal');\r\n\t\tthis.mesh.geometry.deleteAttribute('uv');\r\n\t\tObject.defineProperty(material, 'envMap', {\r\n\t\t\tget: function() {\r\n\t\t\t\treturn this.uniforms.envMap.value;\r\n\t\t\t},\r\n\t\t\tconfigurable: true,\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tmakeEnvMap(texture) {\r\n\t\tlet material = this.mesh.material;\r\n\t\tif (!material.uniforms) {\r\n\t\t\tmaterial.dispose();\r\n\t\t\tmaterial = this.getShaderMaterial(texture);\r\n\t\t\tthis.mesh.material = material;\r\n\t\t} else {\r\n\t\t\ttexture.mapping = THREE.EquirectangularReflectionMapping;\r\n\t\t\tconst cubeMap = this.toCubeMap(texture, this.renderer);\r\n\t\t\tmaterial.map = cubeMap;\r\n\t\t\tmaterial.uniforms.envMap.value = cubeMap;\r\n\t\t\tmaterial.uniforms.flipEnvMap.value = cubeMap.isCubeTexture && cubeMap._needsFlipEnvMap ? -1 : 1;\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t}\r\n\t\t// console.log('Panorama.makeEnvMap', this.texture, this.cubeMap);\r\n\t}\r\n\r\n\ttoCubeMap(texture, renderer) {\r\n\t\tif (this.cubeMap) {\r\n\t\t\tthis.cubeMap.dispose();\r\n\t\t}\r\n\t\tconst image = texture.image;\r\n\t\tconst height = image.height || image.videoHeight;\r\n\t\tconst cubeMap = new THREE.WebGLCubeRenderTarget(height / 2, {\r\n\t\t\tgenerateMipmaps: true,\r\n\t\t\ttype: THREE.HalfFloatType,\r\n\t\t\tencoding: THREE.LinearEncoding,\r\n\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t// mapping: THREE.CubeReflectionMapping,\r\n\t\t\t// mapping: THREE.EquirectangularReflectionMapping,\r\n\t\t\tmapping: THREE.CubeUVReflectionMapping,\r\n\t\t\t// mapping: THREE.UVMapping,\r\n\t\t\tformat: THREE.RGBAFormat,\r\n\t\t});\r\n\t\tcubeMap.addEventListener('dispose', this.onCubeMapDispose);\r\n\t\tthis.setCubeMapEquirectangularTexture(cubeMap, texture);\r\n\t\tthis.updateCubeMapEquirectangularTexture(cubeMap, renderer, texture);\r\n\t\tthis.cubeMap = cubeMap;\r\n\t\tthis.texture = texture;\r\n\t\treturn this.mapTextureMapping(cubeMap.texture, texture.mapping);\r\n\t}\r\n\r\n\tsetCubeMapEquirectangularTexture(cubeMap, texture) {\r\n\t\tcubeMap.texture.type = texture.type;\r\n\t\tcubeMap.texture.format = THREE.RGBAFormat;\r\n\t\tcubeMap.texture.encoding = THREE.sRGBEncoding;\r\n\t\tcubeMap.texture.generateMipmaps = texture.generateMipmaps;\r\n\t\tcubeMap.texture.minFilter = texture.minFilter;\r\n\t\tcubeMap.texture.magFilter = texture.magFilter;\r\n\t\tcubeMap.texture.needsUpdate = true;\r\n\t\tconst shader = {\r\n\t\t\tuniforms: {\r\n\t\t\t\ttEquirect: { value: null },\r\n\t\t\t},\r\n\t\t\tvertexShader: /* glsl */ `\r\n\t\t\t\t\tvarying vec3 vWorldDirection;\r\n\t\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\r\n\t\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\r\n\t\t\t\t\t}\r\n\t\t\t\t\tvoid main() {\r\n\t\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\r\n\t\t\t\t\t\t#include <begin_vertex>\r\n\t\t\t\t\t\t#include <project_vertex>\r\n\t\t\t\t\t}\r\n\t\t\t\t`,\r\n\t\t\tfragmentShader: /* glsl */ `\r\n\t\t\t\t\tuniform sampler2D tEquirect;\r\n\t\t\t\t\tvarying vec3 vWorldDirection;\r\n\t\t\t\t\t#include <common>\r\n\t\t\t\t\tvoid main() {\r\n\t\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\r\n\t\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\r\n\t\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\r\n\t\t\t\t\t}\r\n\t\t\t\t`,\r\n\t\t};\r\n\t\tconst geometry = new THREE.BoxGeometry(5, 5, 5);\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tname: 'CubemapFromEquirect',\r\n\t\t\tuniforms: this.cloneUniforms(shader.uniforms),\r\n\t\t\tvertexShader: shader.vertexShader,\r\n\t\t\tfragmentShader: shader.fragmentShader,\r\n\t\t\tside: THREE.BackSide,\r\n\t\t\tblending: THREE.NoBlending,\r\n\t\t});\r\n\t\tmaterial.uniforms.tEquirect.value = texture;\r\n\t\tconst mesh = new THREE.Mesh(geometry, material);\r\n\t\tconst camera = new THREE.CubeCamera(1, 10, cubeMap);\r\n\t\tcubeMap.camera = camera;\r\n\t\tcubeMap.mesh = mesh;\r\n\t\treturn cubeMap;\r\n\t}\r\n\r\n\tupdateCubeMapEquirectangularTexture(cubeMap, renderer, texture) {\r\n\t\tconst previousMinFilter = texture.minFilter;\r\n\t\t// Avoid blurred poles\r\n\t\tif (texture.minFilter === THREE.LinearMipmapLinearFilter) {\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t}\r\n\t\t/*\r\n\t\tconst outputEncoding = renderer.outputEncoding;\r\n\t\tconst toneMapping = renderer.toneMapping;\r\n\t\tconst toneMappingExposure = renderer.toneMappingExposure;\r\n\t\trenderer.toneMapping = THREE.NoToneMapping;\r\n\t\trenderer.outputEncoding = THREE.LinearEncoding;\r\n\t\trenderer.toneMappingExposure = 2;\r\n\t\t*/\r\n\t\tcubeMap.camera.update(renderer, cubeMap.mesh);\r\n\t\t/*\r\n\t\trenderer.toneMapping = toneMapping;\r\n\t\trenderer.outputEncoding = outputEncoding;\r\n\t\trenderer.toneMappingExposure = toneMappingExposure;\r\n\t\t*/\r\n\t\ttexture.minFilter = previousMinFilter;\r\n\t\t// console.log('updateCubeMapEquirectangularTexture');\r\n\t}\r\n\r\n\tcloneUniforms(src) {\r\n\t\tconst dst = {};\r\n\t\tfor (const u in src) {\r\n\t\t\tdst[u] = {};\r\n\t\t\tfor (const p in src[u]) {\r\n\t\t\t\tconst property = src[u][p];\r\n\t\t\t\tif (property && (property.isColor || property.isMatrix3 || property.isMatrix4 || property.isVector2 || property.isVector3 || property.isVector4 || property.isTexture || property.isQuaternion)) {\r\n\t\t\t\t\tdst[u][p] = property.clone();\r\n\t\t\t\t} else if (Array.isArray(property)) {\r\n\t\t\t\t\tdst[u][p] = property.slice();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdst[u][p] = property;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn dst;\r\n\t}\r\n\r\n\tmapTextureMapping(texture, mapping) {\r\n\t\tif (mapping === THREE.EquirectangularReflectionMapping) {\r\n\t\t\ttexture.mapping = THREE.CubeReflectionMapping;\r\n\t\t} else if (mapping === THREE.EquirectangularRefractionMapping) {\r\n\t\t\ttexture.mapping = THREE.CubeRefractionMapping;\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tonCubeMapDispose() {\r\n\t\tconst cubeMap = this.cubeMap;\r\n\t\tif (cubeMap) {\r\n\t\t\t// console.log('Panorama.onCubeMapDispose', cubeMap);\r\n\t\t\tcubeMap.removeEventListener('dispose', this.onCubeMapDispose);\r\n\t\t\tcubeMap.texture.dispose();\r\n\t\t\tcubeMap.mesh.geometry.dispose();\r\n\t\t\tcubeMap.mesh.material.dispose();\r\n\t\t\tif (cubeMap !== undefined) {\r\n\t\t\t\tthis.cubeMap = null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tchange(view, renderer, callback, onexit) {\r\n\t\tconst item = view instanceof PanoramaGridView ? view.tiles[view.index_] : view;\r\n\t\tconst material = this.mesh.material;\r\n\t\tthis.load(item, renderer, (envMap) => {\r\n\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\tonexit(view);\r\n\t\t\t}\r\n\t\t\tif (material.uniforms && material.uniforms.uTween) {\r\n\t\t\t\tmaterial.uniforms.uTween.value = 1;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t}\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcrossfade(item, renderer, callback) {\r\n\t\tconst material = this.mesh.material;\r\n\t\tthis.load(item, renderer, (envMap) => {\r\n\t\t\tif (material.uniforms && material.uniforms.uTween) {\r\n\t\t\t\tmaterial.uniforms.uTween.value = 1;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t}\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tgetLocalizedAsset(asset) {\r\n\t\tif (asset && asset.locale) {\r\n\t\t\tconst localizedAsset = asset.locale[LanguageService.lang];\r\n\t\t\tif (localizedAsset) {\r\n\t\t\t\tasset = localizedAsset;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn asset;\r\n\t}\r\n\r\n\tload(item, renderer, callback) {\r\n\t\tconst asset = item.type.name === ViewType.Media.name ? Asset.defaultMediaAsset : item.asset;\r\n\t\tif (!asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (asset.type.name === AssetType.Model.name) {\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(null);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst localizedAsset = this.getLocalizedAsset(asset);\r\n\t\t// console.log('Panorama.load.localizedAsset', localizedAsset, 'asset', asset);\r\n\t\tthis.currentAsset = localizedAsset.folder + localizedAsset.file;\r\n\t\tPanoramaLoader.load(localizedAsset, renderer, (texture, rgbe) => {\r\n\t\t\tif (localizedAsset.folder + localizedAsset.file !== this.currentAsset) {\r\n\t\t\t\ttexture.dispose();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst envMap = this.makeEnvMap(texture);\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.subscription.unsubscribe();\r\n\t\tif (this.cubeMap) {\r\n\t\t\tthis.cubeMap.dispose();\r\n\t\t}\r\n\t}\r\n}\r\n","import StreamService from '../../stream/stream.service';\r\n\r\nexport const W = 12;\r\nexport const H = 27;\r\nexport const D = 0.5;\r\nexport const R = 4 / 3;\r\nexport const COLORS = [0xffffff, 0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff];\r\n\r\nexport class PhoneStreamElement {\r\n\r\n\tstatic get geometry() {\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(0.01 * W, 0.01 * W / R, 2, 2);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tsetRemote(remote, i, total) {\r\n\t\tthis.remote = remote;\r\n\t\tlet s, c, r, w, h, sx, sy, sz = 0.01 * D; // !!! double distance\r\n\t\tif (total < 4) {\r\n\t\t\ts = 1;\r\n\t\t\tc = 0;\r\n\t\t\tr = i;\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = 0;\r\n\t\t\tsy = h / 2 - (total * h) / 2;\r\n\t\t\tthis.plane.position.set(sx, sy + h * i, sz);\r\n\t\t} else {\r\n\t\t\ts = 0.5;\r\n\t\t\tc = i % 2;\r\n\t\t\tr = Math.floor(i / 2);\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = -w / 2;\r\n\t\t\tsy = h / 2 - (Math.ceil(total / 2) * h) / 2;\r\n\t\t\tthis.plane.position.set(sx + c * w, sy + r * h, sz);\r\n\t\t}\r\n\t\tthis.plane.scale.set(s, s, s);\r\n\t\t// console.log(this.plane.position);\r\n\t\tif (typeof remote === 'number') {\r\n\t\t\tthis.plane.material.color.set(COLORS[i % COLORS.length]);\r\n\t\t} else {\r\n\t\t\tif (remote.texture) {\r\n\t\t\t\tthis.plane.material.map = remote.texture;\r\n\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.addStreamTexture(remote.getId(), (texture) => {\r\n\t\t\t\t\tremote.texture = texture;\r\n\t\t\t\t\tthis.plane.material.map = texture;\r\n\t\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddStreamTexture(streamId, callback) {\r\n\t\tconst target = `#stream-${streamId}`; // `#stream-remote-${streamId}`;\r\n\t\tconst video = document.querySelector(`${target} video`);\r\n\t\tif (!video) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst onPlaying = () => {\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t// texture.format = THREE.RGBAFormat;\r\n\t\t\t// texture.encoding = THREE.sRGBEncoding;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t}\r\n\t\t};\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\tonPlaying();\r\n\t\t} else {\r\n\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\tonPlaying();\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst geometry = PhoneStreamElement.geometry;\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0xffffff,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst plane = this.plane = new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n}\r\n\r\nexport default class PhoneElement {\r\n\r\n\tset remotes(remotes) {\r\n\t\t// console.log('PhoneElement', remotes);\r\n\t\tremotes.forEach((remote, i) => {\r\n\t\t\tlet stream = this.streams[i];\r\n\t\t\tif (!stream) {\r\n\t\t\t\tstream = new PhoneStreamElement();\r\n\t\t\t}\r\n\t\t\tstream.setRemote(remote, i, remotes.length);\r\n\t\t\tthis.phone.add(stream.plane);\r\n\t\t\tthis.streams[i] = stream;\r\n\t\t});\r\n\t\tfor (let i = remotes.length; i < this.streams.length; i++) {\r\n\t\t\tthis.phone.remove(this.streams[i].plane);\r\n\t\t}\r\n\t\tthis.streams.length = remotes.length;\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst mesh = this.mesh = new THREE.Group();\r\n\t\tconst phone = this.phone = this.create();\r\n\t\tmesh.add(phone);\r\n\t\tconst streams = this.streams = [];\r\n\t\tStreamService.remotes$.subscribe(remotes => {\r\n\t\t\tthis.remotes = remotes;\r\n\t\t});\r\n\t}\r\n\r\n\tcreate() {\r\n\t\tconst geometry = new THREE.BoxBufferGeometry(0.01 * W, 0.01 * H, 0.01 * D, 2, 2, 1);\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0x000000,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.6,\r\n\t\t});\r\n\t\tconst phone = new THREE.Mesh(geometry, material);\r\n\t\tphone.rotation.set(-Math.PI / 4, 0, 0);\r\n\t\treturn phone;\r\n\t}\r\n}\r\n","import { environment } from '../../environment';\r\nimport { Geometry } from '../geometry/geometry';\r\nimport { Host } from '../host/host';\r\nimport Interactive from '../interactive/interactive';\r\n\r\nexport default class PointerElement {\r\n\r\n\tconstructor(color = '#ffffff') {\r\n\t\tconst position = this.position = new THREE.Vector3();\r\n\t\t// const targetPosition = this.targetPosition = new THREE.Vector3();\r\n\t\tconst geometry = Geometry.planeGeometry; // new THREE.PlaneBufferGeometry(1.2, 1.2, 2, 2);\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tconst texture = loader.load(environment.getPath('textures/ui/nav-point.png'));\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: new THREE.Color(color),\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = this.mesh = new THREE.Mesh(geometry, material);\r\n\t\tmesh.renderOrder = environment.renderOrder.pointer;\r\n\t\tmesh.position.set(-100000, -100000, -100000);\r\n\t}\r\n\r\n\tupdate(camera) {\r\n\t\tif (Interactive.lastIntersectedObject) {\r\n\t\t\tconst position = this.position;\r\n\t\t\tposition.copy(Interactive.lastIntersectedObject.intersection.point);\r\n\t\t\tposition.multiplyScalar(0.99);\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\tposition.sub(camera.position);\r\n\t\t\tconst s = position.length() / 80;\r\n\t\t\tmesh.scale.set(s, s, s);\r\n\t\t\t/*\r\n\t\t\tconst targetPosition = this.targetPosition;\r\n\t\t\ttargetPosition.set(0, 0, 0);\r\n\t\t\tcamera.localToWorld(targetPosition);\r\n\t\t\t*/\r\n\t\t\tmesh.lookAt(Host.origin);\r\n\t\t}\r\n\t}\r\n\r\n\tsetPosition(x, y, z, camera) {\r\n\t\tconst position = this.position;\r\n\t\tposition.set(x, y, z).multiplyScalar(80);\r\n\t\tconst mesh = this.mesh;\r\n\t\tmesh.position.copy(position);\r\n\t\tposition.sub(camera.position);\r\n\t\tconst s = position.length() / 80;\r\n\t\tmesh.scale.set(s, s, s);\r\n\t\t/*\r\n\t\tconst targetPosition = this.targetPosition;\r\n\t\ttargetPosition.set(0, 0, 0);\r\n\t\tcamera.localToWorld(targetPosition);\r\n\t\t*/\r\n\t\tmesh.lookAt(Host.origin);\r\n\t}\r\n}\r\n","import { environment } from '../../environment';\r\n\r\nconst LINE_SEGMENTS = 10;\r\n\r\nexport class TeleportElement {\r\n\r\n\tconstructor() {\r\n\t\tconst gravity = this.gravity = new THREE.Vector3(0, -9.8, 0);\r\n\t\tconst controllerPosition = this.controllerPosition = new THREE.Vector3();\r\n\t\tconst controllerDirection = this.controllerDirection = new THREE.Vector3();\r\n\t\tconst currentPosition = this.currentPosition = new THREE.Vector3();\r\n\t\tconst targetPosition = this.targetPosition = new THREE.Vector3();\r\n\t\tconst geometry = new THREE.BufferGeometry();\r\n\t\tconst vertices = this.vertices = new Float32Array((LINE_SEGMENTS + 1) * 3);\r\n\t\tvertices.fill(0);\r\n\t\tconst colors = new Float32Array((LINE_SEGMENTS + 1) * 3);\r\n\t\tcolors.fill(0.5);\r\n\t\tgeometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));\r\n\t\tgeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));\r\n\t\tconst lineMaterial = new THREE.LineBasicMaterial({ vertexColors: true, blending: THREE.AdditiveBlending });\r\n\t\tconst line = this.line = new THREE.Line(geometry, lineMaterial);\r\n\t\t// const light = this.light = new THREE.PointLight(0xffeeaa, 0, 2);\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tconst texture = loader.load(environment.getPath('textures/ui/nav-point.png'));\r\n\t\tconst target = this.target = new THREE.Mesh(\r\n\t\t\tnew THREE.PlaneBufferGeometry(0.3, 0.3, 1, 1),\r\n\t\t\tnew THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\tblending: THREE.AdditiveBlending,\r\n\t\t\t\tcolor: 0x555555,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t}),\r\n\t\t);\r\n\t\ttarget.rotation.x = -Math.PI / 2;\r\n\t}\r\n\r\n\taddToController(controller, scene) {\r\n\t\tthis.currentController = controller;\r\n\t\t// this.light.intensity = 1;\r\n\t\tcontroller.add(this.line);\r\n\t\tscene.add(this.target);\r\n\t}\r\n\r\n\tremoveFromController(controller, scene, renderer, camera, cameraGroup) {\r\n\t\tconst currentController = this.currentController;\r\n\t\tif (currentController === controller) {\r\n\t\t\tconst gravity = this.gravity;\r\n\t\t\tconst currentPosition = this.currentPosition;\r\n\t\t\tconst controllerPosition = this.controllerPosition;\r\n\t\t\tconst controllerDirection = this.controllerDirection;\r\n\t\t\trenderer.xr.getCamera(camera).getWorldPosition(currentPosition);\r\n\t\t\tcurrentPosition.y = 0;\r\n\t\t\tcurrentController.getWorldPosition(controllerPosition);\r\n\t\t\tcurrentController.getWorldDirection(controllerDirection);\r\n\t\t\tcontrollerDirection.multiplyScalar(6);\r\n\t\t\tconst T = (-controllerDirection.y + Math.sqrt(controllerDirection.y ** 2 - 2 * controllerPosition.y * gravity.y)) / gravity.y;\r\n\t\t\tconst targetPosition = this.getPositionT(this.targetPosition, T, controllerPosition, controllerDirection, gravity);\r\n\t\t\ttargetPosition.addScaledVector(currentPosition, -1);\r\n\t\t\tcameraGroup.position.add(targetPosition);\r\n\t\t\t// this.teleport(targetPosition, cameraGroup);\r\n\t\t\tthis.currentController = null;\r\n\t\t\t// this.light.intensity = 0;\r\n\t\t\tcurrentController.remove(this.line);\r\n\t\t\tscene.remove(this.target);\r\n\t\t}\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tconst currentController = this.currentController;\r\n\t\tif (currentController) {\r\n\t\t\tconst gravity = this.gravity;\r\n\t\t\tconst controllerPosition = this.controllerPosition;\r\n\t\t\tconst controllerDirection = this.controllerDirection;\r\n\t\t\tconst targetPosition = this.targetPosition;\r\n\t\t\t// Controller start position\r\n\t\t\tcurrentController.getWorldPosition(controllerPosition);\r\n\t\t\t// Set Vector V to the direction of the controller, at 1m/s\r\n\t\t\tcurrentController.getWorldDirection(controllerDirection);\r\n\t\t\t// Scale the initial velocity to 6m/s\r\n\t\t\tcontrollerDirection.multiplyScalar(6);\r\n\t\t\t// Time for tele ball to hit ground\r\n\t\t\tconst T = (-controllerDirection.y + Math.sqrt(controllerDirection.y ** 2 - 2 * controllerPosition.y * gravity.y)) / gravity.y;\r\n\t\t\tconst vertex = targetPosition.set(0, 0, 0);\r\n\t\t\tfor (let i = 1; i <= LINE_SEGMENTS; i++) {\r\n\t\t\t\t// set vertex to current position of the virtual ball at time t\r\n\t\t\t\tthis.getPositionT(vertex, i * T / LINE_SEGMENTS, controllerPosition, controllerDirection, gravity);\r\n\t\t\t\tcurrentController.worldToLocal(vertex);\r\n\t\t\t\tvertex.toArray(this.vertices, i * 3);\r\n\t\t\t}\r\n\t\t\tthis.line.geometry.attributes.position.needsUpdate = true;\r\n\t\t\t// Place the light and sprite near the end of the poing\r\n\t\t\t// this.getPositionT(this.light.position, T * 0.98, controllerPosition, controllerDirection, gravity);\r\n\t\t\tthis.getPositionT(this.target.position, T * 0.98, controllerPosition, controllerDirection, gravity);\r\n\t\t}\r\n\t}\r\n\r\n\tgetPositionT(position, T, controllerPosition, controllerDirection, gravity) {\r\n\t\tposition.copy(controllerPosition);\r\n\t\tposition.addScaledVector(controllerDirection, T);\r\n\t\tposition.addScaledVector(gravity, 0.5 * T ** 2);\r\n\t\treturn position;\r\n\t}\r\n\r\n\t/*\r\n\tteleport(offsetPosition, cameraGroup) {\r\n\t\tconst position = new THREE.Vector3();\r\n\t\tposition.copy(cameraGroup.position);\r\n\t\tposition.add(offsetPosition);\r\n\t\t// const distance = offsetPosition.length();\r\n\t\tcameraGroup.position.copy(position);\r\n\t}\r\n\t*/\r\n\r\n}\r\n","import { BehaviorSubject, Subject } from 'rxjs';\r\n\r\nexport const XRStatus = {\r\n\tWaiting: 'waiting',\r\n\tEnabled: 'enabled',\r\n\tEnded: 'ended',\r\n\tStarted: 'started',\r\n\tDisabled: 'disabled',\r\n\tNeedsHttps: 'needs-https',\r\n\tUnavailable: 'unavailable',\r\n};\r\n\r\nexport default class VRService {\r\n\r\n\tstatic getService() {\r\n\t\tif (!this.service_) {\r\n\t\t\tthis.service_ = new VRService();\r\n\t\t}\r\n\t\treturn this.service_;\r\n\t}\r\n\r\n\tget status() {\r\n\t\treturn this.status$.getValue();\r\n\t}\r\n\r\n\tget state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tif (VRService.service_) {\r\n\t\t\tthrow ('VRService is a singleton class!');\r\n\t\t}\r\n\t\tconst state = this.state_ = {\r\n\t\t\tcamera: {\r\n\t\t\t\tposition: new THREE.Vector3(),\r\n\t\t\t\tquaternion: new THREE.Quaternion(),\r\n\t\t\t\tscale: new THREE.Vector3(),\r\n\t\t\t\tarray: new Array(3 + 4 + 3).fill(0),\r\n\t\t\t},\r\n\t\t};\r\n\t\tthis.onSessionStarted = this.onSessionStarted.bind(this);\r\n\t\tthis.onSessionEnded = this.onSessionEnded.bind(this);\r\n\t\tthis.status$ = new BehaviorSubject(XRStatus.Waiting);\r\n\t\tthis.session$ = new Subject();\r\n\t\tthis.state$ = new BehaviorSubject(state);\r\n\t\tthis.currentSession = null;\r\n\t\tif ('xr' in navigator) {\r\n\t\t\tnavigator.xr.isSessionSupported('immersive-vr').then((supported) => {\r\n\t\t\t\tif (supported) {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Enabled);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Disabled);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (window.isSecureContext === false) {\r\n\t\t\t\tthis.status$.next(XRStatus.NeedsHttps);\r\n\t\t\t} else {\r\n\t\t\t\tthis.status$.next(XRStatus.Unavailable);\r\n\t\t\t\t// 'https://immersiveweb.dev/';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonSessionStarted(session) {\r\n\t\tsession.addEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = session;\r\n\t\tthis.session$.next(session);\r\n\t\tthis.status$.next(XRStatus.Started);\r\n\t}\r\n\r\n\tonSessionEnded( /*event*/) {\r\n\t\tthis.currentSession.removeEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = null;\r\n\t\tthis.session$.next(null);\r\n\t\tthis.status$.next(XRStatus.Ended);\r\n\t}\r\n\r\n\ttoggleVR(event) {\r\n\t\tif (this.currentSession === null) {\r\n\t\t\t// WebXR's requestReferenceSpace only works if the corresponding feature\r\n\t\t\t// was requested at session creation time. For simplicity, just ask for\r\n\t\t\t// the interesting ones as optional features, but be aware that the\r\n\t\t\t// requestReferenceSpace call will fail if it turns out to be unavailable.\r\n\t\t\t// ('local' is always available for immersive sessions and doesn't need to\r\n\t\t\t// be requested separately.)\r\n\t\t\tconst sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor'] };\r\n\t\t\tnavigator.xr.requestSession('immersive-vr', sessionInit).then(this.onSessionStarted);\r\n\t\t} else {\r\n\t\t\tthis.currentSession.end();\r\n\t\t}\r\n\t}\r\n\r\n\tisDisabled() {\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\treturn true;\r\n\t\t\tdefault:\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet label;\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\t\tlabel = 'Waiting VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Enabled:\r\n\t\t\tcase XRStatus.Ended:\r\n\t\t\t\tlabel = 'Enter VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Started:\r\n\t\t\t\tlabel = 'Exit VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\t\tlabel = 'VR Disabled';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\t\tlabel = 'VR Needs Https';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\tlabel = 'VR Unavailable';\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn label;\r\n\t}\r\n\r\n\tupdateState(world) {\r\n\t\tif (this.status === XRStatus.Started) {\r\n\t\t\tconst renderer = world.renderer,\r\n\t\t\t\tscene = world.scene,\r\n\t\t\t\tcamera = world.camera,\r\n\t\t\t\tstate = this.state_;\r\n\t\t\tcamera.matrixWorld.decompose(state.camera.position, state.camera.quaternion, state.camera.scale);\r\n\t\t\tstate.camera.array[0] = state.camera.position.x;\r\n\t\t\tstate.camera.array[1] = state.camera.position.y;\r\n\t\t\tstate.camera.array[2] = state.camera.position.z;\r\n\t\t\tstate.camera.array[3] = state.camera.quaternion.x;\r\n\t\t\tstate.camera.array[4] = state.camera.quaternion.y;\r\n\t\t\tstate.camera.array[5] = state.camera.quaternion.z;\r\n\t\t\tstate.camera.array[6] = state.camera.quaternion.w;\r\n\t\t\tstate.camera.array[7] = state.camera.scale.x;\r\n\t\t\tstate.camera.array[8] = state.camera.scale.y;\r\n\t\t\tstate.camera.array[9] = state.camera.scale.z;\r\n\t\t\tthis.state$.next(state);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import Emittable from '../interactive/emittable';\r\n\r\nexport class Gamepad extends Emittable {\r\n\tconstructor(gamepad) {\r\n\t\tsuper();\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.buttons = {};\r\n\t\tthis.axes = {};\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tthis.updateButtons();\r\n\t\tthis.updateAxes();\r\n\t}\r\n\r\n\tupdateButtons() {\r\n\t\tthis.gamepad.buttons.forEach((x, i) => {\r\n\t\t\tconst pressed = x.pressed;\r\n\t\t\tconst button = this.buttons[i] || (this.buttons[i] = new GamepadButton(i, this));\r\n\t\t\tif (button.pressed !== pressed) {\r\n\t\t\t\tbutton.pressed = pressed;\r\n\t\t\t\tif (pressed) {\r\n\t\t\t\t\tthis.emit('press', button);\r\n\t\t\t\t} else if (status !== undefined) {\r\n\t\t\t\t\tthis.emit('release', button);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tupdateAxes() {\r\n\t\tconst axes = this.gamepad.axes;\r\n\t\tfor (let i = 0; i < axes.length; i += 2) {\r\n\t\t\tconst index = Math.floor(i / 2);\r\n\t\t\tconst axis = this.axes[index] || (this.axes[index] = new GamepadAxis(index, this));\r\n\t\t\tconst x = axes[i];\r\n\t\t\tconst y = axes[i + 1];\r\n\t\t\tif (axis.x !== x || axis.y !== y) {\r\n\t\t\t\taxis.x = x;\r\n\t\t\t\taxis.y = y;\r\n\t\t\t\tif (Math.abs(x) > Math.abs(y)) {\r\n\t\t\t\t\tconst left = x < -0.85;\r\n\t\t\t\t\tconst right = x > 0.85;\r\n\t\t\t\t\tif (axis.left !== left) {\r\n\t\t\t\t\t\taxis.left = left;\r\n\t\t\t\t\t\tthis.emit((left ? 'left' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} left ${left}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.right !== right) {\r\n\t\t\t\t\t\taxis.right = right;\r\n\t\t\t\t\t\tthis.emit((right ? 'right' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} right ${right}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst up = y < -0.85;\r\n\t\t\t\t\tconst down = y > 0.85;\r\n\t\t\t\t\tif (axis.up !== up) {\r\n\t\t\t\t\t\taxis.up = up;\r\n\t\t\t\t\t\tthis.emit((up ? 'up' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} up ${up}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.down !== down) {\r\n\t\t\t\t\t\taxis.down = down;\r\n\t\t\t\t\t\tthis.emit((down ? 'down' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} down ${down}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.emit('axis', axis);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfeedback(strength = 0.1, duration = 50) {\r\n\t\t// !!! care for battery\r\n\t\tconst actuators = this.gamepad.hapticActuators;\r\n\t\tif (actuators && actuators.length) {\r\n\t\t\treturn actuators[0].pulse(strength, duration);\r\n\t\t} else {\r\n\t\t\treturn Promise.reject();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass GamepadButton {\r\n\tconstructor(index, gamepad) {\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.pressed = false;\r\n\t}\r\n}\r\n\r\nclass GamepadAxis extends THREE.Vector2 {\r\n\tconstructor(index, gamepad) {\r\n\t\tsuper();\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.left = this.right = this.up = this.down = false;\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import {\n\tAnimationClip,\n\tBone,\n\tBox3,\n\tBufferAttribute,\n\tBufferGeometry,\n\tClampToEdgeWrapping,\n\tColor,\n\tDirectionalLight,\n\tDoubleSide,\n\tFileLoader,\n\tFrontSide,\n\tGroup,\n\tImageBitmapLoader,\n\tInterleavedBuffer,\n\tInterleavedBufferAttribute,\n\tInterpolant,\n\tInterpolateDiscrete,\n\tInterpolateLinear,\n\tLine,\n\tLineBasicMaterial,\n\tLineLoop,\n\tLineSegments,\n\tLinearFilter,\n\tLinearMipmapLinearFilter,\n\tLinearMipmapNearestFilter,\n\tLoader,\n\tLoaderUtils,\n\tMaterial,\n\tMathUtils,\n\tMatrix4,\n\tMesh,\n\tMeshBasicMaterial,\n\tMeshPhysicalMaterial,\n\tMeshStandardMaterial,\n\tMirroredRepeatWrapping,\n\tNearestFilter,\n\tNearestMipmapLinearFilter,\n\tNearestMipmapNearestFilter,\n\tNumberKeyframeTrack,\n\tObject3D,\n\tOrthographicCamera,\n\tPerspectiveCamera,\n\tPointLight,\n\tPoints,\n\tPointsMaterial,\n\tPropertyBinding,\n\tQuaternion,\n\tQuaternionKeyframeTrack,\n\tRepeatWrapping,\n\tSkeleton,\n\tSkinnedMesh,\n\tSphere,\n\tSpotLight,\n\tTangentSpaceNormalMap,\n\tTexture,\n\tTextureLoader,\n\tTriangleFanDrawMode,\n\tTriangleStripDrawMode,\n\tVector2,\n\tVector3,\n\tVectorKeyframeTrack,\n\tsRGBEncoding\n} from 'three';\n\nclass GLTFLoader extends Loader {\n\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t\tthis.dracoLoader = null;\n\t\tthis.ktx2Loader = null;\n\t\tthis.meshoptDecoder = null;\n\n\t\tthis.pluginCallbacks = [];\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsClearcoatExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFTextureBasisUExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFTextureWebPExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsSheenExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsTransmissionExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsVolumeExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsIorExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMaterialsSpecularExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFLightsExtension( parser );\n\n\t\t} );\n\n\t\tthis.register( function ( parser ) {\n\n\t\t\treturn new GLTFMeshoptCompression( parser );\n\n\t\t} );\n\n\t}\n\n\tload( url, onLoad, onProgress, onError ) {\n\n\t\tconst scope = this;\n\n\t\tlet resourcePath;\n\n\t\tif ( this.resourcePath !== '' ) {\n\n\t\t\tresourcePath = this.resourcePath;\n\n\t\t} else if ( this.path !== '' ) {\n\n\t\t\tresourcePath = this.path;\n\n\t\t} else {\n\n\t\t\tresourcePath = LoaderUtils.extractUrlBase( url );\n\n\t\t}\n\n\t\t// Tells the LoadingManager to track an extra item, which resolves after\n\t\t// the model is fully loaded. This means the count of items loaded will\n\t\t// be incorrect, but ensures manager.onLoad() does not fire early.\n\t\tthis.manager.itemStart( url );\n\n\t\tconst _onError = function ( e ) {\n\n\t\t\tif ( onError ) {\n\n\t\t\t\tonError( e );\n\n\t\t\t} else {\n\n\t\t\t\tconsole.error( e );\n\n\t\t\t}\n\n\t\t\tscope.manager.itemError( url );\n\t\t\tscope.manager.itemEnd( url );\n\n\t\t};\n\n\t\tconst loader = new FileLoader( this.manager );\n\n\t\tloader.setPath( this.path );\n\t\tloader.setResponseType( 'arraybuffer' );\n\t\tloader.setRequestHeader( this.requestHeader );\n\t\tloader.setWithCredentials( this.withCredentials );\n\n\t\tloader.load( url, function ( data ) {\n\n\t\t\ttry {\n\n\t\t\t\tscope.parse( data, resourcePath, function ( gltf ) {\n\n\t\t\t\t\tonLoad( gltf );\n\n\t\t\t\t\tscope.manager.itemEnd( url );\n\n\t\t\t\t}, _onError );\n\n\t\t\t} catch ( e ) {\n\n\t\t\t\t_onError( e );\n\n\t\t\t}\n\n\t\t}, onProgress, _onError );\n\n\t}\n\n\tsetDRACOLoader( dracoLoader ) {\n\n\t\tthis.dracoLoader = dracoLoader;\n\t\treturn this;\n\n\t}\n\n\tsetDDSLoader() {\n\n\t\tthrow new Error(\n\n\t\t\t'THREE.GLTFLoader: \"MSFT_texture_dds\" no longer supported. Please update to \"KHR_texture_basisu\".'\n\n\t\t);\n\n\t}\n\n\tsetKTX2Loader( ktx2Loader ) {\n\n\t\tthis.ktx2Loader = ktx2Loader;\n\t\treturn this;\n\n\t}\n\n\tsetMeshoptDecoder( meshoptDecoder ) {\n\n\t\tthis.meshoptDecoder = meshoptDecoder;\n\t\treturn this;\n\n\t}\n\n\tregister( callback ) {\n\n\t\tif ( this.pluginCallbacks.indexOf( callback ) === - 1 ) {\n\n\t\t\tthis.pluginCallbacks.push( callback );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\tunregister( callback ) {\n\n\t\tif ( this.pluginCallbacks.indexOf( callback ) !== - 1 ) {\n\n\t\t\tthis.pluginCallbacks.splice( this.pluginCallbacks.indexOf( callback ), 1 );\n\n\t\t}\n\n\t\treturn this;\n\n\t}\n\n\tparse( data, path, onLoad, onError ) {\n\n\t\tlet content;\n\t\tconst extensions = {};\n\t\tconst plugins = {};\n\n\t\tif ( typeof data === 'string' ) {\n\n\t\t\tcontent = data;\n\n\t\t} else {\n\n\t\t\tconst magic = LoaderUtils.decodeText( new Uint8Array( data, 0, 4 ) );\n\n\t\t\tif ( magic === BINARY_EXTENSION_HEADER_MAGIC ) {\n\n\t\t\t\ttry {\n\n\t\t\t\t\textensions[ EXTENSIONS.KHR_BINARY_GLTF ] = new GLTFBinaryExtension( data );\n\n\t\t\t\t} catch ( error ) {\n\n\t\t\t\t\tif ( onError ) onError( error );\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\tcontent = extensions[ EXTENSIONS.KHR_BINARY_GLTF ].content;\n\n\t\t\t} else {\n\n\t\t\t\tcontent = LoaderUtils.decodeText( new Uint8Array( data ) );\n\n\t\t\t}\n\n\t\t}\n\n\t\tconst json = JSON.parse( content );\n\n\t\tif ( json.asset === undefined || json.asset.version[ 0 ] < 2 ) {\n\n\t\t\tif ( onError ) onError( new Error( 'THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.' ) );\n\t\t\treturn;\n\n\t\t}\n\n\t\tconst parser = new GLTFParser( json, {\n\n\t\t\tpath: path || this.resourcePath || '',\n\t\t\tcrossOrigin: this.crossOrigin,\n\t\t\trequestHeader: this.requestHeader,\n\t\t\tmanager: this.manager,\n\t\t\tktx2Loader: this.ktx2Loader,\n\t\t\tmeshoptDecoder: this.meshoptDecoder\n\n\t\t} );\n\n\t\tparser.fileLoader.setRequestHeader( this.requestHeader );\n\n\t\tfor ( let i = 0; i < this.pluginCallbacks.length; i ++ ) {\n\n\t\t\tconst plugin = this.pluginCallbacks[ i ]( parser );\n\t\t\tplugins[ plugin.name ] = plugin;\n\n\t\t\t// Workaround to avoid determining as unknown extension\n\t\t\t// in addUnknownExtensionsToUserData().\n\t\t\t// Remove this workaround if we move all the existing\n\t\t\t// extension handlers to plugin system\n\t\t\textensions[ plugin.name ] = true;\n\n\t\t}\n\n\t\tif ( json.extensionsUsed ) {\n\n\t\t\tfor ( let i = 0; i < json.extensionsUsed.length; ++ i ) {\n\n\t\t\t\tconst extensionName = json.extensionsUsed[ i ];\n\t\t\t\tconst extensionsRequired = json.extensionsRequired || [];\n\n\t\t\t\tswitch ( extensionName ) {\n\n\t\t\t\t\tcase EXTENSIONS.KHR_MATERIALS_UNLIT:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFMaterialsUnlitExtension();\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFMaterialsPbrSpecularGlossinessExtension();\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFDracoMeshCompressionExtension( json, this.dracoLoader );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase EXTENSIONS.KHR_TEXTURE_TRANSFORM:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFTextureTransformExtension();\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase EXTENSIONS.KHR_MESH_QUANTIZATION:\n\t\t\t\t\t\textensions[ extensionName ] = new GLTFMeshQuantizationExtension();\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\n\t\t\t\t\t\tif ( extensionsRequired.indexOf( extensionName ) >= 0 && plugins[ extensionName ] === undefined ) {\n\n\t\t\t\t\t\t\tconsole.warn( 'THREE.GLTFLoader: Unknown extension \"' + extensionName + '\".' );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\tparser.setExtensions( extensions );\n\t\tparser.setPlugins( plugins );\n\t\tparser.parse( onLoad, onError );\n\n\t}\n\n\tparseAsync( data, path ) {\n\n\t\tconst scope = this;\n\n\t\treturn new Promise( function ( resolve, reject ) {\n\n\t\t\tscope.parse( data, path, resolve, reject );\n\n\t\t} );\n\n\t}\n\n}\n\n/* GLTFREGISTRY */\n\nfunction GLTFRegistry() {\n\n\tlet objects = {};\n\n\treturn\t{\n\n\t\tget: function ( key ) {\n\n\t\t\treturn objects[ key ];\n\n\t\t},\n\n\t\tadd: function ( key, object ) {\n\n\t\t\tobjects[ key ] = object;\n\n\t\t},\n\n\t\tremove: function ( key ) {\n\n\t\t\tdelete objects[ key ];\n\n\t\t},\n\n\t\tremoveAll: function () {\n\n\t\t\tobjects = {};\n\n\t\t}\n\n\t};\n\n}\n\n/*********************************/\n/********** EXTENSIONS ***********/\n/*********************************/\n\nconst EXTENSIONS = {\n\tKHR_BINARY_GLTF: 'KHR_binary_glTF',\n\tKHR_DRACO_MESH_COMPRESSION: 'KHR_draco_mesh_compression',\n\tKHR_LIGHTS_PUNCTUAL: 'KHR_lights_punctual',\n\tKHR_MATERIALS_CLEARCOAT: 'KHR_materials_clearcoat',\n\tKHR_MATERIALS_IOR: 'KHR_materials_ior',\n\tKHR_MATERIALS_PBR_SPECULAR_GLOSSINESS: 'KHR_materials_pbrSpecularGlossiness',\n\tKHR_MATERIALS_SHEEN: 'KHR_materials_sheen',\n\tKHR_MATERIALS_SPECULAR: 'KHR_materials_specular',\n\tKHR_MATERIALS_TRANSMISSION: 'KHR_materials_transmission',\n\tKHR_MATERIALS_UNLIT: 'KHR_materials_unlit',\n\tKHR_MATERIALS_VOLUME: 'KHR_materials_volume',\n\tKHR_TEXTURE_BASISU: 'KHR_texture_basisu',\n\tKHR_TEXTURE_TRANSFORM: 'KHR_texture_transform',\n\tKHR_MESH_QUANTIZATION: 'KHR_mesh_quantization',\n\tEXT_TEXTURE_WEBP: 'EXT_texture_webp',\n\tEXT_MESHOPT_COMPRESSION: 'EXT_meshopt_compression'\n};\n\n/**\n * Punctual Lights Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_lights_punctual\n */\nclass GLTFLightsExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_LIGHTS_PUNCTUAL;\n\n\t\t// Object3D instance caches\n\t\tthis.cache = { refs: {}, uses: {} };\n\n\t}\n\n\t_markDefs() {\n\n\t\tconst parser = this.parser;\n\t\tconst nodeDefs = this.parser.json.nodes || [];\n\n\t\tfor ( let nodeIndex = 0, nodeLength = nodeDefs.length; nodeIndex < nodeLength; nodeIndex ++ ) {\n\n\t\t\tconst nodeDef = nodeDefs[ nodeIndex ];\n\n\t\t\tif ( nodeDef.extensions\n\t\t\t\t\t&& nodeDef.extensions[ this.name ]\n\t\t\t\t\t&& nodeDef.extensions[ this.name ].light !== undefined ) {\n\n\t\t\t\tparser._addNodeRef( this.cache, nodeDef.extensions[ this.name ].light );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t_loadLight( lightIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst cacheKey = 'light:' + lightIndex;\n\t\tlet dependency = parser.cache.get( cacheKey );\n\n\t\tif ( dependency ) return dependency;\n\n\t\tconst json = parser.json;\n\t\tconst extensions = ( json.extensions && json.extensions[ this.name ] ) || {};\n\t\tconst lightDefs = extensions.lights || [];\n\t\tconst lightDef = lightDefs[ lightIndex ];\n\t\tlet lightNode;\n\n\t\tconst color = new Color( 0xffffff );\n\n\t\tif ( lightDef.color !== undefined ) color.fromArray( lightDef.color );\n\n\t\tconst range = lightDef.range !== undefined ? lightDef.range : 0;\n\n\t\tswitch ( lightDef.type ) {\n\n\t\t\tcase 'directional':\n\t\t\t\tlightNode = new DirectionalLight( color );\n\t\t\t\tlightNode.target.position.set( 0, 0, - 1 );\n\t\t\t\tlightNode.add( lightNode.target );\n\t\t\t\tbreak;\n\n\t\t\tcase 'point':\n\t\t\t\tlightNode = new PointLight( color );\n\t\t\t\tlightNode.distance = range;\n\t\t\t\tbreak;\n\n\t\t\tcase 'spot':\n\t\t\t\tlightNode = new SpotLight( color );\n\t\t\t\tlightNode.distance = range;\n\t\t\t\t// Handle spotlight properties.\n\t\t\t\tlightDef.spot = lightDef.spot || {};\n\t\t\t\tlightDef.spot.innerConeAngle = lightDef.spot.innerConeAngle !== undefined ? lightDef.spot.innerConeAngle : 0;\n\t\t\t\tlightDef.spot.outerConeAngle = lightDef.spot.outerConeAngle !== undefined ? lightDef.spot.outerConeAngle : Math.PI / 4.0;\n\t\t\t\tlightNode.angle = lightDef.spot.outerConeAngle;\n\t\t\t\tlightNode.penumbra = 1.0 - lightDef.spot.innerConeAngle / lightDef.spot.outerConeAngle;\n\t\t\t\tlightNode.target.position.set( 0, 0, - 1 );\n\t\t\t\tlightNode.add( lightNode.target );\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tthrow new Error( 'THREE.GLTFLoader: Unexpected light type: ' + lightDef.type );\n\n\t\t}\n\n\t\t// Some lights (e.g. spot) default to a position other than the origin. Reset the position\n\t\t// here, because node-level parsing will only override position if explicitly specified.\n\t\tlightNode.position.set( 0, 0, 0 );\n\n\t\tlightNode.decay = 2;\n\n\t\tif ( lightDef.intensity !== undefined ) lightNode.intensity = lightDef.intensity;\n\n\t\tlightNode.name = parser.createUniqueName( lightDef.name || ( 'light_' + lightIndex ) );\n\n\t\tdependency = Promise.resolve( lightNode );\n\n\t\tparser.cache.add( cacheKey, dependency );\n\n\t\treturn dependency;\n\n\t}\n\n\tcreateNodeAttachment( nodeIndex ) {\n\n\t\tconst self = this;\n\t\tconst parser = this.parser;\n\t\tconst json = parser.json;\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\t\tconst lightDef = ( nodeDef.extensions && nodeDef.extensions[ this.name ] ) || {};\n\t\tconst lightIndex = lightDef.light;\n\n\t\tif ( lightIndex === undefined ) return null;\n\n\t\treturn this._loadLight( lightIndex ).then( function ( light ) {\n\n\t\t\treturn parser._getNodeRef( self.cache, lightIndex, light );\n\n\t\t} );\n\n\t}\n\n}\n\n/**\n * Unlit Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_unlit\n */\nclass GLTFMaterialsUnlitExtension {\n\n\tconstructor() {\n\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_UNLIT;\n\n\t}\n\n\tgetMaterialType() {\n\n\t\treturn MeshBasicMaterial;\n\n\t}\n\n\textendParams( materialParams, materialDef, parser ) {\n\n\t\tconst pending = [];\n\n\t\tmaterialParams.color = new Color( 1.0, 1.0, 1.0 );\n\t\tmaterialParams.opacity = 1.0;\n\n\t\tconst metallicRoughness = materialDef.pbrMetallicRoughness;\n\n\t\tif ( metallicRoughness ) {\n\n\t\t\tif ( Array.isArray( metallicRoughness.baseColorFactor ) ) {\n\n\t\t\t\tconst array = metallicRoughness.baseColorFactor;\n\n\t\t\t\tmaterialParams.color.fromArray( array );\n\t\t\t\tmaterialParams.opacity = array[ 3 ];\n\n\t\t\t}\n\n\t\t\tif ( metallicRoughness.baseColorTexture !== undefined ) {\n\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'map', metallicRoughness.baseColorTexture ) );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Clearcoat Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_clearcoat\n */\nclass GLTFMaterialsClearcoatExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_CLEARCOAT;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.clearcoatFactor !== undefined ) {\n\n\t\t\tmaterialParams.clearcoat = extension.clearcoatFactor;\n\n\t\t}\n\n\t\tif ( extension.clearcoatTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'clearcoatMap', extension.clearcoatTexture ) );\n\n\t\t}\n\n\t\tif ( extension.clearcoatRoughnessFactor !== undefined ) {\n\n\t\t\tmaterialParams.clearcoatRoughness = extension.clearcoatRoughnessFactor;\n\n\t\t}\n\n\t\tif ( extension.clearcoatRoughnessTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'clearcoatRoughnessMap', extension.clearcoatRoughnessTexture ) );\n\n\t\t}\n\n\t\tif ( extension.clearcoatNormalTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'clearcoatNormalMap', extension.clearcoatNormalTexture ) );\n\n\t\t\tif ( extension.clearcoatNormalTexture.scale !== undefined ) {\n\n\t\t\t\tconst scale = extension.clearcoatNormalTexture.scale;\n\n\t\t\t\tmaterialParams.clearcoatNormalScale = new Vector2( scale, scale );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Sheen Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Khronos/KHR_materials_sheen\n */\nclass GLTFMaterialsSheenExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_SHEEN;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tmaterialParams.sheenColor = new Color( 0, 0, 0 );\n\t\tmaterialParams.sheenRoughness = 0;\n\t\tmaterialParams.sheen = 1;\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.sheenColorFactor !== undefined ) {\n\n\t\t\tmaterialParams.sheenColor.fromArray( extension.sheenColorFactor );\n\n\t\t}\n\n\t\tif ( extension.sheenRoughnessFactor !== undefined ) {\n\n\t\t\tmaterialParams.sheenRoughness = extension.sheenRoughnessFactor;\n\n\t\t}\n\n\t\tif ( extension.sheenColorTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'sheenColorMap', extension.sheenColorTexture ) );\n\n\t\t}\n\n\t\tif ( extension.sheenRoughnessTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'sheenRoughnessMap', extension.sheenRoughnessTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Transmission Materials Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_transmission\n * Draft: https://github.com/KhronosGroup/glTF/pull/1698\n */\nclass GLTFMaterialsTransmissionExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_TRANSMISSION;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tif ( extension.transmissionFactor !== undefined ) {\n\n\t\t\tmaterialParams.transmission = extension.transmissionFactor;\n\n\t\t}\n\n\t\tif ( extension.transmissionTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'transmissionMap', extension.transmissionTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Materials Volume Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_volume\n */\nclass GLTFMaterialsVolumeExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_VOLUME;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.thickness = extension.thicknessFactor !== undefined ? extension.thicknessFactor : 0;\n\n\t\tif ( extension.thicknessTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'thicknessMap', extension.thicknessTexture ) );\n\n\t\t}\n\n\t\tmaterialParams.attenuationDistance = extension.attenuationDistance || 0;\n\n\t\tconst colorArray = extension.attenuationColor || [ 1, 1, 1 ];\n\t\tmaterialParams.attenuationColor = new Color( colorArray[ 0 ], colorArray[ 1 ], colorArray[ 2 ] );\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * Materials ior Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_ior\n */\nclass GLTFMaterialsIorExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_IOR;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.ior = extension.ior !== undefined ? extension.ior : 1.5;\n\n\t\treturn Promise.resolve();\n\n\t}\n\n}\n\n/**\n * Materials specular Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_materials_specular\n */\nclass GLTFMaterialsSpecularExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_SPECULAR;\n\n\t}\n\n\tgetMaterialType( materialIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) return null;\n\n\t\treturn MeshPhysicalMaterial;\n\n\t}\n\n\textendMaterialParams( materialIndex, materialParams ) {\n\n\t\tconst parser = this.parser;\n\t\tconst materialDef = parser.json.materials[ materialIndex ];\n\n\t\tif ( ! materialDef.extensions || ! materialDef.extensions[ this.name ] ) {\n\n\t\t\treturn Promise.resolve();\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tconst extension = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.specularIntensity = extension.specularFactor !== undefined ? extension.specularFactor : 1.0;\n\n\t\tif ( extension.specularTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'specularIntensityMap', extension.specularTexture ) );\n\n\t\t}\n\n\t\tconst colorArray = extension.specularColorFactor || [ 1, 1, 1 ];\n\t\tmaterialParams.specularColor = new Color( colorArray[ 0 ], colorArray[ 1 ], colorArray[ 2 ] );\n\n\t\tif ( extension.specularColorTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'specularColorMap', extension.specularColorTexture ).then( function ( texture ) {\n\n\t\t\t\ttexture.encoding = sRGBEncoding;\n\n\t\t\t} ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n}\n\n/**\n * BasisU Texture Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_texture_basisu\n */\nclass GLTFTextureBasisUExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.KHR_TEXTURE_BASISU;\n\n\t}\n\n\tloadTexture( textureIndex ) {\n\n\t\tconst parser = this.parser;\n\t\tconst json = parser.json;\n\n\t\tconst textureDef = json.textures[ textureIndex ];\n\n\t\tif ( ! textureDef.extensions || ! textureDef.extensions[ this.name ] ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tconst extension = textureDef.extensions[ this.name ];\n\t\tconst loader = parser.options.ktx2Loader;\n\n\t\tif ( ! loader ) {\n\n\t\t\tif ( json.extensionsRequired && json.extensionsRequired.indexOf( this.name ) >= 0 ) {\n\n\t\t\t\tthrow new Error( 'THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures' );\n\n\t\t\t} else {\n\n\t\t\t\t// Assumes that the extension is optional and that a fallback texture is present\n\t\t\t\treturn null;\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn parser.loadTextureImage( textureIndex, extension.source, loader );\n\n\t}\n\n}\n\n/**\n * WebP Texture Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Vendor/EXT_texture_webp\n */\nclass GLTFTextureWebPExtension {\n\n\tconstructor( parser ) {\n\n\t\tthis.parser = parser;\n\t\tthis.name = EXTENSIONS.EXT_TEXTURE_WEBP;\n\t\tthis.isSupported = null;\n\n\t}\n\n\tloadTexture( textureIndex ) {\n\n\t\tconst name = this.name;\n\t\tconst parser = this.parser;\n\t\tconst json = parser.json;\n\n\t\tconst textureDef = json.textures[ textureIndex ];\n\n\t\tif ( ! textureDef.extensions || ! textureDef.extensions[ name ] ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tconst extension = textureDef.extensions[ name ];\n\t\tconst source = json.images[ extension.source ];\n\n\t\tlet loader = parser.textureLoader;\n\t\tif ( source.uri ) {\n\n\t\t\tconst handler = parser.options.manager.getHandler( source.uri );\n\t\t\tif ( handler !== null ) loader = handler;\n\n\t\t}\n\n\t\treturn this.detectSupport().then( function ( isSupported ) {\n\n\t\t\tif ( isSupported ) return parser.loadTextureImage( textureIndex, source, loader );\n\n\t\t\tif ( json.extensionsRequired && json.extensionsRequired.indexOf( name ) >= 0 ) {\n\n\t\t\t\tthrow new Error( 'THREE.GLTFLoader: WebP required by asset but unsupported.' );\n\n\t\t\t}\n\n\t\t\t// Fall back to PNG or JPEG.\n\t\t\treturn parser.loadTexture( textureIndex );\n\n\t\t} );\n\n\t}\n\n\tdetectSupport() {\n\n\t\tif ( ! this.isSupported ) {\n\n\t\t\tthis.isSupported = new Promise( function ( resolve ) {\n\n\t\t\t\tconst image = new Image();\n\n\t\t\t\t// Lossy test image. Support for lossy images doesn't guarantee support for all\n\t\t\t\t// WebP images, unfortunately.\n\t\t\t\timage.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';\n\n\t\t\t\timage.onload = image.onerror = function () {\n\n\t\t\t\t\tresolve( image.height === 1 );\n\n\t\t\t\t};\n\n\t\t\t} );\n\n\t\t}\n\n\t\treturn this.isSupported;\n\n\t}\n\n}\n\n/**\n * meshopt BufferView Compression Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Vendor/EXT_meshopt_compression\n */\nclass GLTFMeshoptCompression {\n\n\tconstructor( parser ) {\n\n\t\tthis.name = EXTENSIONS.EXT_MESHOPT_COMPRESSION;\n\t\tthis.parser = parser;\n\n\t}\n\n\tloadBufferView( index ) {\n\n\t\tconst json = this.parser.json;\n\t\tconst bufferView = json.bufferViews[ index ];\n\n\t\tif ( bufferView.extensions && bufferView.extensions[ this.name ] ) {\n\n\t\t\tconst extensionDef = bufferView.extensions[ this.name ];\n\n\t\t\tconst buffer = this.parser.getDependency( 'buffer', extensionDef.buffer );\n\t\t\tconst decoder = this.parser.options.meshoptDecoder;\n\n\t\t\tif ( ! decoder || ! decoder.supported ) {\n\n\t\t\t\tif ( json.extensionsRequired && json.extensionsRequired.indexOf( this.name ) >= 0 ) {\n\n\t\t\t\t\tthrow new Error( 'THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files' );\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// Assumes that the extension is optional and that fallback buffer data is present\n\t\t\t\t\treturn null;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn Promise.all( [ buffer, decoder.ready ] ).then( function ( res ) {\n\n\t\t\t\tconst byteOffset = extensionDef.byteOffset || 0;\n\t\t\t\tconst byteLength = extensionDef.byteLength || 0;\n\n\t\t\t\tconst count = extensionDef.count;\n\t\t\t\tconst stride = extensionDef.byteStride;\n\n\t\t\t\tconst result = new ArrayBuffer( count * stride );\n\t\t\t\tconst source = new Uint8Array( res[ 0 ], byteOffset, byteLength );\n\n\t\t\t\tdecoder.decodeGltfBuffer( new Uint8Array( result ), count, stride, source, extensionDef.mode, extensionDef.filter );\n\t\t\t\treturn result;\n\n\t\t\t} );\n\n\t\t} else {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t}\n\n}\n\n/* BINARY EXTENSION */\nconst BINARY_EXTENSION_HEADER_MAGIC = 'glTF';\nconst BINARY_EXTENSION_HEADER_LENGTH = 12;\nconst BINARY_EXTENSION_CHUNK_TYPES = { JSON: 0x4E4F534A, BIN: 0x004E4942 };\n\nclass GLTFBinaryExtension {\n\n\tconstructor( data ) {\n\n\t\tthis.name = EXTENSIONS.KHR_BINARY_GLTF;\n\t\tthis.content = null;\n\t\tthis.body = null;\n\n\t\tconst headerView = new DataView( data, 0, BINARY_EXTENSION_HEADER_LENGTH );\n\n\t\tthis.header = {\n\t\t\tmagic: LoaderUtils.decodeText( new Uint8Array( data.slice( 0, 4 ) ) ),\n\t\t\tversion: headerView.getUint32( 4, true ),\n\t\t\tlength: headerView.getUint32( 8, true )\n\t\t};\n\n\t\tif ( this.header.magic !== BINARY_EXTENSION_HEADER_MAGIC ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Unsupported glTF-Binary header.' );\n\n\t\t} else if ( this.header.version < 2.0 ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Legacy binary file detected.' );\n\n\t\t}\n\n\t\tconst chunkContentsLength = this.header.length - BINARY_EXTENSION_HEADER_LENGTH;\n\t\tconst chunkView = new DataView( data, BINARY_EXTENSION_HEADER_LENGTH );\n\t\tlet chunkIndex = 0;\n\n\t\twhile ( chunkIndex < chunkContentsLength ) {\n\n\t\t\tconst chunkLength = chunkView.getUint32( chunkIndex, true );\n\t\t\tchunkIndex += 4;\n\n\t\t\tconst chunkType = chunkView.getUint32( chunkIndex, true );\n\t\t\tchunkIndex += 4;\n\n\t\t\tif ( chunkType === BINARY_EXTENSION_CHUNK_TYPES.JSON ) {\n\n\t\t\t\tconst contentArray = new Uint8Array( data, BINARY_EXTENSION_HEADER_LENGTH + chunkIndex, chunkLength );\n\t\t\t\tthis.content = LoaderUtils.decodeText( contentArray );\n\n\t\t\t} else if ( chunkType === BINARY_EXTENSION_CHUNK_TYPES.BIN ) {\n\n\t\t\t\tconst byteOffset = BINARY_EXTENSION_HEADER_LENGTH + chunkIndex;\n\t\t\t\tthis.body = data.slice( byteOffset, byteOffset + chunkLength );\n\n\t\t\t}\n\n\t\t\t// Clients must ignore chunks with unknown types.\n\n\t\t\tchunkIndex += chunkLength;\n\n\t\t}\n\n\t\tif ( this.content === null ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: JSON content not found.' );\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * DRACO Mesh Compression Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_draco_mesh_compression\n */\nclass GLTFDracoMeshCompressionExtension {\n\n\tconstructor( json, dracoLoader ) {\n\n\t\tif ( ! dracoLoader ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: No DRACOLoader instance provided.' );\n\n\t\t}\n\n\t\tthis.name = EXTENSIONS.KHR_DRACO_MESH_COMPRESSION;\n\t\tthis.json = json;\n\t\tthis.dracoLoader = dracoLoader;\n\t\tthis.dracoLoader.preload();\n\n\t}\n\n\tdecodePrimitive( primitive, parser ) {\n\n\t\tconst json = this.json;\n\t\tconst dracoLoader = this.dracoLoader;\n\t\tconst bufferViewIndex = primitive.extensions[ this.name ].bufferView;\n\t\tconst gltfAttributeMap = primitive.extensions[ this.name ].attributes;\n\t\tconst threeAttributeMap = {};\n\t\tconst attributeNormalizedMap = {};\n\t\tconst attributeTypeMap = {};\n\n\t\tfor ( const attributeName in gltfAttributeMap ) {\n\n\t\t\tconst threeAttributeName = ATTRIBUTES[ attributeName ] || attributeName.toLowerCase();\n\n\t\t\tthreeAttributeMap[ threeAttributeName ] = gltfAttributeMap[ attributeName ];\n\n\t\t}\n\n\t\tfor ( const attributeName in primitive.attributes ) {\n\n\t\t\tconst threeAttributeName = ATTRIBUTES[ attributeName ] || attributeName.toLowerCase();\n\n\t\t\tif ( gltfAttributeMap[ attributeName ] !== undefined ) {\n\n\t\t\t\tconst accessorDef = json.accessors[ primitive.attributes[ attributeName ] ];\n\t\t\t\tconst componentType = WEBGL_COMPONENT_TYPES[ accessorDef.componentType ];\n\n\t\t\t\tattributeTypeMap[ threeAttributeName ] = componentType;\n\t\t\t\tattributeNormalizedMap[ threeAttributeName ] = accessorDef.normalized === true;\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn parser.getDependency( 'bufferView', bufferViewIndex ).then( function ( bufferView ) {\n\n\t\t\treturn new Promise( function ( resolve ) {\n\n\t\t\t\tdracoLoader.decodeDracoFile( bufferView, function ( geometry ) {\n\n\t\t\t\t\tfor ( const attributeName in geometry.attributes ) {\n\n\t\t\t\t\t\tconst attribute = geometry.attributes[ attributeName ];\n\t\t\t\t\t\tconst normalized = attributeNormalizedMap[ attributeName ];\n\n\t\t\t\t\t\tif ( normalized !== undefined ) attribute.normalized = normalized;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve( geometry );\n\n\t\t\t\t}, threeAttributeMap, attributeTypeMap );\n\n\t\t\t} );\n\n\t\t} );\n\n\t}\n\n}\n\n/**\n * Texture Transform Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_texture_transform\n */\nclass GLTFTextureTransformExtension {\n\n\tconstructor() {\n\n\t\tthis.name = EXTENSIONS.KHR_TEXTURE_TRANSFORM;\n\n\t}\n\n\textendTexture( texture, transform ) {\n\n\t\tif ( transform.texCoord !== undefined ) {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Custom UV sets in \"' + this.name + '\" extension not yet supported.' );\n\n\t\t}\n\n\t\tif ( transform.offset === undefined && transform.rotation === undefined && transform.scale === undefined ) {\n\n\t\t\t// See https://github.com/mrdoob/three.js/issues/21819.\n\t\t\treturn texture;\n\n\t\t}\n\n\t\ttexture = texture.clone();\n\n\t\tif ( transform.offset !== undefined ) {\n\n\t\t\ttexture.offset.fromArray( transform.offset );\n\n\t\t}\n\n\t\tif ( transform.rotation !== undefined ) {\n\n\t\t\ttexture.rotation = transform.rotation;\n\n\t\t}\n\n\t\tif ( transform.scale !== undefined ) {\n\n\t\t\ttexture.repeat.fromArray( transform.scale );\n\n\t\t}\n\n\t\ttexture.needsUpdate = true;\n\n\t\treturn texture;\n\n\t}\n\n}\n\n/**\n * Specular-Glossiness Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Archived/KHR_materials_pbrSpecularGlossiness\n */\n\n/**\n * A sub class of StandardMaterial with some of the functionality\n * changed via the `onBeforeCompile` callback\n * @pailhead\n */\nclass GLTFMeshStandardSGMaterial extends MeshStandardMaterial {\n\n\tconstructor( params ) {\n\n\t\tsuper();\n\n\t\tthis.isGLTFSpecularGlossinessMaterial = true;\n\n\t\t//various chunks that need replacing\n\t\tconst specularMapParsFragmentChunk = [\n\t\t\t'#ifdef USE_SPECULARMAP',\n\t\t\t'\tuniform sampler2D specularMap;',\n\t\t\t'#endif'\n\t\t].join( '\\n' );\n\n\t\tconst glossinessMapParsFragmentChunk = [\n\t\t\t'#ifdef USE_GLOSSINESSMAP',\n\t\t\t'\tuniform sampler2D glossinessMap;',\n\t\t\t'#endif'\n\t\t].join( '\\n' );\n\n\t\tconst specularMapFragmentChunk = [\n\t\t\t'vec3 specularFactor = specular;',\n\t\t\t'#ifdef USE_SPECULARMAP',\n\t\t\t'\tvec4 texelSpecular = texture2D( specularMap, vUv );',\n\t\t\t'\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture',\n\t\t\t'\tspecularFactor *= texelSpecular.rgb;',\n\t\t\t'#endif'\n\t\t].join( '\\n' );\n\n\t\tconst glossinessMapFragmentChunk = [\n\t\t\t'float glossinessFactor = glossiness;',\n\t\t\t'#ifdef USE_GLOSSINESSMAP',\n\t\t\t'\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );',\n\t\t\t'\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture',\n\t\t\t'\tglossinessFactor *= texelGlossiness.a;',\n\t\t\t'#endif'\n\t\t].join( '\\n' );\n\n\t\tconst lightPhysicalFragmentChunk = [\n\t\t\t'PhysicalMaterial material;',\n\t\t\t'material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );',\n\t\t\t'vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );',\n\t\t\t'float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );',\n\t\t\t'material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.',\n\t\t\t'material.roughness += geometryRoughness;',\n\t\t\t'material.roughness = min( material.roughness, 1.0 );',\n\t\t\t'material.specularColor = specularFactor;',\n\t\t].join( '\\n' );\n\n\t\tconst uniforms = {\n\t\t\tspecular: { value: new Color().setHex( 0xffffff ) },\n\t\t\tglossiness: { value: 1 },\n\t\t\tspecularMap: { value: null },\n\t\t\tglossinessMap: { value: null }\n\t\t};\n\n\t\tthis._extraUniforms = uniforms;\n\n\t\tthis.onBeforeCompile = function ( shader ) {\n\n\t\t\tfor ( const uniformName in uniforms ) {\n\n\t\t\t\tshader.uniforms[ uniformName ] = uniforms[ uniformName ];\n\n\t\t\t}\n\n\t\t\tshader.fragmentShader = shader.fragmentShader\n\t\t\t\t.replace( 'uniform float roughness;', 'uniform vec3 specular;' )\n\t\t\t\t.replace( 'uniform float metalness;', 'uniform float glossiness;' )\n\t\t\t\t.replace( '#include <roughnessmap_pars_fragment>', specularMapParsFragmentChunk )\n\t\t\t\t.replace( '#include <metalnessmap_pars_fragment>', glossinessMapParsFragmentChunk )\n\t\t\t\t.replace( '#include <roughnessmap_fragment>', specularMapFragmentChunk )\n\t\t\t\t.replace( '#include <metalnessmap_fragment>', glossinessMapFragmentChunk )\n\t\t\t\t.replace( '#include <lights_physical_fragment>', lightPhysicalFragmentChunk );\n\n\t\t};\n\n\t\tObject.defineProperties( this, {\n\n\t\t\tspecular: {\n\t\t\t\tget: function () {\n\n\t\t\t\t\treturn uniforms.specular.value;\n\n\t\t\t\t},\n\t\t\t\tset: function ( v ) {\n\n\t\t\t\t\tuniforms.specular.value = v;\n\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tspecularMap: {\n\t\t\t\tget: function () {\n\n\t\t\t\t\treturn uniforms.specularMap.value;\n\n\t\t\t\t},\n\t\t\t\tset: function ( v ) {\n\n\t\t\t\t\tuniforms.specularMap.value = v;\n\n\t\t\t\t\tif ( v ) {\n\n\t\t\t\t\t\tthis.defines.USE_SPECULARMAP = ''; // USE_UV is set by the renderer for specular maps\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tdelete this.defines.USE_SPECULARMAP;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tglossiness: {\n\t\t\t\tget: function () {\n\n\t\t\t\t\treturn uniforms.glossiness.value;\n\n\t\t\t\t},\n\t\t\t\tset: function ( v ) {\n\n\t\t\t\t\tuniforms.glossiness.value = v;\n\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tglossinessMap: {\n\t\t\t\tget: function () {\n\n\t\t\t\t\treturn uniforms.glossinessMap.value;\n\n\t\t\t\t},\n\t\t\t\tset: function ( v ) {\n\n\t\t\t\t\tuniforms.glossinessMap.value = v;\n\n\t\t\t\t\tif ( v ) {\n\n\t\t\t\t\t\tthis.defines.USE_GLOSSINESSMAP = '';\n\t\t\t\t\t\tthis.defines.USE_UV = '';\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tdelete this.defines.USE_GLOSSINESSMAP;\n\t\t\t\t\t\tdelete this.defines.USE_UV;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t}\n\n\t\t} );\n\n\t\tdelete this.metalness;\n\t\tdelete this.roughness;\n\t\tdelete this.metalnessMap;\n\t\tdelete this.roughnessMap;\n\n\t\tthis.setValues( params );\n\n\t}\n\n\tcopy( source ) {\n\n\t\tsuper.copy( source );\n\n\t\tthis.specularMap = source.specularMap;\n\t\tthis.specular.copy( source.specular );\n\t\tthis.glossinessMap = source.glossinessMap;\n\t\tthis.glossiness = source.glossiness;\n\t\tdelete this.metalness;\n\t\tdelete this.roughness;\n\t\tdelete this.metalnessMap;\n\t\tdelete this.roughnessMap;\n\t\treturn this;\n\n\t}\n\n}\n\n\nclass GLTFMaterialsPbrSpecularGlossinessExtension {\n\n\tconstructor() {\n\n\t\tthis.name = EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS;\n\n\t\tthis.specularGlossinessParams = [\n\t\t\t'color',\n\t\t\t'map',\n\t\t\t'lightMap',\n\t\t\t'lightMapIntensity',\n\t\t\t'aoMap',\n\t\t\t'aoMapIntensity',\n\t\t\t'emissive',\n\t\t\t'emissiveIntensity',\n\t\t\t'emissiveMap',\n\t\t\t'bumpMap',\n\t\t\t'bumpScale',\n\t\t\t'normalMap',\n\t\t\t'normalMapType',\n\t\t\t'displacementMap',\n\t\t\t'displacementScale',\n\t\t\t'displacementBias',\n\t\t\t'specularMap',\n\t\t\t'specular',\n\t\t\t'glossinessMap',\n\t\t\t'glossiness',\n\t\t\t'alphaMap',\n\t\t\t'envMap',\n\t\t\t'envMapIntensity',\n\t\t\t'refractionRatio',\n\t\t];\n\n\t}\n\n\tgetMaterialType() {\n\n\t\treturn GLTFMeshStandardSGMaterial;\n\n\t}\n\n\textendParams( materialParams, materialDef, parser ) {\n\n\t\tconst pbrSpecularGlossiness = materialDef.extensions[ this.name ];\n\n\t\tmaterialParams.color = new Color( 1.0, 1.0, 1.0 );\n\t\tmaterialParams.opacity = 1.0;\n\n\t\tconst pending = [];\n\n\t\tif ( Array.isArray( pbrSpecularGlossiness.diffuseFactor ) ) {\n\n\t\t\tconst array = pbrSpecularGlossiness.diffuseFactor;\n\n\t\t\tmaterialParams.color.fromArray( array );\n\t\t\tmaterialParams.opacity = array[ 3 ];\n\n\t\t}\n\n\t\tif ( pbrSpecularGlossiness.diffuseTexture !== undefined ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'map', pbrSpecularGlossiness.diffuseTexture ) );\n\n\t\t}\n\n\t\tmaterialParams.emissive = new Color( 0.0, 0.0, 0.0 );\n\t\tmaterialParams.glossiness = pbrSpecularGlossiness.glossinessFactor !== undefined ? pbrSpecularGlossiness.glossinessFactor : 1.0;\n\t\tmaterialParams.specular = new Color( 1.0, 1.0, 1.0 );\n\n\t\tif ( Array.isArray( pbrSpecularGlossiness.specularFactor ) ) {\n\n\t\t\tmaterialParams.specular.fromArray( pbrSpecularGlossiness.specularFactor );\n\n\t\t}\n\n\t\tif ( pbrSpecularGlossiness.specularGlossinessTexture !== undefined ) {\n\n\t\t\tconst specGlossMapDef = pbrSpecularGlossiness.specularGlossinessTexture;\n\t\t\tpending.push( parser.assignTexture( materialParams, 'glossinessMap', specGlossMapDef ) );\n\t\t\tpending.push( parser.assignTexture( materialParams, 'specularMap', specGlossMapDef ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n\tcreateMaterial( materialParams ) {\n\n\t\tconst material = new GLTFMeshStandardSGMaterial( materialParams );\n\t\tmaterial.fog = true;\n\n\t\tmaterial.color = materialParams.color;\n\n\t\tmaterial.map = materialParams.map === undefined ? null : materialParams.map;\n\n\t\tmaterial.lightMap = null;\n\t\tmaterial.lightMapIntensity = 1.0;\n\n\t\tmaterial.aoMap = materialParams.aoMap === undefined ? null : materialParams.aoMap;\n\t\tmaterial.aoMapIntensity = 1.0;\n\n\t\tmaterial.emissive = materialParams.emissive;\n\t\tmaterial.emissiveIntensity = 1.0;\n\t\tmaterial.emissiveMap = materialParams.emissiveMap === undefined ? null : materialParams.emissiveMap;\n\n\t\tmaterial.bumpMap = materialParams.bumpMap === undefined ? null : materialParams.bumpMap;\n\t\tmaterial.bumpScale = 1;\n\n\t\tmaterial.normalMap = materialParams.normalMap === undefined ? null : materialParams.normalMap;\n\t\tmaterial.normalMapType = TangentSpaceNormalMap;\n\n\t\tif ( materialParams.normalScale ) material.normalScale = materialParams.normalScale;\n\n\t\tmaterial.displacementMap = null;\n\t\tmaterial.displacementScale = 1;\n\t\tmaterial.displacementBias = 0;\n\n\t\tmaterial.specularMap = materialParams.specularMap === undefined ? null : materialParams.specularMap;\n\t\tmaterial.specular = materialParams.specular;\n\n\t\tmaterial.glossinessMap = materialParams.glossinessMap === undefined ? null : materialParams.glossinessMap;\n\t\tmaterial.glossiness = materialParams.glossiness;\n\n\t\tmaterial.alphaMap = null;\n\n\t\tmaterial.envMap = materialParams.envMap === undefined ? null : materialParams.envMap;\n\t\tmaterial.envMapIntensity = 1.0;\n\n\t\tmaterial.refractionRatio = 0.98;\n\n\t\treturn material;\n\n\t}\n\n}\n\n/**\n * Mesh Quantization Extension\n *\n * Specification: https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_mesh_quantization\n */\nclass GLTFMeshQuantizationExtension {\n\n\tconstructor() {\n\n\t\tthis.name = EXTENSIONS.KHR_MESH_QUANTIZATION;\n\n\t}\n\n}\n\n/*********************************/\n/********** INTERPOLATION ********/\n/*********************************/\n\n// Spline Interpolation\n// Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#appendix-c-spline-interpolation\nclass GLTFCubicSplineInterpolant extends Interpolant {\n\n\tconstructor( parameterPositions, sampleValues, sampleSize, resultBuffer ) {\n\n\t\tsuper( parameterPositions, sampleValues, sampleSize, resultBuffer );\n\n\t}\n\n\tcopySampleValue_( index ) {\n\n\t\t// Copies a sample value to the result buffer. See description of glTF\n\t\t// CUBICSPLINE values layout in interpolate_() function below.\n\n\t\tconst result = this.resultBuffer,\n\t\t\tvalues = this.sampleValues,\n\t\t\tvalueSize = this.valueSize,\n\t\t\toffset = index * valueSize * 3 + valueSize;\n\n\t\tfor ( let i = 0; i !== valueSize; i ++ ) {\n\n\t\t\tresult[ i ] = values[ offset + i ];\n\n\t\t}\n\n\t\treturn result;\n\n\t}\n\n}\n\nGLTFCubicSplineInterpolant.prototype.beforeStart_ = GLTFCubicSplineInterpolant.prototype.copySampleValue_;\n\nGLTFCubicSplineInterpolant.prototype.afterEnd_ = GLTFCubicSplineInterpolant.prototype.copySampleValue_;\n\nGLTFCubicSplineInterpolant.prototype.interpolate_ = function ( i1, t0, t, t1 ) {\n\n\tconst result = this.resultBuffer;\n\tconst values = this.sampleValues;\n\tconst stride = this.valueSize;\n\n\tconst stride2 = stride * 2;\n\tconst stride3 = stride * 3;\n\n\tconst td = t1 - t0;\n\n\tconst p = ( t - t0 ) / td;\n\tconst pp = p * p;\n\tconst ppp = pp * p;\n\n\tconst offset1 = i1 * stride3;\n\tconst offset0 = offset1 - stride3;\n\n\tconst s2 = - 2 * ppp + 3 * pp;\n\tconst s3 = ppp - pp;\n\tconst s0 = 1 - s2;\n\tconst s1 = s3 - pp + p;\n\n\t// Layout of keyframe output values for CUBICSPLINE animations:\n\t//   [ inTangent_1, splineVertex_1, outTangent_1, inTangent_2, splineVertex_2, ... ]\n\tfor ( let i = 0; i !== stride; i ++ ) {\n\n\t\tconst p0 = values[ offset0 + i + stride ]; // splineVertex_k\n\t\tconst m0 = values[ offset0 + i + stride2 ] * td; // outTangent_k * (t_k+1 - t_k)\n\t\tconst p1 = values[ offset1 + i + stride ]; // splineVertex_k+1\n\t\tconst m1 = values[ offset1 + i ] * td; // inTangent_k+1 * (t_k+1 - t_k)\n\n\t\tresult[ i ] = s0 * p0 + s1 * m0 + s2 * p1 + s3 * m1;\n\n\t}\n\n\treturn result;\n\n};\n\nconst _q = new Quaternion();\n\nclass GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant {\n\n\tinterpolate_( i1, t0, t, t1 ) {\n\n\t\tconst result = super.interpolate_( i1, t0, t, t1 );\n\n\t\t_q.fromArray( result ).normalize().toArray( result );\n\n\t\treturn result;\n\n\t}\n\n}\n\n\n/*********************************/\n/********** INTERNALS ************/\n/*********************************/\n\n/* CONSTANTS */\n\nconst WEBGL_CONSTANTS = {\n\tFLOAT: 5126,\n\t//FLOAT_MAT2: 35674,\n\tFLOAT_MAT3: 35675,\n\tFLOAT_MAT4: 35676,\n\tFLOAT_VEC2: 35664,\n\tFLOAT_VEC3: 35665,\n\tFLOAT_VEC4: 35666,\n\tLINEAR: 9729,\n\tREPEAT: 10497,\n\tSAMPLER_2D: 35678,\n\tPOINTS: 0,\n\tLINES: 1,\n\tLINE_LOOP: 2,\n\tLINE_STRIP: 3,\n\tTRIANGLES: 4,\n\tTRIANGLE_STRIP: 5,\n\tTRIANGLE_FAN: 6,\n\tUNSIGNED_BYTE: 5121,\n\tUNSIGNED_SHORT: 5123\n};\n\nconst WEBGL_COMPONENT_TYPES = {\n\t5120: Int8Array,\n\t5121: Uint8Array,\n\t5122: Int16Array,\n\t5123: Uint16Array,\n\t5125: Uint32Array,\n\t5126: Float32Array\n};\n\nconst WEBGL_FILTERS = {\n\t9728: NearestFilter,\n\t9729: LinearFilter,\n\t9984: NearestMipmapNearestFilter,\n\t9985: LinearMipmapNearestFilter,\n\t9986: NearestMipmapLinearFilter,\n\t9987: LinearMipmapLinearFilter\n};\n\nconst WEBGL_WRAPPINGS = {\n\t33071: ClampToEdgeWrapping,\n\t33648: MirroredRepeatWrapping,\n\t10497: RepeatWrapping\n};\n\nconst WEBGL_TYPE_SIZES = {\n\t'SCALAR': 1,\n\t'VEC2': 2,\n\t'VEC3': 3,\n\t'VEC4': 4,\n\t'MAT2': 4,\n\t'MAT3': 9,\n\t'MAT4': 16\n};\n\nconst ATTRIBUTES = {\n\tPOSITION: 'position',\n\tNORMAL: 'normal',\n\tTANGENT: 'tangent',\n\tTEXCOORD_0: 'uv',\n\tTEXCOORD_1: 'uv2',\n\tCOLOR_0: 'color',\n\tWEIGHTS_0: 'skinWeight',\n\tJOINTS_0: 'skinIndex',\n};\n\nconst PATH_PROPERTIES = {\n\tscale: 'scale',\n\ttranslation: 'position',\n\trotation: 'quaternion',\n\tweights: 'morphTargetInfluences'\n};\n\nconst INTERPOLATION = {\n\tCUBICSPLINE: undefined, // We use a custom interpolant (GLTFCubicSplineInterpolation) for CUBICSPLINE tracks. Each\n\t\t                        // keyframe track will be initialized with a default interpolation type, then modified.\n\tLINEAR: InterpolateLinear,\n\tSTEP: InterpolateDiscrete\n};\n\nconst ALPHA_MODES = {\n\tOPAQUE: 'OPAQUE',\n\tMASK: 'MASK',\n\tBLEND: 'BLEND'\n};\n\n/**\n * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#default-material\n */\nfunction createDefaultMaterial( cache ) {\n\n\tif ( cache[ 'DefaultMaterial' ] === undefined ) {\n\n\t\tcache[ 'DefaultMaterial' ] = new MeshStandardMaterial( {\n\t\t\tcolor: 0xFFFFFF,\n\t\t\temissive: 0x000000,\n\t\t\tmetalness: 1,\n\t\t\troughness: 1,\n\t\t\ttransparent: false,\n\t\t\tdepthTest: true,\n\t\t\tside: FrontSide\n\t\t} );\n\n\t}\n\n\treturn cache[ 'DefaultMaterial' ];\n\n}\n\nfunction addUnknownExtensionsToUserData( knownExtensions, object, objectDef ) {\n\n\t// Add unknown glTF extensions to an object's userData.\n\n\tfor ( const name in objectDef.extensions ) {\n\n\t\tif ( knownExtensions[ name ] === undefined ) {\n\n\t\t\tobject.userData.gltfExtensions = object.userData.gltfExtensions || {};\n\t\t\tobject.userData.gltfExtensions[ name ] = objectDef.extensions[ name ];\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * @param {Object3D|Material|BufferGeometry} object\n * @param {GLTF.definition} gltfDef\n */\nfunction assignExtrasToUserData( object, gltfDef ) {\n\n\tif ( gltfDef.extras !== undefined ) {\n\n\t\tif ( typeof gltfDef.extras === 'object' ) {\n\n\t\t\tObject.assign( object.userData, gltfDef.extras );\n\n\t\t} else {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Ignoring primitive type .extras, ' + gltfDef.extras );\n\n\t\t}\n\n\t}\n\n}\n\n/**\n * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#morph-targets\n *\n * @param {BufferGeometry} geometry\n * @param {Array<GLTF.Target>} targets\n * @param {GLTFParser} parser\n * @return {Promise<BufferGeometry>}\n */\nfunction addMorphTargets( geometry, targets, parser ) {\n\n\tlet hasMorphPosition = false;\n\tlet hasMorphNormal = false;\n\tlet hasMorphColor = false;\n\n\tfor ( let i = 0, il = targets.length; i < il; i ++ ) {\n\n\t\tconst target = targets[ i ];\n\n\t\tif ( target.POSITION !== undefined ) hasMorphPosition = true;\n\t\tif ( target.NORMAL !== undefined ) hasMorphNormal = true;\n\t\tif ( target.COLOR_0 !== undefined ) hasMorphColor = true;\n\n\t\tif ( hasMorphPosition && hasMorphNormal && hasMorphColor ) break;\n\n\t}\n\n\tif ( ! hasMorphPosition && ! hasMorphNormal && ! hasMorphColor ) return Promise.resolve( geometry );\n\n\tconst pendingPositionAccessors = [];\n\tconst pendingNormalAccessors = [];\n\tconst pendingColorAccessors = [];\n\n\tfor ( let i = 0, il = targets.length; i < il; i ++ ) {\n\n\t\tconst target = targets[ i ];\n\n\t\tif ( hasMorphPosition ) {\n\n\t\t\tconst pendingAccessor = target.POSITION !== undefined\n\t\t\t\t? parser.getDependency( 'accessor', target.POSITION )\n\t\t\t\t: geometry.attributes.position;\n\n\t\t\tpendingPositionAccessors.push( pendingAccessor );\n\n\t\t}\n\n\t\tif ( hasMorphNormal ) {\n\n\t\t\tconst pendingAccessor = target.NORMAL !== undefined\n\t\t\t\t? parser.getDependency( 'accessor', target.NORMAL )\n\t\t\t\t: geometry.attributes.normal;\n\n\t\t\tpendingNormalAccessors.push( pendingAccessor );\n\n\t\t}\n\n\t\tif ( hasMorphColor ) {\n\n\t\t\tconst pendingAccessor = target.COLOR_0 !== undefined\n\t\t\t\t? parser.getDependency( 'accessor', target.COLOR_0 )\n\t\t\t\t: geometry.attributes.color;\n\n\t\t\tpendingColorAccessors.push( pendingAccessor );\n\n\t\t}\n\n\t}\n\n\treturn Promise.all( [\n\t\tPromise.all( pendingPositionAccessors ),\n\t\tPromise.all( pendingNormalAccessors ),\n\t\tPromise.all( pendingColorAccessors )\n\t] ).then( function ( accessors ) {\n\n\t\tconst morphPositions = accessors[ 0 ];\n\t\tconst morphNormals = accessors[ 1 ];\n\t\tconst morphColors = accessors[ 2 ];\n\n\t\tif ( hasMorphPosition ) geometry.morphAttributes.position = morphPositions;\n\t\tif ( hasMorphNormal ) geometry.morphAttributes.normal = morphNormals;\n\t\tif ( hasMorphColor ) geometry.morphAttributes.color = morphColors;\n\t\tgeometry.morphTargetsRelative = true;\n\n\t\treturn geometry;\n\n\t} );\n\n}\n\n/**\n * @param {Mesh} mesh\n * @param {GLTF.Mesh} meshDef\n */\nfunction updateMorphTargets( mesh, meshDef ) {\n\n\tmesh.updateMorphTargets();\n\n\tif ( meshDef.weights !== undefined ) {\n\n\t\tfor ( let i = 0, il = meshDef.weights.length; i < il; i ++ ) {\n\n\t\t\tmesh.morphTargetInfluences[ i ] = meshDef.weights[ i ];\n\n\t\t}\n\n\t}\n\n\t// .extras has user-defined data, so check that .extras.targetNames is an array.\n\tif ( meshDef.extras && Array.isArray( meshDef.extras.targetNames ) ) {\n\n\t\tconst targetNames = meshDef.extras.targetNames;\n\n\t\tif ( mesh.morphTargetInfluences.length === targetNames.length ) {\n\n\t\t\tmesh.morphTargetDictionary = {};\n\n\t\t\tfor ( let i = 0, il = targetNames.length; i < il; i ++ ) {\n\n\t\t\t\tmesh.morphTargetDictionary[ targetNames[ i ] ] = i;\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.' );\n\n\t\t}\n\n\t}\n\n}\n\nfunction createPrimitiveKey( primitiveDef ) {\n\n\tconst dracoExtension = primitiveDef.extensions && primitiveDef.extensions[ EXTENSIONS.KHR_DRACO_MESH_COMPRESSION ];\n\tlet geometryKey;\n\n\tif ( dracoExtension ) {\n\n\t\tgeometryKey = 'draco:' + dracoExtension.bufferView\n\t\t\t\t+ ':' + dracoExtension.indices\n\t\t\t\t+ ':' + createAttributesKey( dracoExtension.attributes );\n\n\t} else {\n\n\t\tgeometryKey = primitiveDef.indices + ':' + createAttributesKey( primitiveDef.attributes ) + ':' + primitiveDef.mode;\n\n\t}\n\n\treturn geometryKey;\n\n}\n\nfunction createAttributesKey( attributes ) {\n\n\tlet attributesKey = '';\n\n\tconst keys = Object.keys( attributes ).sort();\n\n\tfor ( let i = 0, il = keys.length; i < il; i ++ ) {\n\n\t\tattributesKey += keys[ i ] + ':' + attributes[ keys[ i ] ] + ';';\n\n\t}\n\n\treturn attributesKey;\n\n}\n\nfunction getNormalizedComponentScale( constructor ) {\n\n\t// Reference:\n\t// https://github.com/KhronosGroup/glTF/tree/master/extensions/2.0/Khronos/KHR_mesh_quantization#encoding-quantized-data\n\n\tswitch ( constructor ) {\n\n\t\tcase Int8Array:\n\t\t\treturn 1 / 127;\n\n\t\tcase Uint8Array:\n\t\t\treturn 1 / 255;\n\n\t\tcase Int16Array:\n\t\t\treturn 1 / 32767;\n\n\t\tcase Uint16Array:\n\t\t\treturn 1 / 65535;\n\n\t\tdefault:\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Unsupported normalized accessor component type.' );\n\n\t}\n\n}\n\nfunction getImageURIMimeType( uri ) {\n\n\tif ( uri.search( /\\.jpe?g($|\\?)/i ) > 0 || uri.search( /^data\\:image\\/jpeg/ ) === 0 ) return 'image/jpeg';\n\tif ( uri.search( /\\.webp($|\\?)/i ) > 0 || uri.search( /^data\\:image\\/webp/ ) === 0 ) return 'image/webp';\n\n\treturn 'image/png';\n\n}\n\n/* GLTF PARSER */\n\nclass GLTFParser {\n\n\tconstructor( json = {}, options = {} ) {\n\n\t\tthis.json = json;\n\t\tthis.extensions = {};\n\t\tthis.plugins = {};\n\t\tthis.options = options;\n\n\t\t// loader object cache\n\t\tthis.cache = new GLTFRegistry();\n\n\t\t// associations between Three.js objects and glTF elements\n\t\tthis.associations = new Map();\n\n\t\t// BufferGeometry caching\n\t\tthis.primitiveCache = {};\n\n\t\t// Object3D instance caches\n\t\tthis.meshCache = { refs: {}, uses: {} };\n\t\tthis.cameraCache = { refs: {}, uses: {} };\n\t\tthis.lightCache = { refs: {}, uses: {} };\n\n\t\tthis.sourceCache = {};\n\t\tthis.textureCache = {};\n\n\t\t// Track node names, to ensure no duplicates\n\t\tthis.nodeNamesUsed = {};\n\n\t\t// Use an ImageBitmapLoader if imageBitmaps are supported. Moves much of the\n\t\t// expensive work of uploading a texture to the GPU off the main thread.\n\t\tif ( typeof createImageBitmap !== 'undefined' && /Firefox|^((?!chrome|android).)*safari/i.test( navigator.userAgent ) === false ) {\n\n\t\t\tthis.textureLoader = new ImageBitmapLoader( this.options.manager );\n\n\t\t} else {\n\n\t\t\tthis.textureLoader = new TextureLoader( this.options.manager );\n\n\t\t}\n\n\t\tthis.textureLoader.setCrossOrigin( this.options.crossOrigin );\n\t\tthis.textureLoader.setRequestHeader( this.options.requestHeader );\n\n\t\tthis.fileLoader = new FileLoader( this.options.manager );\n\t\tthis.fileLoader.setResponseType( 'arraybuffer' );\n\n\t\tif ( this.options.crossOrigin === 'use-credentials' ) {\n\n\t\t\tthis.fileLoader.setWithCredentials( true );\n\n\t\t}\n\n\t}\n\n\tsetExtensions( extensions ) {\n\n\t\tthis.extensions = extensions;\n\n\t}\n\n\tsetPlugins( plugins ) {\n\n\t\tthis.plugins = plugins;\n\n\t}\n\n\tparse( onLoad, onError ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\n\t\t// Clear the loader cache\n\t\tthis.cache.removeAll();\n\n\t\t// Mark the special nodes/meshes in json for efficient parse\n\t\tthis._invokeAll( function ( ext ) {\n\n\t\t\treturn ext._markDefs && ext._markDefs();\n\n\t\t} );\n\n\t\tPromise.all( this._invokeAll( function ( ext ) {\n\n\t\t\treturn ext.beforeRoot && ext.beforeRoot();\n\n\t\t} ) ).then( function () {\n\n\t\t\treturn Promise.all( [\n\n\t\t\t\tparser.getDependencies( 'scene' ),\n\t\t\t\tparser.getDependencies( 'animation' ),\n\t\t\t\tparser.getDependencies( 'camera' ),\n\n\t\t\t] );\n\n\t\t} ).then( function ( dependencies ) {\n\n\t\t\tconst result = {\n\t\t\t\tscene: dependencies[ 0 ][ json.scene || 0 ],\n\t\t\t\tscenes: dependencies[ 0 ],\n\t\t\t\tanimations: dependencies[ 1 ],\n\t\t\t\tcameras: dependencies[ 2 ],\n\t\t\t\tasset: json.asset,\n\t\t\t\tparser: parser,\n\t\t\t\tuserData: {}\n\t\t\t};\n\n\t\t\taddUnknownExtensionsToUserData( extensions, result, json );\n\n\t\t\tassignExtrasToUserData( result, json );\n\n\t\t\tPromise.all( parser._invokeAll( function ( ext ) {\n\n\t\t\t\treturn ext.afterRoot && ext.afterRoot( result );\n\n\t\t\t} ) ).then( function () {\n\n\t\t\t\tonLoad( result );\n\n\t\t\t} );\n\n\t\t} ).catch( onError );\n\n\t}\n\n\t/**\n\t * Marks the special nodes/meshes in json for efficient parse.\n\t */\n\t_markDefs() {\n\n\t\tconst nodeDefs = this.json.nodes || [];\n\t\tconst skinDefs = this.json.skins || [];\n\t\tconst meshDefs = this.json.meshes || [];\n\n\t\t// Nothing in the node definition indicates whether it is a Bone or an\n\t\t// Object3D. Use the skins' joint references to mark bones.\n\t\tfor ( let skinIndex = 0, skinLength = skinDefs.length; skinIndex < skinLength; skinIndex ++ ) {\n\n\t\t\tconst joints = skinDefs[ skinIndex ].joints;\n\n\t\t\tfor ( let i = 0, il = joints.length; i < il; i ++ ) {\n\n\t\t\t\tnodeDefs[ joints[ i ] ].isBone = true;\n\n\t\t\t}\n\n\t\t}\n\n\t\t// Iterate over all nodes, marking references to shared resources,\n\t\t// as well as skeleton joints.\n\t\tfor ( let nodeIndex = 0, nodeLength = nodeDefs.length; nodeIndex < nodeLength; nodeIndex ++ ) {\n\n\t\t\tconst nodeDef = nodeDefs[ nodeIndex ];\n\n\t\t\tif ( nodeDef.mesh !== undefined ) {\n\n\t\t\t\tthis._addNodeRef( this.meshCache, nodeDef.mesh );\n\n\t\t\t\t// Nothing in the mesh definition indicates whether it is\n\t\t\t\t// a SkinnedMesh or Mesh. Use the node's mesh reference\n\t\t\t\t// to mark SkinnedMesh if node has skin.\n\t\t\t\tif ( nodeDef.skin !== undefined ) {\n\n\t\t\t\t\tmeshDefs[ nodeDef.mesh ].isSkinnedMesh = true;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( nodeDef.camera !== undefined ) {\n\n\t\t\t\tthis._addNodeRef( this.cameraCache, nodeDef.camera );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Counts references to shared node / Object3D resources. These resources\n\t * can be reused, or \"instantiated\", at multiple nodes in the scene\n\t * hierarchy. Mesh, Camera, and Light instances are instantiated and must\n\t * be marked. Non-scenegraph resources (like Materials, Geometries, and\n\t * Textures) can be reused directly and are not marked here.\n\t *\n\t * Example: CesiumMilkTruck sample model reuses \"Wheel\" meshes.\n\t */\n\t_addNodeRef( cache, index ) {\n\n\t\tif ( index === undefined ) return;\n\n\t\tif ( cache.refs[ index ] === undefined ) {\n\n\t\t\tcache.refs[ index ] = cache.uses[ index ] = 0;\n\n\t\t}\n\n\t\tcache.refs[ index ] ++;\n\n\t}\n\n\t/** Returns a reference to a shared resource, cloning it if necessary. */\n\t_getNodeRef( cache, index, object ) {\n\n\t\tif ( cache.refs[ index ] <= 1 ) return object;\n\n\t\tconst ref = object.clone();\n\n\t\t// Propagates mappings to the cloned object, prevents mappings on the\n\t\t// original object from being lost.\n\t\tconst updateMappings = ( original, clone ) => {\n\n\t\t\tconst mappings = this.associations.get( original );\n\t\t\tif ( mappings != null ) {\n\n\t\t\t\tthis.associations.set( clone, mappings );\n\n\t\t\t}\n\n\t\t\tfor ( const [ i, child ] of original.children.entries() ) {\n\n\t\t\t\tupdateMappings( child, clone.children[ i ] );\n\n\t\t\t}\n\n\t\t};\n\n\t\tupdateMappings( object, ref );\n\n\t\tref.name += '_instance_' + ( cache.uses[ index ] ++ );\n\n\t\treturn ref;\n\n\t}\n\n\t_invokeOne( func ) {\n\n\t\tconst extensions = Object.values( this.plugins );\n\t\textensions.push( this );\n\n\t\tfor ( let i = 0; i < extensions.length; i ++ ) {\n\n\t\t\tconst result = func( extensions[ i ] );\n\n\t\t\tif ( result ) return result;\n\n\t\t}\n\n\t\treturn null;\n\n\t}\n\n\t_invokeAll( func ) {\n\n\t\tconst extensions = Object.values( this.plugins );\n\t\textensions.unshift( this );\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0; i < extensions.length; i ++ ) {\n\n\t\t\tconst result = func( extensions[ i ] );\n\n\t\t\tif ( result ) pending.push( result );\n\n\t\t}\n\n\t\treturn pending;\n\n\t}\n\n\t/**\n\t * Requests the specified dependency asynchronously, with caching.\n\t * @param {string} type\n\t * @param {number} index\n\t * @return {Promise<Object3D|Material|THREE.Texture|AnimationClip|ArrayBuffer|Object>}\n\t */\n\tgetDependency( type, index ) {\n\n\t\tconst cacheKey = type + ':' + index;\n\t\tlet dependency = this.cache.get( cacheKey );\n\n\t\tif ( ! dependency ) {\n\n\t\t\tswitch ( type ) {\n\n\t\t\t\tcase 'scene':\n\t\t\t\t\tdependency = this.loadScene( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'node':\n\t\t\t\t\tdependency = this.loadNode( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'mesh':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadMesh && ext.loadMesh( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'accessor':\n\t\t\t\t\tdependency = this.loadAccessor( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'bufferView':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadBufferView && ext.loadBufferView( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'buffer':\n\t\t\t\t\tdependency = this.loadBuffer( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'material':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadMaterial && ext.loadMaterial( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'texture':\n\t\t\t\t\tdependency = this._invokeOne( function ( ext ) {\n\n\t\t\t\t\t\treturn ext.loadTexture && ext.loadTexture( index );\n\n\t\t\t\t\t} );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'skin':\n\t\t\t\t\tdependency = this.loadSkin( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'animation':\n\t\t\t\t\tdependency = this.loadAnimation( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'camera':\n\t\t\t\t\tdependency = this.loadCamera( index );\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new Error( 'Unknown type: ' + type );\n\n\t\t\t}\n\n\t\t\tthis.cache.add( cacheKey, dependency );\n\n\t\t}\n\n\t\treturn dependency;\n\n\t}\n\n\t/**\n\t * Requests all dependencies of the specified type asynchronously, with caching.\n\t * @param {string} type\n\t * @return {Promise<Array<Object>>}\n\t */\n\tgetDependencies( type ) {\n\n\t\tlet dependencies = this.cache.get( type );\n\n\t\tif ( ! dependencies ) {\n\n\t\t\tconst parser = this;\n\t\t\tconst defs = this.json[ type + ( type === 'mesh' ? 'es' : 's' ) ] || [];\n\n\t\t\tdependencies = Promise.all( defs.map( function ( def, index ) {\n\n\t\t\t\treturn parser.getDependency( type, index );\n\n\t\t\t} ) );\n\n\t\t\tthis.cache.add( type, dependencies );\n\n\t\t}\n\n\t\treturn dependencies;\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#buffers-and-buffer-views\n\t * @param {number} bufferIndex\n\t * @return {Promise<ArrayBuffer>}\n\t */\n\tloadBuffer( bufferIndex ) {\n\n\t\tconst bufferDef = this.json.buffers[ bufferIndex ];\n\t\tconst loader = this.fileLoader;\n\n\t\tif ( bufferDef.type && bufferDef.type !== 'arraybuffer' ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: ' + bufferDef.type + ' buffer type is not supported.' );\n\n\t\t}\n\n\t\t// If present, GLB container is required to be the first buffer.\n\t\tif ( bufferDef.uri === undefined && bufferIndex === 0 ) {\n\n\t\t\treturn Promise.resolve( this.extensions[ EXTENSIONS.KHR_BINARY_GLTF ].body );\n\n\t\t}\n\n\t\tconst options = this.options;\n\n\t\treturn new Promise( function ( resolve, reject ) {\n\n\t\t\tloader.load( LoaderUtils.resolveURL( bufferDef.uri, options.path ), resolve, undefined, function () {\n\n\t\t\t\treject( new Error( 'THREE.GLTFLoader: Failed to load buffer \"' + bufferDef.uri + '\".' ) );\n\n\t\t\t} );\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#buffers-and-buffer-views\n\t * @param {number} bufferViewIndex\n\t * @return {Promise<ArrayBuffer>}\n\t */\n\tloadBufferView( bufferViewIndex ) {\n\n\t\tconst bufferViewDef = this.json.bufferViews[ bufferViewIndex ];\n\n\t\treturn this.getDependency( 'buffer', bufferViewDef.buffer ).then( function ( buffer ) {\n\n\t\t\tconst byteLength = bufferViewDef.byteLength || 0;\n\t\t\tconst byteOffset = bufferViewDef.byteOffset || 0;\n\t\t\treturn buffer.slice( byteOffset, byteOffset + byteLength );\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#accessors\n\t * @param {number} accessorIndex\n\t * @return {Promise<BufferAttribute|InterleavedBufferAttribute>}\n\t */\n\tloadAccessor( accessorIndex ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\n\t\tconst accessorDef = this.json.accessors[ accessorIndex ];\n\n\t\tif ( accessorDef.bufferView === undefined && accessorDef.sparse === undefined ) {\n\n\t\t\t// Ignore empty accessors, which may be used to declare runtime\n\t\t\t// information about attributes coming from another source (e.g. Draco\n\t\t\t// compression extension).\n\t\t\treturn Promise.resolve( null );\n\n\t\t}\n\n\t\tconst pendingBufferViews = [];\n\n\t\tif ( accessorDef.bufferView !== undefined ) {\n\n\t\t\tpendingBufferViews.push( this.getDependency( 'bufferView', accessorDef.bufferView ) );\n\n\t\t} else {\n\n\t\t\tpendingBufferViews.push( null );\n\n\t\t}\n\n\t\tif ( accessorDef.sparse !== undefined ) {\n\n\t\t\tpendingBufferViews.push( this.getDependency( 'bufferView', accessorDef.sparse.indices.bufferView ) );\n\t\t\tpendingBufferViews.push( this.getDependency( 'bufferView', accessorDef.sparse.values.bufferView ) );\n\n\t\t}\n\n\t\treturn Promise.all( pendingBufferViews ).then( function ( bufferViews ) {\n\n\t\t\tconst bufferView = bufferViews[ 0 ];\n\n\t\t\tconst itemSize = WEBGL_TYPE_SIZES[ accessorDef.type ];\n\t\t\tconst TypedArray = WEBGL_COMPONENT_TYPES[ accessorDef.componentType ];\n\n\t\t\t// For VEC3: itemSize is 3, elementBytes is 4, itemBytes is 12.\n\t\t\tconst elementBytes = TypedArray.BYTES_PER_ELEMENT;\n\t\t\tconst itemBytes = elementBytes * itemSize;\n\t\t\tconst byteOffset = accessorDef.byteOffset || 0;\n\t\t\tconst byteStride = accessorDef.bufferView !== undefined ? json.bufferViews[ accessorDef.bufferView ].byteStride : undefined;\n\t\t\tconst normalized = accessorDef.normalized === true;\n\t\t\tlet array, bufferAttribute;\n\n\t\t\t// The buffer is not interleaved if the stride is the item size in bytes.\n\t\t\tif ( byteStride && byteStride !== itemBytes ) {\n\n\t\t\t\t// Each \"slice\" of the buffer, as defined by 'count' elements of 'byteStride' bytes, gets its own InterleavedBuffer\n\t\t\t\t// This makes sure that IBA.count reflects accessor.count properly\n\t\t\t\tconst ibSlice = Math.floor( byteOffset / byteStride );\n\t\t\t\tconst ibCacheKey = 'InterleavedBuffer:' + accessorDef.bufferView + ':' + accessorDef.componentType + ':' + ibSlice + ':' + accessorDef.count;\n\t\t\t\tlet ib = parser.cache.get( ibCacheKey );\n\n\t\t\t\tif ( ! ib ) {\n\n\t\t\t\t\tarray = new TypedArray( bufferView, ibSlice * byteStride, accessorDef.count * byteStride / elementBytes );\n\n\t\t\t\t\t// Integer parameters to IB/IBA are in array elements, not bytes.\n\t\t\t\t\tib = new InterleavedBuffer( array, byteStride / elementBytes );\n\n\t\t\t\t\tparser.cache.add( ibCacheKey, ib );\n\n\t\t\t\t}\n\n\t\t\t\tbufferAttribute = new InterleavedBufferAttribute( ib, itemSize, ( byteOffset % byteStride ) / elementBytes, normalized );\n\n\t\t\t} else {\n\n\t\t\t\tif ( bufferView === null ) {\n\n\t\t\t\t\tarray = new TypedArray( accessorDef.count * itemSize );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tarray = new TypedArray( bufferView, byteOffset, accessorDef.count * itemSize );\n\n\t\t\t\t}\n\n\t\t\t\tbufferAttribute = new BufferAttribute( array, itemSize, normalized );\n\n\t\t\t}\n\n\t\t\t// https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#sparse-accessors\n\t\t\tif ( accessorDef.sparse !== undefined ) {\n\n\t\t\t\tconst itemSizeIndices = WEBGL_TYPE_SIZES.SCALAR;\n\t\t\t\tconst TypedArrayIndices = WEBGL_COMPONENT_TYPES[ accessorDef.sparse.indices.componentType ];\n\n\t\t\t\tconst byteOffsetIndices = accessorDef.sparse.indices.byteOffset || 0;\n\t\t\t\tconst byteOffsetValues = accessorDef.sparse.values.byteOffset || 0;\n\n\t\t\t\tconst sparseIndices = new TypedArrayIndices( bufferViews[ 1 ], byteOffsetIndices, accessorDef.sparse.count * itemSizeIndices );\n\t\t\t\tconst sparseValues = new TypedArray( bufferViews[ 2 ], byteOffsetValues, accessorDef.sparse.count * itemSize );\n\n\t\t\t\tif ( bufferView !== null ) {\n\n\t\t\t\t\t// Avoid modifying the original ArrayBuffer, if the bufferView wasn't initialized with zeroes.\n\t\t\t\t\tbufferAttribute = new BufferAttribute( bufferAttribute.array.slice(), bufferAttribute.itemSize, bufferAttribute.normalized );\n\n\t\t\t\t}\n\n\t\t\t\tfor ( let i = 0, il = sparseIndices.length; i < il; i ++ ) {\n\n\t\t\t\t\tconst index = sparseIndices[ i ];\n\n\t\t\t\t\tbufferAttribute.setX( index, sparseValues[ i * itemSize ] );\n\t\t\t\t\tif ( itemSize >= 2 ) bufferAttribute.setY( index, sparseValues[ i * itemSize + 1 ] );\n\t\t\t\t\tif ( itemSize >= 3 ) bufferAttribute.setZ( index, sparseValues[ i * itemSize + 2 ] );\n\t\t\t\t\tif ( itemSize >= 4 ) bufferAttribute.setW( index, sparseValues[ i * itemSize + 3 ] );\n\t\t\t\t\tif ( itemSize >= 5 ) throw new Error( 'THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.' );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn bufferAttribute;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#textures\n\t * @param {number} textureIndex\n\t * @return {Promise<THREE.Texture>}\n\t */\n\tloadTexture( textureIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst options = this.options;\n\t\tconst textureDef = json.textures[ textureIndex ];\n\t\tconst sourceIndex = textureDef.source;\n\t\tconst sourceDef = json.images[ sourceIndex ];\n\n\t\tlet loader = this.textureLoader;\n\n\t\tif ( sourceDef.uri ) {\n\n\t\t\tconst handler = options.manager.getHandler( sourceDef.uri );\n\t\t\tif ( handler !== null ) loader = handler;\n\n\t\t}\n\n\t\treturn this.loadTextureImage( textureIndex, sourceIndex, loader );\n\n\t}\n\n\tloadTextureImage( textureIndex, sourceIndex, loader ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\n\t\tconst textureDef = json.textures[ textureIndex ];\n\t\tconst sourceDef = json.images[ sourceIndex ];\n\n\t\tconst cacheKey = ( sourceDef.uri || sourceDef.bufferView ) + ':' + textureDef.sampler;\n\n\t\tif ( this.textureCache[ cacheKey ] ) {\n\n\t\t\t// See https://github.com/mrdoob/three.js/issues/21559.\n\t\t\treturn this.textureCache[ cacheKey ];\n\n\t\t}\n\n\t\tconst promise = this.loadImageSource( sourceIndex, loader ).then( function ( texture ) {\n\n\t\t\ttexture.flipY = false;\n\n\t\t\tif ( textureDef.name ) texture.name = textureDef.name;\n\n\t\t\tconst samplers = json.samplers || {};\n\t\t\tconst sampler = samplers[ textureDef.sampler ] || {};\n\n\t\t\ttexture.magFilter = WEBGL_FILTERS[ sampler.magFilter ] || LinearFilter;\n\t\t\ttexture.minFilter = WEBGL_FILTERS[ sampler.minFilter ] || LinearMipmapLinearFilter;\n\t\t\ttexture.wrapS = WEBGL_WRAPPINGS[ sampler.wrapS ] || RepeatWrapping;\n\t\t\ttexture.wrapT = WEBGL_WRAPPINGS[ sampler.wrapT ] || RepeatWrapping;\n\n\t\t\tparser.associations.set( texture, { textures: textureIndex } );\n\n\t\t\treturn texture;\n\n\t\t} ).catch( function () {\n\n\t\t\treturn null;\n\n\t\t} );\n\n\t\tthis.textureCache[ cacheKey ] = promise;\n\n\t\treturn promise;\n\n\t}\n\n\tloadImageSource( sourceIndex, loader ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst options = this.options;\n\n\t\tif ( this.sourceCache[ sourceIndex ] !== undefined ) {\n\n\t\t\treturn this.sourceCache[ sourceIndex ].then( function ( texture ) {\n\n\t\t\t\treturn texture.clone();\n\n\t\t\t} ).catch( function ( error ) {\n\n\t\t\t\tthrow error;\n\n\t\t\t} );\n\n\t\t}\n\n\t\tconst sourceDef = json.images[ sourceIndex ];\n\n\t\tconst URL = self.URL || self.webkitURL;\n\n\t\tlet sourceURI = sourceDef.uri || '';\n\t\tlet isObjectURL = false;\n\n\t\tif ( sourceDef.bufferView !== undefined ) {\n\n\t\t\t// Load binary image data from bufferView, if provided.\n\n\t\t\tsourceURI = parser.getDependency( 'bufferView', sourceDef.bufferView ).then( function ( bufferView ) {\n\n\t\t\t\tisObjectURL = true;\n\t\t\t\tconst blob = new Blob( [ bufferView ], { type: sourceDef.mimeType } );\n\t\t\t\tsourceURI = URL.createObjectURL( blob );\n\t\t\t\treturn sourceURI;\n\n\t\t\t} );\n\n\t\t} else if ( sourceDef.uri === undefined ) {\n\n\t\t\tthrow new Error( 'THREE.GLTFLoader: Image ' + sourceIndex + ' is missing URI and bufferView' );\n\n\t\t}\n\n\t\tconst promise = Promise.resolve( sourceURI ).then( function ( sourceURI ) {\n\n\t\t\treturn new Promise( function ( resolve, reject ) {\n\n\t\t\t\tlet onLoad = resolve;\n\n\t\t\t\tif ( loader.isImageBitmapLoader === true ) {\n\n\t\t\t\t\tonLoad = function ( imageBitmap ) {\n\n\t\t\t\t\t\tconst texture = new Texture( imageBitmap );\n\t\t\t\t\t\ttexture.needsUpdate = true;\n\n\t\t\t\t\t\tresolve( texture );\n\n\t\t\t\t\t};\n\n\t\t\t\t}\n\n\t\t\t\tloader.load( LoaderUtils.resolveURL( sourceURI, options.path ), onLoad, undefined, reject );\n\n\t\t\t} );\n\n\t\t} ).then( function ( texture ) {\n\n\t\t\t// Clean up resources and configure Texture.\n\n\t\t\tif ( isObjectURL === true ) {\n\n\t\t\t\tURL.revokeObjectURL( sourceURI );\n\n\t\t\t}\n\n\t\t\ttexture.userData.mimeType = sourceDef.mimeType || getImageURIMimeType( sourceDef.uri );\n\n\t\t\treturn texture;\n\n\t\t} ).catch( function ( error ) {\n\n\t\t\tconsole.error( 'THREE.GLTFLoader: Couldn\\'t load texture', sourceURI );\n\t\t\tthrow error;\n\n\t\t} );\n\n\t\tthis.sourceCache[ sourceIndex ] = promise;\n\t\treturn promise;\n\n\t}\n\n\t/**\n\t * Asynchronously assigns a texture to the given material parameters.\n\t * @param {Object} materialParams\n\t * @param {string} mapName\n\t * @param {Object} mapDef\n\t * @return {Promise<Texture>}\n\t */\n\tassignTexture( materialParams, mapName, mapDef ) {\n\n\t\tconst parser = this;\n\n\t\treturn this.getDependency( 'texture', mapDef.index ).then( function ( texture ) {\n\n\t\t\t// Materials sample aoMap from UV set 1 and other maps from UV set 0 - this can't be configured\n\t\t\t// However, we will copy UV set 0 to UV set 1 on demand for aoMap\n\t\t\tif ( mapDef.texCoord !== undefined && mapDef.texCoord != 0 && ! ( mapName === 'aoMap' && mapDef.texCoord == 1 ) ) {\n\n\t\t\t\tconsole.warn( 'THREE.GLTFLoader: Custom UV set ' + mapDef.texCoord + ' for texture ' + mapName + ' not yet supported.' );\n\n\t\t\t}\n\n\t\t\tif ( parser.extensions[ EXTENSIONS.KHR_TEXTURE_TRANSFORM ] ) {\n\n\t\t\t\tconst transform = mapDef.extensions !== undefined ? mapDef.extensions[ EXTENSIONS.KHR_TEXTURE_TRANSFORM ] : undefined;\n\n\t\t\t\tif ( transform ) {\n\n\t\t\t\t\tconst gltfReference = parser.associations.get( texture );\n\t\t\t\t\ttexture = parser.extensions[ EXTENSIONS.KHR_TEXTURE_TRANSFORM ].extendTexture( texture, transform );\n\t\t\t\t\tparser.associations.set( texture, gltfReference );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tmaterialParams[ mapName ] = texture;\n\n\t\t\treturn texture;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Assigns final material to a Mesh, Line, or Points instance. The instance\n\t * already has a material (generated from the glTF material options alone)\n\t * but reuse of the same glTF material may require multiple threejs materials\n\t * to accommodate different primitive types, defines, etc. New materials will\n\t * be created if necessary, and reused from a cache.\n\t * @param  {Object3D} mesh Mesh, Line, or Points instance.\n\t */\n\tassignFinalMaterial( mesh ) {\n\n\t\tconst geometry = mesh.geometry;\n\t\tlet material = mesh.material;\n\n\t\tconst useDerivativeTangents = geometry.attributes.tangent === undefined;\n\t\tconst useVertexColors = geometry.attributes.color !== undefined;\n\t\tconst useFlatShading = geometry.attributes.normal === undefined;\n\n\t\tif ( mesh.isPoints ) {\n\n\t\t\tconst cacheKey = 'PointsMaterial:' + material.uuid;\n\n\t\t\tlet pointsMaterial = this.cache.get( cacheKey );\n\n\t\t\tif ( ! pointsMaterial ) {\n\n\t\t\t\tpointsMaterial = new PointsMaterial();\n\t\t\t\tMaterial.prototype.copy.call( pointsMaterial, material );\n\t\t\t\tpointsMaterial.color.copy( material.color );\n\t\t\t\tpointsMaterial.map = material.map;\n\t\t\t\tpointsMaterial.sizeAttenuation = false; // glTF spec says points should be 1px\n\n\t\t\t\tthis.cache.add( cacheKey, pointsMaterial );\n\n\t\t\t}\n\n\t\t\tmaterial = pointsMaterial;\n\n\t\t} else if ( mesh.isLine ) {\n\n\t\t\tconst cacheKey = 'LineBasicMaterial:' + material.uuid;\n\n\t\t\tlet lineMaterial = this.cache.get( cacheKey );\n\n\t\t\tif ( ! lineMaterial ) {\n\n\t\t\t\tlineMaterial = new LineBasicMaterial();\n\t\t\t\tMaterial.prototype.copy.call( lineMaterial, material );\n\t\t\t\tlineMaterial.color.copy( material.color );\n\n\t\t\t\tthis.cache.add( cacheKey, lineMaterial );\n\n\t\t\t}\n\n\t\t\tmaterial = lineMaterial;\n\n\t\t}\n\n\t\t// Clone the material if it will be modified\n\t\tif ( useDerivativeTangents || useVertexColors || useFlatShading ) {\n\n\t\t\tlet cacheKey = 'ClonedMaterial:' + material.uuid + ':';\n\n\t\t\tif ( material.isGLTFSpecularGlossinessMaterial ) cacheKey += 'specular-glossiness:';\n\t\t\tif ( useDerivativeTangents ) cacheKey += 'derivative-tangents:';\n\t\t\tif ( useVertexColors ) cacheKey += 'vertex-colors:';\n\t\t\tif ( useFlatShading ) cacheKey += 'flat-shading:';\n\n\t\t\tlet cachedMaterial = this.cache.get( cacheKey );\n\n\t\t\tif ( ! cachedMaterial ) {\n\n\t\t\t\tcachedMaterial = material.clone();\n\n\t\t\t\tif ( useVertexColors ) cachedMaterial.vertexColors = true;\n\t\t\t\tif ( useFlatShading ) cachedMaterial.flatShading = true;\n\n\t\t\t\tif ( useDerivativeTangents ) {\n\n\t\t\t\t\t// https://github.com/mrdoob/three.js/issues/11438#issuecomment-507003995\n\t\t\t\t\tif ( cachedMaterial.normalScale ) cachedMaterial.normalScale.y *= - 1;\n\t\t\t\t\tif ( cachedMaterial.clearcoatNormalScale ) cachedMaterial.clearcoatNormalScale.y *= - 1;\n\n\t\t\t\t}\n\n\t\t\t\tthis.cache.add( cacheKey, cachedMaterial );\n\n\t\t\t\tthis.associations.set( cachedMaterial, this.associations.get( material ) );\n\n\t\t\t}\n\n\t\t\tmaterial = cachedMaterial;\n\n\t\t}\n\n\t\t// workarounds for mesh and geometry\n\n\t\tif ( material.aoMap && geometry.attributes.uv2 === undefined && geometry.attributes.uv !== undefined ) {\n\n\t\t\tgeometry.setAttribute( 'uv2', geometry.attributes.uv );\n\n\t\t}\n\n\t\tmesh.material = material;\n\n\t}\n\n\tgetMaterialType( /* materialIndex */ ) {\n\n\t\treturn MeshStandardMaterial;\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#materials\n\t * @param {number} materialIndex\n\t * @return {Promise<Material>}\n\t */\n\tloadMaterial( materialIndex ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\t\tconst materialDef = json.materials[ materialIndex ];\n\n\t\tlet materialType;\n\t\tconst materialParams = {};\n\t\tconst materialExtensions = materialDef.extensions || {};\n\n\t\tconst pending = [];\n\n\t\tif ( materialExtensions[ EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS ] ) {\n\n\t\t\tconst sgExtension = extensions[ EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS ];\n\t\t\tmaterialType = sgExtension.getMaterialType();\n\t\t\tpending.push( sgExtension.extendParams( materialParams, materialDef, parser ) );\n\n\t\t} else if ( materialExtensions[ EXTENSIONS.KHR_MATERIALS_UNLIT ] ) {\n\n\t\t\tconst kmuExtension = extensions[ EXTENSIONS.KHR_MATERIALS_UNLIT ];\n\t\t\tmaterialType = kmuExtension.getMaterialType();\n\t\t\tpending.push( kmuExtension.extendParams( materialParams, materialDef, parser ) );\n\n\t\t} else {\n\n\t\t\t// Specification:\n\t\t\t// https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#metallic-roughness-material\n\n\t\t\tconst metallicRoughness = materialDef.pbrMetallicRoughness || {};\n\n\t\t\tmaterialParams.color = new Color( 1.0, 1.0, 1.0 );\n\t\t\tmaterialParams.opacity = 1.0;\n\n\t\t\tif ( Array.isArray( metallicRoughness.baseColorFactor ) ) {\n\n\t\t\t\tconst array = metallicRoughness.baseColorFactor;\n\n\t\t\t\tmaterialParams.color.fromArray( array );\n\t\t\t\tmaterialParams.opacity = array[ 3 ];\n\n\t\t\t}\n\n\t\t\tif ( metallicRoughness.baseColorTexture !== undefined ) {\n\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'map', metallicRoughness.baseColorTexture ) );\n\n\t\t\t}\n\n\t\t\tmaterialParams.metalness = metallicRoughness.metallicFactor !== undefined ? metallicRoughness.metallicFactor : 1.0;\n\t\t\tmaterialParams.roughness = metallicRoughness.roughnessFactor !== undefined ? metallicRoughness.roughnessFactor : 1.0;\n\n\t\t\tif ( metallicRoughness.metallicRoughnessTexture !== undefined ) {\n\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'metalnessMap', metallicRoughness.metallicRoughnessTexture ) );\n\t\t\t\tpending.push( parser.assignTexture( materialParams, 'roughnessMap', metallicRoughness.metallicRoughnessTexture ) );\n\n\t\t\t}\n\n\t\t\tmaterialType = this._invokeOne( function ( ext ) {\n\n\t\t\t\treturn ext.getMaterialType && ext.getMaterialType( materialIndex );\n\n\t\t\t} );\n\n\t\t\tpending.push( Promise.all( this._invokeAll( function ( ext ) {\n\n\t\t\t\treturn ext.extendMaterialParams && ext.extendMaterialParams( materialIndex, materialParams );\n\n\t\t\t} ) ) );\n\n\t\t}\n\n\t\tif ( materialDef.doubleSided === true ) {\n\n\t\t\tmaterialParams.side = DoubleSide;\n\n\t\t}\n\n\t\tconst alphaMode = materialDef.alphaMode || ALPHA_MODES.OPAQUE;\n\n\t\tif ( alphaMode === ALPHA_MODES.BLEND ) {\n\n\t\t\tmaterialParams.transparent = true;\n\n\t\t\t// See: https://github.com/mrdoob/three.js/issues/17706\n\t\t\tmaterialParams.depthWrite = false;\n\n\t\t} else {\n\n\t\t\tmaterialParams.transparent = false;\n\n\t\t\tif ( alphaMode === ALPHA_MODES.MASK ) {\n\n\t\t\t\tmaterialParams.alphaTest = materialDef.alphaCutoff !== undefined ? materialDef.alphaCutoff : 0.5;\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( materialDef.normalTexture !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'normalMap', materialDef.normalTexture ) );\n\n\t\t\tmaterialParams.normalScale = new Vector2( 1, 1 );\n\n\t\t\tif ( materialDef.normalTexture.scale !== undefined ) {\n\n\t\t\t\tconst scale = materialDef.normalTexture.scale;\n\n\t\t\t\tmaterialParams.normalScale.set( scale, scale );\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( materialDef.occlusionTexture !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'aoMap', materialDef.occlusionTexture ) );\n\n\t\t\tif ( materialDef.occlusionTexture.strength !== undefined ) {\n\n\t\t\t\tmaterialParams.aoMapIntensity = materialDef.occlusionTexture.strength;\n\n\t\t\t}\n\n\t\t}\n\n\t\tif ( materialDef.emissiveFactor !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tmaterialParams.emissive = new Color().fromArray( materialDef.emissiveFactor );\n\n\t\t}\n\n\t\tif ( materialDef.emissiveTexture !== undefined && materialType !== MeshBasicMaterial ) {\n\n\t\t\tpending.push( parser.assignTexture( materialParams, 'emissiveMap', materialDef.emissiveTexture ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending ).then( function () {\n\n\t\t\tlet material;\n\n\t\t\tif ( materialType === GLTFMeshStandardSGMaterial ) {\n\n\t\t\t\tmaterial = extensions[ EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS ].createMaterial( materialParams );\n\n\t\t\t} else {\n\n\t\t\t\tmaterial = new materialType( materialParams );\n\n\t\t\t}\n\n\t\t\tif ( materialDef.name ) material.name = materialDef.name;\n\n\t\t\t// baseColorTexture, emissiveTexture, sheenColorMap, specularColorMap and specularGlossinessTexture use sRGB encoding.\n\t\t\tif ( material.map ) material.map.encoding = sRGBEncoding;\n\t\t\tif ( material.emissiveMap ) material.emissiveMap.encoding = sRGBEncoding;\n\t\t\tif ( material.sheenColorMap ) material.sheenColorMap.encoding = sRGBEncoding;\n\t\t\tif ( material.specularColorMap ) material.specularColorMap.encoding = sRGBEncoding;\n\t\t\tif ( material.specularMap ) material.specularMap.encoding = sRGBEncoding;\n\n\t\t\tassignExtrasToUserData( material, materialDef );\n\n\t\t\tparser.associations.set( material, { materials: materialIndex } );\n\n\t\t\tif ( materialDef.extensions ) addUnknownExtensionsToUserData( extensions, material, materialDef );\n\n\t\t\treturn material;\n\n\t\t} );\n\n\t}\n\n\t/** When Object3D instances are targeted by animation, they need unique names. */\n\tcreateUniqueName( originalName ) {\n\n\t\tconst sanitizedName = PropertyBinding.sanitizeNodeName( originalName || '' );\n\n\t\tlet name = sanitizedName;\n\n\t\tfor ( let i = 1; this.nodeNamesUsed[ name ]; ++ i ) {\n\n\t\t\tname = sanitizedName + '_' + i;\n\n\t\t}\n\n\t\tthis.nodeNamesUsed[ name ] = true;\n\n\t\treturn name;\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#geometry\n\t *\n\t * Creates BufferGeometries from primitives.\n\t *\n\t * @param {Array<GLTF.Primitive>} primitives\n\t * @return {Promise<Array<BufferGeometry>>}\n\t */\n\tloadGeometries( primitives ) {\n\n\t\tconst parser = this;\n\t\tconst extensions = this.extensions;\n\t\tconst cache = this.primitiveCache;\n\n\t\tfunction createDracoPrimitive( primitive ) {\n\n\t\t\treturn extensions[ EXTENSIONS.KHR_DRACO_MESH_COMPRESSION ]\n\t\t\t\t.decodePrimitive( primitive, parser )\n\t\t\t\t.then( function ( geometry ) {\n\n\t\t\t\t\treturn addPrimitiveAttributes( geometry, primitive, parser );\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0, il = primitives.length; i < il; i ++ ) {\n\n\t\t\tconst primitive = primitives[ i ];\n\t\t\tconst cacheKey = createPrimitiveKey( primitive );\n\n\t\t\t// See if we've already created this geometry\n\t\t\tconst cached = cache[ cacheKey ];\n\n\t\t\tif ( cached ) {\n\n\t\t\t\t// Use the cached geometry if it exists\n\t\t\t\tpending.push( cached.promise );\n\n\t\t\t} else {\n\n\t\t\t\tlet geometryPromise;\n\n\t\t\t\tif ( primitive.extensions && primitive.extensions[ EXTENSIONS.KHR_DRACO_MESH_COMPRESSION ] ) {\n\n\t\t\t\t\t// Use DRACO geometry if available\n\t\t\t\t\tgeometryPromise = createDracoPrimitive( primitive );\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// Otherwise create a new geometry\n\t\t\t\t\tgeometryPromise = addPrimitiveAttributes( new BufferGeometry(), primitive, parser );\n\n\t\t\t\t}\n\n\t\t\t\t// Cache this geometry\n\t\t\t\tcache[ cacheKey ] = { primitive: primitive, promise: geometryPromise };\n\n\t\t\t\tpending.push( geometryPromise );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/blob/master/specification/2.0/README.md#meshes\n\t * @param {number} meshIndex\n\t * @return {Promise<Group|Mesh|SkinnedMesh>}\n\t */\n\tloadMesh( meshIndex ) {\n\n\t\tconst parser = this;\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\n\t\tconst meshDef = json.meshes[ meshIndex ];\n\t\tconst primitives = meshDef.primitives;\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0, il = primitives.length; i < il; i ++ ) {\n\n\t\t\tconst material = primitives[ i ].material === undefined\n\t\t\t\t? createDefaultMaterial( this.cache )\n\t\t\t\t: this.getDependency( 'material', primitives[ i ].material );\n\n\t\t\tpending.push( material );\n\n\t\t}\n\n\t\tpending.push( parser.loadGeometries( primitives ) );\n\n\t\treturn Promise.all( pending ).then( function ( results ) {\n\n\t\t\tconst materials = results.slice( 0, results.length - 1 );\n\t\t\tconst geometries = results[ results.length - 1 ];\n\n\t\t\tconst meshes = [];\n\n\t\t\tfor ( let i = 0, il = geometries.length; i < il; i ++ ) {\n\n\t\t\t\tconst geometry = geometries[ i ];\n\t\t\t\tconst primitive = primitives[ i ];\n\n\t\t\t\t// 1. create Mesh\n\n\t\t\t\tlet mesh;\n\n\t\t\t\tconst material = materials[ i ];\n\n\t\t\t\tif ( primitive.mode === WEBGL_CONSTANTS.TRIANGLES ||\n\t\t\t\t\t\tprimitive.mode === WEBGL_CONSTANTS.TRIANGLE_STRIP ||\n\t\t\t\t\t\tprimitive.mode === WEBGL_CONSTANTS.TRIANGLE_FAN ||\n\t\t\t\t\t\tprimitive.mode === undefined ) {\n\n\t\t\t\t\t// .isSkinnedMesh isn't in glTF spec. See ._markDefs()\n\t\t\t\t\tmesh = meshDef.isSkinnedMesh === true\n\t\t\t\t\t\t? new SkinnedMesh( geometry, material )\n\t\t\t\t\t\t: new Mesh( geometry, material );\n\n\t\t\t\t\tif ( mesh.isSkinnedMesh === true && ! mesh.geometry.attributes.skinWeight.normalized ) {\n\n\t\t\t\t\t\t// we normalize floating point skin weight array to fix malformed assets (see #15319)\n\t\t\t\t\t\t// it's important to skip this for non-float32 data since normalizeSkinWeights assumes non-normalized inputs\n\t\t\t\t\t\tmesh.normalizeSkinWeights();\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( primitive.mode === WEBGL_CONSTANTS.TRIANGLE_STRIP ) {\n\n\t\t\t\t\t\tmesh.geometry = toTrianglesDrawMode( mesh.geometry, TriangleStripDrawMode );\n\n\t\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.TRIANGLE_FAN ) {\n\n\t\t\t\t\t\tmesh.geometry = toTrianglesDrawMode( mesh.geometry, TriangleFanDrawMode );\n\n\t\t\t\t\t}\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.LINES ) {\n\n\t\t\t\t\tmesh = new LineSegments( geometry, material );\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.LINE_STRIP ) {\n\n\t\t\t\t\tmesh = new Line( geometry, material );\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.LINE_LOOP ) {\n\n\t\t\t\t\tmesh = new LineLoop( geometry, material );\n\n\t\t\t\t} else if ( primitive.mode === WEBGL_CONSTANTS.POINTS ) {\n\n\t\t\t\t\tmesh = new Points( geometry, material );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tthrow new Error( 'THREE.GLTFLoader: Primitive mode unsupported: ' + primitive.mode );\n\n\t\t\t\t}\n\n\t\t\t\tif ( Object.keys( mesh.geometry.morphAttributes ).length > 0 ) {\n\n\t\t\t\t\tupdateMorphTargets( mesh, meshDef );\n\n\t\t\t\t}\n\n\t\t\t\tmesh.name = parser.createUniqueName( meshDef.name || ( 'mesh_' + meshIndex ) );\n\n\t\t\t\tassignExtrasToUserData( mesh, meshDef );\n\n\t\t\t\tif ( primitive.extensions ) addUnknownExtensionsToUserData( extensions, mesh, primitive );\n\n\t\t\t\tparser.assignFinalMaterial( mesh );\n\n\t\t\t\tmeshes.push( mesh );\n\n\t\t\t}\n\n\t\t\tfor ( let i = 0, il = meshes.length; i < il; i ++ ) {\n\n\t\t\t\tparser.associations.set( meshes[ i ], {\n\t\t\t\t\tmeshes: meshIndex,\n\t\t\t\t\tprimitives: i\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\tif ( meshes.length === 1 ) {\n\n\t\t\t\treturn meshes[ 0 ];\n\n\t\t\t}\n\n\t\t\tconst group = new Group();\n\n\t\t\tparser.associations.set( group, { meshes: meshIndex } );\n\n\t\t\tfor ( let i = 0, il = meshes.length; i < il; i ++ ) {\n\n\t\t\t\tgroup.add( meshes[ i ] );\n\n\t\t\t}\n\n\t\t\treturn group;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#cameras\n\t * @param {number} cameraIndex\n\t * @return {Promise<THREE.Camera>}\n\t */\n\tloadCamera( cameraIndex ) {\n\n\t\tlet camera;\n\t\tconst cameraDef = this.json.cameras[ cameraIndex ];\n\t\tconst params = cameraDef[ cameraDef.type ];\n\n\t\tif ( ! params ) {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Missing camera parameters.' );\n\t\t\treturn;\n\n\t\t}\n\n\t\tif ( cameraDef.type === 'perspective' ) {\n\n\t\t\tcamera = new PerspectiveCamera( MathUtils.radToDeg( params.yfov ), params.aspectRatio || 1, params.znear || 1, params.zfar || 2e6 );\n\n\t\t} else if ( cameraDef.type === 'orthographic' ) {\n\n\t\t\tcamera = new OrthographicCamera( - params.xmag, params.xmag, params.ymag, - params.ymag, params.znear, params.zfar );\n\n\t\t}\n\n\t\tif ( cameraDef.name ) camera.name = this.createUniqueName( cameraDef.name );\n\n\t\tassignExtrasToUserData( camera, cameraDef );\n\n\t\treturn Promise.resolve( camera );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#skins\n\t * @param {number} skinIndex\n\t * @return {Promise<Object>}\n\t */\n\tloadSkin( skinIndex ) {\n\n\t\tconst skinDef = this.json.skins[ skinIndex ];\n\n\t\tconst skinEntry = { joints: skinDef.joints };\n\n\t\tif ( skinDef.inverseBindMatrices === undefined ) {\n\n\t\t\treturn Promise.resolve( skinEntry );\n\n\t\t}\n\n\t\treturn this.getDependency( 'accessor', skinDef.inverseBindMatrices ).then( function ( accessor ) {\n\n\t\t\tskinEntry.inverseBindMatrices = accessor;\n\n\t\t\treturn skinEntry;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#animations\n\t * @param {number} animationIndex\n\t * @return {Promise<AnimationClip>}\n\t */\n\tloadAnimation( animationIndex ) {\n\n\t\tconst json = this.json;\n\n\t\tconst animationDef = json.animations[ animationIndex ];\n\n\t\tconst pendingNodes = [];\n\t\tconst pendingInputAccessors = [];\n\t\tconst pendingOutputAccessors = [];\n\t\tconst pendingSamplers = [];\n\t\tconst pendingTargets = [];\n\n\t\tfor ( let i = 0, il = animationDef.channels.length; i < il; i ++ ) {\n\n\t\t\tconst channel = animationDef.channels[ i ];\n\t\t\tconst sampler = animationDef.samplers[ channel.sampler ];\n\t\t\tconst target = channel.target;\n\t\t\tconst name = target.node !== undefined ? target.node : target.id; // NOTE: target.id is deprecated.\n\t\t\tconst input = animationDef.parameters !== undefined ? animationDef.parameters[ sampler.input ] : sampler.input;\n\t\t\tconst output = animationDef.parameters !== undefined ? animationDef.parameters[ sampler.output ] : sampler.output;\n\n\t\t\tpendingNodes.push( this.getDependency( 'node', name ) );\n\t\t\tpendingInputAccessors.push( this.getDependency( 'accessor', input ) );\n\t\t\tpendingOutputAccessors.push( this.getDependency( 'accessor', output ) );\n\t\t\tpendingSamplers.push( sampler );\n\t\t\tpendingTargets.push( target );\n\n\t\t}\n\n\t\treturn Promise.all( [\n\n\t\t\tPromise.all( pendingNodes ),\n\t\t\tPromise.all( pendingInputAccessors ),\n\t\t\tPromise.all( pendingOutputAccessors ),\n\t\t\tPromise.all( pendingSamplers ),\n\t\t\tPromise.all( pendingTargets )\n\n\t\t] ).then( function ( dependencies ) {\n\n\t\t\tconst nodes = dependencies[ 0 ];\n\t\t\tconst inputAccessors = dependencies[ 1 ];\n\t\t\tconst outputAccessors = dependencies[ 2 ];\n\t\t\tconst samplers = dependencies[ 3 ];\n\t\t\tconst targets = dependencies[ 4 ];\n\n\t\t\tconst tracks = [];\n\n\t\t\tfor ( let i = 0, il = nodes.length; i < il; i ++ ) {\n\n\t\t\t\tconst node = nodes[ i ];\n\t\t\t\tconst inputAccessor = inputAccessors[ i ];\n\t\t\t\tconst outputAccessor = outputAccessors[ i ];\n\t\t\t\tconst sampler = samplers[ i ];\n\t\t\t\tconst target = targets[ i ];\n\n\t\t\t\tif ( node === undefined ) continue;\n\n\t\t\t\tnode.updateMatrix();\n\t\t\t\tnode.matrixAutoUpdate = true;\n\n\t\t\t\tlet TypedKeyframeTrack;\n\n\t\t\t\tswitch ( PATH_PROPERTIES[ target.path ] ) {\n\n\t\t\t\t\tcase PATH_PROPERTIES.weights:\n\n\t\t\t\t\t\tTypedKeyframeTrack = NumberKeyframeTrack;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase PATH_PROPERTIES.rotation:\n\n\t\t\t\t\t\tTypedKeyframeTrack = QuaternionKeyframeTrack;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase PATH_PROPERTIES.position:\n\t\t\t\t\tcase PATH_PROPERTIES.scale:\n\t\t\t\t\tdefault:\n\n\t\t\t\t\t\tTypedKeyframeTrack = VectorKeyframeTrack;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t\tconst targetName = node.name ? node.name : node.uuid;\n\n\t\t\t\tconst interpolation = sampler.interpolation !== undefined ? INTERPOLATION[ sampler.interpolation ] : InterpolateLinear;\n\n\t\t\t\tconst targetNames = [];\n\n\t\t\t\tif ( PATH_PROPERTIES[ target.path ] === PATH_PROPERTIES.weights ) {\n\n\t\t\t\t\tnode.traverse( function ( object ) {\n\n\t\t\t\t\t\tif ( object.morphTargetInfluences ) {\n\n\t\t\t\t\t\t\ttargetNames.push( object.name ? object.name : object.uuid );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t} );\n\n\t\t\t\t} else {\n\n\t\t\t\t\ttargetNames.push( targetName );\n\n\t\t\t\t}\n\n\t\t\t\tlet outputArray = outputAccessor.array;\n\n\t\t\t\tif ( outputAccessor.normalized ) {\n\n\t\t\t\t\tconst scale = getNormalizedComponentScale( outputArray.constructor );\n\t\t\t\t\tconst scaled = new Float32Array( outputArray.length );\n\n\t\t\t\t\tfor ( let j = 0, jl = outputArray.length; j < jl; j ++ ) {\n\n\t\t\t\t\t\tscaled[ j ] = outputArray[ j ] * scale;\n\n\t\t\t\t\t}\n\n\t\t\t\t\toutputArray = scaled;\n\n\t\t\t\t}\n\n\t\t\t\tfor ( let j = 0, jl = targetNames.length; j < jl; j ++ ) {\n\n\t\t\t\t\tconst track = new TypedKeyframeTrack(\n\t\t\t\t\t\ttargetNames[ j ] + '.' + PATH_PROPERTIES[ target.path ],\n\t\t\t\t\t\tinputAccessor.array,\n\t\t\t\t\t\toutputArray,\n\t\t\t\t\t\tinterpolation\n\t\t\t\t\t);\n\n\t\t\t\t\t// Override interpolation with custom factory method.\n\t\t\t\t\tif ( sampler.interpolation === 'CUBICSPLINE' ) {\n\n\t\t\t\t\t\ttrack.createInterpolant = function InterpolantFactoryMethodGLTFCubicSpline( result ) {\n\n\t\t\t\t\t\t\t// A CUBICSPLINE keyframe in glTF has three output values for each input value,\n\t\t\t\t\t\t\t// representing inTangent, splineVertex, and outTangent. As a result, track.getValueSize()\n\t\t\t\t\t\t\t// must be divided by three to get the interpolant's sampleSize argument.\n\n\t\t\t\t\t\t\tconst interpolantType = ( this instanceof QuaternionKeyframeTrack ) ? GLTFCubicSplineQuaternionInterpolant : GLTFCubicSplineInterpolant;\n\n\t\t\t\t\t\t\treturn new interpolantType( this.times, this.values, this.getValueSize() / 3, result );\n\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// Mark as CUBICSPLINE. `track.getInterpolation()` doesn't support custom interpolants.\n\t\t\t\t\t\ttrack.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline = true;\n\n\t\t\t\t\t}\n\n\t\t\t\t\ttracks.push( track );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tconst name = animationDef.name ? animationDef.name : 'animation_' + animationIndex;\n\n\t\t\treturn new AnimationClip( name, undefined, tracks );\n\n\t\t} );\n\n\t}\n\n\tcreateNodeMesh( nodeIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst parser = this;\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\n\t\tif ( nodeDef.mesh === undefined ) return null;\n\n\t\treturn parser.getDependency( 'mesh', nodeDef.mesh ).then( function ( mesh ) {\n\n\t\t\tconst node = parser._getNodeRef( parser.meshCache, nodeDef.mesh, mesh );\n\n\t\t\t// if weights are provided on the node, override weights on the mesh.\n\t\t\tif ( nodeDef.weights !== undefined ) {\n\n\t\t\t\tnode.traverse( function ( o ) {\n\n\t\t\t\t\tif ( ! o.isMesh ) return;\n\n\t\t\t\t\tfor ( let i = 0, il = nodeDef.weights.length; i < il; i ++ ) {\n\n\t\t\t\t\t\to.morphTargetInfluences[ i ] = nodeDef.weights[ i ];\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\treturn node;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#nodes-and-hierarchy\n\t * @param {number} nodeIndex\n\t * @return {Promise<Object3D>}\n\t */\n\tloadNode( nodeIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\t\tconst parser = this;\n\n\t\tconst nodeDef = json.nodes[ nodeIndex ];\n\n\t\t// reserve node's name before its dependencies, so the root has the intended name.\n\t\tconst nodeName = nodeDef.name ? parser.createUniqueName( nodeDef.name ) : '';\n\n\t\treturn ( function () {\n\n\t\t\tconst pending = [];\n\n\t\t\tconst meshPromise = parser._invokeOne( function ( ext ) {\n\n\t\t\t\treturn ext.createNodeMesh && ext.createNodeMesh( nodeIndex );\n\n\t\t\t} );\n\n\t\t\tif ( meshPromise ) {\n\n\t\t\t\tpending.push( meshPromise );\n\n\t\t\t}\n\n\t\t\tif ( nodeDef.camera !== undefined ) {\n\n\t\t\t\tpending.push( parser.getDependency( 'camera', nodeDef.camera ).then( function ( camera ) {\n\n\t\t\t\t\treturn parser._getNodeRef( parser.cameraCache, nodeDef.camera, camera );\n\n\t\t\t\t} ) );\n\n\t\t\t}\n\n\t\t\tparser._invokeAll( function ( ext ) {\n\n\t\t\t\treturn ext.createNodeAttachment && ext.createNodeAttachment( nodeIndex );\n\n\t\t\t} ).forEach( function ( promise ) {\n\n\t\t\t\tpending.push( promise );\n\n\t\t\t} );\n\n\t\t\treturn Promise.all( pending );\n\n\t\t}() ).then( function ( objects ) {\n\n\t\t\tlet node;\n\n\t\t\t// .isBone isn't in glTF spec. See ._markDefs\n\t\t\tif ( nodeDef.isBone === true ) {\n\n\t\t\t\tnode = new Bone();\n\n\t\t\t} else if ( objects.length > 1 ) {\n\n\t\t\t\tnode = new Group();\n\n\t\t\t} else if ( objects.length === 1 ) {\n\n\t\t\t\tnode = objects[ 0 ];\n\n\t\t\t} else {\n\n\t\t\t\tnode = new Object3D();\n\n\t\t\t}\n\n\t\t\tif ( node !== objects[ 0 ] ) {\n\n\t\t\t\tfor ( let i = 0, il = objects.length; i < il; i ++ ) {\n\n\t\t\t\t\tnode.add( objects[ i ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( nodeDef.name ) {\n\n\t\t\t\tnode.userData.name = nodeDef.name;\n\t\t\t\tnode.name = nodeName;\n\n\t\t\t}\n\n\t\t\tassignExtrasToUserData( node, nodeDef );\n\n\t\t\tif ( nodeDef.extensions ) addUnknownExtensionsToUserData( extensions, node, nodeDef );\n\n\t\t\tif ( nodeDef.matrix !== undefined ) {\n\n\t\t\t\tconst matrix = new Matrix4();\n\t\t\t\tmatrix.fromArray( nodeDef.matrix );\n\t\t\t\tnode.applyMatrix4( matrix );\n\n\t\t\t} else {\n\n\t\t\t\tif ( nodeDef.translation !== undefined ) {\n\n\t\t\t\t\tnode.position.fromArray( nodeDef.translation );\n\n\t\t\t\t}\n\n\t\t\t\tif ( nodeDef.rotation !== undefined ) {\n\n\t\t\t\t\tnode.quaternion.fromArray( nodeDef.rotation );\n\n\t\t\t\t}\n\n\t\t\t\tif ( nodeDef.scale !== undefined ) {\n\n\t\t\t\t\tnode.scale.fromArray( nodeDef.scale );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tif ( ! parser.associations.has( node ) ) {\n\n\t\t\t\tparser.associations.set( node, {} );\n\n\t\t\t}\n\n\t\t\tparser.associations.get( node ).nodes = nodeIndex;\n\n\t\t\treturn node;\n\n\t\t} );\n\n\t}\n\n\t/**\n\t * Specification: https://github.com/KhronosGroup/glTF/tree/master/specification/2.0#scenes\n\t * @param {number} sceneIndex\n\t * @return {Promise<Group>}\n\t */\n\tloadScene( sceneIndex ) {\n\n\t\tconst json = this.json;\n\t\tconst extensions = this.extensions;\n\t\tconst sceneDef = this.json.scenes[ sceneIndex ];\n\t\tconst parser = this;\n\n\t\t// Loader returns Group, not Scene.\n\t\t// See: https://github.com/mrdoob/three.js/issues/18342#issuecomment-578981172\n\t\tconst scene = new Group();\n\t\tif ( sceneDef.name ) scene.name = parser.createUniqueName( sceneDef.name );\n\n\t\tassignExtrasToUserData( scene, sceneDef );\n\n\t\tif ( sceneDef.extensions ) addUnknownExtensionsToUserData( extensions, scene, sceneDef );\n\n\t\tconst nodeIds = sceneDef.nodes || [];\n\n\t\tconst pending = [];\n\n\t\tfor ( let i = 0, il = nodeIds.length; i < il; i ++ ) {\n\n\t\t\tpending.push( buildNodeHierarchy( nodeIds[ i ], scene, json, parser ) );\n\n\t\t}\n\n\t\treturn Promise.all( pending ).then( function () {\n\n\t\t\t// Removes dangling associations, associations that reference a node that\n\t\t\t// didn't make it into the scene.\n\t\t\tconst reduceAssociations = ( node ) => {\n\n\t\t\t\tconst reducedAssociations = new Map();\n\n\t\t\t\tfor ( const [ key, value ] of parser.associations ) {\n\n\t\t\t\t\tif ( key instanceof Material || key instanceof Texture ) {\n\n\t\t\t\t\t\treducedAssociations.set( key, value );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tnode.traverse( ( node ) => {\n\n\t\t\t\t\tconst mappings = parser.associations.get( node );\n\n\t\t\t\t\tif ( mappings != null ) {\n\n\t\t\t\t\t\treducedAssociations.set( node, mappings );\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\n\t\t\t\treturn reducedAssociations;\n\n\t\t\t};\n\n\t\t\tparser.associations = reduceAssociations( scene );\n\n\t\t\treturn scene;\n\n\t\t} );\n\n\t}\n\n}\n\nfunction buildNodeHierarchy( nodeId, parentObject, json, parser ) {\n\n\tconst nodeDef = json.nodes[ nodeId ];\n\n\treturn parser.getDependency( 'node', nodeId ).then( function ( node ) {\n\n\t\tif ( nodeDef.skin === undefined ) return node;\n\n\t\t// build skeleton here as well\n\n\t\tlet skinEntry;\n\n\t\treturn parser.getDependency( 'skin', nodeDef.skin ).then( function ( skin ) {\n\n\t\t\tskinEntry = skin;\n\n\t\t\tconst pendingJoints = [];\n\n\t\t\tfor ( let i = 0, il = skinEntry.joints.length; i < il; i ++ ) {\n\n\t\t\t\tpendingJoints.push( parser.getDependency( 'node', skinEntry.joints[ i ] ) );\n\n\t\t\t}\n\n\t\t\treturn Promise.all( pendingJoints );\n\n\t\t} ).then( function ( jointNodes ) {\n\n\t\t\tnode.traverse( function ( mesh ) {\n\n\t\t\t\tif ( ! mesh.isMesh ) return;\n\n\t\t\t\tconst bones = [];\n\t\t\t\tconst boneInverses = [];\n\n\t\t\t\tfor ( let j = 0, jl = jointNodes.length; j < jl; j ++ ) {\n\n\t\t\t\t\tconst jointNode = jointNodes[ j ];\n\n\t\t\t\t\tif ( jointNode ) {\n\n\t\t\t\t\t\tbones.push( jointNode );\n\n\t\t\t\t\t\tconst mat = new Matrix4();\n\n\t\t\t\t\t\tif ( skinEntry.inverseBindMatrices !== undefined ) {\n\n\t\t\t\t\t\t\tmat.fromArray( skinEntry.inverseBindMatrices.array, j * 16 );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tboneInverses.push( mat );\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tconsole.warn( 'THREE.GLTFLoader: Joint \"%s\" could not be found.', skinEntry.joints[ j ] );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tmesh.bind( new Skeleton( bones, boneInverses ), mesh.matrixWorld );\n\n\t\t\t} );\n\n\t\t\treturn node;\n\n\t\t} );\n\n\t} ).then( function ( node ) {\n\n\t\t// build node hierachy\n\n\t\tparentObject.add( node );\n\n\t\tconst pending = [];\n\n\t\tif ( nodeDef.children ) {\n\n\t\t\tconst children = nodeDef.children;\n\n\t\t\tfor ( let i = 0, il = children.length; i < il; i ++ ) {\n\n\t\t\t\tconst child = children[ i ];\n\t\t\t\tpending.push( buildNodeHierarchy( child, node, json, parser ) );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn Promise.all( pending );\n\n\t} );\n\n}\n\n/**\n * @param {BufferGeometry} geometry\n * @param {GLTF.Primitive} primitiveDef\n * @param {GLTFParser} parser\n */\nfunction computeBounds( geometry, primitiveDef, parser ) {\n\n\tconst attributes = primitiveDef.attributes;\n\n\tconst box = new Box3();\n\n\tif ( attributes.POSITION !== undefined ) {\n\n\t\tconst accessor = parser.json.accessors[ attributes.POSITION ];\n\n\t\tconst min = accessor.min;\n\t\tconst max = accessor.max;\n\n\t\t// glTF requires 'min' and 'max', but VRM (which extends glTF) currently ignores that requirement.\n\n\t\tif ( min !== undefined && max !== undefined ) {\n\n\t\t\tbox.set(\n\t\t\t\tnew Vector3( min[ 0 ], min[ 1 ], min[ 2 ] ),\n\t\t\t\tnew Vector3( max[ 0 ], max[ 1 ], max[ 2 ] )\n\t\t\t);\n\n\t\t\tif ( accessor.normalized ) {\n\n\t\t\t\tconst boxScale = getNormalizedComponentScale( WEBGL_COMPONENT_TYPES[ accessor.componentType ] );\n\t\t\t\tbox.min.multiplyScalar( boxScale );\n\t\t\t\tbox.max.multiplyScalar( boxScale );\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tconsole.warn( 'THREE.GLTFLoader: Missing min/max properties for accessor POSITION.' );\n\n\t\t\treturn;\n\n\t\t}\n\n\t} else {\n\n\t\treturn;\n\n\t}\n\n\tconst targets = primitiveDef.targets;\n\n\tif ( targets !== undefined ) {\n\n\t\tconst maxDisplacement = new Vector3();\n\t\tconst vector = new Vector3();\n\n\t\tfor ( let i = 0, il = targets.length; i < il; i ++ ) {\n\n\t\t\tconst target = targets[ i ];\n\n\t\t\tif ( target.POSITION !== undefined ) {\n\n\t\t\t\tconst accessor = parser.json.accessors[ target.POSITION ];\n\t\t\t\tconst min = accessor.min;\n\t\t\t\tconst max = accessor.max;\n\n\t\t\t\t// glTF requires 'min' and 'max', but VRM (which extends glTF) currently ignores that requirement.\n\n\t\t\t\tif ( min !== undefined && max !== undefined ) {\n\n\t\t\t\t\t// we need to get max of absolute components because target weight is [-1,1]\n\t\t\t\t\tvector.setX( Math.max( Math.abs( min[ 0 ] ), Math.abs( max[ 0 ] ) ) );\n\t\t\t\t\tvector.setY( Math.max( Math.abs( min[ 1 ] ), Math.abs( max[ 1 ] ) ) );\n\t\t\t\t\tvector.setZ( Math.max( Math.abs( min[ 2 ] ), Math.abs( max[ 2 ] ) ) );\n\n\n\t\t\t\t\tif ( accessor.normalized ) {\n\n\t\t\t\t\t\tconst boxScale = getNormalizedComponentScale( WEBGL_COMPONENT_TYPES[ accessor.componentType ] );\n\t\t\t\t\t\tvector.multiplyScalar( boxScale );\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// Note: this assumes that the sum of all weights is at most 1. This isn't quite correct - it's more conservative\n\t\t\t\t\t// to assume that each target can have a max weight of 1. However, for some use cases - notably, when morph targets\n\t\t\t\t\t// are used to implement key-frame animations and as such only two are active at a time - this results in very large\n\t\t\t\t\t// boxes. So for now we make a box that's sometimes a touch too small but is hopefully mostly of reasonable size.\n\t\t\t\t\tmaxDisplacement.max( vector );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.warn( 'THREE.GLTFLoader: Missing min/max properties for accessor POSITION.' );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\t// As per comment above this box isn't conservative, but has a reasonable size for a very large number of morph targets.\n\t\tbox.expandByVector( maxDisplacement );\n\n\t}\n\n\tgeometry.boundingBox = box;\n\n\tconst sphere = new Sphere();\n\n\tbox.getCenter( sphere.center );\n\tsphere.radius = box.min.distanceTo( box.max ) / 2;\n\n\tgeometry.boundingSphere = sphere;\n\n}\n\n/**\n * @param {BufferGeometry} geometry\n * @param {GLTF.Primitive} primitiveDef\n * @param {GLTFParser} parser\n * @return {Promise<BufferGeometry>}\n */\nfunction addPrimitiveAttributes( geometry, primitiveDef, parser ) {\n\n\tconst attributes = primitiveDef.attributes;\n\n\tconst pending = [];\n\n\tfunction assignAttributeAccessor( accessorIndex, attributeName ) {\n\n\t\treturn parser.getDependency( 'accessor', accessorIndex )\n\t\t\t.then( function ( accessor ) {\n\n\t\t\t\tgeometry.setAttribute( attributeName, accessor );\n\n\t\t\t} );\n\n\t}\n\n\tfor ( const gltfAttributeName in attributes ) {\n\n\t\tconst threeAttributeName = ATTRIBUTES[ gltfAttributeName ] || gltfAttributeName.toLowerCase();\n\n\t\t// Skip attributes already provided by e.g. Draco extension.\n\t\tif ( threeAttributeName in geometry.attributes ) continue;\n\n\t\tpending.push( assignAttributeAccessor( attributes[ gltfAttributeName ], threeAttributeName ) );\n\n\t}\n\n\tif ( primitiveDef.indices !== undefined && ! geometry.index ) {\n\n\t\tconst accessor = parser.getDependency( 'accessor', primitiveDef.indices ).then( function ( accessor ) {\n\n\t\t\tgeometry.setIndex( accessor );\n\n\t\t} );\n\n\t\tpending.push( accessor );\n\n\t}\n\n\tassignExtrasToUserData( geometry, primitiveDef );\n\n\tcomputeBounds( geometry, primitiveDef, parser );\n\n\treturn Promise.all( pending ).then( function () {\n\n\t\treturn primitiveDef.targets !== undefined\n\t\t\t? addMorphTargets( geometry, primitiveDef.targets, parser )\n\t\t\t: geometry;\n\n\t} );\n\n}\n\n/**\n * @param {BufferGeometry} geometry\n * @param {Number} drawMode\n * @return {BufferGeometry}\n */\nfunction toTrianglesDrawMode( geometry, drawMode ) {\n\n\tlet index = geometry.getIndex();\n\n\t// generate index if not present\n\n\tif ( index === null ) {\n\n\t\tconst indices = [];\n\n\t\tconst position = geometry.getAttribute( 'position' );\n\n\t\tif ( position !== undefined ) {\n\n\t\t\tfor ( let i = 0; i < position.count; i ++ ) {\n\n\t\t\t\tindices.push( i );\n\n\t\t\t}\n\n\t\t\tgeometry.setIndex( indices );\n\t\t\tindex = geometry.getIndex();\n\n\t\t} else {\n\n\t\t\tconsole.error( 'THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible.' );\n\t\t\treturn geometry;\n\n\t\t}\n\n\t}\n\n\t//\n\n\tconst numberOfTriangles = index.count - 2;\n\tconst newIndices = [];\n\n\tif ( drawMode === TriangleFanDrawMode ) {\n\n\t\t// gl.TRIANGLE_FAN\n\n\t\tfor ( let i = 1; i <= numberOfTriangles; i ++ ) {\n\n\t\t\tnewIndices.push( index.getX( 0 ) );\n\t\t\tnewIndices.push( index.getX( i ) );\n\t\t\tnewIndices.push( index.getX( i + 1 ) );\n\n\t\t}\n\n\t} else {\n\n\t\t// gl.TRIANGLE_STRIP\n\n\t\tfor ( let i = 0; i < numberOfTriangles; i ++ ) {\n\n\t\t\tif ( i % 2 === 0 ) {\n\n\t\t\t\tnewIndices.push( index.getX( i ) );\n\t\t\t\tnewIndices.push( index.getX( i + 1 ) );\n\t\t\t\tnewIndices.push( index.getX( i + 2 ) );\n\n\n\t\t\t} else {\n\n\t\t\t\tnewIndices.push( index.getX( i + 2 ) );\n\t\t\t\tnewIndices.push( index.getX( i + 1 ) );\n\t\t\t\tnewIndices.push( index.getX( i ) );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\tif ( ( newIndices.length / 3 ) !== numberOfTriangles ) {\n\n\t\tconsole.error( 'THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.' );\n\n\t}\n\n\t// build final geometry\n\n\tconst newGeometry = geometry.clone();\n\tnewGeometry.setIndex( newIndices );\n\n\treturn newGeometry;\n\n}\n\nexport { GLTFLoader };\n","/**\r\n * @webxr-input-profiles/motion-controllers 1.0.0 https://github.com/immersive-web/webxr-input-profiles\r\n */\r\n\r\nexport const Constants = {\r\n\tHandedness: Object.freeze({\r\n\t\tNONE: 'none',\r\n\t\tLEFT: 'left',\r\n\t\tRIGHT: 'right'\r\n\t}),\r\n\r\n\tComponentState: Object.freeze({\r\n\t\tDEFAULT: 'default',\r\n\t\tTOUCHED: 'touched',\r\n\t\tPRESSED: 'pressed'\r\n\t}),\r\n\r\n\tComponentProperty: Object.freeze({\r\n\t\tBUTTON: 'button',\r\n\t\tX_AXIS: 'xAxis',\r\n\t\tY_AXIS: 'yAxis',\r\n\t\tSTATE: 'state'\r\n\t}),\r\n\r\n\tComponentType: Object.freeze({\r\n\t\tTRIGGER: 'trigger',\r\n\t\tSQUEEZE: 'squeeze',\r\n\t\tTOUCHPAD: 'touchpad',\r\n\t\tTHUMBSTICK: 'thumbstick',\r\n\t\tBUTTON: 'button'\r\n\t}),\r\n\r\n\tButtonTouchThreshold: 0.05,\r\n\r\n\tAxisTouchThreshold: 0.1,\r\n\r\n\tVisualResponseProperty: Object.freeze({\r\n\t\tTRANSFORM: 'transform',\r\n\t\tVISIBILITY: 'visibility'\r\n\t})\r\n};\r\n\r\n/** @constant {Object} */\r\nconst defaultComponentValues = {\r\n\txAxis: 0,\r\n\tyAxis: 0,\r\n\tbutton: 0,\r\n\tstate: Constants.ComponentState.DEFAULT\r\n};\r\n\r\n/**\r\n * @description Static helper function to fetch a JSON file and turn it into a JS object\r\n * @param {string} path - Path to JSON file to be fetched\r\n */\r\nasync function fetchJsonFile(path) {\r\n\tconst response = await fetch(path);\r\n\tif (!response.ok) {\r\n\t\tthrow new Error(response.statusText);\r\n\t} else {\r\n\t\treturn response.json();\r\n\t}\r\n}\r\n\r\nexport async function fetchProfilesList(basePath) {\r\n\tif (!basePath) {\r\n\t\tthrow new Error('No basePath supplied');\r\n\t}\r\n\r\n\tconst profileListFileName = 'profilesList.json';\r\n\tconst profilesList = await fetchJsonFile(`${basePath}/${profileListFileName}`);\r\n\treturn profilesList;\r\n}\r\n\r\nexport async function fetchProfile(xrInputSource, basePath, defaultProfile = null, getAssetPath = true) {\r\n\tif (!xrInputSource) {\r\n\t\tthrow new Error('No xrInputSource supplied');\r\n\t}\r\n\r\n\tif (!basePath) {\r\n\t\tthrow new Error('No basePath supplied');\r\n\t}\r\n\r\n\t// Get the list of profiles\r\n\tconst supportedProfilesList = await fetchProfilesList(basePath);\r\n\r\n\t// Find the relative path to the first requested profile that is recognized\r\n\tlet match;\r\n\txrInputSource.profiles.some((profileId) => {\r\n\t\tconst supportedProfile = supportedProfilesList[profileId];\r\n\t\tif (supportedProfile) {\r\n\t\t\tmatch = {\r\n\t\t\t\tprofileId,\r\n\t\t\t\tprofilePath: `${basePath}/${supportedProfile.path}`,\r\n\t\t\t\tdeprecated: !!supportedProfile.deprecated\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn !!match;\r\n\t});\r\n\r\n\tif (!match) {\r\n\t\tif (!defaultProfile) {\r\n\t\t\tthrow new Error('No matching profile name found');\r\n\t\t}\r\n\r\n\t\tconst supportedProfile = supportedProfilesList[defaultProfile];\r\n\t\tif (!supportedProfile) {\r\n\t\t\tthrow new Error(`No matching profile name found and default profile \"${defaultProfile}\" missing.`);\r\n\t\t}\r\n\r\n\t\tmatch = {\r\n\t\t\tprofileId: defaultProfile,\r\n\t\t\tprofilePath: `${basePath}/${supportedProfile.path}`,\r\n\t\t\tdeprecated: !!supportedProfile.deprecated\r\n\t\t};\r\n\t}\r\n\r\n\tconst profile = await fetchJsonFile(match.profilePath);\r\n\r\n\tlet assetPath;\r\n\tif (getAssetPath) {\r\n\t\tlet layout;\r\n\t\tif (xrInputSource.handedness === 'any') {\r\n\t\t\tlayout = profile.layouts[Object.keys(profile.layouts)[0]];\r\n\t\t} else {\r\n\t\t\tlayout = profile.layouts[xrInputSource.handedness];\r\n\t\t}\r\n\t\tif (!layout) {\r\n\t\t\tthrow new Error(\r\n\t\t\t\t`No matching handedness, ${xrInputSource.handedness}, in profile ${match.profileId}`\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (layout.assetPath) {\r\n\t\t\tassetPath = match.profilePath.replace('profile.json', layout.assetPath);\r\n\t\t}\r\n\t}\r\n\r\n\treturn { profile, assetPath };\r\n}\r\n\r\n/**\r\n * @description Converts an X, Y coordinate from the range -1 to 1 (as reported by the Gamepad\r\n * API) to the range 0 to 1 (for interpolation). Also caps the X, Y values to be bounded within\r\n * a circle. This ensures that thumbsticks are not animated outside the bounds of their physical\r\n * range of motion and touchpads do not report touch locations off their physical bounds.\r\n * @param {number} x The original x coordinate in the range -1 to 1\r\n * @param {number} y The original y coordinate in the range -1 to 1\r\n */\r\nfunction normalizeAxes(x = 0, y = 0) {\r\n\tlet xAxis = x;\r\n\tlet yAxis = y;\r\n\r\n\t// Determine if the point is outside the bounds of the circle\r\n\t// and, if so, place it on the edge of the circle\r\n\tconst hypotenuse = Math.sqrt((x * x) + (y * y));\r\n\tif (hypotenuse > 1) {\r\n\t\tconst theta = Math.atan2(y, x);\r\n\t\txAxis = Math.cos(theta);\r\n\t\tyAxis = Math.sin(theta);\r\n\t}\r\n\r\n\t// Scale and move the circle so values are in the interpolation range.  The circle's origin moves\r\n\t// from (0, 0) to (0.5, 0.5). The circle's radius scales from 1 to be 0.5.\r\n\tconst result = {\r\n\t\tnormalizedXAxis: (xAxis * 0.5) + 0.5,\r\n\t\tnormalizedYAxis: (yAxis * 0.5) + 0.5\r\n\t};\r\n\treturn result;\r\n}\r\n\r\n/**\r\n * Contains the description of how the 3D model should visually respond to a specific user input.\r\n * This is accomplished by initializing the object with the name of a node in the 3D model and\r\n * property that need to be modified in response to user input, the name of the nodes representing\r\n * the allowable range of motion, and the name of the input which triggers the change. In response\r\n * to the named input changing, this object computes the appropriate weighting to use for\r\n * interpolating between the range of motion nodes.\r\n */\r\n\r\nclass VisualResponse {\r\n\r\n\tconstructor(visualResponseDescription) {\r\n\t\tthis.componentProperty = visualResponseDescription.componentProperty;\r\n\t\tthis.states = visualResponseDescription.states;\r\n\t\tthis.valueNodeName = visualResponseDescription.valueNodeName;\r\n\t\tthis.valueNodeProperty = visualResponseDescription.valueNodeProperty;\r\n\t\tif (this.valueNodeProperty === Constants.VisualResponseProperty.TRANSFORM) {\r\n\t\t\tthis.minNodeName = visualResponseDescription.minNodeName;\r\n\t\t\tthis.maxNodeName = visualResponseDescription.maxNodeName;\r\n\t\t}\r\n\t\t// Initializes the response's current value based on default data\r\n\t\tthis.value = 0;\r\n\t\tthis.updateFromComponent(defaultComponentValues);\r\n\t}\r\n\r\n\t/**\r\n\t * Computes the visual response's interpolation weight based on component state\r\n\t * @param {Object} componentValues - The component from which to update\r\n\t * @param {number} xAxis - The reported X axis value of the component\r\n\t * @param {number} yAxis - The reported Y axis value of the component\r\n\t * @param {number} button - The reported value of the component's button\r\n\t * @param {string} state - The component's active state\r\n\t */\r\n\tupdateFromComponent({ xAxis, yAxis, button, state }) {\r\n\t\tconst { normalizedXAxis, normalizedYAxis } = normalizeAxes(xAxis, yAxis);\r\n\t\tswitch (this.componentProperty) {\r\n\t\t\tcase Constants.ComponentProperty.X_AXIS:\r\n\t\t\t\tthis.value = (this.states.includes(state)) ? normalizedXAxis : 0.5;\r\n\t\t\t\tbreak;\r\n\t\t\tcase Constants.ComponentProperty.Y_AXIS:\r\n\t\t\t\tthis.value = (this.states.includes(state)) ? normalizedYAxis : 0.5;\r\n\t\t\t\tbreak;\r\n\t\t\tcase Constants.ComponentProperty.BUTTON:\r\n\t\t\t\tthis.value = (this.states.includes(state)) ? button : 0;\r\n\t\t\t\tbreak;\r\n\t\t\tcase Constants.ComponentProperty.STATE:\r\n\t\t\t\tif (this.valueNodeProperty === Constants.VisualResponseProperty.VISIBILITY) {\r\n\t\t\t\t\tthis.value = (this.states.includes(state));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.value = this.states.includes(state) ? 1.0 : 0.0;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass Component {\r\n\t/**\r\n\t * @param {Object} componentId - Id of the component\r\n\t * @param {Object} componentDescription - Description of the component to be created\r\n\t */\r\n\tconstructor(componentId, componentDescription) {\r\n\t\tif (!componentId ||\r\n\t\t\t!componentDescription ||\r\n\t\t\t!componentDescription.visualResponses ||\r\n\t\t\t!componentDescription.gamepadIndices ||\r\n\t\t\tObject.keys(componentDescription.gamepadIndices).length === 0) {\r\n\t\t\tthrow new Error('Invalid arguments supplied');\r\n\t\t}\r\n\t\tthis.id = componentId;\r\n\t\tthis.type = componentDescription.type;\r\n\t\tthis.rootNodeName = componentDescription.rootNodeName;\r\n\t\tthis.touchPointNodeName = componentDescription.touchPointNodeName;\r\n\t\t// Build all the visual responses for this component\r\n\t\tthis.visualResponses = {};\r\n\t\tObject.keys(componentDescription.visualResponses).forEach((responseName) => {\r\n\t\t\tconst visualResponse = new VisualResponse(componentDescription.visualResponses[responseName]);\r\n\t\t\tthis.visualResponses[responseName] = visualResponse;\r\n\t\t});\r\n\t\t// Set default values\r\n\t\tthis.gamepadIndices = Object.assign({}, componentDescription.gamepadIndices);\r\n\t\tthis.values = {\r\n\t\t\tstate: Constants.ComponentState.DEFAULT,\r\n\t\t\tbutton: (this.gamepadIndices.button !== undefined) ? 0 : undefined,\r\n\t\t\txAxis: (this.gamepadIndices.xAxis !== undefined) ? 0 : undefined,\r\n\t\t\tyAxis: (this.gamepadIndices.yAxis !== undefined) ? 0 : undefined\r\n\t\t};\r\n\t}\r\n\r\n\tget data() {\r\n\t\tconst data = { id: this.id, ...this.values };\r\n\t\treturn data;\r\n\t}\r\n\r\n\t/**\r\n\t * @description Poll for updated data based on current gamepad state\r\n\t * @param {Object} gamepad - The gamepad object from which the component data should be polled\r\n\t */\r\n\tupdateFromGamepad(gamepad) {\r\n\t\t// Set the state to default before processing other data sources\r\n\t\tthis.values.state = Constants.ComponentState.DEFAULT;\r\n\t\t// Get and normalize button\r\n\t\tif (this.gamepadIndices.button !== undefined && gamepad.buttons.length > this.gamepadIndices.button) {\r\n\t\t\tconst gamepadButton = gamepad.buttons[this.gamepadIndices.button];\r\n\t\t\tthis.values.button = gamepadButton.value;\r\n\t\t\tthis.values.button = (this.values.button < 0) ? 0 : this.values.button;\r\n\t\t\tthis.values.button = (this.values.button > 1) ? 1 : this.values.button;\r\n\t\t\t// Set the state based on the button\r\n\t\t\tif (gamepadButton.pressed || this.values.button === 1) {\r\n\t\t\t\tthis.values.state = Constants.ComponentState.PRESSED;\r\n\t\t\t} else if (gamepadButton.touched || this.values.button > Constants.ButtonTouchThreshold) {\r\n\t\t\t\tthis.values.state = Constants.ComponentState.TOUCHED;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// Get and normalize x axis value\r\n\t\tif (this.gamepadIndices.xAxis !== undefined && gamepad.axes.length > this.gamepadIndices.xAxis) {\r\n\t\t\tthis.values.xAxis = gamepad.axes[this.gamepadIndices.xAxis];\r\n\t\t\tthis.values.xAxis = (this.values.xAxis < -1) ? -1 : this.values.xAxis;\r\n\t\t\tthis.values.xAxis = (this.values.xAxis > 1) ? 1 : this.values.xAxis;\r\n\t\t\t// If the state is still default, check if the xAxis makes it touched\r\n\t\t\tif (this.values.state === Constants.ComponentState.DEFAULT && Math.abs(this.values.xAxis) > Constants.AxisTouchThreshold) {\r\n\t\t\t\tthis.values.state = Constants.ComponentState.TOUCHED;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Get and normalize Y axis value\r\n\t\tif (this.gamepadIndices.yAxis !== undefined && gamepad.axes.length > this.gamepadIndices.yAxis) {\r\n\t\t\tthis.values.yAxis = gamepad.axes[this.gamepadIndices.yAxis];\r\n\t\t\tthis.values.yAxis = (this.values.yAxis < -1) ? -1 : this.values.yAxis;\r\n\t\t\tthis.values.yAxis = (this.values.yAxis > 1) ? 1 : this.values.yAxis;\r\n\r\n\t\t\t// If the state is still default, check if the yAxis makes it touched\r\n\t\t\tif (this.values.state === Constants.ComponentState.DEFAULT && Math.abs(this.values.yAxis) > Constants.AxisTouchThreshold) {\r\n\t\t\t\tthis.values.state = Constants.ComponentState.TOUCHED;\r\n\t\t\t}\r\n\t\t}\r\n\t\t// Update the visual response weights based on the current component data\r\n\t\tObject.values(this.visualResponses).forEach((visualResponse) => {\r\n\t\t\tvisualResponse.updateFromComponent(this.values);\r\n\t\t});\r\n\t}\r\n}\r\n\r\n/**\r\n  * @description Builds a motion controller with components and visual responses based on the\r\n  * supplied profile description. Data is polled from the xrInputSource's gamepad.\r\n  * @author Nell Waliczek / https://github.com/NellWaliczek\r\n*/\r\nexport class MotionController {\r\n\t/**\r\n\t * @param {Object} xrInputSource - The XRInputSource to build the MotionController around\r\n\t * @param {Object} profile - The best matched profile description for the supplied xrInputSource\r\n\t * @param {Object} assetUrl\r\n\t */\r\n\tconstructor(xrInputSource, profile, assetUrl) {\r\n\t\tif (!xrInputSource) {\r\n\t\t\tthrow new Error('No xrInputSource supplied');\r\n\t\t}\r\n\t\tif (!profile) {\r\n\t\t\tthrow new Error('No profile supplied');\r\n\t\t}\r\n\t\tthis.xrInputSource = xrInputSource;\r\n\t\tthis.assetUrl = assetUrl;\r\n\t\tthis.id = profile.profileId;\r\n\t\t// Build child components as described in the profile description\r\n\t\tthis.layoutDescription = profile.layouts[xrInputSource.handedness];\r\n\t\tthis.components = {};\r\n\t\tObject.keys(this.layoutDescription.components).forEach((componentId) => {\r\n\t\t\tconst componentDescription = this.layoutDescription.components[componentId];\r\n\t\t\tthis.components[componentId] = new Component(componentId, componentDescription);\r\n\t\t});\r\n\t\t// Initialize components based on current gamepad state\r\n\t\tthis.updateFromGamepad();\r\n\t}\r\n\r\n\tget gripSpace() {\r\n\t\treturn this.xrInputSource.gripSpace;\r\n\t}\r\n\r\n\tget targetRaySpace() {\r\n\t\treturn this.xrInputSource.targetRaySpace;\r\n\t}\r\n\r\n\t/**\r\n\t * @description Returns a subset of component data for simplified debugging\r\n\t */\r\n\tget data() {\r\n\t\tconst data = [];\r\n\t\tObject.values(this.components).forEach((component) => {\r\n\t\t\tdata.push(component.data);\r\n\t\t});\r\n\t\treturn data;\r\n\t}\r\n\r\n\t/**\r\n\t * @description Poll for updated data based on current gamepad state\r\n\t */\r\n\tupdateFromGamepad() {\r\n\t\tObject.values(this.components).forEach((component) => {\r\n\t\t\tcomponent.updateFromGamepad(this.xrInputSource.gamepad);\r\n\t\t});\r\n\t}\r\n}\r\n","import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { MotionController, Constants as MotionControllerConstants, fetchProfile } from './motion-controllers.module.js';\r\n\r\nconst DEFAULT_PROFILES_PATH = 'https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles';\r\nconst DEFAULT_PROFILE = 'generic-trigger';\r\n\r\nclass XRControllerModel extends THREE.Object3D {\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\tthis.motionController = null;\r\n\t\tthis.envMap = null;\r\n\t}\r\n\r\n\tsetEnvironmentMap(envMap) {\r\n\t\tif (this.envMap == envMap) {\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\tthis.envMap = envMap;\r\n\t\tthis.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tchild.material.envMap = this.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn this;\r\n\t}\r\n\r\n\t/**\r\n\t * Polls data from the XRInputSource and updates the model's components to match\r\n\t * the real world data\r\n\t */\r\n\tupdateMatrixWorld(force) {\r\n\t\tsuper.updateMatrixWorld(force);\r\n\t\tif (!this.motionController) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// Cause the MotionController to poll the Gamepad for data\r\n\t\tthis.motionController.updateFromGamepad();\r\n\t\t// Update the 3D model to reflect the button, thumbstick, and touchpad state\r\n\t\tObject.values(this.motionController.components).forEach((component) => {\r\n\t\t\t// Update node data based on the visual responses' current states\r\n\t\t\tObject.values(component.visualResponses).forEach((visualResponse) => {\r\n\t\t\t\tconst { valueNode, minNode, maxNode, value, valueNodeProperty } = visualResponse;\r\n\t\t\t\t// Skip if the visual response node is not found. No error is needed,\r\n\t\t\t\t// because it will have been reported at load time.\r\n\t\t\t\tif (!valueNode) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// Calculate the new properties based on the weight supplied\r\n\t\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.VISIBILITY) {\r\n\t\t\t\t\tvalueNode.visible = value;\r\n\t\t\t\t} else if (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\t\t\t\t\tvalueNode.quaternion.slerpQuaternions(\r\n\t\t\t\t\t\tminNode.quaternion,\r\n\t\t\t\t\t\tmaxNode.quaternion,\r\n\t\t\t\t\t\tvalue,\r\n\t\t\t\t\t);\r\n\t\t\t\t\tvalueNode.position.lerpVectors(\r\n\t\t\t\t\t\tminNode.position,\r\n\t\t\t\t\t\tmaxNode.position,\r\n\t\t\t\t\t\tvalue,\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}\r\n\r\n/**\r\n * Walks the model's tree to find the nodes needed to animate the components and\r\n * saves them to the motionContoller components for use in the frame loop. When\r\n * touchpads are found, attaches a touch dot to them.\r\n */\r\nfunction findNodes(motionController, scene) {\r\n\t// Loop through the components and find the nodes needed for each components' visual responses\r\n\tObject.values(motionController.components).forEach((component) => {\r\n\t\tconst { type, touchPointNodeName, visualResponses } = component;\r\n\t\tif (type === MotionControllerConstants.ComponentType.TOUCHPAD) {\r\n\t\t\tcomponent.touchPointNode = scene.getObjectByName(touchPointNodeName);\r\n\t\t\tif (component.touchPointNode) {\r\n\t\t\t\t// Attach a touch dot to the touchpad.\r\n\t\t\t\tconst sphereGeometry = new THREE.SphereGeometry(0.001);\r\n\t\t\t\tconst material = new THREE.MeshBasicMaterial({ color: 0x0000FF });\r\n\t\t\t\tconst sphere = new THREE.Mesh(sphereGeometry, material);\r\n\t\t\t\tcomponent.touchPointNode.add(sphere);\r\n\t\t\t} else {\r\n\t\t\t\tconsole.warn(`Could not find touch dot, ${component.touchPointNodeName}, in touchpad component ${component.id}`);\r\n\t\t\t}\r\n\t\t}\r\n\t\t// Loop through all the visual responses to be applied to this component\r\n\t\tObject.values(visualResponses).forEach((visualResponse) => {\r\n\t\t\tconst { valueNodeName, minNodeName, maxNodeName, valueNodeProperty } = visualResponse;\r\n\t\t\t// If animating a transform, find the two nodes to be interpolated between.\r\n\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\t\t\t\tvisualResponse.minNode = scene.getObjectByName(minNodeName);\r\n\t\t\t\tvisualResponse.maxNode = scene.getObjectByName(maxNodeName);\r\n\t\t\t\t// If the extents cannot be found, skip this animation\r\n\t\t\t\tif (!visualResponse.minNode) {\r\n\t\t\t\t\tconsole.warn(`Could not find ${minNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (!visualResponse.maxNode) {\r\n\t\t\t\t\tconsole.warn(`Could not find ${maxNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// If the target node cannot be found, skip this animation\r\n\t\t\tvisualResponse.valueNode = scene.getObjectByName(valueNodeName);\r\n\t\t\tif (!visualResponse.valueNode) {\r\n\t\t\t\tconsole.warn(`Could not find ${valueNodeName} in the model`);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction addAssetSceneToControllerModel(controllerModel, scene) {\r\n\t// Find the nodes needed for animation and cache them on the motionController.\r\n\tfindNodes(controllerModel.motionController, scene);\r\n\t// Apply any environment map that the mesh already has set.\r\n\tif (controllerModel.envMap) {\r\n\t\tscene.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tchild.material.envMap = controllerModel.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t// Add the glTF scene to the controllerModel.\r\n\tcontrollerModel.add(scene);\r\n}\r\n\r\nexport class XRControllerModelFactory {\r\n\r\n\tconstructor(gltfLoader = null) {\r\n\t\tthis.gltfLoader = gltfLoader;\r\n\t\tthis.path = DEFAULT_PROFILES_PATH;\r\n\t\tthis._assetCache = {};\r\n\t\t// If a GLTFLoader wasn't supplied to the constructor create a new one.\r\n\t\tif (!this.gltfLoader) {\r\n\t\t\tthis.gltfLoader = new GLTFLoader();\r\n\t\t}\r\n\t}\r\n\r\n\tcreateControllerModel(controller) {\r\n\t\tconst controllerModel = new XRControllerModel();\r\n\t\tlet scene = null;\r\n\t\tcontroller.addEventListener('connected', (event) => {\r\n\t\t\tconst xrInputSource = event.data;\r\n\t\t\tif (xrInputSource.targetRayMode !== 'tracked-pointer' || !xrInputSource.gamepad) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tfetchProfile(xrInputSource, this.path, DEFAULT_PROFILE).then(({ profile, assetPath }) => {\r\n\t\t\t\tcontrollerModel.motionController = new MotionController(\r\n\t\t\t\t\txrInputSource,\r\n\t\t\t\t\tprofile,\r\n\t\t\t\t\tassetPath,\r\n\t\t\t\t);\r\n\t\t\t\tconst cachedAsset = this._assetCache[controllerModel.motionController.assetUrl];\r\n\t\t\t\tif (cachedAsset) {\r\n\t\t\t\t\tscene = cachedAsset.scene.clone();\r\n\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (!this.gltfLoader) {\r\n\t\t\t\t\t\tthrow new Error('GLTFLoader not set.');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.gltfLoader.setPath('');\r\n\t\t\t\t\tthis.gltfLoader.load(controllerModel.motionController.assetUrl, (asset) => {\r\n\t\t\t\t\t\tthis._assetCache[controllerModel.motionController.assetUrl] = asset;\r\n\t\t\t\t\t\tscene = asset.scene.clone();\r\n\t\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\t\t\t\t\t}, null, () => {\r\n\t\t\t\t\t\tthrow new Error(`Asset ${controllerModel.motionController.assetUrl} missing or malformed.`);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}).catch((err) => {\r\n\t\t\t\tconsole.warn(err);\r\n\t\t\t});\r\n\t\t});\r\n\t\tcontroller.addEventListener('disconnected', () => {\r\n\t\t\tcontrollerModel.motionController = null;\r\n\t\t\tcontrollerModel.remove(scene);\r\n\t\t\tscene = null;\r\n\t\t});\r\n\t\treturn controllerModel;\r\n\t}\r\n\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { ReplaySubject } from 'rxjs';\r\nimport { auditTime, filter, map, shareReplay, takeUntil, tap } from 'rxjs/operators';\r\nimport { RGBELoader } from 'three/examples/jsm/loaders/RGBELoader.js';\r\nimport { MessageType, UIMode } from '../agora/agora.types';\r\nimport { DEBUG, environment } from '../environment';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport { LanguageService } from '../language/language.service';\r\nimport LoaderService from '../loader/loader.service';\r\nimport { Logger } from '../logger/logger';\r\nimport { MessageService } from '../message/message.service';\r\nimport { ModalService } from '../modal/modal.service';\r\nimport PrefetchService from '../prefetch/prefetch.service';\r\nimport { Rect } from '../rect/rect';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\nimport { PanoramaGridView, ViewType } from '../view/view';\r\nimport { ViewService } from '../view/view.service';\r\nimport AvatarElement from './avatar/avatar-element';\r\nimport { Host } from './host/host';\r\nimport Interactive from './interactive/interactive';\r\nimport MediaMesh from './media/media-mesh';\r\nimport MediaPlayMesh from './media/media-play-mesh';\r\nimport OrbitService, { OrbitMoveEvent } from './orbit/orbit.service';\r\nimport Panorama from './panorama/panorama';\r\nimport PhoneElement from './phone/phone.element';\r\nimport PointerElement from './pointer/pointer.element';\r\nimport { TeleportElement } from './teleport/teleport.element';\r\nimport { Texture } from './texture/texture';\r\nimport VRService from './vr.service';\r\nimport { Gamepad } from './webxr/gamepad';\r\nimport { XRControllerModelFactory } from './webxr/xr-controller-model.factory';\r\n\r\nconst ZERO = new THREE.Vector3();\r\nconst DOWN = new THREE.Vector3(0, -1, 0);\r\nconst USE_SHADOW = false;\r\nconst USE_PHONE = true;\r\n\r\nconst CONTROL_INFO = {\r\n\ttype: MessageType.ControlInfo,\r\n\torientation: { latitude: 0, longitude: 0 },\r\n\tzoom: 1,\r\n\tcameraGroup: {\r\n\t\tposition: [0, 0, 0],\r\n\t\trotation: [0, 0, 0],\r\n\t},\r\n\tpointer: [0, 0, 0],\r\n};\r\n\r\nexport default class WorldComponent extends Component {\r\n\r\n\tget error() {\r\n\t\treturn this.error_;\r\n\t}\r\n\tset error(error) {\r\n\t\tif (this.error_ !== error) {\r\n\t\t\tthis.error_ = error;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\tget view() {\r\n\t\treturn this.view_;\r\n\t}\r\n\tset view(view) {\r\n\t\tif (this.view_ !== view) {\r\n\t\t\tthis.view_ = view;\r\n\t\t\tthis.setView();\r\n\t\t}\r\n\t}\r\n\tget debugging() {\r\n\t\t// return STATIC || DEBUG;\r\n\t\treturn DEBUG;\r\n\t}\r\n\r\n\tget controlled() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling !== StateService.state.uid);\r\n\t}\r\n\r\n\tget controlling() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling === StateService.state.uid);\r\n\t}\r\n\r\n\tget silencing() {\r\n\t\treturn StateService.state.silencing;\r\n\t}\r\n\r\n\tget silenced() {\r\n\t\treturn (StateService.state.silencing && StateService.state.role === RoleType.Streamer);\r\n\t}\r\n\r\n\tget spyed() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying === StateService.state.uid);\r\n\t}\r\n\r\n\tget spying() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying !== StateService.state.uid);\r\n\t}\r\n\r\n\tget locked() {\r\n\t\treturn this.controlled || this.spying;\r\n\t}\r\n\r\n\tget lockedOrXR() {\r\n\t\treturn this.locked || this.renderer.xr.isPresenting;\r\n\t}\r\n\r\n\tget showMenu() {\r\n\t\treturn StateService.state.hosted && StateService.state.navigable && (StateService.state.mode !== 'embed' || environment.flags.menuEmbed);\r\n\t}\r\n\r\n\tget showPointer() {\r\n\t\treturn this.pointer.mesh.parent != null;\r\n\t}\r\n\tset showPointer(showPointer) {\r\n\t\tif (this.showPointer !== showPointer) {\r\n\t\t\tshowPointer ? this.scene.add(this.pointer.mesh) : this.scene.remove(this.pointer.mesh);\r\n\t\t\t// Logger.log('WorldComponent.showPointer', showPointer);\r\n\t\t}\r\n\t}\r\n\r\n\tset menu(menu) {\r\n\t\tif (this.menu_ !== menu) {\r\n\t\t\tthis.menu_ = menu;\r\n\t\t\tthis.scene.traverse(object => {\r\n\t\t\t\tif (object instanceof MediaMesh || object instanceof MediaPlayMesh) {\r\n\t\t\t\t\tobject.freezed = (menu != null);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\tget menu() {\r\n\t\treturn this.menu_;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// Logger.log('WorldComponent.onInit');\r\n\t\tHost.host = this;\r\n\t\tthis.defaultTexture = Texture.gridTexture;\r\n\t\tthis.index = 0;\r\n\t\tthis.error_ = null;\r\n\t\tthis.loading = null;\r\n\t\tthis.waiting = null;\r\n\t\tthis.avatars = {};\r\n\t\tthis.createScene();\r\n\t\t// this.setView();\r\n\t\tthis.addListeners();\r\n\t\tthis.animate(); // !!!\r\n\t\tKeyboardService.keys$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(keys => {\r\n\t\t\tthis.keys = keys;\r\n\t\t\t// console.log(keys);\r\n\t\t});\r\n\t\tLanguageService.lang$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(_ => {\r\n\t\t\tthis.setView();\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonChanges() {\r\n\t\tif (this.view) {\r\n\t\t\tconst selected = this.view.items.find(item => item.selected);\r\n\t\t\tif (selected && selected.mesh) {\r\n\t\t\t\tif (this.view.type.name !== 'model') {\r\n\t\t\t\t\tthis.orbitService.lookAt(selected.mesh);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(() => { });\r\n\t}\r\n\r\n\tcreateScene() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.size = { left: 0, top: 0, width: 0, height: 0, aspect: 0 };\r\n\t\tthis.mouse = new THREE.Vector2();\r\n\t\tthis.controllerMatrix_ = new THREE.Matrix4();\r\n\t\tthis.controllerWorldPosition_ = new THREE.Vector3();\r\n\t\tthis.controllerWorldDirection_ = new THREE.Vector3();\r\n\r\n\t\tconst container = this.container = node;\r\n\t\tconst info = this.info = node.querySelector('.world__info');\r\n\r\n\t\tconst worldRect = this.worldRect = Rect.fromNode(container);\r\n\t\tconst cameraRect = this.cameraRect = new Rect();\r\n\r\n\t\tconst cameraGroup = this.cameraGroup = new THREE.Group();\r\n\t\t// new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, ROOM_RADIUS * 2);\r\n\t\t// const camera = this.camera = new THREE.PerspectiveCamera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\tconst camera = this.camera = new THREE.PerspectiveCamera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\tcamera.target = new THREE.Vector3();\r\n\t\tcameraGroup.add(camera);\r\n\t\t// cameraGroup.target = new THREE.Vector3();\r\n\r\n\t\tconst orbitService = this.orbitService = new OrbitService(camera);\r\n\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: environment.flags.antialias || false,\r\n\t\t\talpha: environment.flags.alpha || false,\r\n\t\t\tpremultipliedAlpha: environment.flags.premultipliedAlpha || false,\r\n\t\t\tlogarithmicDepthBuffer: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t\tpowerPreference: 'high-performance',\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(container.offsetWidth, container.offsetHeight);\r\n\t\trenderer.xr.enabled = true;\r\n\t\trenderer.outputEncoding = THREE.LinearEncoding;\r\n\t\t// renderer.toneMapping = THREE.NoToneMapping;\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = environment.toneMappingExposure || 1; // 2;\r\n\t\t// renderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\t// renderer.toneMapping = THREE.LinearToneMapping;\r\n\t\t// renderer.toneMapping = THREE.ReinhardToneMapping;\r\n\t\t// renderer.toneMapping = THREE.CineonToneMapping;\r\n\t\t// renderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\tif (USE_SHADOW) {\r\n\t\t\trenderer.shadowMap.enabled = true;\r\n\t\t\trenderer.shadowMap.type = THREE.PCFShadowMap; // THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap\r\n\t\t}\r\n\t\tif (container.childElementCount > 0) {\r\n\t\t\tcontainer.insertBefore(renderer.domElement, container.children[0]);\r\n\t\t} else {\r\n\t\t\tcontainer.appendChild(renderer.domElement);\r\n\t\t}\r\n\r\n\t\tconst raycaster = this.raycaster = new THREE.Raycaster();\r\n\t\traycaster.setFromCamera(this.mouse, camera);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\t\tscene.add(cameraGroup);\r\n\r\n\t\tif (environment.flags.useTextureEnvironment) {\r\n\t\t\tthis.addEnvironment();\r\n\t\t}\r\n\r\n\t\tconst objects = this.objects = new THREE.Group();\r\n\t\tobjects.name = '[objects]';\r\n\t\tscene.add(objects);\r\n\r\n\t\tconst panorama = this.panorama = new Panorama(renderer);\r\n\t\tthis.panoramaIntersectObjects = [panorama.mesh];\r\n\t\tthis.intersectObjects = this.panoramaIntersectObjects;\r\n\t\tobjects.add(panorama.mesh);\r\n\r\n\t\tconst indicator = this.indicator = new PointerElement();\r\n\t\tconst pointer = this.pointer = new PointerElement('#ff4332');\r\n\r\n\t\tconst light1 = new THREE.PointLight(0xffffff, 0.8);\r\n\t\tlight1.position.set(-50, 0, 0);\r\n\t\tobjects.add(light1);\r\n\r\n\t\tconst light2 = new THREE.PointLight(0xffffff, 0.3);\r\n\t\tlight2.position.set(50, 0, 0);\r\n\t\tobjects.add(light2);\r\n\r\n\t\tconst light3 = new THREE.PointLight(0xffffff, 0.5);\r\n\t\tlight3.position.set(0, 50, 0);\r\n\t\tobjects.add(light3);\r\n\r\n\t\tconst light4 = new THREE.PointLight(0xffffff, 0.1);\r\n\t\tlight4.position.set(0, -50, 0);\r\n\t\tobjects.add(light4);\r\n\r\n\t\tconst ambient = this.ambient = new THREE.AmbientLight(0xffffff, 0.25);\r\n\t\tobjects.add(ambient);\r\n\r\n\t\t/*\r\n\t\tconst direct = this.direct = new THREE.DirectionalLight(0xffffff, 1);\r\n\t\tdirect.position.set(-40, -40, -40);\r\n\t\tdirect.target.position.set(0, 0, 0);\r\n\t\tobjects.add(direct);\r\n\t\t*/\r\n\r\n\t\tthis.addControllers();\r\n\t\tthis.resize();\r\n\r\n\t\t// show hide items\r\n\t\tLoaderService.progress$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(progress => {\r\n\t\t\tconst complete = progress.count === 0;\r\n\t\t\tconst view = this.view_;\r\n\t\t\t// this.panorama.mesh.visible = complete;\r\n\t\t\tif (view.items) {\r\n\t\t\t\tview.items.forEach(item => {\r\n\t\t\t\t\titem.visible = complete;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t// console.log(view, complete, progress);\r\n\t\t});\r\n\r\n\t\t// Logger.log('WorldComponent.createScene', this);\r\n\t}\r\n\r\n\ttoggleLights(enabled) {\r\n\t\tif (this.ambient) {\r\n\t\t\tthis.ambient.visible = enabled;\r\n\t\t}\r\n\t\tif (this.direct) {\r\n\t\t\tthis.direct.visible = enabled;\r\n\t\t}\r\n\t}\r\n\r\n\taddEnvironment() {\r\n\t\tconst segments = environment.textures.envMap.split('/');\r\n\t\tconst filename = segments.pop();\r\n\t\tconst folder = segments.join('/') + '/';\r\n\t\tconst isHdr = filename.indexOf('.hdr') !== -1;\r\n\t\t// const loader = isHdr ? new RGBELoader().setDataType(THREE.UnsignedByteType) : new THREE.TextureLoader();\r\n\t\tlet loader;\r\n\t\tif (isHdr) {\r\n\t\t\tloader = new RGBELoader();\r\n\t\t\tloader.setDataType(THREE.HalfFloatType);\r\n\t\t} else {\r\n\t\t\tloader = new THREE.TextureLoader();\r\n\t\t}\r\n\t\tloader.setPath(environment.getPath(folder)).load(filename, (texture) => {\r\n\t\t\tif (isHdr && texture) {\r\n\t\t\t\ttexture.mapping = THREE.EquirectangularReflectionMapping;\r\n\t\t\t\tthis.scene.background = texture;\r\n\t\t\t\tthis.scene.environment = texture;\r\n\t\t\t} else {\r\n\t\t\t\tthis.setBackground(texture);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\taddOffCanvasScene(message) {\r\n\t\tconst avatar = new AvatarElement(message);\r\n\t\tthis.avatars[message.clientId] = avatar;\r\n\t\t// avatar.container.appendChild(avatar.element);\r\n\t}\r\n\r\n\tremoveOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\t/*\r\n\t\tif (avatar && avatar.element.parentNode) {\r\n\t\t\tavatar.element.parentNode.removeChild(avatar.element);\r\n\t\t}\r\n\t\t*/\r\n\t\tdelete this.avatars[message.clientId];\r\n\t}\r\n\r\n\tupdateOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\tif (avatar) {\r\n\t\t\tavatar.update(message);\r\n\t\t}\r\n\t}\r\n\r\n\tsetBackground(texture) {\r\n\t\tlet background = texture || this.defaultTexture;\r\n\t\tbackground.mapping = THREE.EquirectangularReflectionMapping;\r\n\t\t// background.encoding = THREE.LinearEncoding;\r\n\t\tbackground.encoding = THREE.sRGBEncoding;\r\n\t\t// background.encoding = THREE.GammaEncoding;\r\n\t\t// background.encoding = THREE.RGBEEncoding;\r\n\t\t// background.encoding = THREE.LogLuvEncoding;\r\n\t\t// background.encoding = THREE.RGBM7Encoding;\r\n\t\t// background.encoding = THREE.RGBM16Encoding;\r\n\t\t// background.encoding = THREE.RGBDEncoding;\r\n\t\t// background.encoding = THREE.BasicDepthPacking;\r\n\t\t// background.encoding = THREE.RGBADepthPacking;\r\n\t\t// this.scene.background = background;\r\n\t\tthis.scene.environment = background;\r\n\t}\r\n\r\n\tsetView() {\r\n\t\tif (!this.renderer) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!this.panorama) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst view = this.view_;\r\n\t\tif (view) {\r\n\t\t\tif (StateService.state.zoomedId != null) {\r\n\t\t\t\tStateService.patchState({ zoomedId: null });\r\n\t\t\t}\r\n\t\t\tif (this.views) {\r\n\t\t\t\tthis.views.forEach(view => delete view.onUpdateAsset);\r\n\t\t\t}\r\n\t\t\tconst message = this.requestInfoResult;\r\n\t\t\tif (message) {\r\n\t\t\t\tif (view instanceof PanoramaGridView && message.gridIndex !== undefined) {\r\n\t\t\t\t\tview.index_ = message.gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tview.ready = false;\r\n\t\t\tthis.cameraGroup.position.set(0, 0, 0);\r\n\t\t\tthis.cameraGroup.rotation.set(0, 0, 0);\r\n\t\t\tif (view.type.name === ViewType.Room3d.name) {\r\n\t\t\t\tthis.renderer.setClearColor(0x000000, 1);\r\n\t\t\t\tthis.objects.remove(this.panorama.mesh);\r\n\t\t\t\tthis.toggleLights(false);\r\n\t\t\t} else {\r\n\t\t\t\tthis.renderer.setClearColor(0x000000, 1);\r\n\t\t\t\tthis.objects.add(this.panorama.mesh);\r\n\t\t\t\tthis.toggleLights(true);\r\n\t\t\t}\r\n\t\t\t// this.waiting = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tPrefetchService.cancel();\r\n\t\t\tthis.panorama.change(view, this.renderer, (texture) => {\r\n\t\t\t\t// Logger.log('WorldComponent.panorama.change', texture);\r\n\t\t\t\tif (!environment.flags.useTextureEnvironment) {\r\n\t\t\t\t\tthis.setBackground(texture);\r\n\t\t\t\t}\r\n\t\t\t\tview.ready = true;\r\n\t\t\t\tview.onUpdateAsset = () => {\r\n\t\t\t\t\tthis.onViewAssetDidChange();\r\n\t\t\t\t};\r\n\t\t\t\tconst context = getContext(this);\r\n\t\t\t\t// Logger.log('WorldCompoent.setView.context', context);\r\n\t\t\t\tif (context) {\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t}, (view) => {\r\n\t\t\t\tthis.setViewOrientation(view);\r\n\t\t\t\tPrefetchService.prefetch(view.prefetchAssets);\r\n\t\t\t\t// this.loading = null;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonViewAssetDidChange() {\r\n\t\tif (this.panorama) {\r\n\t\t\tthis.panorama.crossfade(this.view, this.renderer, (texture) => {\r\n\t\t\t\tif (!environment.flags.useTextureEnvironment) {\r\n\t\t\t\t\tthis.setBackground(texture);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tsetViewOrientation(view) {\r\n\t\tconst message = this.requestInfoResult;\r\n\t\tthis.requestInfoResult = null;\r\n\t\tif (this.orbitService) {\r\n\t\t\tthis.orbitService.mode = view.type.name;\r\n\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\tlet orientation;\r\n\t\t\t\tif (message) {\r\n\t\t\t\t\torientation = message.orientation;\r\n\t\t\t\t\tthis.orbitService.setOrientation(orientation);\r\n\t\t\t\t\tthis.orbitService.zoom = message.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t} else if (!view.keepOrientation) {\r\n\t\t\t\t\t// Logger.log('WorldComponent.setViewOrientation', view.useLastOrientation, view.lastOrientation);\r\n\t\t\t\t\torientation = view.useLastOrientation ? view.lastOrientation : view.orientation;\r\n\t\t\t\t\tthis.orbitService.setOrientation(orientation);\r\n\t\t\t\t\tthis.orbitService.zoom = view.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddControllers() {\r\n\t\tconst controllerGroup = this.controllerGroup = new THREE.Group();\r\n\t\tconst teleport = this.teleport = new TeleportElement();\r\n\t\tthis.controllers = [];\r\n\t\tthis.controllerModelFactory = new XRControllerModelFactory();\r\n\t\tthis.addController(0);\r\n\t\tthis.addController(1);\r\n\t\tthis.cameraGroup.add(controllerGroup);\r\n\t}\r\n\r\n\taddController(index) {\r\n\t\tconst showPhone = USE_PHONE && StateService.state.live;\r\n\t\tconst renderer = this.renderer;\r\n\t\tconst controllerGroup = this.controllerGroup;\r\n\t\tconst controller = renderer.xr.getController(index);\r\n\t\tconst controllerModelFactory = this.controllerModelFactory;\r\n\t\tconst teleport = this.teleport;\r\n\t\tconst scene = this.scene;\r\n\t\tconst camera = this.camera;\r\n\t\tconst cameraGroup = this.cameraGroup;\r\n\t\tcontroller.name = `[controller${index + 1}]`;\r\n\t\tcontrollerGroup.add(controller);\r\n\t\tconst setController = (controller) => {\r\n\t\t\t// Logger.log('WorldComponent.setController', this);\r\n\t\t\tthis.controller = controller;\r\n\t\t};\r\n\t\tconst onSelectStart = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = true;\r\n\t\t\tsetController(controller);\r\n\t\t};\r\n\t\tconst onSelectEnd = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = false;\r\n\t\t};\r\n\t\tconst onSqueezeStart = (event) => {\r\n\t\t\tif (this.view && this.view.type.name === ViewType.Room3d.name) {\r\n\t\t\t\tteleport.addToController(controller, scene);\r\n\t\t\t\t// this.scene.remove(this.indicator.mesh);\r\n\t\t\t\tthis.indicator.mesh.visible = false;\r\n\t\t\t\tcontroller.children[0].visible = false;\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst onSqueezeEnd = (event) => {\r\n\t\t\t// if (this.view && this.view.type.name === ViewType.Room3d.name) {\r\n\t\t\tteleport.removeFromController(controller, scene, renderer, camera, cameraGroup);\r\n\t\t\t// this.scene.add(this.indicator.mesh);\r\n\t\t\tthis.indicator.mesh.visible = true;\r\n\t\t\tcontroller.children[0].visible = true;\r\n\t\t\t// }\r\n\t\t};\r\n\t\t// const debugService = DebugService.getService();\r\n\t\t// debugService.setMessage('DebugService 1001');\r\n\t\tconst onPress = (event) => {\r\n\t\t\t// Logger.log('WorldComponent.Gamepad.onPress', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onPress ' + event.index);\r\n\t\t\t// 0: select\r\n\t\t\t// 1: squeeze\r\n\t\t\t// 4: x / a\r\n\t\t\t// 5: y / b\r\n\t\t\tswitch (event.index) {\r\n\t\t\t\tcase 0:\r\n\t\t\t\t\t// select\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 1:\r\n\t\t\t\t\t// squeeze\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 4:\r\n\t\t\t\t\t// x / a\r\n\t\t\t\t\tMessageService.send({\r\n\t\t\t\t\t\ttype: MessageType.MenuToggle,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst onRelease = (event) => {\r\n\t\t\tthis.onModelUp();\r\n\t\t};\r\n\t\tconst onLeft = (event) => {\r\n\t\t\t// Logger.log('WorldComponent.Gamepad.onLeft', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onLeft');\r\n\t\t\tthis.cameraGroup.rotation.y += Math.PI / 180 * 45;\r\n\t\t};\r\n\t\tconst onRight = (event) => {\r\n\t\t\t// Logger.log('WorldComponent.Gamepad.onRight', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onRight');\r\n\t\t\tthis.cameraGroup.rotation.y -= Math.PI / 180 * 45;\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// Logger.log('WorldComponent.Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.cameraGroup.rotation.y += (Math.PI / 180 * event.x);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// Logger.log('WorldComponent.Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.onModelDistance(event.y);\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\t// Logger.log('WorldComponent.Gamepad.onUp', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onUp');\r\n\t\t\tthis.cameraGroup.position.y += 1;\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\t// Logger.log('WorldComponent.Gamepad.onDown', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onDown');\r\n\t\t\tthis.cameraGroup.position.y -= 1;\r\n\t\t};\r\n\t\t*/\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\tthis.onModelDistance(1);\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\tthis.onModelDistance(-1);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onConnected = (event) => {\r\n\t\t\tcontroller.add(this.buildController(event.data));\r\n\t\t\tif (showPhone && event.data.handedness === 'left') {\r\n\t\t\t\tconst phone = this.phone = new PhoneElement();\r\n\t\t\t\tcontroller.add(phone.mesh);\r\n\t\t\t}\r\n\t\t\tif (!showPhone || event.data.handedness === 'right') {\r\n\t\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\t\tcontrollerGrip.name = `[controller-grip${index + 1}]`;\r\n\t\t\t\tconst controllerModel = controllerModelFactory.createControllerModel(controllerGrip);\r\n\t\t\t\tcontroller.userData.model = controllerModel;\r\n\t\t\t\tcontrollerGrip.add(controllerModel);\r\n\t\t\t\tcontrollerGroup.add(controllerGrip);\r\n\t\t\t}\r\n\t\t\tconst gamepad = new Gamepad(event.data.gamepad);\r\n\t\t\tgamepad.on('press', onPress);\r\n\t\t\tgamepad.on('release', onRelease);\r\n\t\t\tgamepad.on('left', onLeft);\r\n\t\t\tgamepad.on('right', onRight);\r\n\t\t\tgamepad.on('axis', onAxis);\r\n\t\t\t// gamepad.on('up', onUp);\r\n\t\t\t// gamepad.on('down', onDown);\r\n\t\t\tcontroller.userData.gamepad = gamepad;\r\n\t\t\tcontroller.userData.update = () => {\r\n\t\t\t\tgamepad.update();\r\n\t\t\t};\r\n\t\t};\r\n\t\tconst onDisconnected = (event) => {\r\n\t\t\twhile (controller.children.length) {\r\n\t\t\t\tcontroller.remove(controller.children[0]);\r\n\t\t\t}\r\n\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\twhile (controllerGrip.children.length) {\r\n\t\t\t\tcontrollerGrip.remove(controllerGrip.children[0]);\r\n\t\t\t}\r\n\t\t\tcontrollerGroup.remove(controllerGrip);\r\n\t\t\tcontroller.userData.update = () => { };\r\n\t\t\tconst gamepad = controller.userData.gamepad;\r\n\t\t\tif (gamepad) {\r\n\t\t\t\tgamepad.off('press', onPress);\r\n\t\t\t\tgamepad.off('release', onRelease);\r\n\t\t\t\tgamepad.off('left', onLeft);\r\n\t\t\t\tgamepad.off('right', onRight);\r\n\t\t\t\tgamepad.off('axis', onAxis);\r\n\t\t\t\t// gamepad.off('up', onUp);\r\n\t\t\t\t// gamepad.off('down', onDown);\r\n\t\t\t\tdelete controller.userData.gamepad;\r\n\t\t\t}\r\n\t\t\tteleport.removeFromController(controller, scene, renderer, camera, cameraGroup);\r\n\t\t};\r\n\t\tcontroller.userData.update = () => { };\r\n\t\tcontroller.addEventListener('selectstart', onSelectStart);\r\n\t\tcontroller.addEventListener('selectend', onSelectEnd);\r\n\t\tcontroller.addEventListener('connected', onConnected);\r\n\t\tcontroller.addEventListener('disconnected', onDisconnected);\r\n\t\tcontroller.addEventListener('squeezestart', onSqueezeStart);\r\n\t\tcontroller.addEventListener('squeezeend', onSqueezeEnd);\r\n\t\tconst controllers = this.controllers;\r\n\t\tcontrollers.push(controller);\r\n\t}\r\n\r\n\tbuildController(data) {\r\n\t\t// Logger.log('WorldComponent.buildController', data);\r\n\t\tlet geometry, material;\r\n\t\tswitch (data.targetRayMode) {\r\n\t\t\tcase 'tracked-pointer':\r\n\t\t\t\tgeometry = new THREE.BufferGeometry();\r\n\t\t\t\tgeometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 0, 0, 0, -1], 3));\r\n\t\t\t\tgeometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));\r\n\t\t\t\tmaterial = new THREE.LineBasicMaterial({\r\n\t\t\t\t\tvertexColors: true,\r\n\t\t\t\t\tblending: THREE.AdditiveBlending,\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Line(geometry, material);\r\n\t\t\tcase 'gaze':\r\n\t\t\t\tgeometry = new THREE.RingBufferGeometry(0.02, 0.04, 32).translate(0, 0, -1);\r\n\t\t\t\tmaterial = new THREE.MeshBasicMaterial({\r\n\t\t\t\t\topacity: 0.5,\r\n\t\t\t\t\ttransparent: true,\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Mesh(geometry, material);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateRaycasterXR(controller, raycaster) {\r\n\t\tif (controller) {\r\n\t\t\tthis.controllerMatrix_.identity().extractRotation(controller.matrixWorld);\r\n\t\t\traycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);\r\n\t\t\traycaster.ray.direction.set(0, 0, -1).applyMatrix4(this.controllerMatrix_);\r\n\t\t\t// raycaster.camera = this.host.renderer.xr.getCamera(this.camera);\r\n\t\t\treturn raycaster;\r\n\t\t}\r\n\t}\r\n\r\n\trepos(object, rect) {\r\n\t\tconst worldRect = this.worldRect;\r\n\t\tconst sx = 0.8;\r\n\t\t// const sx = rect.width / worldRect.width;\r\n\t\t// const sy = rect.height / worldRect.height;\r\n\t\tobject.scale.set(sx, sx, sx);\r\n\t\t// const tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect; // * cameraRect.width / worldRect.width - cameraRect.width / 2;\r\n\t\t// const ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect; // * cameraRect.height / worldRect.height - cameraRect.height / 2;\r\n\t\tconst tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect;\r\n\t\tconst ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect;\r\n\t\t// console.log(tx);\r\n\t\t// const position = new THREE.Vector3(tx, ty, 0).unproject(this.camera);\r\n\t\tobject.position.set(tx, -ty, 0);\r\n\t\t// console.log(tx, -ty, 0);\r\n\t}\r\n\r\n\trender(delta) {\r\n\t\ttry {\r\n\t\t\tconst renderer = this.renderer,\r\n\t\t\t\tscene = this.scene,\r\n\t\t\t\tcamera = this.camera,\r\n\t\t\t\tavatars = this.avatars;\r\n\t\t\tconst isPresenting = renderer.xr.isPresenting;\r\n\t\t\tif (!isPresenting && (StateService.state.mode === UIMode.LiveMeeting)) {\r\n\t\t\t\t// !!! || (StateService.state.remoteScreen !== null)\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (isPresenting) {\r\n\t\t\t\tgsap.ticker.tick();\r\n\t\t\t\tthis.controllers.forEach(controller => controller.userData.update());\r\n\t\t\t\tthis.teleport.update();\r\n\t\t\t} else {\r\n\t\t\t\tthis.navWithKeys();\r\n\t\t\t}\r\n\t\t\tthis.orbitService.render();\r\n\t\t\tconst time = performance.now();\r\n\t\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t\tscene.traverse((child) => {\r\n\t\t\t\tconst render = child.userData.render;\r\n\t\t\t\tif (typeof render === 'function') {\r\n\t\t\t\t\trender(time, tick, renderer, scene, camera);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tObject.keys(avatars).forEach(key => {\r\n\t\t\t\tavatars[key].render();\r\n\t\t\t});\r\n\t\t\tthis.vrService.updateState(this);\r\n\t\t\tthis.raycasterXRHitTest();\r\n\t\t\trenderer.render(scene, camera);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tnavWithKeys() {\r\n\t\tif (this.view && this.view.type.name === ViewType.Room3d.name && this.view.mesh && !this.locked && !ModalService.hasModal) {\r\n\t\t\tthis.intersectObjects = this.view.intersectObjects;\r\n\t\t\tconst velocity = this.velocity || (this.velocity = new THREE.Vector3());\r\n\t\t\tconst direction = this.direction || (this.direction = new THREE.Vector3());\r\n\t\t\tconst camera = this.camera;\r\n\t\t\tconst speed = 0.1;\r\n\t\t\tif (this.keys.w || this.keys.ArrowUp) {\r\n\t\t\t\tcamera.getWorldDirection(direction);\r\n\t\t\t\tdirection.multiplyScalar(speed);\r\n\t\t\t\tvelocity.copy(direction);\r\n\t\t\t} else if (this.keys.s || this.keys.ArrowDown) {\r\n\t\t\t\tcamera.getWorldDirection(direction);\r\n\t\t\t\tdirection.multiplyScalar(-speed);\r\n\t\t\t\tvelocity.copy(direction);\r\n\t\t\t} else if (this.keys.d || this.keys.ArrowRight) {\r\n\t\t\t\tcamera.getWorldDirection(direction);\r\n\t\t\t\tdirection.multiplyScalar(speed);\r\n\t\t\t\tconst axisY = this.axisY || (this.direction = new THREE.Vector3(0, 1, 0));\r\n\t\t\t\tconst angle = -Math.PI / 2;\r\n\t\t\t\tdirection.applyAxisAngle(axisY, angle);\r\n\t\t\t\tvelocity.copy(direction);\r\n\t\t\t} else if (this.keys.a || this.keys.ArrowLeft) {\r\n\t\t\t\tcamera.getWorldDirection(direction);\r\n\t\t\t\tdirection.multiplyScalar(-speed);\r\n\t\t\t\tconst axisY = this.axisY || (this.direction = new THREE.Vector3(0, 1, 0));\r\n\t\t\t\tconst angle = -Math.PI / 2;\r\n\t\t\t\tdirection.applyAxisAngle(axisY, angle);\r\n\t\t\t\tvelocity.copy(direction);\r\n\t\t\t}\r\n\t\t\tconst manhattanLength = velocity.manhattanLength();\r\n\t\t\tif (manhattanLength > 0.00001) {\r\n\t\t\t\t// console.log(velocity.x, velocity.y, velocity.z);\r\n\t\t\t\tdirection.copy(this.cameraGroup.position);\r\n\t\t\t\tdirection.add(velocity);\r\n\t\t\t\tdirection.y = 0;\r\n\t\t\t\tconst raycaster = this.raycaster;\r\n\t\t\t\traycaster.set(direction, DOWN);\r\n\t\t\t\tconst intersects = raycaster.intersectObjects(this.view.navIntersectObjects);\r\n\t\t\t\tif (intersects.length) {\r\n\t\t\t\t\t// console.log(manhattanLength, intersects);\r\n\t\t\t\t\tthis.cameraGroup.position.add(velocity);\r\n\t\t\t\t\tthis.cameraGroup.position.y = 0;\r\n\t\t\t\t\tthis.orbitService.markAsDirty();\r\n\t\t\t\t\t// this.orbitService.events$.next(OrbitService.orbitMoveEvent);\r\n\t\t\t\t\t// camera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t\tvelocity.lerp(ZERO, 0.1);\r\n\t\t\t} else {\r\n\t\t\t\tvelocity.set(0, 0, 0);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.intersectObjects = this.panoramaIntersectObjects;\r\n\t\t}\r\n\t}\r\n\r\n\tanimate() {\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(this.render);\r\n\t}\r\n\r\n\tresize() {\r\n\t\ttry {\r\n\t\t\tconst container = this.container,\r\n\t\t\t\trenderer = this.renderer,\r\n\t\t\t\tcamera = this.camera;\r\n\t\t\tconst size = this.size;\r\n\t\t\tconst rect = container.getBoundingClientRect();\r\n\t\t\tsize.left = Math.floor(rect.left);\r\n\t\t\tsize.top = Math.floor(rect.top);\r\n\t\t\tsize.width = Math.ceil(rect.width);\r\n\t\t\tsize.height = Math.ceil(rect.height);\r\n\t\t\tsize.aspect = size.width / size.height;\r\n\t\t\tconst worldRect = this.worldRect;\r\n\t\t\tworldRect.setSize(size.width, size.height);\r\n\t\t\tif (!renderer.xr.isPresenting) {\r\n\t\t\t\trenderer.setSize(size.width, size.height);\r\n\t\t\t\tif (camera) {\r\n\t\t\t\t\tcamera.aspect = size.width / size.height;\r\n\t\t\t\t\tconst angle = camera.fov * Math.PI / 180;\r\n\t\t\t\t\tconst height = Math.abs(camera.position.z * Math.tan(angle / 2) * 2);\r\n\t\t\t\t\tconst cameraRect = this.cameraRect;\r\n\t\t\t\t\tcameraRect.width = height * camera.aspect;\r\n\t\t\t\t\tcameraRect.height = height;\r\n\t\t\t\t\t// Logger.log('WorldComponent.position', camera.position.z, 'angle', angle, 'height', height, 'aspect', camera.aspect, cameraRect);\r\n\t\t\t\t\tcamera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// this.render();\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateRaycasterMouse(event) {\r\n\t\tconst w2 = this.size.width / 2;\r\n\t\tconst h2 = this.size.height / 2;\r\n\t\tthis.mouse.x = (event.clientX - this.size.left - w2) / w2;\r\n\t\tthis.mouse.y = -(event.clientY - this.size.top - h2) / h2;\r\n\t\tconst raycaster = this.raycaster;\r\n\t\traycaster.setFromCamera(this.mouse, this.camera);\r\n\t\treturn raycaster;\r\n\t}\r\n\r\n\traycasterXRHitTest() {\r\n\t\tif (this.renderer.xr.isPresenting && !this.locked) {\r\n\t\t\tconst raycaster = this.updateRaycasterXR(this.controller, this.raycaster);\r\n\t\t\tif (raycaster) {\r\n\t\t\t\tconst hit = Interactive.hittest(raycaster, this.controller.userData.isSelecting);\r\n\t\t\t\tthis.indicator.update(this.renderer.xr.getCamera(this.camera));\r\n\t\t\t\t/*\r\n\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t// controllers.feedback();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\traycasterDesktopHitTest(event) {\r\n\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.dragItem) {\r\n\t\t\tif (typeof this.dragItem.onDragMove === 'function') {\r\n\t\t\t\tconst intersections = raycaster.intersectObjects(this.intersectObjects);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst intersectionPoint = this.intersectionPoint || (this.intersectionPoint = new THREE.Vector3());\r\n\t\t\t\t\tconst intersectionNormal = this.intersectionNormal || (this.intersectionNormal = new THREE.Vector3());\r\n\t\t\t\t\tconst position = intersectionPoint.copy(intersection.point);\r\n\t\t\t\t\tconst normal = intersectionNormal.copy(intersection.face.normal);\r\n\t\t\t\t\tthis.dragItem.onDragMove(position, normal, this.intersectObjects === this.panoramaIntersectObjects);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (this.resizeItem) {\r\n\t\t\t/*\r\n\t\t\tif (typeof this.resizeItem.onResizeMove === 'function') {\r\n\t\t\t\t// calc arc x & y as scale;\r\n\t\t\t\tconst intersections = raycaster.intersectObjects(this.intersectObjects);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst position = new THREE.Vector3().copy(intersection.point).normalize();\r\n\t\t\t\t\tthis.resizeItem.onResizeMove(position);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t} else {\r\n\t\t\tconst hit = Interactive.hittest(raycaster);\r\n\t\t\tthis.controlEvent$.next(CONTROL_INFO);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseDown(event) {\r\n\t\ttry {\r\n\t\t\tif (this.locked) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (event.button !== 0) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, true);\r\n\t\t\tif (this.editor || DEBUG) {\r\n\t\t\t\tif (!(this.keys.Shift || this.keys.Control)) {\r\n\t\t\t\t\tthis.select.next({ item: null });\r\n\t\t\t\t\tconst intersections = raycaster.intersectObjects(this.intersectObjects);\r\n\t\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t\tconst intersectionPoint = this.intersectionPoint || (this.intersectionPoint = new THREE.Vector3());\r\n\t\t\t\t\t\tconst intersectionNormal = this.intersectionNormal || (this.intersectionNormal = new THREE.Vector3());\r\n\t\t\t\t\t\tconst position = intersectionPoint.copy(intersection.point);\r\n\t\t\t\t\t\tconst normal = intersectionNormal.copy(intersection.face.normal);\r\n\t\t\t\t\t\tthis.viewHit.next({ position, normal, spherical: this.intersectObjects === this.panoramaIntersectObjects });\r\n\t\t\t\t\t}\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (this.panorama.mesh.intersection) {\r\n\t\t\t\t\t\tconst position = new THREE.Vector3().copy(this.panorama.mesh.intersection.point).normalize();\r\n\t\t\t\t\t\t// console.log(JSON.stringify({ position: position.toArray() }));\r\n\t\t\t\t\t\tthis.viewHit.next(position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t} else if (this.isTouchDevice() && hit && hit.name === '[panorama]') {\r\n\t\t\t\tconst item = this.view.items.find(item => item.showPanel);\r\n\t\t\t\tif (item) {\r\n\t\t\t\t\titem.showPanel = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t// console.log(item, hit, this.view.items);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseMove(event) {\r\n\t\ttry {\r\n\t\t\tthis.raycasterDesktopHitTest(event);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseUp(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (this.dragItem) {\r\n\t\t\t\tif (typeof this.dragItem.onDragEnd === 'function') {\r\n\t\t\t\t\tthis.dragItem.onDragEnd();\r\n\t\t\t\t\tthis.dragEnd.next(this.dragItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.dragItem = null;\r\n\t\t\tif (this.resizeItem) {\r\n\t\t\t\tif (typeof this.resizeItem.onResizeEnd === 'function') {\r\n\t\t\t\t\tthis.resizeItem.onResizeEnd();\r\n\t\t\t\t\tthis.resizeEnd.next(this.resizeItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.resizeItem = null;\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, false);\r\n\t\t\tthis.checkSelectedItem();\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseWheel(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst deltaY = event.deltaY * (event.wheelDeltaY !== undefined ? 1 : 37);\r\n\t\t\tconst orbitService = this.orbitService;\r\n\t\t\tgsap.to(orbitService, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tzoom: orbitService.zoom + deltaY * 0.1,\r\n\t\t\t\tease: Power4.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t});\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonOrientationDidChange() {\r\n\t\tthis.controlEvent$.next(CONTROL_INFO);\r\n\t}\r\n\r\n\tcheckSelectedItem() {\r\n\t\tif (this.view) {\r\n\t\t\tconst selected = this.view.items.find(item => item.selected);\r\n\t\t\tif (selected && selected.mesh) {\r\n\t\t\t\tif (this.view.type.name !== 'model') {\r\n\t\t\t\t\tthis.orbitService.lookAt(selected.mesh);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonVRStarted() {\r\n\t\t// this.objects.rotation.y = - Math.PI / 2;\r\n\t\tthis.objects.position.y = 1.3;\r\n\t\tthis.scene.add(this.indicator.mesh);\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRStarted,\r\n\t\t});\r\n\t}\r\n\r\n\tonVREnded() {\r\n\t\t// this.objects.rotation.y = 0;\r\n\t\tthis.objects.position.y = 0;\r\n\t\tthis.cameraGroup.rotation.y = 0;\r\n\t\tthis.cameraGroup.position.y = 0;\r\n\t\tthis.scene.remove(this.indicator.mesh);\r\n\t\tthis.orbitService.markAsDirty();\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VREnded,\r\n\t\t});\r\n\t}\r\n\r\n\tonVRStateDidChange(state) {\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRState,\r\n\t\t\tcamera: state.camera.array,\r\n\t\t});\r\n\t}\r\n\r\n\tonMenuNav(event) {\r\n\t\t// Logger.log('WorldComponent.onMenuNav', event.id, event);\r\n\t\tthis.menu = undefined;\r\n\t\tthis.navTo.next({ viewId: event.id });\r\n\t}\r\n\r\n\tonMenuToggle(event) {\r\n\t\t// Logger.log('WorldComponent.onMenuToggle', event.id, event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.menu = event;\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavOver(nav) {\r\n\t\tif (this.menu) {\r\n\t\t\treturn;\r\n\t\t\t// this.menu.removeMenu();\r\n\t\t}\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tif (nav.item.to) {\r\n\t\t\tclearTimeout(nav.item.to);\r\n\t\t}\r\n\t\tnav.item.showPanel = nav.shouldShowPanel();\r\n\t\t// Logger.log('WorldComponent.onNavOver', nav, nav.item.showPanel);\r\n\t\tthis.pushChanges();\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.ShowPanel,\r\n\t\t\titemId: nav.item.showPanel ? nav.item.id : null,\r\n\t\t});\r\n\t}\r\n\r\n\tonNavOut(nav) {\r\n\t\t// Logger.log('WorldComponent.onNavOut', nav);\r\n\t\tif (this.isTouchDevice()) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// nav.item.showPanel = false;\r\n\t\tnav.item.to = setTimeout(() => {\r\n\t\t\tnav.item.showPanel = false;\r\n\t\t\tthis.pushChanges();\r\n\t\t}, 6000);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavDown(event) {\r\n\t\tif (!this.isTouchDevice()) {\r\n\t\t\tevent.item.showPanel = false;\r\n\t\t}\r\n\t\t// Logger.log('WorldComponent.onNavDown', this.keys);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else {\r\n\t\t\tthis.navTo.next(event.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonNavLink(event) {\r\n\t\t// Logger.log('WorldComponent.onNavLink', event.link.href);\r\n\t\tif (this.locked || this.editor) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (environment.flags.useIframe) {\r\n\t\t\tMessageService.send({\r\n\t\t\t\ttype: MessageType.NavLink,\r\n\t\t\t\titemId: event.item.id,\r\n\t\t\t\tlinkIndex: event.linkIndex,\r\n\t\t\t});\r\n\t\t\tthis.navLink.next(event);\r\n\t\t} else {\r\n\t\t\twindow.open(event.link.href, '_blank');\r\n\t\t}\r\n\t}\r\n\r\n\tisTouchDevice() {\r\n\t\treturn (('ontouchstart' in window) ||\r\n\t\t\t(navigator.maxTouchPoints > 0) ||\r\n\t\t\t(navigator.msMaxTouchPoints > 0));\r\n\t}\r\n\r\n\tonModelDown(event) {\r\n\t\tif (this.editor) {\r\n\t\t\treturn this.onObjectDown(event);\r\n\t\t}\r\n\t\t// vr controller model grab\r\n\t\tconst controller = this.controller;\r\n\t\tif (controller && this.renderer.xr.isPresenting) {\r\n\t\t\tconst target = this.tempTarget = event.mesh;\r\n\t\t\t// Logger.log('WorldComponent.onModelDown', target);\r\n\t\t\t// DebugService.getService().setMessage('onModelDown ', target.name);\r\n\t\t\tconst parent = this.tempParent = target.parent;\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tcontroller.worldToLocal(position);\r\n\t\t\tcontroller.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelDistance(direction) {\r\n\t\t// vr controller model distance\r\n\t\tconst controller = this.controller;\r\n\t\tconst target = this.tempTarget;\r\n\t\tif (controller && target && this.renderer.xr.isPresenting) {\r\n\t\t\tlet position = new THREE.Vector3();\r\n\t\t\tposition = position.copy(target.position);\r\n\t\t\tconst distance = Math.max(1, Math.min(8, position.distanceTo(ZERO) + 0.02 * direction));\r\n\t\t\tposition.normalize();\r\n\t\t\tposition = position.multiplyScalar(distance);\r\n\t\t\t// DebugService.getService().setMessage('onModelDistance ' + distance);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelUp() {\r\n\t\t// vr controller model release\r\n\t\tconst target = this.tempTarget;\r\n\t\tconst parent = this.tempParent;\r\n\t\tif (target && parent) {\r\n\t\t\t// Logger.log('WorldComponent.onModelUp', target, parent);\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tparent.worldToLocal(position);\r\n\t\t\tparent.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t\tthis.tempTarget = null;\r\n\t\t\tthis.tempParent = null;\r\n\t\t}\r\n\t}\r\n\r\n\tonObjectDown(event) {\r\n\t\t// Logger.log('WorldComponent.onObjectDown', this.keys);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t}\r\n\t}\r\n\r\n\tonPanelDown(event) {\r\n\t\t// Logger.log('WorldComponent.onPanelDown', event.link.href);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (environment.flags.useIframe) {\r\n\t\t\tMessageService.send({\r\n\t\t\t\ttype: MessageType.NavLink,\r\n\t\t\t\titemId: event.item.id,\r\n\t\t\t\tlinkIndex: event.linkIndex,\r\n\t\t\t});\r\n\t\t\tthis.navLink.next(event);\r\n\t\t} else {\r\n\t\t\twindow.open(event.link.href, '_blank');\r\n\t\t\t/*\r\n\t\t\tconst href = event.getAttribute('href');\r\n\t\t\tconst target = event.getAttribute('target') || '_self';\r\n\t\t\tif (href) {\r\n\t\t\t\twindow.open(href, '_blank');\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonPlayMedia(event) {\r\n\t\tif (this.editor) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.PlayMedia,\r\n\t\t\titemId: event.itemId,\r\n\t\t\tplaying: event.playing,\r\n\t\t});\r\n\t}\r\n\r\n\tonZoomMedia(event) {\r\n\t\tif (event.zoomed) {\r\n\t\t\tthis.view.items.forEach(item => {\r\n\t\t\t\tif (item.mesh instanceof MediaMesh) {\r\n\t\t\t\t\t// console.log(item.id, event.itemId, item.id !== event.itemId);\r\n\t\t\t\t\tif (item.id !== event.itemId) {\r\n\t\t\t\t\t\titem.mesh.setZoomedState(false);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tStateService.patchState({ zoomedId: event.zoomed ? event.itemId : null });\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.ZoomMedia,\r\n\t\t\titemId: event.itemId,\r\n\t\t\tzoomed: event.zoomed,\r\n\t\t});\r\n\t}\r\n\r\n\tonCurrentTimeMedia(event) {\r\n\t\tif (this.editor) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.CurrentTimeMedia,\r\n\t\t\titemId: event.itemId,\r\n\t\t\tcurrentTime: event.currentTime,\r\n\t\t});\r\n\t}\r\n\r\n\tonPlayModel(event) {\r\n\t\tif (this.editor) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.PlayModel,\r\n\t\t\titemId: event.itemId,\r\n\t\t\tactionIndex: event.actionIndex,\r\n\t\t});\r\n\t}\r\n\r\n\tonGridMove(event) {\r\n\t\t// Logger.log('WorldComponent.onGridMove', event, this.view);\r\n\t\tthis.view.items = [];\r\n\t\tthis.pushChanges();\r\n\t\tthis.orbitService.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\tconst tile = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\tif (tile) {\r\n\t\t\t\tthis.panorama.crossfade(tile, this.renderer, (texture) => {\r\n\t\t\t\t\tif (!environment.flags.useTextureEnvironment) {\r\n\t\t\t\t\t\tthis.setBackground(texture);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.orbitService.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t// this.loading = null;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t// this.render();\r\n\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonGridNav(event) {\r\n\t\t// Logger.log('WorldComponent.onGridNav', event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.NavToGrid,\r\n\t\t\tviewId: this.view.id,\r\n\t\t\tgridIndex: event,\r\n\t\t});\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tsetSnapshot(snapshot) {\r\n\t\tif (ViewService.viewId !== snapshot.viewId) {\r\n\t\t\tViewService.viewId = snapshot.viewId;\r\n\t\t\tthis.requestInfoResult = snapshot;\r\n\t\t} else {\r\n\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\tthis.orbitService.setOrientation(snapshot.orientation);\r\n\t\t\t\tthis.orbitService.zoom = snapshot.zoom;\r\n\t\t\t\tthis.cameraGroup.position.set(snapshot.cameraGroup.position[0], snapshot.cameraGroup.position[1], snapshot.cameraGroup.position[2]);\r\n\t\t\t\tthis.cameraGroup.rotation.set(snapshot.cameraGroup.rotation[0], snapshot.cameraGroup.rotation[1], snapshot.cameraGroup.rotation[2]);\r\n\t\t\t\t// this.camera.updateProjectionMatrix();\r\n\t\t\t}\r\n\t\t\tif (this.view instanceof PanoramaGridView && snapshot.gridIndex) {\r\n\t\t\t\tthis.view.index = snapshot.gridIndex;\r\n\t\t\t}\r\n\t\t\tif (!this.view || !this.view.ready) {\r\n\t\t\t\tthis.requestInfoResult = snapshot;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetSnapshot() {\r\n\t\tconst snapshot = {\r\n\t\t\t...CONTROL_INFO,\r\n\t\t\tviewId: this.view.id,\r\n\t\t\ttype: MessageType.SetSnapshot,\r\n\t\t};\r\n\t\tif (this.view instanceof PanoramaGridView) {\r\n\t\t\tsnapshot.gridIndex = this.view.index;\r\n\t\t}\r\n\t\treturn snapshot;\r\n\t}\r\n\r\n\tsendSetSnapshot() {\r\n\t\tconst snapshot = this.getSnapshot();\r\n\t\t// snapshot.type = MessageType.SetSnapshot;\r\n\t\tMessageService.send(snapshot);\r\n\t}\r\n\r\n\tcontrol$() {\r\n\t\treturn this.controlEvent$.pipe(\r\n\t\t\tfilter(() => this.controlling || this.spyed || this.editor),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t\tmap((control) => {\r\n\t\t\t\t/**\r\n\t\t\t\t * here we are updating original CONTROL_INFO object\r\n\t\t\t\t */\r\n\t\t\t\tcontrol.orientation.latitude = this.orbitService.latitude;\r\n\t\t\t\tcontrol.orientation.longitude = this.orbitService.longitude;\r\n\t\t\t\tcontrol.zoom = this.orbitService.zoom;\r\n\t\t\t\tcontrol.cameraGroup = {\r\n\t\t\t\t\tposition: this.cameraGroup.position.toArray(),\r\n\t\t\t\t\trotation: this.cameraGroup.rotation.toArray(),\r\n\t\t\t\t};\r\n\t\t\t\tconst intersections = this.raycaster.intersectObjects(this.intersectObjects);\r\n\t\t\t\tconst point = intersections.length ? intersections[0].point.normalize() : null;\r\n\t\t\t\tif (point) {\r\n\t\t\t\t\tcontrol.pointer[0] = point.x;\r\n\t\t\t\t\tcontrol.pointer[1] = point.y;\r\n\t\t\t\t\tcontrol.pointer[2] = point.z;\r\n\t\t\t\t}\r\n\t\t\t\tMessageService.send(control);\r\n\t\t\t\treturn control;\r\n\t\t\t}),\r\n\t\t\tauditTime(4000),\r\n\t\t\ttap(control => {\r\n\t\t\t\t/**\r\n\t\t\t\t * !!! every 4 seconds we save the last view snapshot\r\n\t\t\t\t */\r\n\t\t\t\tconst snapshot = this.getSnapshot();\r\n\t\t\t\t// snapshot.type = MessageType.SetSnapshot;\r\n\t\t\t\tMessageService.send(snapshot);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.controlEvent$ = new ReplaySubject(1);\r\n\t\tthis.control$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tthis.renderer.xr.setSession(session);\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.onVRStarted();\r\n\t\t\t} else {\r\n\t\t\t\tthis.onVREnded();\r\n\t\t\t}\r\n\t\t});\r\n\t\tvrService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t).subscribe((state) => {\r\n\t\t\tthis.onVRStateDidChange(state);\r\n\t\t});\r\n\t\tconst orbit$ = this.orbitService.observe$(this.container).pipe(\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t\t/*\r\n\t\tconst drag$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitDragEvent),\r\n\t\t);\r\n\t\t*/\r\n\t\tconst orientation$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitMoveEvent),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t);\r\n\t\torientation$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.render();\r\n\t\t\tthis.onOrientationDidChange();\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\tLogger.log('WorldComponent.addListeners', 'MessageService.out$', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.RequestControl:\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tLogger.log('WorldComponent.MessageType.RequestControl', message.controllingId);\r\n\t\t\t\t\t\tStateService.patchState({ controlling: message.controllingId, spying: false });\r\n\t\t\t\t\t\tif (message.controllingId === StateService.state.uid) {\r\n\t\t\t\t\t\t\tthis.sendSetSnapshot();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\tcase MessageType.RequestSpy:\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tLogger.log('WorldComponent.MessageType.RequestSpy', message.spyingId);\r\n\t\t\t\t\t\tStateService.patchState({ spying: message.spyingId, controlling: false });\r\n\t\t\t\t\t\tif (message.spyingId === StateService.state.uid) {\r\n\t\t\t\t\t\t\tthis.sendSetSnapshot();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\tcase MessageType.SetSnapshot:\r\n\t\t\t\t\tthis.setSnapshot(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tif (this.menu) {\r\n\t\t\t\t\t\tthis.menu.removeMenu();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.view.items.forEach(item => item.showPanel = (item.id === message.itemId));\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.NavLink: {\r\n\t\t\t\t\tconst item = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (item) {\r\n\t\t\t\t\t\tconst link = item.links[message.linkIndex];\r\n\t\t\t\t\t\tthis.navLink.next({ item, link, linkIndex: message.linkIndex });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase MessageType.NavLinkClose: {\r\n\t\t\t\t\tconst closeItem = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (closeItem) {\r\n\t\t\t\t\t\tModalService.resolve();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase MessageType.PlayMedia: {\r\n\t\t\t\t\t// !!! uniformare a PlayModel\r\n\t\t\t\t\tconst item = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (item && item.mesh instanceof MediaMesh) {\r\n\t\t\t\t\t\titem.mesh.setPlayingState(message.playing);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase MessageType.ZoomMedia: {\r\n\t\t\t\t\tthis.view.items.forEach(item => {\r\n\t\t\t\t\t\tif (item.mesh instanceof MediaMesh) {\r\n\t\t\t\t\t\t\tif (item.id === message.itemId) {\r\n\t\t\t\t\t\t\t\titem.mesh.setZoomedState(message.zoomed);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\titem.mesh.setZoomedState(false);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tStateService.patchState({ zoomedId: message.zoomed ? message.itemId : null });\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase MessageType.CurrentTimeMedia: {\r\n\t\t\t\t\tconst item = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (item && item.mesh instanceof MediaMesh) {\r\n\t\t\t\t\t\titem.mesh.setCurrentTime(message.currentTime);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase MessageType.PlayModel: {\r\n\t\t\t\t\tconst item = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (item) {\r\n\t\t\t\t\t\titem.onMessage(message);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\t// Logger.log('WorldComponent.NavToGrid', this.view.id, message);\r\n\t\t\t\t\tif (this.view.id === message.viewId) {\r\n\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\tthis.addOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\tthis.removeOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRState:\r\n\t\t\t\t\tthis.updateOffCanvasScene(message);\r\n\t\t\t\t\tif (StateService.state.spying === message.clientId || StateService.state.controlling === message.clientId) {\r\n\t\t\t\t\t\tthis.orbitService.setVRCamera(message.camera);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\tthis.orbitService.setOrientation(message.orientation);\r\n\t\t\t\t\t\tthis.orbitService.zoom = message.zoom;\r\n\t\t\t\t\t\tthis.cameraGroup.position.set(message.cameraGroup.position[0], message.cameraGroup.position[1], message.cameraGroup.position[2]);\r\n\t\t\t\t\t\tthis.cameraGroup.rotation.set(message.cameraGroup.rotation[0], message.cameraGroup.rotation[1], message.cameraGroup.rotation[2]);\r\n\t\t\t\t\t\t// this.camera.updateProjectionMatrix();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.pointer.setPosition(message.pointer[0], message.pointer[1], message.pointer[2], this.camera);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.SelectItem:\r\n\t\t\t\t\tthis.checkSelectedItem();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.showPointer = this.locked;\r\n\t\t\t// console.log(state);\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t\tthis.resize = this.resize.bind(this);\r\n\t\tthis.render = this.render.bind(this);\r\n\t\tthis.onMouseDown = this.onMouseDown.bind(this);\r\n\t\tthis.onMouseMove = this.onMouseMove.bind(this);\r\n\t\tthis.onMouseUp = this.onMouseUp.bind(this);\r\n\t\tthis.onMouseWheel = this.onMouseWheel.bind(this);\r\n\t\t// this.controls.addEventListener('change', this.render); // use if there is no animation loop\r\n\t\twindow.addEventListener('resize', this.resize, false);\r\n\t\tthis.container.addEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.addEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.addEventListener('mouseup', this.onMouseUp, false);\r\n\t\tdocument.addEventListener('mousemove', this.onMouseMove, false);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\tdocument.removeEventListener('mousemove', this.onMouseMove, false);\r\n\t\tdocument.removeEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.removeEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.removeEventListener('mouseup', this.onMouseUp, false);\r\n\t}\r\n}\r\n\r\nWorldComponent.meta = {\r\n\tselector: '[world]',\r\n\tinputs: ['view', 'views', 'editor'],\r\n\toutputs: ['navTo', 'navLink', 'viewHit', 'dragEnd', 'resizeEnd', 'select'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"world__view\" *if=\"view\">\r\n\t\t<div class=\"grid\" model-grid *if=\"view.type.name === 'panorama-grid'\" [view]=\"view\" (move)=\"onGridMove($event)\" (nav)=\"onGridNav($event)\"></div>\r\n\t\t<div *if=\"view.ready\">\r\n\t\t\t<div model-room [view]=\"view\" *if=\"view.type.name === 'room-3d'\"></div>\r\n\t\t\t<div class=\"world__item\" *for=\"let item of view.pathItems; let index = index;\">\r\n\t\t\t\t<div model-nav [item]=\"item\" [view]=\"view\" (over)=\"onNavOver($event)\" (out)=\"onNavOut($event)\" (down)=\"onNavDown($event)\" (link)=\"onNavLink($event)\" *if=\"item.type.name == 'nav'\"></div>\r\n\t\t\t\t<div model-plane [item]=\"item\" [view]=\"view\" (play)=\"onPlayMedia($event)\" (zoom)=\"onZoomMedia($event)\" (down)=\"onObjectDown($event)\" (currentTime)=\"onCurrentTimeMedia($event)\" *if=\"item.type.name == 'plane'\"></div>\r\n\t\t\t\t<div model-curved-plane [item]=\"item\" [view]=\"view\" (play)=\"onPlayMedia($event)\" (zoom)=\"onZoomMedia($event)\" (down)=\"onObjectDown($event)\" (currentTime)=\"onCurrentTimeMedia($event)\" *if=\"item.type.name == 'curved-plane'\"></div>\r\n\t\t\t\t<div class=\"model-viewer__item\" model-model [item]=\"item\" [view]=\"view\" (down)=\"onModelDown($event)\" (play)=\"onPlayModel($event)\" *if=\"item.type.name == 'model'\"></div>\r\n\t\t\t\t<div class=\"panel\" [class]=\"{ 'panel--lg': item.asset != null }\" model-panel [item]=\"item\" (down)=\"onPanelDown($event)\" *if=\"item.showPanel\"></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"progress-indicator\" model-progress [view]=\"view\">\r\n\t\t<div class=\"inner\"></div>\r\n\t</div>\r\n\t<div model-menu [views]=\"views\" (nav)=\"onMenuNav($event)\" (toggle)=\"onMenuToggle($event)\" *if=\"showMenu\"></div>\r\n\t<div model-debug *if=\"debugging\"></div>\r\n\t<div class=\"world__info\" *if=\"error\" [innerHTML]=\"error\"></div>\r\n\t`,\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { Geometry } from '../geometry/geometry';\r\nimport Interactive from '../interactive/interactive';\r\nimport WorldComponent from '../world.component';\r\n\r\nexport default class ModelComponent extends Component {\r\n\r\n\tset renderOrder(renderOrder) {\r\n\t\tthis.group.renderOrder = renderOrder;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('ModelComponent.onInit');\r\n\t\t// console.log('item', this.item, 'host', this.host);\r\n\t\tif (!this.host) {\r\n\t\t\tthrow ('ModelComponent host is undefined');\r\n\t\t}\r\n\t\tthis.scale = new THREE.Vector3(1.0, 1.0, 1.0);\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\tconst group = this.group = new THREE.Group();\r\n\t\tgroup.name = this.getName();\r\n\t\tgroup.userData.render = (time, tick) => {\r\n\t\t\t// if (this.intersection) {\r\n\t\t\tthis.render(this, time, tick);\r\n\t\t\t// }\r\n\t\t};\r\n\t\tthis.getContainer().add(group);\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item),\r\n\t\t);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelComponent', this);\r\n\t\tconst group = this.group;\r\n\t\tthis.getContainer().remove(group);\r\n\t\tdelete group.userData.render;\r\n\t\tthis.disposeObject(group);\r\n\t\tthis.group = null;\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.objects;\r\n\t}\r\n\r\n\tgetName(name) {\r\n\t\treturn `${this.constructor.meta.selector}-${this.rxcompId}${name ? `-${name}` : ''}`;\r\n\t}\r\n\r\n\tonCreate(mounth, dismount) {\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tcolor: new THREE.Color('#ffcc00'),\r\n\t\t\troughness: 0.4,\r\n\t\t\tmetalness: 0.01,\r\n\t\t\tflatShading: true,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = new THREE.Mesh(Geometry.defaultGeometry, material);\r\n\t\tif (typeof mounth === 'function') {\r\n\t\t\tmounth(mesh);\r\n\t\t}\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tonMount(mesh, item) {\r\n\t\tif (this.mesh) {\r\n\t\t\t// console.log('ModelComponent.dismount.mesh');\r\n\t\t\tthis.onDismount(this.mesh);\r\n\t\t}\r\n\t\tmesh.name = this.getName('mesh');\r\n\t\tthis.mesh = mesh;\r\n\t\tif (item) {\r\n\t\t\titem.mesh = mesh;\r\n\t\t\tObject.defineProperty(item, 'visible', {\r\n\t\t\t\tget: () => {\r\n\t\t\t\t\treturn mesh.visible;\r\n\t\t\t\t},\r\n\t\t\t\tset: (visible) => {\r\n\t\t\t\t\tthis.setVisible(visible);\r\n\t\t\t\t},\r\n\t\t\t\tconfigurable: true,\r\n\t\t\t});\r\n\t\t\titem.onUpdate = () => {\r\n\t\t\t\tthis.onUpdate(item, mesh);\r\n\t\t\t};\r\n\t\t\titem.onUpdateAsset = () => {\r\n\t\t\t\tthis.onUpdateAsset(item, mesh);\r\n\t\t\t};\r\n\t\t\titem.onMessage = (message) => {\r\n\t\t\t\tthis.onMessage(message);\r\n\t\t\t};\r\n\t\t}\r\n\t\tif (this.group) {\r\n\t\t\tthis.group.add(mesh);\r\n\t\t}\r\n\t\t// this.host.render(); !!!\r\n\t\t/*\r\n\t\tconst node = this.node;\r\n\t\tDomService.scrollIntersection$(node).subscribe(event => {\r\n\t\t\tthis.scroll = event.scroll;\r\n\t\t\tthis.intersection = event.intersection;\r\n\t\t\tthis.calculateScaleAndPosition();\r\n\t\t});\r\n\t\t*/\r\n\t\t// console.log('Model.loaded', mesh);\r\n\t}\r\n\r\n\tonDismount(mesh, item) {\r\n\t\tthis.group.remove(mesh);\r\n\t\tif (typeof mesh.dispose === 'function') {\r\n\t\t\tmesh.dispose();\r\n\t\t}\r\n\t\tthis.disposeObject(mesh);\r\n\t\tthis.mesh = null;\r\n\t\tif (item) {\r\n\t\t\tdelete item.mesh;\r\n\t\t\tdelete item.onUpdate;\r\n\t\t\tdelete item.onUpdateAsset;\r\n\t\t\tdelete item.onMessage;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeObject(object) {\r\n\t\tobject.traverse(child => {\r\n\t\t\tif (child.isInteractiveMesh || child.isInteractiveSprite) {\r\n\t\t\t\tInteractive.dispose(child);\r\n\t\t\t}\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t\tchild.geometry.dispose();\r\n\t\t\t} else if (child.isSprite) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t}\r\n\t\t});\r\n\t\t// console.log('ModelComponent.disposeObject', object);\r\n\t}\r\n\r\n\tcalculateScaleAndPosition() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.host.repos(this, node.getBoundingClientRect());\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\t/*\r\n\t\tthis.calculateScaleAndPosition();\r\n\t\tconst group = this.group;\r\n\t\tconst scale = this.scale;\r\n\t\t// group.scale.set(scale.x, scale.y, scale.z);\r\n\t\tconst position = this.position;\r\n\t\tgroup.position.set(position.x, 0, 0);\r\n\t\t// const tween = this.tween();\r\n\t\t// group.rotation.x = THREE.Math.degToRad(180) * tween;\r\n\t\t// group.rotation.y = THREE.Math.degToRad(360) * tween;\r\n\t\t*/\r\n\t}\r\n\r\n\tsetVisible(visible) {\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.visible = visible;\r\n\t\t}\r\n\t}\r\n\r\n\tgetScroll(offset) {\r\n\t\tconst scroll = this.intersection.scroll(offset);\r\n\t\t// console.log(scroll);\r\n\t\treturn scroll;\r\n\t}\r\n\r\n\tgetTween(offset) {\r\n\t\tlet tween = Math.min(0.0, this.intersection.offset(offset)) + 1;\r\n\t\ttween = Math.max(0.0, tween);\r\n\t\t// tween = Ease.Sine.InOut(tween);\r\n\t\ttween -= 1;\r\n\t\treturn tween;\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) { }\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) { }\r\n\r\n\t// called by remote events\r\n\tonMessage(message) { }\r\n\r\n}\r\n\r\nModelComponent.meta = {\r\n\tselector: '[model]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelEditableComponent extends ModelComponent {\r\n\r\n\tget editing() {\r\n\t\treturn this.editing_;\r\n\t}\r\n\tset editing(editing) {\r\n\t\tif (this.editing_ !== editing) {\r\n\t\t\tthis.editing_ = editing;\r\n\t\t\tthis.setHelper(editing);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.RADIUS = 100;\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelEditableComponent', this);\r\n\t\tthis.editing = false;\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tsetHelper(showHelper) {\r\n\t\tif (showHelper) {\r\n\t\t\tif (!this.helper) {\r\n\t\t\t\tthis.helper = new THREE.BoxHelper(this.mesh, 0x00ff00);\r\n\t\t\t}\r\n\t\t\tthis.host.scene.add(this.helper);\r\n\t\t} else if (this.helper) {\r\n\t\t\tthis.host.scene.remove(this.helper);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateHelper() {\r\n\t\tif (this.helper) {\r\n\t\t\tthis.helper.setFromObject(this.mesh);\r\n\t\t\t// this.helper.update();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelEditableComponent.meta = {\r\n\tselector: '[model-editable]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport StateService from '../../state/state.service';\r\nimport { RoleType } from '../../user/user';\r\nimport { WishlistService } from '../../wishlist/wishlist.service';\r\nimport { Geometry } from '../geometry/geometry';\r\nimport { Host } from '../host/host';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport const NavModeType = {\r\n\tNone: 'none',\r\n\tMove: 'move',\r\n\tInfo: 'info',\r\n\tPoint: 'point',\r\n\tTitle: 'title',\r\n\tTransparent: 'transparent',\r\n\tWishlist: 'wishlist',\r\n};\r\n\r\nexport default class ModelNavComponent extends ModelEditableComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelNavComponent.loader || (ModelNavComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexturePoint() {\r\n\t\treturn ModelNavComponent.texturePoint || (ModelNavComponent.texturePoint = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-point.png')));\r\n\t}\r\n\r\n\tstatic getTexturePointImportant() {\r\n\t\treturn ModelNavComponent.texturePointImportant || (ModelNavComponent.texturePointImportant = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-point-important.png')));\r\n\t}\r\n\r\n\tstatic getTextureMove() {\r\n\t\treturn ModelNavComponent.textureMove || (ModelNavComponent.textureMove = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-more.png')));\r\n\t}\r\n\r\n\tstatic getTextureMoveImportant() {\r\n\t\treturn ModelNavComponent.textureMoveImportant || (ModelNavComponent.textureMoveImportant = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-more-important.png')));\r\n\t}\r\n\r\n\tstatic getTextureInfo() {\r\n\t\treturn ModelNavComponent.textureInfo || (ModelNavComponent.textureInfo = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-info.png')));\r\n\t}\r\n\r\n\tstatic getTextureInfoImportant() {\r\n\t\treturn ModelNavComponent.textureInfoImportant || (ModelNavComponent.textureInfoImportant = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-info-important.png')));\r\n\t}\r\n\r\n\tstatic getTextureWishlist() {\r\n\t\treturn ModelNavComponent.textureWishlist || (ModelNavComponent.textureWishlist = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-wishlist-off.png')));\r\n\t}\r\n\r\n\tstatic getTextureWishlistAdded() {\r\n\t\treturn ModelNavComponent.textureWishlistAdded || (ModelNavComponent.textureWishlistAdded = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-wishlist-on.png')));\r\n\t}\r\n\r\n\tstatic getTexture(mode, item) {\r\n\t\tlet texture;\r\n\t\tswitch (mode) {\r\n\t\t\tcase NavModeType.Move:\r\n\t\t\t\ttexture = item.important ? this.getTextureMoveImportant() : this.getTextureMove();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Info:\r\n\t\t\t\ttexture = item.important ? this.getTextureInfoImportant() : this.getTextureInfo();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Point:\r\n\t\t\tcase NavModeType.Title:\r\n\t\t\t\ttexture = item.important ? this.getTexturePointImportant() : this.getTexturePoint();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Wishlist:\r\n\t\t\t\ttexture = item.added ? this.getTextureWishlistAdded() : this.getTextureWishlist();\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\ttexture.disposable = false;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getTitleTexture(item, mode) {\r\n\t\tlet texture;\r\n\t\tif (mode === NavModeType.Title) {\r\n\t\t\tconst text = item.title;\r\n\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\tcanvas.width = 512;\r\n\t\t\tcanvas.height = 32;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `24px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tlet w = metrics.width + 8;\r\n\t\t\tw = Math.pow(2, Math.ceil(Math.log(w) / Math.log(2)));\r\n\t\t\tconst x = w / 2;\r\n\t\t\tconst y = 16;\r\n\t\t\tcanvas.width = w;\r\n\t\t\tctx.font = `24px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = 6;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with 'bevel' & 'round' for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, x, y);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, x, y);\r\n\t\t\ttexture = new THREE.CanvasTexture(canvas);\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getNavMode(item, view) {\r\n\t\tlet mode = NavModeType.None;\r\n\t\tif (item.hook && item.hook === 'ToggleWishlist') {\r\n\t\t\tmode = NavModeType.Wishlist;\r\n\t\t} else if (item.transparent) {\r\n\t\t\tmode = NavModeType.Transparent;\r\n\t\t} else if (item.viewId !== view.id) {\r\n\t\t\tmode = NavModeType.Move;\r\n\t\t\tif (this.isValidText(item.title)) {\r\n\t\t\t\tmode = NavModeType.Title;\r\n\t\t\t}\r\n\t\t\tif (this.isValidText(item.abstract) ||\r\n\t\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t\t(item.link && item.link.href)) {\r\n\t\t\t\tmode = NavModeType.Point;\r\n\t\t\t}\r\n\t\t} else if (this.isValidText(item.title) ||\r\n\t\t\tthis.isValidText(item.abstract) ||\r\n\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t(item.link && item.link.href)) {\r\n\t\t\tmode = NavModeType.Info;\r\n\t\t}\r\n\t\treturn mode;\r\n\t}\r\n\r\n\tstatic hasNavInfo(view) {\r\n\t\tconst item = view.items.find(x => this.getNavMode(x, view) === NavModeType.Info);\r\n\t\t// console.log('ModelNavComponent.hasNavInfo', item);\r\n\t\treturn item != null;\r\n\t}\r\n\r\n\tstatic isValidText(text) {\r\n\t\treturn text && text.length > 0;\r\n\t}\r\n\r\n\thidden_ = false;\r\n\tget hidden() {\r\n\t\treturn this.hidden_;\r\n\t}\r\n\tset hidden(hidden) {\r\n\t\tif (this.hidden_ !== hidden) {\r\n\t\t\tthis.hidden_ = hidden;\r\n\t\t\tthis.updateVisibility(!hidden);\r\n\t\t}\r\n\t}\r\n\r\n\tget isHidden() {\r\n\t\treturn StateService.state.zoomedId != null ||\r\n\t\t\t(environment.flags.hideNavInfo && !this.host.editor &&\r\n\t\t\t\t(!StateService.state.showNavInfo && !(this.host.renderer.xr.isPresenting || StateService.state.role === RoleType.SelfService || StateService.state.role === RoleType.Embed)) &&\r\n\t\t\t\tthis.mode === NavModeType.Info);\r\n\t}\r\n\r\n\tget isAnimated() {\r\n\t\tlet isAnimated = false;\r\n\t\tconst mode = this.mode;\r\n\t\tconst important = this.item.important;\r\n\t\tswitch (mode) {\r\n\t\t\tcase NavModeType.Info:\r\n\t\t\t\tisAnimated = important ? environment.flags.navInfoImportantAnimated : environment.flags.navInfoAnimated;\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Move:\r\n\t\t\t\tisAnimated = important ? environment.flags.navMoveImportantAnimated : environment.flags.navMoveAnimated;\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Point:\r\n\t\t\t\tisAnimated = important ? environment.flags.navPointImportantAnimated : environment.flags.navPointAnimated;\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Title:\r\n\t\t\t\tisAnimated = important ? environment.flags.navTitleImportantAnimated : environment.flags.navTitleAnimated;\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Transparent:\r\n\t\t\t\tisAnimated = important ? environment.flags.navTransparentImportantAnimated : environment.flags.navTransparentAnimated;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn isAnimated;\r\n\t}\r\n\r\n\tget iconMinScale() {\r\n\t\treturn (environment.navs.iconMinScale || 1) * 0.03 * (this.isMobile ? 1.6 : 1);\r\n\t}\r\n\r\n\tget iconMaxScale() {\r\n\t\treturn (environment.navs.iconMaxScale || 1.5) * 0.03 * (this.isMobile ? 1.6 : 1);\r\n\t}\r\n\r\n\tisMobile_;\r\n\tget isMobile() {\r\n\t\treturn this.isMobile_;\r\n\t}\r\n\tset isMobile(isMobile) {\r\n\t\tif (this.isMobile_ !== isMobile) {\r\n\t\t\tthis.isMobile_ = isMobile;\r\n\t\t\tthis.setScale();\r\n\t\t}\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\t// console.log('render', this.host.worldRect.width);\r\n\t\tthis.isMobile = this.host.worldRect.width < 768;\r\n\t}\r\n\r\n\tsetScale(pow = 0) {\r\n\t\tconst icon = this.icon;\r\n\t\tif (icon) {\r\n\t\t\tconst scale = this.iconMinScale + pow * (this.iconMaxScale - this.iconMinScale);\r\n\t\t\ticon.scale.set(scale, scale, scale);\r\n\t\t}\r\n\t}\r\n\r\n\tshouldShowPanel() {\r\n\t\treturn (!this.editing && this.mode !== NavModeType.Move && this.mode !== NavModeType.Title && this.mode !== NavModeType.Wishlist && (this.mode !== NavModeType.Transparent || ModelNavComponent.isValidText(this.item.title)));\r\n\t}\r\n\r\n\tupdateVisibility(visible) {\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.visible = visible;\r\n\t\t}\r\n\t\tif (this.sphere) {\r\n\t\t\tthis.sphere.freezed = !visible;\r\n\t\t}\r\n\t\tif (!visible && this.item) {\r\n\t\t\tthis.item.showPanel = false;\r\n\t\t}\r\n\t}\r\n\r\n\tsetVisible(visible) {\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.visible = visible && !this.hidden_;\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(item, this.view);\r\n\t\tif (mode === NavModeType.Wishlist) {\r\n\t\t\titem.added = WishlistService.has({ viewId: view.id, itemId: item.id });\r\n\t\t\tthis.onCreateSprites(this.mesh, 1);\r\n\t\t}\r\n\t\tthis.editing = item.selected;\r\n\t\tthis.hidden = this.isHidden;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.nav;\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (mode === NavModeType.Wishlist) {\r\n\t\t\titem.added = WishlistService.has({ viewId: view.id, itemId: item.id });\r\n\t\t}\r\n\t\tconst isAnimated = this.isAnimated;\r\n\t\tconst nav = new THREE.Group();\r\n\t\tif (mode === NavModeType.Transparent) {\r\n\r\n\t\t\tconst opacityIdle = this.host.editor ? 0.1 : 0.0;\r\n\t\t\tconst opacityOver = 0.2;\r\n\t\t\tconst opacityDown = 0.3;\r\n\r\n\t\t\tnav.position.fromArray(item.position);\r\n\t\t\tnav.rotation.fromArray(item.rotation);\r\n\t\t\tnav.scale.fromArray(item.scale);\r\n\r\n\t\t\tconst geometry = Geometry.planeGeometry;\r\n\t\t\tconst plane = this.plane = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: opacityIdle,\r\n\t\t\t\tcolor: new THREE.Color(environment.colors.menuOverBackground),\r\n\t\t\t\ttoneMapped: false,\r\n\t\t\t}));\r\n\t\t\tplane.name = `[nav] ${item.id}`;\r\n\t\t\tplane.depthTest = false;\r\n\t\t\tnav.add(plane);\r\n\r\n\t\t\tif (isAnimated) {\r\n\t\t\t\tconst from = { pow: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tpow: 1,\r\n\t\t\t\t\tduration: 0.6,\r\n\t\t\t\t\tdelay: 0.5 + 0.1 * item.index,\r\n\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\trepeat: -1,\r\n\t\t\t\t\tyoyo: true,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tplane.material.opacity = from.pow * opacityDown;\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tplane.on('over', () => {\r\n\t\t\t\tif (!isAnimated) {\r\n\t\t\t\t\tplane.material.opacity = opacityOver;\r\n\t\t\t\t}\r\n\t\t\t\tthis.over.next(this);\r\n\t\t\t});\r\n\r\n\t\t\tplane.on('out', () => {\r\n\t\t\t\tif (!isAnimated) {\r\n\t\t\t\t\tplane.material.opacity = opacityIdle;\r\n\t\t\t\t}\r\n\t\t\t\tthis.out.next(this);\r\n\t\t\t});\r\n\r\n\t\t\tplane.on('down', () => {\r\n\t\t\t\tif (!isAnimated) {\r\n\t\t\t\t\tplane.material.opacity = opacityDown;\r\n\t\t\t\t}\r\n\t\t\t\tthis.down.next(this);\r\n\t\t\t\t// opening nav link\r\n\t\t\t\tconst item = this.item;\r\n\t\t\t\tconst link = item.firstLink;\r\n\t\t\t\tif (!this.host.editor && !this.shouldShowPanel() && link && link.href) {\r\n\t\t\t\t\tthis.shouldNavToLink = link.href;\r\n\t\t\t\t}\r\n\t\t\t\tconsole.log('ModelNavComponent.down');\r\n\t\t\t});\r\n\r\n\t\t\tplane.on('up', () => {\r\n\t\t\t\tif (!isAnimated) {\r\n\t\t\t\t\tplane.material.opacity = opacityIdle;\r\n\t\t\t\t}\r\n\t\t\t\t// opening nav link\r\n\t\t\t\tif (this.shouldNavToLink != null) {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tconst link = this.shouldNavToLink;\r\n\t\t\t\t\twindow.open(link, '_blank');\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tthis.shouldNavToLink = null;\r\n\t\t\t\t\tconst item = this.item;\r\n\t\t\t\t\tconst link = item.firstLink;\r\n\t\t\t\t\tthis.link.next({ item, link });\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t} else {\r\n\r\n\t\t\t// !! fixing normalized positions;\r\n\t\t\tconst position = new THREE.Vector3(item.position[0], item.position[1], item.position[2]);\r\n\t\t\tconst normalizedPosition = new THREE.Vector3(item.position[0], item.position[1], item.position[2]).normalize();\r\n\t\t\tif (position.distanceToSquared(normalizedPosition) < 0.0001) {\r\n\t\t\t\tposition.multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\t\t}\r\n\t\t\t// console.log('!!! fixing normalized positions', 'position', position, 'normalizedPosition', normalizedPosition, 'distanceToSquared', position.distanceToSquared(normalizedPosition));\r\n\t\t\tnav.position.copy(position);\r\n\t\t\tthis.onCreateSprites(nav);\r\n\t\t\tconst geometry = Geometry.sphereGeometry;\r\n\t\t\tconst sphere = this.sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0.0,\r\n\t\t\t\tcolor: 0x00ffff,\r\n\t\t\t\ttoneMapped: false,\r\n\t\t\t}));\r\n\t\t\tsphere.name = `[nav] ${item.id}`;\r\n\t\t\t// sphere.lookAt(Host.origin); ??\r\n\t\t\tsphere.depthTest = false;\r\n\t\t\t// sphere.renderOrder = 0;\r\n\t\t\tnav.add(sphere);\r\n\r\n\t\t\tconst from = { pow: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tpow: 1,\r\n\t\t\t\tduration: 0.7,\r\n\t\t\t\tdelay: 0.5 + 0.1 * item.index,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tthis.materials.forEach(material => {\r\n\t\t\t\t\t\tmaterial.opacity = from.pow;\r\n\t\t\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tif (isAnimated) {\r\n\t\t\t\t\t\tconst icon = this.icon;\r\n\t\t\t\t\t\tfrom.pow = 0;\r\n\t\t\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\t\t\tpow: 1,\r\n\t\t\t\t\t\t\tduration: 0.6,\r\n\t\t\t\t\t\t\tdelay: 0.5 + 0.1 * item.index,\r\n\t\t\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\t\t\trepeat: -1,\r\n\t\t\t\t\t\t\tyoyo: true,\r\n\t\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\t\tthis.setScale(from.pow);\r\n\t\t\t\t\t\t\t\ticon.material.opacity = from.pow;\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t});\r\n\r\n\t\t\tsphere.on('over', () => {\r\n\t\t\t\tthis.over.next(this);\r\n\t\t\t\tif (!isAnimated) {\r\n\t\t\t\t\tconst icon = this.icon;\r\n\t\t\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\t\tduration: 0.35,\r\n\t\t\t\t\t\tscale: this.iconMaxScale,\r\n\t\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\t\toverwrite: true,\r\n\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tsphere.on('out', () => {\r\n\t\t\t\tthis.out.next(this);\r\n\t\t\t\tif (!isAnimated) {\r\n\t\t\t\t\tconst icon = this.icon;\r\n\t\t\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\t\tduration: 0.35,\r\n\t\t\t\t\t\tscale: this.iconMinScale,\r\n\t\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\t\toverwrite: true,\r\n\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tsphere.on('down', () => {\r\n\t\t\t\tthis.down.next(this);\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(nav, item);\r\n\t\t}\r\n\t}\r\n\r\n\tonCreateSprites(mesh, opacity = 0) {\r\n\t\tthis.onRemoveSprite(this.icon);\r\n\t\tthis.onRemoveSprite(this.title);\r\n\t\tconst item = this.item;\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (mode === NavModeType.Transparent) {\r\n\t\t\tthis.materials = [];\r\n\t\t} else {\r\n\t\t\tconst map = ModelNavComponent.getTexture(mode, item);\r\n\t\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\t\tmap: map,\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\topacity: opacity,\r\n\t\t\t\ttoneMapped: false,\r\n\t\t\t\t// color: 0xff0000,\r\n\t\t\t});\r\n\t\t\tconst materials = [material];\r\n\t\t\tconst icon = this.icon = new THREE.Sprite(material);\r\n\t\t\ticon.renderOrder = environment.renderOrder.nav;\r\n\t\t\tthis.setScale();\r\n\t\t\tmesh.add(icon);\r\n\t\t\tlet titleMaterial;\r\n\t\t\tconst titleTexture = ModelNavComponent.getTitleTexture(item, mode);\r\n\t\t\tif (titleTexture) {\r\n\t\t\t\ttitleMaterial = new THREE.SpriteMaterial({\r\n\t\t\t\t\tdepthTest: false,\r\n\t\t\t\t\tdepthWrite: false,\r\n\t\t\t\t\ttransparent: true,\r\n\t\t\t\t\tmap: titleTexture,\r\n\t\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\t\topacity: opacity,\r\n\t\t\t\t\ttoneMapped: false,\r\n\t\t\t\t\t// color: 0xff0000,\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(titleTexture);\r\n\t\t\t\tconst image = titleTexture.image;\r\n\t\t\t\tconst title = this.title = new THREE.Sprite(titleMaterial);\r\n\t\t\t\tconst scale = this.iconMinScale;\r\n\t\t\t\ttitle.scale.set(scale * image.width / image.height, scale, scale);\r\n\t\t\t\ttitle.position.set(0, -3.5, 0);\r\n\t\t\t\tmesh.add(title);\r\n\t\t\t\tmaterials.push(titleMaterial);\r\n\t\t\t}\r\n\t\t\tthis.materials = materials;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoveSprite(sprite) {\r\n\t\tif (sprite) {\r\n\t\t\tif (sprite.parent) {\r\n\t\t\t\tsprite.parent.remove(sprite);\r\n\t\t\t}\r\n\t\t\tif (sprite.material.map && sprite.material.map.disposable !== false) {\r\n\t\t\t\tsprite.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tsprite.material.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tInteractive.dispose(this.sphere);\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\tthis.item = item;\r\n\t\tthis.onCreateSprites(mesh, 1);\r\n\t\tif (this.mode === NavModeType.Transparent) {\r\n\t\t\tif (item.position) {\r\n\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// const position = new THREE.Vector3().set(...item.position).normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\t\t// mesh.position.set(position.x, position.y, position.z);\r\n\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\tmesh.rotation.set(0, 0, 0);\r\n\t\t\tmesh.scale.set(1, 1, 1);\r\n\t\t}\r\n\t\t// console.log('onUpdate', item, mesh.position);\r\n\t\tthis.updateHelper();\r\n\t\t/*\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item)\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position, normal, spherical) {\r\n\t\t// console.log('ModelNavComponent.onDragMove', position, normal, spherical);\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\tthis.editing = true;\r\n\t\titem.showPanel = false;\r\n\t\tif (this.mode === NavModeType.Transparent) {\r\n\t\t\tif (spherical) {\r\n\t\t\t\tposition.normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\t\tmesh.lookAt(Host.origin);\r\n\t\t\t} else {\r\n\t\t\t\tmesh.position.set(0, 0, 0);\r\n\t\t\t\tmesh.lookAt(normal);\r\n\t\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\t\tmesh.position.add(normal.multiplyScalar(0.01));\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (spherical) {\r\n\t\t\t\tposition.normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\t} else {\r\n\t\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\t\tmesh.position.add(normal.multiplyScalar(0.01));\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\tif (this.mode === NavModeType.Transparent) {\r\n\t\t\titem.position = mesh.position.toArray();\r\n\t\t\titem.rotation = mesh.rotation.toArray();\r\n\t\t\titem.scale = mesh.scale.toArray();\r\n\t\t} else {\r\n\t\t\titem.position = mesh.position.toArray(); // new THREE.Vector3().copy(mesh.position).normalize().toArray();\r\n\t\t}\r\n\t\tthis.editing = false;\r\n\t}\r\n}\r\n\r\nModelNavComponent.RADIUS = 100;\r\n\r\nModelNavComponent.meta = {\r\n\tselector: '[model-nav]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down', 'link'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { fromEvent } from 'rxjs';\r\nimport { first, map, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport NavmapService from '../editor/navmap/navmap.service';\r\nimport PathService from '../editor/path/path.service';\r\nimport { DEBUG, environment } from '../environment';\r\nimport GtmService from '../gtm/gtm.service';\r\nimport { LabelPipe } from '../label/label.pipe';\r\nimport { Logger } from '../logger/logger';\r\nimport { MeetingId } from '../meeting/meeting-id';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { MessageService } from '../message/message.service';\r\nimport { ModalService } from '../modal/modal.service';\r\nimport { RoutePipe } from '../router/route.pipe';\r\nimport { RouterOutletStructure } from '../router/router-outlet.structure';\r\nimport { RouterService } from '../router/router.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport ToastService, { ToastPosition, ToastResolveEvent, ToastType } from '../toast/toast.service';\r\nimport TryInARModalComponent from '../try-in-ar/try-in-ar-modal.component';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { PanoramaGridView, ViewType } from '../view/view';\r\nimport { ViewService } from '../view/view.service';\r\nimport { WebhookService } from '../webhook/webhook.service';\r\nimport { WishlistService } from '../wishlist/wishlist.service';\r\nimport MediaLoader, { MediaLoaderDisposeEvent, MediaLoaderPauseEvent, MediaLoaderPlayEvent } from '../world/media/media-loader';\r\nimport ModelNavComponent from '../world/model/model-nav.component';\r\nimport VRService from '../world/vr.service';\r\nimport { AgoraChecklistService } from './agora-checklist.service';\r\nimport { CHUNK_BACKGROUND, CHUNK_COPYRIGHT, CHUNK_CREDITS, CHUNK_EMBED, CHUNK_LANGUAGE, CHUNK_LOGO, CHUNK_SELF_SERVICE_TOUR, CHUNK_SMART_DEVICE, CHUNK_VIRTUAL_TOUR } from './agora.component.chunks';\r\nimport AgoraService from './agora.service';\r\nimport { AgoraStatus, MessageType, UIMode } from './agora.types';\r\n\r\nexport default class AgoraComponent extends Component {\r\n\r\n\tget meetingUrl() {\r\n\t\tif (!this.meetingUrl_) {\r\n\t\t\tthis.meetingUrl_ = new MeetingUrl();\r\n\t\t}\r\n\t\treturn this.meetingUrl_;\r\n\t}\r\n\r\n\tget isVirtualTourUser() {\r\n\t\treturn [RoleType.Publisher, RoleType.Attendee, RoleType.Streamer, RoleType.Viewer].indexOf(StateService.state.role) !== -1;\r\n\t}\r\n\r\n\tget isEmbed() {\r\n\t\treturn this.route && this.route.params.mode === 'embed';\r\n\t}\r\n\r\n\tget isSelfServiceTour() {\r\n\t\treturn this.route && this.route.params.mode === 'selfServiceTour';\r\n\t}\r\n\r\n\tget isNavigable() {\r\n\t\tconst embedViewId = this.meetingUrl.embedViewId;\r\n\t\tconst navigable = embedViewId == null;\r\n\t\treturn navigable;\r\n\t}\r\n\r\n\tget isBackButtonVisible() {\r\n\t\treturn this.view && (this.view.type.name === ViewType.Media.name || this.view.type.name === ViewType.Model.name);\r\n\t}\r\n\r\n\tget isSelfServiceProposition() {\r\n\t\treturn StateService.state.role === RoleType.SelfService && environment.flags.selfServiceProposition;\r\n\t}\r\n\r\n\tget isSelfServiceSupport() {\r\n\t\treturn StateService.state.role === RoleType.Publisher && environment.flags.selfServiceProposition && this.meetingUrl.support;\r\n\t}\r\n\r\n\tget showNavInfoToggler() {\r\n\t\treturn environment.flags.hideNavInfo && this.state.mode !== UIMode.LiveMeeting && this.view && ModelNavComponent.hasNavInfo(this.view);\r\n\t}\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\t// uiClass[this.state.mode] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\tuiClass.remotes = this.state.mode === UIMode.LiveMeeting;\r\n\t\tuiClass.remoteScreen = this.remoteScreen != null && !this.hasScreenViewItem;\r\n\t\tuiClass.locked = this.locked;\r\n\t\t// uiClass.media = !uiClass.remotes && this.media;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tget remoteClass() {\r\n\t\treturn `group--remote--${Math.min(9, this.remotes.length)}`;\r\n\t}\r\n\r\n\tget controlled() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling !== StateService.state.uid);\r\n\t}\r\n\r\n\tget controlling() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling === StateService.state.uid);\r\n\t}\r\n\r\n\tget silencing() {\r\n\t\treturn StateService.state.silencing;\r\n\t}\r\n\r\n\tget silenced() {\r\n\t\treturn (StateService.state.silencing && StateService.state.role === RoleType.Streamer);\r\n\t}\r\n\r\n\tget spyed() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying === StateService.state.uid);\r\n\t}\r\n\r\n\tget spying() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying !== StateService.state.uid);\r\n\t}\r\n\r\n\tget locked() {\r\n\t\treturn this.controlled || this.spying;\r\n\t}\r\n\r\n\tget remoteScreen() {\r\n\t\treturn this.remoteScreen_;\r\n\t}\r\n\tset remoteScreen(remoteScreen) {\r\n\t\tif (this.remoteScreen_ !== remoteScreen) {\r\n\t\t\tthis.remoteScreen_ = remoteScreen;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t\t}, 1);\r\n\t\t}\r\n\t}\r\n\r\n\tget pathViews() {\r\n\t\treturn ViewService.pathViews;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// Logger.log('AgoraComponent.onInit', this.host);\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.route = this.host ? this.host.route : null;\r\n\t\tthis.state = {};\r\n\t\tthis.hosted = null;\r\n\t\tthis.view = null;\r\n\t\tthis.previousView = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.screen = null;\r\n\t\tthis.remoteScreen_ = null;\r\n\t\tthis.navmaps = [];\r\n\t\tthis.navmap = null;\r\n\t\t// this.media = null;\r\n\t\tthis.hasScreenViewItem = false;\r\n\t\tthis.remotes = [];\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tgetName(user) {\r\n\t\treturn StateService.state.name || MeetingUrl.getName(user);\r\n\t}\r\n\r\n\tgetLinkRole() {\r\n\t\tlet linkRole = null;\r\n\t\tif (this.isSelfServiceTour) {\r\n\t\t\tlinkRole = RoleType.SelfService;\r\n\t\t\treturn linkRole;\r\n\t\t}\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\tconst match = (meetingUrl.link || '').match(/\\d{9}-(\\d{4})-\\d{13}/);\r\n\t\tif (match) {\r\n\t\t\tconst index = parseInt(match[1]);\r\n\t\t\tlinkRole = Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\t\treturn i === index ? RoleType[c] : p;\r\n\t\t\t}, null);\r\n\t\t}\r\n\t\treturn linkRole;\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tif (this.isEmbed) {\r\n\t\t\tUserService.temporaryUser$(RoleType.Embed).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(user => {\r\n\t\t\t\tthis.initWithUser(user);\r\n\t\t\t});\r\n\t\t} else if (this.isSelfServiceTour) {\r\n\t\t\tUserService.overrideUser$(RoleType.SelfService).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(user => {\r\n\t\t\t\tthis.initWithUser(user);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tUserService.me$().pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(user => {\r\n\t\t\t\tthis.initWithUser(user);\r\n\t\t\t\t// this.userGuard(user);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tuserGuard(user) {\r\n\t\t// Logger.log('AgoraComponent.userGuard', user);\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || user.type === linkRole)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tuserGuardRedirect(user) {\r\n\t\t// Logger.log('AgoraComponent.userGuardRedirect', user);\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || linkRole === user.type)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else if (linkRole === RoleType.Publisher || linkRole === RoleType.Attendee) {\r\n\t\t\tRouterService.setRouterLink(RoutePipe.transform(':lang.access'));\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tsetNextStatus() {\r\n\t\tlet status = AgoraStatus.Idle;\r\n\t\tconst state = StateService.state;\r\n\t\tif (state.role === RoleType.SmartDevice) {\r\n\t\t\tstate.name = state.name || 'Smart Device';\r\n\t\t}\r\n\t\tif (!state.checklist) {\r\n\t\t\tstatus = AgoraStatus.Checklist;\r\n\t\t} else if (!state.link) {\r\n\t\t\tstatus = AgoraStatus.Link;\r\n\t\t} else if (!state.user.id && (state.role === RoleType.Publisher || state.role === RoleType.Attendee)) {\r\n\t\t\tstatus = AgoraStatus.Login;\r\n\t\t} else if (!state.name) {\r\n\t\t\tstatus = AgoraStatus.Name;\r\n\t\t} else if (state.role !== RoleType.Viewer && state.role !== RoleType.SmartDevice) {\r\n\t\t\tstatus = AgoraStatus.Device;\r\n\t\t} else {\r\n\t\t\tstatus = AgoraStatus.ShouldConnect;\r\n\t\t}\r\n\t\tStateService.patchState({ status });\r\n\t\treturn status;\r\n\t}\r\n\r\n\tgetPathId() {\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\tlet pathId = meetingUrl.pathId;\r\n\t\tif (pathId) {\r\n\t\t\t// Logger.log('AgoraComponent.getPathId', pathId);\r\n\t\t\treturn parseInt(pathId);\r\n\t\t}\r\n\t\tconst link = meetingUrl.link;\r\n\t\tif (link) {\r\n\t\t\tconst meetingId = new MeetingId(link);\r\n\t\t\tpathId = meetingId.pathId;\r\n\t\t}\r\n\t\t// Logger.log('AgoraComponent.getPathId', pathId);\r\n\t\treturn pathId;\r\n\t}\r\n\r\n\tinitWithUser(user) {\r\n\t\t// Logger.log('AgoraComponent.initWithUser', user);\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\tconst link = meetingUrl.link;\r\n\t\tconst pathId = this.getPathId();\r\n\t\tconst role = this.getLinkRole() || (user ? user.type : null);\r\n\t\tswitch (role) {\r\n\t\t\tcase RoleType.SelfService:\r\n\t\t\t\tif (!user || (user.type !== RoleType.SelfService && user.type !== RoleType.Publisher)) {\r\n\t\t\t\t\tRouterService.setRouterLink(RoutePipe.transform(':lang.access'));\r\n\t\t\t\t\treturn;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// forcing role type to RoleType.SelfService\r\n\t\t\t\t\tuser = Object.assign({}, user, { type: RoleType.SelfService });\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tuser = user || { type: role };\r\n\t\t\t\tif (role !== user.type) {\r\n\t\t\t\t\tuser = { type: role };\r\n\t\t\t\t}\r\n\t\t}\r\n\t\t// Logger.log('AgoraComponent.initWithUser', role, user);\r\n\t\tconst mode = UserService.getMode(role);\r\n\t\tconst name = this.getMeetingName(user);\r\n\t\t// const name = meetingUrl.name || this.getName(user);\r\n\t\tconst checklist = null;\r\n\t\tconst hosted = role === RoleType.Publisher ? true : false;\r\n\t\tconst live = (role === RoleType.SelfService || role === RoleType.Embed || DEBUG) ? false : true;\r\n\t\tconst navigable = this.isNavigable;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\tmode: mode,\r\n\t\t\tname: name,\r\n\t\t\tchecklist: checklist,\r\n\t\t\tpathId: pathId,\r\n\t\t\tlink: link,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: AgoraStatus.Idle,\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: false,\r\n\t\t\tcontrolling: false,\r\n\t\t\tspying: false,\r\n\t\t\tsilencing: false,\r\n\t\t\thosted: hosted,\r\n\t\t\tlive: live,\r\n\t\t\tnavigable: navigable,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t\tshowNavInfo: true,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log(state);\r\n\t\t\tthis.locked ? document.body.classList.add('locked') : document.body.classList.remove('locked');\r\n\t\t});\r\n\t\tthis.initAgora();\r\n\t}\r\n\r\n\tgetMeetingName(user) {\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\tlet name = null;\r\n\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\tname = meetingUrl.firstName && meetingUrl.lastName ? `${meetingUrl.firstName} ${meetingUrl.lastName}` : null;\r\n\t\t} else {\r\n\t\t\tname = meetingUrl.name ? meetingUrl.name : null;\r\n\t\t}\r\n\t\tif (!name && user.firstName && user.lastName) {\r\n\t\t\tname = `${user.firstName} ${user.lastName}`;\r\n\t\t}\r\n\t\treturn name;\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn ViewService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\t// Logger.log('AgoraComponent.viewObserver$', 'pathId', StateService.state.pathId);\r\n\t\t\t\treturn PathService.getCurrentPath$(StateService.state.pathId).pipe(\r\n\t\t\t\t\tswitchMap(path => {\r\n\t\t\t\t\t\treturn ViewService.hostedView$(data, path);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t\t/*\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\t*/\r\n\t\t\tmap((view) => {\r\n\t\t\t\t// Logger.log('AgoraComponent.viewObserver$', view);\r\n\t\t\t\t// !!! move navToView to user action?\r\n\t\t\t\tif (this.agora) {\r\n\t\t\t\t\tthis.agora.navToView(view.id, view.keepOrientation, view.useLastOrientation);\r\n\t\t\t\t}\r\n\t\t\t\tthis.previousView = this.view;\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.setNavmap(view);\r\n\t\t\t\tthis.hasScreenViewItem = view.items.find(x => MediaLoader.isPublisherScreen(x) || MediaLoader.isAttendeeScreen(x)) != null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tconst state = this.state;\r\n\t\t\t\tGtmService.push({\r\n\t\t\t\t\taction: 'b-here-view',\r\n\t\t\t\t\tviewId: view.id,\r\n\t\t\t\t\tuserType: state.role, // aggiunto\r\n\t\t\t\t});\r\n\t\t\t\treturn view;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tthis.loadNavmaps();\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(view => {\r\n\t\t\t// Logger.log('AgoraComponent.load', view);\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback();\r\n\t\t\t\tcallback = null;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tloadNavmaps() {\r\n\t\tif (environment.flags.navmaps) {\r\n\t\t\tNavmapService.navmapGet$().pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(navmaps => {\r\n\t\t\t\tthis.navmaps = navmaps;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tsetNavmap(view) {\r\n\t\tconst navmaps = this.navmaps;\r\n\t\tconst navmap = (navmaps || []).find(x => (x.items || []).find(i => i.viewId === view.id) != null) || null;\r\n\t\t// Logger.log('AgoraComponent.setNavmap', navmap);\r\n\t\tthis.navmap = navmap;\r\n\t}\r\n\r\n\ttoggleNavmap() {\r\n\t\tStateService.patchState({ showNavmap: !StateService.state.showNavmap });\r\n\t}\r\n\r\n\tonNavmapItem(item) {\r\n\t\tStateService.patchState({ showNavmap: false });\r\n\t\tthis.onNavTo(item);\r\n\t}\r\n\r\n\tloadAndConnect(preferences) {\r\n\t\tthis.load(() => {\r\n\t\t\tthis.connect(preferences);\r\n\t\t});\r\n\t}\r\n\r\n\tinitAgora() {\r\n\t\tlet agora = null;\r\n\t\tif (this.state.role === RoleType.SelfService || this.state.role === RoleType.Embed || DEBUG) {\r\n\t\t\tthis.load(() => {\r\n\t\t\t\tStateService.patchState({ status: AgoraStatus.Connected, hosted: true });\r\n\t\t\t});\r\n\t\t\tthis.checkSelfServiceProposition();\r\n\t\t\tthis.checkSelfServiceAudio();\r\n\t\t} else {\r\n\t\t\tAgoraChecklistService.isChecked$().pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(checked => {\r\n\t\t\t\tStateService.patchState({ checklist: checked });\r\n\t\t\t\tagora = this.agora = AgoraService.getSingleton();\r\n\t\t\t\tconst role = this.getLinkRole();\r\n\t\t\t\tconst status = this.setNextStatus();\r\n\t\t\t\t// Logger.log('AgoraComponent.initAgora', status, role);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.local$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(local => {\r\n\t\t\t// Logger.log('AgoraComponent.initAgora', 'StreamService.local$', local);\r\n\t\t\tthis.local = local;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.screen$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(screen => {\r\n\t\t\t// Logger.log('AgoraComponent.initAgora', 'StreamService.screen$', screen);\r\n\t\t\tif (this.screen === this.remoteScreen) {\r\n\t\t\t\tthis.remoteScreen = null;\r\n\t\t\t}\r\n\t\t\tthis.screen = screen;\r\n\t\t\tthis.remoteScreen = screen || this.remoteScreen;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.orderedRemotes$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(remotes => {\r\n\t\t\tthis.remotes = [];\r\n\t\t\tthis.remoteScreen = this.screen;\r\n\t\t\tremotes.forEach(x => {\r\n\t\t\t\tif (x.clientInfo && x.clientInfo.screenUid === x.getId()) {\r\n\t\t\t\t\tthis.remoteScreen = x;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.remotes.push(x);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// Logger.log('AgoraComponent.initAgora', 'StreamService.orderedRemotes$', this.remotes, this.remoteScreen, remotes.map(x => `${x.clientInfo ? x.clientInfo.uid : 'null'}-${x.clientInfo ? x.clientInfo.screenUid : 'null'}`).join(','));\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t/*\r\n\t\tMediaLoader.events$.pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\tthis.media = event.loader;\r\n\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t} else if (event instanceof MediaLoaderDisposeEvent) {\r\n\t\t\t\t\tif (this.media === event.loader) {\r\n\t\t\t\t\t\tthis.media = null;\r\n\t\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// Logger.log('AgoraComponent.initAgora', 'MediaLoader.events$', event);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t*/\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\t// Logger.log('AgoraComponent.initAgora', 'MessageService.out$', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.ChannelMembers:\r\n\t\t\t\t\tif (this.isSelfServiceSupport) {\r\n\t\t\t\t\t\tconst members = message.members;\r\n\t\t\t\t\t\t// Logger.log('AgoraComponent.initAgora', 'MessageService.out$', members, members.length);\r\n\t\t\t\t\t\tif (members.length > 0) {\r\n\t\t\t\t\t\t\tToastService.open$({\r\n\t\t\t\t\t\t\t\tmessage: LabelPipe.transform('bhere_support_request_sent'),\r\n\t\t\t\t\t\t\t\ttype: ToastType.Alert, position: ToastPosition.BottomRight,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tMessageService.send({ type: MessageType.SupportRequest });\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tToastService.open$({\r\n\t\t\t\t\t\t\t\tmessage: LabelPipe.transform('bhere_support_request_leaved'),\r\n\t\t\t\t\t\t\t\ttype: ToastType.Alert, position: ToastPosition.BottomRight,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.SupportRequest:\r\n\t\t\t\t\tif (this.isSelfServiceProposition) {\r\n\t\t\t\t\t\tthis.openSupportRequestDialog(message.clientInfo);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.SupportRequestAccepted:\r\n\t\t\t\t\tToastService.open$({\r\n\t\t\t\t\t\tmessage: LabelPipe.transform('bhere_support_request_accepted'),\r\n\t\t\t\t\t\ttype: ToastType.Alert, position: ToastPosition.BottomRight,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.SupportRequestRejected:\r\n\t\t\t\t\tToastService.open$({\r\n\t\t\t\t\t\tmessage: LabelPipe.transform('bhere_support_request_rejected'),\r\n\t\t\t\t\t\ttype: ToastType.Alert, position: ToastPosition.BottomRight,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t/*\r\n\t\t\tcase MessageType.RequestPeerInfo:\r\n\t\t\t\t// Logger.log('AgoraComponent.initAgora', 'MessageService.out$', message);\r\n\t\t\t\tmessage.type = MessageType.RequestPeerInfoResult;\r\n\t\t\t\tmessage.clientInfo = {\r\n\t\t\t\t\trole: StateService.state.role,\r\n\t\t\t\t\tname: StateService.state.name,\r\n\t\t\t\t\tuid: StateService.state.uid,\r\n\t\t\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t\t\t\tcontrollingId: StateService.state.controlling,\r\n\t\t\t\t\tmode: StateService.state.mode,\r\n\t\t\t\t};\r\n\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\tbreak;\r\n\t\t\t\t*/\r\n\t\t\t\tcase MessageType.RemoteSilencing:\r\n\t\t\t\t\tStateService.patchState({ silencing: message.silencing });\r\n\t\t\t\t\tthis.setAudio(message.silencing);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.NavToView:\r\n\t\t\t\t\tthis.onRemoteNavTo(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.Mode:\r\n\t\t\t\t\tStateService.patchState({ mode: message.mode });\r\n\t\t\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.NavInfo:\r\n\t\t\t\t\tthis.hidePanels();\r\n\t\t\t\t\tStateService.patchState({ showNavInfo: message.showNavInfo });\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.AddLike:\r\n\t\t\t\t\tViewService.setViewLike$(message).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t).subscribe(view => this.showLove(view));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tif (!StateService.state.chat) {\r\n\t\t\t\t\t\tStateService.patchState({ chatDirty: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\tif (this.agora) {\r\n\t\t\t\tthis.agora.sendMessage(message);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.fullscreen$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t\tif (this.agora && StateService.state.status === AgoraStatus.ShouldConnect) {\r\n\t\t\tthis.loadAndConnect();\r\n\t\t}\r\n\t}\r\n\r\n\tonChecked(checklist) {\r\n\t\t// Logger.log('AgoraComponent.onChecked', checklist);\r\n\t\tStateService.patchState({ checklist: true });\r\n\t\tthis.setNextStatus();\r\n\t}\r\n\r\n\tonLink(link) {\r\n\t\tconst meetingId = new MeetingId(link);\r\n\t\t// Logger.log('AgoraComponent.onLink', meetingId);\r\n\t\tconst pathId = meetingId.pathId;\r\n\t\tconst role = this.getLinkRole();\r\n\t\tconst mode = UserService.getMode(role);\r\n\t\tconst user = StateService.state.user;\r\n\t\tif ((role === RoleType.Publisher || role === RoleType.Attendee) && (!user.id || user.type !== role)) {\r\n\t\t\tStateService.patchState({ link, pathId, role, mode, status: AgoraStatus.Login });\r\n\t\t} else if (StateService.state.name) {\r\n\t\t\tif (role === RoleType.Viewer || role === RoleType.SmartDevice) {\r\n\t\t\t\tStateService.patchState({ link, pathId, role, mode });\r\n\t\t\t\tthis.loadAndConnect();\r\n\t\t\t} else {\r\n\t\t\t\tStateService.patchState({ link, pathId, role, mode, status: AgoraStatus.Device });\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ link, pathId, role, mode, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonLogin(user) {\r\n\t\tconst name = this.getName(user);\r\n\t\tif (name) {\r\n\t\t\tStateService.patchState({ user, name, status: AgoraStatus.Device });\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ user, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonName(name) {\r\n\t\tif (StateService.state.role === RoleType.Viewer || StateService.state.role === RoleType.SmartDevice) {\r\n\t\t\tStateService.patchState({ name });\r\n\t\t\tthis.loadAndConnect();\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ name, status: AgoraStatus.Device });\r\n\t\t}\r\n\t}\r\n\r\n\tonEnter(preferences) {\r\n\t\tthis.loadAndConnect(preferences);\r\n\t}\r\n\r\n\tconnect(preferences) {\r\n\t\t// Logger.log('AgoraComponent.connect', preferences);\r\n\t\tthis.agora.connect$(preferences).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t\tconst state = this.state;\r\n\t\t// Logger.log('AgoraComponent.connect', this.state.role);\r\n\t\tif (state.role === RoleType.SelfService) {\r\n\t\t\tGtmService.push({\r\n\t\t\t\taction: 'b-here-tour',\r\n\t\t\t\tuserType: state.role,\r\n\t\t\t});\r\n\t\t} else if (state.role === RoleType.Embed) {\r\n\t\t\tGtmService.push({\r\n\t\t\t\taction: 'b-here-embed',\r\n\t\t\t\tuserType: state.role,\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tconst meetingUrl = new MeetingUrl();\r\n\t\t\tconst sharedMeetingId = state.link.replace(/-\\d+-/, '-');\r\n\t\t\tconst log = {\r\n\t\t\t\tmeetingId: state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tuserType: state.role,\r\n\t\t\t};\r\n\t\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\t\t// !!! update server side logic to use extended user info\r\n\t\t\t\tlog.firstName = meetingUrl.firstName;\r\n\t\t\t\tlog.lastName = meetingUrl.lastName;\r\n\t\t\t\tlog.email = meetingUrl.email;\r\n\t\t\t} else {\r\n\t\t\t\tlog.fullName = state.name;\r\n\t\t\t}\r\n\t\t\t// Logger.log('AgoraComponent.connect', log);\r\n\t\t\tUserService.log$(log).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe();\r\n\t\t\t// do not share user data in gtm\r\n\t\t\tGtmService.push({\r\n\t\t\t\taction: 'b-here-meeting',\r\n\t\t\t\tmeetingId: state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tuserType: state.role,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.leaveChannel().then(() => {\r\n\t\t\t\t// StateService.patchState({ status: AgoraStatus.Disconnected, connected: false });\r\n\t\t\t\t// window.location.href = window.location.href;\r\n\t\t\t\t// window.location.replace(window.location.href);\r\n\t\t\t\twindow.location.reload();\r\n\t\t\t}, console.log);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ connecting: false, connected: false });\r\n\t\t}\r\n\t}\r\n\r\n\tonNavTo(item) {\r\n\t\tconst viewId = item.viewId;\r\n\t\tconst view = this.pathViews.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\t// Logger.log('AgoraComponent.onNavTo', item, view);\r\n\t\t\tViewService.action = { viewId, keepOrientation: item.keepOrientation, useLastOrientation: item.useLastOrientation };\r\n\t\t\tthis.onHandleHook(view, item);\r\n\t\t}\r\n\t}\r\n\r\n\tonNavLink(event) {\r\n\t\t// Logger.log('AgoraComponent.onNavLink', event.link.href);\r\n\t\tModalService.open$({ iframe: event.link.href }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(_ => {\r\n\t\t\tMessageService.send({\r\n\t\t\t\ttype: MessageType.NavLinkClose,\r\n\t\t\t\titemId: event.item.id,\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tonRemoteNavTo(message) {\r\n\t\tconst viewId = message.viewId;\r\n\t\tconst gridIndex = message.gridIndex;\r\n\t\tif (viewId && ViewService.viewId !== viewId) {\r\n\t\t\tconst view = this.pathViews.find(x => x.id === viewId);\r\n\t\t\tif (view) {\r\n\t\t\t\t// Logger.log('AgoraComponent.onRemoteNavTo', message, view);\r\n\t\t\t\tViewService.action = { viewId, keepOrientation: message.keepOrientation, useLastOrientation: message.useLastOrientation };\r\n\t\t\t\tif (gridIndex != null && view instanceof PanoramaGridView) {\r\n\t\t\t\t\tview.index = gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// Logger.log('AgoraComponent.onRemoteNavTo', viewId, gridIndex);\r\n\t\t}\r\n\t}\r\n\r\n\tonHandleHook(view, item) {\r\n\t\tswitch (item.hook) {\r\n\t\t\tcase 'ToggleWishlist':\r\n\t\t\t\t{\r\n\t\t\t\t\tconst payload = { viewId: view.id, itemId: item.id };\r\n\t\t\t\t\tWishlistService.toggle$(payload).pipe(\r\n\t\t\t\t\t\tswitchMap(items => {\r\n\t\t\t\t\t\t\tpayload.added = WishlistService.has(payload);\r\n\t\t\t\t\t\t\treturn WebhookService.send$(item.hook, payload, item.extra);\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t).subscribe(response => {\r\n\t\t\t\t\t\tLogger.log('AgoraComponent.onHandleHook', response);\r\n\t\t\t\t\t\titem.added = payload.added;\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// !!! why locally?\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleCamera();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleAudio();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t\t}\r\n\t}\r\n\r\n\tsetAudio(audioMuted) {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.setAudio(audioMuted);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ audioMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleScreen();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ screen: !this.state.screen });\r\n\t\t}\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tconst volumeMuted = !this.state.volumeMuted;\r\n\t\tStateService.patchState({ volumeMuted });\r\n\t\tconst selfServiceAudio = this.selfServiceAudio;\r\n\t\tif (selfServiceAudio) {\r\n\t\t\tselfServiceAudio.volume = volumeMuted ? 0 : 0.5;\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleMode() {\r\n\t\tif (this.agora && StateService.state.role === RoleType.Publisher) {\r\n\t\t\tthis.agora.toggleMode();\r\n\t\t} else {\r\n\t\t\tconst mode = this.state.mode === UIMode.VirtualTour ? UIMode.LiveMeeting : UIMode.VirtualTour;\r\n\t\t\tStateService.patchState({ mode });\r\n\t\t\t// this.patchState({ mode });\r\n\t\t}\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\ttoggleFullScreen() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst fullScreen = !this.state.fullScreen;\r\n\t\tif (fullScreen) {\r\n\t\t\tif (node.requestFullscreen) {\r\n\t\t\t\tnode.requestFullscreen();\r\n\t\t\t} else if (node.webkitRequestFullscreen) {\r\n\t\t\t\tnode.webkitRequestFullscreen();\r\n\t\t\t} else if (node.msRequestFullscreen) {\r\n\t\t\t\tnode.msRequestFullscreen();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (document.exitFullscreen) {\r\n\t\t\t\tdocument.exitFullscreen();\r\n\t\t\t} else if (document.webkitExitFullscreen) {\r\n\t\t\t\tdocument.webkitExitFullscreen();\r\n\t\t\t} else if (document.msExitFullscreen) {\r\n\t\t\t\tdocument.msExitFullscreen();\r\n\t\t\t}\r\n\t\t}\r\n\t\t// StateService.patchState({ fullScreen });\r\n\t}\r\n\r\n\tfullscreen$() {\r\n\t\treturn fromEvent(document, 'fullscreenchange').pipe(\r\n\t\t\ttap(_ => {\r\n\t\t\t\tconst fullScreen = document.fullscreenElement != null;\r\n\t\t\t\t// Logger.log('AgoraComponent.fullscreen$', fullScreen);\r\n\t\t\t\tStateService.patchState({ fullScreen });\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tStateService.patchState({ chat: !StateService.state.chat, chatDirty: false });\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tStateService.patchState({ chat: false });\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\ttoggleNavInfo() {\r\n\t\tthis.hidePanels();\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleNavInfo();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ showNavInfo: !this.state.showNavInfo });\r\n\t\t}\r\n\t}\r\n\r\n\tonBack() {\r\n\t\t// Logger.log('AgoraCompoent.onBack');\r\n\t\tif (this.previousView && this.view && this.previousView.id !== this.view.id) {\r\n\t\t\tViewService.action = { viewId: this.previousView.id, useLastOrientation: true };\r\n\t\t}\r\n\t}\r\n\r\n\thidePanels() {\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t}\r\n\r\n\tonToggleControl(remoteId) {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleControl(remoteId);\r\n\t\t} else {\r\n\t\t\tconst controlling = this.state.controlling === remoteId ? null : remoteId;\r\n\t\t\tthis.patchState({ controlling, spying: false });\r\n\t\t}\r\n\t}\r\n\r\n\tonToggleSilence() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleSilence();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ silencing: !this.state.silencing });\r\n\t\t}\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleSpy(remoteId);\r\n\t\t} else {\r\n\t\t\tconst spying = this.state.spying === remoteId ? null : remoteId;\r\n\t\t\tthis.patchState({ spying, controlling: false });\r\n\t\t}\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tViewService.viewLike$(this.view).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe((view) => {\r\n\t\t\tif (view) {\r\n\t\t\t\tthis.view.liked = true; // view.liked;\r\n\t\t\t\tthis.showLove(view);\r\n\t\t\t\t// this.view.likes = view.likes;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t\tMessageService.send({\r\n\t\t\t\t\ttype: MessageType.AddLike,\r\n\t\t\t\t\tviewId: this.view.id,\r\n\t\t\t\t\tlikes: this.view.likes,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tif (this.platform === DevicePlatform.IOS || this.platform === DevicePlatform.Android) {\r\n\t\t\tTryInARModalComponent.openInAR(this.view);\r\n\t\t} else {\r\n\t\t\tModalService.open$({ template: TryInARModalComponent.chunk(), data: this.view }).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tcheckSelfServiceProposition() {\r\n\t\t// self service proposition\r\n\t\tconst isSelfServiceProposition = this.isSelfServiceProposition;\r\n\t\t// Logger.log('AgoraComponent.checkSelfServiceProposition', isSelfServiceProposition);\r\n\t\tif (isSelfServiceProposition) {\r\n\t\t\tAgoraChecklistService.check$().pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\tconst meetingId = new MeetingId({ pathId: StateService.state.pathId });\r\n\t\t\t\tconst meetingIdRoles = meetingId.toRoles();\r\n\t\t\t\tconst meetingUrl = new MeetingUrl({ link: meetingIdRoles.id, support: true });\r\n\t\t\t\tconst href = window.location.origin + meetingUrl.toGuidedTourUrl();\r\n\t\t\t\tLogger.log('AgoraComponent.checkSelfServiceProposition', href);\r\n\t\t\t\tUserService.selfServiceSupportRequest$(StateService.state.user, meetingIdRoles.id, href).pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(_ => {\r\n\t\t\t\t\tconst name = this.getName(StateService.state.user);\r\n\t\t\t\t\tStateService.patchState({ checklist: true, link: meetingIdRoles.idSelfService, name });\r\n\t\t\t\t\tthis.agora = AgoraService.getSingleton();\r\n\t\t\t\t\tthis.connect();\r\n\t\t\t\t});\r\n\t\t\t}, error => {\r\n\t\t\t\tLogger.error('AgoraComponent.checkSelfServiceProposition.error', error);\r\n\t\t\t\t/*\r\n\t\t\t\tUserService.selfServiceTourSupportFailedRequest$(StateService.state.user).pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe();\r\n\t\t\t\t*/\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tcheckSelfServiceAudio() {\r\n\t\tif (StateService.state.role === RoleType.SelfService && environment.selfServiceAudio) {\r\n\t\t\tconst selfServiceAudio = document.createElement('audio');\r\n\t\t\tselfServiceAudio.setAttribute('playsinline', 'true');\r\n\t\t\tselfServiceAudio.setAttribute('autoplay', 'true');\r\n\t\t\tselfServiceAudio.setAttribute('loop', 'true');\r\n\t\t\tselfServiceAudio.volume = 0.5;\r\n\t\t\tselfServiceAudio.src = environment.getPath(environment.selfServiceAudio);\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tnode.parentNode.appendChild(selfServiceAudio);\r\n\t\t\tthis.selfServiceAudio = selfServiceAudio;\r\n\t\t\tMediaLoader.events$.pipe(\r\n\t\t\t\ttap(event => {\r\n\t\t\t\t\t// Logger.log('AgoraComponent.checkSelfServiceAudio', 'MediaLoader.event$', event);\r\n\t\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\t\tselfServiceAudio.pause();\r\n\t\t\t\t\t\t// selfServiceAudio.volume = 0;\r\n\t\t\t\t\t} else if (event instanceof MediaLoaderPauseEvent || event instanceof MediaLoaderDisposeEvent) {\r\n\t\t\t\t\t\tselfServiceAudio.play();\r\n\t\t\t\t\t\t// selfServiceAudio.volume = 0.5;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe();\r\n\t\t}\r\n\t}\r\n\r\n\topenSupportRequestDialog(clientInfo) {\r\n\t\tToastService.open$({\r\n\t\t\tmessage: LabelPipe.transform('bhere_support_request_dialog'),\r\n\t\t\tacceptMessage: LabelPipe.transform('bhere_support_request_dialog_accept'),\r\n\t\t\trejectMessage: LabelPipe.transform('bhere_support_request_dialog_reject'),\r\n\t\t\ttype: ToastType.Dialog, position: ToastPosition.BottomRight,\r\n\t\t}).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ToastResolveEvent) {\r\n\t\t\t\tMessageService.send({ type: MessageType.SupportRequestAccepted });\r\n\t\t\t\tconst name = StateService.state.name;\r\n\t\t\t\tconst meetingId = new MeetingId(StateService.state.link);\r\n\t\t\t\tmeetingId.role = RoleType.Streamer;\r\n\t\t\t\tconst options = { link: meetingId.toString() };\r\n\t\t\t\tif (environment.flags.useExtendedUserInfo) {\r\n\t\t\t\t\tconst user = StateService.state.user;\r\n\t\t\t\t\toptions.firstName = user.firstName;\r\n\t\t\t\t\toptions.lastName = user.lastName;\r\n\t\t\t\t\toptions.email = user.email;\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.name = name;\r\n\t\t\t\t}\r\n\t\t\t\tconst meetingUrl = new MeetingUrl(options);\r\n\t\t\t\tconst href = meetingUrl.toGuidedTourUrl();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\twindow.location.href = href;\r\n\t\t\t\t}, 1000);\r\n\t\t\t} else {\r\n\t\t\t\tMessageService.send({ type: MessageType.SupportRequestRejected });\r\n\t\t\t}\r\n\t\t});\r\n\t\t/*\r\n\t\tModalService.open$({ template: SupportRequestModalComponent.chunk(), data: clientInfo }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tMessageService.send({ type: MessageType.SupportRequestAccepted });\r\n\t\t\t\tconst name = StateService.state.name;\r\n\t\t\t\tconst meetingId = new MeetingId(StateService.state.link);\r\n\t\t\t\tmeetingId.role = RoleType.Streamer;\r\n\t\t\t\tconst meetingUrl = new MeetingUrl({ link: meetingId.toString(), name });\r\n\t\t\t\tconst href = meetingUrl.toGuidedTourUrl();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\twindow.location.href = href;\r\n\t\t\t\t}, 1000);\r\n\t\t\t} else {\r\n\t\t\t\tMessageService.send({ type: MessageType.SupportRequestRejected });\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\t/*\r\n\tonPrevent(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopImmediatePropagation();\r\n\t}\r\n\t*/\r\n}\r\n\r\nAgoraComponent.meta = {\r\n\tselector: '[agora-component]',\r\n\thosts: { host: RouterOutletStructure },\r\n\ttemplate: /* html */`\r\n\t<div class=\"page page--agora\">\r\n\t\t${CHUNK_BACKGROUND}\r\n\t\t<!-- Status Checklist -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'checklist'\" [agora-checklist] (checked)=\"onChecked($event)\"></div>\r\n\t\t<!-- Status Link -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'link'\" [agora-link] (link)=\"onLink($event)\"></div>\r\n\t\t<!-- Status Login -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'login'\" [agora-login] (login)=\"onLogin($event)\"></div>\r\n\t\t<!-- Status Name -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'name' || (state.status == 'disconnected' && state.role === 'viewer')\" [agora-name] (name)=\"onName($event)\"></div>\r\n\t\t<!-- Status Device -->\r\n\t\t<div class=\"ui ui--info\" *if=\"state.status == 'device' || (state.status == 'disconnected' && state.role !== 'viewer')\" [agora-device] (enter)=\"onEnter($event)\"></div>\r\n\t\t${CHUNK_VIRTUAL_TOUR}\r\n\t\t${CHUNK_SMART_DEVICE}\r\n\t\t${CHUNK_SELF_SERVICE_TOUR}\r\n\t\t${CHUNK_EMBED}\r\n\t\t<header>\r\n\t\t\t${CHUNK_LOGO}\r\n\t\t\t${CHUNK_LANGUAGE}\r\n\t\t</header>\r\n\t\t<footer *if=\"state.status != 'connected'\">\r\n\t\t\t<span class=\"group--colophon\">\r\n\t\t\t\t${CHUNK_CREDITS}\r\n\t\t\t\t${CHUNK_COPYRIGHT}\r\n\t\t\t</span>\r\n\t\t\t<a [routerLink]=\"':lang.editor' | route\" class=\"btn--absolute\" *if=\"('editor' | flag) && !('deployed' | flag) && state.role == 'publisher' && (state.status == 'checklist' || state.status == 'link')\">\r\n\t\t\t\t<span [innerHTML]=\"'bhere_editor' | label\"></span> <svg class=\"edit\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#edit\"></use></svg>\r\n\t\t\t</a>\r\n\t\t</footer>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { fromEvent, merge, of } from 'rxjs';\r\nimport { filter, map } from 'rxjs/operators';\r\nimport { HttpService } from '../http/http.service';\r\nimport { Asset, mapAsset } from './asset';\r\n\r\nexport class AssetService {\r\n\r\n\tstatic assetCreate$(asset) {\r\n\t\treturn HttpService.post$(`/api/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetUpdate$(asset) {\r\n\t\treturn HttpService.put$(`/api/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetDelete$(asset) {\r\n\t\tif (asset && asset.id) {\r\n\t\t\treturn HttpService.delete$(`/api/asset/${asset.id}`).pipe(\r\n\t\t\t\tmap(() => null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic localizedAssetCreate$(lg, asset) {\r\n\t\treturn HttpService.post$(`/api/${lg}/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic localizedAssetUpdate$(lg, asset) {\r\n\t\treturn HttpService.put$(`/api/${lg}/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic upload$(files) {\r\n\t\tconst formData = new FormData();\r\n\t\tfiles.forEach(file => formData.append('file', file, file.name));\r\n\t\tconst xhr = new XMLHttpRequest();\r\n\t\tconst events$ = merge(\r\n\t\t\tfromEvent(xhr.upload, 'loadstart'),\r\n\t\t\tfromEvent(xhr.upload, 'progress'),\r\n\t\t\tfromEvent(xhr.upload, 'load'),\r\n\t\t\tfromEvent(xhr, 'readystatechange'),\r\n\t\t).pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tswitch (event.type) {\r\n\t\t\t\t\tcase 'readystatechange':\r\n\t\t\t\t\t\tif (xhr.readyState === 4) {\r\n\t\t\t\t\t\t\treturn JSON.parse(xhr.responseText);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== null)\r\n\t\t);\r\n\t\txhr.open('POST', `/api/upload/`, true);\r\n\t\txhr.send(formData);\r\n\t\treturn events$;\r\n\t}\r\n\r\n\tstatic createOrUpdateAsset$(uploads, control) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.assetUpdate$(asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic createOrUpdateLocalizedAsset$(uploads, control, lg) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.localizedAssetUpdate$(lg, asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.localizedAssetCreate$(lg, asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic assetDidChange(previous, current) {\r\n\t\tlet previousId = null;\r\n\t\tlet previousFile = null;\r\n\t\tlet currentId = null;\r\n\t\tlet currentFile = null;\r\n\t\tif (previous) {\r\n\t\t\tpreviousId = previous.id;\r\n\t\t\tpreviousFile = previous.file;\r\n\t\t}\r\n\t\tif (current) {\r\n\t\t\tcurrentId = current.id;\r\n\t\t\tcurrentFile = current.file;\r\n\t\t}\r\n\t\treturn (previousId !== currentId || previousFile !== currentFile);\r\n\t}\r\n\r\n}\r\n","import { map, shareReplay } from 'rxjs/operators';\r\nimport { HttpService } from '../http/http.service';\r\nimport { mapView, mapViewItem, ViewType } from '../view/view';\r\n\r\nexport class EditorService {\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tthis.data$_ = HttpService.get$(`/api/view`).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic viewIdOptions$() {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tconst options = data.views.filter(x => x.type.name !== ViewType.WaitingRoom.name).map(view => ({ id: view.id, name: view.name }));\r\n\t\t\t\toptions.unshift({ id: null, name: 'select', }); // LabelPipe.transform('select')\r\n\t\t\t\treturn options;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewCreate$(view) {\r\n\t\treturn HttpService.post$(`/api/view`, view).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewUpdate$(view) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}`, view.payload).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewDelete$(view) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}`);\r\n\t}\r\n\r\n\tstatic getTile(view) {\r\n\t\tlet tile;\r\n\t\tif (view.type.name === ViewType.PanoramaGrid.name) {\r\n\t\t\ttile = view.tiles[view.index];\r\n\t\t}\r\n\t\treturn tile;\r\n\t}\r\n\r\n\tstatic inferItemCreate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemCreate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemCreate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemUpdate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemUpdate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDelete$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemDelete$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemDelete$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdateResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet currentItem;\r\n\t\tif (tile) {\r\n\t\t\tcurrentItem = tile.navs.find(i => i.id === item.id);\r\n\t\t} else {\r\n\t\t\tcurrentItem = view.items.find(i => i.id === item.id);\r\n\t\t}\r\n\t\tif (currentItem) {\r\n\t\t\tObject.assign(currentItem, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDeleteResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet items;\r\n\t\tif (tile) {\r\n\t\t\titems = tile.navs;\r\n\t\t} else {\r\n\t\t\titems = view.items;\r\n\t\t}\r\n\t\tif (items) {\r\n\t\t\tconst index = items.indexOf(item);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\titems.splice(index, 1);\r\n\t\t\t}\r\n\t\t\tif (tile) {\r\n\t\t\t\tview.updateCurrentItems();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic itemCreate$(view, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemUpdate$(view, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemDelete$(view, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/item/${item.id}`);\r\n\t}\r\n\r\n\tstatic tileItemCreate$(view, tile, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/tile/${tile.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemUpdate$(view, tile, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemDelete$(view, tile, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`);\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport { Host } from '../../world/host/host';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class CurvedPlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget object() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tconst position = data.hit.position.clone();\r\n\t\t\tconst normal = data.hit.normal.clone();\r\n\t\t\tconst spherical = data.hit.spherical;\r\n\t\t\tif (spherical) {\r\n\t\t\t\tposition.normalize().multiplyScalar(20);\r\n\t\t\t\tobject.position.copy(position);\r\n\t\t\t\tobject.lookAt(Host.origin);\r\n\t\t\t} else {\r\n\t\t\t\tobject.lookAt(normal);\r\n\t\t\t\tobject.position.set(position.x, position.y, position.z);\r\n\t\t\t\tobject.position.add(normal.multiplyScalar(0.01));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn object;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = this.object;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.CurvedPlane,\r\n\t\t\tposition: new FormControl(object.position.toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()),\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tradius: new FormControl(35, RequiredValidator()),\r\n\t\t\theight: new FormControl(20, RequiredValidator()),\r\n\t\t\tarc: new FormControl(90, RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('CurvedPlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\t// console.log('CurvedPlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('CurvedPlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('CurvedPlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nCurvedPlaneModalComponent.meta = {\r\n\tselector: '[curved-plane-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Curved Plane.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<!-- <div control-text [control]=\"controls.title\" label=\"Title\"></div> -->\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<!--\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-number [control]=\"controls.radius\" label=\"Radius\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-number [control]=\"controls.height\" label=\"Height\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-number [control]=\"controls.arc\" label=\"Arc\" [precision]=\"0\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t-->\r\n\t\t\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nCurvedPlaneModalComponent.chunk = () => /* html */'<div class=\"curved-plane-modal\" curved-plane-modal></div>';\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport { Host } from '../../world/host/host';\r\nimport { EditorService } from '../editor.service';\r\nexport default class ItemModelModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget object() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tconst position = data.hit.position.clone();\r\n\t\t\tconst normal = data.hit.normal.clone();\r\n\t\t\tconst spherical = data.hit.spherical;\r\n\t\t\tif (spherical) {\r\n\t\t\t\tposition.normalize().multiplyScalar(4);\r\n\t\t\t\tobject.position.copy(position);\r\n\t\t\t\tobject.lookAt(Host.origin);\r\n\t\t\t} else {\r\n\t\t\t\tobject.lookAt(normal);\r\n\t\t\t\tobject.position.set(position.x, position.y, position.z);\r\n\t\t\t\tobject.position.add(normal.multiplyScalar(0.01));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn object;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = this.object;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Model,\r\n\t\t\tposition: new FormControl(object.position.toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl([0, 0, 0], RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\t// rotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ItemModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\t// console.log('ItemModelModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('ItemModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('ItemModelModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nItemModelModalComponent.meta = {\r\n\tselector: '[item-model-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Model Item.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-model [control]=\"controls.asset\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nItemModelModalComponent.chunk = () => /* html */'<div class=\"item-model-modal\" item-model-modal></div>';\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first, map, switchMap } from 'rxjs/operators';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class MediaModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Media,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('MediaModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\t// console.log('MediaModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tswitchMap(view => {\r\n\t\t\t\t\tconst item = {\r\n\t\t\t\t\t\ttype: ViewItemType.Plane,\r\n\t\t\t\t\t\tposition: [20, 0, 0],\r\n\t\t\t\t\t\trotation: [0, -Math.PI / 2, 0],\r\n\t\t\t\t\t\tscale: [12, 6.75, 1],\r\n\t\t\t\t\t\tasset: values.asset,\r\n\t\t\t\t\t};\r\n\t\t\t\t\treturn EditorService.itemCreate$(view, item).pipe(\r\n\t\t\t\t\t\tmap(item => {\r\n\t\t\t\t\t\t\tview.items = [item];\r\n\t\t\t\t\t\t\treturn view;\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\t\t\t\t}),\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('MediaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('MediaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nMediaModalComponent.meta = {\r\n\tselector: '[media-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Media.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nMediaModalComponent.chunk = () => /* html */`<div class=\"media-modal\" media-modal></div>`;\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first, map, switchMap } from 'rxjs/operators';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class ModelModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Model,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\tmodel: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\t// console.log('ModelModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tswitchMap(view => {\r\n\t\t\t\t\tconst item = {\r\n\t\t\t\t\t\ttype: ViewItemType.Model,\r\n\t\t\t\t\t\tasset: values.model,\r\n\t\t\t\t\t};\r\n\t\t\t\t\treturn EditorService.itemCreate$(view, item).pipe(\r\n\t\t\t\t\t\tmap(item => {\r\n\t\t\t\t\t\t\tview.items = [item];\r\n\t\t\t\t\t\t\treturn view;\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\t\t\t\t}),\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('ModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('ModelModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nModelModalComponent.meta = {\r\n\tselector: '[model-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Model View.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t\t\t<div control-model [control]=\"controls.model\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nModelModalComponent.chunk = () => /* html */`<div class=\"model-modal\" model-modal></div>`;\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport { WebhookService } from '../../webhook/webhook.service';\r\nimport { Host } from '../../world/host/host';\r\nimport ModelNavComponent from '../../world/model/model-nav.component';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class NavModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.hit.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tget object() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tconst position = data.hit.position.clone();\r\n\t\t\tconst normal = data.hit.normal.clone();\r\n\t\t\tconst spherical = data.hit.spherical;\r\n\t\t\tif (spherical) {\r\n\t\t\t\tposition.normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\t\t\tobject.position.copy(position);\r\n\t\t\t\tobject.lookAt(Host.origin);\r\n\t\t\t} else {\r\n\t\t\t\tobject.lookAt(normal);\r\n\t\t\t\tobject.position.set(position.x, position.y, position.z);\r\n\t\t\t\tobject.position.add(normal.multiplyScalar(0.01));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn object;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = this.object;\r\n\t\tthis.error = null;\r\n\t\tthis.useHooks = WebhookService.enabled;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Nav,\r\n\t\t\ttitle: null,\r\n\t\t\tabstract: null,\r\n\t\t\tviewId: null, // new FormControl(null, RequiredValidator()),\r\n\t\t\thook: null,\r\n\t\t\thookExtra: null,\r\n\t\t\tkeepOrientation: false,\r\n\t\t\timportant: false,\r\n\t\t\ttransparent: false,\r\n\t\t\t//\r\n\t\t\tposition: new FormControl(object.position.toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([20, 5, 1], RequiredValidator()),\r\n\t\t\t//\r\n\t\t\tasset: null,\r\n\t\t\tlink: new FormGroup({\r\n\t\t\t\ttitle: new FormControl(null),\r\n\t\t\t\thref: new FormControl(null),\r\n\t\t\t\ttarget: '_blank',\r\n\t\t\t}),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tif (WebhookService.enabled) {\r\n\t\t\tconst options = environment.webhook.methods.nav.map(x => ({ id: x, name: x }));\r\n\t\t\toptions.unshift({ id: null, name: 'select' });\r\n\t\t\tthis.controls.hook.options = options;\r\n\t\t}\r\n\t\t// !!! mode validator\r\n\t\t// form.addValidators(NavModalValidator(form, this.view));\r\n\t\t/*\r\n\t\tthis.controls.viewId.options = [{\r\n\t\t\tname: 'Name',\r\n\t\t\tid: 2,\r\n\t\t}];\r\n\t\t*/\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('NavModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\titem.viewId = item.viewId ? parseInt(item.viewId) : this.view.id;\r\n\t\t\tif (item.link && (!item.link.title || !item.link.href)) {\r\n\t\t\t\titem.link = null;\r\n\t\t\t}\r\n\t\t\t// console.log('NavModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('NavModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('NavModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.submitted = false;\r\n\t\t\t\t// this.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonViewIdDidChange(viewId) {\r\n\t\t// console.log('NavModalComponent.onViewIdDidChange', viewId, this.form.value);\r\n\t\t// const viewId = this.form.value.viewId;\r\n\t\tif (viewId != null && environment.flags.navAutoUpdateTitle) {\r\n\t\t\tconst options = this.controls.viewId.options;\r\n\t\t\tconst selectedOption = options.find(x => x.id === viewId);\r\n\t\t\t// console.log('NavModalComponent.onViewIdDidChange', selectedOption, options);\r\n\t\t\tif (selectedOption != null) {\r\n\t\t\t\tconst title = selectedOption.name;\r\n\t\t\t\tconst currentTitle = this.form.value.title;\r\n\t\t\t\t// console.log('NavModalComponent.onViewIdDidChange', title, currentTitle);\r\n\t\t\t\tif (!currentTitle || options.find(x => x.name === currentTitle)) {\r\n\t\t\t\t\tthis.form.patch({ title });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nNavModalComponent.meta = {\r\n\tselector: '[nav-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Nav.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.title\" label=\"Title\"></div>\r\n\t\t\t\t\t\t<div control-textarea [control]=\"controls.abstract\" label=\"Abstract\"></div>\r\n\t\t\t\t\t\t<div control-custom-select [control]=\"controls.viewId\" label=\"NavToView\" (change)=\"onViewIdDidChange($event)\"></div>\r\n\t\t\t\t\t\t<div control-checkbox [control]=\"controls.keepOrientation\" label=\"Keep Orientation\"></div>\r\n\t\t\t\t\t\t<div control-checkbox [control]=\"controls.important\" label=\"Important\"></div>\r\n\t\t\t\t\t\t<div control-checkbox [control]=\"controls.transparent\" label=\"Transparent\"></div>\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"3\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div *if=\"controls.transparent.value == true\">\r\n\t\t\t\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/png, image/jpeg\"></div>\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.link.controls.title\" label=\"Link Title\"></div>\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.link.controls.href\" label=\"Link Url\"></div>\r\n\t\t\t\t\t\t<div control-custom-select [control]=\"controls.hook\" label=\"Hook\" *if=\"useHooks\"></div>\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.hookExtra\" label=\"Hook Extra\" *if=\"useHooks\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nNavModalComponent.chunk = () => /* html */'<div class=\"nav-modal\" nav-modal></div>';\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { PanoramaGridView, ViewType } from '../../view/view';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class PanoramaGridModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.PanoramaGrid,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tassets: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaGridModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\t// console.log('PanoramaGridModalComponent.onSubmit', this.form.value);\r\n\t\t\tconst assets = this.form.value.assets;\r\n\t\t\tconst tiles = PanoramaGridView.mapTiles(assets.map(asset => ({\r\n\t\t\t\tasset,\r\n\t\t\t\tnavs: [],\r\n\t\t\t})), false, true);\r\n\t\t\ttiles.sort((a, b) => {\r\n\t\t\t\tconst ai = a.indices.x * 10000 + a.indices.y;\r\n\t\t\t\tconst bi = b.indices.x * 10000 + b.indices.y;\r\n\t\t\t\treturn ai - bi;\r\n\t\t\t});\r\n\t\t\t// console.log('PanoramaGridModalComponent.onSubmit', tiles);\r\n\t\t\tconst asset = tiles[0].asset;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: this.form.value.type,\r\n\t\t\t\tname: this.form.value.name,\r\n\t\t\t\tasset,\r\n\t\t\t\ttiles: tiles,\r\n\t\t\t\tinvertAxes: true,\r\n\t\t\t\tflipAxes: false,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tEditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('PanoramaGridModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nPanoramaGridModalComponent.meta = {\r\n\tselector: '[panorama-grid-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Panorama Grid.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t\t<div control-assets [control]=\"controls.assets\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nPanoramaGridModalComponent.chunk = () => /* html */`<div class=\"panorama-grid-modal\" panorama-grid-modal></div>`;\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewType } from '../../view/view';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class PanoramaModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Panorama,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\t// console.log('PanoramaModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('PanoramaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nPanoramaModalComponent.meta = {\r\n\tselector: '[panorama-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Panorama.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<!--\r\n\t\t\t\t\t<div class=\"group--form group--form--fixed\">\r\n\t\t\t\t\t\t<code [innerHTML]=\"form.value | json\"></code>\r\n\t\t\t\t\t\t<button type=\"button\" class=\"btn--test\" (click)=\"test()\"><span>test</span></button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t-->\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nPanoramaModalComponent.chunk = () => /* html */`<div class=\"panorama-modal\" panorama-modal></div>`;\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport PathService from '../path/path.service';\r\n\r\nexport default class PathAddModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PathAddModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst path = {\r\n\t\t\t\tname: values.name,\r\n\t\t\t\titems: this.data ? this.data.item.items : [],\r\n\t\t\t};\r\n\t\t\t// console.log('PathAddModalComponent.onSubmit.path', path);\r\n\t\t\treturn PathService.pathCreate$(path).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('PathAddModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PathAddModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nPathAddModalComponent.meta = {\r\n\tselector: '[path-add-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Add Path.</div>\r\n\t\t\t\t<div class=\"description\">Aggiungi un percorso</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nPathAddModalComponent.chunk = () => /* html */`<div class=\"panorama-modal\" path-add-modal></div>`;\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport PathService from '../path/path.service';\r\n\r\nexport default class PathEditModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.item = null;\r\n\t\tthis.views = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tconst data = parentInstance.modal.data;\r\n\t\t\tif (data) {\r\n\t\t\t\tthis.item = data.item ? data.item : null;\r\n\t\t\t\tthis.views = this.parseViews(data.views, this.item);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(this.item ? this.item.name : null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PathEditModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tparseViews(views, item) {\r\n\t\tif (views && item) {\r\n\t\t\treturn views.map(view => {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tid: view.id,\r\n\t\t\t\t\tname: view.name,\r\n\t\t\t\t\ttype: view.type,\r\n\t\t\t\t\tactive: item.items.indexOf(view.id) === -1,\r\n\t\t\t\t};\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\treturn [];\r\n\t\t}\r\n\t}\r\n\r\n\tonToggleView(view) {\r\n\t\tview.active = !view.active;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst payload = {\r\n\t\t\t\tid: this.item.id,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\titems: this.views.filter(x => !x.active).map(x => x.id),\r\n\t\t\t};\r\n\t\t\t// console.log('PathEditModalComponent.onSubmit', payload);\r\n\t\t\treturn PathService.pathUpdate$(payload).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('PathEditModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PathEditModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonSelectAll() {\r\n\t\tthis.views.forEach(view => view.active = true);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSelectNone() {\r\n\t\tthis.views.forEach(view => view.active = false);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nPathEditModalComponent.meta = {\r\n\tselector: '[path-edit-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Edit Path <span *if=\"item\">&ldquo;<span [innerHTML]=\"item.title || item.name\"></span>&rdquo;</span>.</div>\r\n\t\t\t\t<div class=\"description\">Modifica il percorso</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<ul class=\"nav--flag\" *if=\"views\">\r\n\t\t\t\t\t\t<li class=\"nav__item\" *for=\"let view of views\">\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--flag\" [class]=\"{ active: view.active }\" [title]=\"view.name\" (click)=\"onToggleView(view)\">\r\n\t\t\t\t\t\t\t\t<div class=\"icon\">\r\n\t\t\t\t\t\t\t\t\t<svg-icon [name]=\"view.type.name\"></svg-icon>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t<span class=\"name\" [innerHTML]=\"view.name\"></span>\r\n\t\t\t\t\t\t\t\t<span class=\"flag\">\r\n\t\t\t\t\t\t\t\t\t<svg class=\"check\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#check\"></use></svg>\r\n\t\t\t\t\t\t\t\t\t<svg class=\"close\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<div class=\"group--options\">\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--link\" (click)=\"onSelectAll()\">\r\n\t\t\t\t\t\t\t\t<span>Select all</span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t<button type=\"button\" class=\"btn--link\" (click)=\"onSelectNone()\">\r\n\t\t\t\t\t\t\t\t<span>Select none</span>\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Save</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nPathEditModalComponent.chunk = () => /* html */`<div class=\"path-edit-modal\" path-edit-modal></div>`;\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport { Host } from '../../world/host/host';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class PlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget object() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tconst position = data.hit.position.clone();\r\n\t\t\tconst normal = data.hit.normal.clone();\r\n\t\t\tconst spherical = data.hit.spherical;\r\n\t\t\tif (spherical) {\r\n\t\t\t\tposition.normalize().multiplyScalar(20);\r\n\t\t\t\tobject.position.copy(position);\r\n\t\t\t\tobject.lookAt(Host.origin);\r\n\t\t\t} else {\r\n\t\t\t\tobject.lookAt(normal);\r\n\t\t\t\tobject.position.set(position.x, position.y, position.z);\r\n\t\t\t\tobject.position.add(normal.multiplyScalar(0.01));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn object;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = this.object;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Plane,\r\n\t\t\tposition: new FormControl(object.position.toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([12, 6.75, 1], RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\t// console.log('PlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('PlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('PlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nPlaneModalComponent.meta = {\r\n\tselector: '[plane-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Plane.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<!-- <div control-text [control]=\"controls.title\" label=\"Title\"></div> -->\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nPlaneModalComponent.chunk = () => /* html */'<div class=\"plane-modal\" plane-modal></div>';\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\n\r\nexport default class RemoveModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget item() {\r\n\t\tlet item = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\titem = data.item;\r\n\t\t}\r\n\t\treturn item;\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nRemoveModalComponent.meta = {\r\n\tselector: '[remove-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Remove <span *if=\"item\">&ldquo;<span [innerHTML]=\"item.title || item.name\"></span>&rdquo;</span>.</div>\r\n\t\t\t\t<div class=\"abstract\">are you sure?</div>\r\n\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t\t<span>Remove</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--accept\" (click)=\"onCancel($event)\">\r\n\t\t\t\t\t\t<span>Cancel</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nRemoveModalComponent.chunk = () => /* html */`<div class=\"remove-modal\" remove-modal></div>`;\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewType } from '../../view/view';\r\nimport { EditorService } from '../editor.service';\r\n\r\nexport default class Room3DModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Room3d,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\t// model: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('Room3DModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\t// console.log('Room3DModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\t/*\r\n\t\t\t\tswitchMap(view => {\r\n\t\t\t\t\tconst item = {\r\n\t\t\t\t\t\ttype: ViewItemType.Model,\r\n\t\t\t\t\t\tasset: values.model,\r\n\t\t\t\t\t};\r\n\t\t\t\t\treturn EditorService.itemCreate$(view, item).pipe(\r\n\t\t\t\t\t\tmap(item => {\r\n\t\t\t\t\t\t\tview.items = [item];\r\n\t\t\t\t\t\t\treturn view;\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\t\t\t\t}),\r\n\t\t\t\t*/\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('Room3DModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('Room3DModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nRoom3DModalComponent.meta = {\r\n\tselector: '[room-3d-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Room 3D View.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t\t<!--\r\n\t\t\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t\t\t<div control-model [control]=\"controls.model\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t\t\t\t-->\r\n\t\t\t\t\t\t<div control-model [control]=\"controls.asset\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nRoom3DModalComponent.chunk = () => /* html */`<div class=\"room-3d-modal\" room-3d-modal></div>`;\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { Subject } from 'rxjs';\r\nimport { delay, first, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { AgoraStatus, MessageType, UIMode } from '../agora/agora.types';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { environment } from '../environment';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { MessageService } from '../message/message.service';\r\nimport { ModalResolveEvent, ModalService } from '../modal/modal.service';\r\nimport { RoutePipe } from '../router/route.pipe';\r\nimport { RouterOutletStructure } from '../router/router-outlet.structure';\r\nimport { RouterService } from '../router/router.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService, { StreamServiceMode } from '../stream/stream.service';\r\nimport ToastService from '../toast/toast.service';\r\nimport TryInARModalComponent from '../try-in-ar/try-in-ar-modal.component';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { ViewItemType, ViewType } from '../view/view';\r\nimport { ViewService } from '../view/view.service';\r\nimport VRService from '../world/vr.service';\r\nimport { EditorService } from './editor.service';\r\nimport CurvedPlaneModalComponent from './modals/curved-plane-modal.component';\r\nimport ItemModelModalComponent from './modals/item-model-modal.component';\r\nimport MediaModalComponent from './modals/media-modal.component';\r\nimport ModelModalComponent from './modals/model-modal.component';\r\nimport NavModalComponent from './modals/nav-modal.component';\r\nimport PanoramaGridModalComponent from './modals/panorama-grid-modal.component';\r\nimport PanoramaModalComponent from './modals/panorama-modal.component';\r\nimport PathAddModalComponent from './modals/path-add-modal.component';\r\nimport PathEditModalComponent from './modals/path-edit-modal.component';\r\nimport PlaneModalComponent from './modals/plane-modal.component';\r\nimport RemoveModalComponent from './modals/remove-modal.component';\r\nimport Room3DModalComponent from './modals/room-3d-modal.component';\r\nimport PathService from './path/path.service';\r\n\r\nexport const SETTINGS = {\r\n\tmenu: [{\r\n\t\tid: 'menu',\r\n\t\ttitle: 'editor_menu',\r\n\t\tactive: true,\r\n\t}, {\r\n\t\tid: 'navmaps',\r\n\t\ttitle: 'editor_navmaps',\r\n\t\tactive: true,\r\n\t}],\r\n\tcurrent: null,\r\n\tactive: false,\r\n};\r\n\r\nexport default class EditorComponent extends Component {\r\n\r\n\tget dataViews() {\r\n\t\treturn ViewService.dataViews;\r\n\t}\r\n\r\n\tget pathViews() {\r\n\t\treturn ViewService.pathViews;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.settings = this.getSettings();\r\n\t\tthis.aside = false;\r\n\t\tthis.state = {};\r\n\t\tthis.view = null;\r\n\t\tthis.paths = null;\r\n\t\tthis.path = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.remotes = [];\r\n\t\tthis.viewHit = new Subject();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tUserService.me$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(user => {\r\n\t\t\tif (user && user.type === RoleType.Publisher) {\r\n\t\t\t\tthis.user = user;\r\n\t\t\t\tthis.initState();\r\n\t\t\t} else {\r\n\t\t\t\tRouterService.setRouterLink(RoutePipe.transform(':lang.access'));\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tinitState() {\r\n\t\tconst user = this.user;\r\n\t\tconst role = user.type;\r\n\t\tconst name = user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\tname: name,\r\n\t\t\tmode: UIMode.VirtualTour,\r\n\t\t\tlink: null,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: AgoraStatus.Connected,\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: true,\r\n\t\t\tcontrolling: false,\r\n\t\t\tspying: false,\r\n\t\t\tsilencing: false,\r\n\t\t\thosted: true,\r\n\t\t\tlive: false,\r\n\t\t\tnavigable: true,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t\tshowNavInfo: true,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(view => {\r\n\t\t\t// console.log('EditorComponent.viewObserver$', view);\r\n\t\t});\r\n\t\tStreamService.mode = StreamServiceMode.Editor;\r\n\t\t// this.getUserMedia();\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn EditorService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\t// console.log('viewObserver$', data);\r\n\t\t\t\tconst meetingUrl = new MeetingUrl();\r\n\t\t\t\tconst pathId = meetingUrl.pathId;\r\n\t\t\t\treturn PathService.getCurrentPath$(pathId).pipe(\r\n\t\t\t\t\tswitchMap(path => {\r\n\t\t\t\t\t\tthis.paths = PathService.paths;\r\n\t\t\t\t\t\tthis.path = path;\r\n\t\t\t\t\t\treturn ViewService.editorView$(data, path);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\ttap(view => {\r\n\t\t\t\t// console.log('EditorComponent.viewObserver$', view, ViewService.pathViews, ViewService.dataViews);\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tonAddPath() {\r\n\t\t// console.log('EditorComponent.onAddPath');\r\n\t\tModalService.open$({ template: PathAddModalComponent.chunk() }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tPathService.addPath(event.data);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonEditPath(item) {\r\n\t\t// console.log('EditorComponent.onEditPath', item);\r\n\t\tModalService.open$({ template: PathEditModalComponent.chunk(), data: { item: item, views: ViewService.validViews } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tPathService.editPath(event.data);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDuplicatePath(item) {\r\n\t\t// console.log('EditorComponent.onDuplicatePath', item);\r\n\t\tModalService.open$({ template: PathAddModalComponent.chunk(), data: { item } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tPathService.addPath(event.data);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDeletePath(item) {\r\n\t\t// console.log('EditorComponent.onDeletePath', item);\r\n\t\tModalService.open$({ template: RemoveModalComponent.chunk(), data: { item: item } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tPathService.pathDelete$(item).pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(_ => {\r\n\t\t\t\t\tPathService.deletePath(item);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelectPath(item) {\r\n\t\t// console.log('EditorComponent.onSelectPath', item);\r\n\t\tPathService.path = item;\r\n\t}\r\n\r\n\tisPathSelected(item) {\r\n\t\t// console.log('EditorComponent.isPathSelected', item);\r\n\t\treturn PathService.path.id === item.id;\r\n\t}\r\n\r\n\tonNavTo(item) {\r\n\t\t// console.log('EditorComponent.onNavTo', item);\r\n\t\tconst viewId = item.viewId;\r\n\t\tconst view = ViewService.pathViews.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\tViewService.action = { viewId, keepOrientation: item.keepOrientation, useLastOrientation: item.useLastOrientation };\r\n\t\t}\r\n\t}\r\n\r\n\tonNavLink(event) {\r\n\t\t// console.log('EditorComponent.onNavLink', event);\r\n\t\tModalService.open$({ iframe: event.link.href }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(_ => {\r\n\t\t\tMessageService.send({\r\n\t\t\t\ttype: MessageType.NavLinkClose,\r\n\t\t\t\titemId: event.item.id,\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tModalService.open$({ template: TryInARModalComponent.chunk(), data: this.view }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonToggleAside() {\r\n\t\tthis.aside = !this.aside;\r\n\t\tthis.pushChanges();\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tgetSettings() {\r\n\t\tconst settings = Object.assign({}, SETTINGS);\r\n\t\tsettings.menu = settings.menu.filter(x => environment.flags[x.id]);\r\n\t\tsettings.current = settings.menu.length ? settings.menu[0].id : null;\r\n\t\treturn settings;\r\n\t}\r\n\r\n\tonToggleSettings() {\r\n\t\tconst settings = this.settings;\r\n\t\tsettings.active = !settings.active;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSelectSetting(item) {\r\n\t\tthis.settings.current = item.id;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\t// editor\r\n\r\n\tonViewHit(event) {\r\n\t\t// console.log('onViewHit');\r\n\t\tthis.viewHit.next(event);\r\n\t}\r\n\r\n\tonViewHitted(callback) {\r\n\t\tif (this.viewHitSubscription) {\r\n\t\t\tthis.viewHitSubscription.unsubscribe();\r\n\t\t\tthis.viewHitSubscription = null;\r\n\t\t}\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tthis.viewHitSubscription = this.viewHit.pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(event => callback(event));\r\n\t\t}\r\n\t}\r\n\r\n\tonDragEnd(event) {\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onDragEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onDragEnd.inferItemUpdate$.error', error, this.view, event.item, event.item.payload));\r\n\t}\r\n\r\n\tonResizeEnd(event) {\r\n\t\t// console.log('EditorComponent.onResizeEnd');\r\n\t\t/*\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onResizeEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onResizeEnd.inferItemUpdate$.error', error));\r\n\t\t*/\r\n\t}\r\n\r\n\tonWorldSelect(event) {\r\n\t\t// console.log('EditorComponent.onWorldSelect', this.view);\r\n\t\tif (this.view) {\r\n\t\t\tlet selectedItem;\r\n\t\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\t\tthis.view.items.forEach(item => {\r\n\t\t\t\titem.selected = item === event.item;\r\n\t\t\t\tselectedItem = item.selected ? item : selectedItem;\r\n\t\t\t});\r\n\t\t\tthis.view.selected = !selectedItem;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (selectedItem) {\r\n\t\t\t\tthis.aside = true;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonOpenModal(modal, data) {\r\n\t\tlet template = null;\r\n\t\tswitch (modal.type) {\r\n\t\t\tcase 'view':\r\n\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\ttemplate = PanoramaModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\ttemplate = PanoramaGridModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\ttemplate = ModelModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\t\ttemplate = Room3DModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase ViewType.Media.name:\r\n\t\t\t\t\t\ttemplate = MediaModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'viewItem':\r\n\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\t\ttemplate = NavModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\t\ttemplate = PlaneModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\t\ttemplate = CurvedPlaneModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\t\ttemplate = ItemModelModalComponent.chunk();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tif (!template) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tModalService.open$({ template, data }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t// console.log('EditorComponent.onOpenModal.resolve', event);\r\n\t\t\t\tswitch (modal.type) {\r\n\t\t\t\t\tcase 'view':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\t\t\tcase ViewType.Media.name:\r\n\t\t\t\t\t\t\t\tViewService.addView(event.data);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'viewItem':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Model.name: {\r\n\t\t\t\t\t\t\t\tconst item = event.data; // Object.assign({}, event.data);\r\n\t\t\t\t\t\t\t\tconst tile = EditorService.getTile(this.view);\r\n\t\t\t\t\t\t\t\tif (tile) {\r\n\t\t\t\t\t\t\t\t\tconst navs = tile.navs || [];\r\n\t\t\t\t\t\t\t\t\tnavs.push(item);\r\n\t\t\t\t\t\t\t\t\ttile.navs = navs;\r\n\t\t\t\t\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\titem.path = true;\r\n\t\t\t\t\t\t\t\t\tconst items = this.view.items || [];\r\n\t\t\t\t\t\t\t\t\titems.push(item);\r\n\t\t\t\t\t\t\t\t\tthis.view.items = items;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonAsideSelect(event) {\r\n\t\t// console.log('onAsideSelect', event);\r\n\t\tif (event.value) {\r\n\t\t\tswitch (event.value) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tthis.onViewHitted((hit) => {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, hit });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (event.type === 'viewItem') {\r\n\t\t\t\t\t\tif (this.view.type.name === ViewType.Model.name) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.onViewHitted((hit) => {\r\n\t\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, hit });\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t}\r\n\t\t} else if (event.view && (event.item || event.item === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.items.forEach(item => item.selected = item === event.item);\r\n\t\t\tMessageService.send({\r\n\t\t\t\ttype: MessageType.SelectItem,\r\n\t\t\t});\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view && (event.tile || event.tile === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.tiles.forEach(tile => tile.selected = tile === event.tile);\r\n\t\t\tMessageService.send({\r\n\t\t\t\ttype: MessageType.SelectItem,\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\t// if tile selected\r\n\t\t\t// send ChangeTile message to world component\r\n\t\t\tthis.orbitService.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\t\tconst item = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\t\tif (item) {\r\n\t\t\t\t\tthis.panorama.crossfade(item, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\t\t\tthis.orbitService.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\t\t// this.render();\r\n\t\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view || event.view === null) {\r\n\t\t\tthis.view.selected = (this.view === event.view);\r\n\t\t\tthis.view.items.forEach(item => item.selected = false);\r\n\t\t\tconst currentTile = EditorService.getTile(this.view);\r\n\t\t\tif (currentTile) {\r\n\t\t\t\tthis.view.tiles.forEach(tile => tile.selected = tile === currentTile);\r\n\t\t\t}\r\n\t\t\tMessageService.send({\r\n\t\t\t\ttype: MessageType.SelectItem,\r\n\t\t\t});\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideUpdate(event) {\r\n\t\t// console.log('onAsideUpdate', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.tile && event.view) {\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t} else if (event.view) {\r\n\t\t\tif (ViewService.viewId !== event.view.id) {\r\n\t\t\t\tViewService.viewId = event.view.id;\r\n\t\t\t} else {\r\n\t\t\t\tconst assetDidChange = AssetService.assetDidChange(this.view.asset, event.view.asset);\r\n\t\t\t\tObject.assign(this.view, event.view);\r\n\t\t\t\tif (assetDidChange) {\r\n\t\t\t\t\tif (typeof this.view.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\tthis.view.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideDelete(event) {\r\n\t\t// console.log('onAsideDelete', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tEditorService.inferItemDelete$(event.view, event.item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.inferItemDelete$.success', response);\r\n\t\t\t\tEditorService.inferItemDeleteResult$(event.view, event.item);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.inferItemDelete$.error', error));\r\n\t\t} else if (event.view) {\r\n\t\t\tEditorService.viewDelete$(event.view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.viewDelete$.success', response);\r\n\t\t\t\tViewService.deleteView(event.view);\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.viewDelete$.error', error));\r\n\t\t}\r\n\t}\r\n}\r\n\r\nEditorComponent.meta = {\r\n\tselector: '[editor-component]',\r\n\thosts: { host: RouterOutletStructure },\r\n\ttemplate: /* html */`\r\n\t<div class=\"page page--editor\">\r\n\t\t<div class=\"ui\" [class]=\"{ open: aside }\" *if=\"dataViews.length\">\r\n\t\t\t<div class=\"ui__navbar\">\r\n\t\t\t\t<div class=\"btn--settings\" [class]=\"{ active: settings.active }\" (click)=\"onToggleSettings($event)\" *if=\"settings.menu.length > 0\">\r\n\t\t\t\t\t<svg class=\"settings\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#settings-full\"></use></svg>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"headline\" *if=\"view\">\r\n\t\t\t\t\t<div class=\"headline__id\" [innerHTML]=\"view.id\"></div>\r\n\t\t\t\t\t<div class=\"headline__icon\">\r\n\t\t\t\t\t\t<svg-icon [name]=\"view.type.name\"></svg-icon>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"headline__name\" [innerHTML]=\"view.name\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"group--path\" *if=\"('usePaths' | flag) && path\">\r\n\t\t\t\t\t<div class=\"group--path__select\">\r\n\t\t\t\t\t\t<div class=\"group--form--select\" [dropdown]=\"'path'\">\r\n\t\t\t\t\t\t\t<label>Percorso</label>\r\n\t\t\t\t\t\t\t<span class=\"control--custom-select\" [innerHTML]=\"path.name\"></span>\r\n\t\t\t\t\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"dropdown dropdown-item\" [dropdown-item]=\"'path'\">\r\n\t\t\t\t\t\t\t<div class=\"category\">Percorso</div>\r\n\t\t\t\t\t\t\t<ul class=\"nav--dropdown\">\r\n\t\t\t\t\t\t\t\t<li [class]=\"{ active: isPathSelected(item) }\" *for=\"let item of paths\">\r\n\t\t\t\t\t\t\t\t\t<span [innerHTML]=\"item.name\" (click)=\"onSelectPath(item)\"></span>\r\n\t\t\t\t\t\t\t\t\t<div class=\"check\">\r\n\t\t\t\t\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#check\"></use></svg>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"btn--flags\" (click)=\"onEditPath(item)\" title=\"Edit\" *if=\"item.id\">\r\n\t\t\t\t\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#flags\"></use></svg>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"btn--duplicate\" (click)=\"onDuplicatePath(item)\" title=\"Duplicate\" *if=\"item.id\">\r\n\t\t\t\t\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#duplicate\"></use></svg>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"btn--trash\" (click)=\"onDeletePath(item)\" title=\"Delete\" *if=\"item.id\">\r\n\t\t\t\t\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#trash\"></use></svg>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t\t\t<div class=\"btn--mode\" (click)=\"onAddPath()\">Aggiungi un percorso</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"btn--edit\" [class]=\"{ active: aside }\" (click)=\"onToggleAside($event)\">\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#edit\"></use></svg>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"ui__body\">\r\n\t\t\t\t<div class=\"world\" world [view]=\"view\" [views]=\"pathViews\" [editor]=\"true\" (navTo)=\"onNavTo($event)\" (viewHit)=\"onViewHit($event)\" (dragEnd)=\"onDragEnd($event)\" (select)=\"onWorldSelect($event)\"></div>\r\n\t\t\t</div>\r\n\t\t\t<!-- footer -->\r\n\t\t\t<div class=\"group--footer\">\r\n\t\t\t\t<div class=\"group--ar-vr\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--ar\" [href]=\"view?.ar\" (click)=\"tryInAr()\" *if=\"view?.ar\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#ar\"></use></svg> <span>Try in AR</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--vr\" [class]=\"{ disabled: vrService.isDisabled() }\" (click)=\"vrService.toggleVR()\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#vr\"></use></svg> <span [innerHTML]=\"vrService.getLabel()\"></span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"ui__settings\" *if=\"settings.active\">\r\n\t\t\t\t<!-- settings navs -->\r\n\t\t\t\t<div class=\"group--nav\">\r\n\t\t\t\t\t<ul class=\"nav--menu\">\r\n\t\t\t\t\t\t<li class=\"nav__item\" *for=\"let item of settings.menu\" [class]=\"{ active: settings.current === item.id }\" (click)=\"onSelectSetting(item)\"><span class=\"title\" [innerHTML]=\"item.title | label\"></span></li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t</div>\r\n\t\t\t\t<!-- menu -->\r\n\t\t\t\t<div class=\"group--content\" menu-builder [views]=\"dataViews\" *if=\"settings.current === 'menu'\"></div>\r\n\t\t\t\t<!-- navmaps -->\r\n\t\t\t\t<div class=\"group--content\" navmap-builder [views]=\"dataViews\" *if=\"settings.current === 'navmaps'\"></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<div class=\"aside\" [class]=\"{ active: aside }\" aside [view]=\"view\" (select)=\"onAsideSelect($event)\" (update)=\"onAsideUpdate($event)\" (delete)=\"onAsideDelete($event)\" *if=\"view && aside\"></div>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { switchMap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport { HttpService } from '../http/http.service';\r\nimport { LanguageService } from '../language/language.service';\r\n\r\nexport class GenericService {\r\n\r\n\tstatic currentLanguagePage$(key) {\r\n\t\treturn LanguageService.lang$.pipe(\r\n\t\t\tswitchMap(lang => {\r\n\t\t\t\treturn this.page$(lang, key);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic page$(lang, key) {\r\n\t\tconst url = (environment.flags.production ? `/api/${lang}/pages/${key}/` : `./api/${lang}/pages/${key}.json`);\r\n\t\treturn HttpService.get$(url);\r\n\t}\r\n\r\n}\r\n","import { Component } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { CHUNK_COPYRIGHT, CHUNK_CREDITS, CHUNK_LANGUAGE, CHUNK_LOGO } from '../agora/agora.component.chunks';\r\nimport { RouterOutletStructure } from '../router/router-outlet.structure';\r\nimport { GenericService } from './generic.service';\r\n\r\nexport class GenericComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.route = this.host ? this.host.route : null;\r\n\t\tthis.state = { status: 'generic' };\r\n\t\tthis.page = null;\r\n\t\tGenericService.currentLanguagePage$(this.route.params.mode).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(page => {\r\n\t\t\tthis.page = page;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nGenericComponent.meta = {\r\n\tselector: '[generic-component]',\r\n\thosts: { host: RouterOutletStructure },\r\n\ttemplate: /*html*/ `\r\n\t\t<div class=\"page page--generic\">\r\n\t\t\t<!-- generic -->\r\n\t\t\t<div class=\"ui ui--generic\" *if=\"page\">\r\n\t\t\t\t<div class=\"group--generic\">\r\n\t\t\t\t\t<div class=\"group--generic__content stagger--childs\">\r\n\t\t\t\t\t\t<h1 class=\"title\" [innerHTML]=\"page.title\"></h1>\r\n\t\t\t\t\t\t<div class=\"description\" [innerHTML]=\"page.description\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<header>\r\n\t\t\t\t${CHUNK_LOGO}\r\n\t\t\t\t${CHUNK_LANGUAGE}\r\n\t\t\t</header>\r\n\t\t\t<footer>\r\n\t\t\t\t<span class=\"group--colophon\" *if=\"state.status != 'connected'\">\r\n\t\t\t\t\t${CHUNK_CREDITS}\r\n\t\t\t\t\t${CHUNK_COPYRIGHT}\r\n\t\t\t\t</span>\r\n\t\t\t</footer>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { fromEvent } from 'rxjs';\r\nimport { first, takeUntil, tap } from 'rxjs/operators';\r\nimport { CHUNK_AR_VR, CHUNK_BACKGROUND, CHUNK_CHAT, CHUNK_CONTROLS, CHUNK_LIKE, CHUNK_LOCK, CHUNK_MEDIA, CHUNK_NAVMAP } from '../agora/agora.component.chunks';\r\nimport { AgoraStatus, UIMode } from '../agora/agora.types';\r\nimport { DEBUG, environment } from '../environment';\r\nimport { LabelPipe } from '../label/label.pipe';\r\nimport { LanguageService } from '../language/language.service';\r\nimport LocationService from '../location/location.service';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { RouterOutletStructure } from '../router/router-outlet.structure';\r\nimport StateService from '../state/state.service';\r\nimport ToastService, { ToastPosition, ToastRejectEvent, ToastResolveEvent, ToastType } from '../toast/toast.service';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { ViewType } from '../view/view';\r\nimport VRService from '../world/vr.service';\r\n\r\nexport default class LayoutComponent extends Component {\r\n\r\n\tget meetingUrl() {\r\n\t\tif (!this.meetingUrl_) {\r\n\t\t\tthis.meetingUrl_ = new MeetingUrl();\r\n\t\t}\r\n\t\treturn this.meetingUrl_;\r\n\t}\r\n\r\n\tget isVirtualTourUser() {\r\n\t\treturn [RoleType.Publisher, RoleType.Attendee, RoleType.Streamer, RoleType.Viewer].indexOf(this.state.role) !== -1;\r\n\t}\r\n\r\n\tget isEmbed() {\r\n\t\treturn this.route && this.route.params.mode === 'embed';\r\n\t}\r\n\r\n\tget isSelfServiceTour() {\r\n\t\treturn this.route && this.route.params.mode === 'selfServiceTour';\r\n\t}\r\n\r\n\tget isNavigable() {\r\n\t\tconst embedViewId = this.meetingUrl.embedViewId;\r\n\t\tconst navigable = embedViewId == null;\r\n\t\treturn navigable;\r\n\t}\r\n\r\n\tget isBackButtonVisible() {\r\n\t\treturn this.view && (this.view.type.name === ViewType.Media.name || this.view.type.name === ViewType.Model.name);\r\n\t}\r\n\r\n\tget showNavInfoToggler() {\r\n\t\treturn environment.flags.hideNavInfo && this.state.mode !== UIMode.LiveMeeting;\r\n\t}\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\t// uiClass[this.state.mode] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\tuiClass.remotes = this.state.mode === UIMode.LiveMeeting;\r\n\t\tuiClass.remoteScreen = this.remoteScreen != null && !this.hasScreenViewItem;\r\n\t\tuiClass.media = !uiClass.remotes && this.media;\r\n\t\tuiClass.locked = this.locked;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tget remoteClass() {\r\n\t\treturn `group--remote--${Math.min(9, this.remotes.length)}`;\r\n\t}\r\n\r\n\tget controlled() {\r\n\t\treturn (this.state.controlling && this.state.controlling !== this.state.uid);\r\n\t}\r\n\r\n\tget controlling() {\r\n\t\treturn (this.state.controlling && this.state.controlling === this.state.uid);\r\n\t}\r\n\r\n\tget silencing() {\r\n\t\treturn StateService.state.silencing;\r\n\t}\r\n\r\n\tget silenced() {\r\n\t\treturn (StateService.state.silencing && StateService.state.role === RoleType.Streamer);\r\n\t}\r\n\r\n\tget spyed() {\r\n\t\treturn (this.state.spying && this.state.spying === this.state.uid);\r\n\t}\r\n\r\n\tget spying() {\r\n\t\treturn (this.state.spying && this.state.spying !== this.state.uid);\r\n\t}\r\n\r\n\tget locked() {\r\n\t\treturn this.controlled || this.spying;\r\n\t}\r\n\r\n\tget remoteScreen() {\r\n\t\treturn this.remoteScreen_;\r\n\t}\r\n\tset remoteScreen(remoteScreen) {\r\n\t\tif (this.remoteScreen_ !== remoteScreen) {\r\n\t\t\tthis.remoteScreen_ = remoteScreen;\r\n\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst meetingUrl = this.meetingUrl;\r\n\t\tconst embedViewId = meetingUrl.embedViewId;\r\n\t\tthis.state = {\r\n\t\t\tstatus: LocationService.get('status') || AgoraStatus.Connected,\r\n\t\t\trole: LocationService.get('role') || RoleType.Publisher, // Publisher, Attendee, Streamer, Viewer, SmartDevice, SelfService, Embed\r\n\t\t\tmembersCount: 3,\r\n\t\t\tcontrolling: false,\r\n\t\t\tspying: false,\r\n\t\t\tsilencing: false,\r\n\t\t\thosted: true,\r\n\t\t\tchat: false,\r\n\t\t\tchatDirty: true,\r\n\t\t\tname: 'Jhon Appleseed',\r\n\t\t\tuid: '7341614597544882',\r\n\t\t\tshowNavInfo: true,\r\n\t\t};\r\n\t\tthis.state.live = (this.state.role === RoleType.SelfService || this.state.role === RoleType.Embed || DEBUG) ? false : true;\r\n\t\tthis.state.navigable = embedViewId == null;\r\n\t\tthis.state.mode = UserService.getMode(this.state.role);\r\n\t\tthis.view = {\r\n\t\t\tlikes: 41,\r\n\t\t\ttype: {\r\n\t\t\t\tid: 2,\r\n\t\t\t\tname: 'panorama',\r\n\t\t\t},\r\n\t\t};\r\n\t\tthis.local = {};\r\n\t\tthis.screen = null;\r\n\t\tthis.remoteScreen_ = null;\r\n\t\tthis.media = null;\r\n\t\tthis.hasScreenViewItem = false;\r\n\t\tthis.media = true;\r\n\t\tthis.remotes = new Array(8).fill(0).map((x, i) => ({ id: i + 1 }));\r\n\t\tthis.languageService = LanguageService;\r\n\t\tthis.showLanguages = false;\r\n\t\tStateService.patchState(this.state);\r\n\t\tthis.fullscreen$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tconsole.log('LayoutComponent', this);\r\n\t\t// console.log(AgoraService.getUniqueUserId());\r\n\r\n\t\tsetTimeout(() => {\r\n\t\t\tconst type = ToastType.Dialog;\r\n\t\t\tconst position = ToastPosition.BottomRight;\r\n\t\t\tswitch (type) {\r\n\t\t\t\tcase ToastType.Info:\r\n\t\t\t\t\tToastService.open$({\r\n\t\t\t\t\t\tmessage: LabelPipe.transform('bhere_support_request_sent'),\r\n\t\t\t\t\t}).pipe(\r\n\t\t\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t\t\t).subscribe(event => {\r\n\t\t\t\t\t\tif (event instanceof ToastResolveEvent) {\r\n\t\t\t\t\t\t\tconsole.log('ToastResolveEvent', event);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ToastType.Alert:\r\n\t\t\t\t\tToastService.open$({\r\n\t\t\t\t\t\tmessage: LabelPipe.transform('bhere_support_request_sent'),\r\n\t\t\t\t\t\ttype: type, position: ToastPosition.BottomRight,\r\n\t\t\t\t\t}).pipe(\r\n\t\t\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t\t\t).subscribe(event => {\r\n\t\t\t\t\t\tif (event instanceof ToastResolveEvent) {\r\n\t\t\t\t\t\t\tconsole.log('ToastResolveEvent', event);\r\n\t\t\t\t\t\t} else if (event instanceof ToastRejectEvent) {\r\n\t\t\t\t\t\t\tconsole.log('ToastRejectEvent', event);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ToastType.Dialog:\r\n\t\t\t\t\tToastService.open$({\r\n\t\t\t\t\t\tmessage: LabelPipe.transform('bhere_support_request_dialog'),\r\n\t\t\t\t\t\tacceptMessage: LabelPipe.transform('bhere_support_request_dialog_accept'),\r\n\t\t\t\t\t\trejectMessage: LabelPipe.transform('bhere_support_request_dialog_reject'),\r\n\t\t\t\t\t\ttype: type, position: ToastPosition.BottomRight,\r\n\t\t\t\t\t}).pipe(\r\n\t\t\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t\t\t).subscribe(event => {\r\n\t\t\t\t\t\tif (event instanceof ToastResolveEvent) {\r\n\t\t\t\t\t\t\tconsole.log('ToastResolveEvent', event);\r\n\t\t\t\t\t\t} else if (event instanceof ToastRejectEvent) {\r\n\t\t\t\t\t\t\tconsole.log('ToastRejectEvent', event);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}, 3000);\r\n\t}\r\n\r\n\tsetLanguage(language) {\r\n\t\tthis.languageService.setLanguage$(language).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(_ => {\r\n\t\t\tthis.showLanguages = false;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleLanguages() {\r\n\t\tthis.showLanguages = !this.showLanguages;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.screen = this.state.screen || null;\r\n\t\tthis.remoteScreen = this.screen;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tthis.patchState({ screen: !this.state.screen });\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tthis.patchState({ volumeMuted: !this.state.volumeMuted });\r\n\t}\r\n\r\n\ttoggleMode() {\r\n\t\tconst mode = this.state.mode === UIMode.VirtualTour ? UIMode.LiveMeeting : UIMode.VirtualTour;\r\n\t\tthis.patchState({ mode: mode });\r\n\t\t// this.pushChanges();\r\n\t}\r\n\r\n\ttoggleFullScreen() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst fullScreen = !this.state.fullScreen;\r\n\t\tif (fullScreen) {\r\n\t\t\tif (node.requestFullscreen) {\r\n\t\t\t\tnode.requestFullscreen();\r\n\t\t\t} else if (node.webkitRequestFullscreen) {\r\n\t\t\t\tnode.webkitRequestFullscreen();\r\n\t\t\t} else if (node.msRequestFullscreen) {\r\n\t\t\t\tnode.msRequestFullscreen();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (document.exitFullscreen) {\r\n\t\t\t\tdocument.exitFullscreen();\r\n\t\t\t} else if (document.webkitExitFullscreen) {\r\n\t\t\t\tdocument.webkitExitFullscreen();\r\n\t\t\t} else if (document.msExitFullscreen) {\r\n\t\t\t\tdocument.msExitFullscreen();\r\n\t\t\t}\r\n\t\t}\r\n\t\t// this.patchState({ fullScreen });\r\n\t}\r\n\r\n\tfullscreen$() {\r\n\t\treturn fromEvent(document, 'fullscreenchange').pipe(\r\n\t\t\ttap(_ => {\r\n\t\t\t\tconst fullScreen = document.fullscreenElement != null;\r\n\t\t\t\t// console.log('fullscreen$', fullScreen);\r\n\t\t\t\tthis.patchState({ fullScreen });\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tthis.patchState({ chat: !this.state.chat, chatDirty: false });\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\ttoggleNavInfo() {\r\n\t\tthis.patchState({ showNavInfo: !this.state.showNavInfo });\r\n\t}\r\n\r\n\tonBack() {\r\n\t\tconsole.log('LayoutComponent.onBack');\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tthis.patchState({ chat: false });\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tonToggleControl(remoteId) {\r\n\t\tconst controlling = this.state.controlling === remoteId ? null : remoteId;\r\n\t\tthis.patchState({ controlling, spying: false });\r\n\t}\r\n\r\n\tonToggleSilence() {\r\n\t\tthis.patchState({ silencing: !this.state.silencing });\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tconst spying = this.state.spying === remoteId ? null : remoteId;\r\n\t\tthis.patchState({ spying, controlling: false });\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tthis.view.liked = true; // view.liked;\r\n\t\tthis.showLove(this.view);\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\r\n\t}\r\n}\r\n\r\nLayoutComponent.meta = {\r\n\tselector: '[layout-component]',\r\n\thosts: { host: RouterOutletStructure },\r\n\ttemplate: /* html */`\r\n\t<div class=\"page page--agora\">\r\n\t\t${CHUNK_BACKGROUND}\r\n\t\t<!-- Status Checklist -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'checklist'\" [agora-checklist] (checked)=\"onChecked($event)\"></div>\r\n\t\t<!-- Status Link -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'link'\" [agora-link] (link)=\"onLink($event)\"></div>\r\n\t\t<!-- Status Login -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'login'\" [agora-login] (login)=\"onLogin($event)\"></div>\r\n\t\t<!-- Status Name -->\r\n\t\t<div class=\"ui ui--info ui--info-centered\" *if=\"state.status == 'name' || (state.status == 'disconnected' && state.role === 'viewer')\" [agora-name] (name)=\"onName($event)\"></div>\r\n\t\t<!-- Status Device -->\r\n\t\t<div class=\"ui ui--info\" *if=\"state.status == 'device' || (state.status == 'disconnected' && state.role !== 'viewer')\" [agora-device] (enter)=\"onEnter($event)\"></div>\r\n\t\t<!-- Virtual Tour -->\r\n\t\t<div class=\"ui virtual-tour\" [class]=\"uiClass\" *if=\"state.status == 'connected' && isVirtualTourUser\">\r\n\t\t\t<!-- world -->\r\n\t\t\t<div class=\"ui__body\">\r\n\t\t\t\t<div class=\"world\"></div>\r\n\t\t\t</div>\r\n\t\t\t<!-- remote sidebar -->\r\n\t\t\t<div class=\"group--remote\" [class]=\"remoteClass\" *if=\"state.live\">\r\n\t\t\t\t<div class=\"agora-stream\" *for=\"let remote of remotes\">\r\n\t\t\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t\t\t<div class=\"agora-stream__info\" [class]=\"{ spyed: state.spying == remote.id, controlling: state.controlling == remote.id }\">\r\n\t\t\t\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t\t\t\t\t<div class=\"id\">name</div>\r\n\t\t\t\t\t\t<button type=\"button\" class=\"btn--control\" [title]=\"'title_control' | label\" (click)=\"onToggleControl(remote.id)\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t\t\t<svg class=\"control\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#control\"></use></svg>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t<button type=\"button\" class=\"btn--spy\" [title]=\"'title_spy' | label\" (click)=\"onToggleSpy(remote.id)\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#spy\"></use></svg>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"group--members\" *if=\"state.mode == 'virtual-tour'\">\r\n\t\t\t\t\t<div class=\"members\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#users\"></use></svg>\r\n\t\t\t\t\t\t<span class=\"members__count\" [innerHTML]=\"state.membersCount\"></span>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"credits\">\r\n\t\t\t\t\t\t<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\">\r\n\t\t\t\t\t\t\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t\t\t\t\t</a>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- remote screen -->\r\n\t\t\t<div class=\"group--remote-screen\" *if=\"remoteScreen\">\r\n\t\t\t\t<div class=\"agora-stream\">\r\n\t\t\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t\t\t<div class=\"agora-stream__info\">\r\n\t\t\t\t\t\t<div class=\"id\">name</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--header\">\r\n\t\t\t\t<!-- service -->\r\n\t\t\t\t<div class=\"group--service\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--back\" [title]=\"'title_back' | label\" (click)=\"onBack($event)\" *if=\"isBackButtonVisible\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#arrow-prev\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--view-mode\" [title]=\"'title_view_mode' | label\" (click)=\"toggleMode($event)\" *if=\"state.mode != 'embed'\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.mode == 'virtual-tour'\"><use xlink:href=\"#live-meeting\"></use></svg>\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.mode == 'live-meeting'\"><use xlink:href=\"#virtual-tour\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--volume\" [title]=\"'title_volume' | label\" [class]=\"{ muted: state.volumeMuted }\" (click)=\"toggleVolume($event)\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.volumeMuted\"><use xlink:href=\"#volume-on\"></use></svg>\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.volumeMuted\"><use xlink:href=\"#volume-off\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--fullscreen\" [title]=\"'title_fullscreen' | label\" [class]=\"{ muted: state.fullScreen }\" (click)=\"toggleFullScreen($event)\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.fullScreen\"><use xlink:href=\"#fullscreen-on\"></use></svg>\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.fullScreen\"><use xlink:href=\"#fullscreen-off\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--navmap\" [title]=\"'title_navmap' | label\" [class]=\"{ active: state.showNavmap }\" (click)=\"toggleNavmap($event)\" *if=\"navmap && state.mode != 'live-meeting'\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#navmap\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t\t<!-- local streams -->\r\n\t\t\t\t<div class=\"group--local\" [class]=\"{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }\" *if=\"state.live\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--silence\" [title]=\"'title_silence' | label\" [class]=\"{ active: state.silencing }\" (click)=\"onToggleSilence()\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--control\" [title]=\"'title_control' | label\" [class]=\"{ active: state.controlling == state.uid }\" (click)=\"onToggleControl(state.uid)\" *if=\"state.role == 'publisher'\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#control\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<div class=\"agora-stream\" *if=\"!local\"></div>\r\n\t\t\t\t\t<div class=\"agora-stream\" *if=\"local\">\r\n\t\t\t\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t\t\t\t<div class=\"agora-stream__info\">\r\n\t\t\t\t\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t\t\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"agora-stream agora-stream--screen\" *if=\"screen\">\r\n\t\t\t\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--footer\">\r\n\t\t\t\t${CHUNK_CONTROLS}\r\n\t\t\t\t${CHUNK_MEDIA}\r\n\t\t\t\t${CHUNK_AR_VR}\r\n\t\t\t\t${CHUNK_LIKE}\r\n\t\t\t</div>\r\n\t\t\t<!-- members -->\r\n\t\t\t<div class=\"group--members\" *if=\"state.mode == 'live-meeting'\">\r\n\t\t\t\t<div class=\"members\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#users\"></use></svg>\r\n\t\t\t\t\t<span class=\"members__count\" [innerHTML]=\"state.membersCount\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"credits\">\r\n\t\t\t\t\t<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\">\r\n\t\t\t\t\t\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t\t\t\t</a>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t${CHUNK_CHAT}\r\n\t\t\t${CHUNK_LOCK}\r\n\t\t\t${CHUNK_NAVMAP}\r\n\t\t</div>\r\n\t\t<!-- Smart Device -->\r\n\t\t<div class=\"ui remotes\" [class]=\"uiClass\" *if=\"state.status == 'connected' && state.role == 'smart-device'\">\r\n\t\t\t<!-- world -->\r\n\t\t\t<div class=\"ui__body\">\r\n\t\t\t</div>\r\n\t\t\t<!-- remote sidebar -->\r\n\t\t\t<div class=\"group--remote\" [class]=\"remoteClass\" *if=\"state.live\">\r\n\t\t\t\t<div class=\"agora-stream\" *for=\"let remote of remotes\">\r\n\t\t\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t\t\t<div class=\"agora-stream__info\">\r\n\t\t\t\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t\t\t\t\t<div class=\"id\">name</div>\r\n\t\t\t\t\t\t<button type=\"button\" class=\"btn--spy\" [title]=\"'title_spy' | label\" *if=\"state.role === 'publisher'\" (click)=\"onToggleSpy(remote.id)\">\r\n\t\t\t\t\t\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#spy\"></use></svg>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- remote screen -->\r\n\t\t\t<div class=\"group--remote-screen\" *if=\"remoteScreen\">\r\n\t\t\t\t<div class=\"agora-stream\">\r\n\t\t\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t\t\t<div class=\"agora-stream__info\">\r\n\t\t\t\t\t\t<div class=\"id\">name</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- local streams -->\r\n\t\t\t<div class=\"group--local\" [class]=\"{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }\" *if=\"state.live\">\r\n\t\t\t\t<div class=\"agora-stream\" *if=\"local\">\r\n\t\t\t\t\t<div class=\"agora-stream__player\"></div>\r\n\t\t\t\t\t<div class=\"agora-stream__info\">\r\n\t\t\t\t\t\t<svg class=\"cam-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam-muted\"></use></svg>\r\n\t\t\t\t\t\t<svg class=\"mic-muted\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic-muted\"></use></svg>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- controls -->\r\n\t\t\t<div class=\"group--controls\" *if=\"state.live\">\r\n\t\t\t\t<div class=\"group--actions\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--call\" [title]=\"'title_disconnect' | label\" (click)=\"disconnect()\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#call\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--cam\" [title]=\"'title_mute_camera' | label\" [class]=\"{ muted: state.cameraMuted, disabled: !local }\" (click)=\"toggleCamera()\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#cam\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--mic\" [title]=\"'title_mute_mic' | label\" [class]=\"{ muted: state.audioMuted, disabled: !local || silenced }\" (click)=\"toggleAudio()\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#mic\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--screen\" [title]=\"'title_share_screen' | label\" [class]=\"{ active: screen }\" (click)=\"toggleScreen()\" *if=\"('screenShare' | flag) && (state.role == 'publisher' || state.role == 'attendee' || controlling)\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#screen\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--chat\" [title]=\"'title_chat' | label\" [class]=\"{ active: state.chatDirty }\" (click)=\"toggleChat()\" *if=\"('chat' | flag)\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#chat\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--navinfo\" [title]=\"'title_navinfo' | label\" [class]=\"{ active: state.showNavInfo }\" (click)=\"toggleNavInfo()\" *if=\"showNavInfoToggler\">\r\n\t\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#navinfo\"></use></svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<!-- members -->\r\n\t\t\t<div class=\"group--members\">\r\n\t\t\t\t<div class=\"members\" *if=\"state.role === 'publisher'\">\r\n\t\t\t\t\t<svg class=\"spy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#users\"></use></svg>\r\n\t\t\t\t\t<span class=\"members__count\" [innerHTML]=\"state.membersCount\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"credits\">\r\n\t\t\t\t\t<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\">\r\n\t\t\t\t\t\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t\t\t\t</a>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<!-- Self Service Tour -->\r\n\t\t<div class=\"ui\" [class]=\"uiClass\" *if=\"state.status == 'connected' && state.mode == 'self-service-tour'\">\r\n\t\t\t<!-- world -->\r\n\t\t\t<div class=\"ui__body\">\r\n\t\t\t\t<div class=\"world\"></div>\r\n\t\t\t</div>\r\n\t\t\t<!-- service -->\r\n\t\t\t<div class=\"group--service\">\r\n\t\t\t\t<button type=\"button\" class=\"btn--volume\" [title]=\"'title_volume' | label\" [class]=\"{ muted: state.volumeMuted }\" (click)=\"toggleVolume($event)\">\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.volumeMuted\"><use xlink:href=\"#volume-on\"></use></svg>\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.volumeMuted\"><use xlink:href=\"#volume-off\"></use></svg>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--fullscreen\" [title]=\"'title_fullscreen' | label\" [class]=\"{ muted: state.fullScreen }\" (click)=\"toggleFullScreen($event)\">\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.fullScreen\"><use xlink:href=\"#fullscreen-on\"></use></svg>\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.fullScreen\"><use xlink:href=\"#fullscreen-off\"></use></svg>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t\t${CHUNK_AR_VR}\r\n\t\t\t${CHUNK_LIKE}\r\n\t\t</div>\r\n\t\t<!-- Embed -->\r\n\t\t<div class=\"ui\" [class]=\"uiClass\" *if=\"state.status == 'connected' && state.mode == 'embed'\">\r\n\t\t\t<!-- world -->\r\n\t\t\t<div class=\"ui__body\">\r\n\t\t\t\t<div class=\"world\"></div>\r\n\t\t\t</div>\r\n\t\t\t<!-- service -->\r\n\t\t\t<div class=\"group--service\">\r\n\t\t\t\t<button type=\"button\" class=\"btn--volume\" [title]=\"'title_volume' | label\" [class]=\"{ muted: state.volumeMuted }\" (click)=\"toggleVolume($event)\">\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.volumeMuted\"><use xlink:href=\"#volume-on\"></use></svg>\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.volumeMuted\"><use xlink:href=\"#volume-off\"></use></svg>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--fullscreen\" [title]=\"'title_fullscreen' | label\" [class]=\"{ muted: state.fullScreen }\" (click)=\"toggleFullScreen($event)\">\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"!state.fullScreen\"><use xlink:href=\"#fullscreen-on\"></use></svg>\r\n\t\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" *if=\"state.fullScreen\"><use xlink:href=\"#fullscreen-off\"></use></svg>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t\t${CHUNK_AR_VR}\r\n\t\t\t${CHUNK_LIKE}\r\n\t\t</div>\r\n\t\t<a class=\"btn--logo\" [routerLink]=\"':lang.access' | route\" *if=\"state.status != 'connected'\">\r\n\t\t\t<img [src]=\"'logo' | env\" *if=\"'logo' | env\" />\r\n\t\t\t<svg viewBox=\"0 0 270 98\" *if=\"!('logo' | env)\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t</a>\r\n\t\t<a class=\"btn--credits\" href=\"https://www.websolute.com/\" target=\"_blank\" rel=\"noopener\" *if=\"state.status != 'connected'\">\r\n\t\t\t<svg viewBox=\"0 0 270 98\"><use xlink:href=\"#b-here\"></use></svg>\r\n\t\t</a>\r\n\t\t<div class=\"group--language\" language *if=\"state.status != 'connected'\"></div>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { environment } from '../environment';\r\nimport { MeetingUrl } from '../meeting/meeting-url';\r\nimport { RouterOutletStructure } from '../router/router-outlet.structure';\r\nimport { ViewService } from '../view/view.service';\r\n\r\nexport default class TryInARComponent extends Component {\r\n\r\n\tget viewId() {\r\n\t\tconst viewId = this.route ? this.route.params.viewId : undefined;\r\n\t\treturn viewId ? parseInt(viewId) : null;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.route = this.host ? this.host.route : null;\r\n\t\tthis.missingAr = false;\r\n\t\tthis.missingUsdz = false;\r\n\t\tthis.missingGltf = false;\r\n\t\tconst viewId = this.viewId;\r\n\t\t// console.log('TryInARComponent.viewId', viewId);\r\n\t\tif (viewId) {\r\n\t\t\tViewService.viewById$(viewId).pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(view => {\r\n\t\t\t\tif (!view.ar) {\r\n\t\t\t\t\tthis.missingAr = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('TryInARComponent.view', view);\r\n\t\t\t\tif (this.platform === DevicePlatform.IOS) {\r\n\t\t\t\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\t\t\t\tif (usdzSrc) {\r\n\t\t\t\t\t\twindow.location.href = usdzSrc;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.missingUsdz = true;\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (this.getGltfSrc(view) !== null) {\r\n\t\t\t\t\tconst modelViewerNode = this.getModelViewerNode(view);\r\n\t\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\t\tnode.appendChild(modelViewerNode);\r\n\t\t\t\t\tthis.addARScripts();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.missingGltf = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\taddARScripts() {\r\n\t\tlet script = document.createElement('script');\r\n\t\tscript.setAttribute('type', 'module');\r\n\t\tscript.setAttribute('src', 'https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js');\r\n\t\tdocument.head.appendChild(script);\r\n\t\tscript = document.createElement('script');\r\n\t\tscript.setAttribute('nomodule', '');\r\n\t\tscript.setAttribute('src', 'https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js');\r\n\t\tdocument.head.appendChild(script);\r\n\t}\r\n\r\n\tgetUsdzSrc(view) {\r\n\t\treturn (view.ar && view.ar.usdz) ? environment.getPath(view.ar.usdz.folder + view.ar.usdz.file) : null;\r\n\t}\r\n\r\n\tgetGltfSrc(view) {\r\n\t\treturn (view.ar && view.ar.gltf) ? environment.getPath(view.ar.gltf.folder + view.ar.gltf.file) : null;\r\n\t}\r\n\r\n\tgetViewId() {\r\n\t\tconst meetingUrl = new MeetingUrl();\r\n\t\tlet viewId = null;\r\n\t\tif (meetingUrl.viewId) {\r\n\t\t\tviewId = parseInt(meetingUrl.viewId);\r\n\t\t}\r\n\t\treturn viewId;\r\n\t}\r\n\r\n\tgetModelViewerNode(view) {\r\n\t\tconst environmentImage = environment.getPath(environment.textures.envMap);\r\n\t\tconst skyboxImage = environment.getPath(view.asset.folder + view.asset.file);\r\n\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\tconst gltfSrc = this.getGltfSrc(view);\r\n\t\tconst template = /* html */`\r\n\t\t\t<model-viewer alt=\"${view.name}\" environment-image=\"${environmentImage}\" skybox-image=\"${skyboxImage}\" ios-src=\"${usdzSrc}\" src=\"${gltfSrc}\" ar ar-modes=\"webxr scene-viewer quick-look\" ar-scale=\"auto\" camera-controls></model-viewer>\r\n\t\t`;\r\n\t\tconst div = document.createElement('div');\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n}\r\n\r\nTryInARComponent.meta = {\r\n\tselector: '[try-in-ar]',\r\n\thosts: { host: RouterOutletStructure },\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"page page--try-in-ar\">\r\n\t\t\t<!--\r\n\t\t\t<div *if=\"platform != 'ios'\">\r\n\t\t\t\t<script type=\"module\" src=\"https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js\"></script>\r\n\t\t\t\t<script nomodule src=\"https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js\"></script>\r\n\t\t\t</div>\r\n\t\t\t-->\r\n\t\t\t<div class=\"ui\" *if=\"!viewId\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<div class=\"group--info__content\">\r\n\t\t\t\t\t\t<div class=\"info\">Not found.</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"ui\" *if=\"missingAr\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<div class=\"group--info__content\">\r\n\t\t\t\t\t\t<div class=\"info\">Missing AR in view.</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"ui\" *if=\"missingUsdz\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<div class=\"group--info__content\">\r\n\t\t\t\t\t\t<div class=\"info\">Missing .usdz in ar.</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"ui\" *if=\"missingGltf\">\r\n\t\t\t\t<div class=\"group--info\">\r\n\t\t\t\t\t<div class=\"group--info__content\">\r\n\t\t\t\t\t\t<div class=\"info\">Missing .gltf in ar.</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n","import AccessCodeComponent from './access/access-code.component';\r\nimport AccessComponent from './access/access.component';\r\nimport AgoraComponent from './agora/agora.component';\r\nimport EditorComponent from './editor/editor.component';\r\nimport { environment } from './environment';\r\nimport { GenericComponent } from './generic/generic.component';\r\nimport LayoutComponent from './layout/layout.component';\r\nimport TryInARComponent from './try-in-ar/try-in-ar.component';\r\n\r\nconsole.log('environment.defaultLanguage', environment.defaultLanguage);\r\n\r\nexport const AppRoutesInit = () => [\r\n\t{ name: 'index', path: '/', forwardTo: environment.defaultLanguage || 'it' },\r\n\t// it\r\n\t{ name: 'it', path: '/it', defaultParams: { lang: 'it', mode: 'access' }, factory: AccessComponent },\r\n\t{ name: 'it.access', path: '/accesso', defaultParams: { lang: 'it', mode: 'access' }, factory: AccessComponent },\r\n\t{ name: 'it.accessCode', path: '/codice-di-accesso?:p&:link&:name&:role&:viewId&:pathId&:support', defaultParams: { lang: 'it', mode: 'accessCode' }, factory: AccessCodeComponent },\r\n\t{ name: 'it.guidedTour', path: '/tour-guidato?:p&:link&:name&:role&:viewId&:pathId&:support', defaultParams: { lang: 'it', mode: 'guidedTour' }, factory: AgoraComponent },\r\n\t// { name: 'it.guidedTour', path: '/tour-guidato', defaultParams: { lang: 'it', mode: 'guidedTour' }, factory: AgoraComponent },\r\n\t{ name: 'it.selfServiceTour', path: '/tour-self-service?:p&:viewId&:pathId', defaultParams: { lang: 'it', mode: 'selfServiceTour' }, factory: AgoraComponent },\r\n\t{ name: 'it.embed', path: '/embed', defaultParams: { lang: 'it', mode: 'embed' }, factory: AgoraComponent },\r\n\t{ name: 'it.tryInAr', path: '/prova-in-ar?:p&:viewId', defaultParams: { lang: 'it', mode: 'tryInAr' }, factory: TryInARComponent },\r\n\t{ name: 'it.editor', path: '/editor?:p&:viewId', defaultParams: { lang: 'it', mode: 'editor' }, factory: EditorComponent },\r\n\t{ name: 'it.layout', path: '/layout', defaultParams: { lang: 'it', mode: 'layout' }, factory: LayoutComponent },\r\n\t{ name: 'it.privacy', path: '/informativa-sulla-privacy', defaultParams: { lang: 'it', mode: 'privacy_policy' }, factory: GenericComponent },\r\n\t{ name: 'it.terms', path: '/termini-di-utilizzo', defaultParams: { lang: 'it', mode: 'terms' }, factory: GenericComponent },\r\n\t// en\r\n\t{ name: 'en', path: '/en', defaultParams: { lang: 'en', mode: 'access' }, factory: AccessComponent },\r\n\t{ name: 'en.access', path: '/access', defaultParams: { lang: 'en', mode: 'access' }, factory: AccessComponent },\r\n\t{ name: 'en.accessCode', path: '/accesso-code?:p&:link&:name&:role&:viewId&:pathId&:support', defaultParams: { lang: 'en', mode: 'accessCode' }, factory: AccessCodeComponent },\r\n\t{ name: 'en.guidedTour', path: '/guided-tour?:p&:link&:name&:role&:viewId&:pathId&:support', defaultParams: { lang: 'en', mode: 'guidedTour' }, factory: AgoraComponent },\r\n\t// { name: 'en.guidedTour', path: '/guided-tour', defaultParams: { lang: 'en', mode: 'guidedTour' }, factory: AgoraComponent },\r\n\t{ name: 'en.selfServiceTour', path: '/self-service-tour?:p&:viewId&:pathId', defaultParams: { lang: 'en', mode: 'selfServiceTour' }, factory: AgoraComponent },\r\n\t{ name: 'en.embed', path: '/embed', defaultParams: { lang: 'en', mode: 'embed' }, factory: AgoraComponent },\r\n\t{ name: 'en.tryInAr', path: '/try-in-ar?:p&:viewId', defaultParams: { lang: 'en', mode: 'tryInAr' }, factory: TryInARComponent },\r\n\t{ name: 'en.editor', path: '/editor?:p&:viewId', defaultParams: { lang: 'en', mode: 'editor' }, factory: EditorComponent },\r\n\t{ name: 'en.layout', path: '/layout', defaultParams: { lang: 'en', mode: 'layout' }, factory: LayoutComponent },\r\n\t{ name: 'en.privacy', path: '/privacy-policy', defaultParams: { lang: 'en', mode: 'privacy_policy' }, factory: GenericComponent },\r\n\t{ name: 'en.terms', path: '/terms-of-service', defaultParams: { lang: 'en', mode: 'terms' }, factory: GenericComponent },\r\n];\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { AppRoutesInit } from './app.routes';\r\nimport { AssetGroupTypeInit } from './asset/asset';\r\nimport { environment } from './environment';\r\nimport { LanguageService } from './language/language.service';\r\nimport { RouterService } from './router/router.service';\r\nimport { SVG_CHUNK } from './svg/svg.chunks';\r\n\r\nexport default class AppComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst routes = AppRoutesInit();\r\n\t\tRouterService.useBrowser(routes);\r\n\r\n\t\tAssetGroupTypeInit();\r\n\r\n\t\tRouterService.event$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tconst route = event.route;\r\n\t\t\tif (route && route.params.mode === 'embed') {\r\n\t\t\t\tenvironment.flags.like = false;\r\n\t\t\t}\r\n\t\t\tLanguageService.setRoute(route, routes);\r\n\t\t});\r\n\r\n\t\tLanguageService.lang$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(_ => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t}\r\n\r\n}\r\n\r\nAppComponent.meta = {\r\n\tselector: '[b-here-component]',\r\n\ttemplate: /* html */ `\r\n\t\t<!-- svg -->\r\n\t\t${SVG_CHUNK}\r\n\t\t<!-- header -->\r\n\t\t<router-outlet></router-outlet>\r\n\t\t<!-- footer -->\r\n\t\t<div class=\"toast-outlet\" toast-outlet></div>\r\n\t\t<div class=\"modal-outlet\" modal-outlet></div>\r\n\t`,\r\n};\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport { AssetType } from './asset';\r\n\r\nexport const MIME_IMAGE = [\r\n\t'bmp', 'gif', 'ico', 'jpeg', 'jpg', 'png', 'svg', 'tif', 'tiff', 'webp', 'hdr'\r\n];\r\nexport const MIME_AUDIO = [\r\n\t'aac', 'mid', 'midi', 'mp3', 'oga', 'opus', 'wav', 'weba',\r\n];\r\nexport const MIME_VIDEO = [\r\n\t'mp4', 'avi', 'mpeg', 'ogv', 'ts', 'webm', '3gp', '3g2',\r\n];\r\nexport const MIME_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'obj', 'usdz',\r\n];\r\nexport const MIME_STREAM = [\r\n\t'publisherStream', 'nextAttendeeStream', 'publisherScreen', 'attendeeScreen',\r\n];\r\nexport function isImage(path) {\r\n\treturn new RegExp(`/\\.(${MIME_IMAGE.join('|')})$/i`).test(path);\r\n}\r\nexport function isVideo(path) {\r\n\treturn new RegExp(`/\\.(${MIME_VIDEO.join('|')})$/i`).test(path);\r\n}\r\nexport function isModel(path) {\r\n\treturn new RegExp(`/\\.(${MIME_MODEL.join('|')})$/i`).test(path);\r\n}\r\nexport function isStream(path) {\r\n\treturn MIME_STREAM.indexOf(path) !== -1;\r\n}\r\nexport default class AssetPipe extends Pipe {\r\n\tstatic transform(asset, type = null) {\r\n\t\tif (type != null) { // keep loose equality\r\n\t\t\tasset = asset.type.name === type ? asset : null;\r\n\t\t}\r\n\t\tif (asset) {\r\n\t\t\tif (typeof asset === 'string') {\r\n\t\t\t\treturn environment.getPath(asset);\r\n\t\t\t}\r\n\t\t\t// console.log(asset.type.name, AssetType.Image.name);\r\n\t\t\tswitch (asset.type.name) {\r\n\t\t\t\tcase AssetType.Image.name:\r\n\t\t\t\tcase AssetType.Video.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.Model.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\t\tasset = environment.getPath(asset.file);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tif (isImage(asset.file) || isVideo(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isModel(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isStream(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.file;\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tasset = asset;\r\n\t\t} else {\r\n\t\t\tasset = null;\r\n\t\t}\r\n\t\t// console.log('AssetPipe.transform', asset);\r\n\t\treturn asset;\r\n\t}\r\n}\r\nAssetPipe.meta = {\r\n\tname: 'asset',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport { ModalService } from '../modal/modal.service';\r\n\r\nexport default class ControlRequestModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tonAccept(user) {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonReject(user) {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\t/*\r\n\tonDestroy() {\r\n\t\t// console.log('ControlRequestModalComponent.onDestroy');\r\n\t}\r\n\t*/\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nControlRequestModalComponent.meta = {\r\n\tselector: '[control-request-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">L'utente ha richiesto il controllo della navigazione. Accetti?</div>\r\n\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--cancel\" (click)=\"onReject()\">\r\n\t\t\t\t\t\t<span>Rifiuta</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--accept\" (click)=\"onAccept()\">\r\n\t\t\t\t\t\t<span>Accetta</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nControlRequestModalComponent.chunk = () => /* html */`<div class=\"control-request-modal\" control-request-modal></div>`;\r\n","import { Directive, getContext } from 'rxcomp';\nimport { fromEvent } from 'rxjs';\nimport { shareReplay, takeUntil } from 'rxjs/operators';\n\nexport default class DropDirective extends Directive {\n\n\tonInit() {\n\t\tconst { module, node, parentInstance, selector } = getContext(this);\n\t\tconst event = 'drop';\n\t\tconst event$ = fromEvent(node, event).pipe(shareReplay(1));\n\t\tconst expression = node.getAttribute(`(${event})`);\n\t\tif (expression) {\n\t\t\tconst outputFunction = module.makeFunction(expression, ['$event']);\n\t\t\tevent$.pipe(\n\t\t\t\ttakeUntil(this.unsubscribe$)\n\t\t\t).subscribe(event => {\n\t\t\t\tmodule.resolve(outputFunction, parentInstance, event);\n\t\t\t});\n\t\t\tfromEvent(node, 'dragover').pipe(\n\t\t\t\ttakeUntil(this.unsubscribe$)\n\t\t\t).subscribe(event => event.preventDefault());\n\t\t} else {\n\t\t\tparentInstance[`${event}$`] = event$;\n\t\t}\n\t\t// console.log('DropDirective.onInit', 'selector', selector, 'event', event);\n\t}\n\n}\n\nDropDirective.meta = {\n\tselector: `[(drop)]`,\n};\n","import { Directive, getContext } from 'rxcomp';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { takeUntil } from 'rxjs/operators';\r\n\r\nlet DROPDOWN_ID = 1000000;\r\n\r\nexport default class DropdownDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this.dropdown || this.id_ || (this.id_ = DropdownDirective.nextId());\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst trigger = node.getAttribute('dropdown-trigger');\r\n\t\tthis.trigger = trigger ? node.querySelector(trigger) : node;\r\n\t\tthis.opened = null;\r\n\t\tthis.onClick = this.onClick.bind(this);\r\n\t\tthis.onDocumentClick = this.onDocumentClick.bind(this);\r\n\t\tthis.openDropdown = this.openDropdown.bind(this);\r\n\t\tthis.closeDropdown = this.closeDropdown.bind(this);\r\n\t\tthis.addListeners();\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.openDropdown();\r\n\t\t} else {\r\n\t\t\tconst dropdownItemNode = node.querySelector('[dropdown-item]');\r\n\t\t\t// console.log('dropdownItemNode', dropdownItemNode);\r\n\t\t\tif (!dropdownItemNode) { // if (this.trigger !== node) {\r\n\t\t\t\tthis.closeDropdown();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDocumentClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst clickedInside = node === event.target || node.contains(event.target);\r\n\t\tif (!clickedInside) {\r\n\t\t\tthis.closeDropdown();\r\n\t\t}\r\n\t}\r\n\r\n\topenDropdown() {\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.opened = true;\r\n\t\t\tthis.addDocumentListeners();\r\n\t\t\tDropdownDirective.dropdown$.next(this.id);\r\n\t\t\tthis.dropped.next(this.id);\r\n\t\t}\r\n\t}\r\n\r\n\tcloseDropdown() {\r\n\t\tif (this.opened !== null) {\r\n\t\t\tthis.removeDocumentListeners();\r\n\t\t\tthis.opened = null;\r\n\t\t\tif (DropdownDirective.dropdown$.getValue() === this.id) {\r\n\t\t\t\tDropdownDirective.dropdown$.next(null);\r\n\t\t\t\tthis.dropped.next(null);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.trigger.addEventListener('click', this.onClick);\r\n\t}\r\n\r\n\taddDocumentListeners() {\r\n\t\tdocument.addEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\tthis.trigger.removeEventListener('click', this.onClick);\r\n\t}\r\n\r\n\tremoveDocumentListeners() {\r\n\t\tdocument.removeEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tthis.removeDocumentListeners();\r\n\t}\r\n\r\n\tstatic nextId() {\r\n\t\treturn DROPDOWN_ID++;\r\n\t}\r\n\r\n}\r\n\r\nDropdownDirective.meta = {\r\n\tselector: '[dropdown]',\r\n\tinputs: ['dropdown', 'dropdown-trigger'],\r\n\toutputs: ['dropped']\r\n};\r\n\r\nDropdownDirective.dropdown$ = new BehaviorSubject(null);\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport DropdownDirective from './dropdown.directive';\r\n\r\nexport default class DropdownItemDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this['dropdown-item'];\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('dropdown-item');\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownItemDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nDropdownItemDirective.meta = {\r\n\tselector: '[dropdown-item], [[dropdown-item]]',\r\n\tinputs: ['dropdown-item']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ToastService from './toast.service';\r\n\r\nexport default class ToastOutletComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.toast = null;\r\n\t\tthis.lastToast = null;\r\n\t\tToastService.toast$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(toast => {\r\n\t\t\tif (toast) {\r\n\t\t\t\tthis.lastToast = toast;\r\n\t\t\t}\r\n\t\t\tthis.toast = toast;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t// console.log('ToastOutletComponent.onInit');\r\n\t}\r\n\r\n\tgetClass() {\r\n\t\tconst classList = {};\r\n\t\tif (this.toast) {\r\n\t\t\tclassList.active = true;\r\n\t\t}\r\n\t\tif (this.lastToast) {\r\n\t\t\tclassList[this.lastToast.type] = true;\r\n\t\t\tclassList[this.lastToast.position] = true;\r\n\t\t}\r\n\t\treturn classList;\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tToastService.reject(this.toast);\r\n\t}\r\n\r\n\tonAccept() {\r\n\t\tToastService.resolve(this.toast);\r\n\t}\r\n\r\n\tonReject() {\r\n\t\tToastService.reject(this.toast);\r\n\t}\r\n\r\n}\r\n\r\nToastOutletComponent.meta = {\r\n\tselector: '[toast-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"toast-outlet__container\" [class]=\"getClass()\">\r\n\t\t<div class=\"toast-outlet__toast\" *if=\"lastToast\">\r\n\t\t\t<span class=\"toast-outlet__message\" [innerHTML]=\"lastToast.message\"></span>\r\n\t\t\t<div class=\"group--cta\" *if=\"lastToast.type != 'info'\">\r\n\t\t\t\t<button type=\"button\" class=\"btn--accept\" (click)=\"onAccept()\">\r\n\t\t\t\t\t<span [innerHTML]=\"lastToast.acceptMessage\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--cancel\" (click)=\"onReject()\" *if=\"lastToast.type == 'dialog'\">\r\n\t\t\t\t\t<span [innerHTML]=\"lastToast.rejectMessage\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\" *if=\"lastToast.type != 'info'\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { environment } from '../../environment';\r\nimport { LabelPipe } from '../../label/label.pipe';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\n\r\nexport default class AsideComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.mode = 1;\r\n\t\tthis.viewTypes = Object.keys(ViewType).map(key => {\r\n\t\t\tconst type = ViewType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.viewItemTypes = Object.keys(ViewItemType).map(key => {\r\n\t\t\tconst type = ViewItemType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewItemTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tsetSupportedViewTypes() {\r\n\t\tthis.supportedViewTypes = this.viewTypes.filter(x => this.supportedViewType(x.type.name)).sort((a, b) => {\r\n\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t} else {\r\n\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetSupportedViewItemTypes() {\r\n\t\tif (this.view) {\r\n\t\t\tthis.supportedViewItemTypes = this.viewItemTypes.filter(x => this.supportedViewItemType(this.view.type.name, x.type.name)).sort((a, b) => {\r\n\t\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.supportedViewItemTypes = [];\r\n\t\t}\r\n\t}\r\n\r\n\tsetMode(mode) {\r\n\t\tif (this.mode !== mode) {\r\n\t\t\tthis.mode = mode;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tsupportedViewType(viewTypeName) {\r\n\t\tlet supported = [ViewType.Panorama.name, ViewType.PanoramaGrid.name, ViewType.Room3d.name, ViewType.Model.name, ViewType.Media.name].indexOf(viewTypeName) !== -1; // ViewType.WaitingRoom,\r\n\t\t// console.log('supportedViewType', viewType, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tsupportedViewItemType(viewTypeName, viewItemTypeName) {\r\n\t\tlet supported;\r\n\t\tswitch (viewTypeName) {\r\n\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\tsupported = false;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.Texture.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Model.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Media.name:\r\n\t\t\t\tsupported = [].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t// console.log('supportedViewItemType', viewTypeName, viewItemTypeName, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next(event);\r\n\t}\r\n\r\n\tonUpdate(event) {\r\n\t\tthis.update.next(event);\r\n\t}\r\n\r\n\tonDelete(event) {\r\n\t\tthis.delete.next(event);\r\n\t}\r\n}\r\n\r\nAsideComponent.meta = {\r\n\tselector: '[aside]',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"headline\">\r\n\t\t<ul class=\"nav--tab\">\r\n\t\t\t<li [class]=\"{ active: mode === 1 }\" (click)=\"setMode(1)\" [innerHTML]=\"'editor_properties' | label\"></li>\r\n\t\t\t<li [class]=\"{ active: mode === 2 }\" (click)=\"setMode(2)\" [innerHTML]=\"'editor_views' | label\"></li>\r\n\t\t\t<li [class]=\"{ active: mode === 3 }\" (click)=\"setMode(3)\" [innerHTML]=\"'editor_view_items' | label\"></li>\r\n\t\t</ul>\r\n\t\t<!--\r\n\t\t<div class=\"btn--mode\" [class]=\"{ active: mode === 1 }\" (click)=\"setMode(1)\" [innerHTML]=\"'editor_properties' | label\"></div>\r\n\t\t<div class=\"btn--mode\" [class]=\"{ active: mode === 2 }\" (click)=\"setMode(2)\" [innerHTML]=\"'editor_views' | label\"></div>\r\n\t\t<div class=\"btn--mode\" [class]=\"{ active: mode === 3 }\" (click)=\"setMode(3)\" [innerHTML]=\"'editor_view_items' | label\"></div>\r\n\t\t-->\r\n\t</div>\r\n\t<div class=\"scrollable\">\r\n\t\t<ul class=\"nav--editor\" *if=\"mode === 1\">\r\n\t\t\t<li>\r\n\t\t\t\t<div class=\"title\" [innerHTML]=\"'editor_properties' | label\"></div>\r\n\t\t\t\t<update-view [view]=\"view\" (select)=\"onSelect($event)\" (update)=\"onUpdate($event)\" (delete)=\"onDelete($event)\"></update-view>\r\n\t\t\t</li>\r\n\t\t\t<li *if=\"view.type.name != 'panorama-grid'\">\r\n\t\t\t\t<div class=\"title\" [innerHTML]=\"'editor_items' | label\"></div>\r\n\t\t\t\t<update-view-item [view]=\"view\" [item]=\"item\" (select)=\"onSelect($event)\" (update)=\"onUpdate($event)\" (delete)=\"onDelete($event)\" *for=\"let item of view.pathItems\"></update-view-item>\r\n\t\t\t\t<div class=\"abstract\" *if=\"view.pathItems.length == 0\" [innerHTML]=\"'editor_no_items' | label\"></div>\r\n\t\t\t\t<div class=\"btn--mode\" (click)=\"setMode(3)\" [innerHTML]=\"'editor_add_item' | label\"></div>\r\n\t\t\t</li>\r\n\t\t\t<li *if=\"view.type.name == 'panorama-grid'\">\r\n\t\t\t\t<div class=\"title\" [innerHTML]=\"'editor_tiles' | label\"></div>\r\n\t\t\t\t<div *for=\"let tile of view.tiles\">\r\n\t\t\t\t\t<div *if=\"tile.selected\">\r\n\t\t\t\t\t\t<update-view-tile [view]=\"view\" [tile]=\"tile\" (update)=\"onUpdate($event)\" (delete)=\"onDelete($event)\"></update-view-tile>\r\n\t\t\t\t\t\t<ul class=\"nav--editor\">\r\n\t\t\t\t\t\t\t<li>\r\n\t\t\t\t\t\t\t\t<update-view-item [view]=\"view\" [item]=\"item\" (select)=\"onSelect($event)\" (update)=\"onUpdate($event)\" (delete)=\"onDelete($event)\" *for=\"let item of tile.navs\"></update-view-item>\r\n\t\t\t\t\t\t\t\t<div class=\"abstract\" *if=\"tile.navs.length == 0\" [innerHTML]=\"'editor_no_navs' | label\"></div>\r\n\t\t\t\t\t\t\t\t<div class=\"btn--mode\" (click)=\"onSelect({ type:'viewItem', value: 'nav', tile: tile })\" [innerHTML]=\"'editor_add_nav' | label\"></div>\r\n\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t<!--\r\n\t\t\t\t\t\t\t<li>\r\n\t\t\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect({ type:'viewItem', value: 'nav', tile: tile })\">\r\n\t\t\t\t\t\t\t\t\t<div class=\"icon\">\r\n\t\t\t\t\t\t\t\t\t\t<svg-icon name=\"nav\"></svg-icon>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"'editor_add_nav' | label\"></div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</li>\r\n\t\t\t\t\t\t\t-->\r\n\t\t\t\t\t\t</ul>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"abstract\" *if=\"view.tiles.length == 0\" [innerHTML]=\"'editor_no_tiles' | label\"></div>\r\n\t\t\t\t<!-- <div class=\"btn--mode\" (click)=\"setMode(3)\">Add Tile</div> -->\r\n\t\t\t</li>\r\n\t\t\t<!--\r\n\t\t\t<li *if=\"false\">\r\n\t\t\t\t<div class=\"title\">Icons</div>\r\n\t\t\t\t<ul class=\"nav--editor\">\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('animated-tabs')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.3\"></path><path d=\"M 2 8.4 L 12 8.4 L 12 2 L 6 2 C 3.791 2 2 3.791 2 6 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 12 8.4 L 22 8.4 L 22 6 C 22 3.791 20.209 2 18 2 L 12 2 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Animated Tabs</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('card-list')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.3\"></path><path d=\"M 6.8 13.6 C 6.8 13.158 7.158 12.8 7.6 12.8 L 16.8 12.8 C 17.242 12.8 17.6 13.158 17.6 13.6 L 17.6 16.8 C 17.6 17.242 17.242 17.6 16.8 17.6 L 7.6 17.6 C 7.158 17.6 6.8 17.242 6.8 16.8 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 6.8 7.2 C 6.8 6.758 7.158 6.4 7.6 6.4 L 16.8 6.4 C 17.242 6.4 17.6 6.758 17.6 7.2 L 17.6 10.4 C 17.6 10.842 17.242 11.2 16.8 11.2 L 7.6 11.2 C 7.158 11.2 6.8 10.842 6.8 10.4 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Card List</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('container-transitions')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 15.667 13 C 17.139 13 18.333 14.194 18.333 15.667 C 18.333 17.139 17.139 18.333 15.667 18.333 C 14.194 18.333 13 17.139 13 15.667 C 13 14.194 14.194 13 15.667 13 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Container Transitions</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('dynamic-grid')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.3\"></path><g transform=\"translate(6.6 6.6)\"><path d=\"M 6.048 0.8 C 6.048 0.358 6.406 0 6.848 0 L 10 0 C 10.442 0 10.8 0.358 10.8 0.8 L 10.8 3.952 C 10.8 4.394 10.442 4.752 10 4.752 L 6.848 4.752 C 6.406 4.752 6.048 4.394 6.048 3.952 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.5\"></path><path d=\"M 6.048 6.848 C 6.048 6.406 6.406 6.048 6.848 6.048 L 10 6.048 C 10.442 6.048 10.8 6.406 10.8 6.848 L 10.8 10 C 10.8 10.442 10.442 10.8 10 10.8 L 6.848 10.8 C 6.406 10.8 6.048 10.442 6.048 10 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 0 0.8 C 0 0.358 0.358 0 0.8 0 L 3.952 0 C 4.394 0 4.752 0.358 4.752 0.8 L 4.752 3.952 C 4.752 4.394 4.394 4.752 3.952 4.752 L 0.8 4.752 C 0.358 4.752 0 4.394 0 3.952 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 0 6.848 C 0 6.406 0.358 6.048 0.8 6.048 L 3.952 6.048 C 4.394 6.048 4.752 6.406 4.752 6.848 L 4.752 10 C 4.752 10.442 4.394 10.8 3.952 10.8 L 0.8 10.8 C 0.358 10.8 0 10.442 0 10 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.5\"></path></g></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Dynamic Grid</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('expand-on-tap')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 0 0 L 7.833 0\" transform=\"translate(8.583 11.583) rotate(270 3.917 0.5)\" fill=\"transparent\" stroke-width=\"1.67\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 14.667 9.333 L 12 6.667 L 9.333 9.333\" stroke=\"var(--svg-icon-tint)\" fill=\"transparent\" stroke-width=\"1.67\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 14.667 14.667 L 12 17.333 L 9.333 14.667\" stroke=\"var(--svg-icon-tint)\" fill=\"transparent\" stroke-width=\"1.67\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path> </svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Expand on Tap</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('image-gallery-2')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 10.333 7.333 C 10.886 7.333 11.333 7.781 11.333 8.333 L 11.333 10.333 C 11.333 10.886 10.886 11.333 10.333 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 12.333 8.333 C 12.333 7.781 12.781 7.333 13.333 7.333 L 15.333 7.333 C 15.886 7.333 16.333 7.781 16.333 8.333 L 16.333 10.333 C 16.333 10.886 15.886 11.333 15.333 11.333 L 13.333 11.333 C 12.781 11.333 12.333 10.886 12.333 10.333 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.333 12.667 C 15.886 12.667 16.333 13.114 16.333 13.667 L 16.333 15.667 C 16.333 16.219 15.886 16.667 15.333 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Image Gallery 2</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('stories-ui')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.3\"></path><path d=\"M 6.8 4.8 C 7.905 4.8 8.8 5.695 8.8 6.8 C 8.8 7.905 7.905 8.8 6.8 8.8 C 5.695 8.8 4.8 7.905 4.8 6.8 C 4.8 5.695 5.695 4.8 6.8 4.8 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 12 4.8 C 13.105 4.8 14 5.695 14 6.8 C 14 7.905 13.105 8.8 12 8.8 C 10.895 8.8 10 7.905 10 6.8 C 10 5.695 10.895 4.8 12 4.8 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 17.2 4.8 C 18.305 4.8 19.2 5.695 19.2 6.8 C 19.2 7.905 18.305 8.8 17.2 8.8 C 16.095 8.8 15.2 7.905 15.2 6.8 C 15.2 5.695 16.095 4.8 17.2 4.8 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Stories UI</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('todo-list')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 8 12.333 L 10.5 14.833 L 16 9.333\" stroke=\"var(--svg-icon-tint)\" fill=\"transparent\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">To-Do List</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('toggle-menu')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 17.333 15.333 C 18.438 15.333 19.333 16.229 19.333 17.333 C 19.333 18.438 18.438 19.333 17.333 19.333 C 16.229 19.333 15.333 18.438 15.333 17.333 C 15.333 16.229 16.229 15.333 17.333 15.333 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 17.333 10 C 18.438 10 19.333 10.895 19.333 12 C 19.333 13.105 18.438 14 17.333 14 C 16.229 14 15.333 13.105 15.333 12 C 15.333 10.895 16.229 10 17.333 10 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 17.333 4.667 C 18.438 4.667 19.333 5.562 19.333 6.667 C 19.333 7.771 18.438 8.667 17.333 8.667 C 16.229 8.667 15.333 7.771 15.333 6.667 C 15.333 5.562 16.229 4.667 17.333 4.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Toggle Menu</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('bottom-sheet')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 10.333 C 22 10.886 21.552 11.333 21 11.333 L 3 11.333 C 2.448 11.333 2 10.886 2 10.333 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 2 13.333 C 2 12.781 2.448 12.333 3 12.333 L 21 12.333 C 21.552 12.333 22 12.781 22 13.333 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Bottom Sheet</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('draggable-sheet')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 2 14 C 2 12.895 2.895 12 4 12 L 20 12 C 21.105 12 22 12.895 22 14 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z M 10.667 15.333 L 13.333 15.333 C 13.702 15.333 14 15.035 14 14.667 C 14 14.298 13.702 14 13.333 14 L 10.667 14 C 10.298 14 10 14.298 10 14.667 C 10 15.035 10.298 15.333 10.667 15.333 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Draggable Sheet</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('modal-box')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.333 9.333 C 7.333 8.229 8.229 7.333 9.333 7.333 L 14.667 7.333 C 15.771 7.333 16.667 8.229 16.667 9.333 L 16.667 14.667 C 16.667 15.771 15.771 16.667 14.667 16.667 L 9.333 16.667 C 8.229 16.667 7.333 15.771 7.333 14.667 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Modal Box</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('side-menu')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 11 2 C 11.552 2 12 2.448 12 3 L 12 21 C 12 21.552 11.552 22 11 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Side Menu</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('input-form')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 11.667 7.333 C 11.667 7.333 11.667 7.333 11.667 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 9 C 16.667 9.552 16.219 10 15.667 10 L 13.333 10 L 13.333 15.667 C 13.333 16.219 12.886 16.667 12.333 16.667 L 11.667 16.667 C 11.114 16.667 10.667 16.219 10.667 15.667 L 10.667 10 L 8.333 10 C 7.781 10 7.333 9.552 7.333 9 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Input Form</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('loading-indicator')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.3\"></path><path d=\"M 16.4 10.4 C 17.284 10.4 18 11.116 18 12 C 18 12.884 17.284 13.6 16.4 13.6 C 15.516 13.6 14.8 12.884 14.8 12 C 14.8 11.116 15.516 10.4 16.4 10.4 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 12 10.4 C 12.884 10.4 13.6 11.116 13.6 12 C 13.6 12.884 12.884 13.6 12 13.6 C 11.116 13.6 10.4 12.884 10.4 12 C 10.4 11.116 11.116 10.4 12 10.4 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 7.6 10.4 C 8.484 10.4 9.2 11.116 9.2 12 C 9.2 12.884 8.484 13.6 7.6 13.6 C 6.716 13.6 6 12.884 6 12 C 6 11.116 6.716 10.4 7.6 10.4 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Loading Indicator</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('radio-button-form')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 9.833 8.167 L 14.167 8.167 C 16.284 8.167 18 9.883 18 12 C 18 14.117 16.284 15.833 14.167 15.833 L 9.833 15.833 C 7.716 15.833 6 14.117 6 12 C 6 9.883 7.716 8.167 9.833 8.167 Z M 11.333 12 C 11.333 13.473 12.527 14.667 14 14.667 C 15.473 14.667 16.667 13.473 16.667 12 C 16.667 10.527 15.473 9.333 14 9.333 C 12.527 9.333 11.333 10.527 11.333 12 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Radio Button Form</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('checkbox-form')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 8.651 6.931 C 7.911 6.738 7.238 7.411 7.431 8.151 L 9.363 15.558 C 9.592 16.435 10.775 16.58 11.208 15.784 L 13 12.5 L 16.284 10.708 C 17.08 10.275 16.935 9.092 16.058 8.863 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 16 15.5 L 11 10.5\" fill=\"transparent\" stroke-width=\"1.67\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Checkbox Form</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('splash-screen')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.757 13.414 C 6.976 12.633 6.976 11.367 7.757 10.586 L 10.586 7.757 C 11.367 6.976 12.633 6.976 13.414 7.757 L 16.243 10.586 C 17.024 11.367 17.024 12.633 16.243 13.414 L 13.414 16.243 C 12.633 17.024 11.367 17.024 10.586 16.243 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Splash Screen</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('timeout-transition')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 1 5.8 C 1 3.149 3.149 1 5.8 1 L 18.2 1 C 20.851 1 23 3.149 23 5.8 L 23 18.2 C 23 20.851 20.851 23 18.2 23 L 5.8 23 C 3.149 23 1 20.851 1 18.2 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.3\"></path><path d=\"M 12 6.72 C 14.916 6.72 17.28 9.084 17.28 12 C 17.28 14.916 14.916 17.28 12 17.28 C 9.084 17.28 6.72 14.916 6.72 12 C 6.72 9.084 9.084 6.72 12 6.72 Z M 11.34 12 C 11.34 12.365 11.635 12.66 12 12.66 L 14.2 12.66 C 14.565 12.66 14.86 12.365 14.86 12 C 14.86 11.635 14.565 11.34 14.2 11.34 L 12.66 11.34 L 12.66 9.8 C 12.66 9.435 12.365 9.14 12 9.14 C 11.635 9.14 11.34 9.435 11.34 9.8 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Timeout Transition</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('accordion-menu')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 16 10.667 L 12 14.667 L 8 10.667\" fill=\"transparent\" stroke-width=\"2\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Accordion Menu</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('drop-on-scroll')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 0 0 L 8 0\" transform=\"translate(8.5 11.5) rotate(270 4 0.5)\" fill=\"transparent\" stroke-width=\"1.67\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 15.333 11.333 L 12 8 L 8.667 11.333\" fill=\"transparent\" stroke-width=\"1.67\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Drop on Scroll</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('nested-scroll')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 7 C 21.82 7.552 21.372 8 20.82 8 L 2.82 8 C 2.267 8 1.82 7.552 1.82 7 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 1.82 17 C 1.82 16.448 2.267 16 2.82 16 L 20.82 16 C 21.372 16 21.82 16.448 21.82 17 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 8.82 10 C 8.82 9.448 9.267 9 9.82 9 L 20.82 9 C 21.372 9 21.82 9.448 21.82 10 L 21.82 14 C 21.82 14.552 21.372 15 20.82 15 L 9.82 15 C 9.267 15 8.82 14.552 8.82 14 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 1.82 10 C 1.82 9.448 2.267 9 2.82 9 L 6.82 9 C 7.372 9 7.82 9.448 7.82 10 L 7.82 14 C 7.82 14.552 7.372 15 6.82 15 L 2.82 15 C 2.267 15 1.82 14.552 1.82 14 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Nested Scroll</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('star-rating')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 11.399 6.884 C 11.645 6.386 12.355 6.386 12.601 6.884 L 13.705 9.122 C 13.803 9.32 13.992 9.457 14.21 9.489 L 16.68 9.848 C 17.229 9.928 17.449 10.603 17.051 10.99 L 15.264 12.733 C 15.106 12.887 15.034 13.108 15.071 13.326 L 15.493 15.786 C 15.587 16.333 15.013 16.75 14.521 16.492 L 12.312 15.331 C 12.117 15.228 11.883 15.228 11.688 15.331 L 9.479 16.492 C 8.987 16.75 8.413 16.333 8.507 15.786 L 8.929 13.326 C 8.966 13.108 8.894 12.887 8.736 12.733 L 6.949 10.99 C 6.551 10.603 6.771 9.928 7.32 9.848 L 9.79 9.489 C 10.008 9.457 10.197 9.32 10.295 9.122 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Star Rating</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('swipe-menu')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 17.33 C 2 16.595 2.595 16 3.33 16 L 21 16 C 21.552 16 22 16.448 22 17 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 2 10 C 2 9.448 2.448 9 3 9 L 14 9 C 14.552 9 15 9.448 15 10 L 15 14 C 15 14.552 14.552 15 14 15 L 3 15 C 2.448 15 2 14.552 2 14 Z M 19 9 C 20.657 9 22 10.343 22 12 C 22 13.657 20.657 15 19 15 C 17.343 15 16 13.657 16 12 C 16 10.343 17.343 9 19 9 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 7 C 22 7.552 21.552 8 21 8 L 3 8 C 2.448 8 2 7.552 2 7 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Swipe Menu</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('switch-sheet')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 15.667 13.333 C 17.139 13.333 18.333 14.527 18.333 16 C 18.333 17.473 17.139 18.667 15.667 18.667 C 14.194 18.667 13 17.473 13 16 C 13 14.527 14.194 13.333 15.667 13.333 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 8.333 13.333 C 9.806 13.333 11 14.527 11 16 C 11 17.473 9.806 18.667 8.333 18.667 C 6.861 18.667 5.667 17.473 5.667 16 C 5.667 14.527 6.861 13.333 8.333 13.333 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Switch Sheet</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('tab-menu')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 10 15.333 L 14 15.333 L 14 18.667 L 10 18.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 5.333 16.333 C 5.333 15.781 5.781 15.333 6.333 15.333 L 9.333 15.333 L 9.333 18.667 L 6.333 18.667 C 5.781 18.667 5.333 18.219 5.333 17.667 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 18.667 16.333 C 18.667 15.781 18.219 15.333 17.667 15.333 L 14.667 15.333 L 14.667 18.667 L 17.667 18.667 C 18.219 18.667 18.667 18.219 18.667 17.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Tab Menu</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('wheel-picker')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 3.667 6 C 3.667 3.791 5.458 2 7.667 2 L 16.333 2 C 18.542 2 20.333 3.791 20.333 6 L 20.333 7 C 20.333 7.552 19.886 8 19.333 8 L 4.667 8 C 4.114 8 3.667 7.552 3.667 7 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 2 11 C 2 9.895 2.895 9 4 9 L 20 9 C 21.105 9 22 9.895 22 11 L 22 13 C 22 14.105 21.105 15 20 15 L 4 15 C 2.895 15 2 14.105 2 13 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 3.667 17 C 3.667 16.448 4.114 16 4.667 16 L 19.333 16 C 19.886 16 20.333 16.448 20.333 17 L 20.333 18 C 20.333 20.209 18.542 22 16.333 22 L 7.667 22 C 5.458 22 3.667 20.209 3.667 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Wheel Picker</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('cover-flow')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 11.333 17.962 C 11.333 18.385 11.068 18.762 10.67 18.904 L 4.673 21.045 C 3.37 21.511 2 20.545 2 19.162 L 2 4.838 C 2 3.455 3.37 2.489 4.673 2.955 L 10.67 5.096 C 11.068 5.238 11.333 5.615 11.333 6.038 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 22 4.838 C 22 3.455 20.63 2.489 19.327 2.955 L 13.33 5.096 C 12.932 5.238 12.667 5.615 12.667 6.038 L 12.667 17.962 C 12.667 18.385 12.932 18.762 13.33 18.904 L 19.327 21.045 C 20.63 21.511 22 20.545 22 19.162 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Cover Flow</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('cube-effect')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6.743 C 2 5.898 2.531 5.144 3.327 4.859 L 9.997 2.477 C 10.648 2.245 11.333 2.727 11.333 3.419 L 11.333 20.581 C 11.333 21.273 10.648 21.755 9.997 21.523 L 3.327 19.141 C 2.531 18.856 2 18.102 2 17.257 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 12.667 3.419 C 12.667 2.727 13.352 2.245 14.003 2.477 L 20.673 4.859 C 21.469 5.144 22 5.898 22 6.743 L 22 17.257 C 22 18.102 21.469 18.856 20.673 19.141 L 14.003 21.523 C 13.352 21.755 12.667 21.273 12.667 20.581 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Cube Effect</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('flip-effect')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 11.333 4.667 C 11.333 4.114 10.886 3.667 10.333 3.667 L 4 3.667 C 2.895 3.667 2 4.562 2 5.667 L 2 18.333 C 2 19.438 2.895 20.333 4 20.333 L 10.333 20.333 C 10.886 20.333 11.333 19.886 11.333 19.333 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 20 4.167 C 20 3.891 20.224 3.667 20.5 3.667 L 20.5 3.667 C 21.328 3.667 22 4.338 22 5.167 L 22 18.833 C 22 19.662 21.328 20.333 20.5 20.333 L 20.5 20.333 C 20.224 20.333 20 20.109 20 19.833 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 18.667 4.631 C 18.667 3.309 17.406 2.35 16.131 2.704 L 13.399 3.463 C 12.966 3.583 12.667 3.978 12.667 4.427 L 12.667 19.573 C 12.667 20.022 12.966 20.417 13.399 20.537 L 16.131 21.296 C 17.406 21.65 18.667 20.691 18.667 19.369 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Flip Effect</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('parallax-scroll')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 12 6.667 C 12 5.562 12.895 4.667 14 4.667 L 17.333 4.667 C 18.438 4.667 19.333 5.562 19.333 6.667 L 19.333 10 C 19.333 11.105 18.438 12 17.333 12 L 14 12 C 12.895 12 12 11.105 12 10 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 4.667 14 C 4.667 12.895 5.562 12 6.667 12 L 10 12 C 11.105 12 12 12.895 12 14 L 12 17.333 C 12 18.438 11.105 19.333 10 19.333 L 6.667 19.333 C 5.562 19.333 4.667 18.438 4.667 17.333 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Parallax Scroll</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('pile-effect')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 6.5 4 C 6.224 4 6 3.776 6 3.5 L 6 3.5 C 6 2.672 6.672 2 7.5 2 L 16.5 2 C 17.328 2 18 2.672 18 3.5 L 18 3.5 C 18 3.776 17.776 4 17.5 4 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 4.5 7 C 4.224 7 4 6.776 4 6.5 L 4 6.5 C 4 5.672 4.672 5 5.5 5 L 18.5 5 C 19.328 5 20 5.672 20 6.5 L 20 6.5 C 20 6.776 19.776 7 19.5 7 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.7\"></path><path d=\"M 0 2.67 C 0 1.195 1.195 0 2.67 0 L 11.33 0 C 12.805 0 14 1.195 14 2.67 L 14 17.33 C 14 18.805 12.805 20 11.33 20 L 2.67 20 C 1.195 20 0 18.805 0 17.33 Z\" transform=\"translate(5 5) rotate(-90 7 10)\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Pile Effect</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('shuffle')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 15.174 10.452 L 16.708 9.06 L 15.174 7.667\" fill=\"transparent\" stroke-width=\"1.33\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 15.174 16.333 L 16.708 14.94 L 15.174 13.548\" fill=\"transparent\" stroke-width=\"1.33\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 16.145 9.06 C 16.145 9.06 13.982 8.542 12.617 9.679 C 11.252 10.815 11.829 12.213 10.776 13.548 C 9.724 14.882 7.708 14.94 7.708 14.94\" fill=\"transparent\" stroke-width=\"1.33\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 16.145 14.823 C 16.145 14.823 13.982 15.34 12.617 14.204 C 11.252 13.068 11.829 11.669 10.776 10.335 C 9.724 9.001 7.708 8.942 7.708 8.942\" fill=\"transparent\" stroke-width=\"1.33\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Shuffle</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('svg-animation')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 8 12.333 L 10.5 14.833 L 16 9.333\" stroke=\"var(--svg-icon-tint)\" fill=\"transparent\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">SVG Animation</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('google-sheets')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7 8.667 C 7 8.206 7.373 7.833 7.833 7.833 L 7.833 7.833 C 8.294 7.833 8.667 8.206 8.667 8.667 L 8.667 8.667 C 8.667 9.127 8.294 9.5 7.833 9.5 L 7.833 9.5 C 7.373 9.5 7 9.127 7 8.667 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 7 12 C 7 11.54 7.373 11.167 7.833 11.167 L 7.833 11.167 C 8.294 11.167 8.667 11.54 8.667 12 L 8.667 12 C 8.667 12.46 8.294 12.833 7.833 12.833 L 7.833 12.833 C 7.373 12.833 7 12.46 7 12 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 7 15.333 C 7 14.873 7.373 14.5 7.833 14.5 L 7.833 14.5 C 8.294 14.5 8.667 14.873 8.667 15.333 L 8.667 15.333 C 8.667 15.794 8.294 16.167 7.833 16.167 L 7.833 16.167 C 7.373 16.167 7 15.794 7 15.333 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 9.778 8.667 C 9.778 8.206 10.151 7.833 10.611 7.833 L 16.167 7.833 C 16.627 7.833 17 8.206 17 8.667 L 17 8.667 C 17 9.127 16.627 9.5 16.167 9.5 L 10.611 9.5 C 10.151 9.5 9.778 9.127 9.778 8.667 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 9.778 12 C 9.778 11.54 10.151 11.167 10.611 11.167 L 16.167 11.167 C 16.627 11.167 17 11.54 17 12 L 17 12 C 17 12.46 16.627 12.833 16.167 12.833 L 10.611 12.833 C 10.151 12.833 9.778 12.46 9.778 12 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 9.778 15.333 C 9.778 14.873 10.151 14.5 10.611 14.5 L 16.167 14.5 C 16.627 14.5 17 14.873 17 15.333 L 17 15.333 C 17 15.794 16.627 16.167 16.167 16.167 L 10.611 16.167 C 10.151 16.167 9.778 15.794 9.778 15.333 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Google Sheets</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('map')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 11.82 6.504 C 14.029 6.504 15.82 8.282 15.82 10.476 C 15.82 10.698 15.801 10.915 15.766 11.127 C 15.359 14.488 13.033 16.581 12.155 17.261 C 12.051 17.341 11.976 17.437 11.82 17.437 C 11.663 17.437 11.586 17.34 11.481 17.258 C 10.6 16.576 8.28 14.483 7.873 11.127 C 7.838 10.915 7.82 10.698 7.82 10.476 C 7.82 8.282 9.61 6.504 11.82 6.504 Z M 9.486 10.644 C 9.486 11.933 10.531 12.977 11.82 12.977 C 13.108 12.977 14.153 11.933 14.153 10.644 C 14.153 9.355 13.108 8.311 11.82 8.311 C 10.531 8.311 9.486 9.355 9.486 10.644 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Map</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('signature-pad')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 8.82 13.068 C 8.56 12.807 8.56 12.385 8.82 12.125 L 13.733 7.212 C 13.993 6.952 14.415 6.952 14.676 7.212 L 16.788 9.324 C 17.048 9.585 17.048 10.007 16.788 10.267 L 11.875 15.18 C 11.615 15.44 11.193 15.44 10.932 15.18 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 3.096 0.303 C 3.318 0.17 3.6 0.33 3.6 0.589 L 3.6 3.732 C 3.6 3.991 3.318 4.151 3.096 4.018 L 0.953 2.732 C 0.521 2.473 0.521 1.848 0.953 1.589 Z\" transform=\"translate(6.24 13.8) rotate(-45 1.8 2.16)\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Signature Pad</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('sound-effects')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 14.225 10.793 C 14.471 11.102 14.623 11.529 14.623 12 C 14.623 12.471 14.471 12.898 14.225 13.207\" fill=\"transparent\" stroke-width=\"1.33\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 16.224 9.185 C 16.96 9.911 17.417 10.905 17.417 12 C 17.417 13.095 16.96 14.09 16.224 14.816\" fill=\"transparent\" stroke-width=\"1.33\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 6.083 10.656 C 6.083 10.288 6.382 9.989 6.75 9.989 L 7.674 9.989 L 11.021 7.835 C 11.464 7.549 12.048 7.868 12.048 8.396 L 12.048 15.604 C 12.048 16.132 11.464 16.451 11.021 16.165 L 7.674 14.011 L 6.75 14.011 C 6.382 14.011 6.083 13.712 6.083 13.344 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Sound Effects</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('card-swipe')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 3.423 7.423 C 3.423 5.214 5.214 3.423 7.423 3.423 L 16.756 3.423 C 18.965 3.423 20.756 5.214 20.756 7.423 L 20.756 16.756 C 20.756 18.965 18.965 20.756 16.756 20.756 L 7.423 20.756 C 5.214 20.756 3.423 18.965 3.423 16.756 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 9.172 3.377 C 10.734 1.815 13.266 1.815 14.828 3.377 L 20.721 9.269 C 22.283 10.831 22.283 13.364 20.721 14.926 L 14.828 20.819 C 13.266 22.381 10.734 22.381 9.172 20.819 L 3.279 14.926 C 1.717 13.364 1.717 10.831 3.279 9.269 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Card Swipe</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('custom-effect')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6.2 C 2 5.673 2.31 5.195 2.792 4.981 L 7.063 3.083 C 7.503 2.887 8 3.21 8 3.693 L 8 20.307 C 8 20.79 7.503 21.113 7.063 20.917 L 2.792 19.019 C 2.31 18.805 2 18.327 2 17.8 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 9.333 3.297 C 9.333 2.642 9.954 2.163 10.588 2.33 L 20.509 4.941 C 21.388 5.172 22 5.967 22 6.875 L 22 17.125 C 22 18.033 21.388 18.828 20.509 19.059 L 10.588 21.67 C 9.954 21.837 9.333 21.358 9.333 20.703 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Custom Effect</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('drag-handle')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 5.333 2.667 L 2.667 0 L 0 2.667\" transform=\"translate(5.667 10.667) rotate(-90 2.667 1.333)\" fill=\"transparent\" stroke-width=\"1.67\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 5.333 0 L 2.667 2.667 L 0 0\" transform=\"translate(13 10.667) rotate(-90 2.667 1.333)\" fill=\"transparent\" stroke-width=\"1.67\" stroke=\"var(--svg-icon-tint)\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Drag Handle</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('dynamic-header')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 8 L 2 8 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Dynamic Header</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('image-panning')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 12 14 C 12 12.895 12.895 12 14 12 L 20 12 C 21.105 12 22 12.895 22 14 L 22 18 C 22 20.209 20.209 22 18 22 L 14 22 C 12.895 22 12 21.105 12 20 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Image Panning</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('input-data')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 10.333 C 16.667 10.886 16.219 11.333 15.667 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.667 12.667 C 16.219 12.667 16.667 13.114 16.667 13.667 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Input Data</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('input-validation')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 10.333 C 16.667 10.886 16.219 11.333 15.667 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.667 12.667 C 16.219 12.667 16.667 13.114 16.667 13.667 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Input Validation</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('like-animation')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 5.28 0 C 7.017 0 7.747 2.366 6.357 3.755 C 4.968 5.144 3.543 5.905 3.543 5.905 C 3.543 5.905 2.118 5.144 0.728 3.755 C -0.661 2.365 0.069 -0 1.806 0 C 3.543 0 3.543 1.701 3.543 1.701 C 3.543 1.701 3.543 0 5.28 0 Z\" transform=\"translate(11.213 11.787) rotate(15 3.543 2.953)\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 5.28 0 C 7.017 -0 7.747 2.365 6.357 3.755 C 4.968 5.144 3.543 5.905 3.543 5.905 C 3.543 5.905 2.118 5.144 0.728 3.755 C -0.661 2.366 0.069 0 1.806 0 C 3.543 0 3.543 1.701 3.543 1.701 C 3.543 1.701 3.543 0 5.28 0 Z\" transform=\"translate(5.701 6.669) rotate(-15 3.543 2.953)\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Like Animation</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('like-counter')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 14.778 7.333 C 17.556 7.333 18.724 11.072 16.502 13.268 C 14.279 15.464 12 16.667 12 16.667 C 12 16.667 9.721 15.464 7.498 13.268 C 5.276 11.072 6.444 7.333 9.222 7.333 C 12 7.333 12 10.022 12 10.022 C 12 10.022 12 7.333 14.778 7.333 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Like Counter</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('lock-screen')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.333 11 C 7.333 10.448 7.781 10 8.333 10 L 15.667 10 C 16.219 10 16.667 10.448 16.667 11 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 12 7.333 C 13.289 7.333 14.333 8.378 14.333 9.667 C 14.333 10.955 13.289 12 12 12 C 10.711 12 9.667 10.955 9.667 9.667 C 9.667 8.378 10.711 7.333 12 7.333 Z\" fill=\"transparent\" stroke-width=\"1.67\" stroke=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Lock Screen</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('long-press-menu')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 16.667 10.667 C 17.771 10.667 18.667 11.562 18.667 12.667 C 18.667 13.771 17.771 14.667 16.667 14.667 C 15.562 14.667 14.667 13.771 14.667 12.667 C 14.667 11.562 15.562 10.667 16.667 10.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 12 8 C 13.105 8 14 8.895 14 10 C 14 11.105 13.105 12 12 12 C 10.895 12 10 11.105 10 10 C 10 8.895 10.895 8 12 8 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 7.333 10.667 C 8.438 10.667 9.333 11.562 9.333 12.667 C 9.333 13.771 8.438 14.667 7.333 14.667 C 6.229 14.667 5.333 13.771 5.333 12.667 C 5.333 11.562 6.229 10.667 7.333 10.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Long Press Menu</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('perspective-3d')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 6.913 22 C 5.987 22 5.182 21.364 4.967 20.463 L 2.586 10.463 C 2.287 9.206 3.24 8 4.532 8 L 19.468 8 C 20.76 8 21.713 9.206 21.414 10.463 L 19.033 20.463 C 18.818 21.364 18.013 22 17.087 22 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 3.833 7 C 3.557 7 3.333 6.776 3.333 6.5 L 3.333 6.5 C 3.333 5.672 4.005 5 4.833 5 L 19.167 5 C 19.995 5 20.667 5.672 20.667 6.5 L 20.667 6.5 C 20.667 6.776 20.443 7 20.167 7 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.7\"></path><path d=\"M 5.167 4 C 4.891 4 4.667 3.776 4.667 3.5 L 4.667 3.5 C 4.667 2.672 5.338 2 6.167 2 L 17.833 2 C 18.662 2 19.333 2.672 19.333 3.5 L 19.333 3.5 C 19.333 3.776 19.109 4 18.833 4 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Perspective 3D</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('progress-bar')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 5.153 17 C 5.153 16.08 5.899 15.333 6.82 15.333 L 16.82 15.333 C 17.74 15.333 18.486 16.08 18.486 17 L 18.486 17 C 18.486 17.92 17.74 18.667 16.82 18.667 L 6.82 18.667 C 5.899 18.667 5.153 17.92 5.153 17 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 5.153 17 C 5.153 16.08 5.899 15.333 6.82 15.333 L 11.486 15.333 C 12.407 15.333 13.153 16.08 13.153 17 L 13.153 17 C 13.153 17.92 12.407 18.667 11.486 18.667 L 6.82 18.667 C 5.899 18.667 5.153 17.92 5.153 17 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Progress Bar</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('scroll-progress')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 7.333 10.333 C 7.333 9.781 7.781 9.333 8.333 9.333 L 15.667 9.333 C 16.219 9.333 16.667 9.781 16.667 10.333 L 16.667 11.667 C 16.667 12.219 16.219 12.667 15.667 12.667 L 8.333 12.667 C 7.781 12.667 7.333 12.219 7.333 11.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 7.333 14.667 C 7.333 14.114 7.781 13.667 8.333 13.667 L 15.667 13.667 C 16.219 13.667 16.667 14.114 16.667 14.667 L 16.667 16 C 16.667 16.552 16.219 17 15.667 17 L 8.333 17 C 7.781 17 7.333 16.552 7.333 16 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 7.333 7.667 C 7.333 7.298 7.632 7 8 7 L 16 7 C 16.368 7 16.667 7.298 16.667 7.667 L 16.667 7.667 C 16.667 8.035 16.368 8.333 16 8.333 L 8 8.333 C 7.632 8.333 7.333 8.035 7.333 7.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 7.333 7.667 C 7.333 7.298 7.632 7 8 7 L 12.667 7 C 13.035 7 13.333 7.298 13.333 7.667 L 13.333 7.667 C 13.333 8.035 13.035 8.333 12.667 8.333 L 8 8.333 C 7.632 8.333 7.333 8.035 7.333 7.667 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Scroll Progress</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('show-password')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 10.6 12 C 10.6 11.227 11.227 10.6 12 10.6 L 12 10.6 C 12.773 10.6 13.4 11.227 13.4 12 L 13.4 12 C 13.4 12.773 12.773 13.4 12 13.4 L 12 13.4 C 11.227 13.4 10.6 12.773 10.6 12 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 12.166 7.833 C 14.892 7.833 17.161 9.42 17.811 12 C 17.161 14.58 14.892 16.167 12.166 16.167 C 9.44 16.167 7.127 14.58 6.478 12 C 7.127 9.42 9.44 7.833 12.166 7.833 Z M 9.333 12 C 9.333 13.473 10.527 14.667 12 14.667 C 13.473 14.667 14.667 13.473 14.667 12 C 14.667 10.527 13.473 9.333 12 9.333 C 10.527 9.333 9.333 10.527 9.333 12 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Show Password</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('slider')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 5.667 12 L 18.333 12\" stroke=\"var(--svg-icon-tint)\" fill=\"transparent\" opacity=\"0.4\" stroke-width=\"2.67\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></path><path d=\"M 12 8.333 C 14.025 8.333 15.667 9.975 15.667 12 C 15.667 14.025 14.025 15.667 12 15.667 C 9.975 15.667 8.333 14.025 8.333 12 C 8.333 9.975 9.975 8.333 12 8.333 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Slider</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('stories-drag')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 5.333 6.667 C 5.333 5.93 5.93 5.333 6.667 5.333 L 10 5.333 C 10.736 5.333 11.333 5.93 11.333 6.667 L 11.333 6.667 C 11.333 7.403 10.736 8 10 8 L 6.667 8 C 5.93 8 5.333 7.403 5.333 6.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path><path d=\"M 12.667 6.667 C 12.667 5.93 13.264 5.333 14 5.333 L 17.333 5.333 C 18.07 5.333 18.667 5.93 18.667 6.667 L 18.667 6.667 C 18.667 7.403 18.07 8 17.333 8 L 14 8 C 13.264 8 12.667 7.403 12.667 6.667 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Stories: Drag</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('stories-tap')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 5.333 6.667 C 5.333 5.93 5.93 5.333 6.667 5.333 L 10 5.333 C 10.736 5.333 11.333 5.93 11.333 6.667 L 11.333 6.667 C 11.333 7.403 10.736 8 10 8 L 6.667 8 C 5.93 8 5.333 7.403 5.333 6.667 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 12.667 6.667 C 12.667 5.93 13.264 5.333 14 5.333 L 17.333 5.333 C 18.07 5.333 18.667 5.93 18.667 6.667 L 18.667 6.667 C 18.667 7.403 18.07 8 17.333 8 L 14 8 C 13.264 8 12.667 7.403 12.667 6.667 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.4\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Stories: Tap</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t\t<li>\r\n\t\t\t\t\t\t<div class=\"btn\" (click)=\"onSelect('toast-prompt')\">\r\n\t\t\t\t\t\t\t<div class=\"icon\"><svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18.333 C 22 20.542 20.209 22.333 18 22.333 L 6 22.333 C 3.791 22.333 2 20.542 2 18.333 Z\" fill=\"var(--svg-icon-tint)\" opacity=\"0.2\"></path><path d=\"M 12 6.333 C 15.13 6.333 17.667 8.87 17.667 12 C 17.667 15.13 15.13 17.667 12 17.667 C 8.87 17.667 6.333 15.13 6.333 12 C 6.333 8.87 8.87 6.333 12 6.333 Z\" fill=\"transparent\" stroke-width=\"1.33\" stroke=\"var(--svg-icon-tint)\"></path><path d=\"M 12 13 C 12.552 13 13 13.448 13 14 C 13 14.552 12.552 15 12 15 C 11.448 15 11 14.552 11 14 C 11 13.448 11.448 13 12 13 Z\" fill=\"var(--svg-icon-tint)\"></path><path d=\"M 11.06 9.998 C 11.027 9.457 11.458 9 12 9 L 12 9 C 12.542 9 12.973 9.457 12.94 9.998 L 12.848 11.535 C 12.821 11.983 12.449 12.333 12 12.333 L 12 12.333 C 11.551 12.333 11.179 11.983 11.152 11.535 Z\" fill=\"var(--svg-icon-tint)\"></path></svg></div>\r\n\t\t\t\t\t\t\t<div class=\"title\">Toast Prompt</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t</ul>\r\n\t\t\t</li>\r\n\t\t\t-->\r\n\t\t</ul>\r\n\t\t<ul class=\"nav--editor\" *if=\"mode === 2\">\r\n\t\t\t<li>\r\n\t\t\t\t<div class=\"title\" [innerHTML]=\"'editor_views' | label\"></div>\r\n\t\t\t\t<ul class=\"nav--editor\">\r\n\t\t\t\t\t<li *for=\"let item of supportedViewTypes\">\r\n\t\t\t\t\t\t<div class=\"btn\" [class]=\"{ disabled: item.disabled }\" (click)=\"onSelect({ type:'view', value: item.type.name })\">\r\n\t\t\t\t\t\t\t<div class=\"icon\">\r\n\t\t\t\t\t\t\t\t<svg-icon [name]=\"item.type.name\"></svg-icon>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"item.name\"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t</ul>\r\n\t\t\t</li>\r\n\t\t</ul>\r\n\t\t<ul class=\"nav--editor\" *if=\"mode === 3\">\r\n\t\t\t<li>\r\n\t\t\t\t<div class=\"title\" [innerHTML]=\"'editor_view_items' | label\"></div>\r\n\t\t\t\t<ul class=\"nav--editor\">\r\n\t\t\t\t\t<li *for=\"let item of supportedViewItemTypes\">\r\n\t\t\t\t\t\t<div class=\"btn\" [class]=\"{ disabled: item.disabled }\" (click)=\"onSelect({ type:'viewItem', value: item.type.name })\" [title]=\"item.id\">\r\n\t\t\t\t\t\t\t<div class=\"icon\">\r\n\t\t\t\t\t\t\t\t<svg-icon [name]=\"item.type.name\"></svg-icon>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"item.name\"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</li>\r\n\t\t\t\t</ul>\r\n\t\t\t\t<div class=\"abstract\" *if=\"supportedViewItemTypes.length == 0\" [innerHTML]=\"'editor_type_no_items' | label\"></div>\r\n\t\t\t</li>\r\n\t\t</ul>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport { map, switchMap } from 'rxjs/operators';\r\nimport { HttpService } from '../../http/http.service';\r\nimport { ViewType } from '../../view/view';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class MenuService {\r\n\r\n\tstatic active$ = new BehaviorSubject(false);\r\n\tstatic set active(active) {\r\n\t\tthis.active$.next(active);\r\n\t}\r\n\tstatic get active() {\r\n\t\treturn this.active$.getValue();\r\n\t}\r\n\r\n\tstatic menu$_ = new BehaviorSubject([]);\r\n\r\n\tstatic menu$() {\r\n\t\treturn this.getMenu$().pipe(\r\n\t\t\tswitchMap(menu => {\r\n\t\t\t\tthis.menu$_.next(menu);\r\n\t\t\t\treturn this.menu$_;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getMenu$() {\r\n\t\treturn HttpService.get$(`/api/menu`).pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tdata.menu.sort((a, b) => {\r\n\t\t\t\t\treturn a.order - b.order;\r\n\t\t\t\t});\r\n\t\t\t\treturn data.menu;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic updateMenu$(menu) {\r\n\t\treturn HttpService.put$(`/api/menu`, menu);\r\n\t}\r\n\r\n\tstatic createMenuItem$(parentId = null, order = 0) {\r\n\t\tconst payload = {\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\torder: order * 10,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t}\r\n\t\treturn HttpService.post$(`/api/menu`, payload);\r\n\t}\r\n\r\n\tstatic updateMenuItem$(item) {\r\n\t\treturn HttpService.put$(`/api/menu/${item.id}`, item);\r\n\t}\r\n\r\n\tstatic deleteMenuItem$(item) {\r\n\t\treturn HttpService.delete$(`/api/menu/${item.id}`);\r\n\t}\r\n\r\n\tstatic getModelMenu$(views, editor = false) {\r\n\t\treturn this.menu$().pipe(\r\n\t\t\tmap(menu => {\r\n\t\t\t\tif (menu && menu.length) {\r\n\t\t\t\t\tmenu = menu.filter(x => x.viewId == null || x.viewId == 0 || views.find(v => v.id === x.viewId) != null);\r\n\t\t\t\t\t// menu = menu.filter(x => x.viewId == null || views.find(v => v.id === x.viewId) != null);\r\n\t\t\t\t\t// console.log('getModelMenu$', menu);\r\n\t\t\t\t\treturn this.mapMenuItems(menu);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// console.log('MenuService.getModelMenu$.Views', views);\r\n\t\t\t\t\tconst keys = {};\r\n\t\t\t\t\tviews.forEach(item => {\r\n\t\t\t\t\t\tif (item.type.name !== ViewType.WaitingRoom.name && (!item.hidden || editor)) {\r\n\t\t\t\t\t\t\tlet group = keys[item.type.name];\r\n\t\t\t\t\t\t\tif (!group) {\r\n\t\t\t\t\t\t\t\tgroup = keys[item.type.name] = [];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tgroup.push(item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconst menu = Object.keys(keys).map(typeName => {\r\n\t\t\t\t\t\tlet name = 'Button';\r\n\t\t\t\t\t\tswitch (typeName) {\r\n\t\t\t\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\t\t\t\tname = 'Waiting Room';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\t\tname = 'Experience';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\t\tname = 'Virtual Tour';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\t\t\t\tname = 'Stanze 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\t\tname = 'Modelli 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Media.name:\r\n\t\t\t\t\t\t\t\tname = 'Media';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn { name, type: { name: 'menu-group' }, items: views.filter(x => x.type.name === typeName && (!x.hidden || editor)) };\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn menu;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic mapMenuItem(item, items) {\r\n\t\tif (item.viewId) {\r\n\t\t\treturn { id: item.viewId, name: item.name, type: { name: 'panorama' } };\r\n\t\t} else {\r\n\t\t\treturn { name: item.name, type: { name: 'menu-group' }, items: this.mapMenuItems(items, item.id) };\r\n\t\t}\r\n\t}\r\n\r\n\tstatic mapMenuItems(items, parentId = null) {\r\n\t\treturn items.filter(item => {\r\n\t\t\t// console.log('MenuService.mapMenuItems', item);\r\n\t\t\treturn (item.parentId || null) === parentId;\r\n\t\t}).map(item => this.mapMenuItem(item, items)).filter(x => x.id != null || x.items.length > 0);\r\n\t}\r\n}\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { combineLatest, EMPTY, from, fromEvent, merge } from 'rxjs';\r\nimport { filter, map, switchMap, tap } from 'rxjs/operators';\r\nimport { Asset } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class DropService {\r\n\r\n\tstatic drop$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\t// console.log('DropService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === input) {\r\n\t\t\t\t\t\tinput.files = event.dataTransfer.files;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic change$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tfilter((event) => input.files && input.files.length),\r\n\t\t\t\tmap((event) => Array.from(input.files)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic asset$(input, previews = []) {\r\n\t\treturn this.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tpreviews.length = files.length;\r\n\t\t\t\tpreviews.fill(null);\r\n\t\t\t\t// output.previews = files.map(() => null);\r\n\t\t\t\tconst uploads$ = files.map((file, i) => this.read$(file, i, previews).pipe(\r\n\t\t\t\t\tmap(() => file),\r\n\t\t\t\t\tswitchMap((file) => AssetService.upload$([file])),\r\n\t\t\t\t\tswitchMap((uploads) => {\r\n\t\t\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic read$(file, i, previews = []) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\treturn this.resize$(blob);\r\n\t\t\t}),\r\n\t\t\ttap(resized => {\r\n\t\t\t\tpreviews[i] = resized;\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tstatic resize$(blob) {\r\n\t\treturn from(this.resize_(blob));\r\n\t}\r\n\r\n\tstatic resize_(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function() {\r\n\t\t\t\treject(blob);\r\n\t\t\t}\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n\r\nexport default class ControlComponent extends Component {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(this, node, this.control);\r\n\t\tconst control = this.control;\r\n\t\tconst flags = control.flags;\r\n\t\tObject.keys(flags).forEach((key) => {\r\n\t\t\tflags[key] ? node.classList.add(key) : node.classList.remove(key);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlComponent.meta = {\r\n\tselector: '[control]',\r\n\tinputs: ['control']\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlAssetComponent.meta = {\r\n\tselector: '[control-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"control.value | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"control.value && control.value.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"control.value | asset\" *if=\"control.value && control.value.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport { EditorService } from '../editor/editor.service';\r\nimport MenuService from '../editor/menu/menu.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class ControlMenuComponent extends ControlAssetComponent {\r\n\r\n\tstatic itemToFormGroup(item) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: item.id,\r\n\t\t\tparentId: item.parentId,\r\n\t\t\tviewId: item.viewId,\r\n\t\t\tname: item.name,\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tstatic newFormGroup(parentId = null) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: null,\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonInit() {\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tthis.controls = this.control.controls;\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t});\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(this.controls.id.value, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup(this.controls.id.value));\r\n\t}\r\n\r\n\tonRemoveItem() {\r\n\t\tthis.remove.next(this.control);\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tonLinkItem() {\r\n\t\tthis.link.next(this.control);\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\t\tthis.link.next(control);\r\n\t}\r\n\r\n\tonItemUp() {\r\n\t\tthis.up.next(this.control);\r\n\t}\r\n\r\n\tonItemDown() {\r\n\t\tthis.down.next(this.control);\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex--;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tsetView(view) {\r\n\t\t// console.log('ControlMenuComponent.setView', view.id);\r\n\t\tconst payload = Object.assign({}, this.control.value);\r\n\t\tpayload.viewId = view.id;\r\n\t\tif (view.id) {\r\n\t\t\tpayload.name = view.name;\r\n\t\t}\r\n\t\tMenuService.updateMenuItem$(payload).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.viewId.value = view.id;\r\n\t\t\tif (view.id) {\r\n\t\t\t\tthis.controls.name.value = view.name;\r\n\t\t\t\t// clear sub items\r\n\t\t\t\tthis.controls.items.controls = [];\r\n\t\t\t\tthis.controls.items.switchSubjects_();\r\n\t\t\t}\r\n\t\t\t// this.change.next(value);\r\n\t\t});\r\n\t}\r\n\r\n\tonTextDidChange(event) {\r\n\t\t// console.log('ControlMenuComponent.onTextDidChange', this.controls.name.value);\r\n\t\tMenuService.updateMenuItem$(this.control.value).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\treturn this.controls.viewId.value === item.id;\r\n\t}\r\n\r\n\tonDropped(id) {\r\n\t\t// console.log('ControlMenuComponent.onDropped', id);\r\n\t}\r\n\r\n}\r\n\r\nControlMenuComponent.meta = {\r\n\tselector: '[control-menu]',\r\n\toutputs: ['remove', 'link', 'up', 'down'],\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\">\r\n\t\t\t<button type=\"button\" class=\"control-menu__link\" [class]=\"{ active: control.controls.viewId.value }\" (click)=\"onLinkItem($event)\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#link\"></use></svg>\r\n\t\t\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t\t\t<div class=\"category\">View</div>\r\n\t\t\t\t\t<ul class=\"nav--dropdown\">\r\n\t\t\t\t\t\t<li (click)=\"setView(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.controls.viewId.options\">\r\n\t\t\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name\"></span>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t</div>\r\n\t\t\t</button>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control.controls.name\" placeholder=\"Name\" (change)=\"onTextDidChange($event)\" />\r\n\t\t\t<!--\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\">\r\n\t\t\t\t<span [innerHTML]=\"control.controls.viewId.value\"></span>\r\n\t\t\t</button>\r\n\t\t\t-->\r\n\t\t\t<!--\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control.controls.viewId\">\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.controls.viewId.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t-->\r\n\t\t\t<button type=\"button\" class=\"control-menu__up\" (click)=\"onItemUp($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#up\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__down\" (click)=\"onItemDown($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#down\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\" *if=\"!control.controls.viewId.value\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#add\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__remove\" (click)=\"onRemoveItem($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#remove\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"group--items\">\r\n\t\t\t<div control-menu *for=\"let sub of control.controls.items.controls\" [control]=\"sub\" (remove)=\"onRemoveControl($event)\" (link)=\"onLinkControl($event)\" (up)=\"onUpControl($event)\" (down)=\"onDownControl($event)\"></div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport ControlMenuComponent from '../../forms/control-menu.component';\r\nimport MenuService from './menu.service';\r\n\r\nexport default class MenuBuilderComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.changes = 0;\r\n\t\tthis.form = null;\r\n\t\tMenuService.getMenu$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.initForm(menu));\r\n\t}\r\n\r\n\tinitForm(menu = []) {\r\n\t\tconst items = this.menuToControls(menu);\r\n\t\t// console.log('MenuBuilderComponent', items);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\titems: items,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('MenuBuilderComponent', changes);\r\n\t\t\tthis.changes++;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex--;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(null, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup());\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonSubmit(event) {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst menu = this.controlsToMenu(changes);\r\n\t\t\tMenuService.updateMenu$(menu);\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tmenuToControls(menu, parentId = null) {\r\n\t\tconst items = new FormArray(menu.filter(x => {\r\n\t\t\treturn (x.parentId || null) === parentId;\r\n\t\t}).map(x => {\r\n\t\t\tconst subitems = this.menuToControls(menu, x.id);\r\n\t\t\treturn new FormGroup({\r\n\t\t\t\tid: x.id,\r\n\t\t\t\tparentId: x.parentId,\r\n\t\t\t\tviewId: x.viewId,\r\n\t\t\t\tname: x.name,\r\n\t\t\t\titems: subitems,\r\n\t\t\t});\r\n\t\t}))\r\n\t\treturn items;\r\n\t}\r\n\r\n\tcontrolsToMenu(changes) {\r\n\t\tconst menu = [];\r\n\t\tconst pushItem = (items) => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems.forEach((item, i) => {\r\n\t\t\t\t\tconst menuItem = Object.assign({}, item);\r\n\t\t\t\t\tmenuItem.order = i * 10;\r\n\t\t\t\t\tdelete menuItem.items;\r\n\t\t\t\t\tmenu.push(menuItem);\r\n\t\t\t\t\tpushItem(item.items);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\tpushItem(changes.items);\r\n\t\treturn menu;\r\n\t}\r\n\r\n}\r\n\r\nMenuBuilderComponent.meta = {\r\n\tselector: '[menu-builder]',\r\n\tinputs: ['views'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"group--head\">\r\n\t\t<div class=\"title\" [innerHTML]=\"'editor_menu' | label\"></div>\r\n\t</div>\r\n\t<div class=\"group--main\">\r\n\t\t<div class=\"nav--tree\" *if=\"form\">\r\n\t\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"isValid() && onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t<div class=\"abstract\" *if=\"controls.items.controls.length == 0\" [innerHTML]=\"'editor_add_item' | label\"></div>\r\n\t\t\t\t<div *for=\"let control of controls.items.controls\">\r\n\t\t\t\t\t<div control-menu [control]=\"control\" (remove)=\"onRemoveControl($event)\" (link)=\"onLinkControl($event)\" (up)=\"onUpControl($event)\" (down)=\"onDownControl($event)\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</form>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"group--foot\">\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onAddItem($event)\" [innerHTML]=\"'editor_add' | label\"></button>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"isValid() && onSubmit()\" *if=\"changes > 1\" [innerHTML]=\"'editor_save' | label\"></button>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport { EditorService } from '../editor.service';\r\nimport NavmapService from '../navmap/navmap.service';\r\n\r\nexport default class NavmapItemModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget navmap() {\r\n\t\tlet navmap = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tnavmap = data.navmap;\r\n\t\t}\r\n\t\treturn navmap;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = [0, 0, 0];\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = [data.hit.x, data.hit.y, 0];\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst position = this.position;\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Nav,\r\n\t\t\ttitle: null,\r\n\t\t\tabstract: null,\r\n\t\t\tviewId: new FormControl(null, RequiredValidator()),\r\n\t\t\tkeepOrientation: false,\r\n\t\t\timportant: false,\r\n\t\t\ttransparent: false,\r\n\t\t\tposition: new FormControl(position, RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('NavmapItemModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\titem.viewId = parseInt(item.viewId);\r\n\t\t\t// console.log('NavmapItemModalComponent.onSubmit', this.navmap, item);\r\n\t\t\tNavmapService.itemCreate$(this.navmap, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('NavmapItemModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('NavmapItemModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.submitted = false;\r\n\t\t\t\t// this.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nNavmapItemModalComponent.meta = {\r\n\tselector: '[navmap-item-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Map Nav.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.title\" label=\"Title\"></div>\r\n\t\t\t\t\t\t<div control-textarea [control]=\"controls.abstract\" label=\"Abstract\"></div>\r\n\t\t\t\t\t\t<div control-custom-select [control]=\"controls.viewId\" label=\"NavToView\"></div>\r\n\t\t\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"3\" [disabled]=\"true\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nNavmapItemModalComponent.chunk = () => /* html */'<div class=\"nav-modal\" navmap-item-modal></div>';\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport { ModalService } from '../../modal/modal.service';\r\nimport NavmapService from '../navmap/navmap.service';\r\n\r\nexport default class NavmapModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('NavmapModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst navmap = {\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t};\r\n\t\t\t// console.log('NavmapModalComponent.onSubmit.navmap', navmap);\r\n\t\t\treturn NavmapService.navmapCreate$(navmap).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('NavmapModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('NavmapModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nNavmapModalComponent.meta = {\r\n\tselector: '[navmap-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Create Map.</div>\r\n\t\t\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/png\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"description\">Formato immagine .png con trasparenza (2048x1024 o 1024x512)</div>\r\n\t\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t\t<span>Create</span>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</form>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nNavmapModalComponent.chunk = () => /* html */`<div class=\"panorama-modal\" navmap-modal></div>`;\r\n","import { Component } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { ModalResolveEvent, ModalService } from '../../modal/modal.service';\r\nimport NavmapItemModalComponent from '../modals/navmap-item-modal.component';\r\nimport NavmapModalComponent from '../modals/navmap-modal.component';\r\nimport NavmapService from './navmap.service';\r\n\r\nexport default class NavmapBuilderComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.navmap = null;\r\n\t\tthis.navmaps = [];\r\n\t\tNavmapService.navmapGet$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(navmaps => {\r\n\t\t\tthis.navmaps = navmaps;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonBack(event) {\r\n\t\tthis.navmap = null;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonAdd() {\r\n\t\tModalService.open$({ template: NavmapModalComponent.chunk() }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.navmaps.push(event.data);\r\n\t\t\t\tthis.navmap = event.data;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSet(item) {\r\n\t\tthis.navmap = this.navmaps.find(x => x.id === item.id);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonAddItem(navmap, hit) {\r\n\t\tModalService.open$({ template: NavmapItemModalComponent.chunk(), data: { navmap, hit } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tconst items = navmap.items || [];\r\n\t\t\t\titems.push(event.data);\r\n\t\t\t\tObject.assign(navmap, { items });\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDelete(navmap) {\r\n\t\tconst index = this.navmaps.indexOf(navmap);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.navmaps.splice(index, 1);\r\n\t\t}\r\n\t\tthis.navmap = null;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n}\r\n\r\nNavmapBuilderComponent.meta = {\r\n\tselector: '[navmap-builder]',\r\n\tinputs: ['views'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"group--head\">\r\n\t\t<div class=\"title\" [innerHTML]=\"'editor_navmaps' | label\"></div>\r\n\t</div>\r\n\t<div class=\"group--main\">\r\n\t\t<!-- listing navmaps -->\r\n\t\t<div class=\"listing--navmaps\" *if=\"!navmap\">\r\n\t\t\t<div class=\"abstract\" *if=\"navmaps.length == 0\" [innerHTML]=\"'editor_add_item' | label\"></div>\r\n\t\t\t<div class=\"listing__item\" *for=\"let item of navmaps\">\r\n\t\t\t\t<div class=\"card--navmap\" (click)=\"onSet(item)\">\r\n\t\t\t\t\t<div class=\"card__picture\">\r\n\t\t\t\t\t\t<img [src]=\"item.asset | asset\" *if=\"item.asset\" />\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div class=\"card__content\">\r\n\t\t\t\t\t\t<div class=\"card__name\" [innerHTML]=\"item.name\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<!-- navmap edit -->\r\n\t\t<div class=\"navmap\" navmap-edit [navmap]=\"navmap\" (delete)=\"onDelete($event)\" *if=\"navmap\">\r\n\t\t\t<form class=\"form\" [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\">\r\n\t\t\t\t<div class=\"title\"><span [innerHTML]=\"navmap.name\"></span> <span [innerHTML]=\"navmap.id\"></span></div>\r\n\t\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t\t\t<!--\r\n\t\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/png\"></div>\r\n\t\t\t\t\t-->\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t<button type=\"submit\" class=\"btn--accept\">\r\n\t\t\t\t\t\t<span [innerHTML]=\"'editor_save' | label\"></span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t\t<span [innerHTML]=\"'editor_remove' | label\"></span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"navmap-control\" [class]=\"mode\">\r\n\t\t\t\t\t<div class=\"navmap-control__image\">\r\n\t\t\t\t\t\t<img draggable=\"false\" [src]=\"navmap.asset | asset\" *if=\"navmap.asset\" />\r\n\t\t\t\t\t\t<div class=\"navmap__item\" [style]=\"{ left: item.position[0] * 100 + '%', top: item.position[1] * 100 + '%' }\" (mousedown)=\"onMoveItem($event, item)\" (click)=\"onRemoveItem(item)\" *for=\"let item of navmap.items\">\r\n\t\t\t\t\t\t\t<img draggable=\"false\" [src]=\"'textures/ui/nav-point.png' | asset\" />\r\n\t\t\t\t\t\t\t<div class=\"title\" [innerHTML]=\"item.title\" *if=\"item.title\"></div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<ul class=\"navmap-control__toolbar\">\r\n\t\t\t\t\t\t<li class=\"nav__item\"><span [class]=\"{ active: mode === 'insert' }\" (click)=\"onToggleMode('insert')\"><svg class=\"pencil\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#pencil\"></use></svg></span></li>\r\n\t\t\t\t\t\t<li class=\"nav__item\"><span [class]=\"{ active: mode === 'move' }\" (click)=\"onToggleMode('move')\"><svg class=\"move\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#move\"></use></svg></span></li>\r\n\t\t\t\t\t\t<li class=\"nav__item\"><span [class]=\"{ active: mode === 'remove' }\" (click)=\"onToggleMode('remove')\"><svg class=\"erase\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#erase\"></use></svg></span></li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t</div>\r\n\t\t\t</form>\r\n\t\t</div>\r\n\t</div>\r\n\t<div class=\"group--foot\">\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onAdd($event)\" [innerHTML]=\"'editor_add' | label\" *if=\"!navmap\"></button>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onBack($event)\" [innerHTML]=\"'editor_back' | label\" *if=\"navmap\"></button>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { fromEvent } from 'rxjs';\r\nimport { filter, first, map, takeUntil, tap } from 'rxjs/operators';\r\nimport { ModalResolveEvent, ModalService } from '../../modal/modal.service';\r\nimport NavmapItemModalComponent from '../modals/navmap-item-modal.component';\r\nimport RemoveModalComponent from '../modals/remove-modal.component';\r\nimport NavmapService from './navmap.service';\r\n\r\nexport const NavmapModes = {\r\n\tIdle: 'idle',\r\n\tInsert: 'insert',\r\n\tRemove: 'remove',\r\n\tMove: 'move',\r\n};\r\n\r\nexport class ControlEvent {\r\n\r\n\tconstructor(element, event) {\r\n\t\tconst rect = element.getBoundingClientRect();\r\n\t\tthis.x = (event.clientX - rect.x) / rect.width;\r\n\t\tthis.y = (event.clientY - rect.y) / rect.height;\r\n\t\t// console.log(this);\r\n\t}\r\n\r\n}\r\n\r\nexport class ControlDownEvent extends ControlEvent { }\r\nexport class ControlMoveEvent extends ControlEvent { }\r\nexport class ControlUpEvent extends ControlEvent { }\r\n\r\nexport default class NavmapEditComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.mode = NavmapModes.Idle;\r\n\t\tthis.error = null;\r\n\t\tconst navmap = this.navmap;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(navmap.name, RequiredValidator()),\r\n\t\t\tasset: new FormControl(navmap.asset, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('NavmapEditComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.insert$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// console.log('NavmapEditComponent.insert', event);\r\n\t\t\tconst hit = event;\r\n\t\t\tModalService.open$({ template: NavmapItemModalComponent.chunk(), data: { navmap, hit } }).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t\tconst items = navmap.items || [];\r\n\t\t\t\t\titems.push(event.data);\r\n\t\t\t\t\tObject.assign(navmap, { items });\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tinsert$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst image = node.querySelector('.navmap-control__image');\r\n\t\treturn fromEvent(image, 'pointerdown').pipe(\r\n\t\t\tfilter(x => this.mode === NavmapModes.Insert),\r\n\t\t\tmap(event => new ControlDownEvent(image, event)),\r\n\t\t);\r\n\t}\r\n\r\n\tonToggleMode(mode) {\r\n\t\tthis.mode = (this.mode === mode) ? NavmapModes.Idle : mode;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonMoveItem(event, item) {\r\n\t\tconst navmap = this.navmap;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase NavmapModes.Move:\r\n\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\tconst image = node.querySelector('.navmap-control__image');\r\n\t\t\t\tconst position = item.position.slice();\r\n\t\t\t\tconst down = new ControlDownEvent(image, event);\r\n\t\t\t\tconst move$ = fromEvent(image, 'mousemove').pipe(\r\n\t\t\t\t\tmap(event => new ControlMoveEvent(image, event)),\r\n\t\t\t\t\ttap(event => {\r\n\t\t\t\t\t\tconst diff = {\r\n\t\t\t\t\t\t\tx: event.x - down.x,\r\n\t\t\t\t\t\t\ty: event.y - down.y,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\titem.position = [\r\n\t\t\t\t\t\t\tMath.max(0, Math.min(1, position[0] + diff.x)),\r\n\t\t\t\t\t\t\tMath.max(0, Math.min(1, position[1] + diff.y)),\r\n\t\t\t\t\t\t\t0\r\n\t\t\t\t\t\t];\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t\tconst up$ = fromEvent(image, 'mouseup').pipe(\r\n\t\t\t\t\tmap(event => new ControlUpEvent(image, event)),\r\n\t\t\t\t\ttap(event => {\r\n\t\t\t\t\t\tconst diff = {\r\n\t\t\t\t\t\t\tx: event.x - down.x,\r\n\t\t\t\t\t\t\ty: event.y - down.y,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\titem.position = [\r\n\t\t\t\t\t\t\tMath.max(0, Math.min(1, position[0] + diff.x)),\r\n\t\t\t\t\t\t\tMath.max(0, Math.min(1, position[1] + diff.y)),\r\n\t\t\t\t\t\t\t0\r\n\t\t\t\t\t\t];\r\n\t\t\t\t\t\t// console.log('NavmapEditComponent.onNavmapItem.Update', navmap, item);\r\n\t\t\t\t\t\tNavmapService.itemUpdate$(navmap, item).pipe(\r\n\t\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t\t).subscribe(item_ => {\r\n\t\t\t\t\t\t\tObject.assign(item, item_);\r\n\t\t\t\t\t\t\t// console.log('NavmapEditComponent.onNavmapItem.Update');\r\n\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t\tmove$.pipe(\r\n\t\t\t\t\ttakeUntil(up$),\r\n\t\t\t\t).subscribe();\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoveItem(item) {\r\n\t\tconst navmap = this.navmap;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase NavmapModes.Remove:\r\n\t\t\t\tNavmapService.itemDelete$(navmap, item).pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(_ => {\r\n\t\t\t\t\t// console.log('NavmapEditComponent.onNavmapItem.Remove');\r\n\t\t\t\t\tconst items = navmap.items || [];\r\n\t\t\t\t\tconst index = items.indexOf(item);\r\n\t\t\t\t\tif (index !== -1) {\r\n\t\t\t\t\t\titems.splice(index, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tObject.assign(navmap, { items });\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst payload = Object.assign({ items: [] }, this.navmap, { name: values.name });\r\n\t\t\t// console.log('NavmapEditComponent.onSubmit.navmap', payload);\r\n\t\t\tNavmapService.navmapUpdate$(payload).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('NavmapEditComponent.onSubmit.success', response);\r\n\t\t\t\tObject.assign(this.navmap, response);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, error => {\r\n\t\t\t\t// console.log('NavmapEditComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tconst navmap = this.navmap;\r\n\t\tModalService.open$({ template: RemoveModalComponent.chunk(), data: { item: navmap } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tNavmapService.navmapDelete$(navmap).pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(response => {\r\n\t\t\t\t\tthis.delete.next(navmap);\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n\r\nNavmapEditComponent.meta = {\r\n\tselector: '[navmap-edit]',\r\n\toutputs: ['delete'],\r\n\tinputs: ['navmap']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormArray, FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { of } from 'rxjs';\r\nimport { first, switchMap } from 'rxjs/operators';\r\nimport { AssetGroupType, assetGroupTypeFromItem, assetPayloadFromGroupTypeId, AssetType } from '../../asset/asset';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport { LabelPipe } from '../../label/label.pipe';\r\nimport { ModalResolveEvent, ModalService } from '../../modal/modal.service';\r\nimport { ViewItem, ViewItemType, ViewType } from '../../view/view';\r\nimport { WebhookService } from '../../webhook/webhook.service';\r\nimport { EditorService } from '../editor.service';\r\nimport RemoveModalComponent from '../modals/remove-modal.component';\r\n\r\nexport default class UpdateViewItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tthis.useHooks = WebhookService.enabled;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tconst item = this.item;\r\n\t\tthis.originalItem = Object.assign({}, item);\r\n\t\titem.hasChromaKeyColor = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\titem.autoplay = (item.asset && item.asset.type.name === AssetType.Video.name) ? item.asset.autoplay : undefined;\r\n\t\titem.loop = (item.asset && item.asset.type.name === AssetType.Video.name) ? item.asset.loop : undefined;\r\n\t\titem.assetType = assetGroupTypeFromItem(item).id;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewItemComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateItem(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tgetFlagsDidChange(item, changes) {\r\n\t\tconst flags = ['hasChromaKeyColor', 'autoplay', 'loop'];\r\n\t\treturn flags.reduce((p, c) => {\r\n\t\t\tconst a = changes[c] || false;\r\n\t\t\tconst b = item[c] || false;\r\n\t\t\t// console.log(c, a, b);\r\n\t\t\treturn p || (a !== b);\r\n\t\t}, false);\r\n\t}\r\n\r\n\tgetAssetDidChange(item, changes) {\r\n\t\t// console.log('UpdateViewItemComponent.getAssetDidChange', item.asset, changes.asset);\r\n\t\treturn AssetService.assetDidChange(item.asset, changes.asset);\r\n\t}\r\n\r\n\tdoUpdateItem(changes) {\r\n\t\tconst item = this.item;\r\n\t\tconst assetDidChange = this.getAssetDidChange(item, changes);\r\n\t\tconst flagsDidChange = this.getFlagsDidChange(item, changes);\r\n\t\t// console.log('UpdateViewItemCompoent.doUpdateItem', 'assetDidChange', assetDidChange, 'flagsDidChange', flagsDidChange);\r\n\t\tObject.assign(item, changes);\r\n\t\tif (item.asset) {\r\n\t\t\titem.asset.chromaKeyColor = item.hasChromaKeyColor ? [0.0, 1.0, 0.0] : null;\r\n\t\t\titem.asset.autoplay = item.autoplay;\r\n\t\t\titem.asset.loop = item.loop;\r\n\t\t}\r\n\t\tif (assetDidChange || flagsDidChange) {\r\n\t\t\tconst asset$ = item.asset ? AssetService.assetUpdate$(item.asset) : of(null);\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t// !!! create indices for nextAttendeeStream\r\n\t\t\tthis.view.updateIndices(this.view.items);\r\n\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\titem.onUpdateAsset();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (typeof item.onUpdate === 'function') {\r\n\t\t\titem.onUpdate();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst item = this.item;\r\n\t\tconst form = this.form;\r\n\t\tif (!this.type || this.type.name !== item.type.name) {\r\n\t\t\tthis.type = item.type;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (item.type.name) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\tif (this.useHooks) {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'title?', 'abstract?', 'viewId?', 'hook?', 'hookExtra?', 'keepOrientation?', 'important?', 'transparent?', 'position', 'rotation', 'scale', 'asset?', 'link?', 'links?'];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'title?', 'abstract?', 'viewId?', 'keepOrientation?', 'important?', 'transparent?', 'position', 'rotation', 'scale', 'asset?', 'link?', 'links?'];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'assetType?', 'asset?', 'hasChromaKeyColor?', 'autoplay?', 'loop?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'radius', 'height', 'arc', 'assetType?', 'asset?', 'hasChromaKeyColor?', 'autoplay?', 'loop?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Texture.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'assetType?', 'asset?', 'hasChromaKeyColor?', 'autoplay?', 'loop?']; // asset, key no id!!\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (this.view.type.name === ViewType.Model) {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'asset?'];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'asset?'];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type'];\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tconst value = (item[key] != null ? item[key] : null);\r\n\t\t\t\tlet control;\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'viewId':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t\t).subscribe(options => {\r\n\t\t\t\t\t\t\tcontrol.options = options;\r\n\t\t\t\t\t\t\tcontrol.value = control.value || null;\r\n\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'hook':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tif (WebhookService.enabled) {\r\n\t\t\t\t\t\t\tconst options = environment.webhook.methods.nav.map(x => ({ id: x, name: x }));\r\n\t\t\t\t\t\t\toptions.unshift({ id: null, name: 'select' });\r\n\t\t\t\t\t\t\tcontrol.options = options;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcontrol.value = control.value || null;\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tcontrol.options = Object.keys(AssetGroupType).map(x => AssetGroupType[x]);\r\n\t\t\t\t\t\t// console.log(control.options);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tcontrol = new FormGroup({\r\n\t\t\t\t\t\t\ttitle: new FormControl(title),\r\n\t\t\t\t\t\t\thref: new FormControl(href),\r\n\t\t\t\t\t\t\ttarget\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'links':\r\n\t\t\t\t\t\tconst links = item.links;\r\n\t\t\t\t\t\tcontrol = new FormArray(links.map(link => new FormGroup({\r\n\t\t\t\t\t\t\ttitle: new FormControl(link.title),\r\n\t\t\t\t\t\t\thref: new FormControl(link.href),\r\n\t\t\t\t\t\t\ttarget: '_blank',\r\n\t\t\t\t\t\t})));\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t}\r\n\t\t\t\tform.add(control, key);\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t} else {\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tthis.controls[key].value = { title, href, target };\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'links':\r\n\t\t\t\t\t\tconst links = item.links.map(link => ({\r\n\t\t\t\t\t\t\ttitle: link.title || null,\r\n\t\t\t\t\t\t\thref: link.href || null,\r\n\t\t\t\t\t\t\ttarget: '_blank',\r\n\t\t\t\t\t\t}));\r\n\t\t\t\t\t\tconst formArray = this.controls[key];\r\n\t\t\t\t\t\twhile (formArray.controls.length > links.length) {\r\n\t\t\t\t\t\t\tformArray.remove(formArray.controls[formArray.controls.length - 1]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\twhile (formArray.controls.length < links.length) {\r\n\t\t\t\t\t\t\tformArray.push(new FormGroup({\r\n\t\t\t\t\t\t\t\ttitle: new FormControl(null),\r\n\t\t\t\t\t\t\t\thref: new FormControl(null),\r\n\t\t\t\t\t\t\t\ttarget: '_blank',\r\n\t\t\t\t\t\t\t}));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// console.log(formArray, links);\r\n\t\t\t\t\t\tformArray.patch(links);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'hasChromaKeyColor':\r\n\t\t\t\t\t\tthis.controls[key].value = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'autoplay':\r\n\t\t\t\t\t\tthis.controls[key].value = (item.asset && item.asset.autoplay) ? true : false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'loop':\r\n\t\t\t\t\t\tthis.controls[key].value = (item.asset && item.asset.loop) ? true : false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tthis.controls[key].value = assetGroupTypeFromItem(item).id;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tthis.controls[key].value = (item[key] != null ? item[key] : null);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonAssetTypeDidChange(assetType) {\r\n\t\tconst item = this.item;\r\n\t\tconst currentType = assetGroupTypeFromItem(item).id;\r\n\t\t// console.log('UpdateViewItemComponent.onAssetTypeDidChange', assetType, currentType);\r\n\t\tif (assetType !== currentType) {\r\n\t\t\titem.assetType = assetType;\r\n\t\t\tlet asset$ = of(null); // AssetService.assetDelete$(item.asset);\r\n\t\t\tif (assetType !== AssetGroupType.ImageOrVideo.id) {\r\n\t\t\t\tasset$ = asset$.pipe(\r\n\t\t\t\t\tswitchMap(() => {\r\n\t\t\t\t\t\tconst asset = assetPayloadFromGroupTypeId(assetType);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(asset => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.asset$', asset);\r\n\t\t\t\tthis.controls.asset.value = asset;\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tasset$.pipe(\r\n\t\t\t\ttap(asset => {\r\n\t\t\t\t\titem.asset = asset;\r\n\t\t\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\titem.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\t// console.log('UpdateViewItemComponent.onChanges', changes);\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst payload = Object.assign({}, changes);\r\n\t\t\tif (this.item.type.name === ViewItemType.Nav.name) {\r\n\t\t\t\tpayload.viewId = payload.viewId || this.view.id;\r\n\t\t\t}\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst item = new ViewItem(payload);\r\n\t\t\tEditorService.inferItemUpdate$(view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.success', response);\r\n\t\t\t\tEditorService.inferItemUpdateResult$(view, item);\r\n\t\t\t\tthis.update.next({ view, item });\r\n\t\t\t\tthis.setTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}, error => console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: this.view, item: new ViewItem(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ template: RemoveModalComponent.chunk(), data: { item: this.item } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, item: this.item });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, item: this.item.selected ? null : this.item });\r\n\t\t/*\r\n\t\tthis.item.active = !this.item.active;\r\n\t\tthis.pushChanges();\r\n\t\t*/\r\n\t}\r\n\r\n\tgetTitle(item) {\r\n\t\treturn LabelPipe.getKeys('editor', item.type.name);\r\n\t}\r\n\r\n\tonAddLink(event) {\r\n\t\tthis.controls.links.push(new FormGroup({\r\n\t\t\ttitle: new FormControl(null),\r\n\t\t\thref: new FormControl(null),\r\n\t\t\ttarget: '_blank',\r\n\t\t}));\r\n\t}\r\n\r\n\tonRemoveLink(item) {\r\n\t\tthis.controls.links.remove(item);\r\n\t}\r\n\r\n\tclearTimeout() {\r\n\t\tif (this.to) {\r\n\t\t\tclearTimeout(this.to);\r\n\t\t}\r\n\t}\r\n\r\n\tsetTimeout(callback, msec = 300) {\r\n\t\tthis.clearTimeout();\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tthis.to = setTimeout(callback, msec);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.clearTimeout();\r\n\t}\r\n}\r\n\r\nUpdateViewItemComponent.meta = {\r\n\tselector: 'update-view-item',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'item'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: item.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"item.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"item.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(item)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"item.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'nav'\">\r\n\t\t\t\t<div control-text [control]=\"controls.title\" label=\"Title\"></div>\r\n\t\t\t\t<div control-textarea [control]=\"controls.abstract\" label=\"Abstract\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.viewId\" label=\"NavToView\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.keepOrientation\" label=\"Keep Orientation\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.important\" label=\"Important\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.transparent\" label=\"Transparent\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"3\"></div>\r\n\t\t\t\t<div *if=\"controls.transparent.value == true\">\r\n\t\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\r\n\t\t\t\t<div class=\"group--link\" *for=\"let link of controls.links.controls\">\r\n\t\t\t\t\t<div class=\"group--controls\">\r\n\t\t\t\t\t\t<div control-text [control]=\"link.controls.title\" label=\"Link Title\"></div>\r\n\t\t\t\t\t\t<div control-text [control]=\"link.controls.href\" label=\"Link Url\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemoveLink(link)\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#remove\"></use></svg></button>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--update\" (click)=\"onAddLink($event)\">\r\n\t\t\t\t\t\t<span>Add Link</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t<div *if=\"useHooks\">\r\n\t\t\t\t\t<div control-custom-select [control]=\"controls.hook\" label=\"Hook\"></div>\r\n\t\t\t\t\t<div control-text [control]=\"controls.hookExtra\" label=\"Hook Extra\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'plane' && view.type.name != 'media'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Localized Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.autoplay\" label=\"Autoplay\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.loop\" label=\"Loop\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'plane' && view.type.name == 'media'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Localized Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.autoplay\" label=\"Autoplay\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.loop\" label=\"Loop\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'curved-plane'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<!-- <div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-number [control]=\"controls.radius\" label=\"Radius\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.height\" label=\"Height\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.arc\" label=\"Arc\" [precision]=\"0\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.autoplay\" label=\"Autoplay\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.loop\" label=\"Loop\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'texture'\">\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.autoplay\" label=\"Autoplay\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.loop\" label=\"Loop\" *if=\"item.asset && item.asset.type.name === 'video'\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'model'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"2\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.asset\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport { ModalResolveEvent, ModalService } from '../../modal/modal.service';\r\nimport RemoveModalComponent from '../modals/remove-modal.component';\r\n\r\nexport default class UpdateViewTileComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tid: new FormControl(this.tile.id, RequiredValidator()),\r\n\t\t\tasset: new FormControl(this.tile.asset, RequiredValidator()),\r\n\t\t\tnavs: new FormControl(this.tile.navs, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewTileComponent.form.changes$', changes);\r\n\t\t\tconst tile = this.tile;\r\n\t\t\tObject.assign(tile, changes);\r\n\t\t\tif (typeof tile.onUpdate === 'function') {\r\n\t\t\t\ttile.onUpdate();\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t// console.log('UpdateViewTileComponent.onInit', this.view, this.tile);\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.form.value);\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst tile = payload;\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t\tthis.update.next({ view, tile });\r\n\t\t\tthis.setTimeout(() => {\r\n\t\t\t\tthis.busy = false;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ template: RemoveModalComponent.chunk(), data: { tile: this.tile } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, tile: this.tile });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, tile: this.tile.selected ? null : this.tile });\r\n\t}\r\n\r\n\tclearTimeout() {\r\n\t\tif (this.to) {\r\n\t\t\tclearTimeout(this.to);\r\n\t\t}\r\n\t}\r\n\r\n\tsetTimeout(callback, msec = 300) {\r\n\t\tthis.clearTimeout();\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tthis.to = setTimeout(callback, msec);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.clearTimeout();\r\n\t}\r\n}\r\n\r\nUpdateViewTileComponent.meta = {\r\n\tselector: 'update-view-tile',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'tile'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: tile.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon name=\"tile\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\">Tile {{tile.id}}</div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"tile.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<!--\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t-->\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { auditTime, distinctUntilChanged, filter, first, takeUntil } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport { LabelPipe } from '../../label/label.pipe';\r\nimport { MessageService } from '../../message/message.service';\r\nimport { ModalResolveEvent, ModalService } from '../../modal/modal.service';\r\nimport { View, ViewType } from '../../view/view';\r\nimport { EditorService } from '../editor.service';\r\nimport RemoveModalComponent from '../modals/remove-modal.component';\r\n\r\nexport default class UpdateViewComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateView(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.orbit$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (this.view.type.name) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\tcase ViewType.Media.name:\r\n\t\t\t\t\tthis.form.patch({\r\n\t\t\t\t\t\tlatitude: message.orientation.latitude,\r\n\t\t\t\t\t\tlongitude: message.orientation.longitude,\r\n\t\t\t\t\t\tzoom: message.zoom,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\torbit$() {\r\n\t\tlet latitude, longitude, zoom = null;\r\n\t\treturn MessageService.in$.pipe(\r\n\t\t\tfilter(message => message.type === MessageType.ControlInfo),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t\tdistinctUntilChanged((previous, current) => {\r\n\t\t\t\tconst didChange = (latitude !== current.orientation.latitude ||\r\n\t\t\t\t\tlongitude !== current.orientation.longitude ||\r\n\t\t\t\t\tzoom !== current.zoom);\r\n\t\t\t\tlatitude = current.orientation.latitude;\r\n\t\t\t\tlongitude = current.orientation.longitude;\r\n\t\t\t\tzoom = current.zoom;\r\n\t\t\t\treturn !didChange;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tgetAssetDidChange(changes) {\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name === ViewType.PanoramaGrid.name) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tconst assetDidChange = AssetService.assetDidChange(view.asset, changes.asset);\r\n\t\tconst usdzDidChange = AssetService.assetDidChange(view.ar ? view.ar.usdz : null, changes.usdz);\r\n\t\tconst gltfDidChange = AssetService.assetDidChange(view.ar ? view.ar.gltf : null, changes.gltf);\r\n\t\tif (assetDidChange || usdzDidChange || gltfDidChange) {\r\n\t\t\t// console.log('UpdateViewComponent.getAssetDidChange', assetDidChange, usdzDidChange, gltfDidChange);\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateView(changes) {\r\n\t\tconst assetDidChange = this.getAssetDidChange(changes);\r\n\t\t// console.log('doUpdateItem.assetDidChange', assetDidChange);\r\n\t\tif (assetDidChange) {\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst view = this.view;\r\n\t\tif (!this.type || this.type.name !== view.type.name) {\r\n\t\t\tthis.type = view.type;\r\n\t\t\tconst form = this.form;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (view.type.name) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Media.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name'];\r\n\t\t\t}\r\n\t\t\tif (view.type.name !== ViewType.WaitingRoom.name && environment.flags.ar) {\r\n\t\t\t\tkeys.push('usdz?');\r\n\t\t\t\tkeys.push('gltf?');\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'latitude':\r\n\t\t\t\t\tcase 'longitude': {\r\n\t\t\t\t\t\tconst orientation = view.orientation || { latitude: 0, longitude: 0 };\r\n\t\t\t\t\t\tform.add(new FormControl(orientation[key], RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcase 'usdz':\r\n\t\t\t\t\tcase 'gltf': {\r\n\t\t\t\t\t\tform.add(new FormControl((view.ar ? (view.ar[key] || null) : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdefault: {\r\n\t\t\t\t\t\tform.add(new FormControl((view[key] != null ? view[key] : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\t// console.log('UpdateViewComponent.onChanges');\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.form.value);\r\n\t\t\tif (payload.latitude != null) { // !!! keep loose inequality\r\n\t\t\t\tpayload.orientation = {\r\n\t\t\t\t\tlatitude: payload.latitude,\r\n\t\t\t\t\tlongitude: payload.longitude,\r\n\t\t\t\t};\r\n\t\t\t\tdelete payload.latitude;\r\n\t\t\t\tdelete payload.longitude;\r\n\t\t\t}\r\n\t\t\tconst usdz = payload.usdz || null;\r\n\t\t\tconst gltf = payload.gltf || null;\r\n\t\t\tdelete payload.usdz;\r\n\t\t\tdelete payload.gltf;\r\n\t\t\tpayload.ar = (usdz || gltf) ? { usdz, gltf } : null;\r\n\t\t\tconst view = new View(Object.assign({}, this.view, payload));\r\n\t\t\t/*\r\n\t\t\tlet dataView = Object.assign({}, ViewService.getDataView(this.view.id), payload);\r\n\t\t\tdataView = new View(dataView);\r\n\t\t\tlet pathView = Object.assign({}, this.view, payload);\r\n\t\t\tpathView = new View(pathView);\r\n\t\t\t*/\r\n\t\t\tEditorService.viewUpdate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewComponent.onSubmit.viewUpdate$.success', response);\r\n\t\t\t\tthis.update.next({ view: view });\r\n\t\t\t\tthis.setTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}, error => console.log('UpdateViewComponent.onSubmit.viewUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: new View(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ template: RemoveModalComponent.chunk(), data: { item: this.item } }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view.selected ? null : this.view });\r\n\t}\r\n\r\n\tgetTitle(view) {\r\n\t\treturn LabelPipe.getKeys('editor', view.type.name);\r\n\t}\r\n\r\n\tclearTimeout() {\r\n\t\tif (this.to) {\r\n\t\t\tclearTimeout(this.to);\r\n\t\t}\r\n\t}\r\n\r\n\tsetTimeout(callback, msec = 300) {\r\n\t\tthis.clearTimeout();\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tthis.to = setTimeout(callback, msec);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.clearTimeout();\r\n\t}\r\n}\r\n\r\nUpdateViewComponent.meta = {\r\n\tselector: 'update-view',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: view.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"view.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"view.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(view)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"view.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'waiting-room'\">\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama-grid'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'room-3d'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.asset\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'model'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name != 'waiting-room' && ('ar' | flag)\">\r\n\t\t\t\t<div control-model [control]=\"controls.usdz\" label=\"AR IOS (.usdz)\" accept=\".usdz\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.gltf\" label=\"AR Android (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" *if=\"view.type.name != 'waiting-room'\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Module } from 'rxcomp';\r\nimport ToastOutletComponent from '../toast/toast-outlet.component';\r\nimport AsideComponent from './aside/aside.component';\r\nimport EditorComponent from './editor.component';\r\nimport MenuBuilderComponent from './menu/menu-builder.component';\r\nimport CurvedPlaneModalComponent from './modals/curved-plane-modal.component';\r\nimport ItemModelModalComponent from './modals/item-model-modal.component';\r\nimport MediaModalComponent from './modals/media-modal.component';\r\nimport ModelModalComponent from './modals/model-modal.component';\r\nimport NavModalComponent from './modals/nav-modal.component';\r\nimport NavmapItemModalComponent from './modals/navmap-item-modal.component';\r\nimport NavmapModalComponent from './modals/navmap-modal.component';\r\nimport PanoramaGridModalComponent from './modals/panorama-grid-modal.component';\r\nimport PanoramaModalComponent from './modals/panorama-modal.component';\r\nimport PathAddModalComponent from './modals/path-add-modal.component';\r\nimport PathEditModalComponent from './modals/path-edit-modal.component';\r\nimport PlaneModalComponent from './modals/plane-modal.component';\r\nimport RemoveModalComponent from './modals/remove-modal.component';\r\nimport Room3DModalComponent from './modals/room-3d-modal.component';\r\nimport NavmapBuilderComponent from './navmap/navmap-builder.component';\r\nimport NavmapEditComponent from './navmap/navmap-edit.component';\r\nimport UpdateViewItemComponent from './update/update-view-item.component';\r\nimport UpdateViewTileComponent from './update/update-view-tile.component';\r\nimport UpdateViewComponent from './update/update-view.component';\r\n\r\nconst factories = [\r\n\tAsideComponent,\r\n\tCurvedPlaneModalComponent,\r\n\tEditorComponent,\r\n\tItemModelModalComponent,\r\n\tNavmapBuilderComponent,\r\n\tNavmapEditComponent,\r\n\tNavmapModalComponent,\r\n\tNavmapItemModalComponent,\r\n\tMediaModalComponent,\r\n\tMenuBuilderComponent,\r\n\tModelModalComponent,\r\n\tNavModalComponent,\r\n\tPanoramaModalComponent,\r\n\tPanoramaGridModalComponent,\r\n\tPathAddModalComponent,\r\n\tPathEditModalComponent,\r\n\tPlaneModalComponent,\r\n\tRemoveModalComponent,\r\n\tRoom3DModalComponent,\r\n\tToastOutletComponent,\r\n\tUpdateViewItemComponent,\r\n\tUpdateViewTileComponent,\r\n\tUpdateViewComponent,\r\n];\r\n\r\nconst pipes = [];\r\n\r\nexport class EditorModule extends Module { }\r\n\r\nEditorModule.meta = {\r\n\timports: [],\r\n\tdeclarations: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t],\r\n\texports: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t]\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { ModalService } from '../../modal/modal.service';\r\n\r\nexport default class IframeModalComponent extends Component {\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nIframeModalComponent.meta = {\r\n\tselector: '[iframe-modal]',\r\n\tinputs: ['src'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"modal__content\">\r\n\t\t\t<iframe [src]=\"src\"></iframe>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nIframeModalComponent.chunk = (src) => /* html */`<div class=\"iframe-modal\" iframe-modal src=\"${src}\"></div>`;\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\n\r\nexport default class EnvPipe extends Pipe {\r\n\r\n\tstatic transform(keypath) {\r\n\t\tlet env = environment;\r\n\t\tconst keys = keypath.split('.');\r\n\t\tlet k = keys.shift();\r\n\t\twhile (keys.length > 0 && env[k]) {\r\n\t\t\tenv = env[k];\r\n\t\t\tk = keys.shift();\r\n\t\t}\r\n\t\tconst value = env[k] || null;\r\n\t\treturn value;\r\n\t}\r\n\r\n}\r\n\r\nEnvPipe.meta = {\r\n\tname: 'env',\r\n};\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\n\r\nexport default class FlagPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst flags = environment.flags;\r\n\t\treturn flags[key] || false;\r\n\t}\r\n\r\n}\r\n\r\nFlagPipe.meta = {\r\n\tname: 'flag',\r\n};\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { BehaviorSubject, combineLatest, EMPTY, fromEvent, merge, of, ReplaySubject } from 'rxjs';\r\nimport { delayWhen, filter, first, map, switchMap, tap } from 'rxjs/operators';\r\nimport { Asset, assetTypeFromPath } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class UploadItem {\r\n\r\n\tconstructor(file) {\r\n\t\tthis.file = file;\r\n\t\tthis.name = file.name;\r\n\t\tthis.type = assetTypeFromPath(file.name);\r\n\t\tthis.progress = 0;\r\n\t\tthis.size = file.size;\r\n\t\tthis.uploading = false;\r\n\t\tthis.paused = false;\r\n\t\tthis.success = false;\r\n\t\tthis.complete = false;\r\n\t\tthis.error = null;\r\n\t\tthis.preview = null;\r\n\t}\r\n\r\n}\r\n\r\nexport class UploadEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class UploadStartEvent extends UploadEvent { }\r\n\r\nexport class UploadCompleteEvent extends UploadEvent { }\r\n\r\nexport class UploadAssetEvent extends UploadEvent { }\r\n\r\nexport class UploadService {\r\n\r\n\tconstructor() {\r\n\t\tthis.concurrent$ = new BehaviorSubject(0);\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tupload$() {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst uploadItems = items.filter(item => !item.uploading);\r\n\t\treturn combineLatest(uploadItems.map(item => this.uploadItem$(item)));\r\n\t}\r\n\r\n\tuploadItem$(item) {\r\n\t\t// max 4 concurrent upload\r\n\t\titem.uploading = true;\r\n\t\tthis.events$.next(new UploadStartEvent({ item }));\r\n\t\tconst files = [item.file];\r\n\t\treturn of(files).pipe(\r\n\t\t\tdelayWhen(() => this.concurrent$.pipe(\r\n\t\t\t\tfilter(x => x < 4)\r\n\t\t\t)),\r\n\t\t\ttap(() => this.concurrent$.next(this.concurrent$.getValue() + 1)),\r\n\t\t\tfirst(),\r\n\t\t\tswitchMap(files => AssetService.upload$(files)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t\tthis.concurrent$.next(this.concurrent$.getValue() - 1);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t/*\r\n\t\t// concurrent upload\r\n\t\treturn AssetService.upload$([item.file]).pipe(\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\taddItems(files) {\r\n\t\tif (files && files.length) {\r\n\t\t\t// console.log('addItems', files);\r\n\t\t\tconst items = this.items$.getValue();\r\n\t\t\tconst newItems = Array.from(files).map(file => new UploadItem(file));\r\n\t\t\titems.push(...newItems);\r\n\t\t\tthis.items$.next(items);\r\n\t\t}\r\n\t}\r\n\r\n\tremove(item) {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst index = items.indexOf(item);\r\n\t\tif (index !== -1) {\r\n\t\t\titems.splice(index, 1);\r\n\t\t}\r\n\t\tthis.items$.next(items);\r\n\t}\r\n\r\n\tremoveAll() {\r\n\t\t// !!!\r\n\t\tthis.items$.next([]);\r\n\t}\r\n\r\n\tdrop$(input, dropArea) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tdropArea = dropArea || input;\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\t// console.log('UploadService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === dropArea) {\r\n\t\t\t\t\t\tthis.addItems(event.dataTransfer.files);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tchange$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tswitchMap((event) => {\r\n\t\t\t\t\tif (input.files.length) {\r\n\t\t\t\t\t\tthis.addItems(input.files);\r\n\t\t\t\t\t\tinput.value = '';\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tfiles$(files) {\r\n\t\treturn combineLatest(Array.from(files).map((file, i) => this.file$(file, i)));\r\n\t}\r\n\r\n\tfile$(file, i) {\r\n\t\treturn this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\tstatic files$(files) {\r\n\t\tconst fileArray = Array.from(files);\r\n\t\tthis.previews = fileArray.map(() => null);\r\n\t\tconst uploads$ = fileArray.map((file, i) => this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t));\r\n\t\treturn combineLatest(uploads$);\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tthis.resize(blob, (resized) => {\r\n\t\t\t\t\tthis.previews[i] = resized;\r\n\t\t\t\t\t// console.log('resized', resized);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tuploadFile$(file) {\r\n\t\treturn AssetService.upload$([file]).pipe(\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t/*\r\n\t\t\t\tid: 1601303293569\r\n\t\t\t\ttype: 'image/jpeg'\r\n\t\t\t\tfile: '1601303293569_ambiente1_x0_y2.jpg'\r\n\t\t\t\toriginalFileName: 'ambiente1_x0_y2.jpg'\r\n\t\t\t\turl: '/uploads/1601303293569_ambiente1_x0_y2.jpg'\r\n\t\t\t\t*/\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tresize(blob, callback) {\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tcallback(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t}\r\n\t}\r\n\r\n\tsupported() {\r\n\t\treturn supportFileAPI() && supportAjaxUploadProgressEvents() && supportFormData();\r\n\t\tfunction supportFileAPI() {\r\n\t\t\tvar input = document.createElement('input');\r\n\t\t\tinput.type = 'file';\r\n\t\t\treturn 'files' in input;\r\n\t\t}\r\n\t\tfunction supportAjaxUploadProgressEvents() {\r\n\t\t\tvar xhr = new XMLHttpRequest();\r\n\t\t\treturn !!(xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));\r\n\t\t}\r\n\t\tfunction supportFormData() {\r\n\t\t\treturn !!window.FormData;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { getContext } from 'rxcomp';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { UploadAssetEvent, UploadService } from '../upload/upload.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetsComponent extends ControlComponent {\r\n\r\n\tget items() {\r\n\t\treturn this.items_;\r\n\t}\r\n\tset items(items) {\r\n\t\tthis.items_ = items;\r\n\t\tthis.uploadCount = items.reduce((p, c) => {\r\n\t\t\treturn p + (c.uploading || c.completed ? 0 : 1);\r\n\t\t}, 0);\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.multiple = (this.multiple !== false);\r\n\t\tthis.items = [];\r\n\t\tthis.assets = this.control.value || [];\r\n\t\tthis.hasFiles = false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tconst dropArea = node.querySelector('.upload-drop');\r\n\t\tconst service = this.service = new UploadService();\r\n\t\tservice.drop$(input, dropArea).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.drop$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.change$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.events$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// console.log('ControlAssetComponent.events$', event);\r\n\t\t\tif (event instanceof UploadAssetEvent) {\r\n\t\t\t\tthis.assets.push(event.asset);\r\n\t\t\t\tthis.control.value = this.assets;\r\n\t\t\t}\r\n\t\t\tthis.items = this.items;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// this.control.value = assets;\r\n\t\t});\r\n\t}\r\n\r\n\tonUpload() {\r\n\t\t// console.log('ControlAssetsComponent.onUpload');\r\n\t\tthis.service.upload$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\t// console.log('ControlAssetsComponent.onCancel');\r\n\t\tthis.service.removeAll();\r\n\t}\r\n\r\n\tonItemPause(item) {\r\n\t\t// console.log('ControlAssetsComponent.onPause', item);\r\n\t}\r\n\r\n\tonItemResume(item) {\r\n\t\t// console.log('ControlAssetsComponent.onResume', item);\r\n\t}\r\n\r\n\tonItemCancel(item) {\r\n\t\t// console.log('ControlAssetsComponent.onCancel', item);\r\n\t}\r\n\r\n\tonItemRemove(item) {\r\n\t\t// console.log('ControlAssetsComponent.onRemove', item);\r\n\t\tthis.service.remove(item);\r\n\t}\r\n}\r\n\r\nControlAssetsComponent.meta = {\r\n\tselector: '[control-assets]',\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"listing--assets\">\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of assets\">\r\n\t\t\t\t\t<div class=\"upload-item\">\r\n\t\t\t\t\t\t<div class=\"picture\">\r\n\t\t\t\t\t\t\t<img [lazy]=\"item | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.type.name === 'image'\" />\r\n\t\t\t\t\t\t\t<video [src]=\"item | asset\" *if=\"item.type.name === 'video'\"></video>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"name\" [innerHTML]=\"item.file\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of items\">\r\n\t\t\t\t\t<div upload-item [item]=\"item\" (pause)=\"onItemPause($event)\" (resume)=\"onItemResume($event)\" (cancel)=\"onItemCancel($event)\" (remove)=\"onItemRemove($event)\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<div class=\"btn--browse\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t\t<input type=\"file\" accept=\"image/jpeg\" multiple />\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"btn--upload\" (click)=\"onUpload()\" *if=\"uploadCount > 0\" [innerHTML]=\"'upload' | label\"></div>\r\n\t\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\" *if=\"uploadCount > 0\" [innerHTML]=\"'cancel' | label\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"upload-drop\">\r\n    \t\t\t<span [innerHTML]=\"'drag_and_drop_images' | label\"></span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport { ModalService } from '../modal/modal.service';\r\nimport { GenericService } from './generic.service';\r\n\r\nexport class GenericModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconsole.log(this.data);\r\n\t\tthis.page = null;\r\n\t\tGenericService.currentLanguagePage$(this.data.mode).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(page => {\r\n\t\t\tthis.page = page;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nGenericModalComponent.meta = {\r\n\tselector: '[generic-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\" *if=\"page\">\r\n\t\t\t<h1 class=\"title\" [innerHTML]=\"page.title\"></h1>\r\n\t\t\t<div class=\"description\" [innerHTML]=\"page.description\"></div>\r\n\t\t</div>\r\n\t\t<div class=\"modal__footer\">\r\n\t\t\t<button type=\"button\" class=\"btn--accept\" (click)=\"onClose()\">\r\n\t\t\t\t<span [innerHTML]=\"'title_close' | label\"></span>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nGenericModalComponent.chunk = () => /* html */`<div class=\"generic-modal\" generic-modal></div>`;\r\n","import { getContext } from 'rxcomp';\r\nimport { EMPTY, fromEvent, ReplaySubject } from 'rxjs';\r\nimport { first, switchAll, takeUntil, tap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport { GenericModalComponent } from '../generic/generic-modal.component';\r\nimport { ModalService } from '../modal/modal.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlCheckboxComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.linksSubject = new ReplaySubject();\r\n\t\tthis.links$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst links = Array.prototype.slice.call(node.querySelectorAll('a'));\r\n\t\t// console.log('ControlCheckboxComponent.onChanges', links);\r\n\t\tthis.linksSubject.next(links.length ? fromEvent(links, 'click') : EMPTY);\r\n\t}\r\n\r\n\tlinks$() {\r\n\t\tconst linksSubject = this.linksSubject.pipe(\r\n\t\t\tswitchAll(),\r\n\t\t\ttap(event => {\r\n\t\t\t\t// console.log(event);\r\n\t\t\t\tif (environment.flags.gdprRoutes) {\r\n\t\t\t\t\tconst template = GenericModalComponent.chunk();\r\n\t\t\t\t\tModalService.open$({ template, data: { mode: 'privacy_policy' } }).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t).subscribe();\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t\treturn linksSubject;\r\n\t}\r\n\r\n}\r\n\r\nControlCheckboxComponent.meta = {\r\n\tselector: '[control-checkbox]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--checkbox\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label>\r\n\t\t\t\t<input type=\"checkbox\" class=\"control--checkbox\" [formControl]=\"control\" [value]=\"true\" />\r\n\t\t\t\t<span [innerHTML]=\"label | html\"></span>\r\n\t\t\t</label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlCustomSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.dropped = false;\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tKeyboardService.typing$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(word => {\r\n\t\t\tthis.scrollToWord(word);\r\n\t\t});\r\n\t\t/*\r\n\t\tKeyboardService.key$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(key => {\r\n\t\t\tthis.scrollToKey(key);\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\t/*\r\n\tonChanges() {\r\n\t\t// console.log('ControlCustomSelectComponent.onChanges');\r\n\t}\r\n\t*/\r\n\r\n\tscrollToWord(word) {\r\n\t\t// console.log('ControlCustomSelectComponent.scrollToWord', word);\r\n\t\tconst items = this.control.options || [];\r\n\t\tlet index = -1;\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst x = items[i];\r\n\t\t\tif (x.name.toLowerCase().indexOf(word.toLowerCase()) === 0) {\r\n\t\t\t\t// console.log(word, x.name);\r\n\t\t\t\tindex = i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (index !== -1) {\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst dropdown = node.querySelector('.dropdown');\r\n\t\t\tconst navDropdown = node.querySelector('.nav--dropdown');\r\n\t\t\tconst item = navDropdown.children[index];\r\n\t\t\tif (item) {\r\n\t\t\t\tdropdown.scrollTo(0, item.offsetTop);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tsetOption(item) {\r\n\t\t// console.log('setOption', item, this.isMultiple);\r\n\t\tlet value;\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst value = this.control.value || [];\r\n\t\t\tconst index = value.indexOf(item.id);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\t// if (value.length > 1) {\r\n\t\t\t\tvalue.splice(index, 1);\r\n\t\t\t\t// }\r\n\t\t\t} else {\r\n\t\t\t\tvalue.push(item.id);\r\n\t\t\t}\r\n\t\t\tvalue = value.length ? value.slice() : null;\r\n\t\t} else {\r\n\t\t\tvalue = item.id;\r\n\t\t\t// DropdownDirective.dropdown$.next(null);\r\n\t\t}\r\n\t\tthis.control.value = value;\r\n\t\tthis.change.next(value);\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst values = this.control.value || [];\r\n\t\t\treturn values.indexOf(item.id) !== -1;\r\n\t\t} else {\r\n\t\t\treturn this.control.value === item.id;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet value = this.control.value;\r\n\t\tconst items = this.control.options || [];\r\n\t\tif (this.isMultiple) {\r\n\t\t\tvalue = value || [];\r\n\t\t\tif (value.length) {\r\n\t\t\t\treturn value.map(v => {\r\n\t\t\t\t\tconst item = items.find(x => x.id === v || x.name === v);\r\n\t\t\t\t\treturn item ? item.name : '';\r\n\t\t\t\t}).join(', ');\r\n\t\t\t} else {\r\n\t\t\t\treturn 'select'; // LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst item = items.find(x => x.id === value || x.name === value);\r\n\t\t\tif (item) {\r\n\t\t\t\treturn item.name;\r\n\t\t\t} else {\r\n\t\t\t\treturn 'select'; // LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDropped($event) {\r\n\t\t// console.log('ControlCustomSelectComponent.onDropped', id);\r\n\t\tif (this.dropped && $event === null) {\r\n\t\t\tthis.control.touched = true;\r\n\t\t}\r\n\t\tthis.dropped = $event === this.dropdownId;\r\n\t}\r\n\r\n\tget isMultiple() {\r\n\t\treturn this.multiple && this.multiple !== false && this.multiple !== 'false';\r\n\t}\r\n}\r\n\r\nControlCustomSelectComponent.meta = {\r\n\tselector: '[control-custom-select]',\r\n\toutputs: ['change'],\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length, multiple: isMultiple }\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"control--custom-select\" [innerHTML]=\"getLabel() | label\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t<div class=\"category\" [innerHTML]=\"label\"></div>\r\n\t\t\t<ul class=\"nav--dropdown\" [class]=\"{ multiple: isMultiple }\">\r\n\t\t\t\t<li (click)=\"setOption(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.options\">\r\n\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name | label\"></span>\r\n\t\t\t\t</li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlLinkComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tmerge(fromEvent(input, 'input')).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tfromEvent(input, 'blur').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\t// console.log('ControlLinkComponent.onInputDidChange', event.target.value);\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\t// console.log('ControlLinkComponent.onInputDidBlur', event.target.value);\r\n\t\tthis.control.touched = true;\r\n\t\tthis.value = this.input.value;\r\n\t}\r\n\r\n}\r\n\r\nControlLinkComponent.meta = {\r\n\tselector: '[control-link]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport { environment } from '../environment';\r\nimport { LanguageService } from '../language/language.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlLocalizedAssetComponent extends ControlComponent {\r\n\r\n\tget localizedValue() {\r\n\t\tlet asset = this.control.value;\r\n\t\tif (asset && asset.locale) {\r\n\t\t\tconst localizedAsset = asset.locale[this.currentLanguage];\r\n\t\t\tif (localizedAsset) {\r\n\t\t\t\tasset = localizedAsset;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn asset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.languages = environment.languages;\r\n\t\tthis.currentLanguage = LanguageService.lang;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => (this.languages.length > 1 ? AssetService.createOrUpdateLocalizedAsset$ : AssetService.createOrUpdateAsset$)(uploads, this.control, this.currentLanguage)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlLocalizedAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tsetLanguage(language) {\r\n\t\tLanguageService.setLanguage$(language).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(_ => {\r\n\t\t\tthis.currentLanguage = language;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlLocalizedAssetComponent.meta = {\r\n\tselector: '[control-localized-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"localizedValue | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"localizedValue && localizedValue.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"localizedValue | asset\" *if=\"localizedValue && localizedValue.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"localizedValue\" [innerHTML]=\"localizedValue.file\"></div>\r\n\t\t\t<ul class=\"nav--languages\" *if=\"languages.length > 1\">\r\n\t\t\t\t<li class=\"nav__item\" [class]=\"{ active: lang == currentLanguage }\" (click)=\"setLanguage(lang)\" [innerHTML]=\"lang\" *for=\"let lang of languages\"></li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest, of } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nexport default class ControlModelComponent extends ControlAssetComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || '.glb';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\t/*\r\n\t\tthis.click$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t*/\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlModelComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tAssetService.assetDelete$(this.control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.control.value = null;\r\n\t\t\tthis.input.value = null;\r\n\t\t\tthis.control.touched = true; // !!!\r\n\t\t});\r\n\t\t// !!! delete upload\r\n\t\t// !!! delete asset\r\n\t}\r\n\r\n\t/*\r\n\tclick$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'click').pipe(\r\n\t\t\t\ttap(() => input.value = null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\treturn of(file);\r\n\t}\r\n}\r\n\r\nControlModelComponent.meta = {\r\n\tselector: '[control-model]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--model\">\r\n\t\t\t\t<div class=\"file-name\" *if=\"!control.value\" [innerHTML]=\"'select_file' | label\"></div>\r\n\t\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t\t\t<div class=\"btn--upload\"><input type=\"file\"><span [innerHTML]=\"'browse' | label\"></span></div>\r\n\t\t\t\t<div class=\"btn--remove\" *if=\"control.value\" (click)=\"onRemove($event)\"><span [innerHTML]=\"'remove' | label\"></span></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlNumberComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(value) {\r\n\t\tthis.control.value = value;\r\n\t}\r\n}\r\n\r\nControlNumberComponent.meta = {\r\n\tselector: '[control-number]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--number\">\r\n\t\t\t\t<input-value label=\"\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value\" (update)=\"updateValue($event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlPasswordComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlPasswordComponent.meta = {\r\n\tselector: '[control-password]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"password\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlSelectComponent.meta = {\r\n\tselector: '[control-select]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control\" required>\r\n\t\t\t\t<option [value]=\"null\" [innerHTML]=\"'select' | label\"></option>\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextComponent.meta = {\r\n\tselector: '[control-text]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextareaComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextareaComponent.meta = {\r\n\tselector: '[control-textarea]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--textarea\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<textarea class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [innerHTML]=\"label\" rows=\"4\" [disabled]=\"disabled\"></textarea>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlVectorComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(index, value) {\r\n\t\tconst values = this.control.value;\r\n\t\tvalues[index] = value;\r\n\t\tthis.control.value = values.slice();\r\n\t}\r\n}\r\n\r\nControlVectorComponent.meta = {\r\n\tselector: '[control-vector]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--vector\">\r\n\t\t\t\t<input-value label=\"x\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[0]\" (update)=\"updateValue(0, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"y\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[1]\" (update)=\"updateValue(1, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"z\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[2]\" (update)=\"updateValue(2, $event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class DisabledDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('DisabledDirective.onChanges', this.disabled);\r\n\t\tif (this.disabled === true) {\r\n\t\t\tnode.disabled = this.disabled;\r\n\t\t\tnode.setAttribute('disabled', this.disabled);\r\n\t\t} else {\r\n\t\t\tdelete node.disabled;\r\n\t\t\tnode.removeAttribute('disabled');\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nDisabledDirective.meta = {\r\n\tselector: 'input[disabled],textarea[disabled]',\r\n\tinputs: ['disabled'],\r\n};\r\n","import { LabelPipe } from '../label/label.pipe';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ErrorsComponent extends ControlComponent {\r\n\tgetLabel(key, value) {\r\n\t\tconst label = LabelPipe.transform(`error_${key}`);\r\n\t\treturn label;\r\n\t}\r\n}\r\n\r\nErrorsComponent.meta = {\r\n\tselector: 'errors-component',\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"inner\" [style]=\"{ display: control.invalid && control.touched ? 'block' : 'none' }\">\r\n\t\t<div class=\"error\" *for=\"let [key, value] of control.errors\">\r\n\t\t\t<span [innerHTML]=\"getLabel(key, value)\"></span>\r\n\t\t\t<!-- <span class=\"key\" [innerHTML]=\"key\"></span> <span class=\"value\" [innerHTML]=\"value | json\"></span> -->\r\n\t\t</div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { fromEvent, interval, merge, race } from 'rxjs';\r\nimport { filter, map, switchMap, takeUntil, tap } from 'rxjs/operators';\r\n\r\nexport default class InputValueComponent extends Component {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.value = this.value || 0;\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.increment$('.btn--more', 1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tthis.increment$('.btn--less', -1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\t// fromEvent(input, 'change')\r\n\t\tmerge(\r\n\t\t\tfromEvent(input, 'input')\r\n\t\t).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tmerge(\r\n\t\t\tfromEvent(input, 'blur'),\r\n\t\t\tfromEvent(input, 'keydown').pipe(\r\n\t\t\t\tfilter(event => (event.key === 'Enter' || event.keyCode === 13)),\r\n\t\t\t)\r\n\t\t).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t\t// fromEvent(node, 'focus').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onFocus(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\t// const node = getContext(this).node;\r\n\t\t// const value = node.value === '' ? null : node.value;\r\n\t\tevent.target.value = event.target.value.replace(/[^\\d|\\.|-]/g, '');\r\n\t\t// console.log('InputValueComponent.onInputDidChange', event.target.value);\r\n\t\t/*\r\n\t\tconst value = parseFloat(event.target.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\t// this.control.touched = true;\r\n\t\t// console.log('InputValueComponent.onInputDidBlur', event.target.value);\r\n\t\tconst value = parseFloat(this.input.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t} else {\r\n\t\t\t\tthis.input.value = this.getValue();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tincrement$(selector, sign) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst element = node.querySelector(selector);\r\n\t\tlet m, increment;\r\n\t\treturn race(fromEvent(element, 'mousedown'), fromEvent(element, 'touchstart')).pipe(\r\n\t\t\ttap(() => {\r\n\t\t\t\tincrement = this.increment;\r\n\t\t\t\tm = 16;\r\n\t\t\t}),\r\n\t\t\tswitchMap((e) => {\r\n\t\t\t\treturn interval(30).pipe(\r\n\t\t\t\t\tfilter((i) => {\r\n\t\t\t\t\t\treturn i % m === 0;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tmap(() => {\r\n\t\t\t\t\t\tconst i = increment * sign;\r\n\t\t\t\t\t\t// increment = Math.min(this.increment * 100, increment * 2);\r\n\t\t\t\t\t\tm = Math.max(1, Math.floor(m * 0.85));\r\n\t\t\t\t\t\treturn i;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\t// startWith(increment * sign),\r\n\t\t\t\t\ttakeUntil(race(fromEvent(element, 'mouseup'), fromEvent(element, 'touchend')))\r\n\t\t\t\t);\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\tgetValue() {\r\n\t\treturn this.value.toFixed(this.precision);\r\n\t}\r\n\tsetValue(sign) {\r\n\t\tthis.value += this.increment * sign;\r\n\t\tthis.update.next(this.value);\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nInputValueComponent.meta = {\r\n\tselector: 'input-value',\r\n\toutputs: ['update'],\r\n\tinputs: ['value', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--control\" [class]=\"{ disabled: disabled }\">\r\n\t\t\t<input type=\"text\" class=\"control--text\" [placeholder]=\"label\" [value]=\"getValue()\" [disabled]=\"disabled\" />\r\n\t\t\t<div class=\"control--trigger\">\r\n\t\t\t\t<div class=\"btn--more\" (click)=\"setValue(1)\">+</div>\r\n\t\t\t\t<div class=\"btn--less\" (click)=\"setValue(-1)\">-</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { ENV } from '../environment';\r\n\r\nexport default class TestComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = ENV;\r\n\t}\r\n\r\n\tonTest(event) {\r\n\t\tthis.test.next(event);\r\n\t}\r\n\r\n\tonReset(event) {\r\n\t\tthis.reset.next(event);\r\n\t}\r\n\r\n}\r\n\r\nTestComponent.meta = {\r\n\tselector: 'test-component',\r\n\tinputs: ['form'],\r\n\toutputs: ['test', 'reset'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"group--form--results\" *if=\"env.DEVELOPMENT\">\r\n\t\t<code [innerHTML]=\"form.value | json\"></code>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onReset($event)\"><span>reset</span></button>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onTest($event)\"><span>test</span></button>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class ValueDirective extends Directive {\r\n\r\n\tonChanges(changes) {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('ValueDirective.onChanges', this.value);\r\n\t\tnode.value = this.value;\r\n\t\tnode.setAttribute('value', this.value);\r\n\t}\r\n\r\n}\r\n\r\nValueDirective.meta = {\r\n\tselector: '[value]',\r\n\tinputs: ['value'],\r\n};\r\n","import { Pipe } from 'rxcomp';\r\n\r\n/*\r\n['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n['\"', '&', ''', '<', '>', ' ', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '&', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];\r\n*/\r\n\r\nexport default class HtmlPipe extends Pipe {\r\n\r\n\tstatic transform(value) {\r\n\t\tif (value) {\r\n\t\t\tvalue = value.replace(/&#(\\d+);/g, function(m, n) {\r\n\t\t\t\treturn String.fromCharCode(parseInt(n));\r\n\t\t\t});\r\n\t\t\tconst escapes = ['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n\t\t\tconst unescapes = ['\"', '&', '\\'', '<', '>', ' ', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '&', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];\r\n\t\t\tconst rx = new RegExp(`(&${escapes.join(';)|(&')};)`, 'g');\r\n\t\t\tvalue = value.replace(rx, function() {\r\n\t\t\t\tfor (let i = 1; i < arguments.length; i++) {\r\n\t\t\t\t\tif (arguments[i]) {\r\n\t\t\t\t\t\t// console.log(arguments[i], unescapes[i - 1]);\r\n\t\t\t\t\t\treturn unescapes[i - 1];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// console.log(value);\r\n\t\t\treturn value;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHtmlPipe.meta = {\r\n\tname: 'html',\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class IdDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.setAttribute('id', this.id);\r\n\t}\r\n\r\n}\r\n\r\nIdDirective.meta = {\r\n\tselector: '[id]',\r\n\tinputs: ['id']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { LanguageService } from './language.service';\r\n\r\nexport default class LanguageComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.showLanguages = false;\r\n\t\tthis.languageService = LanguageService;\r\n\t}\r\n\r\n\tsetLanguage(language) {\r\n\t\tthis.languageService.setLanguage$(language).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(_ => {\r\n\t\t\tthis.showLanguages = false;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tthis.set.next();\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleLanguages() {\r\n\t\tthis.showLanguages = !this.showLanguages;\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nLanguageComponent.meta = {\r\n\tselector: '[language]',\r\n\toutputs: ['set'],\r\n\ttemplate: /* html */ `\r\n\t\t<button type=\"button\" class=\"btn--language\" (click)=\"toggleLanguages()\" *if=\"languageService.hasLanguages\"><span [innerHTML]=\"languageService.activeLanguage.title\"></span> <svg viewBox=\"0 0 8 5\"><use xlink:href=\"#caret-down\"></use></svg></button>\r\n\t\t<ul class=\"nav--language\" *if=\"showLanguages\">\r\n\t\t\t<li (click)=\"setLanguage(language)\" *for=\"let language of languageService.languages\"><span [innerHTML]=\"language.title\"></span></li>\r\n\t\t</ul>\r\n\t`\r\n};\r\n","export default class LazyCache {\r\n\tstatic get cache() {\r\n\t\tif (!this.cache_) {\r\n\t\t\tthis.cache_ = {};\r\n\t\t}\r\n\t\treturn this.cache_;\r\n\t}\r\n\r\n\tstatic get(src) {\r\n\t\treturn this.cache[src];\r\n\t}\r\n\r\n\tstatic set(src, blob) {\r\n\t\tthis.cache[src] = blob;\r\n\t\tconst keys = Object.keys(this.cache);\r\n\t\tif (keys.length > 100) {\r\n\t\t\tthis.remove(keys[0]);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remove(src) {\r\n\t\tdelete this.cache[src];\r\n\t}\r\n}\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { of, Subject } from 'rxjs';\r\nimport { distinctUntilChanged, first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport ImageService from '../image/image.service';\r\nimport IntersectionService from '../intersection/intersection.service';\r\nimport LazyCache from './lazy.cache';\r\n\r\nexport default class LazyDirective extends Directive {\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('lazy');\r\n\t\tthis.input$ = new Subject().pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t\tswitchMap(input => {\r\n\t\t\t\tconst src = LazyCache.get(input);\r\n\t\t\t\tif (src) {\r\n\t\t\t\t\treturn of(src);\r\n\t\t\t\t}\r\n\t\t\t\tnode.classList.remove('lazyed');\r\n\t\t\t\treturn this.lazy$(input);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t);\r\n\t\tthis.input$.subscribe(src => {\r\n\t\t\tLazyCache.set(this.lazy, src);\r\n\t\t\tnode.setAttribute('src', src);\r\n\t\t\tnode.classList.add('lazyed');\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.input$.next(this.lazy);\r\n\t}\r\n\r\n\tlazy$(input) {\r\n\t\tconst { node } = getContext(this);\r\n\t\treturn IntersectionService.intersection$(node).pipe(\r\n\t\t\t// first(),\r\n\t\t\tswitchMap(() => ImageService.load$(input, this.size)),\r\n\t\t\tfirst(),\r\n\t\t\t// takeUntil(this.unsubscribe$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n\r\nLazyDirective.meta = {\r\n\tselector: '[lazy],[[lazy]]',\r\n\tinputs: ['lazy', 'size']\r\n};\r\n","import { BehaviorSubject, of , Subject } from 'rxjs';\r\nimport { filter, finalize, first, map } from 'rxjs/operators';\r\n\r\nexport default class IntersectionService {\r\n\r\n\tstatic observer() {\r\n\t\tif (!this.observer_) {\r\n\t\t\tthis.readySubject_ = new BehaviorSubject(false);\r\n\t\t\tthis.observerSubject_ = new Subject();\r\n\t\t\tthis.observer_ = new IntersectionObserver(entries => {\r\n\t\t\t\tthis.observerSubject_.next(entries);\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn this.observer_;\r\n\t}\r\n\r\n\tstatic intersection$(node) {\r\n\t\tif ('IntersectionObserver' in window) {\r\n\t\t\tconst observer = this.observer();\r\n\t\t\tobserver.observe(node);\r\n\t\t\treturn this.observerSubject_.pipe(\r\n\t\t\t\t// tap(entries => console.log(entries.length)),\r\n\t\t\t\tmap(entries => entries.find(entry => entry.target === node)),\r\n\t\t\t\t// tap(entry => console.log('IntersectionService.intersection$', entry)),\r\n\t\t\t\tfilter(entry => entry !== undefined && entry.isIntersecting), // entry.intersectionRatio > 0\r\n\t\t\t\tfirst(),\r\n\t\t\t\tfinalize(() => observer.unobserve(node)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of({ target: node });\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\tfunction observer() {\r\n\t\t\tif ('IntersectionObserver' in window) {\r\n\t\t\t\treturn new IntersectionObserver(entries => {\r\n\t\t\t\t\tentries.forEach(function(entry) {\r\n\t\t\t\t\t\tif (entry.isIntersecting) {\r\n\t\t\t\t\t\t\tentry.target.classList.add('appear');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\treturn { observe: function(node) { node.classList.add('appear')}, unobserve: function() {} };\r\n\t\t\t}\r\n\t\t}\r\n\t\tobserver.observe(node);\r\n\t\tobserver.unobserve(node);\r\n\t\t*/\r\n\r\n\t}\r\n\r\n}\r\n","import { Pipe } from 'rxcomp';\r\n\r\nexport const URL_PATTERN = '(?:(?:https?|ftp):\\/\\/|\\b(?:[a-z\\d]+\\.))(?:(?:[^\\s()<>]+|\\((?:[^\\s()<>]+|(?:\\([^\\s()<>]+\\)))?\\))+(?:\\((?:[^\\s()<>]+|(?:\\(?:[^\\s()<>]+\\)))?\\)|[^\\s`!()\\[\\]{};:\\'\".,<>?]))?';\r\n\r\n// export const URL_PATTERN = '/((http:\\/\\/|https:\\/\\/|www\\.)([a-z0-9])([a-z0-9]|\\.)+(\\?[a-z]([a-z0-9]|\\=|\\&)+)?)';\r\n\r\nexport default class MessagePipe extends Pipe {\r\n\r\n\tstatic transform(text) {\r\n\t\tlet html = MessagePipe.urlify(text);\r\n\t\thtml = MessagePipe.breakLines(html);\r\n\t\t// console.log('MessagePipe', text, html);\r\n\t\treturn html;\r\n\t}\r\n\r\n\tstatic urlify(text) {\r\n\t\t// const regex = new RegExp(URL_PATTERN, 'gim');\r\n\t\tconst regex = /(?:(?:https?|ftp):\\/\\/|\\b(?:[a-z\\d]+\\.))(?:(?:[^\\s()<>]+|\\((?:[^\\s()<>]+|(?:\\([^\\s()<>]+\\)))?\\))+(?:\\((?:[^\\s()<>]+|(?:\\(?:[^\\s()<>]+\\)))?\\)|[^\\s`!()\\[\\]{};:'\".,<>?]))?/gmi;\r\n\t\treturn text.replace(regex, (url) => {\r\n\t\t\treturn /*html*/`<a href=\"${url}\" target=\"_blank\">${url}</a>`;\r\n\t\t});\r\n\t\t// or alternatively\r\n\t\t// return text.replace(urlRegex, '<a href=\"$1\">$1</a>')\r\n\t}\r\n\r\n\tstatic breakLines(text) {\r\n\t\tconst regex = /\\n/gm;\r\n\t\treturn text.replace(regex, (text) => {\r\n\t\t\treturn /*html*/`<br>`;\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nMessagePipe.meta = {\r\n\tname: 'message',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from './modal-outlet.component';\r\nimport { ModalService } from './modal.service';\r\n\r\nexport default class ModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nModalComponent.meta = {\r\n\tselector: '[modal]'\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { fromEvent } from 'rxjs';\r\nimport { map, takeUntil } from 'rxjs/operators';\r\n// import { RouteSegment } from '../route/route-segment';\r\nimport { RouterService } from './router.service';\r\n\r\nexport class RouterLinkDirective extends Directive {\r\n\r\n\tpath;\r\n\tsegments;\r\n\trouterLink_;\r\n\r\n\tget routerLink() {\r\n\t\treturn this.routerLink_;\r\n\t}\r\n\r\n\tset routerLink(routerLink) {\r\n\t\tthis.routerLink_ = Array.isArray(routerLink) ? routerLink : [routerLink];\r\n\t\t// this.segments = this.getSegments(this.routerLink_);\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// const { node, module } = getContext(this);\r\n\t\t// console.log('RouterLinkDirective.onInit', this.routerLink, node, module);\r\n\t\tthis.routerLink$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// const routerLink = Array.isArray(this.routerLink) ? this.routerLink : [this.routerLink];\r\n\t\tconst routerLink = this.routerLink;\r\n\t\tif (routerLink.length) {\r\n\t\t\tconst routeUrl = RouterService.buildUrl(...routerLink);\r\n\t\t\t// RouterService.isActive(name, params, [strictEquality], [ignoreQueryParams])\r\n\t\t\t// console.log('RouterLinkDirective.routeUrl', routeUrl);\r\n\t\t\tnode.setAttribute('href', routeUrl);\r\n\t\t} else {\r\n\t\t\tnode.setAttribute('href', '');\r\n\t\t}\r\n\t}\r\n\r\n\trouterLink$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\treturn fromEvent(node, 'click').pipe(\r\n\t\t\tmap((event) => {\r\n\t\t\t\t// console.log('RouterLinkDirective.routerLink$', this.routerLink);\r\n\t\t\t\tRouterService.setRouterLink(...this.routerLink);\r\n\t\t\t\tevent.preventDefault();\r\n\t\t\t\treturn false;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tgetSegments(routerLink) {\r\n\t\t// console.log('RouterLinkDirective.getSegments', routerLink);\r\n\t\tconst segments = [];\r\n\t\trouterLink.forEach(item => {\r\n\t\t\tif (typeof item === 'string') {\r\n\t\t\t\tconst regExp = /([^:]+)|\\:([^\\/]+)/g;\r\n\t\t\t\tconst matches = item.matchAll(regExp);\r\n\t\t\t\tconst components = [];\r\n\t\t\t\tfor (let match of matches) {\r\n\t\t\t\t\tconst g1 = match[1];\r\n\t\t\t\t\tconst g2 = match[2];\r\n\t\t\t\t\tif (g1) {\r\n\t\t\t\t\t\tcomponents.push(g1);\r\n\t\t\t\t\t} else if (g2) {\r\n\t\t\t\t\t\tconst param = {};\r\n\t\t\t\t\t\tparam[g2] = null;\r\n\t\t\t\t\t\tcomponents.push(param);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tsegments.push(new RouteSegment('', {}));\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn segments;\r\n\t}\r\n\r\n\tstatic meta = {\r\n\t\tselector: '[routerLink]',\r\n\t\tinputs: ['routerLink'],\r\n\t};\r\n}\r\n\r\n/*\r\nget urlTree(): UrlTree {\r\n\treturn RouterService.createUrlTree(this.routerLink, {\r\n\t\trelativeTo: this.route,\r\n\t\tqueryParams: this.queryParams,\r\n\t\tfragment: this.fragment,\r\n\t\tpreserveQueryParams: this.preserve,\r\n\t\tqueryParamsHandling: this.queryParamsHandling,\r\n\t\tpreserveFragment: this.preserveFragment,\r\n\t});\r\n}\r\n*/\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport { ModalService } from '../modal/modal.service';\r\n\r\nexport default class SupportRequestModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tonAccept(user) {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonReject(user) {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tonClose() {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nSupportRequestModalComponent.meta = {\r\n\tselector: '[support-request-modal]',\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"modal__header\">\r\n\t\t\t<button type=\"button\" class=\"btn--close\" (click)=\"onClose()\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#close\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"container\">\r\n\t\t\t<div class=\"form\">\r\n\t\t\t\t<div class=\"title\">Un operatore  disponibile per un tour guidato.<br>Desideri Accettare?</div>\r\n\t\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--accept\" (click)=\"onAccept()\">\r\n\t\t\t\t\t\t<span>Accetta</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t\t<button type=\"button\" class=\"btn--cancel\" (click)=\"onReject()\">\r\n\t\t\t\t\t\t<span>Rifiuta</span>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nSupportRequestModalComponent.chunk = () => /* html */`<div class=\"support-request-modal\" support-request-modal></div>`;\r\n","import { getContext, Structure } from 'rxcomp';\r\n\r\nexport default class SvgIconStructure extends Structure {\r\n\tonInit() {\r\n\t\tthis.update();\r\n\t}\r\n\tonChanges() {\r\n\t\tthis.update();\r\n\t}\r\n\tupdate() {\r\n\t\tif (this.name_ !== this.name) {\r\n\t\t\tthis.name_ = this.name;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tif (node.parentNode) {\r\n\t\t\t\tconst xmlns = 'http://www.w3.org/2000/svg';\r\n\t\t\t\tconst element = document.createElementNS(xmlns, `svg`);\r\n\t\t\t\tconst w = this.width || 24;\r\n\t\t\t\tconst h = this.height || 24;\r\n\t\t\t\telement.setAttribute('class', `icon--${this.name}`);\r\n\t\t\t\t// element.setAttributeNS(null, 'width', w);\r\n\t\t\t\t// element.setAttributeNS(null, 'height', h);\r\n\t\t\t\telement.setAttributeNS(null, 'viewBox', `0 0 ${w} ${h}`);\r\n\t\t\t\telement.innerHTML = `<use xlink:href=\"#${this.name}\"></use>`;\r\n\t\t\t\telement.rxcompId = node.rxcompId;\r\n\t\t\t\telement.classList.add(...node.classList);\r\n\t\t\t\tnode.parentNode.replaceChild(element, node);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nSvgIconStructure.meta = {\r\n\tselector: 'svg-icon',\r\n\tinputs: ['name', 'width', 'height']\r\n};\r\n\r\n/*\r\n<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n*/\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class TitleDirective extends Directive {\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tthis.title_ = title;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\ttitle ? node.setAttribute('title', title) : node.removeAttribute('title');\r\n\t\t}\r\n\t}\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n}\r\n\r\nTitleDirective.meta = {\r\n\tselector: '[[title]]',\r\n\tinputs: ['title'],\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { fromEvent, of } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetType } from '../asset/asset';\r\n\r\nexport default class UploadItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\t// console.log('UploadItemComponent.onInit', this.item);\r\n\t\tif (this.item.preview === null) {\r\n\t\t\tthis.read$(this.item.file).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe(preview => {\r\n\t\t\t\tthis.item.preview = preview;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tread$(file) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tif (this.item.type.name === AssetType.Image.name) {\r\n\t\t\t\t\treturn this.resize$(blob);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn of(blob);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tresize$(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function(error) {\r\n\t\t\t\treject(error);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n\r\n\tonPause() {\r\n\t\tthis.pause.next(this.item);\r\n\t}\r\n\r\n\tonResume() {\r\n\t\tthis.resume.next(this.item);\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tthis.cancel.next(this.item);\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tthis.remove.next(this.item);\r\n\t}\r\n}\r\n\r\nUploadItemComponent.meta = {\r\n\tselector: '[upload-item]',\r\n\toutputs: ['pause', 'resume', 'cancel', 'remove'],\r\n\tinputs: ['item'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"upload-item\" [class]=\"{ 'error': item.error, 'success': item.success }\">\r\n\t\t<div class=\"picture\">\r\n\t\t\t<img [lazy]=\"item.preview\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.preview && item.type.name === 'image'\" />\r\n\t\t\t<video [src]=\"item.preview\" *if=\"item.preview && item.type.name === 'video'\"></video>\r\n\t\t\t<svg class=\"spinner\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" [class]=\"{ uploading: item.uploading }\" *if=\"item.uploading\"><use xlink:href=\"#spinner\"></use></svg>\r\n\t\t</div>\r\n\t\t<div class=\"name\">{{item.name}}</div>\r\n\t\t<!--\r\n\t\t<div class=\"group--info\">\r\n\t\t\t<div>progress: {{item.progress}}</div>\r\n\t\t\t<div>size: {{item.size}} bytes</div>\r\n\t\t\t<div>current speed: {{item.currentSpeed}} bytes/s</div>\r\n\t\t\t<div>average speed: {{item.averageSpeed}} bytes/s</div>\r\n\t\t\t<div>time ramining: {{item.timeRemaining}}s</div>\r\n\t\t\t<div>paused: {{item.paused}}</div>\r\n\t\t\t<div>success: {{item.success}}</div>\r\n\t\t\t<div>complete: {{item.complete}}</div>\r\n\t\t\t<div>error: {{item.error}}</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<!--\r\n\t\t<div class=\"group--cta\" *if=\"!item.complete && item.uploading\">\r\n\t\t\t<div class=\"btn--pause\" (click)=\"onPause()\">pause</div>\r\n\t\t\t<div class=\"btn--resume\" (click)=\"onResume()\">resume</div>\r\n\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\">cancel</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<div class=\"group--cta\">\r\n\t\t\t<div class=\"btn--remove\" (click)=\"onRemove()\" *if=\"!item.complete\">remove</div>\r\n\t\t</div>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class HlsDirective extends Directive {\r\n\r\n\tset hls(hls) {\r\n\t\tif (this.hls_ !== hls) {\r\n\t\t\tthis.hls_ = hls;\r\n\t\t\tthis.play(hls);\r\n\t\t}\r\n\t}\r\n\r\n\tget hls() {\r\n\t\treturn this.hls_;\r\n\t}\r\n\r\n\tplay(src) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\t// bind them together\r\n\t\t\thls.attachMedia(node);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\tnode.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHlsDirective.meta = {\r\n\tselector: '[[hls]]',\r\n\tinputs: ['hls'],\r\n};\r\n","import { Context } from 'rxcomp';\r\n\r\nexport default class VirtualItem extends Context {\r\n\tconstructor(key, $key, value, $value, index, count, parentInstance) {\r\n\t\tsuper(parentInstance);\r\n\t\tthis[key] = $key;\r\n\t\tthis[value] = $value;\r\n\t\tthis.index = index;\r\n\t\tthis.count = count;\r\n\t}\r\n\r\n\tget first() {\r\n\t\treturn this.index === 0;\r\n\t}\r\n\r\n\tget last() {\r\n\t\treturn this.index === this.count - 1;\r\n\t}\r\n\r\n\tget even() {\r\n\t\treturn this.index % 2 === 0;\r\n\t}\r\n\r\n\tget odd() {\r\n\t\treturn !this.even;\r\n\t}\r\n}\r\n","import { getContext, Structure } from 'rxcomp';\r\nimport { BehaviorSubject, fromEvent, merge } from 'rxjs';\r\nimport { auditTime, distinctUntilChanged, map, startWith, takeUntil, tap } from 'rxjs/operators';\r\nimport VirtualItem from './virtual.item';\r\n\r\nexport const VirtualMode = {\r\n\tResponsive: 1,\r\n\tGrid: 2,\r\n\tCentered: 3,\r\n\tList: 4,\r\n};\r\n\r\nexport default class VirtualStructure extends Structure {\r\n\r\n\tonInit() {\r\n\t\tconst { module, node } = getContext(this);\r\n\t\tconst template = node.firstElementChild;\r\n\t\tconst expression = node.getAttribute('*virtual');\r\n\t\tnode.removeAttribute('*virtual');\r\n\t\tnode.removeChild(template);\r\n\t\tconst tokens = (this.tokens = this.getExpressionTokens(expression));\r\n\t\tthis.virtualFunction = module.makeFunction(tokens.iterable);\r\n\t\tthis.container = node;\r\n\t\tthis.template = template;\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.reverse = this.reverse === true ? true : false;\r\n\t\tthis.options = {\r\n\t\t\twidth: this.width,\r\n\t\t\tgutter: this.gutter,\r\n\t\t\treverse: this.reverse,\r\n\t\t\tcontainerWidth: 0,\r\n\t\t\tcontainerHeight: 0,\r\n\t\t\ttop: 0,\r\n\t\t\tcols: [0],\r\n\t\t};\r\n\t\tthis.cachedRects = {};\r\n\t\tthis.cachedInstances = [];\r\n\t\tthis.cacheNodes = [];\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.update$()\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe(visibleItems => {\r\n\t\t\t\t// console.log(visibleItems.length);\r\n\t\t\t});\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\t// resolve\r\n\t\tconst items = module.resolve(this.virtualFunction, context.parentInstance, this) || [];\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.options.width = this.width;\r\n\t\tthis.updateView(true);\r\n\t\tthis.items$.next(items);\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t}\r\n\r\n\tupdate$() {\r\n\t\tthis.updateView(true);\r\n\t\treturn merge(this.scroll$(), this.resize$(), this.items$.pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t)).pipe(\r\n\t\t\tmap(_ => {\r\n\t\t\t\tconst visibleItems = this.updateForward();\r\n\t\t\t\treturn visibleItems;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tupdateForward() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = 0, len = items.length; i < len; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, 0, options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tconst parentContainer = this.container.parentNode;\r\n\t\tif (this.reverse && (highestHeight < parentContainer.offsetHeight - 1)) {\r\n\t\t\tconst diff = parentContainer.offsetHeight - 1 - highestHeight;\r\n\t\t\titems.forEach((item, i) => {\r\n\t\t\t\tif (visibleItems.indexOf(item) !== -1) {\r\n\t\t\t\t\tconst rect = this.cachedRects[i];\r\n\t\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\t\tnode.style.top = (rect.top + diff) + 'px';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.container.style.height = `${parentContainer.offsetHeight - 1}px`;\r\n\t\t} else {\r\n\t\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\t}\r\n\t\t// console.log('VirtualStructure.updateForward', 'items.length', items.length, highestHeight, visibleItems);\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\t/*\r\n\tupdateForward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = items.filter((item, i) => {\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t});\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\tupdateBackward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet lowestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = items.length - 1; i >= 0; i--) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\tbottom = options.cols[col];\r\n\t\t\tif (this.intersect(bottom - height + options.top, bottom + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, -top);\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom: bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.top = top;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, top);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${-lowestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\t*/\r\n\r\n\tgetCols() {\r\n\t\tconst options = this.options;\r\n\t\tconst cols = Math.floor((options.containerWidth + options.gutter) / (options.width + options.gutter)) || 1;\r\n\t\treturn new Array(cols).fill(0);\r\n\t}\r\n\r\n\tgetCol() {\r\n\t\tconst options = this.options;\r\n\t\tlet col;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tcol = options.cols.reduce((p, c, i, a) => {\r\n\t\t\t\t\treturn c < a[p] ? i : p;\r\n\t\t\t\t}, 0);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tcol = 0;\r\n\t\t}\r\n\t\treturn col;\r\n\t}\r\n\r\n\tgetWidth() {\r\n\t\tconst options = this.options;\r\n\t\tlet width;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\twidth = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\twidth = (options.containerWidth - (options.cols.length - 1) * options.gutter) / options.cols.length;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\twidth = options.containerWidth;\r\n\t\t}\r\n\t\treturn width;\r\n\t}\r\n\r\n\tgetHeight(width, item) {\r\n\t\tconst options = this.options;\r\n\t\tlet height;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\theight = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\theight = 80;\r\n\t\t}\r\n\t\treturn height;\r\n\t}\r\n\r\n\tgetGutter(width) {\r\n\t\tconst options = this.options;\r\n\t\tlet gutter;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tgutter = options.gutter;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tgutter = (options.containerWidth - options.cols.length * width) / (options.cols.length - 1);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tgutter = 0;\r\n\t\t}\r\n\t\treturn gutter;\r\n\t}\r\n\r\n\tgetLeft(index, width, gutter) {\r\n\t\tconst options = this.options;\r\n\t\tlet left;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tleft = index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tleft = (options.containerWidth - options.cols.length * (width + gutter) + gutter) / 2 + index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tleft = 0;\r\n\t\t}\r\n\t\treturn left;\r\n\t}\r\n\r\n\tcachedNode(index, i, value, total) {\r\n\t\tif (this.cacheNodes[index]) {\r\n\t\t\treturn this.updateNode(index, i, value);\r\n\t\t} else {\r\n\t\t\treturn this.createNode(index, i, value, total);\r\n\t\t}\r\n\t}\r\n\r\n\tcreateNode(index, i, value, total) {\r\n\t\tconst clonedNode = this.template.cloneNode(true);\r\n\t\tdelete clonedNode.rxcompId;\r\n\t\tthis.container.appendChild(clonedNode);\r\n\t\tthis.cacheNodes[index] = clonedNode;\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\tconst tokens = this.tokens;\r\n\t\tconst args = [tokens.key, i, tokens.value, value, i, total, context.parentInstance];\r\n\t\tconst instance = module.makeInstance(clonedNode, VirtualItem, context.selector, context.parentInstance, args);\r\n\t\tconst forItemContext = getContext(instance);\r\n\t\tmodule.compile(clonedNode, forItemContext.instance);\r\n\t\tthis.cachedInstances[index] = instance;\r\n\t\treturn clonedNode;\r\n\t}\r\n\r\n\tupdateNode(index, i, value) {\r\n\t\tconst instance = this.cachedInstances[index];\r\n\t\tconst tokens = this.tokens;\r\n\t\tif (instance[tokens.key] !== i) {\r\n\t\t\tinstance[tokens.key] = i;\r\n\t\t\tinstance[tokens.value] = value;\r\n\t\t\tinstance.pushChanges();\r\n\t\t}\r\n\t\t// console.log(index, i, value);\r\n\t\treturn this.cacheNodes[index];\r\n\t}\r\n\r\n\tremoveNode(index) {\r\n\t\tthis.cachedInstances[index] = undefined;\r\n\t\tconst node = this.cacheNodes[index];\r\n\t\tif (node) {\r\n\t\t\tconst context = getContext(this);\r\n\t\t\tconst module = context.module;\r\n\t\t\tnode.parentNode.removeChild(node);\r\n\t\t\tmodule.remove(node);\r\n\t\t}\r\n\t\tthis.cacheNodes[index] = undefined;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tintersect(top1, bottom1, top2, bottom2) {\r\n\t\t// console.log(top2, '<', bottom1, bottom2, '>', top1);\r\n\t\treturn top2 < bottom1 && bottom2 > top1;\r\n\t}\r\n\r\n\tresize$() {\r\n\t\treturn fromEvent(window, 'resize').pipe(\r\n\t\t\tstartWith(_ => null),\r\n\t\t\tauditTime(100),\r\n\t\t\ttap(() => this.updateView(true)),\r\n\t\t);\r\n\t}\r\n\r\n\tscroll$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(node.parentNode, getComputedStyle(node.parentNode).overflowY, node.parentNode.style.overflowY);\r\n\t\tif (node.parentNode && getComputedStyle(node.parentNode).overflowY === 'auto') {\r\n\t\t\treturn fromEvent(node.parentNode, 'scroll').pipe(\r\n\t\t\t\ttap(() => {\r\n\t\t\t\t\tthis.updateView();\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn fromEvent(window, 'scroll').pipe(tap(() => this.updateView()));\r\n\t\t}\r\n\t}\r\n\r\n\tupdateView(reset) {\r\n\t\tconst rect = this.container.getBoundingClientRect();\r\n\t\tconst options = this.options;\r\n\t\toptions.top = rect.top;\r\n\t\toptions.containerWidth = rect.width;\r\n\t\t// options.containerHeight = rect.height;\r\n\t\toptions.containerHeight = this.container.parentNode.offsetHeight;\r\n\t\toptions.cols = this.getCols();\r\n\t\tif (reset) {\r\n\t\t\tthis.cachedRects = {};\r\n\t\t}\r\n\t}\r\n\r\n\tgetExpressionTokens(expression) {\r\n\t\tif (expression === null) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tif (expression.trim().indexOf('let ') === -1 || expression.trim().indexOf(' of ') === -1) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tconst expressions = expression\r\n\t\t\t.split(';')\r\n\t\t\t.map(x => x.trim())\r\n\t\t\t.filter(x => x !== '');\r\n\t\tconst virtualExpressions = expressions[0].split(' of ').map(x => x.trim());\r\n\t\tlet value = virtualExpressions[0].replace(/\\s*let\\s*/, '');\r\n\t\tconst iterable = virtualExpressions[1];\r\n\t\tlet key = 'index';\r\n\t\tconst keyValueMatches = value.match(/\\[(.+)\\s*,\\s*(.+)\\]/);\r\n\t\tif (keyValueMatches) {\r\n\t\t\tkey = keyValueMatches[1];\r\n\t\t\tvalue = keyValueMatches[2];\r\n\t\t}\r\n\t\tif (expressions.length > 1) {\r\n\t\t\tconst indexExpressions = expressions[1].split(/\\s*let\\s*|\\s*=\\s*index/).map(x => x.trim());\r\n\t\t\tif (indexExpressions.length === 3) {\r\n\t\t\t\tkey = indexExpressions[1];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn { key, value, iterable };\r\n\t}\r\n}\r\n\r\nVirtualStructure.meta = {\r\n\tselector: '[*virtual]',\r\n\tinputs: ['mode', 'width', 'gutter', 'reverse'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { filter, takeUntil, tap } from 'rxjs/operators';\r\nimport DragService, { DragDownEvent, DragMoveEvent, DragUpEvent } from '../../drag/drag.service';\r\nimport MediaLoader, { MediaLoaderDisposeEvent, MediaLoaderPauseEvent, MediaLoaderPlayEvent, MediaLoaderTimeUpdateEvent } from './media-loader';\r\n\r\nexport default class MediaPlayerComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\t// console.log('MediaPlayerComponent', this.media);\r\n\t\tthis.playing = false;\r\n\t\tthis.progress = 0;\r\n\t\tthis.media$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t\tthis.drag$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\tmedia$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst page = document.querySelector('.page');\r\n\t\treturn MediaLoader.events$.pipe(\r\n\t\t\t// filter(event => event.loader.item.id === this.media.item.id),\r\n\t\t\ttap(event => {\r\n\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\tthis.media = event.loader;\r\n\t\t\t\t\tthis.playing = true;\r\n\t\t\t\t\tnode.classList.add('active');\r\n\t\t\t\t\tpage.classList.add('media-player-active');\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t} else if (this.media === event.loader) {\r\n\t\t\t\t\tif (event instanceof MediaLoaderPauseEvent) {\r\n\t\t\t\t\t\tthis.playing = false;\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t} else if (event instanceof MediaLoaderTimeUpdateEvent) {\r\n\t\t\t\t\t\tif (!this.dragging) {\r\n\t\t\t\t\t\t\tthis.progress = this.media.progress;\r\n\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if (event instanceof MediaLoaderDisposeEvent) {\r\n\t\t\t\t\t\tthis.media = null;\r\n\t\t\t\t\t\tnode.classList.remove('active');\r\n\t\t\t\t\t\tpage.classList.remove('media-player-active');\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('MediaPlayerComponent.MediaLoader.events$', event);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tdrag$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst track = node.querySelector('.track');\r\n\t\tlet initialProgress;\r\n\t\treturn DragService.observe$(track).pipe(\r\n\t\t\tfilter(_ => this.media),\r\n\t\t\ttap((event) => {\r\n\t\t\t\tif (event instanceof DragDownEvent) {\r\n\t\t\t\t\tconst rect = track.getBoundingClientRect();\r\n\t\t\t\t\tinitialProgress = Math.max(0, Math.min(1, (event.down.x - rect.left) / rect.width));\r\n\t\t\t\t\tthis.dragging = true;\r\n\t\t\t\t} else if (event instanceof DragMoveEvent) {\r\n\t\t\t\t\tconst rect = track.getBoundingClientRect();\r\n\t\t\t\t\tconst progress = Math.max(0, Math.min(1, initialProgress + event.distance.x / rect.width));\r\n\t\t\t\t\tthis.progress = progress;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t} else if (event instanceof DragUpEvent) {\r\n\t\t\t\t\tthis.media.progress = this.progress;\r\n\t\t\t\t\tthis.dragging = false;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tonPlay() {\r\n\t\tthis.media.play();\r\n\t}\r\n\r\n\tonPause() {\r\n\t\tthis.media.pause();\r\n\t}\r\n\r\n\tonTrack(event) {\r\n\t\tconst rect = event.currentTarget.getBoundingClientRect();\r\n\t\tconst progress = (event.screenX - rect.left) / rect.width;\r\n\t\tthis.media.progress = progress;\r\n\t\t// console.log(rect.left, event.screenX);\r\n\t}\r\n}\r\n\r\nMediaPlayerComponent.meta = {\r\n\tselector: '[media-player]',\r\n};\r\n","import { environment } from '../../environment';\r\nimport { PANORAMA_RADIUS } from '../geometry/geometry';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\n\r\nexport default class ModelBannerComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tconst init = this.title_ != null;\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (!init) {\r\n\t\t\t\tthis.createBanner();\r\n\t\t\t} else {\r\n\t\t\t\tthis.updateBanner();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelBannerComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\t// console.log('ModelBannerComponent.onView', this.item);\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\t// this.createBanner();\r\n\t}\r\n\t*/\r\n\r\n\tonChanges() {\r\n\t\t// console.log('ModelBannerComponent.onChanges', this.item);\r\n\t\tthis.title = this.item.title;\r\n\t}\r\n\r\n\tcreateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 24;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\ttoneMapped: false,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(1).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\t// !!!\r\n\t\t\t\t// mesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tupdateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelBannerComponent.updateBanner', result);\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonViewBak() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 3;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 45;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 20, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(4).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\tmesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.2;\r\n\t\t\t\t\ttexture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 128;\r\n\t\t\tconst F = Math.floor(H * 0.8);\r\n\t\t\tconst L = Math.floor(H * 0.075);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.item.title;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with 'bevel' & 'round' for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tgetCanvasTexture_() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (this.item.bannerTexture) {\r\n\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t} else {\r\n\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\tbackgroundColor: '#00000000', // '#000000ff',\r\n\t\t\t\t\t\tscale: 2,\r\n\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\tthis.item.bannerTexture = {\r\n\t\t\t\t\t\t\ttexture: texture,\r\n\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t}, 1);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t*/\r\n}\r\n\r\nModelBannerComponent.meta = {\r\n\tselector: '[model-banner]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport { Host } from '../host/host';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelCurvedPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelCurvedPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tconst selected = this.item.selected;\r\n\t\tthis.editing = selected;\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.editing = selected;\r\n\t\t}\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst view = this.view;\r\n\t\tconst items = view.items;\r\n\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\tthis.onMeshDown = this.onMeshDown.bind(this);\r\n\t\tthis.onMeshPlaying = this.onMeshPlaying.bind(this);\r\n\t\tthis.onMeshZoomed = this.onMeshZoomed.bind(this);\r\n\t\tthis.onMeshCurrentTime = this.onMeshCurrentTime.bind(this);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('ModelCurvedPanel', streamId, item.asset)\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = this.disposableMesh = new MediaMesh(item, view, geometry, this.host);\r\n\t\t\t\t\tmesh.updateFromItem(item);\r\n\t\t\t\t\tmesh.name = 'curved-plane';\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tthis.disposableMesh = null;\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.addMeshListeners(mesh);\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\taddMeshListeners(mesh) {\r\n\t\tmesh.on('down', this.onMeshDown);\r\n\t\tmesh.on('playing', this.onMeshPlaying);\r\n\t\tmesh.on('zoomed', this.onMeshZoomed);\r\n\t\tmesh.on('currentTime', this.onMeshCurrentTime);\r\n\t}\r\n\r\n\tremoveMeshListeners(mesh) {\r\n\t\tmesh.off('down', this.onMeshDown);\r\n\t\tmesh.off('playing', this.onMeshPlaying);\r\n\t\tmesh.off('zoomed', this.onMeshZoomed);\r\n\t\tmesh.off('currentTime', this.onMeshCurrentTime);\r\n\t}\r\n\r\n\tonMeshDown() {\r\n\t\t// console.log('ModelCurvedPanelComponent.onMeshDown');\r\n\t\tthis.down.next(this);\r\n\t}\r\n\r\n\tonMeshPlaying(playing) {\r\n\t\t// console.log('ModelCurvedPanelComponent.playing', playing);\r\n\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t}\r\n\r\n\tonMeshZoomed(zoomed) {\r\n\t\t// console.log('ModelCurvedPanelComponent.zoomed', zoomed);\r\n\t\tthis.zoom.next({ itemId: this.item.id, zoomed });\r\n\t}\r\n\r\n\tonMeshCurrentTime(currentTime) {\r\n\t\t// console.log('ModelCurvedPanelComponent.playing', playing);\r\n\t\tthis.currentTime.next({ itemId: this.item.id, currentTime });\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onDestroy');\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.disposableMesh) {\r\n\t\t\tthis.removeMeshListeners(this.disposableMesh);\r\n\t\t\tthis.disposableMesh.dispose();\r\n\t\t}\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.removeMeshListeners(this.mesh);\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdate', item);\r\n\t\t// !!! true\r\n\t\tif (true && (item.radius !== this.radius_ || item.height !== this.height_ || item.arc !== this.arc_)) {\r\n\t\t\tmesh.geometry.dispose();\r\n\t\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\t\tmesh.geometry = geometry;\r\n\t\t}\r\n\t\tmesh.updateFromItem(item);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdateAsset', item);\r\n\t\tmesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tmesh.load(() => {\r\n\t\t\t\t// console.log('ModelCurvedPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position, normal, spherical) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onDragMove', position, normal, spherical);\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\titem.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\tif (spherical) {\r\n\t\t\tposition.normalize().multiplyScalar(20);\r\n\t\t\tmesh.lookAt(Host.origin);\r\n\t\t} else {\r\n\t\t\tmesh.position.set(0, 0, 0);\r\n\t\t\tmesh.lookAt(normal);\r\n\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\tmesh.position.add(normal.multiplyScalar(0.01));\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\titem.position = mesh.position.toArray();\r\n\t\titem.rotation = mesh.rotation.toArray();\r\n\t\titem.scale = mesh.scale.toArray();\r\n\t\tmesh.updateFromItem(item);\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tgetCurvedPanelGeometry(item) {\r\n\t\tthis.radius_ = item.radius;\r\n\t\tthis.height_ = item.height;\r\n\t\tthis.arc_ = item.arc;\r\n\t\tconst arc = Math.PI / 180 * item.arc;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(item.radius, item.radius, item.height, 36, 2, true, 0, arc);\r\n\t\tgeometry.rotateY(-Math.PI - arc / 2);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n}\r\n\r\nModelCurvedPlaneComponent.textures = {};\r\n\r\nModelCurvedPlaneComponent.meta = {\r\n\tselector: '[model-curved-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play', 'zoom', 'currentTime'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nexport const XRStatus = {\r\n\tWaiting: 'waiting',\r\n\tEnabled: 'enabled',\r\n\tEnded: 'ended',\r\n\tStarted: 'started',\r\n\tDisabled: 'disabled',\r\n\tNeedsHttps: 'needs-https',\r\n\tUnavailable: 'unavailable',\r\n};\r\n\r\nexport default class DebugService {\r\n\r\n\tstatic getService() {\r\n\t\tif (!this.service_) {\r\n\t\t\tthis.service_ = new DebugService();\r\n\t\t}\r\n\t\treturn this.service_;\r\n\t}\r\n\r\n\tget message() {\r\n\t\treturn this.message$.getValue();\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tif (DebugService.service_) {\r\n\t\t\tthrow ('DebugService is a singleton class!');\r\n\t\t}\r\n\t\tthis.message$ = new BehaviorSubject(null);\r\n\t}\r\n\r\n\tsetMessage(message) {\r\n\t\tif (this.message !== message) {\r\n\t\t\tthis.message$.next(message);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport DebugService from '../debug.service';\r\nimport { Host } from '../host/host';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelDebugComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelDebugComponent.loader || (ModelDebugComponent.loader = new THREE.FontLoader());\r\n\t}\r\n\r\n\tstatic getFontLoader(callback) {\r\n\t\treturn ModelDebugComponent.fontLoader || (ModelDebugComponent.fontLoader = ModelDebugComponent.getLoader().load(environment.getPath('fonts/helvetiker/helvetiker_regular.typeface.json'), callback));\r\n\t}\r\n\r\n\tget message() {\r\n\t\treturn this.message_;\r\n\t}\r\n\r\n\tset message(message) {\r\n\t\tmessage = message && message !== '' ? message : null;\r\n\t\tif (this.message_ !== message) {\r\n\t\t\tthis.message_ = message;\r\n\t\t\t// console.log('ModelDebugComponent.set.message', message);\r\n\t\t\tthis.setText(message);\r\n\t\t\t/*\r\n\t\t\tif (this.font) {\r\n\t\t\t\tthis.setText(message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelDebugComponent.onInit');\r\n\t\t// this.loadFont();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.textGroup.add(this.text);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.text.parent.remove(this.text);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tconst debugService = this.debugService = DebugService.getService();\r\n\t\tdebugService.message$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => this.message = message);\r\n\t}\r\n\r\n\tcreateText() {\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = ModelDebugComponent.W;\r\n\t\tcanvas.height = ModelDebugComponent.H;\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(4, 1, 2, 2);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\ttoneMapped: false,\r\n\t\t\t// blending: THREE.AdditiveBlending,\r\n\t\t\t// side: THREE.DoubleSide\r\n\t\t});\r\n\t\tconst text = new THREE.Mesh(geometry, material);\r\n\t\ttext.renderOrder = environment.renderOrder.debug;\r\n\t\ttext.position.y = 0;\r\n\t\treturn text;\r\n\t}\r\n\r\n\tloadFont() {\r\n\t\tthis.fontLoader = ModelDebugComponent.getFontLoader((font) => {\r\n\t\t\tthis.font = font;\r\n\t\t\tif (this.message_) {\r\n\t\t\t\tthis.setText(this.message_);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst textGroup = this.textGroup = new THREE.Group();\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\tside: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst text = this.text = this.createText();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(textGroup);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\t// camera.updateMatrixWorld(); // make sure the camera matrix is updated\r\n\t\t\t// camera.matrixWorldInverse.getInverse(camera.matrixWorld);\r\n\t\t}\r\n\t\tcamera.getWorldDirection(position);\r\n\t\t// console.log(position);\r\n\t\t// if (position.lengthSq() > 0.01) {\r\n\t\t// normalize so we can get a constant speed\r\n\t\t// position.normalize();\r\n\t\tposition.multiplyScalar(3);\r\n\t\t// move body, not the camera\r\n\t\t// VR.body.position.add(lookDirection);\r\n\t\t// console.log(position.x + '|' + position.y + '|' + position.z);\r\n\t\tgroup.position.copy(position);\r\n\t\tgroup.lookAt(Host.origin);\r\n\t\t// }\r\n\t}\r\n\r\n\tsetText(message) {\r\n\t\tconst text = this.text;\r\n\t\tif (text) {\r\n\t\t\tif (this.host.renderer.xr.isPresenting && message != null) {\r\n\t\t\t\t// draw\r\n\t\t\t\tconst ctx = text.material.map.image.getContext('2d');\r\n\t\t\t\tctx.clearRect(0, 0, ModelDebugComponent.W, ModelDebugComponent.H);\r\n\t\t\t\t// ctx.fillRect(0, 0, 10, 10);\r\n\t\t\t\t// ctx.fillRect(ModelDebugComponent.W - 10, ModelDebugComponent.H - 10, 10, 10);\r\n\t\t\t\tctx.font = `30px ${environment.fontFamily}`;\r\n\t\t\t\tctx.textBaseline = 'middle';\r\n\t\t\t\tctx.textAlign = 'center';\r\n\t\t\t\tctx.fillStyle = '#FFFFFF';\r\n\t\t\t\tctx.strokeStyle = '#000000';\r\n\t\t\t\tctx.lineWidth = 5;\r\n\t\t\t\tctx.fillText(message, ModelDebugComponent.W / 2, ModelDebugComponent.H / 2, ModelDebugComponent.W - 20);\r\n\t\t\t\ttext.material.map.needsUpdate = true;\r\n\t\t\t\t// draw\r\n\t\t\t\tthis.textGroup.add(text);\r\n\t\t\t} else if (text.parent) {\r\n\t\t\t\ttext.parent.remove(text);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nModelDebugComponent.W = 1024;\r\nModelDebugComponent.H = 256;\r\n\r\nModelDebugComponent.meta = {\r\n\tselector: '[model-debug]',\r\n\thosts: { host: WorldComponent },\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst VERTEX_SHADER = `\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\nvarying vec2 vUv;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform float opacity;\r\nuniform float tween;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = mix(colorA, colorB, tween);\r\n\tcolor.a = clamp(color.a * opacity, 0.0, 1.0);\r\n\tcolor.rgb /= color.a;\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class ModelGridComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelGridComponent.loader || (ModelGridComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexture() {\r\n\t\treturn ModelGridComponent.texture || (ModelGridComponent.texture = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav.png')));\r\n\t}\r\n\r\n\tstatic getOverTexture() {\r\n\t\treturn ModelGridComponent.textureOver || (ModelGridComponent.textureOver = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav-over.png')));\r\n\t}\r\n\r\n\tset coords(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst previousUniforms = previousTile.uniforms;\r\n\t\t\t\tgsap.to(previousUniforms, {\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.uniforms.tween.value = previousUniforms.tween;\r\n\t\t\t\t\t\tpreviousTile.material.needsUpdate = true;\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst currentUniforms = currentTile.uniforms;\r\n\t\t\t\tgsap.to(currentUniforms, {\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.uniforms.tween.value = currentUniforms.tween;\r\n\t\t\t\t\t\tcurrentTile.material.needsUpdate = true;\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tset coords__(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst from = { tween: 1 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// previousTile.material.needsUpdate = true;\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst from = { tween: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// currentTile.material.needsUpdate = true;\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tgetCoords(point) {\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst col = Math.ceil((point.x + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst row = Math.ceil((point.z + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\tconst ci = Math.min(dx, Math.abs(col)) * (col ? Math.abs(col) / col : 1);\r\n\t\tconst ri = Math.min(dy, Math.abs(row)) * (row ? Math.abs(row) / row : 1);\r\n\t\tif (this.view.hasTile(this.indices.x + ci, this.indices.y + ri)) {\r\n\t\t\t// console.log('col', col, 'row', row, 'ci', ci, 'ri', ri);\r\n\t\t\treturn new THREE.Vector2(ci, ri);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.indices = new THREE.Vector2();\r\n\t\t// console.log('ModelGridComponent.onInit', this.view);\r\n\t\tthis.view.index$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(index => {\r\n\t\t\tthis.moveToIndex(index);\r\n\t\t});\r\n\t}\r\n\r\n\taddTiles(mesh) {\r\n\t\t// console.log('addTiles');\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(innerTileSize, innerTileSize, 2, 2);\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\tconst map = ModelGridComponent.getTexture();\r\n\t\tmap.disposable = false;\r\n\t\tmap.encoding = THREE.sRGBEncoding;\r\n\t\tconst mapOver = ModelGridComponent.getOverTexture();\r\n\t\tmapOver.disposable = false;\r\n\t\tmapOver.encoding = THREE.sRGBEncoding;\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst tileMap = this.tileMap = {};\r\n\t\tconst tiles = this.tiles = new Array(ModelGridComponent.COLS * ModelGridComponent.ROWS).fill(0).map((x, i) => {\r\n\t\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\ttoneMapped: false,\r\n\t\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\t\tfragmentShader: FRAGMENT_SHADER,\r\n\t\t\t\tuniforms: {\r\n\t\t\t\t\ttextureA: { type: 't', value: map },\r\n\t\t\t\t\ttextureB: { type: 't', value: mapOver },\r\n\t\t\t\t\ttween: { value: 0 },\r\n\t\t\t\t\topacity: { value: 0 },\r\n\t\t\t\t},\r\n\t\t\t\textensions: {\r\n\t\t\t\t\tfragDepth: true,\r\n\t\t\t\t},\r\n\t\t\t\t// side: THREE.DoubleSide\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\tmap: map,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tconst tile = new THREE.Mesh(geometry, material);\r\n\t\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\t\tconst row = Math.floor(i / ModelGridComponent.COLS);\r\n\t\t\tconst col = i % ModelGridComponent.COLS;\r\n\t\t\tconst ci = -dx + col;\r\n\t\t\tconst ri = -dy + row;\r\n\t\t\t// console.log(ci, ri);\r\n\t\t\ttile.position.set(ci * outerTileSize, -ModelGridComponent.RADIUS * 0.15, ri * outerTileSize);\r\n\t\t\ttile.name = this.getName(`tile_${ci}_${ri}`);\r\n\t\t\tconst uniforms = tile.uniforms = {\r\n\t\t\t\ttween: 0,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tci: ci,\r\n\t\t\t\tri: ri,\r\n\t\t\t};\r\n\t\t\ttileMap[`${ci}_${ri}`] = tile;\r\n\t\t\tmesh.add(tile);\r\n\t\t\treturn tile;\r\n\t\t});\r\n\t\tthis.showTiles();\r\n\t}\r\n\r\n\tshowTiles() {\r\n\t\tthis.tiles.forEach((tile, i) => {\r\n\t\t\tconst ix = this.indices ? this.indices.x : 0;\r\n\t\t\tconst iy = this.indices ? this.indices.y : 0;\r\n\t\t\tconst visible = this.view.hasTile(ix + tile.uniforms.ci, iy + tile.uniforms.ri);\r\n\t\t\tconst uniforms = tile.uniforms;\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\topacity: visible ? 1 : 0,\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\t// delay: 0 + i * 0.02,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ttile.material.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\ttile.material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\taddHitArea(mesh) {\r\n\t\tthis.onGroundOver = this.onGroundOver.bind(this);\r\n\t\tthis.onGroundMove = this.onGroundMove.bind(this);\r\n\t\tthis.onGroundDown = this.onGroundDown.bind(this);\r\n\t\tthis.onGroundOut = this.onGroundOut.bind(this);\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(ModelGridComponent.RADIUS, ModelGridComponent.RADIUS, 8, 8); // 20, 20\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\ttoneMapped: false,\r\n\t\t\topacity: 0,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst ground = this.ground = new InteractiveMesh(geometry, material);\r\n\t\tground.name = this.getName('ground');\r\n\t\tground.position.set(0, -ModelGridComponent.RADIUS * 0.15, 0);\r\n\t\tground.on('over', this.onGroundOver);\r\n\t\tground.on('move', this.onGroundMove);\r\n\t\tground.on('out', this.onGroundOut);\r\n\t\tground.on('down', this.onGroundDown);\r\n\t\tmesh.add(ground);\r\n\t}\r\n\r\n\tonGroundOver() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundMove() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundDown() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t\tif (coords) {\r\n\t\t\tconst index = this.view.getTileIndex(this.indices.x + coords.x, this.indices.y + coords.y);\r\n\t\t\tthis.view.index = index;\r\n\t\t\tthis.nav.next(index);\r\n\t\t\t/*\r\n\t\t\tthis.indices.x += coords.x;\r\n\t\t\tthis.indices.y += coords.y;\r\n\t\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\t\tthis.move.next({\r\n\t\t\t\tindices: this.indices,\r\n\t\t\t\tcoords,\r\n\t\t\t\tposition: coords.clone().multiplyScalar(outerTileSize)\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonGroundOut() {\r\n\t\tthis.coords = null;\r\n\t}\r\n\r\n\tmoveToIndex(index) {\r\n\t\t// console.log('ModelGridComponent.moveToIndex', index);\r\n\t\tthis.coords = null;\r\n\t\tconst tile = this.view.tiles[index];\r\n\t\tconst coords = new THREE.Vector2(tile.indices.x - this.indices.x, tile.indices.y - this.indices.y);\r\n\t\tthis.indices.x = tile.indices.x;\r\n\t\tthis.indices.y = tile.indices.y;\r\n\t\tthis.showTiles();\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tthis.move.next({\r\n\t\t\tindices: this.indices,\r\n\t\t\tcoords,\r\n\t\t\tposition: coords.clone().multiplyScalar(outerTileSize),\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.tile;\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tthis.addTiles(mesh);\r\n\t\tthis.addHitArea(mesh);\r\n\t\t/*\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\r\n\t\t\t}\r\n\t\t};\r\n\t\t*/\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tconst ground = this.ground;\r\n\t\tground.off('over', this.onGroundOver);\r\n\t\tground.off('move', this.onGroundMove);\r\n\t\tground.off('down', this.onGroundDown);\r\n\t\tground.off('out', this.onGroundOut);\r\n\t}\r\n\r\n}\r\n\r\nModelGridComponent.RADIUS = 101;\r\nModelGridComponent.COLS = 11;\r\nModelGridComponent.ROWS = 11;\r\n\r\nModelGridComponent.meta = {\r\n\tselector: '[model-grid]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['move', 'nav'],\r\n\tinputs: ['view'],\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { of } from 'rxjs';\r\nimport { first, takeUntil, tap } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { MessageService } from '../../message/message.service';\r\nimport StateService from '../../state/state.service';\r\nimport { RoleType } from '../../user/user';\r\nimport { Host } from '../host/host';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport OrbitService, { OrbitMode } from '../orbit/orbit.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport class MenuButton extends InteractiveMesh {\r\n\r\n\tstatic getGrid(total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\treturn [rows, cols];\r\n\t}\r\n\r\n\tstatic getX(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst w = (1 / MenuButton.W * (MenuButton.W + MenuButton.G));\r\n\t\treturn (w / 2 - cols * w / 2) + c * w;\r\n\t}\r\n\r\n\tstatic getY(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst r = Math.floor(index / cols);\r\n\t\tconst h = (1 / MenuButton.W * (MenuButton.H + MenuButton.G));\r\n\t\treturn (rows * h / 2 - h / 2) + r * -h; // y flipped\r\n\t}\r\n\r\n\tstatic get geometry() {\r\n\t\tif (this.geometry_) {\r\n\t\t\treturn this.geometry_;\r\n\t\t}\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1, 1 / MenuButton.W * MenuButton.H, 2, 2);\r\n\t\tthis.geometry_ = geometry;\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tstatic get material() {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\ttoneMapped: false,\r\n\t\t\tvertexShader: ModelMenuComponent.VERTEX_SHADER,\r\n\t\t\tfragmentShader: ModelMenuComponent.FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\ttextureA: { type: 't', value: null },\r\n\t\t\t\ttextureB: { type: 't', value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\ttween: { value: 0 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t\textensions: {\r\n\t\t\t\tfragDepth: true,\r\n\t\t\t},\r\n\t\t});\r\n\t\t/*\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.8,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\t*/\r\n\t\treturn material;\r\n\t}\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tconst geometry = MenuButton.geometry;\r\n\t\tconst material = MenuButton.material;\r\n\t\tsuper(geometry, material);\r\n\t\t// this.userData.item = item;\r\n\t\t// this.userData.index = index;\r\n\t\tthis.renderOrder = environment.renderOrder.menu;\r\n\t\tthis.name = item.name;\r\n\t\tthis.item = item;\r\n\t\tthis.index = index;\r\n\t\tthis.total = total;\r\n\t\tthis.tween = 0;\r\n\t\tthis.opacity = 0;\r\n\t\tconst textureA = this.textureA = this.getTextureA(item.name);\r\n\t\t// material.map = textureA;\r\n\t\tmaterial.uniforms.textureA.value = textureA;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureA.width, textureA.height);\r\n\t\tconst textureB = this.textureB = this.getTextureB(item.name);\r\n\t\t// material.map = textureB;\r\n\t\tmaterial.uniforms.textureB.value = textureB;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureB.width, textureB.height);\r\n\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\tmaterial.uniforms.opacity.value = this.opacity;\r\n\t\tmaterial.needsUpdate = true;\r\n\t\tthis.position.set(MenuButton.getX(index, total), MenuButton.getY(index, total), 0);\r\n\t\tthis.onOver = this.onOver.bind(this);\r\n\t\tthis.onOut = this.onOut.bind(this);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.fillStyle = environment.colors.menuForeground;\r\n\t\tthis.writeText(ctx, text, w, h);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t// texture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.fillStyle = environment.colors.menuOverForeground;\r\n\t\tthis.writeText(ctx, text, w, h);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\t// texture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\twriteText(ctx, text, w, h) {\r\n\t\tthis.setFont(ctx);\r\n\t\tconst lineHeight = MenuButton.FONT_SIZE * MenuButton.LINE_HEIGHT;\r\n\t\tconst lines = this.getLines(ctx, text, w);\r\n\t\tconst lineCount = lines.length;\r\n\t\tthis.setFont(ctx, lineCount - 1);\r\n\t\tlines.forEach((line, i) => {\r\n\t\t\tctx.fillText(line, 10, (h - lineCount * lineHeight) * 0.5 + (0.5 + i) * lineHeight, w - 20);\r\n\t\t});\r\n\t}\r\n\r\n\tsetFont(ctx, diff = 0) {\r\n\t\tctx.textBaseline = 'middle';\r\n\t\tctx.font = `${MenuButton.FONT_SIZE - diff * 2}px ${environment.fontFamily}`;\r\n\t}\r\n\r\n\tgetLines(ctx, text, maxWidth) {\r\n\t\tconst words = text.split(' ');\r\n\t\tconst lines = [];\r\n\t\tlet currentLine = words[0];\r\n\t\tfor (let i = 1; i < words.length; i++) {\r\n\t\t\tconst word = words[i];\r\n\t\t\tconst width = ctx.measureText(currentLine + ' ' + word).width;\r\n\t\t\tif (width < maxWidth) {\r\n\t\t\t\tcurrentLine += ' ' + word;\r\n\t\t\t} else {\r\n\t\t\t\tlines.push(currentLine);\r\n\t\t\t\tcurrentLine = word;\r\n\t\t\t}\r\n\t\t}\r\n\t\tlines.push(currentLine);\r\n\t\treturn lines;\r\n\t}\r\n\r\n\tonOver() {\r\n\t\t// DebugService.getService().setMessage('over ' + this.name);\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 1,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 0,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tInteractive.dispose(this);\r\n\t\tthis.textureA.dispose();\r\n\t\tthis.textureB.dispose();\r\n\t\tthis.material.dispose();\r\n\t\tthis.geometry.dispose();\r\n\t}\r\n}\r\n\r\nMenuButton.FONT_SIZE = 19; // 20\r\nMenuButton.LINE_HEIGHT = 0.9;\r\nMenuButton.W = 256;\r\nMenuButton.H = 64;\r\nMenuButton.G = 2;\r\nMenuButton.ROWS = 6;\r\n\r\nexport class BackButton extends MenuButton {\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tsuper(item, index, total);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.fillStyle = environment.colors.menuBackForeground;\r\n\t\tctx.font = `${MenuButton.FONT_SIZE}px ${environment.fontFamily}`;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.fillStyle = environment.colors.menuBackOverForeground;\r\n\t\tctx.font = `${MenuButton.FONT_SIZE}px ${environment.fontFamily}`;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\t// texture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n}\r\n\r\nexport default class ModelMenuComponent extends ModelComponent {\r\n\r\n\tget controlled() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling !== StateService.state.uid);\r\n\t}\r\n\r\n\tget controlling() {\r\n\t\treturn (StateService.state.controlling && StateService.state.controlling === StateService.state.uid);\r\n\t}\r\n\r\n\tget silencing() {\r\n\t\treturn StateService.state.silencing;\r\n\t}\r\n\r\n\tget silenced() {\r\n\t\treturn (StateService.state.silencing && StateService.state.role === RoleType.Streamer);\r\n\t}\r\n\r\n\tget spyed() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying === StateService.state.uid);\r\n\t}\r\n\r\n\tget spying() {\r\n\t\treturn (StateService.state.spying && StateService.state.spying !== StateService.state.uid);\r\n\t}\r\n\r\n\tget locked() {\r\n\t\treturn this.controlled || this.spying;\r\n\t}\r\n\r\n\tget loading() {\r\n\t\treturn this.loading_;\r\n\t}\r\n\tset loading(loading) {\r\n\t\t// console.log('loading', loading);\r\n\t\tif (this.loading_ !== loading) {\r\n\t\t\tthis.loading_ = loading;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst btn = node.querySelector('.btn--menu');\r\n\t\t\tbtn.classList.toggle('loading', loading);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.onDown = this.onDown.bind(this);\r\n\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\t// console.log('ModelMenuComponent.onInit');\r\n\t\t/*\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeMenu();\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.progressIndicator = node.querySelector('.progress circle');\r\n\t\tLoaderService.progress$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(progress => {\r\n\t\t\tthis.loading = progress.count > 0;\r\n\t\t\tlet strokeDashoffset = 144.51;\r\n\t\t\tif (progress.count) {\r\n\t\t\t\tstrokeDashoffset = 144.51 * (1 - progress.value);\r\n\t\t\t}\r\n\t\t\tgsap.set(this.progressIndicator, {\r\n\t\t\t\t'strokeDashoffset': strokeDashoffset,\r\n\t\t\t});\r\n\t\t});\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => {\r\n\t\t\t// DebugService.getService().setMessage('ModelMenuComponent.MessageService ' + message.type);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.MenuToggle:\r\n\t\t\t\t\tthis.onToggle();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tbuildMenu() {\r\n\t\tif (!this.views) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.getModelMenu$(this.views, this.host.editor).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.groups = menu);\r\n\t}\r\n\t*/\r\n\r\n\tonDestroy() {\r\n\t\tif (this.buttons) {\r\n\t\t\tthis.buttons.forEach(x => Interactive.dispose(x));\r\n\t\t}\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.cameraGroup;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.menu;\r\n\t\tconst menuGroup = this.menuGroup = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(menuGroup);\r\n\t\t}\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tconst cameraGroup = this.host.cameraGroup;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tposition.y += 0.5;\r\n\t\t\tposition.multiplyScalar(3);\r\n\t\t\tthis.host.cameraGroup.worldToLocal(position);\r\n\t\t\tposition.y += this.host.cameraGroup.position.y;\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tgroup.scale.set(1, 1, 1);\r\n\t\t\tgroup.lookAt(Host.origin);\r\n\t\t} else {\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tif (OrbitService.mode === OrbitMode.Model) {\r\n\t\t\t\tposition.multiplyScalar(0.01);\r\n\t\t\t} else {\r\n\t\t\t\tposition.multiplyScalar(3);\r\n\t\t\t}\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tconst s = 1 / camera.zoom;\r\n\t\t\tgroup.scale.set(s, s, s);\r\n\t\t\tgroup.lookAt(Host.origin);\r\n\t\t}\r\n\t}\r\n\r\n\titems$(item = null) {\r\n\t\tif (item) {\r\n\t\t\treturn of(item.items);\r\n\t\t} else if (this.rootItems) {\r\n\t\t\treturn of(this.rootItems);\r\n\t\t} else {\r\n\t\t\treturn MenuService.getModelMenu$(this.views, this.host.editor).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t\ttap(items => {\r\n\t\t\t\t\tif (!this.host.editor) {\r\n\t\t\t\t\t\tthis.rootItems = items;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\taddMenu(item = null) {\r\n\t\tthis.removeMenu();\r\n\t\t// nav to view\r\n\t\tif (item && item.type.name !== 'menu-group') {\r\n\t\t\t/*\r\n\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.nav.next(item);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.active = true;\r\n\t\tthis.items$(item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(items => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems = items.slice();\r\n\t\t\t\tconst back = {\r\n\t\t\t\t\ttype: { name: 'back' },\r\n\t\t\t\t\tname: item ? 'Back' : 'Close',\r\n\t\t\t\t\tbackItem: item,\r\n\t\t\t\t};\r\n\t\t\t\titems.push(back);\r\n\t\t\t\tconst buttons = this.buttons = items.map((x, i, a) => {\r\n\t\t\t\t\tx.backItem = item;\r\n\t\t\t\t\treturn (x.type.name === 'back') ? new BackButton(x, i, a.length) : new MenuButton(x, i, a.length);\r\n\t\t\t\t});\r\n\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\tbutton.depthTest = false;\r\n\t\t\t\t\tbutton.on('over', button.onOver);\r\n\t\t\t\t\tbutton.on('out', button.onOut);\r\n\t\t\t\t\tbutton.on('down', this.onDown);\r\n\t\t\t\t\tthis.menuGroup.add(button);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tvar box = new THREE.BoxHelper(button, 0xffff00);\r\n\t\t\t\t\tthis.host.scene.add(box);\r\n\t\t\t\t\t*/\r\n\t\t\t\t});\r\n\t\t\t\tgsap.to(buttons, {\r\n\t\t\t\t\tduration: 0.3,\r\n\t\t\t\t\topacity: 0.8,\r\n\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\tstagger: {\r\n\t\t\t\t\t\tgrid: MenuButton.getGrid(buttons.length),\r\n\t\t\t\t\t\tfrom: 0, // index\r\n\t\t\t\t\t\tamount: 0.02 * buttons.length,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\t\t\tbutton.material.uniforms.opacity.value = (button.opacity * (button.item.hidden ? 0.5 : 1));\r\n\t\t\t\t\t\t\t// button.material.needsUpdate = true;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tremoveMenu() {\r\n\t\tMenuService.active = false;\r\n\t\tthis.removeButtons();\r\n\t\tthis.removeToggler();\r\n\t}\r\n\r\n\tremoveButtons() {\r\n\t\tconst buttons = this.buttons;\r\n\t\tif (buttons) {\r\n\t\t\tbuttons.forEach(button => {\r\n\t\t\t\tthis.menuGroup.remove(button);\r\n\t\t\t\tbutton.off('over', button.onOver);\r\n\t\t\t\tbutton.off('out', button.onOut);\r\n\t\t\t\tbutton.off('down', this.onDown);\r\n\t\t\t\tbutton.dispose();\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.buttons = null;\r\n\t}\r\n\r\n\taddToggler() {\r\n\t\tthis.removeMenu();\r\n\t\tconst toggler = this.toggler = new MenuButton({\r\n\t\t\ttype: { name: 'menu' },\r\n\t\t\tname: 'Menu',\r\n\t\t}, 0, 1);\r\n\t\t// toggler.position.y = -0.5;\r\n\t\ttoggler.opacity = 0.8;\r\n\t\ttoggler.material.uniforms.opacity.value = toggler.opacity;\r\n\t\ttoggler.material.needsUpdate = true;\r\n\t\ttoggler.on('over', toggler.onOver);\r\n\t\ttoggler.on('out', toggler.onOut);\r\n\t\ttoggler.on('down', this.onToggle);\r\n\t\tthis.menuGroup.add(toggler);\r\n\t}\r\n\r\n\tremoveToggler() {\r\n\t\tconst toggler = this.toggler;\r\n\t\tif (toggler) {\r\n\t\t\tthis.menuGroup.remove(toggler);\r\n\t\t\ttoggler.off('over', toggler.onOver);\r\n\t\t\ttoggler.off('out', toggler.onOut);\r\n\t\t\ttoggler.off('down', this.onToggle);\r\n\t\t\ttoggler.dispose();\r\n\t\t}\r\n\t\tthis.toggler = null;\r\n\t}\r\n\r\n\tonDown(button) {\r\n\t\t// this.down.next(this.item);\r\n\t\tif (button.item && button.item.type.name === 'back') {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tif (button.item.backItem) {\r\n\t\t\t\tthis.addMenu(button.item.backItem.backItem);\r\n\t\t\t} else {\r\n\t\t\t\t/*\r\n\t\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\t\tthis.addToggler();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tthis.toggle.next();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.addMenu(button.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle(event) {\r\n\t\tif (event) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopImmediatePropagation();\r\n\t\t}\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (MenuService.active) {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tthis.toggle.next();\r\n\t\t} else {\r\n\t\t\tthis.addMenu();\r\n\t\t\tthis.toggle.next(this);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelMenuComponent.VERTEX_SHADER = `\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\nModelMenuComponent.FRAGMENT_SHADER = `\r\nvarying vec2 vUv;\r\nuniform float opacity;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = vec4(mix(colorA.rgb, colorB.rgb, tween), opacity);\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nModelMenuComponent.meta = {\r\n\tselector: '[model-menu]',\r\n\thosts: { host: WorldComponent },\r\n\t// outputs: ['over', 'out', 'down', 'nav'],\r\n\toutputs: ['nav', 'toggle'],\r\n\tinputs: ['views'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"btn--menu\" (mousedown)=\"onToggle($event)\">\r\n\t\t<svg class=\"menu-light\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#menu-light\"></use></svg>\r\n\t\t<div class=\"btn--menu__spinner\"></div>\r\n\t\t<svg class=\"bullets\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#menu\"></use></svg>\r\n\t\t<svg class=\"progress\" width=\"50\" height=\"50\" viewBox=\"0 0 50 50\">\r\n\t\t\t<circle id=\"circle\" r=\"23\" cx=\"25\" cy=\"25\" fill=\"transparent\"></circle>\r\n\t\t</svg>\r\n\t</div>\r\n\t`,\r\n};\r\n","import {\n\tBufferAttribute,\n\tBufferGeometry,\n\tFileLoader,\n\tLoader\n} from 'three';\n\nconst _taskCache = new WeakMap();\n\nclass DRACOLoader extends Loader {\n\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t\tthis.decoderPath = '';\n\t\tthis.decoderConfig = {};\n\t\tthis.decoderBinary = null;\n\t\tthis.decoderPending = null;\n\n\t\tthis.workerLimit = 4;\n\t\tthis.workerPool = [];\n\t\tthis.workerNextTaskID = 1;\n\t\tthis.workerSourceURL = '';\n\n\t\tthis.defaultAttributeIDs = {\n\t\t\tposition: 'POSITION',\n\t\t\tnormal: 'NORMAL',\n\t\t\tcolor: 'COLOR',\n\t\t\tuv: 'TEX_COORD'\n\t\t};\n\t\tthis.defaultAttributeTypes = {\n\t\t\tposition: 'Float32Array',\n\t\t\tnormal: 'Float32Array',\n\t\t\tcolor: 'Float32Array',\n\t\t\tuv: 'Float32Array'\n\t\t};\n\n\t}\n\n\tsetDecoderPath( path ) {\n\n\t\tthis.decoderPath = path;\n\n\t\treturn this;\n\n\t}\n\n\tsetDecoderConfig( config ) {\n\n\t\tthis.decoderConfig = config;\n\n\t\treturn this;\n\n\t}\n\n\tsetWorkerLimit( workerLimit ) {\n\n\t\tthis.workerLimit = workerLimit;\n\n\t\treturn this;\n\n\t}\n\n\tload( url, onLoad, onProgress, onError ) {\n\n\t\tconst loader = new FileLoader( this.manager );\n\n\t\tloader.setPath( this.path );\n\t\tloader.setResponseType( 'arraybuffer' );\n\t\tloader.setRequestHeader( this.requestHeader );\n\t\tloader.setWithCredentials( this.withCredentials );\n\n\t\tloader.load( url, ( buffer ) => {\n\n\t\t\tconst taskConfig = {\n\t\t\t\tattributeIDs: this.defaultAttributeIDs,\n\t\t\t\tattributeTypes: this.defaultAttributeTypes,\n\t\t\t\tuseUniqueIDs: false\n\t\t\t};\n\n\t\t\tthis.decodeGeometry( buffer, taskConfig )\n\t\t\t\t.then( onLoad )\n\t\t\t\t.catch( onError );\n\n\t\t}, onProgress, onError );\n\n\t}\n\n\t/** @deprecated Kept for backward-compatibility with previous DRACOLoader versions. */\n\tdecodeDracoFile( buffer, callback, attributeIDs, attributeTypes ) {\n\n\t\tconst taskConfig = {\n\t\t\tattributeIDs: attributeIDs || this.defaultAttributeIDs,\n\t\t\tattributeTypes: attributeTypes || this.defaultAttributeTypes,\n\t\t\tuseUniqueIDs: !! attributeIDs\n\t\t};\n\n\t\tthis.decodeGeometry( buffer, taskConfig ).then( callback );\n\n\t}\n\n\tdecodeGeometry( buffer, taskConfig ) {\n\n\t\t// TODO: For backward-compatibility, support 'attributeTypes' objects containing\n\t\t// references (rather than names) to typed array constructors. These must be\n\t\t// serialized before sending them to the worker.\n\t\tfor ( const attribute in taskConfig.attributeTypes ) {\n\n\t\t\tconst type = taskConfig.attributeTypes[ attribute ];\n\n\t\t\tif ( type.BYTES_PER_ELEMENT !== undefined ) {\n\n\t\t\t\ttaskConfig.attributeTypes[ attribute ] = type.name;\n\n\t\t\t}\n\n\t\t}\n\n\t\t//\n\n\t\tconst taskKey = JSON.stringify( taskConfig );\n\n\t\t// Check for an existing task using this buffer. A transferred buffer cannot be transferred\n\t\t// again from this thread.\n\t\tif ( _taskCache.has( buffer ) ) {\n\n\t\t\tconst cachedTask = _taskCache.get( buffer );\n\n\t\t\tif ( cachedTask.key === taskKey ) {\n\n\t\t\t\treturn cachedTask.promise;\n\n\t\t\t} else if ( buffer.byteLength === 0 ) {\n\n\t\t\t\t// Technically, it would be possible to wait for the previous task to complete,\n\t\t\t\t// transfer the buffer back, and decode again with the second configuration. That\n\t\t\t\t// is complex, and I don't know of any reason to decode a Draco buffer twice in\n\t\t\t\t// different ways, so this is left unimplemented.\n\t\t\t\tthrow new Error(\n\n\t\t\t\t\t'THREE.DRACOLoader: Unable to re-decode a buffer with different ' +\n\t\t\t\t\t'settings. Buffer has already been transferred.'\n\n\t\t\t\t);\n\n\t\t\t}\n\n\t\t}\n\n\t\t//\n\n\t\tlet worker;\n\t\tconst taskID = this.workerNextTaskID ++;\n\t\tconst taskCost = buffer.byteLength;\n\n\t\t// Obtain a worker and assign a task, and construct a geometry instance\n\t\t// when the task completes.\n\t\tconst geometryPending = this._getWorker( taskID, taskCost )\n\t\t\t.then( ( _worker ) => {\n\n\t\t\t\tworker = _worker;\n\n\t\t\t\treturn new Promise( ( resolve, reject ) => {\n\n\t\t\t\t\tworker._callbacks[ taskID ] = { resolve, reject };\n\n\t\t\t\t\tworker.postMessage( { type: 'decode', id: taskID, taskConfig, buffer }, [ buffer ] );\n\n\t\t\t\t\t// this.debug();\n\n\t\t\t\t} );\n\n\t\t\t} )\n\t\t\t.then( ( message ) => this._createGeometry( message.geometry ) );\n\n\t\t// Remove task from the task list.\n\t\t// Note: replaced '.finally()' with '.catch().then()' block - iOS 11 support (#19416)\n\t\tgeometryPending\n\t\t\t.catch( () => true )\n\t\t\t.then( () => {\n\n\t\t\t\tif ( worker && taskID ) {\n\n\t\t\t\t\tthis._releaseTask( worker, taskID );\n\n\t\t\t\t\t// this.debug();\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t// Cache the task result.\n\t\t_taskCache.set( buffer, {\n\n\t\t\tkey: taskKey,\n\t\t\tpromise: geometryPending\n\n\t\t} );\n\n\t\treturn geometryPending;\n\n\t}\n\n\t_createGeometry( geometryData ) {\n\n\t\tconst geometry = new BufferGeometry();\n\n\t\tif ( geometryData.index ) {\n\n\t\t\tgeometry.setIndex( new BufferAttribute( geometryData.index.array, 1 ) );\n\n\t\t}\n\n\t\tfor ( let i = 0; i < geometryData.attributes.length; i ++ ) {\n\n\t\t\tconst attribute = geometryData.attributes[ i ];\n\t\t\tconst name = attribute.name;\n\t\t\tconst array = attribute.array;\n\t\t\tconst itemSize = attribute.itemSize;\n\n\t\t\tgeometry.setAttribute( name, new BufferAttribute( array, itemSize ) );\n\n\t\t}\n\n\t\treturn geometry;\n\n\t}\n\n\t_loadLibrary( url, responseType ) {\n\n\t\tconst loader = new FileLoader( this.manager );\n\t\tloader.setPath( this.decoderPath );\n\t\tloader.setResponseType( responseType );\n\t\tloader.setWithCredentials( this.withCredentials );\n\n\t\treturn new Promise( ( resolve, reject ) => {\n\n\t\t\tloader.load( url, resolve, undefined, reject );\n\n\t\t} );\n\n\t}\n\n\tpreload() {\n\n\t\tthis._initDecoder();\n\n\t\treturn this;\n\n\t}\n\n\t_initDecoder() {\n\n\t\tif ( this.decoderPending ) return this.decoderPending;\n\n\t\tconst useJS = typeof WebAssembly !== 'object' || this.decoderConfig.type === 'js';\n\t\tconst librariesPending = [];\n\n\t\tif ( useJS ) {\n\n\t\t\tlibrariesPending.push( this._loadLibrary( 'draco_decoder.js', 'text' ) );\n\n\t\t} else {\n\n\t\t\tlibrariesPending.push( this._loadLibrary( 'draco_wasm_wrapper.js', 'text' ) );\n\t\t\tlibrariesPending.push( this._loadLibrary( 'draco_decoder.wasm', 'arraybuffer' ) );\n\n\t\t}\n\n\t\tthis.decoderPending = Promise.all( librariesPending )\n\t\t\t.then( ( libraries ) => {\n\n\t\t\t\tconst jsContent = libraries[ 0 ];\n\n\t\t\t\tif ( ! useJS ) {\n\n\t\t\t\t\tthis.decoderConfig.wasmBinary = libraries[ 1 ];\n\n\t\t\t\t}\n\n\t\t\t\tconst fn = DRACOWorker.toString();\n\n\t\t\t\tconst body = [\n\t\t\t\t\t'/* draco decoder */',\n\t\t\t\t\tjsContent,\n\t\t\t\t\t'',\n\t\t\t\t\t'/* worker */',\n\t\t\t\t\tfn.substring( fn.indexOf( '{' ) + 1, fn.lastIndexOf( '}' ) )\n\t\t\t\t].join( '\\n' );\n\n\t\t\t\tthis.workerSourceURL = URL.createObjectURL( new Blob( [ body ] ) );\n\n\t\t\t} );\n\n\t\treturn this.decoderPending;\n\n\t}\n\n\t_getWorker( taskID, taskCost ) {\n\n\t\treturn this._initDecoder().then( () => {\n\n\t\t\tif ( this.workerPool.length < this.workerLimit ) {\n\n\t\t\t\tconst worker = new Worker( this.workerSourceURL );\n\n\t\t\t\tworker._callbacks = {};\n\t\t\t\tworker._taskCosts = {};\n\t\t\t\tworker._taskLoad = 0;\n\n\t\t\t\tworker.postMessage( { type: 'init', decoderConfig: this.decoderConfig } );\n\n\t\t\t\tworker.onmessage = function ( e ) {\n\n\t\t\t\t\tconst message = e.data;\n\n\t\t\t\t\tswitch ( message.type ) {\n\n\t\t\t\t\t\tcase 'decode':\n\t\t\t\t\t\t\tworker._callbacks[ message.id ].resolve( message );\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'error':\n\t\t\t\t\t\t\tworker._callbacks[ message.id ].reject( message );\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tconsole.error( 'THREE.DRACOLoader: Unexpected message, \"' + message.type + '\"' );\n\n\t\t\t\t\t}\n\n\t\t\t\t};\n\n\t\t\t\tthis.workerPool.push( worker );\n\n\t\t\t} else {\n\n\t\t\t\tthis.workerPool.sort( function ( a, b ) {\n\n\t\t\t\t\treturn a._taskLoad > b._taskLoad ? - 1 : 1;\n\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\tconst worker = this.workerPool[ this.workerPool.length - 1 ];\n\t\t\tworker._taskCosts[ taskID ] = taskCost;\n\t\t\tworker._taskLoad += taskCost;\n\t\t\treturn worker;\n\n\t\t} );\n\n\t}\n\n\t_releaseTask( worker, taskID ) {\n\n\t\tworker._taskLoad -= worker._taskCosts[ taskID ];\n\t\tdelete worker._callbacks[ taskID ];\n\t\tdelete worker._taskCosts[ taskID ];\n\n\t}\n\n\tdebug() {\n\n\t\tconsole.log( 'Task load: ', this.workerPool.map( ( worker ) => worker._taskLoad ) );\n\n\t}\n\n\tdispose() {\n\n\t\tfor ( let i = 0; i < this.workerPool.length; ++ i ) {\n\n\t\t\tthis.workerPool[ i ].terminate();\n\n\t\t}\n\n\t\tthis.workerPool.length = 0;\n\n\t\treturn this;\n\n\t}\n\n}\n\n/* WEB WORKER */\n\nfunction DRACOWorker() {\n\n\tlet decoderConfig;\n\tlet decoderPending;\n\n\tonmessage = function ( e ) {\n\n\t\tconst message = e.data;\n\n\t\tswitch ( message.type ) {\n\n\t\t\tcase 'init':\n\t\t\t\tdecoderConfig = message.decoderConfig;\n\t\t\t\tdecoderPending = new Promise( function ( resolve/*, reject*/ ) {\n\n\t\t\t\t\tdecoderConfig.onModuleLoaded = function ( draco ) {\n\n\t\t\t\t\t\t// Module is Promise-like. Wrap before resolving to avoid loop.\n\t\t\t\t\t\tresolve( { draco: draco } );\n\n\t\t\t\t\t};\n\n\t\t\t\t\tDracoDecoderModule( decoderConfig ); // eslint-disable-line no-undef\n\n\t\t\t\t} );\n\t\t\t\tbreak;\n\n\t\t\tcase 'decode':\n\t\t\t\tconst buffer = message.buffer;\n\t\t\t\tconst taskConfig = message.taskConfig;\n\t\t\t\tdecoderPending.then( ( module ) => {\n\n\t\t\t\t\tconst draco = module.draco;\n\t\t\t\t\tconst decoder = new draco.Decoder();\n\t\t\t\t\tconst decoderBuffer = new draco.DecoderBuffer();\n\t\t\t\t\tdecoderBuffer.Init( new Int8Array( buffer ), buffer.byteLength );\n\n\t\t\t\t\ttry {\n\n\t\t\t\t\t\tconst geometry = decodeGeometry( draco, decoder, decoderBuffer, taskConfig );\n\n\t\t\t\t\t\tconst buffers = geometry.attributes.map( ( attr ) => attr.array.buffer );\n\n\t\t\t\t\t\tif ( geometry.index ) buffers.push( geometry.index.array.buffer );\n\n\t\t\t\t\t\tself.postMessage( { type: 'decode', id: message.id, geometry }, buffers );\n\n\t\t\t\t\t} catch ( error ) {\n\n\t\t\t\t\t\tconsole.error( error );\n\n\t\t\t\t\t\tself.postMessage( { type: 'error', id: message.id, error: error.message } );\n\n\t\t\t\t\t} finally {\n\n\t\t\t\t\t\tdraco.destroy( decoderBuffer );\n\t\t\t\t\t\tdraco.destroy( decoder );\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\t\t\t\tbreak;\n\n\t\t}\n\n\t};\n\n\tfunction decodeGeometry( draco, decoder, decoderBuffer, taskConfig ) {\n\n\t\tconst attributeIDs = taskConfig.attributeIDs;\n\t\tconst attributeTypes = taskConfig.attributeTypes;\n\n\t\tlet dracoGeometry;\n\t\tlet decodingStatus;\n\n\t\tconst geometryType = decoder.GetEncodedGeometryType( decoderBuffer );\n\n\t\tif ( geometryType === draco.TRIANGULAR_MESH ) {\n\n\t\t\tdracoGeometry = new draco.Mesh();\n\t\t\tdecodingStatus = decoder.DecodeBufferToMesh( decoderBuffer, dracoGeometry );\n\n\t\t} else if ( geometryType === draco.POINT_CLOUD ) {\n\n\t\t\tdracoGeometry = new draco.PointCloud();\n\t\t\tdecodingStatus = decoder.DecodeBufferToPointCloud( decoderBuffer, dracoGeometry );\n\n\t\t} else {\n\n\t\t\tthrow new Error( 'THREE.DRACOLoader: Unexpected geometry type.' );\n\n\t\t}\n\n\t\tif ( ! decodingStatus.ok() || dracoGeometry.ptr === 0 ) {\n\n\t\t\tthrow new Error( 'THREE.DRACOLoader: Decoding failed: ' + decodingStatus.error_msg() );\n\n\t\t}\n\n\t\tconst geometry = { index: null, attributes: [] };\n\n\t\t// Gather all vertex attributes.\n\t\tfor ( const attributeName in attributeIDs ) {\n\n\t\t\tconst attributeType = self[ attributeTypes[ attributeName ] ];\n\n\t\t\tlet attribute;\n\t\t\tlet attributeID;\n\n\t\t\t// A Draco file may be created with default vertex attributes, whose attribute IDs\n\t\t\t// are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,\n\t\t\t// a Draco file may contain a custom set of attributes, identified by known unique\n\t\t\t// IDs. glTF files always do the latter, and `.drc` files typically do the former.\n\t\t\tif ( taskConfig.useUniqueIDs ) {\n\n\t\t\t\tattributeID = attributeIDs[ attributeName ];\n\t\t\t\tattribute = decoder.GetAttributeByUniqueId( dracoGeometry, attributeID );\n\n\t\t\t} else {\n\n\t\t\t\tattributeID = decoder.GetAttributeId( dracoGeometry, draco[ attributeIDs[ attributeName ] ] );\n\n\t\t\t\tif ( attributeID === - 1 ) continue;\n\n\t\t\t\tattribute = decoder.GetAttribute( dracoGeometry, attributeID );\n\n\t\t\t}\n\n\t\t\tgeometry.attributes.push( decodeAttribute( draco, decoder, dracoGeometry, attributeName, attributeType, attribute ) );\n\n\t\t}\n\n\t\t// Add index.\n\t\tif ( geometryType === draco.TRIANGULAR_MESH ) {\n\n\t\t\tgeometry.index = decodeIndex( draco, decoder, dracoGeometry );\n\n\t\t}\n\n\t\tdraco.destroy( dracoGeometry );\n\n\t\treturn geometry;\n\n\t}\n\n\tfunction decodeIndex( draco, decoder, dracoGeometry ) {\n\n\t\tconst numFaces = dracoGeometry.num_faces();\n\t\tconst numIndices = numFaces * 3;\n\t\tconst byteLength = numIndices * 4;\n\n\t\tconst ptr = draco._malloc( byteLength );\n\t\tdecoder.GetTrianglesUInt32Array( dracoGeometry, byteLength, ptr );\n\t\tconst index = new Uint32Array( draco.HEAPF32.buffer, ptr, numIndices ).slice();\n\t\tdraco._free( ptr );\n\n\t\treturn { array: index, itemSize: 1 };\n\n\t}\n\n\tfunction decodeAttribute( draco, decoder, dracoGeometry, attributeName, attributeType, attribute ) {\n\n\t\tconst numComponents = attribute.num_components();\n\t\tconst numPoints = dracoGeometry.num_points();\n\t\tconst numValues = numPoints * numComponents;\n\t\tconst byteLength = numValues * attributeType.BYTES_PER_ELEMENT;\n\t\tconst dataType = getDracoDataType( draco, attributeType );\n\n\t\tconst ptr = draco._malloc( byteLength );\n\t\tdecoder.GetAttributeDataArrayForAllPoints( dracoGeometry, attribute, dataType, byteLength, ptr );\n\t\tconst array = new attributeType( draco.HEAPF32.buffer, ptr, numValues ).slice();\n\t\tdraco._free( ptr );\n\n\t\treturn {\n\t\t\tname: attributeName,\n\t\t\tarray: array,\n\t\t\titemSize: numComponents\n\t\t};\n\n\t}\n\n\tfunction getDracoDataType( draco, attributeType ) {\n\n\t\tswitch ( attributeType ) {\n\n\t\t\tcase Float32Array: return draco.DT_FLOAT32;\n\t\t\tcase Int8Array: return draco.DT_INT8;\n\t\t\tcase Int16Array: return draco.DT_INT16;\n\t\t\tcase Int32Array: return draco.DT_INT32;\n\t\t\tcase Uint8Array: return draco.DT_UINT8;\n\t\t\tcase Uint16Array: return draco.DT_UINT16;\n\t\t\tcase Uint32Array: return draco.DT_UINT32;\n\n\t\t}\n\n\t}\n\n}\n\nexport { DRACOLoader };\n","import { takeUntil } from 'rxjs/operators';\r\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\r\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport EmittableMesh from '../interactive/emittable.mesh';\r\nimport FreezableMesh from '../interactive/freezable.mesh';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelModelComponent extends ModelEditableComponent {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\tset freezed(freezed) {\r\n\t\tif (this.freezed_ !== freezed) {\r\n\t\t\tthis.freezed_ = freezed;\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tif (mesh) {\r\n\t\t\t\tmesh.traverse((child) => {\r\n\t\t\t\t\tif (child.isInteractiveMesh) {\r\n\t\t\t\t\t\tchild.freezed = freezed;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.isPresenting = false;\r\n\t\tMenuService.active$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(active => this.freezed = active);\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tthis.loadGlb(environment.getPath(this.item.asset.folder), this.item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, mount, dismount);\r\n\t\t});\r\n\t}\r\n\r\n\tloadGlb(path, file, callback) {\r\n\t\tconst renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('progressRef');\r\n\t\tconst loader = new GLTFLoader().setPath(path);\r\n\t\t// Optional: Provide a DRACOLoader instance to decode compressed mesh data\r\n\t\tconst decoderPath = `${environment.dist}js/draco/`;\r\n\t\t// console.log(decoderPath);\r\n\t\tconst dracoLoader = new DRACOLoader();\r\n\t\tdracoLoader.setDecoderPath(decoderPath);\r\n\t\tloader.setDRACOLoader(dracoLoader);\r\n\t\tloader.load(file, (glb) => {\r\n\t\t\t/*\r\n\t\t\tglb.scene.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(glb.scene, glb.animations);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\tLoaderService.setProgress(progressRef, progressEvent.loaded, progressEvent.total);\r\n\t\t});\r\n\t}\r\n\r\n\tonGlbLoaded(mesh, animations, mount, dismount) {\r\n\t\t// animations\r\n\t\tthis.parseAnimations(mesh, animations);\r\n\t\t// scale\r\n\t\tconst box = new THREE.Box3().setFromObject(mesh);\r\n\t\tconst size = box.max.clone().sub(box.min);\r\n\t\tconst max = Math.max(size.x, size.y, size.z);\r\n\t\tconst scale = 1.7 / max;\r\n\t\tmesh.scale.set(scale, scale, scale);\r\n\t\t// repos\r\n\t\tlet dummy;\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t// this.onUpdateVRSession(this.vrService.currentSession);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tbox.setFromObject(dummy);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tdummy.position.set(\r\n\t\t\t\tmesh.position.x - center.x,\r\n\t\t\t\tmesh.position.y - center.y,\r\n\t\t\t\tmesh.position.z - center.z + (this.host.renderer.xr.isPresenting ? -2 : 0),\r\n\t\t\t\t// mesh.position.z - center.z,\r\n\t\t\t);\r\n\t\t\tconst endY = dummy.position.y;\r\n\t\t\tconst from = { tween: 1 };\r\n\t\t\tconst onUpdate = () => {\r\n\t\t\t\tdummy.position.y = endY + 3 * from.tween;\r\n\t\t\t\tdummy.rotation.y = 0 + Math.PI * from.tween;\r\n\t\t\t};\r\n\t\t\tonUpdate();\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 1.5,\r\n\t\t\t\ttween: 0,\r\n\t\t\t\tdelay: 0.1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: onUpdate,\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tthis.updateHelper();\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tbox.setFromObject(mesh);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tmesh.position.set(\r\n\t\t\t\t- center.x,\r\n\t\t\t\t- center.y,\r\n\t\t\t\t- center.z,\r\n\t\t\t);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tif (item.position) {\r\n\t\t\t\tdummy.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tdummy.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tdummy.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\t/*\r\n\t\t\tconst geometry = ModelModelComponent.getInteractiveGeometry();\r\n\t\t\tconst sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\t// wireframe: true,\r\n\t\t\t\t// opacity: 1.0,\r\n\t\t\t\topacity: 0.0,\r\n\t\t\t\tcolor: 0x00ffff,\r\n\t\t\t}));\r\n\t\t\tconst radius = max * scale / 1.7;\r\n\t\t\tsphere.scale.set(radius, radius, radius);\r\n\t\t\tsphere.name = `[model] ${this.item.id}`;\r\n\t\t\t// sphere.depthTest = false;\r\n\t\t\tsphere.renderOrder = 0;\r\n\t\t\tdummy.add(sphere);\r\n\t\t\tsphere.on('down', () => {\r\n\t\t\t\t// console.log('ModelModelComponent.down');\r\n\t\t\t\tthis.down.next(this);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.updateHelper();\r\n\t\t}\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(dummy, this.item);\r\n\t\t\tthis.freezed = MenuService.active;\r\n\t\t}\r\n\t}\r\n\r\n\tparseAnimations(mesh, animations) {\r\n\t\t// animations\r\n\t\t// console.log('ModelModelComponent.onGlbLoaded', 'animations', animations);\r\n\t\tconst actionIndex = this.actionIndex = -1;\r\n\t\tconst actions = this.actions = [];\r\n\t\tif (animations && animations.length) {\r\n\t\t\tconst clock = this.clock = new THREE.Clock();\r\n\t\t\tconst mixer = this.mixer = new THREE.AnimationMixer(mesh);\r\n\t\t\tmixer.timeScale = 1;\r\n\t\t\tanimations.forEach(animation => {\r\n\t\t\t\tconst action = mixer.clipAction(animation);\r\n\t\t\t\taction.enabled = true;\r\n\t\t\t\taction.setEffectiveTimeScale(1);\r\n\t\t\t\taction.setEffectiveWeight(1);\r\n\t\t\t\t// action.setLoop(THREE.LoopPingPong);\r\n\t\t\t\taction.setLoop(THREE.LoopRepeat);\r\n\t\t\t\t// action.clampWhenFinished = true; // pause on last frame\r\n\t\t\t\tactions.push(action);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonClipToggle() {\r\n\t\tlet actionIndex;\r\n\t\tconst actions = this.actions;\r\n\t\tif (actions.length === 1) {\r\n\t\t\tactionIndex = this.actionIndex === -1 ? 0 : -1;\r\n\t\t\tthis.setSingleAction(actionIndex);\r\n\t\t} else if (actions.length > 1) {\r\n\t\t\tactionIndex = this.actionIndex + 1;\r\n\t\t\tif (actionIndex === actions.length) {\r\n\t\t\t\tactionIndex = -1;\r\n\t\t\t}\r\n\t\t\tthis.setMultiAction(actionIndex);\r\n\t\t}\r\n\t\tthis.play.next({ itemId: this.item.id, actionIndex });\r\n\t}\r\n\r\n\tsetSingleAction(actionIndex) {\r\n\t\tif (this.actionIndex !== actionIndex) {\r\n\t\t\tthis.actionIndex = actionIndex;\r\n\t\t\tconst action = this.actions[0];\r\n\t\t\tif (actionIndex === 0) {\r\n\t\t\t\tif (action.paused || action.timeScale === 0) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\taction.play();\r\n\t\t\t\t}\r\n\t\t\t} else if (actionIndex === -1) {\r\n\t\t\t\taction.halt(0.3);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tsetMultiAction(actionIndex) {\r\n\t\tif (this.actionIndex !== actionIndex) {\r\n\t\t\tconst actions = this.actions;\r\n\t\t\tconst previousClip = this.actionIndex > -1 ? actions[this.actionIndex] : null;\r\n\t\t\tthis.actionIndex = actionIndex;\r\n\t\t\tif (previousClip) {\r\n\t\t\t\tpreviousClip.halt(0.3);\r\n\t\t\t}\r\n\t\t\t// console.log('setMultiAction', actionIndex, actions.length);\r\n\t\t\tif (actionIndex > -1) {\r\n\t\t\t\tconst action = actions[actionIndex];\r\n\t\t\t\tif (action.paused) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (action.timeScale === 0) {\r\n\t\t\t\t\taction.timeScale = 1;\r\n\t\t\t\t}\r\n\t\t\t\taction.play();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonMessage(message) {\r\n\t\tswitch (message.type) {\r\n\t\t\tcase MessageType.PlayModel: {\r\n\t\t\t\tconst actions = this.actions;\r\n\t\t\t\tif (actions.length === 1) {\r\n\t\t\t\t\tthis.setSingleAction(message.actionIndex);\r\n\t\t\t\t} else if (actions.length > 1) {\r\n\t\t\t\t\tthis.setMultiAction(message.actionIndex);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\tconst isPresenting = this.host.renderer.xr.isPresenting;\r\n\t\tconst group = this.group;\r\n\t\tif (mesh) {\r\n\t\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t\tif (this.isPresenting !== isPresenting) {\r\n\t\t\t\t\tthis.isPresenting = isPresenting;\r\n\t\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = -2;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = 0;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst mixer = this.mixer;\r\n\t\tconst clock = this.clock;\r\n\t\tif (mixer) {\r\n\t\t\tconst delta = clock.getDelta();\r\n\t\t\tmixer.update(delta);\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdate', item);\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tif (item.position) {\r\n\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdateAsset', item);\r\n\t\tthis.loadGlb(environment.getPath(item.asset.folder), item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, (mesh, item) => this.onMount(mesh, item), (mesh, item) => this.onDismount(mesh, item));\r\n\t\t});\r\n\t\t/*\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tthis.mesh.load(() => {\r\n\t\t\t// console.log('ModelModelComponent.mesh.load.complete');\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position, normal, spherical) {\r\n\t\t// console.log('ModelModelComponent.onDragMove', position, normal, spherical);\r\n\t\tif (spherical) {\r\n\t\t\tposition.normalize().multiplyScalar(4);\r\n\t\t}\r\n\t\tthis.editing = true;\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.mesh.position.set(position.x, position.y, position.z);\r\n\t\t\t// this.mesh.lookAt(Host.origin);\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelModelComponent.onDragEnd');\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\t}\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tstatic getInteractiveDescriptors() {\r\n\t\tlet descriptors = ModelModelComponent.interactiveDescriptors;\r\n\t\tif (!descriptors) {\r\n\t\t\tconst freezableDescriptors = Object.getOwnPropertyDescriptors(FreezableMesh.prototype);\r\n\t\t\tconst emittableDescriptors = Object.getOwnPropertyDescriptors(EmittableMesh.prototype);\r\n\t\t\tconst interactiveDescriptors = Object.getOwnPropertyDescriptors(InteractiveMesh.prototype);\r\n\t\t\tdescriptors = Object.assign({}, freezableDescriptors, emittableDescriptors, interactiveDescriptors);\r\n\t\t\tModelModelComponent.interactiveDescriptors = descriptors;\r\n\t\t}\r\n\t\treturn descriptors;\r\n\t}\r\n\r\n\tmakeInteractive(mesh) {\r\n\t\tconst interactiveDescriptors = ModelModelComponent.getInteractiveDescriptors();\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tObject.keys(interactiveDescriptors).forEach(key => {\r\n\t\t\t\t\tif (key !== 'constructor') {\r\n\t\t\t\t\t\tObject.defineProperty(child, key, interactiveDescriptors[key]);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tchild.freezed = false;\r\n\t\t\t\tchild.events = {};\r\n\t\t\t\tchild.depthTest = true;\r\n\t\t\t\tchild.over_ = false;\r\n\t\t\t\tchild.down_ = false;\r\n\t\t\t\tInteractive.items.push(child);\r\n\t\t\t\tchild.on('down', () => {\r\n\t\t\t\t\t// console.log('ModelModelComponent.down', child);\r\n\t\t\t\t\tthis.onClipToggle();\r\n\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nModelModelComponent.meta = {\r\n\tselector: '[model-model]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","export default class FreezableSprite extends THREE.Sprite {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import FreezableSprite from './freezable.sprite';\r\n\r\nexport default class EmittableSprite extends FreezableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import EmittableSprite from './emittable.sprite';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveSprite extends EmittableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tsuper(material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveSprite() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","// import domtoimage from 'dom-to-image';\r\nimport html2canvas from 'html2canvas';\r\nimport { getContext } from 'rxcomp';\r\nimport DragService from '../../drag/drag.service';\r\nimport { environment } from '../../environment';\r\nimport { Host } from '../host/host';\r\nimport InteractiveSprite from '../interactive/interactive.sprite';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\n// const USE_DOM_TO_IMAGE = true;\r\n\r\nexport default class ModelPanelComponent extends ModelComponent {\r\n\r\n\tisMobile_;\r\n\tget isMobile() {\r\n\t\treturn this.isMobile_;\r\n\t}\r\n\tset isMobile(isMobile) {\r\n\t\tif (this.isMobile_ !== isMobile) {\r\n\t\t\tthis.isMobile_ = isMobile;\r\n\t\t\tthis.setScale();\r\n\t\t}\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\t// console.log('render', this.host.worldRect.width);\r\n\t\tthis.isMobile = this.host.worldRect.width < 768;\r\n\t}\r\n\r\n\tsetScale(pow = 0) {\r\n\t\tconst textureWidth = this.textureWidth;\r\n\t\tconst textureHeight = this.textureHeight;\r\n\t\tconst item = this.item;\r\n\t\tconst panel = this.panel;\r\n\t\tif (panel) {\r\n\t\t\tconst scale = 0.2 * (item.asset ? 1.5 : 1.0) * (this.isMobile ? 1.6 : 1);\r\n\t\t\tconst aspect = textureWidth / textureHeight;\r\n\t\t\tconst width = ModelPanelComponent.PANEL_RADIUS * scale;\r\n\t\t\tconst height = ModelPanelComponent.PANEL_RADIUS * scale / aspect;\r\n\t\t\tconst dy = width * 0.25;\r\n\t\t\tconst position = item.mesh.position.normalize().multiplyScalar(ModelPanelComponent.PANEL_RADIUS);\r\n\t\t\tpanel.position.set(position.x, position.y + (height + dy * 2) - dy * (1 - pow), position.z);\r\n\t\t\tpanel.scale.set(0.02 * width, 0.02 * height, 1);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.textureWidth = 0;\r\n\t\tthis.textureHeight = 0;\r\n\t\t// console.log('ModelPanelComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.getCanvasTexture(node).then(texture => {\r\n\t\t\tthis.textureWidth = texture.width;\r\n\t\t\tthis.textureHeight = texture.height;\r\n\t\t\tif (this.mesh && this.item) {\r\n\t\t\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\t\t\tdepthTest: false,\r\n\t\t\t\t\ttransparent: true,\r\n\t\t\t\t\topacity: 0,\r\n\t\t\t\t\tmap: texture.map,\r\n\t\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\t\ttoneMapped: false,\r\n\t\t\t\t});\r\n\t\t\t\tconst item = this.item;\r\n\t\t\t\tconst panel = this.panel = new InteractiveSprite(material);\r\n\t\t\t\tpanel.renderOrder = environment.renderOrder.panel;\r\n\t\t\t\tthis.setScale(1);\r\n\t\t\t\tpanel.on('down', (event) => {\r\n\t\t\t\t\t// console.log(event.intersection.uv.x, event.intersection.uv.y, node.offsetWidth, node.offsetHeight);\r\n\t\t\t\t\tconst xy = { x: parseInt(event.intersection.uv.x * node.offsetWidth), y: parseInt((1 - event.intersection.uv.y) * node.offsetHeight) };\r\n\t\t\t\t\t// console.log('ModelPanelComponent.down.xy', xy);\r\n\t\t\t\t\tconst linkNodes = Array.prototype.slice.call(node.querySelectorAll('.panel__link'));\r\n\t\t\t\t\t// console.log('linkNodes', linkNodes);\r\n\t\t\t\t\tconst linkNode = linkNodes.find(link => {\r\n\t\t\t\t\t\tconst inside = xy.x >= link.offsetLeft && xy.y >= link.offsetTop && xy.x <= (link.offsetLeft + link.offsetWidth) && xy.y <= (link.offsetTop + link.offsetHeight);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tconsole.log(\r\n\t\t\t\t\t\t\t(link.offsetLeft + link.offsetWidth), '>=', xy.x, '>=', link.offsetLeft,\r\n\t\t\t\t\t\t\t(link.offsetTop + link.offsetHeight), '>=', xy.y, '>=', link.offsetTop,\r\n\t\t\t\t\t\t\tinside,\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\treturn inside;\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('linkNode', linkNode);\r\n\t\t\t\t\tif (linkNode) {\r\n\t\t\t\t\t\tconst linkIndex = linkNodes.indexOf(linkNode);\r\n\t\t\t\t\t\tconst link = item.links[linkIndex];\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.down.link', link, linkNode, linkNodes);\r\n\t\t\t\t\t\tthis.down.next({ item, link, linkIndex });\r\n\t\t\t\t\t\tconst rect = node.getBoundingClientRect();\r\n\t\t\t\t\t\tconst mouseEvent = {\r\n\t\t\t\t\t\t\tbutton: 0,\r\n\t\t\t\t\t\t\tbuttons: 0,\r\n\t\t\t\t\t\t\tclientX: xy.x + rect.left,\r\n\t\t\t\t\t\t\tclientY: xy.y + rect.top,\r\n\t\t\t\t\t\t\tmovementX: 0,\r\n\t\t\t\t\t\t\tmovementY: 0,\r\n\t\t\t\t\t\t\trelatedTarget: linkNode,\r\n\t\t\t\t\t\t\tscreenX: xy.x,\r\n\t\t\t\t\t\t\tscreenY: xy.y,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tconst event = new MouseEvent('mouseup', mouseEvent);\r\n\t\t\t\t\t\tlinkNode.dispatchEvent(event);\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.dispatchEvent', mouseEvent);\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tDragService.dismissEvent(event, DragService.events$, DragService.dismiss$, DragService.downEvent);\r\n\t\t\t\t\t\t}, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tthis.mesh.add(panel);\r\n\t\t\t\tconst from = { value: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\tvalue: 1,\r\n\t\t\t\t\tdelay: 0.0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tthis.setScale(1 - from.value);\r\n\t\t\t\t\t\tpanel.lookAt(Host.origin);\r\n\t\t\t\t\t\tpanel.material.opacity = from.value;\r\n\t\t\t\t\t\tpanel.material.needsUpdate = true;\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}, error => {\r\n\t\t\tconsole.log('ModelPanelComponent.getCanvasTexture.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelPanelComponent.onDestroy');\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\timagesLoaded() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (node) {\r\n\t\t\tconst images = Array.prototype.slice.call(node.querySelectorAll('img'));\r\n\t\t\tconst promises = images.map(x => new Promise(function(resolve, reject) {\r\n\t\t\t\tconst cors = x.src && x.src.indexOf(location.origin) === -1;\r\n\t\t\t\tif (x.complete) {\r\n\t\t\t\t\treturn setTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t}\r\n\t\t\t\tfunction onLoad() {\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t}\r\n\t\t\t\tfunction onError() {\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t\tfunction removeListeners() {\r\n\t\t\t\t\tx.removeEventListener('load', onLoad);\r\n\t\t\t\t\tx.removeEventListener('error', onError);\r\n\t\t\t\t}\r\n\t\t\t\tfunction addListeners() {\r\n\t\t\t\t\tx.addEventListener('load', onLoad);\r\n\t\t\t\t\tx.addEventListener('error', onError);\r\n\t\t\t\t}\r\n\t\t\t\taddListeners();\r\n\t\t\t}));\r\n\t\t\tif (promises.length) {\r\n\t\t\t\treturn Promise.all(promises);\r\n\t\t\t} else {\r\n\t\t\t\treturn Promise.resolve();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture(node) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tif (this.item.panelTexture) {\r\n\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.imagesLoaded().then((results) => {\r\n\t\t\t\t\t\tconst context = getContext(this);\r\n\t\t\t\t\t\tif (context && context.node) {\r\n\t\t\t\t\t\t\tnode = context.node;\r\n\t\t\t\t\t\t\tconst useCORS = results && (results.find(x => x === true) != null); // !!! keep loose equality\r\n\t\t\t\t\t\t\t// console.log('ModelPanelComponent.getCanvasTexture.useCORS', useCORS);\r\n\t\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t\tif (USE_DOM_TO_IMAGE) {\r\n\t\t\t\t\t\t\t\tdomtoimage.toBlob(node, { cacheBust: true }).then(function(blob) {\r\n\t\t\t\t\t\t\t\t\tcreateImageBitmap(blob).then(function(imageBitmap) {\r\n\t\t\t\t\t\t\t\t\t\tconst map = new THREE.Texture();\r\n\t\t\t\t\t\t\t\t\t\tmap.image = imageBitmap;\r\n\t\t\t\t\t\t\t\t\t\tmap.needsUpdate = true;\r\n\t\t\t\t\t\t\t\t\t\tthis.item.panelTexture = {\r\n\t\t\t\t\t\t\t\t\t\t\tmap: map,\r\n\t\t\t\t\t\t\t\t\t\t\twidth: imageBitmap.width,\r\n\t\t\t\t\t\t\t\t\t\t\theight: imageBitmap.height,\r\n\t\t\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\t\t\tresolve(this.item.panelTexture);\r\n\r\n\t\t\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t\thtmlToImage.toCanvas(node).then((canvas) => {\r\n\t\t\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\t\t\tconst map = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\t\t\t// console.log(canvas.width, canvas.height);\r\n\t\t\t\t\t\t\t\tthis.item.panelTexture = {\r\n\t\t\t\t\t\t\t\t\tmap: map,\r\n\t\t\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t\t\t\t}).catch(error => {\r\n\t\t\t\t\t\t\t\tconsole.log('htmlToImage', error);\r\n\t\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\t\t\tbackgroundColor: '#ffffff00',\r\n\t\t\t\t\t\t\t\tscale: 1,\r\n\t\t\t\t\t\t\t\tuseCORS,\r\n\t\t\t\t\t\t\t\t// logging: true,\r\n\t\t\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\t\t\tconst map = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\t\t\t// console.log(canvas.width, canvas.height);\r\n\t\t\t\t\t\t\t\tthis.item.panelTexture = {\r\n\t\t\t\t\t\t\t\t\tmap: map,\r\n\t\t\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t// }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}, 1); // keep it for childnode images to be compiled\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelPanelComponent.PANEL_RADIUS = 99;\r\n\r\nModelPanelComponent.meta = {\r\n\tselector: '[model-panel]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down'],\r\n\tinputs: ['item'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"panel__title\"><span [innerHTML]=\"item.title\"></span></div>\r\n\t\t<div class=\"panel__abstract\"><span [innerHTML]=\"item.abstract\"></span></div>\r\n\t\t<img class=\"panel__picture\" [src]=\"item.asset | asset\" *if=\"item.asset\">\r\n\t\t<a class=\"panel__link\" [href]=\"link.href\" target=\"_blank\" rel=\"noopener\" *for=\"let link of item.links\">\r\n\t\t\t<span [innerHTML]=\"link.title\"></span>\r\n\t\t</a>\r\n\t`,\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelPictureComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPictureComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelPictureComponent.meta = {\r\n\tselector: '[model-picture]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport { Geometry } from '../geometry/geometry';\r\nimport { Host } from '../host/host';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\nexport default class ModelPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tconst selected = this.item.selected;\r\n\t\tthis.editing = selected;\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.editing = selected;\r\n\t\t}\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst view = this.view;\r\n\t\tconst items = view.items;\r\n\t\tconst geometry = Geometry.planeGeometry;\r\n\t\tthis.onMeshDown = this.onMeshDown.bind(this);\r\n\t\tthis.onMeshPlaying = this.onMeshPlaying.bind(this);\r\n\t\tthis.onMeshZoomed = this.onMeshZoomed.bind(this);\r\n\t\tthis.onMeshCurrentTime = this.onMeshCurrentTime.bind(this);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\t// console.log('ModelPlaneComponent.onCreate.streamId', streamId);\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = this.disposableMesh = new MediaMesh(item, view, geometry, this.host);\r\n\t\t\t\t\tmesh.updateFromItem(item);\r\n\t\t\t\t\tmesh.name = 'plane';\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tthis.disposableMesh = null;\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.addMeshListeners(mesh);\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\taddMeshListeners(mesh) {\r\n\t\tmesh.on('down', this.onMeshDown);\r\n\t\tmesh.on('playing', this.onMeshPlaying);\r\n\t\tmesh.on('zoomed', this.onMeshZoomed);\r\n\t\tmesh.on('currentTime', this.onMeshCurrentTime);\r\n\t}\r\n\r\n\tremoveMeshListeners(mesh) {\r\n\t\tmesh.off('down', this.onMeshDown);\r\n\t\tmesh.off('playing', this.onMeshPlaying);\r\n\t\tmesh.off('zoomed', this.onMeshZoomed);\r\n\t\tmesh.off('currentTime', this.onMeshCurrentTime);\r\n\t}\r\n\r\n\tonMeshDown() {\r\n\t\t// console.log('ModelPanelComponent.onMeshDown');\r\n\t\tthis.down.next(this);\r\n\t}\r\n\r\n\tonMeshPlaying(playing) {\r\n\t\t// console.log('ModelPanelComponent.playing', playing);\r\n\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t}\r\n\r\n\tonMeshZoomed(zoomed) {\r\n\t\t// console.log('ModelPanelComponent.zoomed', zoomed);\r\n\t\tthis.zoom.next({ itemId: this.item.id, zoomed });\r\n\t}\r\n\r\n\tonMeshCurrentTime(currentTime) {\r\n\t\t// console.log('ModelPanelComponent.playing', playing);\r\n\t\tthis.currentTime.next({ itemId: this.item.id, currentTime });\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelPlaneComponent.onDestroy');\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.disposableMesh) {\r\n\t\t\tthis.removeMeshListeners(this.disposableMesh);\r\n\t\t\tthis.disposableMesh.dispose();\r\n\t\t}\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.removeMeshListeners(this.mesh);\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdate', item);\r\n\t\tmesh.updateFromItem(item);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdateAsset', item);\r\n\t\tmesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tmesh.load(() => {\r\n\t\t\t\t// console.log('ModelPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position, normal, spherical) {\r\n\t\t// console.log('ModelPlaneComponent.onDragMove', position, normal, spherical);\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\titem.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tif (spherical) {\r\n\t\t\tposition.normalize().multiplyScalar(20);\r\n\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\tmesh.lookAt(Host.origin);\r\n\t\t} else {\r\n\t\t\tmesh.position.set(0, 0, 0);\r\n\t\t\tmesh.lookAt(normal);\r\n\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\tmesh.position.add(normal.multiplyScalar(0.01));\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelPlaneComponent.onDragEnd');\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\titem.position = mesh.position.toArray();\r\n\t\titem.rotation = mesh.rotation.toArray();\r\n\t\titem.scale = mesh.scale.toArray();\r\n\t\tmesh.updateFromItem(item);\r\n\t\tthis.editing = false;\r\n\t}\r\n}\r\n\r\nModelPlaneComponent.textures = {};\r\n\r\nModelPlaneComponent.meta = {\r\n\tselector: '[model-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play', 'zoom', 'currentTime'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport { LabelPipe } from '../../label/label.pipe';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport { PANORAMA_RADIUS } from '../geometry/geometry';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\n// export const LOADING_BANNER = { title: LabelPipe.transform('loading') };\r\n// export const WAITING_BANNER = { title: LabelPipe.transform('waiting_host') };\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\n\r\nexport default class ModelProgressComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (title === LabelPipe.transform('waiting_host') || (title !== '' && this.visible_)) {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget visible() {\r\n\t\treturn this.visible_;\r\n\t}\r\n\tset visible(visible) {\r\n\t\tif (this.visible_ !== visible) {\r\n\t\t\tthis.visible_ = visible;\r\n\t\t\tif (visible && this.title_ !== '') {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.title_ = '';\r\n\t\tthis.visible_ = this.host.renderer.xr.isPresenting;\r\n\t\tsuper.onInit();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => this.visible = session != null); // loose\r\n\t\t// this.progress = LoaderService.progress;\r\n\t\t/*\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst inner = node.querySelector('.inner');\r\n\t\tLoaderService.progress$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(progress => {\r\n\t\t\tprogress.count > 0 ? node.classList.add('active') : node.classList.remove('active');\r\n\t\t\tinner.style.width = `${progress.count}%`;\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// console.log('ModelProgressComponent.onCreate');\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst inner = node.querySelector('.inner');\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst mesh = this.createMesh(result);\r\n\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\tmount(mesh);\r\n\t\t\t}\r\n\t\t\tLoaderService.progress$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe(progress => {\r\n\t\t\t\tprogress.count > 0 ? node.classList.add('active') : node.classList.remove('active');\r\n\t\t\t\tinner.style.width = `${progress.value * 100}%`;\r\n\t\t\t\tif (progress.count) {\r\n\t\t\t\t\tthis.title = progress.value === 0 ? LabelPipe.transform('loading') : progress.title;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.title = this.getTitle();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tgetTitle() {\r\n\t\tif (this.view && this.view.type.name === ViewType.WaitingRoom.name) {\r\n\t\t\treturn LabelPipe.transform('waiting_host');\r\n\t\t} else {\r\n\t\t\treturn '';\r\n\t\t}\r\n\t}\r\n\r\n\tshow() {\r\n\t\tthis.mesh.add(this.banner);\r\n\t\tthis.material.opacity = 1;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst material = this.material;\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 1,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\thide() {\r\n\t\tthis.mesh.remove(this.banner);\r\n\t\tthis.material.opacity = 0;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 0,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\tthis.mesh.remove(this.banner);\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tcreateMesh(result) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\t// const repeat = 24;\r\n\t\t// const aspect = (result.width * repeat) / result.height;\r\n\t\tconst arc = Math.PI / 180 * 360;\r\n\t\tconst width = PANEL_RADIUS * arc;\r\n\t\tconst height = width / 360 * 2.4;\r\n\t\tconst w = result.width * height / result.height;\r\n\t\tconst repeat = width / w;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\tconst texture = result.texture;\r\n\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\ttexture.repeat.x = repeat;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t\ttoneMapped: false,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst banner = this.banner = new THREE.Mesh(geometry, material);\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t};\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tupdateProgress() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelProgressComponent.updateProgress', result);\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / 360 * 2.4;\r\n\t\t\tconst w = result.width * height / result.height;\r\n\t\t\tconst repeat = width / w;\r\n\t\t\tthis.texture.repeat.x = repeat;\r\n\t\t});\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 64;\r\n\t\t\tconst F = Math.floor(H * 0.75);\r\n\t\t\tconst L = Math.floor(H * 0.05);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.title_;\r\n\t\t\t// console.log('ModelProgressComponent.getCanvasTexture', text);\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.35)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with 'bevel' & 'round' for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelProgressComponent.meta = {\r\n\tselector: '[model-progress]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['view'],\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';\r\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst SHOULD_SCALE = false;\r\n\r\nexport default class ModelRoomComponent extends ModelComponent {\r\n\r\n\tstatic get transparentMaterial() {\r\n\t\tif (!this.transparentMaterial_) {\r\n\t\t\tthis.transparentMaterial_ = new THREE.MeshBasicMaterial({\r\n\t\t\t\tcolor: 0xff0000,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn this.transparentMaterial_;\r\n\t}\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\tset freezed(freezed) {\r\n\t\tif (this.freezed_ !== freezed) {\r\n\t\t\tthis.freezed_ = freezed;\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tif (mesh) {\r\n\t\t\t\tmesh.traverse((child) => {\r\n\t\t\t\t\tif (child.isInteractiveMesh) {\r\n\t\t\t\t\t\tchild.freezed = freezed;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('ModelRoomComponent.onInit');\r\n\t\tsuper.onInit();\r\n\t\tthis.isPresenting = false;\r\n\t\tMenuService.active$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(active => this.freezed = active);\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.view.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.room;\r\n\t\tthis.loadGlb(environment.getPath(this.view.asset.folder), this.view.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, mount, dismount);\r\n\t\t});\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\tloadGlb(path, file, callback) {\r\n\t\tconst renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('progressRef');\r\n\t\tconst loader = new GLTFLoader().setPath(path);\r\n\t\t// Optional: Provide a DRACOLoader instance to decode compressed mesh data\r\n\t\tconst decoderPath = `${environment.dist}js/draco/`;\r\n\t\t// console.log(decoderPath);\r\n\t\tconst dracoLoader = new DRACOLoader();\r\n\t\tdracoLoader.setDecoderPath(decoderPath);\r\n\t\tloader.setDRACOLoader(dracoLoader);\r\n\t\tloader.load(file, (glb) => {\r\n\t\t\t/*\r\n\t\t\tglb.scene.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(glb.scene, glb.animations);\r\n\t\t\t}\r\n\t\t\t// console.log('ModelRoomComponent.loadGlb');\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\tLoaderService.setProgress(progressRef, progressEvent.loaded, progressEvent.total);\r\n\t\t});\r\n\t}\r\n\r\n\tonGlbLoaded(mesh, animations, mount, dismount) {\r\n\t\tconst view = this.view;\r\n\t\t// scale\r\n\t\tif (SHOULD_SCALE) {\r\n\t\t\tconst box = new THREE.Box3().setFromObject(mesh);\r\n\t\t\tconst size = box.max.clone().sub(box.min);\r\n\t\t\tconst min = Math.min(size.x, size.y, size.z);\r\n\t\t\tconst scale = 12 / min;\r\n\t\t\tmesh.scale.set(scale, scale, scale);\r\n\t\t}\r\n\t\tmesh.position.set(0, -1.76, 0);\r\n\t\t// nav\r\n\t\tconst intersectObjects = [];\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tintersectObjects.push(child);\r\n\t\t\t}\r\n\t\t\tif (child.name === 'nav') {\r\n\t\t\t\t// child.parent.remove(child);\r\n\t\t\t\tview.navIntersectObjects = [child];\r\n\t\t\t\tthis.makeTransparent(child);\r\n\t\t\t}\r\n\t\t});\r\n\t\tview.intersectObjects = intersectObjects;\r\n\t\t// animations\r\n\t\tlet dummy;\r\n\t\tdummy = new THREE.Group();\r\n\t\tdummy.add(mesh);\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(dummy, this.view);\r\n\t\t}\r\n\t}\r\n\r\n\tmakeTransparent(object) {\r\n\t\tif (object.isMesh) {\r\n\t\t\tobject.material = ModelRoomComponent.transparentMaterial;\r\n\t\t}\r\n\t\tobject.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tchild.material = ModelRoomComponent.transparentMaterial;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(view, mesh) {\r\n\t\t// console.log('ModelRoomComponent.onUpdateAsset', view);\r\n\t\tthis.loadGlb(environment.getPath(view.asset.folder), view.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, (mesh, view) => this.onMount(mesh, view), (mesh, view) => this.onDismount(mesh, view));\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nModelRoomComponent.meta = {\r\n\tselector: '[model-room]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['view'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelTextComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelTextComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelTextComponent.meta = {\r\n\tselector: '[model-text]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { CoreModule, Module } from 'rxcomp';\r\nimport { FormModule } from 'rxcomp-form';\r\nimport AccessCodeComponent from './access/access-code.component';\r\nimport AccessComponent from './access/access.component';\r\nimport AgoraChatEmojiComponent from './agora/agora-chat-emoji.component';\r\nimport AgoraChatComponent from './agora/agora-chat.component';\r\nimport AgoraCheckComponent from './agora/agora-check.component';\r\nimport AgoraChecklistComponent from './agora/agora-checklist.component';\r\nimport AgoraConfigureFirewallModalComponent from './agora/agora-configure-firewall-modal.component';\r\nimport AgoraDevicePreviewComponent from './agora/agora-device-preview.component';\r\nimport AgoraDeviceComponent from './agora/agora-device.component';\r\nimport AgoraLinkComponent from './agora/agora-link.component';\r\nimport AgoraLoginComponent from './agora/agora-login.component';\r\nimport AgoraNameComponent from './agora/agora-name.component';\r\nimport AgoraStreamComponent from './agora/agora-stream.component';\r\nimport AgoraComponent from './agora/agora.component';\r\nimport AgoraService from './agora/agora.service';\r\nimport AppComponent from './app.component';\r\nimport AssetPipe from './asset/asset.pipe';\r\nimport ControlRequestModalComponent from './control-request/control-request-modal.component';\r\nimport DropDirective from './drop/drop.directive';\r\nimport DropdownItemDirective from './dropdown/dropdown-item.directive';\r\nimport DropdownDirective from './dropdown/dropdown.directive';\r\nimport { EditorModule } from './editor/editor.module';\r\nimport IframeModalComponent from './editor/modals/iframe-modal.component';\r\nimport EnvPipe from './env/env.pipe';\r\nimport FlagPipe from './flag/flag.pipe';\r\nimport ControlAssetComponent from './forms/control-asset.component';\r\nimport ControlAssetsComponent from './forms/control-assets.component';\r\nimport ControlCheckboxComponent from './forms/control-checkbox.component';\r\nimport ControlCustomSelectComponent from './forms/control-custom-select.component';\r\nimport ControlLinkComponent from './forms/control-link.component';\r\nimport ControlLocalizedAssetComponent from './forms/control-localized-asset.component';\r\nimport ControlMenuComponent from './forms/control-menu.component';\r\nimport ControlModelComponent from './forms/control-model.component';\r\nimport ControlNumberComponent from './forms/control-number.component';\r\nimport ControlPasswordComponent from './forms/control-password.component';\r\nimport ControlSelectComponent from './forms/control-select.component';\r\nimport ControlTextComponent from './forms/control-text.component';\r\nimport ControlTextareaComponent from './forms/control-textarea.component';\r\nimport ControlVectorComponent from './forms/control-vector.component';\r\nimport ControlsComponent from './forms/controls.component';\r\nimport DisabledDirective from './forms/disabled.directive';\r\nimport ErrorsComponent from './forms/errors.component';\r\nimport InputValueComponent from './forms/input-value.component';\r\nimport TestComponent from './forms/test.component';\r\nimport ValueDirective from './forms/value.directive';\r\nimport { GenericModalComponent } from './generic/generic-modal.component';\r\nimport { GenericComponent } from './generic/generic.component';\r\nimport HtmlPipe from './html/html.pipe';\r\nimport IdDirective from './id/id.directive';\r\nimport { LabelPipe } from './label/label.pipe';\r\nimport LanguageComponent from './language/language.component';\r\nimport LayoutComponent from './layout/layout.component';\r\nimport LazyDirective from './lazy/lazy.directive';\r\nimport MessagePipe from './message/message.pipe';\r\nimport ModalOutletComponent from './modal/modal-outlet.component';\r\nimport ModalComponent from './modal/modal.component';\r\nimport { RoutePipe } from './router/route.pipe';\r\nimport { RouterLinkDirective } from './router/router-link.directive';\r\nimport { RouterOutletStructure } from './router/router-outlet.structure';\r\nimport SupportRequestModalComponent from './support-request/support-request-modal.component';\r\nimport SvgIconStructure from './svg/svg-icon.structure';\r\nimport TitleDirective from './title/title.directive';\r\nimport TryInARModalComponent from './try-in-ar/try-in-ar-modal.component';\r\nimport TryInARComponent from './try-in-ar/try-in-ar.component';\r\nimport UploadItemComponent from './upload/upload-item.component';\r\nimport HlsDirective from './video/hls.directive';\r\nimport VirtualStructure from './virtual/virtual.structure';\r\nimport MediaPlayerComponent from './world/media/media-player.component';\r\nimport ModelBannerComponent from './world/model/model-banner.component';\r\nimport ModelCurvedPlaneComponent from './world/model/model-curved-plane.component';\r\nimport ModelDebugComponent from './world/model/model-debug.component';\r\nimport ModelGridComponent from './world/model/model-grid.component';\r\nimport ModelMenuComponent from './world/model/model-menu.component';\r\nimport ModelModelComponent from './world/model/model-model.component';\r\nimport ModelNavComponent from './world/model/model-nav.component';\r\nimport ModelPanelComponent from './world/model/model-panel.component';\r\nimport ModelPictureComponent from './world/model/model-picture.component';\r\nimport ModelPlaneComponent from './world/model/model-plane.component';\r\nimport ModelProgressComponent from './world/model/model-progress.component';\r\nimport ModelRoomComponent from './world/model/model-room.component';\r\nimport ModelTextComponent from './world/model/model-text.component';\r\nimport ModelComponent from './world/model/model.component';\r\nimport WorldComponent from './world/world.component';\r\n\r\nAgoraService.fixLegacy();\r\n\r\nexport class AppModule extends Module { }\r\n\r\nAppModule.meta = {\r\n\timports: [\r\n\t\tCoreModule,\r\n\t\tFormModule,\r\n\t\tEditorModule,\r\n\t],\r\n\tdeclarations: [\r\n\t\tAccessCodeComponent,\r\n\t\tAccessComponent,\r\n\t\tAgoraChatComponent,\r\n\t\tAgoraChatEmojiComponent,\r\n\t\tAgoraCheckComponent,\r\n\t\tAgoraChecklistComponent,\r\n\t\tAgoraComponent,\r\n\t\tAgoraConfigureFirewallModalComponent,\r\n\t\tAgoraDeviceComponent,\r\n\t\tAgoraDevicePreviewComponent,\r\n\t\tAgoraLinkComponent,\r\n\t\tAgoraLoginComponent,\r\n\t\tAgoraNameComponent,\r\n\t\tAgoraStreamComponent,\r\n\t\tAssetPipe,\r\n\t\tControlAssetComponent,\r\n\t\tControlAssetsComponent,\r\n\t\tControlCheckboxComponent,\r\n\t\tControlCustomSelectComponent,\r\n\t\tControlLinkComponent,\r\n\t\tControlLocalizedAssetComponent,\r\n\t\tControlMenuComponent,\r\n\t\tControlModelComponent,\r\n\t\tControlNumberComponent,\r\n\t\tControlPasswordComponent,\r\n\t\tControlRequestModalComponent,\r\n\t\tControlsComponent,\r\n\t\tControlSelectComponent,\r\n\t\tControlTextareaComponent,\r\n\t\tControlTextComponent,\r\n\t\tControlVectorComponent,\r\n\t\tDisabledDirective,\r\n\t\tDropDirective,\r\n\t\tDropdownDirective,\r\n\t\tDropdownItemDirective,\r\n\t\tEnvPipe,\r\n\t\tErrorsComponent,\r\n\t\tFlagPipe,\r\n\t\tGenericComponent,\r\n\t\tGenericModalComponent,\r\n\t\tHlsDirective,\r\n\t\tHtmlPipe,\r\n\t\tIframeModalComponent,\r\n\t\tIdDirective,\r\n\t\tInputValueComponent,\r\n\t\tLabelPipe,\r\n\t\tLanguageComponent,\r\n\t\tLayoutComponent,\r\n\t\tLazyDirective,\r\n\t\tMediaPlayerComponent,\r\n\t\tMessagePipe,\r\n\t\tModalComponent,\r\n\t\tModalOutletComponent,\r\n\t\tModelBannerComponent,\r\n\t\tModelComponent,\r\n\t\tModelCurvedPlaneComponent,\r\n\t\tModelDebugComponent,\r\n\t\tModelGridComponent,\r\n\t\tModelMenuComponent,\r\n\t\tModelModelComponent,\r\n\t\tModelNavComponent,\r\n\t\tModelPanelComponent,\r\n\t\tModelPictureComponent,\r\n\t\tModelPlaneComponent,\r\n\t\tModelProgressComponent,\r\n\t\tModelRoomComponent,\r\n\t\tModelTextComponent,\r\n\t\tRoutePipe,\r\n\t\tSupportRequestModalComponent,\r\n\t\tSvgIconStructure,\r\n\t\tTestComponent,\r\n\t\tTitleDirective,\r\n\t\tTryInARComponent,\r\n\t\tTryInARModalComponent,\r\n\t\tUploadItemComponent,\r\n\t\tValueDirective,\r\n\t\tVirtualStructure,\r\n\t\tWorldComponent,\r\n\t\tRouterOutletStructure,\r\n\t\tRouterLinkDirective,\r\n\t],\r\n\tbootstrap: AppComponent,\r\n};\r\n","import { Browser } from 'rxcomp';\r\nimport { AppModule } from './app.module';\r\n\r\nBrowser.bootstrap(AppModule);\r\n"]}