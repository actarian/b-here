/**
 * @license beta-bhere-development v1.0.33-canary.0
 * (c) 2023 Luca Zampetti <lzampetti@gmail.com>
 * License: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("rxcomp"),require("rxcomp-form"),require("rxjs"),require("rxjs/operators"),require("three"),require("html2canvas")):"function"==typeof define&&define.amd?define(["rxcomp","rxcomp-form","rxjs","rxjs/operators","three","html2canvas"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).rxcomp,t.rxcomp.form,t.rxjs,t.rxjs.operators,t.THREE,t.html2canvas)}(this,(function(t,e,i,n,s,o){"use strict";function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var a=r(o);const c='\n\x3c!-- service --\x3e\n<div class="group--service">\n\t<button type="button" class="btn--back" [title]="\'title_back\' | label" (click)="onBack($event)" *if="isBackButtonVisible">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t</button>\n\t<button type="button" class="btn--view-mode" [title]="\'title_view_mode\' | label" (click)="toggleMode($event)" *if="state.mode != \'embed\'">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == \'virtual-tour\'"><use xlink:href="#live-meeting"></use></svg>\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == \'live-meeting\'"><use xlink:href="#virtual-tour"></use></svg>\n\t</button>\n\t<button type="button" class="btn--volume" [title]="\'title_volume\' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t</button>\n\t<button type="button" class="btn--fullscreen" [title]="\'title_fullscreen\' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t</button>\n\t<button type="button" class="btn--navmap" [title]="\'title_navmap\' | label" [class]="{ active: state.showNavmap }" (click)="toggleNavmap($event)" *if="navmap && state.mode != \'live-meeting\'">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navmap"></use></svg>\n\t</button>\n</div>\n',d='\n\x3c!-- controls --\x3e\n<div class="group--controls" *if="state.live">\n\t<div class="group--actions">\n\t\t<button type="button" class="btn--call" [title]="\'title_disconnect\' | label" (click)="disconnect()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--cam" [title]="\'title_mute_camera\' | label" [class]="{ muted: state.cameraMuted, disabled: !local }" (click)="toggleCamera()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--mic" [title]="\'title_mute_mic\' | label" [class]="{ muted: state.audioMuted, disabled: !local || silenced }" (click)="toggleAudio()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--screen" [title]="\'title_share_screen\' | label" [class]="{ active: screen }" (click)="toggleScreen()" *if="(\'screenShare\' | flag) && (state.role == \'publisher\' || state.role == \'attendee\' || controlling)">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#screen"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--chat" [title]="\'title_chat\' | label" [class]="{ active: state.chatDirty }" (click)="toggleChat()" *if="(\'chat\' | flag)">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#chat"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--navinfo" [title]="\'title_navinfo\' | label" [class]="{ active: state.showNavInfo }" (click)="toggleNavInfo()" *if="showNavInfoToggler">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navinfo"></use></svg>\n\t\t</button>\n\t</div>\n</div>\n',l='\n\x3c!-- media --\x3e\n<div class="group--media" media-player>\n\t<button type="button" class="btn--play" [title]="\'title_play\' | label" (click)="onPlay()" *if="!playing">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#play"></use></svg>\n\t</button>\n\t<button type="button" class="btn--pause" [title]="\'title_pause\' | label" (click)="onPause()" *if="playing">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#pause"></use></svg>\n\t</button>\n\t<div class="track" (click)="onTrack($event)">\n\t\t<div class="track__progress" [style]="{ transform: \'scale(\' + this.progress + \', 1)\'}"></div>\n\t</div>\n</div>\n',h='\n\x3c!-- ar-vr --\x3e\n<div class="group--ar-vr">\n\t<button type="button" class="btn--ar" [title]="\'title_ar\' | label" [href]="view?.ar" (click)="tryInAr()" *if="view?.ar">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#ar"></use></svg> <span>Try in AR</span>\n\t</button>\n\t<button type="button" class="btn--vr" [title]="\'title_vr\' | label" [class]="{ disabled: vrService.isDisabled() }" (click)="vrService.toggleVR()">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#vr"></use></svg> <span [innerHTML]="vrService.getLabel()"></span>\n\t</button>\n</div>\n',u='\n\x3c!-- like --\x3e\n<div class="group--heart" *if="view && (\'like\' | flag)">\n\t<svg class="love" [class]="{ active: view.showLove }" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#heart"></use></svg>\n\t<button type="button" class="btn--heart" [class]="{ active: view.showLove }" (click)="addLike($event)">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#heart"></use></svg>\n\t\t<span class="badge" [innerHTML]="view.likes" *if="view.likes"></span>\n\t</button>\n</div>\n<div class="group--spacer" *if="!view || !(\'like\' | flag)"></div>\n',p='\n\x3c!-- chat --\x3e\n<div class="group--chat" *if="state.chat" agora-chat (close)="onChatClose()"></div>\n',m='\n\x3c!-- lock --\x3e\n<div class="ui__lock" [class]="{ spying: spying }" *if="locked || controlling"></div>\n',g='\n\x3c!-- navmap --\x3e\n<div class="group--navmap" *if="navmap && state.showNavmap && state.mode != \'live-meeting\'">\n\t<img draggable="false" [src]="navmap.asset | asset" *if="navmap.asset" />\n\t<div class="navmap__item" [style]="{ left: item.position[0] * 100 + \'%\', top: item.position[1] * 100 + \'%\' }" (click)="onNavmapItem(item)" *for="let item of navmap.items">\n\t\t<img draggable="false" [src]="\'textures/ui/nav-point.png\' | asset" />\n\t\t<div class="title" [innerHTML]="item.title" *if="item.title"></div>\n\t</div>\n</div>\n',f="\n\x3c!-- background --\x3e\n<div class=\"background\" [class]=\"{ 'background--image': ('background.image' | env), 'background--video': ('background.video' | env) }\" *if=\"state.status != 'connected'\">\n\t<img [src]=\"'background.image' | env | asset\" *if=\"'background.image' | env\" />\n\t<video [src]=\"'background.video' | env | asset\" *if=\"'background.video' | env\" oncanplay=\"this.muted = true; this.classList.add('ready');\" playsinline autoplay muted loop></video>\n</div>\n",v='\n\x3c!-- logo --\x3e\n<a class="btn--logo" [routerLink]="\':lang.access\' | route" *if="state.status != \'connected\'">\n\t<img [src]="\'logo\' | env" *if="\'logo\' | env" />\n\t<svg viewBox="0 0 270 98" *if="!(\'logo\' | env)"><use xlink:href="#b-here"></use></svg>\n</a>\n',_='\n\x3c!-- credits --\x3e\n<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener" *if="state.status != \'connected\'">\n\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n</a>\n',E='\n\x3c!-- copyright --\x3e\n<span *if="\'gdprRoutes\' | flag"> <span [innerHTML]="\'copyright\' | label"></span> <span *if="\'privacy_policy\' | label">-</span> <a [routerLink]="\':lang.privacy\' | route" class="btn--colophon" [innerHTML]="\'privacy_policy\' | label"></a> <span *if="\'terms_of_service\' | label">-</span> <a [routerLink]="\':lang.terms\' | route" class="btn--colophon" [innerHTML]="\'terms_of_service\' | label"></a></span>\n',S='\n\x3c!-- language --\x3e\n<div class="group--language" language *if="state.status != \'connected\'"></div>\n',T=`\n\x3c!-- Virtual Tour --\x3e\n<div class="ui virtual-tour" [class]="uiClass" *if="state.status == 'connected' && isVirtualTourUser">\n\t\x3c!-- world --\x3e\n\t<div class="ui__body">\n\t\t<div class="world" world [view]="view" [views]="pathViews" (navTo)="onNavTo($event)" (navLink)="onNavLink($event)"></div>\n\t</div>\n\t\n\x3c!-- remote sidebar --\x3e\n<div class="group--remote" [class]="remoteClass" *if="state.live">\n\t<div class="agora-stream" (toggleControl)="onToggleControl($event)" (toggleSpy)="onToggleSpy($event)" agora-stream [stream]="remote" type="remote" *for="let remote of remotes">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info" [class]="{ spyed: state.spying == streamId, controlling: state.controlling == streamId }">\n\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t\t<button type="button" class="btn--control" [title]="'title_control' | label" (click)="onToggleControl(streamId)" *if="state.role === 'publisher'">\n\t\t\t\t<svg class="control" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="btn--spy" [title]="'title_spy' | label" (click)="onToggleSpy(streamId)" *if="state.role === 'publisher'">\n\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#spy"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t<div class="group--members" *if="state.mode == 'virtual-tour'">\n\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t</div>\n\t\t<div class="credits">\n\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t</a>\n\t\t</div>\n\t</div>\n</div>\n\x3c!-- remote screen --\x3e\n<div class="group--remote-screen" *if="remoteScreen">\n\t<div class="agora-stream" agora-stream [stream]="remoteScreen" type="remote">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info">\n\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t</div>\n\t</div>\n</div>\n\n\t<div class="group--header">\n\t\t${c}\n\t\t\n\x3c!-- local streams --\x3e\n<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t<button type="button" class="btn--silence" [title]="'title_silence' | label" [class]="{ active: state.silencing }" (click)="onToggleSilence()" *if="state.role === 'publisher'">\n\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t</button>\n\t<button type="button" class="btn--control" [title]="'title_control' | label" [class]="{ active: state.controlling == state.uid }" (click)="onToggleControl(state.uid)" *if="state.role == 'publisher'">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t</button>\n\t<div class="agora-stream" *if="!local"></div>\n\t<div class="agora-stream" agora-stream [stream]="local" type="local" *if="local">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info">\n\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t</div>\n\t</div>\n\t<div class="agora-stream agora-stream--screen" agora-stream [stream]="screen" type="local" *if="screen && hasScreenViewItem">\n\t\t<div class="agora-stream__player"></div>\n\t</div>\n</div>\n\n\t</div>\n\t<div class="group--footer">\n\t\t${d}\n\t\t${l}\n\t\t${h}\n\t\t${u}\n\t</div>\n\t\n\x3c!-- members --\x3e\n<div class="group--members" *if="state.mode == 'live-meeting'">\n\t<div class="members" *if="state.role === 'publisher'">\n\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t</div>\n\t<div class="credits">\n\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t</div>\n</div>\n\n\t${p}\n\t${m}\n\t${g}\n</div>\n`,b=`\n\x3c!-- Self Service Tour --\x3e\n<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'self-service-tour'">\n\t\x3c!-- world --\x3e\n\t<div class="ui__body">\n\t\t<div class="world" world [view]="view" [views]="pathViews" (navTo)="onNavTo($event)" (navLink)="onNavLink($event)"></div>\n\t</div>\n\t<div class="group--header">\n\t\t${c}\n\t</div>\n\t<div class="group--footer">\n\t\t<div class="group--spacer"></div>\n\t\t${l}\n\t\t${h}\n\t\t${u}\n\t</div>\n\t${g}\n</div>\n`,y=`\n\x3c!-- Embed --\x3e\n<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'embed'">\n\t\x3c!-- world --\x3e\n\t<div class="ui__body">\n\t\t<div class="world" world [view]="view" [views]="pathViews" (navTo)="onNavTo($event)" (navLink)="onNavLink($event)"></div>\n\t</div>\n\t<div class="group--header">\n\t\t${c}\n\t</div>\n\t<div class="group--footer">\n\t\t<div class="group--spacer"></div>\n\t\t${l}\n\t\t${h}\n\t\t${u}\n\t</div>\n</div>\n`;class C{static merge(t,e){return null===e?e:t?(e&&"object"==typeof e&&Object.keys(e).forEach((i=>{const n=e[i];"object"!=typeof n||Array.isArray(n)?t[i]=n:t[i]=this.merge(t[i],n)})),t):e&&"object"==typeof e?Object.assign({},e):e}}const w="undefined"!=typeof module&&module.exports,R=null!=(w?{get:()=>{}}:new URLSearchParams(window.location.search)).get("debug");!w&&document.querySelector("base").getAttribute("href");const I=!w&&(window&&-1!==window.location.host.indexOf("herokuapp")),A=!w&&(window&&-1!==window.location.host.indexOf("vercel.app")),O=I||A,N=!w&&(O||window&&("41789"===window.location.port||"5000"===window.location.port||"6443"===window.location.port||"actarian.github.io"===window.location.host)),k=!w&&(window&&-1!==["localhost","127.0.0.1","0.0.0.0"].indexOf(window.location.host.split(":")[0])),L={STATIC:N,DEVELOPMENT:k,PRODUCTION:!k};const P={channelName:"BHere",flags:{heroku:I,vercel:A,deployed:O},navs:{iconMinScale:1,iconMaxScale:1.4},url:{},languages:["it","en"],defaultLanguage:"it",labels:{},data:{},fields:[]},D=window.STATIC?{appKey:"8b0cae93d47a44e48e97e7fd0404be4e",channelName:"BHere",flags:{production:!1,useProxy:!0,useToken:!1,usePrefetch:!0,useExtendedUserInfo:!0,useEncryptedUrl:!0,gdprRoutes:!0,selfService:!0,guidedTourRequest:!0,guidedTourAccess:!0,ssoLogin:!1,ssoRegister:!1,editor:!0,editorAssetScreen:!0,menu:!0,menuEmbed:!0,navmaps:!0,screenShare:!0,chat:!0,ar:!0,like:!0,hideNavInfo:!0,useIframe:!0,attendee:!0,streamer:!0,viewer:!0,smartDevice:!0,selfServiceProposition:!1,navInfoAnimated:!1,navInfoImportantAnimated:!1,navMoveAnimated:!0,navMoveImportantAnimated:!0,navPointAnimated:!1,navPointImportantAnimated:!1,navTitleAnimated:!1,navTitleImportantAnimated:!1,navTransparentAnimated:!0,navTransparentImportantAnimated:!0,useTextureEnvironment:!0,usePaths:!0,antialias:!0,alpha:!1,premultipliedAlpha:!1},sso:{issuer:"bhere-sso",origin:"http://localhost:3010",loginUrl:"http://localhost:3010/sso/login?redirectUrl={redirectUrl}",logoutUrl:"http://localhost:3010/sso/logout?redirectUrl={redirectUrl}",registerUrl:"http://localhost:3010/sso/register?redirectUrl={redirectUrl}",verifyTokenUrl:"http://localhost:3010/sso/verifytoken?verifyToken={verifytoken}"},navs:{iconMinScale:1,iconMaxScale:1.4},profiles:{streamer:"480p_2",attendee:"1080p_2",publisher:"1080p_2",screen:"1080p_2"},logo:null,selfServiceAudio:null,colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room"],disabledViewItemTypes:["texture"]},assets:"/docs/",dist:"/dist/",workers:{image:"./js/workers/image.service.worker.js",prefetch:"./js/workers/prefetch.service.worker.js"},textures:{envMap:"textures/envMap/studio_small_03_2k.hdr",grid:"textures/grid/grid.jpg"},toneMappingExposure:1,githubDocs:"https://raw.githubusercontent.com/actarian/b-here/beta-bhere-sso/docs/",template:{email:{supportRequest:"/email/support-request.html"}}}:{appKey:"8b0cae93d47a44e48e97e7fd0404be4e",channelName:"BHere",flags:{production:!0,useProxy:!1,useToken:!1,usePrefetch:!0,useExtendedUserInfo:!1,useEncryptedUrl:!1,gdprRoutes:!1,selfService:!0,guidedTourRequest:!0,guidedTourAccess:!0,ssoLogin:!1,ssoRegister:!1,editor:!1,editorAssetScreen:!1,menu:!0,menuEmbed:!1,navmaps:!1,screenShare:!1,chat:!1,ar:!0,like:!0,hideNavInfo:!0,useIframe:!0,attendee:!0,streamer:!0,viewer:!0,smartDevice:!0,selfServiceProposition:!1,navInfoAnimated:!1,navInfoImportantAnimated:!1,navMoveAnimated:!1,navMoveImportantAnimated:!1,navPointAnimated:!1,navPointImportantAnimated:!1,navTitleAnimated:!1,navTitleImportantAnimated:!1,navTransparentAnimated:!1,navTransparentImportantAnimated:!1,useTextureEnvironment:!0,usePaths:!1,antialias:!0,alpha:!1,premultipliedAlpha:!1},navs:{iconMinScale:1,iconMaxScale:1.4},profiles:{streamer:"480p_2",attendee:"1080p_2",publisher:"1080p_2",screen:"720p_2"},logo:null,selfServiceAudio:null,colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d","media"],disabledViewItemTypes:["texture"]},assets:"/Modules/B-Here/Client/docs/",dist:"/Modules/B-Here/Client/dist/",workers:{image:"/Modules/B-Here/Client/docs/js/workers/image.service.worker.js",prefetch:"/Modules/B-Here/Client/docs/js/workers/prefetch.service.worker.js"},textures:{envMap:"textures/envMap/studio_small_03_2k.hdr",grid:"textures/grid/grid.jpg"},toneMappingExposure:1,githubDocs:"https://raw.githubusercontent.com/actarian/b-here/beta-bhere-sso/docs/",template:{email:{supportRequest:"/template/modules/b-here/email/support-request.cshtml"}}};let M=Object.assign({port:5e3,fontFamily:"Work Sans, sans-serif",colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d","media"],disabledViewItemTypes:["texture"]},renderOrder:{panorama:0,room:10,plane:20,tile:30,model:40,banner:50,nav:60,panel:70,menu:80,debug:90,pointer:100}},P,D);M=C.merge(M,window.bhere);const x=new class{get STATIC(){return L.STATIC}set STATIC(t){L.STATIC=!0===t||"true"===t,console.log("Environment.STATIC.set",L.STATIC)}get href(){return O?this.githubDocs:this.assets}getAbsoluteUrl(t,e){let i=`${window.location.origin}${t}`;return Object.keys(e).forEach((t=>{i=i.replace(`$${t}`,e[t])})),i}getPath(t){return this.isLocal(t)?this.href+t:t}isLocal(t){return-1===t.indexOf("://")}merge(t){t&&C.merge(this,t)}constructor(t){t&&Object.assign(this,t)}}(M);console.log("environment",x);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var U=function(){return U=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},U.apply(this,arguments)},V=function(){return V=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},V.apply(this,arguments)},F=function(t){return void 0===t&&(t={}),{arrayFormat:t.arrayFormat||"none",booleanFormat:t.booleanFormat||"none",nullFormat:t.nullFormat||"default"}},B=function(t){return encodeURIComponent(t)},j=function(t){return decodeURIComponent(t)},H=function(t,e,i){return null===e?function(t,e){return"hidden"===e.nullFormat?"":"string"===e.nullFormat?t+"=null":t}(t,i):"boolean"==typeof e?function(t,e,i){return"empty-true"===i.booleanFormat&&e?t:t+"="+("unicode"===i.booleanFormat?e?"✓":"✗":e.toString())}(t,e,i):Array.isArray(e)?function(t,e,i){var n=function(t){return"index"===t.arrayFormat?function(t,e){return t+"["+e+"]"}:"brackets"===t.arrayFormat?function(t){return t+"[]"}:function(t){return t}}(i);return e.map((function(e,i){return n(t,i)+"="+B(e)})).join("&")}(t,e,i):t+"="+B(e)},G=function(t){var e=t.indexOf("?");return-1===e?t:t.slice(e+1)},W=function(t){var e=t.indexOf("["),i=-1!==e;return{hasBrackets:i,name:i?t.slice(0,e):t}},$=function(t,e){var i=F(e);return G(t).split("&").reduce((function(t,e){var n=e.split("="),s=n[0],o=n[1],r=W(s),a=r.hasBrackets,c=r.name,d=t[c],l=function(t,e){if(void 0===t)return"empty-true"===e.booleanFormat||null;if("string"===e.booleanFormat){if("true"===t)return!0;if("false"===t)return!1}if("unicode"===e.booleanFormat){if("✓"===j(t))return!0;if("✗"===j(t))return!1}return"string"===e.nullFormat&&"null"===t?null:j(t)}(o,i);return t[c]=void 0===d?a?[l]:l:(Array.isArray(d)?d:[d]).concat(l),t}),{})},z=function(t,e){var i=F(e);return Object.keys(t).filter((function(e){return void 0!==t[e]})).map((function(e){return H(e,t[e],i)})).filter(Boolean).join("&")},q=/[^!$'()*+,;|:]/g,K=function(t){return t.replace(q,(function(t){return encodeURIComponent(t)}))},Y={default:K,uri:encodeURI,uriComponent:encodeURIComponent,none:function(t){return t},legacy:encodeURI},J={default:decodeURIComponent,uri:decodeURI,uriComponent:decodeURIComponent,none:function(t){return t},legacy:decodeURIComponent},X=function(t,e,i){var n=Y[e]||K;return i?String(t).split("/").map(n).join("/"):n(String(t))},Z=function(t){return"("+(t?t.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~%':|=+\\*@$]+")+")"},Q=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(t){return new RegExp(Z(t[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^?]*)/},{name:"url-parameter-matrix",pattern:/^;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(t){return new RegExp(";"+t[1]+"="+Z(t[2]))}},{name:"query-parameter",pattern:/^(?:\?|&)(?::)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function(t){return new RegExp("\\"+t[0])}},{name:"sub-delimiter",pattern:/^(!|&|-|_|\.|;)/,regex:function(t){return new RegExp(t[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+)/,regex:function(t){return new RegExp(t[0])}}],tt=function t(e,i){if(void 0===i&&(i=[]),!Q.some((function(n){var s=e.match(n.pattern);return!!s&&(i.push({type:n.name,match:s[0],val:s.slice(1,2),otherVal:s.slice(2),regex:n.regex instanceof Function?n.regex(s):n.regex}),s[0].length<e.length&&(i=t(e.substr(s[0].length),i)),!0)})))throw new Error("Could not parse path '"+e+"'");return i},et=function(t){return null!=t},it={urlParamsEncoding:"default"},nt=function(){function t(t,e){if(!t)throw new Error("Missing path in Path constructor");this.path=t,this.options=V(V({},it),e),this.tokens=tt(t),this.hasUrlParams=this.tokens.filter((function(t){return/^url-parameter/.test(t.type)})).length>0,this.hasSpatParam=this.tokens.filter((function(t){return/splat$/.test(t.type)})).length>0,this.hasMatrixParams=this.tokens.filter((function(t){return/matrix$/.test(t.type)})).length>0,this.hasQueryParams=this.tokens.filter((function(t){return/^query-parameter/.test(t.type)})).length>0,this.spatParams=this.getParams("url-parameter-splat"),this.urlParams=this.getParams(/^url-parameter/),this.queryParams=this.getParams("query-parameter"),this.params=this.urlParams.concat(this.queryParams),this.source=this.tokens.filter((function(t){return void 0!==t.regex})).map((function(t){return t.regex.source})).join("")}return t.createPath=function(e,i){return new t(e,i)},t.prototype.isQueryParam=function(t){return-1!==this.queryParams.indexOf(t)},t.prototype.isSpatParam=function(t){return-1!==this.spatParams.indexOf(t)},t.prototype.test=function(t,e){var i=this,n=V(V({caseSensitive:!1,strictTrailingSlash:!1},this.options),e),s=function(t,e){return e||"\\/"===t?t:t.replace(/\\\/$/,"")+"(?:\\/)?"}(this.source,n.strictTrailingSlash),o=this.urlTest(t,s+(this.hasQueryParams?"(\\?.*$|$)":"$"),n.caseSensitive,n.urlParamsEncoding);if(!o||!this.hasQueryParams)return o;var r=$(t,n.queryParams);return 0===Object.keys(r).filter((function(t){return!i.isQueryParam(t)})).length?(Object.keys(r).forEach((function(t){return o[t]=r[t]})),o):null},t.prototype.partialTest=function(t,e){var i=this,n=V(V({caseSensitive:!1,delimited:!0},this.options),e),s=function(t,e){return e?/(\/)$/.test(t)?t:t+"(\\/|\\?|\\.|;|$)":t}(this.source,n.delimited),o=this.urlTest(t,s,n.caseSensitive,n.urlParamsEncoding);if(!o)return o;if(!this.hasQueryParams)return o;var r=$(t,n.queryParams);return Object.keys(r).filter((function(t){return i.isQueryParam(t)})).forEach((function(t){return function(t,e,i){void 0===i&&(i="");var n=t[e];return t[e]=void 0===n?i:Array.isArray(n)?n.concat(i):[n,i],t}(o,t,r[t])})),o},t.prototype.build=function(t,e){var i=this;void 0===t&&(t={});var n=V(V({ignoreConstraints:!1,ignoreSearch:!1,queryParams:{}},this.options),e),s=Object.keys(t).filter((function(t){return!i.isQueryParam(t)})).reduce((function(e,s){if(!et(t[s]))return e;var o=t[s],r=i.isSpatParam(s);return"boolean"==typeof o?e[s]=o:Array.isArray(o)?e[s]=o.map((function(t){return X(t,n.urlParamsEncoding,r)})):e[s]=X(o,n.urlParamsEncoding,r),e}),{});if(this.urlParams.some((function(e){return!et(t[e])}))){var o=this.urlParams.filter((function(e){return!et(t[e])}));throw new Error("Cannot build path: '"+this.path+"' requires missing parameters { "+o.join(", ")+" }")}if(!n.ignoreConstraints&&!this.tokens.filter((function(t){return/^url-parameter/.test(t.type)&&!/-splat$/.test(t.type)})).every((function(t){return new RegExp("^"+Z(t.otherVal[0])+"$").test(s[t.val])})))throw new Error("Some parameters of '"+this.path+"' are of invalid format");var r=this.tokens.filter((function(t){return!1===/^query-parameter/.test(t.type)})).map((function(t){return"url-parameter-matrix"===t.type?";"+t.val+"="+s[t.val[0]]:/^url-parameter/.test(t.type)?s[t.val[0]]:t.match})).join("");if(n.ignoreSearch)return r;var a=this.queryParams.filter((function(e){return-1!==Object.keys(t).indexOf(e)})).reduce((function(e,i){return e[i]=t[i],e}),{}),c=z(a,n.queryParams);return c?r+"?"+c:r},t.prototype.getParams=function(t){var e=t instanceof RegExp?function(e){return t.test(e.type)}:function(e){return e.type===t};return this.tokens.filter(e).map((function(t){return t.val[0]}))},t.prototype.urlTest=function(t,e,i,n){var s=this,o=new RegExp("^"+e,i?"":"i"),r=t.match(o);return r?this.urlParams.length?r.slice(1,this.urlParams.length+1).reduce((function(t,e,i){return t[s.urlParams[i]]=(J[n]||decodeURIComponent)(e),t}),{}):{}:null},t}(),st=function(t){var e="";return t.reduce((function(t,i){var n,s,o,r,a=null!=(s=null===(n=i.parser)||void 0===n?void 0:n.urlParams.reduce((function(t,e){return t[e]="url",t}),{}))?s:{},c=null!=(r=null===(o=i.parser)||void 0===o?void 0:o.queryParams.reduce((function(t,e){return t[e]="query",t}),a))?r:{};return void 0!==i.name&&(t[e=e?e+"."+i.name:i.name]=c),t}),{})},ot=function t(e,i,n,s,o){void 0===s&&(s={});for(var r=s.queryParamsMode,a=void 0===r?"default":r,c=s.strictTrailingSlash,d=void 0!==c&&c,l=s.strongMatching,h=void 0===l||l,u=s.caseSensitive,p=void 0!==u&&u,m=1===e.length&&""===e[0].name,g=function(e){var r,c=null,l=void 0,u=i;if("/"===o&&"/"===e.path&&(u="/"+i),e.children.length||(c=e.parser.test(u,{caseSensitive:p,strictTrailingSlash:d,queryParams:s.queryParams,urlParamsEncoding:s.urlParamsEncoding})),c||(c=e.parser.partialTest(u,{delimited:h,caseSensitive:p,queryParams:s.queryParams,urlParamsEncoding:s.urlParamsEncoding})),c){var g=e.parser.build(c,{ignoreSearch:!0,urlParamsEncoding:s.urlParamsEncoding});d||e.children.length||(g=g.replace(/\/$/,"")),l=0===u.toLowerCase().indexOf(g.toLowerCase())?u.slice(g.length):u,d||e.children.length||(l=l.replace(/^\/\?/,"?"));var f=function(t,e,i){var n=F(i);if(""===G(t))return{querystring:"",removedParams:{}};var s=t.split("&").reduce((function(t,i){var n=t[0],s=t[1],o=i.split("=")[0],r=W(o).name;return-1===e.indexOf(r)?[n.concat(i),s]:[n,s.concat(i)]}),[[],[]]),o=s[0],r=s[1];return{querystring:o.join("&"),removedParams:$(r.join("&"),n)}}((r=u.replace(g,""),r.split("?")[1]||""),e.parser.queryParams,s.queryParams).querystring;if(l=function(t){return t.split("?")[0]}(l)+(f?"?"+f:""),d||m||"/"!==l||/\/$/.test(g)||(l=""),n.segments.push(e),Object.keys(c).forEach((function(t){return n.params[t]=c[t]})),!m&&!l.length)return{value:n};if(!m&&"strict"!==a&&0===l.indexOf("?")){var v=$(l.slice(1),s.queryParams);return Object.keys(v).forEach((function(t){return n.params[t]=v[t]})),{value:n}}var _=e.getNonAbsoluteChildren();return _.length?{value:t(_,l,n,s,g)}:{value:null}}},f=0,v=e;f<v.length;f++){var _=g(v[f]);if("object"==typeof _)return _.value}return null};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var rt=function(t){return function(e,i){var n,s,o,r,a,c,d=e.path.replace(/<.*?>/g,"").split("?")[0].replace(/(.+)\/$/,"$1"),l=i.path.replace(/<.*?>/g,"").split("?")[0].replace(/(.+)\/$/,"$1");if("/"===d)return 1;if("/"===l)return-1;if(null===(n=e.parser)||void 0===n?void 0:n.hasSpatParam)return 1;if(null===(s=i.parser)||void 0===s?void 0:s.hasSpatParam)return-1;var h=(d.match(/\//g)||[]).length,u=(l.match(/\//g)||[]).length;if(h<u)return 1;if(h>u)return-1;var p=null!=(r=null===(o=e.parser)||void 0===o?void 0:o.urlParams.length)?r:0,m=null!=(c=null===(a=i.parser)||void 0===a?void 0:a.urlParams.length)?c:0;if(p<m)return-1;if(p>m)return 1;var g=(d.split("/").slice(-1)[0]||"").length,f=(l.split("/").slice(-1)[0]||"").length;return g<f?1:g>f?-1:t.indexOf(e)-t.indexOf(i)}},at=function(){function t(t,e,i,n){return void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=[]),void 0===n&&(n={}),this.name=t,this.absolute=/^~/.test(e),this.path=this.absolute?e.slice(1):e,this.parser=this.path?new nt(this.path):null,this.children=[],this.parent=n.parent,this.checkParents(),this.add(i,n.onAdd,!n.finalSort&&!1!==n.sort),n.finalSort&&this.sortDescendants(),this}return t.prototype.getParentSegments=function(t){return void 0===t&&(t=[]),this.parent&&this.parent.parser?this.parent.getParentSegments(t.concat(this.parent)):t.reverse()},t.prototype.setParent=function(t){this.parent=t,this.checkParents()},t.prototype.setPath=function(t){void 0===t&&(t=""),this.path=t,this.parser=t?new nt(t):null},t.prototype.add=function(e,i,n){var s=this;if(void 0===n&&(n=!0),null==e)return this;if(e instanceof Array)return e.forEach((function(t){return s.add(t,i,n)})),this;if(!(e instanceof t||e instanceof Object))throw new Error("RouteNode.add() expects routes to be an Object or an instance of RouteNode.");if(e instanceof t)e.setParent(this),this.addRouteNode(e,n);else{if(!e.name||!e.path)throw new Error("RouteNode.add() expects routes to have a name and a path defined.");var o=new t(e.name,e.path,e.children,{finalSort:!1,onAdd:i,parent:this,sort:n}),r=o.getParentSegments([o]).map((function(t){return t.name})).join(".");i&&i(U(U({},e),{name:r})),this.addRouteNode(o,n)}return this},t.prototype.addNode=function(e,i){return this.add(new t(e,i)),this},t.prototype.getPath=function(t){var e,i=this.getSegmentsByName(t);return i?(e=i)?e.map((function(t){return t.path})).join(""):null:null},t.prototype.getNonAbsoluteChildren=function(){return this.children.filter((function(t){return!t.absolute}))},t.prototype.sortChildren=function(){var t,e;this.children.length&&(t=this.children,e=t.slice(0),t.sort(rt(e)))},t.prototype.sortDescendants=function(){this.sortChildren(),this.children.forEach((function(t){return t.sortDescendants()}))},t.prototype.buildPath=function(t,e,i){void 0===e&&(e={}),void 0===i&&(i={});var n=this.getSegmentsByName(t);if(!n)throw new Error("[route-node][buildPath] '{routeName}' is not defined");return function(t,e,i){void 0===e&&(e={}),void 0===i&&(i={});for(var n=i.queryParamsMode,s=void 0===n?"default":n,o=i.trailingSlashMode,r=void 0===o?"default":o,a=[],c=[],d=0,l=t;d<l.length;d++){var h=l[d].parser;h&&(a.push.apply(a,h.queryParams),c.push.apply(c,h.urlParams),c.push.apply(c,h.spatParams))}if("loose"===s){var u=Object.keys(e).reduce((function(t,e){return-1===a.indexOf(e)&&-1===c.indexOf(e)?t.concat(e):t}),[]);a.push.apply(a,u)}var p=a.reduce((function(t,i){return-1!==Object.keys(e).indexOf(i)&&(t[i]=e[i]),t}),{}),m=z(p,i.queryParams),g=t.reduce((function(t,n){var s,o,r=null!=(o=null===(s=n.parser)||void 0===s?void 0:s.build(e,{ignoreSearch:!0,queryParams:i.queryParams,urlParamsEncoding:i.urlParamsEncoding}))?o:"";return n.absolute?r:t+r}),"").replace(/\/\/{1,}/g,"/"),f=g;return"always"===r?f=/\/$/.test(g)?g:g+"/":"never"===r&&"/"!==g&&(f=/\/$/.test(g)?g.slice(0,-1):g),f+(m?"?"+m:"")}(n,e,i)},t.prototype.buildState=function(t,e){void 0===e&&(e={});var i=this.getSegmentsByName(t);return i&&i.length?{name:t,params:e,meta:st(i)}:null},t.prototype.matchPath=function(t,e){void 0===e&&(e={}),""!==t||e.strictTrailingSlash||(t="/");var i=this.getSegmentsMatchingPath(t,e);if(!i)return null;var n=i.segments;if(n[0].absolute){var s=n[0].getParentSegments();n.reverse(),n.push.apply(n,s),n.reverse()}var o=n[n.length-1].findSlashChild();return o&&n.push(o),function(t){return t&&t.segments&&t.segments.length?{name:t.segments.map((function(t){return t.name})).filter((function(t){return t})).join("."),params:t.params,meta:st(t.segments)}:null}(i)},t.prototype.addRouteNode=function(t,e){void 0===e&&(e=!0);var i=t.name.split(".");if(1===i.length){if(-1!==this.children.map((function(t){return t.name})).indexOf(t.name))throw new Error('Alias "'+t.name+'" is already defined in route node');if(-1!==this.children.map((function(t){return t.path})).indexOf(t.path))throw new Error('Path "'+t.path+'" is already defined in route node');this.children.push(t),e&&this.sortChildren()}else{var n=this.getSegmentsByName(i.slice(0,-1).join("."));if(!n)throw new Error("Could not add route named '"+t.name+"', parent is missing.");t.name=i[i.length-1],n[n.length-1].add(t)}return this},t.prototype.checkParents=function(){if(this.absolute&&this.hasParentsParams())throw new Error("[RouteNode] A RouteNode with an abolute path cannot have parents with route parameters")},t.prototype.hasParentsParams=function(){if(this.parent&&this.parent.parser){var t=this.parent.parser;return t.hasUrlParams||t.hasSpatParam||t.hasMatrixParams||t.hasQueryParams||this.parent.hasParentsParams()}return!1},t.prototype.findAbsoluteChildren=function(){return this.children.reduce((function(t,e){return t.concat(e.absolute?e:[]).concat(e.findAbsoluteChildren())}),[])},t.prototype.findSlashChild=function(){return this.getNonAbsoluteChildren().filter((function(t){return t.parser&&/^\/(\?|$)/.test(t.parser.path)}))[0]},t.prototype.getSegmentsByName=function(t){var e=[],i=this.parser?[this]:this.children,n=(this.parser?[""]:[]).concat(t.split(".")).every((function(t){var n=function(t,e){var i=e.filter((function(e){return e.name===t}));return i.length?i[0]:void 0}(t,i);return!!n&&(i=n.children,e.push(n),!0)}));return n?e:null},t.prototype.getSegmentsMatchingPath=function(t,e){var i=(this.parser?[this]:this.children).reduce((function(t,e){return t.concat(e,e.findAbsoluteChildren())}),[]),n=ot(i,t,{segments:[],params:{}},e);return n&&1===n.segments.length&&""===n.segments[0].name?null:n},t}();var ct=function(t){var e,i=t.Symbol;return"function"==typeof i?i.observable?e=i.observable:(e=i("observable"),i.observable=e):e="@@observable",e}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),dt=function(t){return t.split(".").reduce((function(t,e){return t.concat(t.length?t[t.length-1]+"."+e:e)}),[])},lt=function(t){return t&&t.meta&&t.meta.params},ht=function(t,e){return lt(e)&&null!=e.meta.params[t]?Object.keys(e.meta.params[t]).reduce((function(t,i){return t[i]=e.params[i],t}),{}):{}};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var ut=function(){return ut=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},ut.apply(this,arguments)},pt={trailingSlashMode:"default",queryParamsMode:"default",strictTrailingSlash:!1,autoCleanUp:!0,allowNotFound:!1,strongMatching:!0,rewritePathOnMatch:!0,caseSensitive:!1,urlParamsEncoding:"default"};var mt="NOT_STARTED",gt="NO_START_PATH_OR_STATE",ft="ALREADY_STARTED",vt="ROUTE_NOT_FOUND",_t="SAME_STATES",Et="CANNOT_DEACTIVATE",St="CANNOT_ACTIVATE",Tt="TRANSITION_ERR",bt="CANCELLED",yt="@@router5/UNKNOWN_ROUTE",Ct="$start",wt="$stop",Rt="$$start",It="$$cancel",At="$$success",Ot="$$error";function Nt(t){var e=0,i=null;return t.getState=function(){return i},t.setState=function(t){i=t},t.makeState=function(i,n,s,o,r){return{name:i,params:ut(ut({},t.config.defaultParams[i]),n),path:s,meta:o?ut(ut({},o),{id:void 0===r?++e:r}):void 0}},t.makeNotFoundState=function(e,i){return t.makeState(yt,{path:e},e,{options:i})},t.areStatesEqual=function(e,i,n){if(void 0===n&&(n=!0),e.name!==i.name)return!1;var s=function(e){return t.rootNode.getSegmentsByName(e).map((function(t){return t.parser.urlParams})).reduce((function(t,e){return t.concat(e)}),[])},o=n?s(e.name):Object.keys(e.params),r=n?s(i.name):Object.keys(i.params);return o.length===r.length&&o.every((function(t){return e.params[t]===i.params[t]}))},t.areStatesDescendants=function(t,e){return!!new RegExp("^"+t.name+"\\.(.*)$").test(e.name)&&Object.keys(t.params).every((function(i){return t.params[i]===e.params[i]}))},t.forwardState=function(e,i){var n=t.config.forwardMap[e]||e;return{name:n,params:ut(ut(ut({},t.config.defaultParams[e]),t.config.defaultParams[n]),i)}},t.buildState=function(e,i){var n=t.forwardState(e,i),s=n.name,o=n.params;return t.rootNode.buildState(s,o)},t}var kt={onStart:Ct,onStop:wt,onTransitionSuccess:At,onTransitionStart:Rt,onTransitionError:Ot,onTransitionCancel:It};function Lt(t){var e=[];function i(e){var i=t.executeFactory(e),n=Object.keys(kt).map((function(e){if(i[e])return t.addEventListener(kt[e],i[e])})).filter(Boolean);return function(){n.forEach((function(t){return t()})),i.teardown&&i.teardown()}}return t.getPlugins=function(){return e},t.usePlugin=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var s=t.map((function(t){return e.push(t),i(t)}));return function(){e=e.filter((function(e){return-1===t.indexOf(e)})),s.forEach((function(t){return t()}))}},t}function Pt(t){var e=[],i=[];return t.useMiddleware=function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];var o=n.map((function(n){var s=t.executeFactory(n);return e.push(n),i.push(s),function(){e=e.filter((function(t){return t!==n})),i=i.filter((function(t){return t!==s}))}}));return function(){return o.forEach((function(t){return t()}))}},t.clearMiddleware=function(){return e=[],i=[],t},t.getMiddlewareFactories=function(){return e},t.getMiddlewareFunctions=function(){return i},t}function Dt(t){var e={};function i(e){var i="object"==typeof e,n=i?e.next.bind(e):e,s=t.addEventListener(At,(function(t,e){n({route:t,previousRoute:e})}));return i?{unsubscribe:s}:s}function n(){var t;return(t={subscribe:function(t){if("object"!=typeof t||null===t)throw new TypeError("Expected the observer to be an object.");return i(t)}})[ct]=function(){return this},t}return t.invokeEventListeners=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];(e[t]||[]).forEach((function(t){return t.apply(void 0,i)}))},t.removeEventListener=function(t,i){e[t]=e[t].filter((function(t){return t!==i}))},t.addEventListener=function(i,n){return e[i]=(e[i]||[]).concat(n),function(){return t.removeEventListener(i,n)}},t.subscribe=i,t[ct]=n,t["@@observable"]=n,t}function Mt(t,e,i){var n=e.isCancelled,s=e.toState,o=e.fromState,r=e.errorKey,a=void 0===r?void 0:r,c=Array.isArray(t)?t:Object.keys(t),d=function(t){return"object"==typeof t&&void 0!==t.name&&void 0!==t.params&&void 0!==t.path},l=function(t,e,i,s){var r=function(t,e){t?s(t):e&&e!==i&&d(e)?(function(t,e){return e.name!==t.name||e.params!==t.params||e.path!==t.path}(e,i)&&console.error("[router5][transition] Warning: state values (name, params, path) were changed during transition process."),s(null,function(t,e){return ut(ut(ut({},e),t),{meta:ut(ut({},e.meta),t.meta)})}(e,i))):s(null,i)},a=t.call(null,i,o,r);n()?r(null):"boolean"==typeof a?r(a?null:e):d(a)?r(null,a):a&&"function"==typeof a.then&&a.then((function(t){t instanceof Error?r({error:t},null):r(null,t)}),(function(t){t instanceof Error?(console.error(t.stack||t),r(ut(ut({},e),{promiseError:t}),null)):r("object"==typeof t?ut(ut({},e),t):e,null)}))},h=function(e,s){var o;if(n())i();else if(e)i(e);else if(c.length){var r="string"==typeof c[0],d=a&&r?((o={})[a]=c[0],o):{},u=r?t[c[0]]:c[0];c=c.slice(1),l(u,d,s,h)}else i(null,s)};h(null,s)}function xt(t,e,i,n,s){var o=!1,r=!1,a=t.getOptions(),c=t.getLifecycleFunctions(),d=c[0],l=c[1],h=t.getMiddlewareFunctions(),u=function(){return o},p=function(t,e){return ut(ut({},t),e instanceof Object?e:{error:e})},m=e.name===yt,g={isCancelled:u,toState:e,fromState:i},f=function(t,e){var i,n=t.meta&&t.meta&&t.meta.options||{},s=e?dt(e.name):[],o=dt(t.name),r=Math.min(s.length,o.length);i=!e||n.reload?0:lt(e)||lt(t)?function(){var i,n=function(){var n=s[i],r=o[i];if(n!==r)return{value:i};var a=ht(n,t),c=ht(r,e);return Object.keys(a).length!==Object.keys(c).length?{value:i}:0===Object.keys(a).length?"continue":Object.keys(a).some((function(t){return c[t]!==a[t]}))?{value:i}:void 0};for(i=0;i<r;i+=1){var a=n();if("object"==typeof a)return a.value}return i}():0;var a=s.slice(i).reverse(),c=o.slice(i);return{intersection:e&&i>0?s[i-1]:"",toDeactivate:a,toActivate:c}}(e,i),v=f.toDeactivate,_=f.toActivate,E=!i||n.forceDeactivate?[]:function(t,e,i){var n=v.filter((function(t){return d[t]})).reduce((function(t,e){var i;return ut(ut({},t),((i={})[e]=d[e],i))}),{});Mt(n,ut(ut({},g),{errorKey:"segment"}),(function(t){return i(t?p({code:Et},t):null)}))},S=m?[]:function(t,e,i){var n=_.filter((function(t){return l[t]})).reduce((function(t,e){var i;return ut(ut({},t),((i={})[e]=l[e],i))}),{});Mt(n,ut(ut({},g),{errorKey:"segment"}),(function(t){return i(t?p({code:St},t):null)}))},T=h.length?function(t,e,i){return Mt(h,ut({},g),(function(e,n){return i(e?p({code:Tt},e):null,n||t)}))}:[];return Mt([].concat(E).concat(S).concat(T),g,(function(i,n){if(r=!0,!u()){if(!i&&a.autoCleanUp){var o=dt(e.name);Object.keys(d).forEach((function(e){-1===o.indexOf(e)&&t.clearCanDeactivate(e)}))}s(i,n||e)}})),function(){o||r||(o=!0,s({code:bt},null))}}var Ut=function(){};function Vt(t){var e;function i(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var s=e[0],o=e[e.length-1],r="function"==typeof o?o:Ut,a="object"==typeof e[1]?e[1]:{},c="object"==typeof e[2]?e[2]:{};if(t.isStarted()){var d=t.buildState(s,a);if(!d)return r(l={code:vt}),void t.invokeEventListeners(Ot,null,t.getState(),l);var l,h=t.makeState(d.name,d.params,t.buildPath(d.name,d.params),{params:d.meta,options:c}),u=!!t.getState()&&t.areStatesEqual(t.getState(),h,!1);if(u&&!c.reload&&!c.force)return r(l={code:_t}),void t.invokeEventListeners(Ot,h,t.getState(),l);var p=t.getState();return c.skipTransition?(r(null,h),Ut):t.transitionToState(h,p,c,(function(e,n){if(e)if(e.redirect){var s=e.redirect;i(s.name,s.params,ut(ut({},c),{force:!0,redirected:!0}),r)}else r(e);else t.invokeEventListeners(At,n,p,c),r(null,n)}))}r({code:mt})}return t.navigate=i,t.navigate=i,t.navigateToDefault=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var s="object"==typeof e[0]?e[0]:{},o=2===e.length?e[1]:"function"==typeof e[0]?e[0]:Ut,r=t.getOptions();return r.defaultRoute?i(r.defaultRoute,r.defaultParams,s,o):function(){}},t.cancel=function(){return e&&(e("navigate"),e=null),t},t.transitionToState=function(i,n,s,o){return void 0===s&&(s={}),void 0===o&&(o=Ut),t.cancel(),t.invokeEventListeners(Rt,i,n),e=xt(t,i,n,s,(function(s,r){e=null,r=r||i,s?(s.code===bt?t.invokeEventListeners(It,i,n):t.invokeEventListeners(Ot,i,n,s),o(s)):(t.setState(r),o(null,r))}))},t}var Ft=function(){};function Bt(t){var e=!1;return t.isStarted=function(){return e},t.start=function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];var s,o,r=t.getOptions(),a=i[i.length-1],c="function"==typeof a?a:Ft,d="function"!=typeof i[0]?i[0]:void 0;if(e)return c({code:ft}),t;e=!0,t.invokeEventListeners(Ct);var l=function(e,i,n){void 0===n&&(n=!0),e||t.invokeEventListeners(At,i,null,{replace:!0}),e&&n&&t.invokeEventListeners(Ot,i,null,e),c(e,i)};if(void 0===d&&!r.defaultRoute)return l({code:gt});if("string"==typeof d?s=d:"object"==typeof d&&(o=d),o)t.setState(o),l(null,o);else{o=void 0===s?null:t.matchPath(s);var h=function(){return t.navigateToDefault({replace:!0},c)},u=function(e){return t.navigate(e.name,e.params,{replace:!0,reload:!0,redirected:!0},c)},p=function(e){t.transitionToState(e,t.getState(),{},(function(t,e){t?t.redirect?u(t.redirect):r.defaultRoute?h():l(t,null,!1):l(null,e)}))};o?p(o):r.defaultRoute?h():r.allowNotFound?p(t.makeNotFoundState(s,{replace:!0})):l({code:vt,path:s},null)}return t},t.stop=function(){return e&&(t.setState(null),e=!1,t.invokeEventListeners(wt)),t},t}var jt=function(t){return"function"==typeof t?t:function(){return function(){return t}}};function Ht(t){var e={},i={},n={},s={};return t.getLifecycleFactories=function(){return[e,i]},t.getLifecycleFunctions=function(){return[n,s]},t.canDeactivate=function(i,s){var o=jt(s);return e[i]=o,n[i]=t.executeFactory(o),t},t.clearCanDeactivate=function(i){return e[i]=void 0,n[i]=void 0,t},t.canActivate=function(e,n){var o=jt(n);return i[e]=o,s[e]=t.executeFactory(o),t},t}var Gt=function(t,e,i){void 0===t&&(t=[]),void 0===e&&(e={}),void 0===i&&(i={});return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return function(e){return t.reduce((function(t,e){return e(t)}),e)}}(function(t){return function(e){var i=ut(ut({},pt),t);return e.getOptions=function(){return i},e.setOption=function(t,n){return i[t]=n,e},e}}(e),function(t){return function(e){var i=t;return e.setDependency=function(t,n){return i[t]=n,e},e.setDependencies=function(t){return Object.keys(t).forEach((function(i){return e.setDependency(i,t[i])})),e},e.getDependencies=function(){return i},e.getInjectables=function(){return[e,e.getDependencies()]},e.executeFactory=function(t){return t.apply(void 0,e.getInjectables())},e}}(i),Dt,Nt,Bt,Ht,Vt,Lt,Pt,function(t){return function(e){e.forward=function(t,i){return e.config.forwardMap[t]=i,e};var i=t instanceof at?t:new at("","",t,{onAdd:n});function n(t){t.canActivate&&e.canActivate(t.name,t.canActivate),t.forwardTo&&e.forward(t.name,t.forwardTo),t.decodeParams&&(e.config.decoders[t.name]=t.decodeParams),t.encodeParams&&(e.config.encoders[t.name]=t.encodeParams),t.defaultParams&&(e.config.defaultParams[t.name]=t.defaultParams)}return e.rootNode=i,e.add=function(t,s){return i.add(t,n,!s),s&&i.sortDescendants(),e},e.addNode=function(t,n,s){return i.addNode(t,n),s&&e.canActivate(t,s),e},e.isActive=function(t,i,n,s){void 0===i&&(i={}),void 0===n&&(n=!1),void 0===s&&(s=!0);var o=e.getState();return!!o&&(n||o.name===t?e.areStatesEqual(e.makeState(t,i),o,s):e.areStatesDescendants(e.makeState(t,i),o))},e.buildPath=function(t,i){if(t===yt)return i.path;var n=ut(ut({},e.config.defaultParams[t]),i),s=e.getOptions(),o=s.trailingSlashMode,r=s.queryParamsMode,a=s.queryParams,c=e.config.encoders[t]?e.config.encoders[t](n):n;return e.rootNode.buildPath(t,c,{trailingSlashMode:o,queryParamsMode:r,queryParams:a,urlParamsEncoding:e.getOptions().urlParamsEncoding})},e.matchPath=function(t,i){var n=e.getOptions(),s=e.rootNode.matchPath(t,n);if(s){var o=s.name,r=s.params,a=s.meta,c=e.config.decoders[o]?e.config.decoders[o](r):r,d=e.forwardState(o,c),l=d.name,h=d.params,u=!1===n.rewritePathOnMatch?t:e.buildPath(l,h);return e.makeState(l,h,u,{params:a,source:i})}return null},e.setRootPath=function(t){e.rootNode.setPath(t)},e}}(t))({config:{decoders:{},encoders:{},defaultParams:{},forwardMap:{}}})},Wt=function(){return Wt=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},Wt.apply(this,arguments)};function $t(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),s=0;for(e=0;e<i;e++)for(var o=arguments[e],r=0,a=o.length;r<a;r++,s++)n[s]=o[r];return n}var zt=function(t){return function(){return t}},qt=function(){},Kt="undefined"!=typeof window&&window.history,Yt=function(t){try{return encodeURI(decodeURI(t))}catch(e){return t}},Jt=Kt?{getBase:function(){return window.location.pathname},pushState:function(t,e,i){return window.history.pushState(t,e,i)},replaceState:function(t,e,i){return window.history.replaceState(t,e,i)},addPopstateListener:function(t,e){var i=e.useHash&&!(-1===window.navigator.userAgent.indexOf("Trident"));return window.addEventListener("popstate",t),i&&window.addEventListener("hashchange",t),function(){window.removeEventListener("popstate",t),i&&window.removeEventListener("hashchange",t)}},getLocation:function(t){var e=t.useHash?window.location.hash.replace(new RegExp("^#"+t.hashPrefix),""):window.location.pathname.replace(new RegExp("^"+t.base),"");return(Yt(e)||"/")+window.location.search},getState:function(){return window.history.state},getHash:function(){return window.location.hash}}:{getBase:zt(""),pushState:qt,replaceState:qt,addPopstateListener:qt,getLocation:zt(""),getState:zt(null),getHash:zt("")},Xt={forceDeactivate:!0,useHash:!1,hashPrefix:"",base:"",mergeState:!1,preserveHash:!0},Zt="popstate";function Qt(t,e){void 0===e&&(e=Jt);var i,n=Wt(Wt({},Xt),t),s={forceDeactivate:n.forceDeactivate,source:Zt};return function(t){var o=t.getOptions(),r=t.start;t.buildUrl=function(e,i){return(n.base||"")+(n.useHash?"#"+n.hashPrefix:"")+t.buildPath(e,i)};function a(t,i,s){var o=t?{meta:t.meta,name:t.name,params:t.params,path:t.path}:t,r=!0===n.mergeState?Wt(Wt({},e.getState()),o):o;s?e.replaceState(r,"",i):e.pushState(r,"",i)}function c(i){var r=t.getState(),c=!i.state||!i.state.name,d=c?t.matchPath(e.getLocation(n),Zt):t.makeState(i.state.name,i.state.params,i.state.path,Wt(Wt({},i.state.meta),{source:Zt}),i.state.meta.id),l=o.defaultRoute,h=o.defaultParams;d?r&&t.areStatesEqual(d,r,!1)||t.transitionToState(d,r,s,(function(e,i){if(e)if(e.redirect){var n=e.redirect,o=n.name,u=n.params;t.navigate(o,u,Wt(Wt({},s),{replace:!0,force:!0,redirected:!0}))}else if(e.code===Et){var p=t.buildUrl(r.name,r.params);c||a(d,p,!0)}else l&&t.navigate(l,h,Wt(Wt({},s),{reload:!0,replace:!0}));else t.invokeEventListeners(At,i,r,{replace:!0})})):l&&t.navigateToDefault(Wt(Wt({},s),{reload:!0,replace:!0}))}function d(){i&&(i(),i=void 0)}return t.matchUrl=function(e){return t.matchPath(function(t){var e=t.match(/^(?:http|https):\/\/(?:[0-9a-z_\-.:]+?)(?=\/)(.*)$/),i=(e?e[1]:t).match(/^(.+?)(#.+?)?(\?.+)?$/);if(!i)throw new Error("[router5] Could not parse url "+t);var s=i[1],o=i[2]||"",r=i[3]||"";return(n.useHash?o.replace(new RegExp("^#"+n.hashPrefix),""):n.base?s.replace(new RegExp("^"+n.base),""):s)+r}(e))},t.start=function(){for(var i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];return 0===i.length||"function"==typeof i[0]?r.apply(void 0,$t([e.getLocation(n)],i)):r.apply(void 0,i),t},t.replaceHistoryState=function(i,n,s){void 0===n&&(n={}),void 0===s&&(s="");var o=t.buildState(i,n),r=t.makeState(o.name,o.params,t.buildPath(o.name,o.params),{params:o.meta}),a=t.buildUrl(i,n);t.lastKnownState=r,e.replaceState(r,s,a)},{onStart:function(){n.useHash&&!n.base&&(n.base=e.getBase()),i=e.addPopstateListener(c,n)},onStop:d,teardown:d,onTransitionSuccess:function(i,s,o){var r=e.getState(),c=r&&r.meta&&r.name&&r.params,d=s&&t.areStatesEqual(s,i,!1),l=o.replace||!c||d,h=t.buildUrl(i.name,i.params);null===s&&!1===n.useHash&&!0===n.preserveHash&&(h+=e.getHash()),a(i,h,l)},onPopState:c}}}class te{static get router(){return this.router_}static get route(){let t=null;const e=this.router_;return e&&(t=e.getState()),t}static useBrowser(t){if(!Array.isArray(t)||!t.length)return void(this.event$=i.EMPTY);this.routes=t;const e=Gt(t,{allowNotFound:!1,autoCleanUp:!0,defaultRoute:"index",defaultParams:{},queryParams:{arrayFormat:"default",nullFormat:"default",booleanFormat:"default"},queryParamsMode:"default",trailingSlashMode:"default",strictTrailingSlash:!1,caseSensitive:!1,urlParamsEncoding:"default"});this.router_=e,e.usePlugin(Qt({useHash:!1})),e.start(),this.event$=i.from(e).pipe(n.startWith({route:e.getState(),previousRoute:null}))}static useBrowser$(t){return this.useBrowser(t),this.event$}static setRouterLink(t,e,i){void 0===t&&(t="it.access"),void 0===e&&(e=null),void 0===i&&(i={reload:!0});const n=this.router_;if(n)try{n.navigate(t,e,i)}catch(t){console.log("RouterService.setRouterLink.error",t)}}static replaceHistoryState(t,e){const i=this.router_;if(i)try{i.replaceHistoryState(t,e)}catch(t){console.log("RouterService.replaceHistoryState.error",t)}}static setCurrentParams(t){const e=this.router_;if(e)try{const i=this.route;i&&e.replaceHistoryState(i.name,t)}catch(t){console.log("RouterService.setCurrentParams.error",t)}}static buildPath(t,e){void 0===e&&(e=null);let i=null;const n=this.router_;if(n)try{i=n.buildPath(t,e)}catch(t){console.log("RouterService.buildPath.error",t)}return i}static buildUrl(t,e){void 0===e&&(e=null);let i=null;const n=this.router_;if(n)try{i=n.buildUrl(t,e)}catch(t){console.log("RouterService.buildUrl.error",t)}return i}static isActive(t,e,i,n){void 0===i&&(i=!1),void 0===n&&(n=!0);let s=!1;const o=this.router_;if(o)try{s=o.isActive(t,e,i,n)}catch(t){console.log("RouterService.isActive.error",t)}return s}}te.routes=[],te.router_=null;class ee{static set state(t){this.state$.next(t)}static get state(){return this.state$.getValue()}static patchState(t){t=Object.assign({},this.state,t),this.state=t}}ee.state$=new i.BehaviorSubject({});const ie={Publisher:"publisher",Attendee:"attendee",Streamer:"streamer",Viewer:"viewer",SmartDevice:"smart-device",SelfService:"self-service",Embed:"embed"};class ne{constructor(t){t&&Object.assign(this,t)}}const se=/^\d{9}-\d{4}-\d{13}(-\d+)?$/;class oe{get roleIndex(){return oe.getRoleIndex(this.role)}set roleIndex(t){if(oe.getRoleIndex(this.role)!==t){const e=Object.keys(ie)[t];this.role=ie[e]}}constructor(t){if(this.userId=ee.state.user?ee.state.user.id:0,this.role=ee.state.role||ie.Viewer,this.timestamp=(new Date).valueOf().toString(),this.pathId=null,"string"==typeof t){if(!t.match(se))return console.warn("MeetingId","invalid meetingId",t),null;t=oe.decompose(t)}"object"==typeof t&&(t.id&&(this.id=t.id),t.userId&&(this.userId=t.userId),t.role&&(this.role=t.role),t.roleIndex&&(this.roleIndex=t.roleIndex),t.timestamp&&(this.timestamp=t.timestamp),t.pathId&&(this.pathId=t.pathId))}toString(){return oe.compose(this.userId,this.roleIndex,this.timestamp,this.pathId)}toRoles(){const t=this.userId,e=this.timestamp,i=this.pathId;return{id:oe.compose(t,oe.getRoleIndex(ie.Publisher),e,i),idAttendee:oe.compose(t,oe.getRoleIndex(ie.Attendee),e,i),idStreamer:oe.compose(t,oe.getRoleIndex(ie.Streamer),e,i),idViewer:oe.compose(t,oe.getRoleIndex(ie.Viewer),e,i),idSmartDevice:oe.compose(t,oe.getRoleIndex(ie.SmartDevice),e,i),idSelfService:oe.compose(t,oe.getRoleIndex(ie.SelfService),e,i)}}static compose(t,e,i,n){return`${oe.padded(t,9)}-${oe.padded(e,4)}-${i}${n?`-${n}`:""}`}static decompose(t){const e=t.split("-");return{userId:parseInt(e[0]),roleIndex:parseInt(e[1]),timestamp:parseInt(e[2]),pathId:e[3]?parseInt(e[3]):null}}static generateMeetingId(){return(new oe).toRoles()}static getRoleIndex(t){return Object.keys(ie).reduce(((e,i,n)=>ie[i]===t?n:e),-1)}static padded(t,e){const i="000000000000"+t;return i.substring(i.length-e)}}class re{get meetingId(){return this.link?new oe(this.link):null}constructor(t){if("string"==typeof(t=t||window.location.href)&&(t=re.decompose(t)),"object"==typeof t){if(Object.assign(this,t),t.user){const e=re.getName(t.user);if(e&&(this.name=e),x.flags.useExtendedUserInfo){const e=re.getFirstName(t.user);e&&(this.firstName=e);const i=re.getLastName(t.user);i&&(this.lastName=i);const n=re.getEmail(t.user);n&&(this.email=n)}}t.name&&(this.name=t.name),x.flags.useExtendedUserInfo&&(t.firstName&&(this.firstName=t.firstName),t.lastName&&(this.lastName=t.lastName),t.email&&(this.email=t.email))}this.link=this.link||null,this.name=this.name||null,this.firstName=this.firstName||null,this.lastName=this.lastName||null,this.email=this.email||null,this.role=this.role||null,this.viewId=this.viewId||null,this.pathId=this.pathId||null,this.embedViewId=this.embedViewId||null,this.support=this.support||!1}toParams(t){void 0===t&&(t=!1);let e={};return this.link&&(e.link=this.link),x.flags.useExtendedUserInfo?(this.firstName&&(e.firstName=this.firstName),this.lastName&&(e.lastName=this.lastName),this.email&&(e.email=this.email)):this.name&&(e.name=this.name),this.role&&!t&&(e.role=this.role),this.viewId&&(e.viewId=this.viewId),this.pathId&&(e.pathId=this.pathId),this.support&&(e.support=this.support),x.flags.useEncryptedUrl&&(e={p:re.encrypt(e)}),e}toString(t){let e;return void 0===t&&(t=!1),e=x.flags.useExtendedUserInfo?{link:this.link,firstName:this.firstName,lastName:this.lastName,email:this.email,role:t?null:this.role,viewId:this.viewId,pathId:this.pathId,support:this.support}:{link:this.link,name:this.name,role:t?null:this.role,viewId:this.viewId,pathId:this.pathId,support:this.support},re.compose(e)}toUrl(){const t=this.toParams();return re.getCurrentUrl(t)}toAccessCodeUrl(){const t=this.toParams();return re.getAccessCodeUrl(t)}toGuidedTourUrl(){const t=this.toParams();return re.getGuidedTourUrl(t)}copyToClipBoard(t){void 0===t&&(t=!1);const e=document.createElement("input");e.style.position="absolute",e.style.top="1000vh",document.querySelector("body").appendChild(e);const i=this.toParams(!0);e.value=window.location.origin+(t?re.getAccessCodeUrl(i):re.getGuidedTourUrl(i)),e.focus(),e.select(),e.setSelectionRange(0,99999),document.execCommand("copy"),e.parentNode.removeChild(e),alert(`link copiato!\n ${e.value}`)}replaceUrl(){te.setCurrentParams(this.toParams())}static replaceWithOptions(t){const e=re.decompose(window.location.href),i=new re(Object.assign(e,t));return i.replaceUrl(),i}static replaceWithUser(t){return this.replaceWithOptions({user:t})}static replaceWithName(t){return this.replaceWithOptions({name:t})}static replaceWithLink(t){return this.replaceWithOptions({link:t})}static getCurrentUrl(t){void 0===t&&(t=null);const e=te.route;if(e){const i=e.name;return te.buildUrl(i,t)}}static getAccessCodeUrl(t){void 0===t&&(t=null);const e=te.route;if(e){const i=`${e.params.lang}.accessCode`;return te.buildUrl(i,t)}}static getGuidedTourUrl(t){void 0===t&&(t=null);const e=te.route;if(e){const i=`${e.params.lang}.guidedTour`;return te.buildUrl(i,t)}}static getName(t){return t&&t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:null}static getFirstName(t){return t&&t.firstName?t.firstName:null}static getLastName(t){return t&&t.lastName?t.lastName:null}static getEmail(t){return t&&t.email?t.email:null}static compose(t){if(x.flags.useEncryptedUrl){return`?p=${re.encrypt(t)}`}return`?${(t=Object.keys(t).map((e=>({key:e,value:t[e]}))).filter((t=>null!=t.value&&!1!==t.value)).map((t=>`${t.key}=${t.value}`))).join("&")}`}static decompose(t){let e={};if(x.flags.useEncryptedUrl){const i=new URLSearchParams(t.split("?")[1]);i.has("p")&&(e=re.decrypt(i.get("p")))}else if(t.indexOf("?")>-1){new URLSearchParams(t.split("?")[1]).forEach(((t,i)=>{switch(i){case"viewId":case"pathId":case"embedViewId":t=t?parseInt(t):null;break;case"support":t=!!t&&"true"===t}e[i]=t}))}return e}static decrypt(t){return JSON.parse(window.atob(t))}static encrypt(t){return window.btoa(JSON.stringify(t))}static validateParams(t){if(x.flags.useEncryptedUrl){return{p:re.encrypt(t)}}return t}}class ae extends t.Structure{getFactory(t){let e=null;const i=te.routes.find((e=>e.name===t.name));return i&&(e=i.factory),e}onInit(){this.route$().pipe(n.switchMap((t=>this.factory$(t))),n.takeUntil(this.unsubscribe$)).subscribe((t=>{}))}route$(){return te.event$.pipe(n.map((t=>{const e=t.route;return this.route=e,e})))}factory$(e){const s=this.getFactory(e),{module:o,node:r}=t.getContext(this);return this.factory_=s,i.of(s).pipe(n.tap((()=>{this.element&&(this.element.parentNode.removeChild(this.element),o.remove(this.element,this),this.element=void 0,this.instance=void 0)})),n.map((()=>{if(s&&s.meta.template){let t=document.createElement("div");t.innerHTML=s.meta.template,1===t.children.length&&(t=t.firstElementChild),r.appendChild(t);const i=o.makeInstance(t,s,s.meta.selector,this,void 0,{route:e});return o.compile(t,i),this.instance=i,this.element=t,{element:t,instance:i}}})))}onChanges(){}}ae.meta={selector:"router-outlet,[router-outlet]",hosts:{host:ae}};class ce extends t.Component{onInit(){this.state={};const e=new re;if(e.link){const i=e.toGuidedTourUrl(),{node:n}=t.getContext(this);new QRious({element:n.querySelector(".qrcode"),value:i,size:256})}else window.location.href=window.location.origin+re.getGuidedTourUrl()}}function de(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function le(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?de(Object(i),!0).forEach((function(e){he(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):de(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function he(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}ce.meta={selector:"[access-code-component]",hosts:{host:ae},template:`\n\t\t<div class="page page--access-code">\n\t\t\t${f}\n\t\t\t\x3c!-- access-code --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t<div class="title" [innerHTML]="'access_code_title' | label"></div>\n\t\t\t\t\t\t<div class="picture">\n\t\t\t\t\t\t\t<canvas class="qrcode"></canvas>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t${v}\n\t\t\t${_}\n\t\t\t${S}\n\t\t</div>\n\t`};class ue extends t.Component{get group(){if(this.formGroup)return this.formGroup;if(!this.host)throw"missing form collection";return this.host.control}getControl(t){return this.group.get(t)}}function pe(t){return new e.FormGroup(function(t){const i=t.reduce(((t,i,n)=>{const s=[];if(i.required&&s.push("checkbox"===i.type?e.Validators.RequiredTrueValidator():e.Validators.RequiredValidator()),"email"===i.type&&s.push(e.Validators.EmailValidator()),"url"===i.type&&s.push(e.Validators.PatternValidator("(https?://(?:www.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9].[^s]{2,}|www.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9].[^s]{2,}|https?://(?:www.|(?!www))[a-zA-Z0-9]+.[^s]{2,}|www.[a-zA-Z0-9]+.[^s]{2,})")),null!=i.pattern&&s.push(e.Validators.PatternValidator(i.pattern)),t[i.name]=new e.FormControl(null!=i.value?i.value:null,s),"select"===i.type||"custom-select"===i.type){const e=(i.options||[]).slice();e.unshift({id:null,name:"select"}),t[i.name].options=e}return t}),{});return i}(t))}function me(t,e){const i=t.reduce(((t,e,i)=>(e.test&&(t[e.name]=e.test),t)),{});e.patch(i)}ue.meta={selector:"[controls]",inputs:["formGroup","fields"],hosts:{host:e.FormAbstractCollectionDirective},template:'\n\t\t<div *for="let field of fields">\n\t\t\t<div *if="[\'text\', \'email\', \'url\'].indexOf(field.type) !== -1" control-text [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'select\'" control-select [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'custom-select\'" control-custom-select [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'textarea\'" control-textarea [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'checkbox\'" control-checkbox [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<input *if="field.type == \'hidden\'" [name]="field.name" [formControl]="getControl(field.name)" value="" type="text" style="display:none !important;" />\n\t\t</div>\n\t'};class ge extends t.Pipe{static get labels(){return x.labels}static transform(t){if("@copy"===t)return this.getCopy();const e=ge.labels;let i=null!=e[t]?e[t]:t;return"string"==typeof i&&-1!==i.indexOf("@copy")&&(i=i.replace("@copy",this.getCopy())),i}static getKeys(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return ge.transform(e.map((t=>t.replace("-","_"))).join("_"))}static getCopy(){return`©${(new Date).getFullYear()}`}}ge.meta={name:"label"};class fe{static has(t){return new URLSearchParams(window.location.search).has(t)}static get(t){return new URLSearchParams(window.location.search).get(t)}static set(t,e){const i=new URLSearchParams(window.location.search);"string"==typeof t?i.set(t,e):i.set(t,""),this.pushParams(i)}static delete(t){const e=new URLSearchParams(window.location.search);e.has(t)&&(e.delete(t),this.pushParams(e))}static pushParams(t){if(window.history&&window.history.pushState){const e=document.title,i=`${window.location.href.split("?")[0]}?${t.toString()}`;window.history.pushState(t.toString(),e,i)}}static replace(t,e){const i=window.history;if(i&&i.replaceState){const n=window.location,s=document.title;if("/"===n.pathname){const t=n.origin+e+n.search;i.replaceState(i.state,s,t)}else if(-1!==n.href.indexOf(t)){const o=n.href.replace(t,e);i.replaceState(i.state,s,o)}}}static deserialize(t){const e=this.get("params");return this.decode(t,e)}static serialize(t,e){const i=this.deserialize(),n=this.encode(t,e,i);this.set("params",n)}static decode(t,e){let i=null;if(e){const t=window.atob(e);i=JSON.parse(t)}return t&&i&&(i=i[t]),i||null}static encode(t,e,i){i=i||{};let n=null;"string"==typeof t?i[t]=e:i=t;const s=JSON.stringify(i);return n=window.btoa(s),n}}class ve{static get lang(){return this.lang$.getValue()}static set lang(t){this.lang!==t&&this.lang$.next(t)}static setAlternates(t,e){this.languages=e,this.lang=t}static setRoute(t,e){const i=t.params.lang,n=x.languages.map((n=>{const s="it"===n?"Italiano":"English",o=t.name.replace(new RegExp(`(^${i}$)|(^${i}.)`),((t,e,i,s)=>e?n:`${n}.`)),r=e.find((t=>t.name===o));return r?{name:r.name,params:t.params,href:r.path,lang:r.defaultParams.lang,title:s}:null})).filter((t=>null!==t));this.setAlternates(i,n)}static get hasLanguages(){return this.languages.length>1}static get activeLanguage(){return this.languages.find((t=>t.lang===this.lang))}static getDefaultLanguages(){return x.alternates||[]}static getDefaultLanguage(){return x.defaultLanguage||(this.languages?this.languages[0].lang:null)}static setLanguage(t){this.lang=t.lang}static setLanguage$(t){if("string"==typeof t&&(t=this.languages.find((e=>e.lang===t))),!t)return;const e=x.flags.production?`/api/${t.lang}/labels/`:`./api/${t.lang}/labels.json`;return i.from(fetch(e).then((t=>t.json()))).pipe(n.tap((e=>{x.labels=e,te.replaceHistoryState(t.name,t.params);const i=this.activeLanguage.href.split("?")[0],n=t.href.split("?")[0];fe.replace(i,n),this.lang=t.lang})))}static setLanguage$_(t){return i.from(fetch(t.href).then((t=>t.text()))).pipe(n.tap((e=>{const i=/(window\.labels\s*=\s*\n*\s*\{((\{.+?\})|.)+?\})/gms.exec(e);i&&(new Function(i[0]).call(window),ge.setLabels());const n=/(window\.bhere\s*=\s*\n*\s*\{((\{.+?\})|.)+?\})/gms.exec(e);if(n){const t={};new Function(n[0].replace("window","this")).call(t),t.bhere&&C.merge(x,t.bhere)}fe.replace(this.activeLanguage.href,t.href),this.lang=t.lang})))}static toggleLanguages(){this.showLanguages=!this.showLanguages,this.pushChanges()}}ve.languages=ve.getDefaultLanguages(),ve.lang$=new i.BehaviorSubject(ve.getDefaultLanguage());class _e extends t.Pipe{static transform(t){return t.replace(":lang",ve.lang)}}_e.meta={name:"route"};const Ee=[["480p_1",640,480,15,500,!0],["480p_2",640,480,30,1e3,!0],["480p_3",480,480,15,400,!0],["480p_4",640,480,30,750,!0],["480p_6",480,480,30,600,!0],["480p_8",848,480,15,610,!0],["480p_9",848,480,30,930,!0],["480p_10",640,480,10,400,!0],["720p_1",1280,720,15,1130,!0],["720p_2",1280,720,30,2e3,!0],["720p_3",1280,720,30,1710,!0],["720p_5",960,720,15,910,!0],["720p_6",960,720,30,1380,!0],["1080p_1",1920,1080,15,2080,!1],["1080p_2",1920,1080,30,3e3,!1],["1080p_3",1920,1080,30,3150,!1],["1080p_5",1920,1080,60,4780,!1]].map((t=>({profile:t[0],resolution:{width:t[1],height:t[2]},frameRate:{min:t[3],max:t[3]},bitrate:{min:t[4],max:t[4]},compatible:t[5]})));function Se(t){let e=x.profiles.streamer;switch(t.role){case ie.Publisher:case ie.SmartDevice:e=x.profiles.publisher||x.profiles.streamer;break;case ie.Attendee:e=x.profiles.attendee||x.profiles.streamer}return Ee.find((t=>t.profile===e))}const Te="idle",be="checklist",ye="link",Ce="login",we="name",Re="device",Ie="should-connect",Ae="connecting",Oe="connected",Ne="addLike",ke="agoraEvent",Le="channelMembers",Pe="chatMessage",De="chatTypingBegin",Me="chatTypingEnd",xe="controlInfo",Ue="currentTimeMedia",Ve="menuToggle",Fe="mode",Be="navInfo",je="navLink",He="navLinkClose",Ge="navToGrid",We="navToView",$e="playMedia",ze="playModel",qe="remoteSilencing",Ke="requestControl",Ye="requestControlDismiss",Je="requestSpy",Xe="requestSpyDismiss",Ze="selectItem",Qe="setSnapshot",ti="showPanel",ei="slideChange",ii="supportRequest",ni="supportRequestAccepted",si="supportRequestRejected",oi="vrEnded",ri="vrStarted",ai="vrState",ci="zoomMedia",di="virtual-tour",li="live-meeting",hi="self-service-tour",ui="embed",pi="none";class mi{constructor(t){Object.assign(this,t)}}class gi extends mi{}class fi extends mi{}class vi extends mi{}class _i extends mi{}class Ei extends mi{}class Si extends mi{}class Ti extends mi{}class bi extends mi{}class yi{static http$(t,e,s,o){let r=null;return i.from(fetch(e,{method:t,headers:{Accept:"application/json","Content-Type":"application/json"},body:-1!==["POST","PUT","PATCH"].indexOf(t)?JSON.stringify(s):void 0}).then((t=>{r=t;try{const e=t.headers.get("content-type");let i;return i=e&&-1!==e.indexOf("application/json")?t.json():t.text(),t.ok?i:i.then((t=>Promise.reject(t)))}catch(e){return t.ok?(console.warn("HttpService.http$","Cannot parse response"),Promise.resolve()):Promise.reject(e)}}))).pipe(n.catchError((t=>i.throwError(this.getError(t,r)))))}static get$(t,e,i){const n=this.query(e);return this.http$("GET",`${t}${n}`,void 0,i)}static delete$(t){return this.http$("DELETE",t)}static post$(t,e){return this.http$("POST",t,e)}static put$(t,e){return this.http$("PUT",t,e)}static patch$(t,e){return this.http$("PATCH",t,e)}static query(t){return""}static getError(t,e){let i="object"==typeof t?t:{};return i.status||(i.status=e?e.status:0),i.statusCode||(i.statusCode=e?e.status:0),i.statusMessage||(i.statusMessage=e?e.statusText:t),i}}class Ci{static setUser(t){this.user$.next(t)}static me$(){return yi.get$("/api/user/me").pipe(n.map((t=>this.mapUser(t))),n.catchError((t=>{if(404===t.status||404===t.statusCode)return i.of(null);throw t})),n.switchMap((t=>(this.setUser(t),this.user$))))}static login$(t){return yi.post$("/api/user/login",t).pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(t))))}static logout$(){return yi.get$("/api/user/logout").pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(null))))}static guidedTour$(t){return yi.post$("/api/user/guided-tour",t).pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(t))))}static selfServiceTour$(t){return yi.post$("/api/user/self-service-tour",t).pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(t))))}static selfServiceSupportRequest$(t,e,i){const s={user:t,meetingId:e,link:i};return yi.post$("/api/user/self-service-support-request",s).pipe(n.tap((e=>{x.flags.production||fetch(x.template.email.supportRequest).then((t=>t.text())).then((e=>{e=(e=e.replace("{{username}}",re.getName(t))).replace("{{href}}",i);const n=(new DOMParser).parseFromString(e,"text/html");setTimeout((()=>{const t=window.open();t.document.head.innerHTML=n.querySelector("head").innerHTML,t.document.body.innerHTML=n.querySelector("body").innerHTML}),3e3)}))})))}static resolve$(t,e){return"login"===e?this.login$(t):"guided-tour"===e?this.guidedTour$(t):"self-service-tour"===e?this.selfServiceTour$(t):void 0}static log$(t){return yi.post$("/api/user/log",t)}static temporaryUser$(t){return void 0===t&&(t=ie.Embed),i.of({id:this.uuid(),type:t,username:t}).pipe(n.map((t=>this.mapUser(t))),n.switchMap((t=>(this.setUser(t),this.user$))))}static overrideUser$(t){return void 0===t&&(t=ie.Embed),this.me$().pipe(n.switchMap((e=>e?(e.type=t,e.username=t,this.user$):this.temporaryUser$(t))))}static uuid(){return(new Date).getTime()}static mapUser(t){return new ne(t)}static getMode(t){let e;switch(t){case ie.Attendee:case ie.Streamer:case ie.Viewer:case ie.Publisher:e=di;break;case ie.SelfService:e=hi;break;case ie.SmartDevice:e=li;break;case ie.Embed:e=ui;break;default:e=pi}return e}}Ci.user$=new i.BehaviorSubject(null);let wi=0;class Ri{constructor(t){t&&Object.assign(this,t)}toJson(){return JSON.stringify(this)}static newEvent(t,e,i){console.log("WebhookEvent.newEvent",t,e,i);const n=new Ri,s=(new Date).getTime();return n.timestamp=s,n.id=`${s}-${++wi}`,n.action=t,n.data=e,i&&(n.extra="string"==typeof i?JSON.parse(i):i),ee.state.link&&(n.meetingId=ee.state.link,n.userSessionId=ee.state.uid,n.userRole=ee.state.role,n.fullName=ee.state.name),n}static parseEvent(t){if(t&&"data"in t){const e="string"==typeof t.data?JSON.parse(t.data):t.data;return"action"in e?new Ri(e):null}return null}}class Ii{static internal$_(t){return i.of(t).pipe(n.tap((t=>{console.log("WebhookService.internal$_.postMessage",t),window.parent&&window.parent.postMessage(t.action,t.toJson())})),n.switchMap((t=>this.event$_.pipe(n.filter((t=>t.id==t.id)),n.first()))),n.map((e=>(console.log("WebhookService.internal$_.handleResponse_",t,e),this.handleResponse_(t,e)))),n.catchError((e=>this.handleError_(t,e))))}static send$_(t,e){return yi.post$(t,e).pipe(n.map((t=>this.handleResponse_(e,t))),n.catchError((t=>this.handleError_(e,t))))}static send$(t,e,n){if(console.log("WebhookService.send$",t,e,n),this.enabled){const s=Ri.newEvent(t,e,n),o=x.webhook.uris.map((t=>"internal"===t?this.internal$_(s):this.send$_(t,s)));return i.forkJoin(o)}return i.of(null)}static handleResponse_(t,e){console.log("WebhookService.handleResponse_",e);const i=Object.assign({},t);return i.remoteStatus=1,i.remoteResponse=e,i}static handleError_(t,e){const n=Object.assign({},t);return n.remoteStatus=0,n.remoteError=e,i.of(n)}static get enabled(){const t=x.webhook,e=t&&t.uris&&t.uris.length>0;return e&&(t.methods=t.methods||{},t.methods.nav=t.methods.nav||[]),e}}Ii.event$_=i.fromEvent(window,"message").pipe(n.map((t=>Ri.parseEvent(t))),n.filter((t=>null!==t)),n.shareReplay(1));class Ai extends t.Component{onInit(){this.state={status:"access"},window.onSSOPopupClose=t=>{"success"===t?(alert("Login Successful"),Ci.me$().pipe(n.first()).subscribe((t=>{const e=_e.transform(":lang.selfServiceTour"),i=x.pathMapper&&x.pathMapper.ssoLogin?x.pathMapper.ssoLogin(t):null;i?te.setRouterLink(e,re.validateParams({pathId:i})):te.setRouterLink(e)}))):alert("Login Failed")}}onSelfServiceTourRequest(){this.initRequestForm(),this.state.status="self-service-tour",this.pushChanges(),N&&-1!==window.navigator.userAgent.indexOf("OculusBrowser")&&(this.test(),this.onSubmit())}onGuidedTourRequest(){this.initRequestForm(),this.state.status="guided-tour",this.pushChanges()}onSSOLogin(t){const e=`${location.protocol}//${location.host}/sso/login`;return window.open(e,"BHere | SSO Login","left=20,top=20,width=600,height=600,toolbar=1,resizable=0"),t.preventDefault(),!1}onSSORegister(t){const e=`${location.protocol}//${location.host}/sso/register`;return window.open(e,"BHere | SSO Register","left=20,top=20,width=600,height=600,toolbar=1,resizable=0"),t.preventDefault(),!1}onGuidedTourAccess(){Ci.logout$().pipe(n.first()).subscribe((()=>{te.setRouterLink(_e.transform(":lang.guidedTour"))}))}onLogin(){this.initLoginForm(),this.state.status="login",this.pushChanges()}initRequestForm(){this.formSubscription&&this.formSubscription.unsubscribe();const t=this.data=x.data||{roles:[{id:1,name:"Show room"},{id:2,name:"Architetto"},{id:3,name:"Interior designer"},{id:4,name:"Privato"},{id:5,name:"Altro"}]},e=this.fields=x.fields||[{type:"text",name:"firstName",label:"access_first_name",required:!0,test:"Jhon"},{type:"text",name:"lastName",label:"access_last_name",required:!0,test:"Appleseed"},{type:"email",name:"email",label:"access_email",required:!0,test:"jhonappleseed@gmail.com"},{type:"custom-select",name:"role",label:"access_role",required:!0,options:t.roles,test:t.roles[0].id},{type:"checkbox",name:"privacy",label:"access_privacy_disclaimer",required:!0,test:!0}];e.push({type:"hidden",name:"checkField",value:"",test:""}),x.antiforgery&&e.push({type:"none",name:"checkRequest",value:x.antiforgery,test:x.antiforgery});const i=this.form=pe(e);this.controls=i.controls,this.formSubscription=i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),this.error=null}initLoginForm(){this.formSubscription&&this.formSubscription.unsubscribe();const t=this.form=new e.FormGroup({username:new e.FormControl(null,e.Validators.RequiredValidator()),password:new e.FormControl(null,e.Validators.RequiredValidator()),checkRequest:window.antiforgery||"",checkField:""});this.controls=t.controls,this.formSubscription=t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),this.error=null}test(){"login"===this.state.status?this.form.patch({username:"publisher",password:"publisher",checkRequest:window.antiforgery||"",checkField:""}):me(this.fields,this.form)}reset(){this.form.reset()}onBack(){this.state.status="access",this.pushChanges()}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e=le({},t),i=this.controls;Object.keys(e).forEach((t=>{if(i[t].options){const n=i[t].options;e[t]=n.find((i=>i.id===e[t])).name}}));const s=this.state.status;Ci.resolve$(t,s).pipe(n.first()).subscribe((t=>{switch(s){case"guided-tour":this.onHandleHook("GuidedTour",e).pipe(n.first()).subscribe((t=>{this.state.status="guided-tour-success",this.pushChanges()}));break;case"self-service-tour":this.onHandleHook("SelfServiceTour",e).pipe(n.first()).subscribe((e=>{const i=_e.transform(":lang.selfServiceTour"),n=x.pathMapper&&x.pathMapper.selfService?x.pathMapper.selfService(t):null;n?te.setRouterLink(i,re.validateParams({pathId:n})):te.setRouterLink(i)}));break;case"login":te.setRouterLink(_e.transform(":lang.guidedTour"))}this.form.reset()}),(t=>{console.log("AccessComponent.error",t),this.error=t,this.pushChanges()}))}else this.form.touched=!0}isValid(){return this.form.valid}onHandleHook(t,e){const i=e;return Ii.send$(t,i,null)}}Ai.meta={selector:"[access-component]",hosts:{host:ae},template:`\n\t\t<div class="page page--access">\n\t\t\t\x3c!-- background --\x3e\n\t\t\t<div class="background" [class]="{ 'background--image': ('background.image' | env), 'background--video': ('background.video' | env) }" *if="state.status != 'connected'">\n\t\t\t\t<img [src]="'background.image' | env | asset" *if="'background.image' | env" />\n\t\t\t\t<video [src]="'background.video' | env | asset" *if="'background.video' | env" oncanplay="this.muted = true; this.classList.add('ready');" playsinline autoplay muted loop></video>\n\t\t\t</div>\n\t\t\t\x3c!-- access --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'access'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t<div class="title" [innerHTML]="'access_title' | label"></div>\n\t\t\t\t\t\t<div *if="'selfService' | flag">\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onSelfServiceTourRequest($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_tour' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_or' | label" *if="('guidedTourRequest' | flag) || ('guidedTourAccess' | flag)"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'guidedTourRequest' | flag">\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onGuidedTourRequest($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_guided_tour' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'guidedTourAccess' | flag">\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_has_meeting_id' | label"></div>\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onGuidedTourAccess($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_guided_tour_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'ssoLogin' | flag">\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_sso_login_info' | label"></div>\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onSSOLogin($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_sso_login_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'ssoRegister' | flag">\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_sso_register_info' | label"></div>\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onSSORegister($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_sso_register_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- guided-tour --\x3e\n\t\t\t<div class="ui ui--info" *if="state.status == 'self-service-tour' || state.status == 'guided-tour'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t\t<div class="title" *if="state.status == 'self-service-tour'" [innerHTML]="'access_fill_fields' | label"></div>\n\t\t\t\t\t\t\t<div class="title" *if="state.status == 'guided-tour'" [innerHTML]="'access_guided_tour_request' | label"></div>\n\t\t\t\t\t\t\t\x3c!-- controls --\x3e\n\t\t\t\t\t\t\t<div controls [formGroup]="form" [fields]="fields"></div>\n\t\t\t\t\t\t\t<div class="group--error" *if="error">\n\t\t\t\t\t\t\t\t<span class="status-code" [innerHTML]="error.statusCode"></span>\n\t\t\t\t\t\t\t\t<span class="status-message" [innerHTML]="error.statusMessage"></span>\n\t\t\t\t\t\t\t\t<span class="friendly-message" [innerHTML]="error.friendlyMessage"></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\x3c!-- <div class="info" *if="isValid()" [innerHTML]="'access_take_part' | label"></div> --\x3e\n\t\t\t\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t\t\t\t<span *if="!form.submitted" [innerHTML]="'access_send' | label"></span>\n\t\t\t\t\t\t\t\t<span *if="form.submitted" [innerHTML]="'access_sent' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="btn--mode" (click)="onBack($event)">\n\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_back' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- guided-tour success --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'guided-tour-success'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t<div class="title" [innerHTML]="'access_request_sent' | label"></div>\n\t\t\t\t\t\t<div class="info" [innerHTML]="'access_info_request' | label"></div>\n\t\t\t\t\t\t<button type="button" class="btn--mode" (click)="onBack($event)">\n\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t\t\t<span [innerHTML]="'access_back' | label"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- login --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'login'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="'access_login' | label"></div>\n\t\t\t\t\t\t\t<input name="checkField" [formControl]="controls.checkField" value="" type="text" style="display:none !important;" />\n\t\t\t\t\t\t\t<div control-text [control]="controls.username" [label]="'access_username' | label"></div>\n\t\t\t\t\t\t\t<div control-password [control]="controls.password" [label]="'access_password' | label"></div>\n\t\t\t\t\t\t\t<div class="group--error" *if="error">\n\t\t\t\t\t\t\t\t<span class="status-code" [innerHTML]="error.statusCode"></span>\n\t\t\t\t\t\t\t\t<span class="status-message" [innerHTML]="error.statusMessage"></span>\n\t\t\t\t\t\t\t\t<span class="friendly-message" [innerHTML]="error.friendlyMessage"></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="'access_cta' | label"></div>\n\t\t\t\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="btn--mode" (click)="onBack($event)">\n\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_back' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<header>\n\t\t\t\t\x3c!-- logo --\x3e\n\t\t\t\t<div class="btn--logo" (click)="onBack($event)">\n\t\t\t\t\t<img [src]="'logo' | env" *if="'logo' | env" />\n\t\t\t\t\t<svg viewBox="0 0 270 98" *if="!('logo' | env)"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t</div>\n\t\t\t\t${S}\n\t\t\t</header>\n\t\t\t<footer>\n\t\t\t\t<span class="group--colophon" *if="state.status != 'connected'">\n\t\t\t\t\t${_}\n\t\t\t\t\t${E}\n\t\t\t\t</span>\n\t\t\t\t\x3c!-- login --\x3e\n\t\t\t\t<button type="button" class="btn--absolute" (click)="onLogin($event)" *if="state.status == 'access'">\n\t\t\t\t\t<span [innerHTML]="'access_cta' | label"></span> <svg class="lock" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#lock"></use></svg>\n\t\t\t\t</button>\n\t\t\t</footer>\n\t\t</div>\n\t`};class Oi{static emoji$(){return null!=Oi.items_?i.of(Oi.items_):yi.get$(`${x.assets}api/emoji/emoji.json`).pipe(n.map((t=>(Oi.items_=t,t))))}}class Ni extends t.Component{onInit(){this.items=[],Oi.emoji$().pipe(n.first()).subscribe((t=>{setTimeout((()=>{this.items=t,this.pushChanges()}),1)}))}onSelect(t){this.emoji.next(t)}onClose(t){this.close.next()}}Ni.meta={selector:"[agora-chat-emoji]",outputs:["emoji","close"]};class ki{static message(t){this.message$.next(t)}static in(t){this.in$.next(t)}static sendBack(t){t=Object.assign({},t,{remoteId:t.clientId}),this.in$.next(t)}static out(t){this.out$.next(t)}}ki.message$=new i.ReplaySubject(1),ki.in$=new i.ReplaySubject(1),ki.send=ki.in,ki.out$=new i.ReplaySubject(1);var Li="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Pi(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Di={exports:{}};!function(t,e){t.exports=function(){function t(t,e){return e.forEach((function(e){e&&"string"!=typeof e&&!Array.isArray(e)&&Object.keys(e).forEach((function(i){if("default"!==i&&!(i in t)){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})}}))})),Object.freeze(t)}let e=!0,i=!0;function n(t,e,i){const n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function s(t,e,i){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(t,n){if(t!==e)return s.apply(this,arguments);const o=t=>{const e=i(t);e&&(n.handleEvent?n.handleEvent(e):n(e))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(n,o),s.apply(this,[t,o])};const o=n.removeEventListener;n.removeEventListener=function(t,i){if(t!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(i))return o.apply(this,arguments);const n=this._eventMap[e].get(i);return this._eventMap[e].delete(i),0===this._eventMap[e].size&&delete this._eventMap[e],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[t,n])},Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(t){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),t&&this.addEventListener(e,this["_on"+e]=t)},enumerable:!0,configurable:!0})}function o(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(e=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function r(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(i=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function a(){if("object"==typeof window){if(e)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function c(t,e){i&&console.warn(t+" is deprecated, please use "+e+" instead.")}function d(t){return"[object Object]"===Object.prototype.toString.call(t)}function l(t){return d(t)?Object.keys(t).reduce((function(e,i){const n=d(t[i]),s=n?l(t[i]):t[i],o=n&&!Object.keys(s).length;return void 0===s||o?e:Object.assign(e,{[i]:s})}),{}):t}function h(t,e,i){e&&!i.has(e.id)&&(i.set(e.id,e),Object.keys(e).forEach((n=>{n.endsWith("Id")?h(t,t.get(e[n]),i):n.endsWith("Ids")&&e[n].forEach((e=>{h(t,t.get(e),i)}))})))}function u(t,e,i){const n=i?"outbound-rtp":"inbound-rtp",s=new Map;if(null===e)return s;const o=[];return t.forEach((t=>{"track"===t.type&&t.trackIdentifier===e.id&&o.push(t)})),o.forEach((e=>{t.forEach((i=>{i.type===n&&i.trackId===e.id&&h(t,i,s)}))})),s}const p=a;function m(t,e){const i=t&&t.navigator;if(!i.mediaDevices)return;const n=function(t){if("object"!=typeof t||t.mandatory||t.optional)return t;const e={};return Object.keys(t).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof t[i]?t[i]:{ideal:t[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const s=function(t,e){return t?t+e.charAt(0).toUpperCase()+e.slice(1):"deviceId"===e?"sourceId":e};if(void 0!==n.ideal){e.optional=e.optional||[];let t={};"number"==typeof n.ideal?(t[s("min",i)]=n.ideal,e.optional.push(t),t={},t[s("max",i)]=n.ideal,e.optional.push(t)):(t[s("",i)]=n.ideal,e.optional.push(t))}void 0!==n.exact&&"number"!=typeof n.exact?(e.mandatory=e.mandatory||{},e.mandatory[s("",i)]=n.exact):["min","max"].forEach((t=>{void 0!==n[t]&&(e.mandatory=e.mandatory||{},e.mandatory[s(t,i)]=n[t])}))})),t.advanced&&(e.optional=(e.optional||[]).concat(t.advanced)),e},s=function(t,s){if(e.version>=61)return s(t);if((t=JSON.parse(JSON.stringify(t)))&&"object"==typeof t.audio){const e=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])};e((t=JSON.parse(JSON.stringify(t))).audio,"autoGainControl","googAutoGainControl"),e(t.audio,"noiseSuppression","googNoiseSuppression"),t.audio=n(t.audio)}if(t&&"object"==typeof t.video){let o=t.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const r=e.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||r)){let e;if(delete t.video.facingMode,"environment"===o.exact||"environment"===o.ideal?e=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(e=["front"]),e)return i.mediaDevices.enumerateDevices().then((i=>{let r=(i=i.filter((t=>"videoinput"===t.kind))).find((t=>e.some((e=>t.label.toLowerCase().includes(e)))));return!r&&i.length&&e.includes("back")&&(r=i[i.length-1]),r&&(t.video.deviceId=o.exact?{exact:r.deviceId}:{ideal:r.deviceId}),t.video=n(t.video),p("chrome: "+JSON.stringify(t)),s(t)}))}t.video=n(t.video)}return p("chrome: "+JSON.stringify(t)),s(t)},o=function(t){return e.version>=64?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(t,e,n){s(t,(t=>{i.webkitGetUserMedia(t,e,(t=>{n&&n(o(t))}))}))}.bind(i),i.mediaDevices.getUserMedia){const t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(e){return s(e,(e=>t(e).then((t=>{if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((t=>{t.stop()})),new DOMException("","NotFoundError");return t}),(t=>Promise.reject(o(t))))))}}}function g(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function f(t){if("object"==typeof t&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",(i=>{let n;n=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===i.track.id)):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[e.stream],this.dispatchEvent(s)})),e.stream.getTracks().forEach((i=>{let n;n=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===i.id)):{track:i};const s=new Event("track");s.track=i,s.receiver=n,s.transceiver={receiver:n},s.streams=[e.stream],this.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else s(t,"track",(t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t)))}function v(t){if("object"==typeof t&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(t,e){return{track:e,get dtmf(){return void 0===this._dtmf&&("audio"===e.kind?this._dtmf=t.createDTMFSender(e):this._dtmf=null),this._dtmf},_pc:t}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,n){let s=i.apply(this,arguments);return s||(s=e(this,t),this._senders.push(s)),s};const n=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){n.apply(this,arguments);const e=this._senders.indexOf(t);-1!==e&&this._senders.splice(e,1)}}const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._senders=this._senders||[],i.apply(this,[t]),t.getTracks().forEach((t=>{this._senders.push(e(this,t))}))};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){this._senders=this._senders||[],n.apply(this,[t]),t.getTracks().forEach((t=>{const e=this._senders.find((e=>e.track===t));e&&this._senders.splice(this._senders.indexOf(e),1)}))}}else if("object"==typeof t&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function _(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[t,i,n]=arguments;if(arguments.length>0&&"function"==typeof t)return e.apply(this,arguments);if(0===e.length&&(0===arguments.length||"function"!=typeof t))return e.apply(this,[]);const s=function(t){const e={};return t.result().forEach((t=>{const i={id:t.id,timestamp:t.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};t.names().forEach((e=>{i[e]=t.stat(e)})),e[i.id]=i})),e},o=function(t){return new Map(Object.keys(t).map((e=>[e,t[e]])))};if(arguments.length>=2){const n=function(t){i(o(s(t)))};return e.apply(this,[n,t])}return new Promise(((t,i)=>{e.apply(this,[function(e){t(o(s(e)))},i])})).then(i,n)}}function E(t){if(!("object"==typeof t&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){const t=this;return this._pc.getStats().then((e=>u(e,t.track,!0)))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),s(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){const t=this;return this._pc.getStats().then((e=>u(e,t.track,!1)))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const t=arguments[0];let e,i,n;return this.getSenders().forEach((i=>{i.track===t&&(e?n=!0:e=i)})),this.getReceivers().forEach((e=>(e.track===t&&(i?n=!0:i=e),e.track===t))),n||e&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):e?e.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function S(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((t=>this._shimmedLocalStreams[t][0]))};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,i){if(!i)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=e.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._shimmedLocalStreams=this._shimmedLocalStreams||{},t.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")}));const e=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter((t=>-1===e.indexOf(t)));this._shimmedLocalStreams[t.id]=[t].concat(n)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[t.id],n.apply(this,arguments)};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},t&&Object.keys(this._shimmedLocalStreams).forEach((e=>{const i=this._shimmedLocalStreams[e].indexOf(t);-1!==i&&this._shimmedLocalStreams[e].splice(i,1),1===this._shimmedLocalStreams[e].length&&delete this._shimmedLocalStreams[e]})),s.apply(this,arguments)}}function T(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return S(t);const i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const t=i.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((t=>this._reverseStreams[t.id]))};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(e){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},e.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[e.id]){const i=new t.MediaStream(e.getTracks());this._streams[e.id]=i,this._reverseStreams[i.id]=e,e=i}n.apply(this,[e])};const s=t.RTCPeerConnection.prototype.removeStream;function o(t,e){let i=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e],s=t._streams[n.id];i=i.replace(new RegExp(s.id,"g"),n.id)})),new RTCSessionDescription({type:e.type,sdp:i})}t.RTCPeerConnection.prototype.removeStream=function(t){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[t.id]||t]),delete this._reverseStreams[this._streams[t.id]?this._streams[t.id].id:t.id],delete this._streams[t.id]},t.RTCPeerConnection.prototype.addTrack=function(e,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((t=>t===e)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const s=this._streams[i.id];if(s)s.addTrack(e),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const n=new t.MediaStream([e]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find((t=>t.track===e))},["createOffer","createAnswer"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){const t=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[e=>{const i=o(this,e);t[0].apply(null,[i])},e=>{t[1]&&t[1].apply(null,e)},arguments[2]]):i.apply(this,arguments).then((t=>o(this,t)))}};t.RTCPeerConnection.prototype[e]=n[e]}));const r=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(t,e){let i=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e],s=t._streams[n.id];i=i.replace(new RegExp(n.id,"g"),s.id)})),new RTCSessionDescription({type:e.type,sdp:i})}(this,arguments[0]),r.apply(this,arguments)):r.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const t=a.get.apply(this);return""===t.type?t:o(this,t)}}),t.RTCPeerConnection.prototype.removeTrack=function(t){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!t._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(t._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let e;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((e=>t.track===e))&&(e=this._streams[i])})),e&&(1===e.getTracks().length?this.removeStream(this._reverseStreams[e.id]):e.removeTrack(t.track),this.dispatchEvent(new Event("negotiationneeded")))}}function b(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}))}function y(t,e){s(t,"negotiationneeded",(t=>{const i=t.target;if(!(e.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return t}))}var C=Object.freeze({__proto__:null,fixNegotiationNeeded:y,shimAddTrackRemoveTrack:T,shimAddTrackRemoveTrackWithNative:S,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&("function"==typeof e?t.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then((e=>{const n=i.video&&i.video.width,s=i.video&&i.video.height,o=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxFrameRate:o||3}},n&&(i.video.mandatory.maxWidth=n),s&&(i.video.mandatory.maxHeight=s),t.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:v,shimGetStats:_,shimGetUserMedia:m,shimMediaStream:g,shimOnTrack:f,shimPeerConnection:b,shimSenderReceiverGetStats:E});function w(t,e){const i=t&&t.navigator,n=t&&t.MediaStreamTrack;if(i.getUserMedia=function(t,e,n){c("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(t).then(e,n)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const t=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])},e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),t(i.audio,"autoGainControl","mozAutoGainControl"),t(i.audio,"noiseSuppression","mozNoiseSuppression")),e(i)},n&&n.prototype.getSettings){const e=n.prototype.getSettings;n.prototype.getSettings=function(){const i=e.apply(this,arguments);return t(i,"mozAutoGainControl","autoGainControl"),t(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const e=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),t(i,"autoGainControl","mozAutoGainControl"),t(i,"noiseSuppression","mozNoiseSuppression")),e.apply(this,[i])}}}}function R(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function I(t,e){if("object"!=typeof t||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[t,s,o]=arguments;return n.apply(this,[t||null]).then((t=>{if(e.version<53&&!s)try{t.forEach((t=>{t.type=i[t.type]||t.type}))}catch(e){if("TypeError"!==e.name)throw e;t.forEach(((e,n)=>{t.set(n,Object.assign({},e,{type:i[e.type]||e.type}))}))}return t})).then(s,o)}}function A(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender)return;if(t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function O(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender)return;if(t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),s(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function N(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(t){c("removeStream","removeTrack"),this.getSenders().forEach((e=>{e.track&&t.getTracks().includes(e.track)&&this.removeTrack(e)}))})}function k(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function L(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let t=arguments[1]&&arguments[1].sendEncodings;void 0===t&&(t=[]),t=[...t];const i=t.length>0;i&&t.forEach((t=>{if("rid"in t&&!/^[a-z0-9]{0,16}$/i.test(t.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in t&&!(parseFloat(t.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in t&&!(parseFloat(t.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=e.apply(this,arguments);if(i){const{sender:e}=n,i=e.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=t,e.sendEncodings=t,this.setParametersPromises.push(e.setParameters(i).then((()=>{delete e.sendEncodings})).catch((()=>{delete e.sendEncodings}))))}return n})}function P(t){if("object"!=typeof t||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const t=e.apply(this,arguments);return"encodings"in t||(t.encodings=[].concat(this.sendEncodings||[{}])),t})}function D(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}function M(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}var x=Object.freeze({__proto__:null,shimAddTransceiver:L,shimCreateAnswer:M,shimCreateOffer:D,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const t=new DOMException("getDisplayMedia without video constraints is undefined");return t.name="NotFoundError",t.code=8,Promise.reject(t)}return!0===i.video?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:P,shimGetUserMedia:w,shimOnTrack:R,shimPeerConnection:I,shimRTCDataChannel:k,shimReceiverGetStats:O,shimRemoveStream:N,shimSenderGetStats:A});function U(t){if("object"==typeof t&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(t){this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getAudioTracks().forEach((i=>e.call(this,i,t))),t.getVideoTracks().forEach((i=>e.call(this,i,t)))},t.RTCPeerConnection.prototype.addTrack=function(t,...i){return i&&i.forEach((t=>{this._localStreams?this._localStreams.includes(t)||this._localStreams.push(t):this._localStreams=[t]})),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const e=this._localStreams.indexOf(t);if(-1===e)return;this._localStreams.splice(e,1);const i=t.getTracks();this.getSenders().forEach((t=>{i.includes(t.track)&&this.removeTrack(t)}))})}}function V(t){if("object"==typeof t&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=t=>{t.streams.forEach((t=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(t))return;this._remoteStreams.push(t);const e=new Event("addstream");e.stream=t,this.dispatchEvent(e)}))})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((e=>{if(t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.indexOf(e)>=0)return;t._remoteStreams.push(e);const i=new Event("addstream");i.stream=e,t.dispatchEvent(i)}))}),e.apply(t,arguments)}}}function F(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,i=e.createOffer,n=e.createAnswer,s=e.setLocalDescription,o=e.setRemoteDescription,r=e.addIceCandidate;e.createOffer=function(t,e){const n=arguments.length>=2?arguments[2]:arguments[0],s=i.apply(this,[n]);return e?(s.then(t,e),Promise.resolve()):s},e.createAnswer=function(t,e){const i=arguments.length>=2?arguments[2]:arguments[0],s=n.apply(this,[i]);return e?(s.then(t,e),Promise.resolve()):s};let a=function(t,e,i){const n=s.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n};e.setLocalDescription=a,a=function(t,e,i){const n=o.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n},e.setRemoteDescription=a,a=function(t,e,i){const n=r.apply(this,[t]);return i?(n.then(e,i),Promise.resolve()):n},e.addIceCandidate=a}function B(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=t=>i(j(t))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(t,i,n){e.mediaDevices.getUserMedia(t).then(i,n)}.bind(e))}function j(t){return t&&void 0!==t.video?Object.assign({},t,{video:l(t.video)}):t}function H(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(t,i){if(t&&t.iceServers){const e=[];for(let i=0;i<t.iceServers.length;i++){let n=t.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(c("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,e.push(n)):e.push(t.iceServers[i])}t.iceServers=e}return new e(t,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function G(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function W(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(t){if(t){void 0!==t.offerToReceiveAudio&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);const e=this.getTransceivers().find((t=>"audio"===t.receiver.track.kind));!1===t.offerToReceiveAudio&&e?"sendrecv"===e.direction?e.setDirection?e.setDirection("sendonly"):e.direction="sendonly":"recvonly"===e.direction&&(e.setDirection?e.setDirection("inactive"):e.direction="inactive"):!0!==t.offerToReceiveAudio||e||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==t.offerToReceiveVideo&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);const i=this.getTransceivers().find((t=>"video"===t.receiver.track.kind));!1===t.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==t.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function $(t){"object"!=typeof t||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var z=Object.freeze({__proto__:null,shimAudioContext:$,shimCallbacksAPI:F,shimConstraints:j,shimCreateOfferLegacy:W,shimGetUserMedia:B,shimLocalStreamsAPI:U,shimRTCIceServerUrls:H,shimRemoteStreamsAPI:V,shimTrackEventTransceiver:G}),q="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==Li?Li:"undefined"!=typeof self?self:{};function K(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Y={exports:{}};!function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split("\n").map((t=>t.trim()))},e.splitSections=function(t){return t.split("\nm=").map(((t,e)=>(e>0?"m="+t:t).trim()+"\r\n"))},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter((t=>0===t.indexOf(i)))},e.parseCandidate=function(t){let e;e=0===t.indexOf("a=candidate:")?t.substring(12).split(" "):t.substring(10).split(" ");const i={foundation:e[0],component:{1:"rtp",2:"rtcp"}[e[1]]||e[1],protocol:e[2].toLowerCase(),priority:parseInt(e[3],10),ip:e[4],address:e[4],port:parseInt(e[5],10),type:e[7]};for(let t=8;t<e.length;t+=2)switch(e[t]){case"raddr":i.relatedAddress=e[t+1];break;case"rport":i.relatedPort=parseInt(e[t+1],10);break;case"tcptype":i.tcpType=e[t+1];break;case"ufrag":i.ufrag=e[t+1],i.usernameFragment=e[t+1];break;default:void 0===i[e[t]]&&(i[e[t]]=e[t+1])}return i},e.writeCandidate=function(t){const e=[];e.push(t.foundation);const i=t.component;"rtp"===i?e.push(1):"rtcp"===i?e.push(2):e.push(i),e.push(t.protocol.toUpperCase()),e.push(t.priority),e.push(t.address||t.ip),e.push(t.port);const n=t.type;return e.push("typ"),e.push(n),"host"!==n&&t.relatedAddress&&t.relatedPort&&(e.push("raddr"),e.push(t.relatedAddress),e.push("rport"),e.push(t.relatedPort)),t.tcpType&&"tcp"===t.protocol.toLowerCase()&&(e.push("tcptype"),e.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(e.push("ufrag"),e.push(t.usernameFragment||t.ufrag)),"candidate:"+e.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let e=t.substring(9).split(" ");const i={payloadType:parseInt(e.shift(),10)};return e=e[0].split("/"),i.name=e[0],i.clockRate=parseInt(e[1],10),i.channels=3===e.length?parseInt(e[2],10):1,i.numChannels=i.channels,i},e.writeRtpMap=function(t){let e=t.payloadType;void 0!==t.preferredPayloadType&&(e=t.preferredPayloadType);const i=t.channels||t.numChannels||1;return"a=rtpmap:"+e+" "+t.name+"/"+t.clockRate+(1!==i?"/"+i:"")+"\r\n"},e.parseExtmap=function(t){const e=t.substring(9).split(" ");return{id:parseInt(e[0],10),direction:e[0].indexOf("/")>0?e[0].split("/")[1]:"sendrecv",uri:e[1],attributes:e.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&"sendrecv"!==t.direction?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+"\r\n"},e.parseFmtp=function(t){const e={};let i;const n=t.substring(t.indexOf(" ")+1).split(";");for(let t=0;t<n.length;t++)i=n[t].trim().split("="),e[i[0].trim()]=i[1];return e},e.writeFmtp=function(t){let e="",i=t.payloadType;if(void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const n=[];Object.keys(t.parameters).forEach((e=>{void 0!==t.parameters[e]?n.push(e+"="+t.parameters[e]):n.push(e)})),e+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return e},e.parseRtcpFb=function(t){const e=t.substring(t.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}},e.writeRtcpFb=function(t){let e="",i=t.payloadType;return void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach((t=>{e+="a=rtcp-fb:"+i+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"})),e},e.parseSsrcMedia=function(t){const e=t.indexOf(" "),i={ssrc:parseInt(t.substring(7,e),10)},n=t.indexOf(":",e);return n>-1?(i.attribute=t.substring(e+1,n),i.value=t.substring(n+1)):i.attribute=t.substring(e+1),i},e.parseSsrcGroup=function(t){const e=t.substring(13).split(" ");return{semantics:e.shift(),ssrcs:e.map((t=>parseInt(t,10)))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){const e=t.substring(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,e){let i="a=setup:"+e+"\r\n";return t.fingerprints.forEach((t=>{i+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"})),i},e.parseCryptoLine=function(t){const e=t.substring(9).split(" ");return{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+("object"==typeof t.keyParams?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+"\r\n"},e.parseCryptoKeyParams=function(t){if(0!==t.indexOf("inline:"))return null;const e=t.substring(7).split("|");return{keyMethod:"inline",keySalt:e[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:void 0,mkiLength:e[2]?e[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const n=e.matchPrefix(t+i,"a=ice-ufrag:")[0],s=e.matchPrefix(t+i,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(t){let e="a=ice-ufrag:"+t.usernameFragment+"\r\na=ice-pwd:"+t.password+"\r\n";return t.iceLite&&(e+="a=ice-lite\r\n"),e},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=e.splitLines(t)[0].split(" ");i.profile=n[2];for(let s=3;s<n.length;s++){const o=n[s],r=e.matchPrefix(t,"a=rtpmap:"+o+" ")[0];if(r){const n=e.parseRtpMap(r),s=e.matchPrefix(t,"a=fmtp:"+o+" ");switch(n.parameters=s.length?e.parseFmtp(s[0]):{},n.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+o+" ").map(e.parseRtcpFb),i.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase())}}}e.matchPrefix(t,"a=extmap:").forEach((t=>{i.headerExtensions.push(e.parseExtmap(t))}));const s=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach((t=>{s.forEach((e=>{t.rtcpFeedback.find((t=>t.type===e.type&&t.parameter===e.parameter))||t.rtcpFeedback.push(e)}))})),i},e.writeRtpDescription=function(t,i){let n="";n+="m="+t+" ",n+=i.codecs.length>0?"9":"0",n+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=i.codecs.map((t=>void 0!==t.preferredPayloadType?t.preferredPayloadType:t.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((t=>{n+=e.writeRtpMap(t),n+=e.writeFmtp(t),n+=e.writeRtcpFb(t)}));let s=0;return i.codecs.forEach((t=>{t.maxptime>s&&(s=t.maxptime)})),s>0&&(n+="a=maxptime:"+s+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((t=>{n+=e.writeExtmap(t)})),n},e.parseRtpEncodingParameters=function(t){const i=[],n=e.parseRtpParameters(t),s=-1!==n.fecMechanisms.indexOf("RED"),o=-1!==n.fecMechanisms.indexOf("ULPFEC"),r=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute)),a=r.length>0&&r[0].ssrc;let c;const d=e.matchPrefix(t,"a=ssrc-group:FID").map((t=>t.substring(17).split(" ").map((t=>parseInt(t,10)))));d.length>0&&d[0].length>1&&d[0][0]===a&&(c=d[0][1]),n.codecs.forEach((t=>{if("RTX"===t.name.toUpperCase()&&t.parameters.apt){let e={ssrc:a,codecPayloadType:parseInt(t.parameters.apt,10)};a&&c&&(e.rtx={ssrc:c}),i.push(e),s&&(e=JSON.parse(JSON.stringify(e)),e.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},i.push(e))}})),0===i.length&&a&&i.push({ssrc:a});let l=e.matchPrefix(t,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach((t=>{t.maxBitrate=l}))),i},e.parseRtcpParameters=function(t){const i={},n=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=0===s.length;const o=e.matchPrefix(t,"a=rtcp-mux");return i.mux=o.length>0,i},e.writeRtcpParameters=function(t){let e="";return t.reducedSize&&(e+="a=rtcp-rsize\r\n"),t.mux&&(e+="a=rtcp-mux\r\n"),void 0!==t.ssrc&&t.cname&&(e+="a=ssrc:"+t.ssrc+" cname:"+t.cname+"\r\n"),e},e.parseMsid=function(t){let i;const n=e.matchPrefix(t,"a=msid:");if(1===n.length)return i=n[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"msid"===t.attribute));return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(t){const i=e.parseMLine(t),n=e.matchPrefix(t,"a=max-message-size:");let s;n.length>0&&(s=parseInt(n[0].substring(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(t,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const r=e.matchPrefix(t,"a=sctpmap:");if(r.length>0){const t=r[0].substring(10).split(" ");return{port:parseInt(t[0],10),protocol:t[1],maxMessageSize:s}}},e.writeSctpDescription=function(t,e){let i=[];return i="DTLS/SCTP"!==t.protocol?["m="+t.kind+" 9 "+t.protocol+" "+e.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+e.port+"\r\n"]:["m="+t.kind+" 9 "+t.protocol+" "+e.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+e.port+" "+e.protocol+" 65535\r\n"],void 0!==e.maxMessageSize&&i.push("a=max-message-size:"+e.maxMessageSize+"\r\n"),i.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,n){let s;const o=void 0!==i?i:2;return s=t||e.generateSessionId(),"v=0\r\no="+(n||"thisisadapterortc")+" "+s+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},e.getDirection=function(t,i){const n=e.splitLines(t);for(let t=0;t<n.length;t++)switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return"0"===t.split(" ",2)[1]},e.parseMLine=function(t){const i=e.splitLines(t)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(t){const i=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(t){if("string"!=typeof t||0===t.length)return!1;const i=e.splitLines(t);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},t.exports=e}(Y);var J=Y.exports,X=K(J),Z=t({__proto__:null,default:X},[J]);function Q(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(t){if("object"==typeof t&&t.candidate&&0===t.candidate.indexOf("a=")&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substr(2)),t.candidate&&t.candidate.length){const i=new e(t),n=X.parseCandidate(t.candidate),s=Object.assign(i,n);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new e(t)},t.RTCIceCandidate.prototype=e.prototype,s(t,"icecandidate",(e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e)))}function tt(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||s(t,"icecandidate",(t=>{if(t.candidate){const e=X.parseCandidate(t.candidate.candidate);"relay"===e.type&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24])}return t}))}function et(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(t){if(!t||!t.sdp)return!1;const e=X.splitSections(t.sdp);return e.shift(),e.some((t=>{const e=X.parseMLine(t);return e&&"application"===e.kind&&-1!==e.protocol.indexOf("SCTP")}))},n=function(t){const e=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===e||e.length<2)return-1;const i=parseInt(e[1],10);return i!=i?-1:i},s=function(t){let i=65536;return"firefox"===e.browser&&(i=e.version<57?-1===t?16384:2147483637:e.version<60?57===e.version?65535:65536:2147483637),i},o=function(t,i){let n=65536;"firefox"===e.browser&&57===e.version&&(n=65535);const s=X.matchPrefix(t.sdp,"a=max-message-size:");return s.length>0?n=parseInt(s[0].substr(19),10):"firefox"===e.browser&&-1!==i&&(n=2147483637),n},r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===e.browser&&e.version>=76){const{sdpSemantics:t}=this.getConfiguration();"plan-b"===t&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const t=n(arguments[0]),e=s(t),i=o(arguments[0],t);let r;r=0===e&&0===i?Number.POSITIVE_INFINITY:0===e||0===i?Math.max(e,i):Math.min(e,i);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>r}),this._sctp=a}return r.apply(this,arguments)}}function it(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(t,e){const i=t.send;t.send=function(){const n=arguments[0],s=n.length||n.size||n.byteLength;if("open"===t.readyState&&e.sctp&&s>e.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+e.sctp.maxMessageSize+" bytes)");return i.apply(t,arguments)}}const i=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const t=i.apply(this,arguments);return e(t,this),t},s(t,"datachannel",(t=>(e(t.channel,t.target),t)))}function nt(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=t=>{const e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;const i=new Event("connectionstatechange",t);e.dispatchEvent(i)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function st(t,e){if(!t.RTCPeerConnection)return;if("chrome"===e.browser&&e.version>=71)return;if("safari"===e.browser&&e.version>=605)return;const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(e){if(e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")){const i=e.sdp.split("\n").filter((t=>"a=extmap-allow-mixed"!==t.trim())).join("\n");t.RTCSessionDescription&&e instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:e.type,sdp:i}):e.sdp=i}return i.apply(this,arguments)}}function ot(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===e.browser&&e.version<78||"firefox"===e.browser&&e.version<68||"safari"===e.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function rt(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let t=arguments[0]||{};if("object"!=typeof t||t.type&&t.sdp)return i.apply(this,arguments);if(t={type:t.type,sdp:t.sdp},!t.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":t.type="offer";break;default:t.type="answer"}return t.sdp||"offer"!==t.type&&"answer"!==t.type?i.apply(this,[t]):("offer"===t.type?this.createOffer:this.createAnswer).apply(this).then((t=>i.apply(this,[t])))})}var at=Object.freeze({__proto__:null,removeExtmapAllowMixed:st,shimAddIceCandidateNullOrEmpty:ot,shimConnectionState:nt,shimMaxMessageSize:et,shimParameterlessSetLocalDescription:rt,shimRTCIceCandidate:Q,shimRTCIceCandidateRelayProtocol:tt,shimSendThrowTypeError:it});!function({window:t}={},e={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const i=a,s=function(t){const e={browser:null,version:null};if(void 0===t||!t.navigator)return e.browser="Not a browser.",e;const{navigator:i}=t;if(i.mozGetUserMedia)e.browser="firefox",e.version=n(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===t.isSecureContext&&t.webkitRTCPeerConnection)e.browser="chrome",e.version=n(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!t.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return e.browser="Not a supported browser.",e;e.browser="safari",e.version=n(i.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype}return e}(t),c={browserDetails:s,commonShim:at,extractVersion:n,disableLog:o,disableWarnings:r,sdp:Z};switch(s.browser){case"chrome":if(!C||!b||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),c;if(null===s.version)return i("Chrome shim can not determine version, not shimming."),c;i("adapter.js shimming chrome."),c.browserShim=C,ot(t,s),rt(t),m(t,s),g(t),b(t,s),f(t),T(t,s),v(t),_(t),E(t),y(t,s),Q(t),tt(t),nt(t),et(t,s),it(t),st(t,s);break;case"firefox":if(!x||!I||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),c;i("adapter.js shimming firefox."),c.browserShim=x,ot(t,s),rt(t),w(t,s),I(t,s),R(t),N(t),A(t),O(t),k(t),L(t),P(t),D(t),M(t),Q(t),nt(t),et(t,s),it(t);break;case"safari":if(!z||!e.shimSafari)return i("Safari shim is not included in this adapter release."),c;i("adapter.js shimming safari."),c.browserShim=z,ot(t,s),rt(t),H(t),W(t),F(t),U(t),V(t),G(t),B(t),$(t),Q(t),tt(t),et(t,s),it(t),st(t,s);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});var ct=function(t){try{return!!t()}catch(t){return!0}},dt=!ct((function(){var t=function(){}.bind();return"function"!=typeof t||t.hasOwnProperty("prototype")})),lt=dt,ht=Function.prototype,ut=ht.call,pt=lt&&ht.bind.bind(ut,ut),mt=lt?pt:function(t){return function(){return ut.apply(t,arguments)}},gt=mt({}.isPrototypeOf),ft=function(t){return t&&t.Math==Math&&t},vt=ft("object"==typeof globalThis&&globalThis)||ft("object"==typeof window&&window)||ft("object"==typeof self&&self)||ft("object"==typeof q&&q)||function(){return this}()||q||Function("return this")(),_t=dt,Et=Function.prototype,St=Et.apply,Tt=Et.call,bt="object"==typeof Reflect&&Reflect.apply||(_t?Tt.bind(St):function(){return Tt.apply(St,arguments)}),yt=mt,Ct=yt({}.toString),wt=yt("".slice),Rt=function(t){return wt(Ct(t),8,-1)},It=Rt,At=mt,Ot=function(t){if("Function"===It(t))return At(t)},Nt="object"==typeof document&&document.all,kt={all:Nt,IS_HTMLDDA:void 0===Nt&&void 0!==Nt},Lt=kt.all,Pt=kt.IS_HTMLDDA?function(t){return"function"==typeof t||t===Lt}:function(t){return"function"==typeof t},Dt={},Mt=!ct((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),xt=dt,Ut=Function.prototype.call,Vt=xt?Ut.bind(Ut):function(){return Ut.apply(Ut,arguments)},Ft={},Bt={}.propertyIsEnumerable,jt=Object.getOwnPropertyDescriptor,Ht=jt&&!Bt.call({1:2},1);Ft.f=Ht?function(t){var e=jt(this,t);return!!e&&e.enumerable}:Bt;var Gt,Wt,$t=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},zt=ct,qt=Rt,Kt=Object,Yt=mt("".split),Jt=zt((function(){return!Kt("z").propertyIsEnumerable(0)}))?function(t){return"String"==qt(t)?Yt(t,""):Kt(t)}:Kt,Xt=function(t){return null==t},Zt=Xt,Qt=TypeError,te=function(t){if(Zt(t))throw Qt("Can't call method on "+t);return t},ee=Jt,ie=te,ne=function(t){return ee(ie(t))},se=Pt,oe=kt.all,re=kt.IS_HTMLDDA?function(t){return"object"==typeof t?null!==t:se(t)||t===oe}:function(t){return"object"==typeof t?null!==t:se(t)},ae={},ce=ae,de=vt,le=Pt,he=function(t){return le(t)?t:void 0},ue=function(t,e){return arguments.length<2?he(ce[t])||he(de[t]):ce[t]&&ce[t][e]||de[t]&&de[t][e]},pe="undefined"!=typeof navigator&&String(navigator.userAgent)||"",me=vt,ge=pe,fe=me.process,ve=me.Deno,_e=fe&&fe.versions||ve&&ve.version,Ee=_e&&_e.v8;Ee&&(Wt=(Gt=Ee.split("."))[0]>0&&Gt[0]<4?1:+(Gt[0]+Gt[1])),!Wt&&ge&&(!(Gt=ge.match(/Edge\/(\d+)/))||Gt[1]>=74)&&(Gt=ge.match(/Chrome\/(\d+)/))&&(Wt=+Gt[1]);var Se=Wt,Te=Se,be=ct,ye=vt.String,Ce=!!Object.getOwnPropertySymbols&&!be((function(){var t=Symbol();return!ye(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Te&&Te<41})),we=Ce&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,Re=ue,Ie=Pt,Ae=gt,Oe=Object,Ne=we?function(t){return"symbol"==typeof t}:function(t){var e=Re("Symbol");return Ie(e)&&Ae(e.prototype,Oe(t))},ke=String,Le=function(t){try{return ke(t)}catch(t){return"Object"}},Pe=Pt,De=Le,Me=TypeError,xe=function(t){if(Pe(t))return t;throw Me(De(t)+" is not a function")},Ue=xe,Ve=Xt,Fe=function(t,e){var i=t[e];return Ve(i)?void 0:Ue(i)},Be=Vt,je=Pt,He=re,Ge=TypeError,We={exports:{}},$e=vt,ze=Object.defineProperty,qe=function(t,e){try{ze($e,t,{value:e,configurable:!0,writable:!0})}catch(i){$e[t]=e}return e},Ke="__core-js_shared__",Ye=vt[Ke]||qe(Ke,{}),Je=Ye;(We.exports=function(t,e){return Je[t]||(Je[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var Xe=We.exports,Ze=te,Qe=Object,ti=function(t){return Qe(Ze(t))},ei=ti,ii=mt({}.hasOwnProperty),ni=Object.hasOwn||function(t,e){return ii(ei(t),e)},si=mt,oi=0,ri=Math.random(),ai=si(1..toString),ci=function(t){return"Symbol("+(void 0===t?"":t)+")_"+ai(++oi+ri,36)},di=Xe,li=ni,hi=ci,ui=Ce,pi=we,mi=vt.Symbol,gi=di("wks"),fi=pi?mi.for||mi:mi&&mi.withoutSetter||hi,vi=function(t){return li(gi,t)||(gi[t]=ui&&li(mi,t)?mi[t]:fi("Symbol."+t)),gi[t]},_i=Vt,Ei=re,Si=Ne,Ti=Fe,bi=function(t,e){var i,n;if("string"===e&&je(i=t.toString)&&!He(n=Be(i,t)))return n;if(je(i=t.valueOf)&&!He(n=Be(i,t)))return n;if("string"!==e&&je(i=t.toString)&&!He(n=Be(i,t)))return n;throw Ge("Can't convert object to primitive value")},yi=TypeError,Ci=vi("toPrimitive"),wi=function(t,e){if(!Ei(t)||Si(t))return t;var i,n=Ti(t,Ci);if(n){if(void 0===e&&(e="default"),i=_i(n,t,e),!Ei(i)||Si(i))return i;throw yi("Can't convert object to primitive value")}return void 0===e&&(e="number"),bi(t,e)},Ri=Ne,Ii=function(t){var e=wi(t,"string");return Ri(e)?e:e+""},Ai=re,Oi=vt.document,Ni=Ai(Oi)&&Ai(Oi.createElement),ki=function(t){return Ni?Oi.createElement(t):{}},Pi=ki,Di=!Mt&&!ct((function(){return 7!=Object.defineProperty(Pi("div"),"a",{get:function(){return 7}}).a})),Mi=Mt,xi=Vt,Ui=Ft,Vi=$t,Fi=ne,Bi=Ii,ji=ni,Hi=Di,Gi=Object.getOwnPropertyDescriptor;Dt.f=Mi?Gi:function(t,e){if(t=Fi(t),e=Bi(e),Hi)try{return Gi(t,e)}catch(t){}if(ji(t,e))return Vi(!xi(Ui.f,t,e),t[e])};var Wi=ct,$i=Pt,zi=/#|\.prototype\./,qi=function(t,e){var i=Yi[Ki(t)];return i==Xi||i!=Ji&&($i(e)?Wi(e):!!e)},Ki=qi.normalize=function(t){return String(t).replace(zi,".").toLowerCase()},Yi=qi.data={},Ji=qi.NATIVE="N",Xi=qi.POLYFILL="P",Zi=qi,Qi=xe,tn=dt,en=Ot(Ot.bind),nn=function(t,e){return Qi(t),void 0===e?t:tn?en(t,e):function(){return t.apply(e,arguments)}},sn={},on=Mt&&ct((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),rn=re,an=String,cn=TypeError,dn=function(t){if(rn(t))return t;throw cn(an(t)+" is not an object")},ln=Mt,hn=Di,un=on,pn=dn,mn=Ii,gn=TypeError,fn=Object.defineProperty,vn=Object.getOwnPropertyDescriptor,_n="enumerable",En="configurable",Sn="writable";sn.f=ln?un?function(t,e,i){if(pn(t),e=mn(e),pn(i),"function"==typeof t&&"prototype"===e&&"value"in i&&Sn in i&&!i[Sn]){var n=vn(t,e);n&&n[Sn]&&(t[e]=i.value,i={configurable:En in i?i[En]:n[En],enumerable:_n in i?i[_n]:n[_n],writable:!1})}return fn(t,e,i)}:fn:function(t,e,i){if(pn(t),e=mn(e),pn(i),hn)try{return fn(t,e,i)}catch(t){}if("get"in i||"set"in i)throw gn("Accessors not supported");return"value"in i&&(t[e]=i.value),t};var Tn=sn,bn=$t,yn=Mt?function(t,e,i){return Tn.f(t,e,bn(1,i))}:function(t,e,i){return t[e]=i,t},Cn=vt,wn=bt,Rn=Ot,In=Pt,An=Dt.f,On=Zi,Nn=ae,kn=nn,Ln=yn,Pn=ni,Dn=function(t){var e=function(i,n,s){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(i);case 2:return new t(i,n)}return new t(i,n,s)}return wn(t,this,arguments)};return e.prototype=t.prototype,e},Mn=function(t,e){var i,n,s,o,r,a,c,d,l,h=t.target,u=t.global,p=t.stat,m=t.proto,g=u?Cn:p?Cn[h]:(Cn[h]||{}).prototype,f=u?Nn:Nn[h]||Ln(Nn,h,{})[h],v=f.prototype;for(o in e)n=!(i=On(u?o:h+(p?".":"#")+o,t.forced))&&g&&Pn(g,o),a=f[o],n&&(c=t.dontCallGetSet?(l=An(g,o))&&l.value:g[o]),r=n&&c?c:e[o],n&&typeof a==typeof r||(d=t.bind&&n?kn(r,Cn):t.wrap&&n?Dn(r):m&&In(r)?Rn(r):r,(t.sham||r&&r.sham||a&&a.sham)&&Ln(d,"sham",!0),Ln(f,o,d),m&&(Pn(Nn,s=h+"Prototype")||Ln(Nn,s,{}),Ln(Nn[s],o,r),t.real&&v&&(i||!v[o])&&Ln(v,o,r)))},xn=Math.ceil,Un=Math.floor,Vn=Math.trunc||function(t){var e=+t;return(e>0?Un:xn)(e)},Fn=function(t){var e=+t;return e!=e||0===e?0:Vn(e)},Bn=Fn,jn=Math.max,Hn=Math.min,Gn=function(t,e){var i=Bn(t);return i<0?jn(i+e,0):Hn(i,e)},Wn=Fn,$n=Math.min,zn=function(t){return t>0?$n(Wn(t),9007199254740991):0},qn=function(t){return zn(t.length)},Kn=ne,Yn=Gn,Jn=qn,Xn=function(t){return function(e,i,n){var s,o=Kn(e),r=Jn(o),a=Yn(n,r);if(t&&i!=i){for(;r>a;)if((s=o[a++])!=s)return!0}else for(;r>a;a++)if((t||a in o)&&o[a]===i)return t||a||0;return!t&&-1}},Zn={includes:Xn(!0),indexOf:Xn(!1)},Qn=Zn.includes;Mn({target:"Array",proto:!0,forced:ct((function(){return!Array(1).includes()}))},{includes:function(t){return Qn(this,t,arguments.length>1?arguments[1]:void 0)}});var ts=ae,es=function(t){return ts[t+"Prototype"]},is=es("Array").includes,ns=re,ss=Rt,os=vi("match"),rs=function(t){var e;return ns(t)&&(void 0!==(e=t[os])?!!e:"RegExp"==ss(t))},as=TypeError,cs={};cs[vi("toStringTag")]="z";var ds="[object z]"===String(cs),ls=ds,hs=Pt,us=Rt,ps=vi("toStringTag"),ms=Object,gs="Arguments"==us(function(){return arguments}()),fs=ls?us:function(t){var e,i,n;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(i=function(t,e){try{return t[e]}catch(t){}}(e=ms(t),ps))?i:gs?us(e):"Object"==(n=us(e))&&hs(e.callee)?"Arguments":n},vs=fs,_s=String,Es=function(t){if("Symbol"===vs(t))throw TypeError("Cannot convert a Symbol value to a string");return _s(t)},Ss=vi("match"),Ts=Mn,bs=function(t){if(rs(t))throw as("The method doesn't accept regular expressions");return t},ys=te,Cs=Es,ws=function(t){var e=/./;try{"/./"[t](e)}catch(i){try{return e[Ss]=!1,"/./"[t](e)}catch(t){}}return!1},Rs=mt("".indexOf);Ts({target:"String",proto:!0,forced:!ws("includes")},{includes:function(t){return!!~Rs(Cs(ys(this)),Cs(bs(t)),arguments.length>1?arguments[1]:void 0)}});var Is=es("String").includes,As=gt,Os=is,Ns=Is,ks=Array.prototype,Ls=String.prototype,Ps=K((function(t){var e=t.includes;return t===ks||As(ks,t)&&e===ks.includes?Os:"string"==typeof t||t===Ls||As(Ls,t)&&e===Ls.includes?Ns:e})),Ds={exports:{}},Ms=Mn,xs=Mt,Us=sn.f;Ms({target:"Object",stat:!0,forced:Object.defineProperty!==Us,sham:!xs},{defineProperty:Us});var Vs=ae.Object,Fs=Ds.exports=function(t,e,i){return Vs.defineProperty(t,e,i)};Vs.defineProperty.sham&&(Fs.sham=!0);var Bs=K(Ds.exports),js=Rt,Hs=Array.isArray||function(t){return"Array"==js(t)},Gs=TypeError,Ws=Ii,$s=sn,zs=$t,qs=function(t,e,i){var n=Ws(e);n in t?$s.f(t,n,zs(0,i)):t[n]=i},Ks=Pt,Ys=Ye,Js=mt(Function.toString);Ks(Ys.inspectSource)||(Ys.inspectSource=function(t){return Js(t)});var Xs=Ys.inspectSource,Zs=mt,Qs=ct,to=Pt,eo=fs,io=Xs,no=function(){},so=[],oo=ue("Reflect","construct"),ro=/^\s*(?:class|function)\b/,ao=Zs(ro.exec),co=!ro.exec(no),lo=function(t){if(!to(t))return!1;try{return oo(no,so,t),!0}catch(t){return!1}},ho=function(t){if(!to(t))return!1;switch(eo(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return co||!!ao(ro,io(t))}catch(t){return!0}};ho.sham=!0;var uo=!oo||Qs((function(){var t;return lo(lo.call)||!lo(Object)||!lo((function(){t=!0}))||t}))?ho:lo,po=Hs,mo=uo,go=re,fo=vi("species"),vo=Array,_o=function(t){var e;return po(t)&&(e=t.constructor,(mo(e)&&(e===vo||po(e.prototype))||go(e)&&null===(e=e[fo]))&&(e=void 0)),void 0===e?vo:e},Eo=function(t,e){return new(_o(t))(0===e?0:e)},So=ct,To=Se,bo=vi("species"),yo=Mn,Co=ct,wo=Hs,Ro=re,Io=ti,Ao=qn,Oo=function(t){if(t>9007199254740991)throw Gs("Maximum allowed index exceeded");return t},No=qs,ko=Eo,Lo=function(t){return To>=51||!So((function(){var e=[];return(e.constructor={})[bo]=function(){return{foo:1}},1!==e[t](Boolean).foo}))},Po=Se,Do=vi("isConcatSpreadable"),Mo=Po>=51||!Co((function(){var t=[];return t[Do]=!1,t.concat()[0]!==t})),xo=function(t){if(!Ro(t))return!1;var e=t[Do];return void 0!==e?!!e:wo(t)};yo({target:"Array",proto:!0,arity:1,forced:!Mo||!Lo("concat")},{concat:function(t){var e,i,n,s,o,r=Io(this),a=ko(r,0),c=0;for(e=-1,n=arguments.length;e<n;e++)if(xo(o=-1===e?r:arguments[e]))for(s=Ao(o),Oo(c+s),i=0;i<s;i++,c++)i in o&&No(a,c,o[i]);else Oo(c+1),No(a,c++,o);return a.length=c,a}});var Uo={},Vo={},Fo=ni,Bo=ne,jo=Zn.indexOf,Ho=Vo,Go=mt([].push),Wo=function(t,e){var i,n=Bo(t),s=0,o=[];for(i in n)!Fo(Ho,i)&&Fo(n,i)&&Go(o,i);for(;e.length>s;)Fo(n,i=e[s++])&&(~jo(o,i)||Go(o,i));return o},$o=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],zo=Wo,qo=$o,Ko=Object.keys||function(t){return zo(t,qo)},Yo=Mt,Jo=on,Xo=sn,Zo=dn,Qo=ne,tr=Ko;Uo.f=Yo&&!Jo?Object.defineProperties:function(t,e){Zo(t);for(var i,n=Qo(e),s=tr(e),o=s.length,r=0;o>r;)Xo.f(t,i=s[r++],n[i]);return t};var er,ir=ue("document","documentElement"),nr=ci,sr=Xe("keys"),or=function(t){return sr[t]||(sr[t]=nr(t))},rr=dn,ar=Uo,cr=$o,dr=Vo,lr=ir,hr=ki,ur="prototype",pr="script",mr=or("IE_PROTO"),gr=function(){},fr=function(t){return"<"+pr+">"+t+"</"+pr+">"},vr=function(t){t.write(fr("")),t.close();var e=t.parentWindow.Object;return t=null,e},_r=function(){try{er=new ActiveXObject("htmlfile")}catch(t){}var t,e,i;_r="undefined"!=typeof document?document.domain&&er?vr(er):(e=hr("iframe"),i="java"+pr+":",e.style.display="none",lr.appendChild(e),e.src=String(i),(t=e.contentWindow.document).open(),t.write(fr("document.F=Object")),t.close(),t.F):vr(er);for(var n=cr.length;n--;)delete _r[ur][cr[n]];return _r()};dr[mr]=!0;var Er=Object.create||function(t,e){var i;return null!==t?(gr[ur]=rr(t),i=new gr,gr[ur]=null,i[mr]=t):i=_r(),void 0===e?i:ar.f(i,e)},Sr={},Tr=Wo,br=$o.concat("length","prototype");Sr.f=Object.getOwnPropertyNames||function(t){return Tr(t,br)};var yr={},Cr=Gn,wr=qn,Rr=qs,Ir=Array,Ar=Math.max,Or=function(t,e,i){for(var n=wr(t),s=Cr(e,n),o=Cr(void 0===i?n:i,n),r=Ir(Ar(o-s,0)),a=0;s<o;s++,a++)Rr(r,a,t[s]);return r.length=a,r},Nr=Rt,kr=ne,Lr=Sr.f,Pr=Or,Dr="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];yr.f=function(t){return Dr&&"Window"==Nr(t)?function(t){try{return Lr(t)}catch(t){return Pr(Dr)}}(t):Lr(kr(t))};var Mr={};Mr.f=Object.getOwnPropertySymbols;var xr=yn,Ur=function(t,e,i,n){return n&&n.enumerable?t[e]=i:xr(t,e,i),t},Vr=sn,Fr=function(t,e,i){return Vr.f(t,e,i)},Br={},jr=vi;Br.f=jr;var Hr,Gr,Wr,$r=ae,zr=ni,qr=Br,Kr=sn.f,Yr=function(t){var e=$r.Symbol||($r.Symbol={});zr(e,t)||Kr(e,t,{value:qr.f(t)})},Jr=Vt,Xr=ue,Zr=vi,Qr=Ur,ta=function(){var t=Xr("Symbol"),e=t&&t.prototype,i=e&&e.valueOf,n=Zr("toPrimitive");e&&!e[n]&&Qr(e,n,(function(t){return Jr(i,this)}),{arity:1})},ea=fs,ia=ds?{}.toString:function(){return"[object "+ea(this)+"]"},na=ds,sa=sn.f,oa=yn,ra=ni,aa=ia,ca=vi("toStringTag"),da=function(t,e,i,n){if(t){var s=i?t:t.prototype;ra(s,ca)||sa(s,ca,{configurable:!0,value:e}),n&&!na&&oa(s,"toString",aa)}},la=Pt,ha=vt.WeakMap,ua=la(ha)&&/native code/.test(String(ha)),pa=vt,ma=re,ga=yn,fa=ni,va=Ye,_a=or,Ea=Vo,Sa="Object already initialized",Ta=pa.TypeError,ba=pa.WeakMap;if(ua||va.state){var ya=va.state||(va.state=new ba);ya.get=ya.get,ya.has=ya.has,ya.set=ya.set,Hr=function(t,e){if(ya.has(t))throw Ta(Sa);return e.facade=t,ya.set(t,e),e},Gr=function(t){return ya.get(t)||{}},Wr=function(t){return ya.has(t)}}else{var Ca=_a("state");Ea[Ca]=!0,Hr=function(t,e){if(fa(t,Ca))throw Ta(Sa);return e.facade=t,ga(t,Ca,e),e},Gr=function(t){return fa(t,Ca)?t[Ca]:{}},Wr=function(t){return fa(t,Ca)}}var wa={set:Hr,get:Gr,has:Wr,enforce:function(t){return Wr(t)?Gr(t):Hr(t,{})},getterFor:function(t){return function(e){var i;if(!ma(e)||(i=Gr(e)).type!==t)throw Ta("Incompatible receiver, "+t+" required");return i}}},Ra=nn,Ia=Jt,Aa=ti,Oa=qn,Na=Eo,ka=mt([].push),La=function(t){var e=1==t,i=2==t,n=3==t,s=4==t,o=6==t,r=7==t,a=5==t||o;return function(c,d,l,h){for(var u,p,m=Aa(c),g=Ia(m),f=Ra(d,l),v=Oa(g),_=0,E=h||Na,S=e?E(c,v):i||r?E(c,0):void 0;v>_;_++)if((a||_ in g)&&(p=f(u=g[_],_,m),t))if(e)S[_]=p;else if(p)switch(t){case 3:return!0;case 5:return u;case 6:return _;case 2:ka(S,u)}else switch(t){case 4:return!1;case 7:ka(S,u)}return o?-1:n||s?s:S}},Pa={forEach:La(0),map:La(1),filter:La(2),some:La(3),every:La(4),find:La(5),findIndex:La(6),filterReject:La(7)},Da=Mn,Ma=vt,xa=Vt,Ua=mt,Va=Mt,Fa=Ce,Ba=ct,ja=ni,Ha=gt,Ga=dn,Wa=ne,$a=Ii,za=Es,qa=$t,Ka=Er,Ya=Ko,Ja=Sr,Xa=yr,Za=Mr,Qa=Dt,tc=sn,ec=Uo,ic=Ft,nc=Ur,sc=Fr,oc=Xe,rc=Vo,ac=ci,cc=vi,dc=Br,lc=Yr,hc=ta,uc=da,pc=wa,mc=Pa.forEach,gc=or("hidden"),fc="Symbol",vc="prototype",_c=pc.set,Ec=pc.getterFor(fc),Sc=Object[vc],Tc=Ma.Symbol,bc=Tc&&Tc[vc],yc=Ma.TypeError,Cc=Ma.QObject,wc=Qa.f,Rc=tc.f,Ic=Xa.f,Ac=ic.f,Oc=Ua([].push),Nc=oc("symbols"),kc=oc("op-symbols"),Lc=oc("wks"),Pc=!Cc||!Cc[vc]||!Cc[vc].findChild,Dc=Va&&Ba((function(){return 7!=Ka(Rc({},"a",{get:function(){return Rc(this,"a",{value:7}).a}})).a}))?function(t,e,i){var n=wc(Sc,e);n&&delete Sc[e],Rc(t,e,i),n&&t!==Sc&&Rc(Sc,e,n)}:Rc,Mc=function(t,e){var i=Nc[t]=Ka(bc);return _c(i,{type:fc,tag:t,description:e}),Va||(i.description=e),i},xc=function(t,e,i){t===Sc&&xc(kc,e,i),Ga(t);var n=$a(e);return Ga(i),ja(Nc,n)?(i.enumerable?(ja(t,gc)&&t[gc][n]&&(t[gc][n]=!1),i=Ka(i,{enumerable:qa(0,!1)})):(ja(t,gc)||Rc(t,gc,qa(1,{})),t[gc][n]=!0),Dc(t,n,i)):Rc(t,n,i)},Uc=function(t,e){Ga(t);var i=Wa(e),n=Ya(i).concat(jc(i));return mc(n,(function(e){Va&&!xa(Vc,i,e)||xc(t,e,i[e])})),t},Vc=function(t){var e=$a(t),i=xa(Ac,this,e);return!(this===Sc&&ja(Nc,e)&&!ja(kc,e))&&(!(i||!ja(this,e)||!ja(Nc,e)||ja(this,gc)&&this[gc][e])||i)},Fc=function(t,e){var i=Wa(t),n=$a(e);if(i!==Sc||!ja(Nc,n)||ja(kc,n)){var s=wc(i,n);return!s||!ja(Nc,n)||ja(i,gc)&&i[gc][n]||(s.enumerable=!0),s}},Bc=function(t){var e=Ic(Wa(t)),i=[];return mc(e,(function(t){ja(Nc,t)||ja(rc,t)||Oc(i,t)})),i},jc=function(t){var e=t===Sc,i=Ic(e?kc:Wa(t)),n=[];return mc(i,(function(t){!ja(Nc,t)||e&&!ja(Sc,t)||Oc(n,Nc[t])})),n};Fa||(Tc=function(){if(Ha(bc,this))throw yc("Symbol is not a constructor");var t=arguments.length&&void 0!==arguments[0]?za(arguments[0]):void 0,e=ac(t),i=function(t){this===Sc&&xa(i,kc,t),ja(this,gc)&&ja(this[gc],e)&&(this[gc][e]=!1),Dc(this,e,qa(1,t))};return Va&&Pc&&Dc(Sc,e,{configurable:!0,set:i}),Mc(e,t)},nc(bc=Tc[vc],"toString",(function(){return Ec(this).tag})),nc(Tc,"withoutSetter",(function(t){return Mc(ac(t),t)})),ic.f=Vc,tc.f=xc,ec.f=Uc,Qa.f=Fc,Ja.f=Xa.f=Bc,Za.f=jc,dc.f=function(t){return Mc(cc(t),t)},Va&&sc(bc,"description",{configurable:!0,get:function(){return Ec(this).description}})),Da({global:!0,constructor:!0,wrap:!0,forced:!Fa,sham:!Fa},{Symbol:Tc}),mc(Ya(Lc),(function(t){lc(t)})),Da({target:fc,stat:!0,forced:!Fa},{useSetter:function(){Pc=!0},useSimple:function(){Pc=!1}}),Da({target:"Object",stat:!0,forced:!Fa,sham:!Va},{create:function(t,e){return void 0===e?Ka(t):Uc(Ka(t),e)},defineProperty:xc,defineProperties:Uc,getOwnPropertyDescriptor:Fc}),Da({target:"Object",stat:!0,forced:!Fa},{getOwnPropertyNames:Bc}),hc(),uc(Tc,fc),rc[gc]=!0;var Hc=Ce&&!!Symbol.for&&!!Symbol.keyFor,Gc=Mn,Wc=ue,$c=ni,zc=Es,qc=Xe,Kc=Hc,Yc=qc("string-to-symbol-registry"),Jc=qc("symbol-to-string-registry");Gc({target:"Symbol",stat:!0,forced:!Kc},{for:function(t){var e=zc(t);if($c(Yc,e))return Yc[e];var i=Wc("Symbol")(e);return Yc[e]=i,Jc[i]=e,i}});var Xc=Mn,Zc=ni,Qc=Ne,td=Le,ed=Hc,id=Xe("symbol-to-string-registry");Xc({target:"Symbol",stat:!0,forced:!ed},{keyFor:function(t){if(!Qc(t))throw TypeError(td(t)+" is not a symbol");if(Zc(id,t))return id[t]}});var nd=mt([].slice),sd=Hs,od=Pt,rd=Rt,ad=Es,cd=mt([].push),dd=Mn,ld=ue,hd=bt,ud=Vt,pd=mt,md=ct,gd=Pt,fd=Ne,vd=nd,_d=function(t){if(od(t))return t;if(sd(t)){for(var e=t.length,i=[],n=0;n<e;n++){var s=t[n];"string"==typeof s?cd(i,s):"number"!=typeof s&&"Number"!=rd(s)&&"String"!=rd(s)||cd(i,ad(s))}var o=i.length,r=!0;return function(t,e){if(r)return r=!1,e;if(sd(this))return e;for(var n=0;n<o;n++)if(i[n]===t)return e}}},Ed=Ce,Sd=String,Td=ld("JSON","stringify"),bd=pd(/./.exec),yd=pd("".charAt),Cd=pd("".charCodeAt),wd=pd("".replace),Rd=pd(1..toString),Id=/[\uD800-\uDFFF]/g,Ad=/^[\uD800-\uDBFF]$/,Od=/^[\uDC00-\uDFFF]$/,Nd=!Ed||md((function(){var t=ld("Symbol")();return"[null]"!=Td([t])||"{}"!=Td({a:t})||"{}"!=Td(Object(t))})),kd=md((function(){return'"\\udf06\\ud834"'!==Td("\udf06\ud834")||'"\\udead"'!==Td("\udead")})),Ld=function(t,e){var i=vd(arguments),n=_d(e);if(gd(n)||void 0!==t&&!fd(t))return i[1]=function(t,e){if(gd(n)&&(e=ud(n,this,Sd(t),e)),!fd(e))return e},hd(Td,null,i)},Pd=function(t,e,i){var n=yd(i,e-1),s=yd(i,e+1);return bd(Ad,t)&&!bd(Od,s)||bd(Od,t)&&!bd(Ad,n)?"\\u"+Rd(Cd(t,0),16):t};Td&&dd({target:"JSON",stat:!0,arity:3,forced:Nd||kd},{stringify:function(t,e,i){var n=vd(arguments),s=hd(Nd?Ld:Td,null,n);return kd&&"string"==typeof s?wd(s,Id,Pd):s}});var Dd=Mr,Md=ti;Mn({target:"Object",stat:!0,forced:!Ce||ct((function(){Dd.f(1)}))},{getOwnPropertySymbols:function(t){var e=Dd.f;return e?e(Md(t)):[]}}),Yr("asyncIterator"),Yr("hasInstance"),Yr("isConcatSpreadable"),Yr("iterator"),Yr("match"),Yr("matchAll"),Yr("replace"),Yr("search"),Yr("species"),Yr("split");var xd=ta;Yr("toPrimitive"),xd();var Ud=ue,Vd=da;Yr("toStringTag"),Vd(Ud("Symbol"),"Symbol"),Yr("unscopables"),da(vt.JSON,"JSON",!0);var Fd,Bd,jd,Hd=ae.Symbol,Gd={},Wd=Mt,$d=ni,zd=Function.prototype,qd=Wd&&Object.getOwnPropertyDescriptor,Kd=$d(zd,"name"),Yd={EXISTS:Kd,PROPER:Kd&&"something"===function(){}.name,CONFIGURABLE:Kd&&(!Wd||Wd&&qd(zd,"name").configurable)},Jd=!ct((function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype})),Xd=ni,Zd=Pt,Qd=ti,tl=Jd,el=or("IE_PROTO"),il=Object,nl=il.prototype,sl=tl?il.getPrototypeOf:function(t){var e=Qd(t);if(Xd(e,el))return e[el];var i=e.constructor;return Zd(i)&&e instanceof i?i.prototype:e instanceof il?nl:null},ol=ct,rl=Pt,al=re,cl=Er,dl=sl,ll=Ur,hl=vi("iterator"),ul=!1;[].keys&&("next"in(jd=[].keys())?(Bd=dl(dl(jd)))!==Object.prototype&&(Fd=Bd):ul=!0);var pl=!al(Fd)||ol((function(){var t={};return Fd[hl].call(t)!==t}));rl((Fd=pl?{}:cl(Fd))[hl])||ll(Fd,hl,(function(){return this}));var ml={IteratorPrototype:Fd,BUGGY_SAFARI_ITERATORS:ul},gl=ml.IteratorPrototype,fl=Er,vl=$t,_l=da,El=Gd,Sl=function(){return this},Tl=mt,bl=xe,yl=Pt,Cl=String,wl=TypeError,Rl=function(t,e,i){try{return Tl(bl(Object.getOwnPropertyDescriptor(t,e)[i]))}catch(t){}},Il=dn,Al=function(t){if("object"==typeof t||yl(t))return t;throw wl("Can't set "+Cl(t)+" as a prototype")},Ol=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,i={};try{(t=Rl(Object.prototype,"__proto__","set"))(i,[]),e=i instanceof Array}catch(t){}return function(i,n){return Il(i),Al(n),e?t(i,n):i.__proto__=n,i}}():void 0),Nl=Mn,kl=Vt,Ll=function(t,e,i,n){var s=e+" Iterator";return t.prototype=fl(gl,{next:vl(+!n,i)}),_l(t,s,!1,!0),El[s]=Sl,t},Pl=sl,Dl=da,Ml=Ur,xl=Gd,Ul=ml,Vl=Yd.PROPER,Fl=Ul.BUGGY_SAFARI_ITERATORS,Bl=vi("iterator"),jl="keys",Hl="values",Gl="entries",Wl=function(){return this},$l=function(t,e,i,n,s,o,r){Ll(i,e,n);var a,c,d,l=function(t){if(t===s&&g)return g;if(!Fl&&t in p)return p[t];switch(t){case jl:case Hl:case Gl:return function(){return new i(this,t)}}return function(){return new i(this)}},h=e+" Iterator",u=!1,p=t.prototype,m=p[Bl]||p["@@iterator"]||s&&p[s],g=!Fl&&m||l(s),f="Array"==e&&p.entries||m;if(f&&(a=Pl(f.call(new t)))!==Object.prototype&&a.next&&(Dl(a,h,!0,!0),xl[h]=Wl),Vl&&s==Hl&&m&&m.name!==Hl&&(u=!0,g=function(){return kl(m,this)}),s)if(c={values:l(Hl),keys:o?g:l(jl),entries:l(Gl)},r)for(d in c)(Fl||u||!(d in p))&&Ml(p,d,c[d]);else Nl({target:e,proto:!0,forced:Fl||u},c);return r&&p[Bl]!==g&&Ml(p,Bl,g,{name:s}),xl[e]=g,c},zl=function(t,e){return{value:t,done:e}},ql=ne,Kl=Gd,Yl=wa;sn.f;var Jl=$l,Xl=zl,Zl="Array Iterator",Ql=Yl.set,th=Yl.getterFor(Zl);Jl(Array,"Array",(function(t,e){Ql(this,{type:Zl,target:ql(t),index:0,kind:e})}),(function(){var t=th(this),e=t.target,i=t.kind,n=t.index++;return!e||n>=e.length?(t.target=void 0,Xl(void 0,!0)):Xl("keys"==i?n:"values"==i?e[n]:[n,e[n]],!1)}),"values"),Kl.Arguments=Kl.Array;var eh={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},ih=vt,nh=fs,sh=yn,oh=Gd,rh=vi("toStringTag");for(var ah in eh){var ch=ih[ah],dh=ch&&ch.prototype;dh&&nh(dh)!==rh&&sh(dh,rh,ah),oh[ah]=oh.Array}var lh=Hd,hh=vi,uh=sn.f,ph=hh("metadata"),mh=Function.prototype;void 0===mh[ph]&&uh(mh,ph,{value:null}),Yr("dispose"),Yr("metadata");var gh=lh;Yr("asyncDispose");var fh=mt,vh=ue("Symbol"),_h=vh.keyFor,Eh=fh(vh.prototype.valueOf),Sh=vh.isRegisteredSymbol||function(t){try{return void 0!==_h(Eh(t))}catch(t){return!1}};Mn({target:"Symbol",stat:!0},{isRegisteredSymbol:Sh});for(var Th=Xe,bh=ue,yh=mt,Ch=Ne,wh=vi,Rh=bh("Symbol"),Ih=Rh.isWellKnownSymbol,Ah=bh("Object","getOwnPropertyNames"),Oh=yh(Rh.prototype.valueOf),Nh=Th("wks"),kh=0,Lh=Ah(Rh),Ph=Lh.length;kh<Ph;kh++)try{var Dh=Lh[kh];Ch(Rh[Dh])&&wh(Dh)}catch(t){}var Mh=function(t){if(Ih&&Ih(t))return!0;try{for(var e=Oh(t),i=0,n=Ah(Nh),s=n.length;i<s;i++)if(Nh[n[i]]==e)return!0}catch(t){}return!1};Mn({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Mh}),Yr("matcher"),Yr("observable"),Mn({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:Sh}),Mn({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Mh}),Yr("metadataKey"),Yr("patternMatch"),Yr("replaceAll");var xh=K(gh),Uh=mt,Vh=Fn,Fh=Es,Bh=te,jh=Uh("".charAt),Hh=Uh("".charCodeAt),Gh=Uh("".slice),Wh=function(t){return function(e,i){var n,s,o=Fh(Bh(e)),r=Vh(i),a=o.length;return r<0||r>=a?t?"":void 0:(n=Hh(o,r))<55296||n>56319||r+1===a||(s=Hh(o,r+1))<56320||s>57343?t?jh(o,r):n:t?Gh(o,r,r+2):s-56320+(n-55296<<10)+65536}},$h=(Wh(!1),Wh(!0)),zh=Es,qh=wa,Kh=$l,Yh=zl,Jh="String Iterator",Xh=qh.set,Zh=qh.getterFor(Jh);Kh(String,"String",(function(t){Xh(this,{type:Jh,string:zh(t),index:0})}),(function(){var t,e=Zh(this),i=e.string,n=e.index;return n>=i.length?Yh(void 0,!0):(t=$h(i,n),e.index+=t.length,Yh(t,!1))}));var Qh=K(Br.f("iterator"));function tu(t){return tu="function"==typeof xh&&"symbol"==typeof Qh?function(t){return typeof t}:function(t){return t&&"function"==typeof xh&&t.constructor===xh&&t!==xh.prototype?"symbol":typeof t},tu(t)}var eu=K(Br.f("toPrimitive"));function iu(t){var e=function(t,e){if("object"!==tu(t)||null===t)return t;var i=t[eu];if(void 0!==i){var n=i.call(t,e||"default");if("object"!==tu(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===tu(e)?e:String(e)}function nu(t,e,i){return(e=iu(e))in t?Bs(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var su=es("Array").keys,ou=fs,ru=ni,au=gt,cu=su,du=Array.prototype,lu={DOMTokenList:!0,NodeList:!0},hu=K((function(t){var e=t.keys;return t===du||au(du,t)&&e===du.keys||ru(lu,ou(t))?cu:e})),uu=Le,pu=TypeError,mu=Or,gu=Math.floor,fu=function(t,e){var i=t.length,n=gu(i/2);return i<8?vu(t,e):_u(t,fu(mu(t,0,n),e),fu(mu(t,n),e),e)},vu=function(t,e){for(var i,n,s=t.length,o=1;o<s;){for(n=o,i=t[o];n&&e(t[n-1],i)>0;)t[n]=t[--n];n!==o++&&(t[n]=i)}return t},_u=function(t,e,i,n){for(var s=e.length,o=i.length,r=0,a=0;r<s||a<o;)t[r+a]=r<s&&a<o?n(e[r],i[a])<=0?e[r++]:i[a++]:r<s?e[r++]:i[a++];return t},Eu=fu,Su=ct,Tu=function(t,e){var i=[][t];return!!i&&Su((function(){i.call(null,e||function(){return 1},1)}))},bu=pe.match(/firefox\/(\d+)/i),yu=!!bu&&+bu[1],Cu=/MSIE|Trident/.test(pe),wu=pe.match(/AppleWebKit\/(\d+)\./),Ru=!!wu&&+wu[1],Iu=Mn,Au=mt,Ou=xe,Nu=ti,ku=qn,Lu=function(t,e){if(!delete t[e])throw pu("Cannot delete property "+uu(e)+" of "+uu(t))},Pu=Es,Du=ct,Mu=Eu,xu=Tu,Uu=yu,Vu=Cu,Fu=Se,Bu=Ru,ju=[],Hu=Au(ju.sort),Gu=Au(ju.push),Wu=Du((function(){ju.sort(void 0)})),$u=Du((function(){ju.sort(null)})),zu=xu("sort"),qu=!Du((function(){if(Fu)return Fu<70;if(!(Uu&&Uu>3)){if(Vu)return!0;if(Bu)return Bu<603;var t,e,i,n,s="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)ju.push({k:e+n,v:i})}for(ju.sort((function(t,e){return e.v-t.v})),n=0;n<ju.length;n++)e=ju[n].k.charAt(0),s.charAt(s.length-1)!==e&&(s+=e);return"DGBEFHACIJK"!==s}}));Iu({target:"Array",proto:!0,forced:Wu||!$u||!zu||!qu},{sort:function(t){void 0!==t&&Ou(t);var e=Nu(this);if(qu)return void 0===t?Hu(e):Hu(e,t);var i,n,s=[],o=ku(e);for(n=0;n<o;n++)n in e&&Gu(s,e[n]);for(Mu(s,function(t){return function(e,i){return void 0===i?-1:void 0===e?1:void 0!==t?+t(e,i)||0:Pu(e)>Pu(i)?1:-1}}(t)),i=ku(s),n=0;n<i;)e[n]=s[n++];for(;n<o;)Lu(e,n++);return e}});var Ku=es("Array").sort,Yu=gt,Ju=Ku,Xu=Array.prototype,Zu=K((function(t){var e=t.sort;return t===Xu||Yu(Xu,t)&&e===Xu.sort?Ju:e})),Qu=ue,tp=Sr,ep=Mr,ip=dn,np=mt([].concat),sp=Qu("Reflect","ownKeys")||function(t){var e=tp.f(ip(t)),i=ep.f;return i?np(e,i(t)):e},op=ni,rp=sp,ap=Dt,cp=sn,dp=re,lp=yn,hp=Error,up=mt("".replace),pp=String(hp("zxcasd").stack),mp=/\n\s*at [^:]*:[^\n]*/,gp=mp.test(pp),fp=$t,vp=!ct((function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",fp(1,7)),7!==t.stack)})),_p=yn,Ep=function(t,e){if(gp&&"string"==typeof t&&!hp.prepareStackTrace)for(;e--;)t=up(t,mp,"");return t},Sp=vp,Tp=Error.captureStackTrace,bp=Gd,yp=vi("iterator"),Cp=Array.prototype,wp=fs,Rp=Fe,Ip=Xt,Ap=Gd,Op=vi("iterator"),Np=function(t){if(!Ip(t))return Rp(t,Op)||Rp(t,"@@iterator")||Ap[wp(t)]},kp=Vt,Lp=xe,Pp=dn,Dp=Le,Mp=Np,xp=TypeError,Up=Vt,Vp=dn,Fp=Fe,Bp=nn,jp=Vt,Hp=dn,Gp=Le,Wp=function(t){return void 0!==t&&(bp.Array===t||Cp[yp]===t)},$p=qn,zp=gt,qp=function(t,e){var i=arguments.length<2?Mp(t):e;if(Lp(i))return Pp(kp(i,t));throw xp(Dp(t)+" is not iterable")},Kp=Np,Yp=function(t,e,i){var n,s;Vp(t);try{if(!(n=Fp(t,"return"))){if("throw"===e)throw i;return i}n=Up(n,t)}catch(t){s=!0,n=t}if("throw"===e)throw i;if(s)throw n;return Vp(n),i},Jp=TypeError,Xp=function(t,e){this.stopped=t,this.result=e},Zp=Xp.prototype,Qp=function(t,e,i){var n,s,o,r,a,c,d,l=i&&i.that,h=!(!i||!i.AS_ENTRIES),u=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),m=!(!i||!i.INTERRUPTED),g=Bp(e,l),f=function(t){return n&&Yp(n,"normal",t),new Xp(!0,t)},v=function(t){return h?(Hp(t),m?g(t[0],t[1],f):g(t[0],t[1])):m?g(t,f):g(t)};if(u)n=t.iterator;else if(p)n=t;else{if(!(s=Kp(t)))throw Jp(Gp(t)+" is not iterable");if(Wp(s)){for(o=0,r=$p(t);r>o;o++)if((a=v(t[o]))&&zp(Zp,a))return a;return new Xp(!1)}n=qp(t,s)}for(c=u?t.next:n.next;!(d=jp(c,n)).done;){try{a=v(d.value)}catch(t){Yp(n,"throw",t)}if("object"==typeof a&&a&&zp(Zp,a))return a}return new Xp(!1)},tm=Es,em=Mn,im=gt,nm=sl,sm=Ol,om=function(t,e,i){for(var n=rp(e),s=cp.f,o=ap.f,r=0;r<n.length;r++){var a=n[r];op(t,a)||i&&op(i,a)||s(t,a,o(e,a))}},rm=Er,am=yn,cm=$t,dm=function(t,e){dp(e)&&"cause"in e&&lp(t,"cause",e.cause)},lm=function(t,e,i,n){Sp&&(Tp?Tp(t,e):_p(t,"stack",Ep(i,n)))},hm=Qp,um=function(t,e){return void 0===t?arguments.length<2?"":e:tm(t)},pm=vi("toStringTag"),mm=Error,gm=[].push,fm=function(t,e){var i,n=im(vm,this);sm?i=sm(mm(),n?nm(this):vm):(i=n?this:rm(vm),am(i,pm,"Error")),void 0!==e&&am(i,"message",um(e)),lm(i,fm,i.stack,1),arguments.length>2&&dm(i,arguments[2]);var s=[];return hm(t,gm,{that:s}),am(i,"errors",s),i};sm?sm(fm,mm):om(fm,mm,{name:!0});var vm=fm.prototype=rm(mm.prototype,{constructor:cm(1,fm),message:cm(1,""),name:cm(1,"AggregateError")});em({global:!0,constructor:!0,arity:2},{AggregateError:fm});var _m,Em,Sm,Tm,bm="undefined"!=typeof process&&"process"==Rt(process),ym=ue,Cm=Fr,wm=Mt,Rm=vi("species"),Im=gt,Am=TypeError,Om=uo,Nm=Le,km=TypeError,Lm=dn,Pm=function(t){if(Om(t))return t;throw km(Nm(t)+" is not a constructor")},Dm=Xt,Mm=vi("species"),xm=function(t,e){var i,n=Lm(t).constructor;return void 0===n||Dm(i=Lm(n)[Mm])?e:Pm(i)},Um=TypeError,Vm=/(?:ipad|iphone|ipod).*applewebkit/i.test(pe),Fm=vt,Bm=bt,jm=nn,Hm=Pt,Gm=ni,Wm=ct,$m=ir,zm=nd,qm=ki,Km=function(t,e){if(t<e)throw Um("Not enough arguments");return t},Ym=Vm,Jm=bm,Xm=Fm.setImmediate,Zm=Fm.clearImmediate,Qm=Fm.process,tg=Fm.Dispatch,eg=Fm.Function,ig=Fm.MessageChannel,ng=Fm.String,sg=0,og={},rg="onreadystatechange";Wm((function(){_m=Fm.location}));var ag=function(t){if(Gm(og,t)){var e=og[t];delete og[t],e()}},cg=function(t){return function(){ag(t)}},dg=function(t){ag(t.data)},lg=function(t){Fm.postMessage(ng(t),_m.protocol+"//"+_m.host)};Xm&&Zm||(Xm=function(t){Km(arguments.length,1);var e=Hm(t)?t:eg(t),i=zm(arguments,1);return og[++sg]=function(){Bm(e,void 0,i)},Em(sg),sg},Zm=function(t){delete og[t]},Jm?Em=function(t){Qm.nextTick(cg(t))}:tg&&tg.now?Em=function(t){tg.now(cg(t))}:ig&&!Ym?(Tm=(Sm=new ig).port2,Sm.port1.onmessage=dg,Em=jm(Tm.postMessage,Tm)):Fm.addEventListener&&Hm(Fm.postMessage)&&!Fm.importScripts&&_m&&"file:"!==_m.protocol&&!Wm(lg)?(Em=lg,Fm.addEventListener("message",dg,!1)):Em=rg in qm("script")?function(t){$m.appendChild(qm("script"))[rg]=function(){$m.removeChild(this),ag(t)}}:function(t){setTimeout(cg(t),0)});var hg={set:Xm,clear:Zm},ug=function(){this.head=null,this.tail=null};ug.prototype={add:function(t){var e={item:t,next:null},i=this.tail;i?i.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return null===(this.head=t.next)&&(this.tail=null),t.item}};var pg,mg,gg,fg,vg,_g=ug,Eg=/ipad|iphone|ipod/i.test(pe)&&"undefined"!=typeof Pebble,Sg=/web0s(?!.*chrome)/i.test(pe),Tg=vt,bg=nn,yg=Dt.f,Cg=hg.set,wg=_g,Rg=Vm,Ig=Eg,Ag=Sg,Og=bm,Ng=Tg.MutationObserver||Tg.WebKitMutationObserver,kg=Tg.document,Lg=Tg.process,Pg=Tg.Promise,Dg=yg(Tg,"queueMicrotask"),Mg=Dg&&Dg.value;if(!Mg){var xg=new wg,Ug=function(){var t,e;for(Og&&(t=Lg.domain)&&t.exit();e=xg.get();)try{e()}catch(t){throw xg.head&&pg(),t}t&&t.enter()};Rg||Og||Ag||!Ng||!kg?!Ig&&Pg&&Pg.resolve?((fg=Pg.resolve(void 0)).constructor=Pg,vg=bg(fg.then,fg),pg=function(){vg(Ug)}):Og?pg=function(){Lg.nextTick(Ug)}:(Cg=bg(Cg,Tg),pg=function(){Cg(Ug)}):(mg=!0,gg=kg.createTextNode(""),new Ng(Ug).observe(gg,{characterData:!0}),pg=function(){gg.data=mg=!mg}),Mg=function(t){xg.head||pg(),xg.add(t)}}var Vg=Mg,Fg=function(t){try{return{error:!1,value:t()}}catch(t){return{error:!0,value:t}}},Bg=vt.Promise,jg="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,Hg=!jg&&!bm&&"object"==typeof window&&"object"==typeof document,Gg=vt,Wg=Bg,$g=Pt,zg=Zi,qg=Xs,Kg=vi,Yg=Hg,Jg=jg,Xg=Se,Zg=Wg&&Wg.prototype,Qg=Kg("species"),tf=!1,ef=$g(Gg.PromiseRejectionEvent),nf=zg("Promise",(function(){var t=qg(Wg),e=t!==String(Wg);if(!e&&66===Xg)return!0;if(!Zg.catch||!Zg.finally)return!0;if(!Xg||Xg<51||!/native code/.test(t)){var i=new Wg((function(t){t(1)})),n=function(t){t((function(){}),(function(){}))};if((i.constructor={})[Qg]=n,!(tf=i.then((function(){}))instanceof n))return!0}return!e&&(Yg||Jg)&&!ef})),sf={CONSTRUCTOR:nf,REJECTION_EVENT:ef,SUBCLASSING:tf},of={},rf=xe,af=TypeError,cf=function(t){var e,i;this.promise=new t((function(t,n){if(void 0!==e||void 0!==i)throw af("Bad Promise constructor");e=t,i=n})),this.resolve=rf(e),this.reject=rf(i)};of.f=function(t){return new cf(t)};var df,lf,hf=Mn,uf=bm,pf=vt,mf=Vt,gf=Ur,ff=da,vf=function(t){var e=ym(t);wm&&e&&!e[Rm]&&Cm(e,Rm,{configurable:!0,get:function(){return this}})},_f=xe,Ef=Pt,Sf=re,Tf=function(t,e){if(Im(e,t))return t;throw Am("Incorrect invocation")},bf=xm,yf=hg.set,Cf=Vg,wf=function(t,e){try{1==arguments.length?console.error(t):console.error(t,e)}catch(t){}},Rf=Fg,If=_g,Af=wa,Of=Bg,Nf=sf,kf=of,Lf="Promise",Pf=Nf.CONSTRUCTOR,Df=Nf.REJECTION_EVENT,Mf=Af.getterFor(Lf),xf=Af.set,Uf=Of&&Of.prototype,Vf=Of,Ff=Uf,Bf=pf.TypeError,jf=pf.document,Hf=pf.process,Gf=kf.f,Wf=Gf,$f=!!(jf&&jf.createEvent&&pf.dispatchEvent),zf="unhandledrejection",qf=function(t){var e;return!(!Sf(t)||!Ef(e=t.then))&&e},Kf=function(t,e){var i,n,s,o=e.value,r=1==e.state,a=r?t.ok:t.fail,c=t.resolve,d=t.reject,l=t.domain;try{a?(r||(2===e.rejection&&Qf(e),e.rejection=1),!0===a?i=o:(l&&l.enter(),i=a(o),l&&(l.exit(),s=!0)),i===t.promise?d(Bf("Promise-chain cycle")):(n=qf(i))?mf(n,i,c,d):c(i)):d(o)}catch(t){l&&!s&&l.exit(),d(t)}},Yf=function(t,e){t.notified||(t.notified=!0,Cf((function(){for(var i,n=t.reactions;i=n.get();)Kf(i,t);t.notified=!1,e&&!t.rejection&&Xf(t)})))},Jf=function(t,e,i){var n,s;$f?((n=jf.createEvent("Event")).promise=e,n.reason=i,n.initEvent(t,!1,!0),pf.dispatchEvent(n)):n={promise:e,reason:i},!Df&&(s=pf["on"+t])?s(n):t===zf&&wf("Unhandled promise rejection",i)},Xf=function(t){mf(yf,pf,(function(){var e,i=t.facade,n=t.value;if(Zf(t)&&(e=Rf((function(){uf?Hf.emit("unhandledRejection",n,i):Jf(zf,i,n)})),t.rejection=uf||Zf(t)?2:1,e.error))throw e.value}))},Zf=function(t){return 1!==t.rejection&&!t.parent},Qf=function(t){mf(yf,pf,(function(){var e=t.facade;uf?Hf.emit("rejectionHandled",e):Jf("rejectionhandled",e,t.value)}))},tv=function(t,e,i){return function(n){t(e,n,i)}},ev=function(t,e,i){t.done||(t.done=!0,i&&(t=i),t.value=e,t.state=2,Yf(t,!0))},iv=function(t,e,i){if(!t.done){t.done=!0,i&&(t=i);try{if(t.facade===e)throw Bf("Promise can't be resolved itself");var n=qf(e);n?Cf((function(){var i={done:!1};try{mf(n,e,tv(iv,i,t),tv(ev,i,t))}catch(e){ev(i,e,t)}})):(t.value=e,t.state=1,Yf(t,!1))}catch(e){ev({done:!1},e,t)}}};Pf&&(Ff=(Vf=function(t){Tf(this,Ff),_f(t),mf(df,this);var e=Mf(this);try{t(tv(iv,e),tv(ev,e))}catch(t){ev(e,t)}}).prototype,(df=function(t){xf(this,{type:Lf,done:!1,notified:!1,parent:!1,reactions:new If,rejection:!1,state:0,value:void 0})}).prototype=gf(Ff,"then",(function(t,e){var i=Mf(this),n=Gf(bf(this,Vf));return i.parent=!0,n.ok=!Ef(t)||t,n.fail=Ef(e)&&e,n.domain=uf?Hf.domain:void 0,0==i.state?i.reactions.add(n):Cf((function(){Kf(n,i)})),n.promise})),lf=function(){var t=new df,e=Mf(t);this.promise=t,this.resolve=tv(iv,e),this.reject=tv(ev,e)},kf.f=Gf=function(t){return t===Vf||void 0===t?new lf(t):Wf(t)}),hf({global:!0,constructor:!0,wrap:!0,forced:Pf},{Promise:Vf}),ff(Vf,Lf,!1,!0),vf(Lf);var nv=vi("iterator"),sv=!1;try{var ov=0,rv={next:function(){return{done:!!ov++}},return:function(){sv=!0}};rv[nv]=function(){return this},Array.from(rv,(function(){throw 2}))}catch(t){}var av=Bg,cv=function(t,e){if(!e&&!sv)return!1;var i=!1;try{var n={};n[nv]=function(){return{next:function(){return{done:i=!0}}}},t(n)}catch(t){}return i},dv=sf.CONSTRUCTOR||!cv((function(t){av.all(t).then(void 0,(function(){}))})),lv=Vt,hv=xe,uv=of,pv=Fg,mv=Qp;Mn({target:"Promise",stat:!0,forced:dv},{all:function(t){var e=this,i=uv.f(e),n=i.resolve,s=i.reject,o=pv((function(){var i=hv(e.resolve),o=[],r=0,a=1;mv(t,(function(t){var c=r++,d=!1;a++,lv(i,e,t).then((function(t){d||(d=!0,o[c]=t,--a||n(o))}),s)})),--a||n(o)}));return o.error&&s(o.value),i.promise}});var gv=Mn,fv=sf.CONSTRUCTOR;Bg&&Bg.prototype,gv({target:"Promise",proto:!0,forced:fv,real:!0},{catch:function(t){return this.then(void 0,t)}});var vv=Vt,_v=xe,Ev=of,Sv=Fg,Tv=Qp;Mn({target:"Promise",stat:!0,forced:dv},{race:function(t){var e=this,i=Ev.f(e),n=i.reject,s=Sv((function(){var s=_v(e.resolve);Tv(t,(function(t){vv(s,e,t).then(i.resolve,n)}))}));return s.error&&n(s.value),i.promise}});var bv=Vt,yv=of;Mn({target:"Promise",stat:!0,forced:sf.CONSTRUCTOR},{reject:function(t){var e=yv.f(this);return bv(e.reject,void 0,t),e.promise}});var Cv=dn,wv=re,Rv=of,Iv=function(t,e){if(Cv(t),wv(e)&&e.constructor===t)return e;var i=Rv.f(t);return(0,i.resolve)(e),i.promise},Av=Mn,Ov=Bg,Nv=sf.CONSTRUCTOR,kv=Iv,Lv=ue("Promise"),Pv=!Nv;Av({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return kv(Pv&&this===Lv?Ov:this,t)}});var Dv=Vt,Mv=xe,xv=of,Uv=Fg,Vv=Qp;Mn({target:"Promise",stat:!0,forced:dv},{allSettled:function(t){var e=this,i=xv.f(e),n=i.resolve,s=i.reject,o=Uv((function(){var i=Mv(e.resolve),s=[],o=0,r=1;Vv(t,(function(t){var a=o++,c=!1;r++,Dv(i,e,t).then((function(t){c||(c=!0,s[a]={status:"fulfilled",value:t},--r||n(s))}),(function(t){c||(c=!0,s[a]={status:"rejected",reason:t},--r||n(s))}))})),--r||n(s)}));return o.error&&s(o.value),i.promise}});var Fv=Vt,Bv=xe,jv=ue,Hv=of,Gv=Fg,Wv=Qp,$v="No one promise resolved";Mn({target:"Promise",stat:!0,forced:dv},{any:function(t){var e=this,i=jv("AggregateError"),n=Hv.f(e),s=n.resolve,o=n.reject,r=Gv((function(){var n=Bv(e.resolve),r=[],a=0,c=1,d=!1;Wv(t,(function(t){var l=a++,h=!1;c++,Fv(n,e,t).then((function(t){h||d||(d=!0,s(t))}),(function(t){h||d||(h=!0,r[l]=t,--c||o(new i(r,$v)))}))})),--c||o(new i(r,$v))}));return r.error&&o(r.value),n.promise}});var zv=Mn,qv=Bg,Kv=ct,Yv=ue,Jv=Pt,Xv=xm,Zv=Iv,Qv=qv&&qv.prototype;zv({target:"Promise",proto:!0,real:!0,forced:!!qv&&Kv((function(){Qv.finally.call({then:function(){}},(function(){}))}))},{finally:function(t){var e=Xv(this,Yv("Promise")),i=Jv(t);return this.then(i?function(i){return Zv(e,t()).then((function(){return i}))}:t,i?function(i){return Zv(e,t()).then((function(){throw i}))}:t)}});var t_=ae.Promise,e_=K(t_);const i_=()=>{};function n_(){const t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:i_};return t.promise=new e_(((e,i)=>{t.resolve=i=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(i),t.value=i)},t.reject=e=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,i(e))}})),t}const s_=new Map,o_=new Map,r_=new Map;var a_,c_;!function(t){t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot"}(a_||(a_={})),function(t){t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger"}(c_||(c_={}));var d_={exports:{}};!function(t,e){!function(i,n){var s="function",o="undefined",r="object",a="string",c="major",d="model",l="name",h="type",u="vendor",p="version",m="architecture",g="console",f="mobile",v="tablet",_="smarttv",E="wearable",S="embedded",T="Amazon",b="Apple",y="ASUS",C="BlackBerry",w="Browser",R="Chrome",I="Firefox",A="Google",O="Huawei",N="LG",k="Microsoft",L="Motorola",P="Opera",D="Samsung",M="Sharp",x="Sony",U="Xiaomi",V="Zebra",F="Facebook",B="Chromium OS",j="Mac OS",H=function(t){for(var e={},i=0;i<t.length;i++)e[t[i].toUpperCase()]=t[i];return e},G=function(t,e){return typeof t===a&&-1!==W(e).indexOf(W(t))},W=function(t){return t.toLowerCase()},$=function(t,e){if(typeof t===a)return t=t.replace(/^\s\s*/,""),typeof e===o?t:t.substring(0,350)},z=function(t,e){for(var i,o,a,c,d,l,h=0;h<e.length&&!d;){var u=e[h],p=e[h+1];for(i=o=0;i<u.length&&!d&&u[i];)if(d=u[i++].exec(t))for(a=0;a<p.length;a++)l=d[++o],typeof(c=p[a])===r&&c.length>0?2===c.length?typeof c[1]==s?this[c[0]]=c[1].call(this,l):this[c[0]]=c[1]:3===c.length?typeof c[1]!==s||c[1].exec&&c[1].test?this[c[0]]=l?l.replace(c[1],c[2]):n:this[c[0]]=l?c[1].call(this,l,c[2]):n:4===c.length&&(this[c[0]]=l?c[3].call(this,l.replace(c[1],c[2])):n):this[c]=l||n;h+=2}},q=function(t,e){for(var i in e)if(typeof e[i]===r&&e[i].length>0){for(var s=0;s<e[i].length;s++)if(G(e[i][s],t))return"?"===i?n:i}else if(G(e[i],t))return"?"===i?n:i;return t},K={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Y={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,P+" Mini"]],[/\bopr\/([\w\.]+)/i],[p,[l,P]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+w]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+w],p],[/\bfocus\/([\w\.]+)/i],[p,[l,I+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,P+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,P+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI "+w]],[/fxios\/([-\w\.]+)/i],[p,[l,I]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 "+w]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 "+w],p],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,F],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,R+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,R+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+w]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,q,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,I+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[l,p],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,W]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[m,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/windows (ce|mobile); ppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[m,/ower/,"",W]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[m,W]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[u,D],[h,v]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[u,D],[h,f]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[u,b],[h,f]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[u,b],[h,v]],[/(macintosh);/i],[d,[u,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[u,M],[h,f]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[u,O],[h,v]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[u,O],[h,f]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[u,U],[h,f]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[u,U],[h,v]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[u,"OPPO"],[h,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[u,"Vivo"],[h,f]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[u,"Realme"],[h,f]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[u,L],[h,f]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[u,L],[h,v]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[u,N],[h,v]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[u,N],[h,f]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[u,"Lenovo"],[h,v]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[u,"Nokia"],[h,f]],[/(pixel c)\b/i],[d,[u,A],[h,v]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[u,A],[h,f]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[u,x],[h,f]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[u,x],[h,v]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[u,"OnePlus"],[h,f]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[u,T],[h,v]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[u,T],[h,f]],[/(playbook);[-\w\),; ]+(rim)/i],[d,u,[h,v]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[u,C],[h,f]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[u,y],[h,v]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[u,y],[h,f]],[/(nexus 9)/i],[d,[u,"HTC"],[h,v]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[d,/_/g," "],[h,f]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[u,"Acer"],[h,v]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[u,"Meizu"],[h,f]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,d,[h,f]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,d,[h,v]],[/(surface duo)/i],[d,[u,k],[h,v]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[u,"Fairphone"],[h,f]],[/(u304aa)/i],[d,[u,"AT&T"],[h,f]],[/\bsie-(\w*)/i],[d,[u,"Siemens"],[h,f]],[/\b(rct\w+) b/i],[d,[u,"RCA"],[h,v]],[/\b(venue[\d ]{2,7}) b/i],[d,[u,"Dell"],[h,v]],[/\b(q(?:mv|ta)\w+) b/i],[d,[u,"Verizon"],[h,v]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[u,"Barnes & Noble"],[h,v]],[/\b(tm\d{3}\w+) b/i],[d,[u,"NuVision"],[h,v]],[/\b(k88) b/i],[d,[u,"ZTE"],[h,v]],[/\b(nx\d{3}j) b/i],[d,[u,"ZTE"],[h,f]],[/\b(gen\d{3}) b.+49h/i],[d,[u,"Swiss"],[h,f]],[/\b(zur\d{3}) b/i],[d,[u,"Swiss"],[h,v]],[/\b((zeki)?tb.*\b) b/i],[d,[u,"Zeki"],[h,v]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],d,[h,v]],[/\b(ns-?\w{0,9}) b/i],[d,[u,"Insignia"],[h,v]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[u,"NextBook"],[h,v]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],d,[h,f]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],d,[h,f]],[/\b(ph-1) /i],[d,[u,"Essential"],[h,f]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[u,"Envizen"],[h,v]],[/\b(trio[-\w\. ]+) b/i],[d,[u,"MachSpeed"],[h,v]],[/\btu_(1491) b/i],[d,[u,"Rotor"],[h,v]],[/(shield[\w ]+) b/i],[d,[u,"Nvidia"],[h,v]],[/(sprint) (\w+)/i],[u,d,[h,f]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[u,k],[h,f]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[u,V],[h,v]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[u,V],[h,f]],[/smart-tv.+(samsung)/i],[u,[h,_]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[u,D],[h,_]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,N],[h,_]],[/(apple) ?tv/i],[u,[d,b+" TV"],[h,_]],[/crkey/i],[[d,R+"cast"],[u,A],[h,_]],[/droid.+aft(\w)( bui|\))/i],[d,[u,T],[h,_]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[u,M],[h,_]],[/(bravia[\w ]+)( bui|\))/i],[d,[u,x],[h,_]],[/(mitv-\w{5}) bui/i],[d,[u,U],[h,_]],[/Hbbtv.*(technisat) (.*);/i],[u,d,[h,_]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,$],[d,$],[h,_]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[h,_]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,d,[h,g]],[/droid.+; (shield) bui/i],[d,[u,"Nvidia"],[h,g]],[/(playstation [345portablevi]+)/i],[d,[u,x],[h,g]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[u,k],[h,g]],[/((pebble))app/i],[u,d,[h,E]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[u,b],[h,E]],[/droid.+; (glass) \d/i],[d,[u,A],[h,E]],[/droid.+; (wt63?0{2,3})\)/i],[d,[u,V],[h,E]],[/(quest( 2| pro)?)/i],[d,[u,F],[h,E]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[h,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[h,f]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[h,v]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[h,v]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[h,f]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[p,q,K]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[p,q,K]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,j],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,C]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,I+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,R+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,B],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,p]]},J=function(t,e){if(typeof t===r&&(e=t,t=n),!(this instanceof J))return new J(t,e).getResult();var g=typeof i!==o&&i.navigator?i.navigator:n,_=t||(g&&g.userAgent?g.userAgent:""),E=g&&g.userAgentData?g.userAgentData:n,S=e?function(t,e){var i={};for(var n in t)e[n]&&e[n].length%2==0?i[n]=e[n].concat(t[n]):i[n]=t[n];return i}(Y,e):Y;return this.getBrowser=function(){var t={};return t[l]=n,t[p]=n,z.call(t,_,S.browser),t[c]=function(t){return typeof t===a?t.replace(/[^\d\.]/g,"").split(".")[0]:n}(t[p]),g&&g.brave&&typeof g.brave.isBrave==s&&(t[l]="Brave"),t},this.getCPU=function(){var t={};return t[m]=n,z.call(t,_,S.cpu),t},this.getDevice=function(){var t={};return t[u]=n,t[d]=n,t[h]=n,z.call(t,_,S.device),!t[h]&&E&&E.mobile&&(t[h]=f),"Macintosh"==t[d]&&g&&typeof g.standalone!==o&&g.maxTouchPoints&&g.maxTouchPoints>2&&(t[d]="iPad",t[h]=v),t},this.getEngine=function(){var t={};return t[l]=n,t[p]=n,z.call(t,_,S.engine),t},this.getOS=function(){var t={};return t[l]=n,t[p]=n,z.call(t,_,S.os),!t[l]&&E&&"Unknown"!=E.platform&&(t[l]=E.platform.replace(/chrome os/i,B).replace(/macos/i,j)),t},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return _},this.setUA=function(t){return _=typeof t===a&&t.length>350?$(t,350):t,this},this.setUA(_),this};J.VERSION="0.7.34",J.BROWSER=H([l,p,c]),J.CPU=H([m]),J.DEVICE=H([d,u,h,g,f,_,v,E,S]),J.ENGINE=J.OS=H([l,p]),t.exports&&(e=t.exports=J),e.UAParser=J;var X=typeof i!==o&&(i.jQuery||i.Zepto);if(X&&!X.ua){var Z=new J;X.ua=Z.getResult(),X.ua.get=function(){return Z.getUA()},X.ua.set=function(t){Z.setUA(t);var e=Z.getResult();for(var i in e)X.ua[i]=e[i]}}}("object"==typeof window?window:q)}(d_,d_.exports);const l_=new(K(d_.exports));let h_=l_.getResult(),u_=null;function p_(t){if(!u_){t&&l_.setUA(t),h_=l_.getResult();const e=function(t){if("Blink"===t.engine.name&&"WeChat"!==t.browser.name)return c_.CHROME;switch(t.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return c_.CHROME;case"Safari":case"Mobile Safari":return c_.SAFARI;case"Edge":return c_.EDGE;case"Firefox":return c_.FIREFOX;case"QQBrowser":return c_.QQ;case"Opera":return c_.OPERA;case"WeChat":return c_.WECHAT;default:return t.browser.name||""}}(h_),i=function(t){let e;return e="Blink"===t.engine.name?t.engine.version||"":t.browser.version||"",e.split(".")[0]}(h_),n=function(t){return"Windows"===t.os.name?t.os.version?t.os.name+" "+t.os.version:t.os.name:t.os.name||""}(h_),s=h_.os.version;if(!(e&&i&&n&&s))return{name:e,version:i,os:n,osVersion:s};u_={name:e,version:i,os:n,osVersion:s}}return u_}function m_(){return p_().os}function g_(){const t=p_();return"".concat(t.os," ").concat(t.osVersion)}function f_(){const t=p_();return!!("WebKit"===h_.engine.name&&t.os===a_.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==c_.SAFARI||b_()&&t.name!==c_.SAFARI)}function v_(){const t=p_();if(f_()){if(t.os===a_.MAC_OS)return!0;if(t.os===a_.IOS){const t=h_.os.version&&h_.os.version.split(".");if(t&&14===Number(t[0])&&t[1]&&Number(t[1])>=3)return!0;if(t&&Number(t[0])>14)return!0}}return!1}function __(){return"WebKit"===h_.engine.name}function E_(){return p_().name===c_.CHROME}function S_(){return p_().name===c_.SAFARI}function T_(){return p_().name===c_.FIREFOX}function b_(){return p_().os===a_.IOS}function y_(t){const e=p_();return!(e.name!==c_.CHROME||!e.osVersion)&&Number(e.version)>=t}function C_(t){const e=p_();return!(e.name!==c_.EDGE||!e.osVersion)&&Number(e.version)>=t}function w_(t){const e=p_();return!(e.name!==c_.OPERA||!e.osVersion)&&Number(e.version)>=t}function R_(){const t=p_();return!(t.name!==c_.CHROME||!t.osVersion)&&Number(t.version)<=90}function I_(){const t=p_();if(t.os!==a_.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||14===Number(e[0])&&Number(e[1])<=6}function A_(){const t=p_();if(t.os!==a_.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])}function O_(){const t=p_();if(t.os!==a_.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 16===Number(e[0])}function N_(){const t=p_();if(t.os!==a_.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])&&Number(e[1])>=1}function k_(){return S_()&&navigator.maxTouchPoints>0}function L_(){return p_().name===c_.WECHAT}function P_(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function D_(){const t=p_();return t.name!==c_.EDGE&&t.name!==c_.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function M_(){return m_()===a_.ANDROID}function x_(){const t=p_();return M_()&&(t.name===c_.CHROME||t.name===c_.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var U_;!function(t){t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED"}(U_||(U_={}));let V_=class extends Error{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(e),nu(this,"code",void 0),nu(this,"message",void 0),nu(this,"data",void 0),nu(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),"\n").concat(this.stack):"".concat(this.stack)}print(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return"error"===t&&(e||console).error(this.toString()),"warning"===t&&(e||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}};function F_(t,e){if("boolean"!=typeof t)throw new V_(U_.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function B_(t,e,i){if(!Ps(i).call(i,t))throw new V_(U_.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(i)))}function j_(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(t<i||t>n||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!function(t){return"number"==typeof t&&t%1==0}(t))throw new V_(U_.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(i,", ").concat(n,"]. integer only"))}function H_(t,e){if("number"!=typeof t){if(!(t.min||t.max||t.ideal||t.exact))throw new V_(U_.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));void 0!==t.min&&j_(t.min,"".concat(e,".min"),0,1/0),void 0!==t.max&&j_(t.max,"".concat(e,".max"),1,1/0),void 0!==t.exact&&j_(t.exact,"".concat(e,".exact"),1,1/0),void 0!==t.ideal&&j_(t.ideal,"".concat(e,".ideal"),1,1/0)}else j_(t,e,1,1/0)}function G_(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==t)throw new V_(U_.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!z_(t,i,n,s))throw new V_(U_.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(i,",").concat(n,"].").concat(s?" ASCII characters only.":""))}function W_(t,e){if(!Array.isArray(t))throw new V_(U_.INVALID_PARAMS,"".concat(e," should be an array"))}function $_(t){return null==t}function z_(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof t&&t.length<=i&&t.length>=e&&(!n||function(t){if("string"!=typeof t)return!1;for(let e=0;e<t.length;e+=1){const i=t.charCodeAt(e);if(i<0||i>255)return!1}return!0}(t))}function q_(t,e,i){if("getBigUint64"in DataView.prototype)return t.getBigUint64(e,i);const n=t.getUint32(e,i),s=t.getUint32(e+4,i),o=Number(!!i),r=Number(!i);return BigInt(n*r+s*o)<<BigInt(32)|BigInt(n*o+s*r)}function K_(t,e,i,n){if("setBigUint64"in DataView.prototype)return t.setBigUint64(e,i,n);const s=Number(i>>BigInt(32)),o=Number(i&BigInt(4294967295));n?(t.setUint32(e+4,s,n),t.setUint32(e,o,n)):(t.setUint32(e,s,n),t.setUint32(e+4,o,n))}var Y_,J_;!function(t){t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE"}(Y_||(Y_={})),function(t){t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(J_||(J_={}));const X_=new class{constructor(){nu(this,"_clientSize",null),nu(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),nu(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),nu(this,"getStyle",(t=>window.getComputedStyle(t,null))),nu(this,"checkCssVisibleProperty",(t=>{var e;let i=!0;const n=this.getStyle(t),{display:s,visibility:o,opacity:r,filter:a}=n;return("none"===s||Ps(e=["hidden","collapse"]).call(e,o)||Number(r)<.1)&&(i=!1),!!i&&(a&&a.split(" ").filter((t=>{var e;const i=t.split("(")[0];return Ps(e=["brightness","blur","opacity"]).call(e,i)})).map((t=>{const[e,i]=t.split(/\(|\)/);return[e,Number(i.match(/^[0-9\.]+/))]})).forEach((t=>{const[e,n]=t;switch(e){case"brightness":(n<.1||n>3)&&(i=!1);break;case"blur":n>3&&(i=!1);break;case"opacity":n<.1&&(i=!1)}})),i)})),nu(this,"checkPropertyUpToAllParentNodes",((t,e)=>{let i=!0,n=!0;const s=t=>e(t);let o=t;for(;o&&n;)s(o)||(i=!1,n=!1),o=o.parentElement,o||(n=!1);return i})),nu(this,"checkActualCssVisibleIncludeInherit",(t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty))),nu(this,"getSizeAboutClient",(t=>{const{width:e,height:i,left:n,right:s,top:o,bottom:r}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:i,left:n,right:s,top:o,bottom:r,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),nu(this,"checkActualSize",(()=>{const{width:t,height:e,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(t,e,i)})),nu(this,"elementFromPoint",((t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null)),nu(this,"checkCoverForAPoint",((t,e,i)=>{const n=this.elementFromPoint(t,e);return null!==n&&n!==i})),nu(this,"getPointPositionList",(()=>{const{width:t,height:e,left:i,top:n}=this._clientSize,s=t/6,o=e/6,r=[],a=10**6;for(let t=0;t<5;t++)for(let e=0;e<5;e++){const c=(i*a+(0===t?.1:4===t?(s*t*a-1e5)/a:s*t)*a)/a,d=(n*a+(0===e?.1:4===e?(o*e*a-1e5)/a:o*e)*a)/a;r.push({x:c,y:d})}return[...r]})),nu(this,"checkElementCover",(t=>this.getPointPositionList().map((e=>this.checkCoverForAPoint(e.x,e.y,t))).filter((t=>!!t)).length>6)),nu(this,"checkSizeIsVisible",((t,e,i)=>(t>50||i/t<=10)&&(e>50||i/e<=10))),nu(this,"checkSizeOfPartInClient",(()=>{const{left:t,right:e,top:i,bottom:n,clientHeight:s,clientWidth:o,clientMin:r}=this._clientSize;let a,c,d,l;if(t<0)a=0;else{if(!(t<o))return!1;a=t}if(e<0)return!1;if(c=e<o?e:o,i<0)d=0;else{if(!(i<s))return!1;d=i}if(n<0)return!1;l=n<s?n:s;const h=c-a,u=l-d;return this.checkSizeIsVisible(h,u,r)})),nu(this,"returnHiddenResult",(t=>(this._clientSize=null,{visible:!1,reason:t}))),nu(this,"checkOneElementVisible",(t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Y_.COVERED);{const t=this.checkActualSize(),e=this.checkSizeOfPartInClient();return t&&!e?this.returnHiddenResult(Y_.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Y_.SIZE)}}return this.returnHiddenResult(Y_.STYLE)}return this.returnHiddenResult(J_.UNMOUNTED)}return this.returnHiddenResult(J_.INVALID_HTML_ELEMENT)})),nu(this,"checkElementIsMountedOnDom",(t=>this.checkPropertyUpToAllParentNodes(t,(t=>"HTML"!==t.nodeName.toUpperCase()?null!==t.parentElement:!!document.documentElement))))}};function Z_(t){return(new TextEncoder).encode(t)}const Q_=function(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i},tE=async t=>{const e=function(t){const e=window.atob(t),i=new Uint8Array(new ArrayBuffer(e.length));for(let t=0;t<e.length;t+=1)i[t]=e.charCodeAt(t);return i}("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),i=await window.crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),n=Z_(t),s=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},i,n);return function(t){let e="";for(let i=0;i<t.length;i+=1)e+=String.fromCharCode(t[i]);return window.btoa(e)}(new Uint8Array(s))},eE=async t=>function(t,e){let i="";return new Uint8Array(t).forEach((t=>{i+=t.toString(e).padStart(2,"0")})),i}(await crypto.subtle.digest("SHA-256",Z_(t)),16);class iE{constructor(){nu(this,"_events",{}),nu(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map((t=>t.listener)):[]}on(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];-1===this._indexOfListener(i,e)&&i.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];-1===this._indexOfListener(i,e)&&i.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const i=this._events[t],n=this._indexOfListener(i,e);-1!==n&&i.splice(n,1),0===this._events[t].length&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map((t=>t));for(var i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];for(let i=0;i<e.length;i+=1){const s=e[i];s.once&&this.off(t,s.listener),s.listener.apply(this,n||[])}}safeEmit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];[...this._events[t]||[]].forEach((e=>{e.once&&this.off(t,e.listener);try{e.listener.apply(this,i)}catch(e){console.error("safeEmit event:".concat(t," error ").concat(null==e?void 0:e.toString()))}}))}_indexOfListener(t,e){let i=t.length;for(;i--;)if(t[i].listener===e)return i;return-1}}let nE=null;function sE(){if(nE)return nE;if(window.electron)return nE=window.electron;if(!window.require)return null;try{return nE=window.require("electron"),nE}catch(t){return null}}var oE,rE,aE,cE,dE,lE,hE,uE;function pE(t){return j_(t.timeout,"config.timeout",0,1e5),j_(t.timeoutFactor,"config.timeoutFactor",0,100,!1),j_(t.maxRetryCount,"config.maxRetryConfig",0,1/0),j_(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function mE(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach((t=>{if(!t.urls)throw Error()}))}catch(t){return!1}return!0}function gE(t){return G_(t.turnServerURL,"turnServerURL"),G_(t.username,"username"),G_(t.password,"password"),t.udpport&&j_(t.udpport,"udpport",1,99999,!0),t.forceturn&&F_(t.forceturn,"forceturn"),t.security&&F_(t.security,"security"),t.tcpport&&j_(t.tcpport,"tcpport",1,99999,!0),!0}function fE(t){return void 0!==t.level&&B_(t.level,"level",[1,2,3]),void 0!==t.delay&&j_(t.delay,"delay",0,3e3,!0),!0}function vE(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return 0===t.getListeners(e).length?e_.reject(new V_(U_.UNEXPECTED_ERROR,"can not emit promise")):new e_(((i,s)=>{t.emit(e,...n,i,s)}))}function _E(t,e){if(0===t.getListeners(e).length)return e_.resolve();for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return vE(t,e,...n)}function EE(t,e){if(0===t.getListeners(e).length)return null;for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return SE(t,e,...n)}function SE(t,e){let i=null,n=null;for(var s=arguments.length,o=new Array(s>2?s-2:0),r=2;r<s;r++)o[r-2]=arguments[r];if(t.emit(e,...o,(t=>{i=t}),(t=>{n=t})),null!==n)throw n;if(null===i)throw new V_(U_.UNEXPECTED_ERROR,"handler is not sync");return i}!function(t){t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.DATACHANNEL_FAILBACK="Client._datachannelFailback",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",t.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload"}(oE||(oE={})),function(t){t.TRACER="tracer"}(rE||(rE={})),function(t){t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(aE||(aE={})),function(t){t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.FALLBACK="FALLBACK",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE"}(cE||(cE={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.INJECT_STREAM_STATUS="stream-inject-status",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(dE||(dE={})),function(t){t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK"}(lE||(lE={})),function(t){t.ONLINE="ONLINE",t.OFFLINE="OFFLINE"}(hE||(hE={})),function(t){t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE"}(uE||(uE={}));const TE=new class extends iE{set networkState(t){this.emit(uE.NETWORK_STATE_CHANGE,t,this._networkState),t===hE.ONLINE?this.emit(uE.ONLINE):t===hE.OFFLINE&&(this.onlineWaiter=new e_((t=>{this.once(uE.ONLINE,(()=>{this.onlineWaiter=void 0,t(hE.ONLINE)}))})),this.emit(uE.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===hE.ONLINE}constructor(){super(),nu(this,"_moduleName","network-indicator"),nu(this,"_networkState",hE.ONLINE),nu(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=hE.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=hE.OFFLINE}))}};function bE(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function yE(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?bE(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):bE(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function CE(t,e){const i=t.indexOf(e);-1!==i&&t.splice(i,1)}function wE(t){const e=[];return t.forEach((t=>{-1===e.indexOf(t)&&e.push(t)})),e}function RE(t){void 0!==e_?e_.resolve().then(t):setTimeout(t,0)}function IE(t){return JSON.parse(JSON.stringify(t))}function AE(t){try{return IE(t)}catch(e){return t}}const OE={};function NE(t,e){OE[e]||(OE[e]=!0,t())}function kE(t){const e=window.atob(t),i=new Uint8Array(new ArrayBuffer(e.length));for(let t=0;t<e.length;t+=1)i[t]=e.charCodeAt(t);return i}function LE(t){let e="";for(let i=0;i<t.length;i+=1)e+=String.fromCharCode(t[i]);return window.btoa(e)}function PE(t){return window.TextEncoder?(new TextEncoder).encode(t).length:t.length}function DE(t){let e=0;return/DingTalk/i.test(navigator.userAgent)&&t.realFormData&&(t=t.realFormData),t.forEach((t=>{e+="string"==typeof t?PE(t):t.size})),e+138}function ME(t){const e=new V_(U_.TIMEOUT,"timeout");return new e_(((i,n)=>{window.setTimeout((()=>n(e)),t)}))}function xE(t){return new e_((e=>{window.setTimeout(e,t)}))}function UE(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,t).toLowerCase();return i.length===t?"".concat(e).concat(i):"".concat(e).concat(i)+UE(t-i.length,"")}function VE(){return UE(32,"").toUpperCase()}const FE=()=>{},BE=new class{constructor(){nu(this,"fnMap",new Map)}throttleByKey(t,e,i,n){for(var s=arguments.length,o=new Array(s>4?s-4:0),r=4;r<s;r++)o[r-4]=arguments[r];if(this.fnMap.has(e)){const s=this.fnMap.get(e);if(s.threshold!==i){s.fn(...s.args),clearTimeout(s.timer);const r=window.setTimeout((()=>{const t=this.fnMap.get(e);t&&t.fn(...t.args),this.fnMap.delete(e)}),i);this.fnMap.set(e,{fn:t,threshold:i,timer:r,args:o,skipFn:n})}else s.skipFn&&s.skipFn(...s.args),this.fnMap.set(e,yE(yE({},s),{},{fn:t,args:o,skipFn:n}))}else{const s=window.setTimeout((()=>{const t=this.fnMap.get(e);t&&t.fn(...t.args),this.fnMap.delete(e)}),i);this.fnMap.set(e,{fn:t,threshold:i,timer:s,args:o,skipFn:n})}}},jE=BE.throttleByKey.bind(BE);function HE(t){return"object"==typeof t&&null!==t&&!(t instanceof RegExp)}function GE(t,e){if(!HE(t)||!HE(e))return e;if(Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){const i=[...t];for(let n=0;n<e.length;n++)i[n]=GE(t[n],e[n]);return i}{const i=yE({},t);for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)?i[n]=GE(t[n],e[n]):i[n]=e[n]);return i}}let WE=1,$E=console;class zE{static setLogger(t){$E=t}constructor(t){nu(this,"lockingPromise",e_.resolve()),nu(this,"locks",0),nu(this,"name",""),nu(this,"lockId",void 0),this.lockId=WE++,t&&(this.name=t),$E.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,$E.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat("string"==typeof t?t:""));const i=new e_((i=>{e=()=>{this.locks-=1,$E.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat("string"==typeof t?t:"")),i()}})),n=this.lockingPromise.then((()=>e));return this.lockingPromise=this.lockingPromise.then((()=>i)),n}}function qE(t,e){return function(i,n,s){const o=s.value;if("function"!=typeof o)throw new Error("Cannot use mutex on object property.");return s.value=async function(){const i=this[e];if(!i)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const s=await i.lock("From ".concat(t,".").concat(n));try{for(var r=arguments.length,a=new Array(r),c=0;c<r;c++)a[c]=arguments[c];return await o.apply(this,a)}finally{s()}},s}}const KE={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function YE(t,e){const i=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,i)}function JE(t,e,i,n){const s=Object.assign({},KE,n);let o=s.timeout;const r=async()=>{await function(t){return new e_((e=>{window.setTimeout(e,t)}))}(o),o*=s.timeoutFactor,o=Math.min(s.maxRetryTimeout,o)};let a=!1;const c=new e_((async(n,o)=>{e=e||(()=>!1),i=i||(()=>!0);for(let c=0;c<s.maxRetryCount;c+=1){if(a)return o(new V_(U_.OPERATION_ABORTED));try{const i=await t();if(!e(i,c))return n(i);if(c+1===s.maxRetryCount)return n(i);await r()}catch(t){if(!i(t,c))return o(t);if(c+1===s.maxRetryCount)return o(t);await r()}}}));return c.cancel=()=>a=!0,c}var XE=xe,ZE=ti,QE=Jt,tS=qn,eS=TypeError,iS=function(t){return function(e,i,n,s){XE(i);var o=ZE(e),r=QE(o),a=tS(o),c=t?a-1:0,d=t?-1:1;if(n<2)for(;;){if(c in r){s=r[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw eS("Reduce of empty array with no initial value")}for(;t?c>=0:a>c;c+=d)c in r&&(s=i(s,r[c],c,o));return s}},nS=[iS(!1),iS(!0)][0];Mn({target:"Array",proto:!0,forced:!bm&&Se>79&&Se<83||!Tu("reduce")},{reduce:function(t){var e=arguments.length;return nS(this,t,e,e>1?arguments[1]:void 0)}});var sS=es("Array").reduce,oS=gt,rS=sS,aS=Array.prototype,cS=K((function(t){var e=t.reduce;return t===aS||oS(aS,t)&&e===aS.reduce?rS:e}));let dS=class{constructor(t){nu(this,"input",[]),nu(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return 0===this.input.length?0:cS(t=this.input).call(t,((t,e)=>t+e))/this.input.length}};var lS,hS={exports:{}},uS=function(t,e){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return t.apply(e,i)}},pS=uS,mS=Object.prototype.toString,gS=(lS=Object.create(null),function(t){var e=mS.call(t);return lS[e]||(lS[e]=e.slice(8,-1).toLowerCase())});function fS(t){return t=t.toLowerCase(),function(e){return gS(e)===t}}function vS(t){return Array.isArray(t)}function _S(t){return void 0===t}var ES=fS("ArrayBuffer");function SS(t){return null!==t&&"object"==typeof t}function TS(t){if("object"!==gS(t))return!1;var e=Object.getPrototypeOf(t);return null===e||e===Object.prototype}var bS=fS("Date"),yS=fS("File"),CS=fS("Blob"),wS=fS("FileList");function RS(t){return"[object Function]"===mS.call(t)}var IS=fS("URLSearchParams");function AS(t,e){if(null!=t)if("object"!=typeof t&&(t=[t]),vS(t))for(var i=0,n=t.length;i<n;i++)e.call(null,t[i],i,t);else for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.call(null,t[s],s,t)}var OS,NS=(OS="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(t){return OS&&t instanceof OS}),kS={isArray:vS,isArrayBuffer:ES,isBuffer:function(t){return null!==t&&!_S(t)&&null!==t.constructor&&!_S(t.constructor)&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)},isFormData:function(t){var e="[object FormData]";return t&&("function"==typeof FormData&&t instanceof FormData||mS.call(t)===e||RS(t.toString)&&t.toString()===e)},isArrayBufferView:function(t){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&ES(t.buffer)},isString:function(t){return"string"==typeof t},isNumber:function(t){return"number"==typeof t},isObject:SS,isPlainObject:TS,isUndefined:_S,isDate:bS,isFile:yS,isBlob:CS,isFunction:RS,isStream:function(t){return SS(t)&&RS(t.pipe)},isURLSearchParams:IS,isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:AS,merge:function t(){var e={};function i(i,n){TS(e[n])&&TS(i)?e[n]=t(e[n],i):TS(i)?e[n]=t({},i):vS(i)?e[n]=i.slice():e[n]=i}for(var n=0,s=arguments.length;n<s;n++)AS(arguments[n],i);return e},extend:function(t,e,i){return AS(e,(function(e,n){t[n]=i&&"function"==typeof e?pS(e,i):e})),t},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},stripBOM:function(t){return 65279===t.charCodeAt(0)&&(t=t.slice(1)),t},inherits:function(t,e,i,n){t.prototype=Object.create(e.prototype,n),t.prototype.constructor=t,i&&Object.assign(t.prototype,i)},toFlatObject:function(t,e,i){var n,s,o,r={};e=e||{};do{for(s=(n=Object.getOwnPropertyNames(t)).length;s-- >0;)r[o=n[s]]||(e[o]=t[o],r[o]=!0);t=Object.getPrototypeOf(t)}while(t&&(!i||i(t,e))&&t!==Object.prototype);return e},kindOf:gS,kindOfTest:fS,endsWith:function(t,e,i){t=String(t),(void 0===i||i>t.length)&&(i=t.length),i-=e.length;var n=t.indexOf(e,i);return-1!==n&&n===i},toArray:function(t){if(!t)return null;var e=t.length;if(_S(e))return null;for(var i=new Array(e);e-- >0;)i[e]=t[e];return i},isTypedArray:NS,isFileList:wS},LS=kS;function PS(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var DS=function(t,e,i){if(!e)return t;var n;if(i)n=i(e);else if(LS.isURLSearchParams(e))n=e.toString();else{var s=[];LS.forEach(e,(function(t,e){null!=t&&(LS.isArray(t)?e+="[]":t=[t],LS.forEach(t,(function(t){LS.isDate(t)?t=t.toISOString():LS.isObject(t)&&(t=JSON.stringify(t)),s.push(PS(e)+"="+PS(t))})))})),n=s.join("&")}if(n){var o=t.indexOf("#");-1!==o&&(t=t.slice(0,o)),t+=(-1===t.indexOf("?")?"?":"&")+n}return t},MS=kS;function xS(){this.handlers=[]}xS.prototype.use=function(t,e,i){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},xS.prototype.eject=function(t){this.handlers[t]&&(this.handlers[t]=null)},xS.prototype.forEach=function(t){MS.forEach(this.handlers,(function(e){null!==e&&t(e)}))};var US,VS,FS=xS,BS=kS;function jS(){if(VS)return US;VS=1;var t=kS;function e(t,e,i,n,s){Error.call(this),this.message=t,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),n&&(this.request=n),s&&(this.response=s)}t.inherits(e,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var i=e.prototype,n={};return["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(t){n[t]={value:t}})),Object.defineProperties(e,n),Object.defineProperty(i,"isAxiosError",{value:!0}),e.from=function(n,s,o,r,a,c){var d=Object.create(i);return t.toFlatObject(n,d,(function(t){return t!==Error.prototype})),e.call(d,n.message,s,o,r,a),d.name=n.name,c&&Object.assign(d,c),d},US=e}var HS,GS,WS,$S,zS,qS,KS={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function YS(){if(GS)return HS;GS=1;var t=kS;return HS=function(e,i){i=i||new FormData;var n=[];function s(e){return null===e?"":t.isDate(e)?e.toISOString():t.isArrayBuffer(e)||t.isTypedArray(e)?"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}return function e(o,r){if(t.isPlainObject(o)||t.isArray(o)){if(-1!==n.indexOf(o))throw Error("Circular reference detected in "+r);n.push(o),t.forEach(o,(function(n,o){if(!t.isUndefined(n)){var a,c=r?r+"."+o:o;if(n&&!r&&"object"==typeof n)if(t.endsWith(o,"{}"))n=JSON.stringify(n);else if(t.endsWith(o,"[]")&&(a=t.toArray(n)))return void a.forEach((function(e){!t.isUndefined(e)&&i.append(c,s(e))}));e(n,c)}})),n.pop()}else i.append(r,s(o))}(e),i},HS}function JS(){if($S)return WS;$S=1;var t=jS();return WS=function(e,i,n){var s=n.config.validateStatus;n.status&&s&&!s(n.status)?i(new t("Request failed with status code "+n.status,[t.ERR_BAD_REQUEST,t.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}}function XS(){if(qS)return zS;qS=1;var t=kS;return zS=t.isStandardBrowserEnv()?{write:function(e,i,n,s,o,r){var a=[];a.push(e+"="+encodeURIComponent(i)),t.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),t.isString(s)&&a.push("path="+s),t.isString(o)&&a.push("domain="+o),!0===r&&a.push("secure"),document.cookie=a.join("; ")},read:function(t){var e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},zS}var ZS,QS,tT,eT,iT,nT,sT,oT,rT,aT,cT,dT,lT=function(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)},hT=function(t,e){return e?t.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):t},uT=function(t,e){return t&&!lT(e)?hT(t,e):e};function pT(){if(QS)return ZS;QS=1;var t=kS,e=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return ZS=function(i){var n,s,o,r={};return i?(t.forEach(i.split("\n"),(function(i){if(o=i.indexOf(":"),n=t.trim(i.substr(0,o)).toLowerCase(),s=t.trim(i.substr(o+1)),n){if(r[n]&&e.indexOf(n)>=0)return;r[n]="set-cookie"===n?(r[n]?r[n]:[]).concat([s]):r[n]?r[n]+", "+s:s}})),r):r},ZS}function mT(){if(eT)return tT;eT=1;var t=kS;return tT=t.isStandardBrowserEnv()?function(){var e,i=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");function s(t){var e=t;return i&&(n.setAttribute("href",e),e=n.href),n.setAttribute("href",e),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:"/"===n.pathname.charAt(0)?n.pathname:"/"+n.pathname}}return e=s(window.location.href),function(i){var n=t.isString(i)?s(i):i;return n.protocol===e.protocol&&n.host===e.host}}():function(){return!0}}function gT(){if(nT)return iT;nT=1;var t=jS();function e(e){t.call(this,null==e?"canceled":e,t.ERR_CANCELED),this.name="CanceledError"}return kS.inherits(e,t,{__CANCEL__:!0}),iT=e}function fT(){return oT||(oT=1,sT=function(t){var e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}),sT}function vT(){if(aT)return rT;aT=1;var t=kS,e=JS(),i=XS(),n=DS,s=uT,o=pT(),r=mT(),a=KS,c=jS(),d=gT(),l=fT();return rT=function(h){return new Promise((function(u,p){var m,g=h.data,f=h.headers,v=h.responseType;function _(){h.cancelToken&&h.cancelToken.unsubscribe(m),h.signal&&h.signal.removeEventListener("abort",m)}t.isFormData(g)&&t.isStandardBrowserEnv()&&delete f["Content-Type"];var E=new XMLHttpRequest;if(h.auth){var S=h.auth.username||"",T=h.auth.password?unescape(encodeURIComponent(h.auth.password)):"";f.Authorization="Basic "+btoa(S+":"+T)}var b=s(h.baseURL,h.url);function y(){if(E){var t="getAllResponseHeaders"in E?o(E.getAllResponseHeaders()):null,i={data:v&&"text"!==v&&"json"!==v?E.response:E.responseText,status:E.status,statusText:E.statusText,headers:t,config:h,request:E};e((function(t){u(t),_()}),(function(t){p(t),_()}),i),E=null}}if(E.open(h.method.toUpperCase(),n(b,h.params,h.paramsSerializer),!0),E.timeout=h.timeout,"onloadend"in E?E.onloadend=y:E.onreadystatechange=function(){E&&4===E.readyState&&(0!==E.status||E.responseURL&&0===E.responseURL.indexOf("file:"))&&setTimeout(y)},E.onabort=function(){E&&(p(new c("Request aborted",c.ECONNABORTED,h,E)),E=null)},E.onerror=function(){p(new c("Network Error",c.ERR_NETWORK,h,E,E)),E=null},E.ontimeout=function(){var t=h.timeout?"timeout of "+h.timeout+"ms exceeded":"timeout exceeded",e=h.transitional||a;h.timeoutErrorMessage&&(t=h.timeoutErrorMessage),p(new c(t,e.clarifyTimeoutError?c.ETIMEDOUT:c.ECONNABORTED,h,E)),E=null},t.isStandardBrowserEnv()){var C=(h.withCredentials||r(b))&&h.xsrfCookieName?i.read(h.xsrfCookieName):void 0;C&&(f[h.xsrfHeaderName]=C)}"setRequestHeader"in E&&t.forEach(f,(function(t,e){void 0===g&&"content-type"===e.toLowerCase()?delete f[e]:E.setRequestHeader(e,t)})),t.isUndefined(h.withCredentials)||(E.withCredentials=!!h.withCredentials),v&&"json"!==v&&(E.responseType=h.responseType),"function"==typeof h.onDownloadProgress&&E.addEventListener("progress",h.onDownloadProgress),"function"==typeof h.onUploadProgress&&E.upload&&E.upload.addEventListener("progress",h.onUploadProgress),(h.cancelToken||h.signal)&&(m=function(t){E&&(p(!t||t&&t.type?new d:t),E.abort(),E=null)},h.cancelToken&&h.cancelToken.subscribe(m),h.signal&&(h.signal.aborted?m():h.signal.addEventListener("abort",m))),g||(g=null);var w=l(b);w&&-1===["http","https","file"].indexOf(w)?p(new c("Unsupported protocol "+w+":",c.ERR_BAD_REQUEST,h)):E.send(g)}))},rT}var _T=kS,ET=function(t,e){BS.forEach(t,(function(i,n){n!==e&&n.toUpperCase()===e.toUpperCase()&&(t[e]=i,delete t[n])}))},ST=jS(),TT=KS,bT=YS(),yT={"Content-Type":"application/x-www-form-urlencoded"};function CT(t,e){!_T.isUndefined(t)&&_T.isUndefined(t["Content-Type"])&&(t["Content-Type"]=e)}var wT,RT={transitional:TT,adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(wT=vT()),wT),transformRequest:[function(t,e){if(ET(e,"Accept"),ET(e,"Content-Type"),_T.isFormData(t)||_T.isArrayBuffer(t)||_T.isBuffer(t)||_T.isStream(t)||_T.isFile(t)||_T.isBlob(t))return t;if(_T.isArrayBufferView(t))return t.buffer;if(_T.isURLSearchParams(t))return CT(e,"application/x-www-form-urlencoded;charset=utf-8"),t.toString();var i,n=_T.isObject(t),s=e&&e["Content-Type"];if((i=_T.isFileList(t))||n&&"multipart/form-data"===s){var o=this.env&&this.env.FormData;return bT(i?{"files[]":t}:t,o&&new o)}return n||"application/json"===s?(CT(e,"application/json"),function(t,e,i){if(_T.isString(t))try{return(e||JSON.parse)(t),_T.trim(t)}catch(t){if("SyntaxError"!==t.name)throw t}return(i||JSON.stringify)(t)}(t)):t}],transformResponse:[function(t){var e=this.transitional||RT.transitional,i=e&&e.silentJSONParsing,n=e&&e.forcedJSONParsing,s=!i&&"json"===this.responseType;if(s||n&&_T.isString(t)&&t.length)try{return JSON.parse(t)}catch(t){if(s){if("SyntaxError"===t.name)throw ST.from(t,ST.ERR_BAD_RESPONSE,this,null,this.response);throw t}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:dT?cT:(dT=1,cT=null)},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};_T.forEach(["delete","get","head"],(function(t){RT.headers[t]={}})),_T.forEach(["post","put","patch"],(function(t){RT.headers[t]=_T.merge(yT)}));var IT,AT,OT=RT,NT=kS,kT=OT;function LT(){return AT?IT:(AT=1,IT=function(t){return!(!t||!t.__CANCEL__)})}var PT=kS,DT=function(t,e,i){var n=this||kT;return NT.forEach(i,(function(i){t=i.call(n,t,e)})),t},MT=LT(),xT=OT,UT=gT();function VT(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new UT}var FT,BT,jT=kS,HT=function(t,e){e=e||{};var i={};function n(t,e){return jT.isPlainObject(t)&&jT.isPlainObject(e)?jT.merge(t,e):jT.isPlainObject(e)?jT.merge({},e):jT.isArray(e)?e.slice():e}function s(i){return jT.isUndefined(e[i])?jT.isUndefined(t[i])?void 0:n(void 0,t[i]):n(t[i],e[i])}function o(t){if(!jT.isUndefined(e[t]))return n(void 0,e[t])}function r(i){return jT.isUndefined(e[i])?jT.isUndefined(t[i])?void 0:n(void 0,t[i]):n(void 0,e[i])}function a(i){return i in e?n(t[i],e[i]):i in t?n(void 0,t[i]):void 0}var c={url:o,method:o,data:o,baseURL:r,transformRequest:r,transformResponse:r,paramsSerializer:r,timeout:r,timeoutMessage:r,withCredentials:r,adapter:r,responseType:r,xsrfCookieName:r,xsrfHeaderName:r,onUploadProgress:r,onDownloadProgress:r,decompress:r,maxContentLength:r,maxBodyLength:r,beforeRedirect:r,transport:r,httpAgent:r,httpsAgent:r,cancelToken:r,socketPath:r,responseEncoding:r,validateStatus:a};return jT.forEach(Object.keys(t).concat(Object.keys(e)),(function(t){var e=c[t]||s,n=e(t);jT.isUndefined(n)&&e!==a||(i[t]=n)})),i};function GT(){return BT?FT:(BT=1,FT={version:"0.27.2"})}var WT=GT().version,$T=jS(),zT={};["object","boolean","number","function","string","symbol"].forEach((function(t,e){zT[t]=function(i){return typeof i===t||"a"+(e<1?"n ":" ")+t}}));var qT={};zT.transitional=function(t,e,i){function n(t,e){return"[Axios v"+WT+"] Transitional option '"+t+"'"+e+(i?". "+i:"")}return function(i,s,o){if(!1===t)throw new $T(n(s," has been removed"+(e?" in "+e:"")),$T.ERR_DEPRECATED);return e&&!qT[s]&&(qT[s]=!0,console.warn(n(s," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(i,s,o)}};var KT,YT,JT,XT,ZT,QT,tb={assertOptions:function(t,e,i){if("object"!=typeof t)throw new $T("options must be an object",$T.ERR_BAD_OPTION_VALUE);for(var n=Object.keys(t),s=n.length;s-- >0;){var o=n[s],r=e[o];if(r){var a=t[o],c=void 0===a||r(a,o,t);if(!0!==c)throw new $T("option "+o+" must be "+c,$T.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new $T("Unknown option "+o,$T.ERR_BAD_OPTION)}},validators:zT},eb=kS,ib=DS,nb=FS,sb=function(t){return VT(t),t.headers=t.headers||{},t.data=DT.call(t,t.data,t.headers,t.transformRequest),t.headers=PT.merge(t.headers.common||{},t.headers[t.method]||{},t.headers),PT.forEach(["delete","get","head","post","put","patch","common"],(function(e){delete t.headers[e]})),(t.adapter||xT.adapter)(t).then((function(e){return VT(t),e.data=DT.call(t,e.data,e.headers,t.transformResponse),e}),(function(e){return MT(e)||(VT(t),e&&e.response&&(e.response.data=DT.call(t,e.response.data,e.response.headers,t.transformResponse))),Promise.reject(e)}))},ob=HT,rb=uT,ab=tb,cb=ab.validators;function db(t){this.defaults=t,this.interceptors={request:new nb,response:new nb}}db.prototype.request=function(t,e){"string"==typeof t?(e=e||{}).url=t:e=t||{},(e=ob(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var i=e.transitional;void 0!==i&&ab.assertOptions(i,{silentJSONParsing:cb.transitional(cb.boolean),forcedJSONParsing:cb.transitional(cb.boolean),clarifyTimeoutError:cb.transitional(cb.boolean)},!1);var n=[],s=!0;this.interceptors.request.forEach((function(t){"function"==typeof t.runWhen&&!1===t.runWhen(e)||(s=s&&t.synchronous,n.unshift(t.fulfilled,t.rejected))}));var o,r=[];if(this.interceptors.response.forEach((function(t){r.push(t.fulfilled,t.rejected)})),!s){var a=[sb,void 0];for(Array.prototype.unshift.apply(a,n),a=a.concat(r),o=Promise.resolve(e);a.length;)o=o.then(a.shift(),a.shift());return o}for(var c=e;n.length;){var d=n.shift(),l=n.shift();try{c=d(c)}catch(t){l(t);break}}try{o=sb(c)}catch(t){return Promise.reject(t)}for(;r.length;)o=o.then(r.shift(),r.shift());return o},db.prototype.getUri=function(t){t=ob(this.defaults,t);var e=rb(t.baseURL,t.url);return ib(e,t.params,t.paramsSerializer)},eb.forEach(["delete","get","head","options"],(function(t){db.prototype[t]=function(e,i){return this.request(ob(i||{},{method:t,url:e,data:(i||{}).data}))}})),eb.forEach(["post","put","patch"],(function(t){function e(e){return function(i,n,s){return this.request(ob(s||{},{method:t,headers:e?{"Content-Type":"multipart/form-data"}:{},url:i,data:n}))}}db.prototype[t]=e(),db.prototype[t+"Form"]=e(!0)}));var lb=kS,hb=uS,ub=db,pb=HT,mb=function t(e){var i=new ub(e),n=hb(ub.prototype.request,i);return lb.extend(n,ub.prototype,i),lb.extend(n,i),n.create=function(i){return t(pb(e,i))},n}(OT);mb.Axios=ub,mb.CanceledError=gT(),mb.CancelToken=function(){if(YT)return KT;YT=1;var t=gT();function e(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var i;this.promise=new Promise((function(t){i=t}));var n=this;this.promise.then((function(t){if(n._listeners){var e,i=n._listeners.length;for(e=0;e<i;e++)n._listeners[e](t);n._listeners=null}})),this.promise.then=function(t){var e,i=new Promise((function(t){n.subscribe(t),e=t})).then(t);return i.cancel=function(){n.unsubscribe(e)},i},e((function(e){n.reason||(n.reason=new t(e),i(n.reason))}))}return e.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},e.prototype.subscribe=function(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]},e.prototype.unsubscribe=function(t){if(this._listeners){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)}},e.source=function(){var t;return{token:new e((function(e){t=e})),cancel:t}},KT=e}(),mb.isCancel=LT(),mb.VERSION=GT().version,mb.toFormData=YS(),mb.AxiosError=jS(),mb.Cancel=mb.CanceledError,mb.all=function(t){return Promise.all(t)},mb.spread=XT?JT:(XT=1,JT=function(t){return function(e){return t.apply(null,e)}}),mb.isAxiosError=function(){if(QT)return ZT;QT=1;var t=kS;return ZT=function(e){return t.isObject(e)&&!0===e.isAxiosError}}(),hS.exports=mb,hS.exports.default=mb;var gb=K(hS.exports);function fb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function vb(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?fb(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):fb(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let _b,Eb=0,Sb=0;function Tb(t,e,i,n){return new e_(((s,o)=>{e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),Eb+=PE(e.data)):i&&(e.data.size?Eb+=e.data.size:e.data instanceof FormData?Eb+=DE(e.data):Eb+=PE(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,gb.request(e).then((t=>{"string"==typeof t.data?Sb+=PE(t.data):t.data instanceof ArrayBuffer||t.data instanceof Uint8Array?Sb+=t.data.byteLength:Sb+=PE(JSON.stringify(t.data)),n&&s({data:t.data,headers:t.headers}),s(t.data)})).catch((t=>{gb.isCancel(t)?o(new V_(U_.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===t.code?o(new V_(U_.NETWORK_TIMEOUT,t.message)):t.response?o(new V_(U_.NETWORK_RESPONSE_ERROR,t.response.status)):o(new V_(U_.NETWORK_ERROR,t.message))}))}))}async function bb(t,e){const i=new Blob([e.data],{type:"buffer"});return await Tb(t,vb(vb({},e),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const yb=()=>"HTTPS"===(_b||_b||(_b=(window.location.protocol.split(":")[0]||"").toUpperCase(),_b)),Cb=()=>void 0!==window.isSecureContext;function wb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Rb(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?wb(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wb(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var Ib;!function(t){t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",t.SET_USE_P2P="SET_USE_P2P"}(Ib||(Ib={}));class Ab{constructor(t,e,i,n){nu(this,"state",void 0),this.state={codec:t,audioCodec:e,mode:i,clientId:n,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1}}dispatch(t){this.state=function(t,e){switch(e.type){case Ib.SET_SESSION_ID:return Rb(Rb({},t),{},{sessionId:e.sessionId});case Ib.SET_P2P_ID:return Rb(Rb({},t),{},{p2pId:e.p2pId});case Ib.SET_UID:return Rb(Rb({},t),{},{uid:e.uid});case Ib.SET_PUB_ID:return Rb(Rb({},t),{},{pubId:e.pubId});case Ib.KEY_METRIC_CLIENT_CREATED:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{clientCreated:e.metric})});case Ib.KEY_METRIC_JOIN_START:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{joinStart:e.metric})});case Ib.AVOID_JOIN_START:return Rb(Rb({},t),{},{avoidJoinStart:e.avoidJoinStart});case Ib.KEY_METRIC_JOIN_END:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{joinEnd:e.metric})});case Ib.KEY_METRIC_REQUEST_AP_START:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{requestAPStart:e.metric})});case Ib.KEY_METRIC_REQUEST_AP_END:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{requestAPEnd:e.metric})});case Ib.KEY_METRIC_JOIN_GATEWAY_START:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{joinGatewayStart:e.metric})});case Ib.KEY_METRIC_JOIN_GATEWAY_END:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{joinGatewayEnd:e.metric})});case Ib.KEY_METRIC_PEER_CONNECTION_START:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{peerConnectionStart:e.metric})});case Ib.KEY_METRIC_PEER_CONNECTION_END:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{peerConnectionEnd:e.metric})});case Ib.KEY_METRIC_DESCRIPTION_START:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{descriptionStart:e.metric})});case Ib.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{signalChannelOpen:e.metric})});case Ib.KEY_METRIC_ICE_CONNECTION_END:return Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{iceConnectionEnd:e.metric})});case Ib.KEY_METRIC_PUBLISH:{const i=t.keyMetrics.publish,n=i.findIndex((t=>t.trackId===e.metric.trackId));return-1!==n?(i[n]=Rb(Rb({},i[n]),e.metric),Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{publish:[...i]})})):Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{publish:[...t.keyMetrics.publish,e.metric]})})}case Ib.KEY_METRIC_SUBSCRIBE:{const i=t.keyMetrics.subscribe,n=i.findIndex((t=>t.userId===e.metric.userId&&t.type===e.metric.type));return-1!==n?(i[n]=Rb(Rb({},i[n]),e.metric),Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{subscribe:[...i]})})):Rb(Rb({},t),{},{keyMetrics:Rb(Rb({},t.keyMetrics),{},{subscribe:[...t.keyMetrics.subscribe,e.metric]})})}case Ib.SET_CLOUD_PROXY_SERVER_MODE:return t.cloudProxyServerMode=e.mode,t;case Ib.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof e.index?t.joinChannelServiceRecords=[...t.joinChannelServiceRecords,e.record]:(t.joinChannelServiceRecords[e.index]=Rb(Rb({},t.joinChannelServiceRecords[e.index]),e.record),t.joinChannelServiceRecords=[...t.joinChannelServiceRecords]),t;case Ib.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return t.joinChannelServiceRecords=[],t;case Ib.RESET_KEY_METRICS:return t.keyMetrics={publish:[],subscribe:[]},t;case Ib.SET_USE_DATACHANNEL:return Rb(Rb({},t),{},{useDataChannel:e.val});case Ib.SET_USE_P2P:return Rb(Rb({},t),{},{useP2P:e.val});default:return t}}(this.state,t)}set sessionId(t){this.dispatch({type:Ib.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}set codec(t){this.state.codec=t}get codec(){return this.state.codec}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:Ib.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:Ib.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:Ib.SET_UID,uid:t})}get uid(){return this.state.uid}set pubId(t){this.dispatch({type:Ib.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:Ib.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(t){this.dispatch({type:Ib.SET_USE_DATACHANNEL,val:t})}get useDataChannel(){return this.state.useDataChannel}set useP2P(t){this.dispatch({type:Ib.SET_USE_P2P,val:t})}get useP2P(){return this.state.useP2P}clientCreated(){this.dispatch({type:Ib.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Ib.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:Ib.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Ib.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Ib.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Ib.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Ib.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Ib.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Ib.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:Ib.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Ib.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Ib.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,e,i,n){this.dispatch({type:Ib.KEY_METRIC_PUBLISH,metric:Rb(Rb({trackId:t,type:e},i&&{publishStart:i}),n&&{publishEnd:n})})}subscribe(t,e,i,n,s,o,r){this.dispatch({type:Ib.KEY_METRIC_SUBSCRIBE,metric:Rb(Rb(Rb(Rb(Rb({userId:t,type:e},i&&{subscribeStart:i}),n&&{subscribeEnd:n}),s&&{firstFrame:s}),o&&{streamAdded:o}),r&&{firstDecoded:r})})}massSubscribe(t,e,i,n){t.forEach((t=>{this.dispatch({type:Ib.KEY_METRIC_SUBSCRIBE,metric:Rb(Rb(Rb({userId:t.userId,type:t.type},e&&{subscribeStart:e}),i&&{subscribeEnd:i}),n&&{firstFrame:n})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,e){"gateway"===t.service&&Array.isArray(t.urls)&&(t.urls=t.urls.map((t=>t.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return"number"!=typeof e?(this.dispatch({type:Ib.RECORD_JOIN_CHANNEL_SERVICE,record:Rb(Rb({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(e<0||e>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Ib.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:e}),e)}catch(t){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Ib.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Ib.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(t){return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:Ib.AVOID_JOIN_START,avoidJoinStart:t})}}const Ob=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){const t=e[1],i=e[2];return"".concat(t,".").concat(i)}const i=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){const t=i[1],e=i[2];return"".concat(t,".").concat(100*(Number(e)+1))}return"4.0.0.999"}("4.19.3"),Nb=function(){try{return!0===JSON.parse("true")}catch(t){return!0}}(),kb="v4.19.3-0-gb2ca8ca7(11/2/2023, 2:57:33 PM)",Lb={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,RTM2_FLAG:void 0,AP_RTM:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:1e4,P2P:!1,SHOW_P2P_LOG:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[]};function Pb(t,e,i){var n,s;Ps(n=Object.keys(Lb)).call(n,t)&&(!i&&Ps(s=Object.keys(Mb)).call(s,t)||(Lb[t]=e))}function Db(t){return Lb[t]}const Mb={};var xb,Ub;!function(t){t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1"}(xb||(xb={})),function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"}(Ub||(Ub={}));const Vb=new class extends iE{reportLogUploadError(t){this.emit("REPORT_LOG_UPLOAD",t)}};class Fb{constructor(t){nu(this,"logger",void 0),nu(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.debug(...this.prefixLists,...e)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.info(...this.prefixLists,...e)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.warning(...this.prefixLists,...e)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.error(...this.prefixLists,...e)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function Bb(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function jb(){const t=new Date,e=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return e?(null==e?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const Hb={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Gb=Date.now(),Wb=t=>{for(const e in Hb)if(Object.prototype.hasOwnProperty.call(Hb,e)&&Hb[e]===t)return e;return"DEFAULT"},$b=new class{constructor(){nu(this,"proxyServerURL",void 0),nu(this,"logLevel",Hb.DEBUG),nu(this,"uploadState","collecting"),nu(this,"uploadLogWaitingList",[]),nu(this,"uploadLogUploadingList",[]),nu(this,"uploadErrorCount",0),nu(this,"currentLogID",0),nu(this,"url",void 0),nu(this,"extLog",((t,e)=>{this.appendLogToWaitingList(t,...e)}))}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Hb.DEBUG].concat(e);this.log.apply(this,n)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Hb.INFO].concat(e);this.log.apply(this,n)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Hb.WARNING].concat(e);this.log.apply(this,n)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Hb.ERROR].concat(e);this.log.apply(this,n)}upload(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Hb.DEBUG].concat(e);this.uploadLog.apply(this,n)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Pb("UPLOAD_LOG",!0)}disableLogUpload(){Pb("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new Fb(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Gb<100)return void setTimeout((()=>{this.log(...e)}),Date.now()-Gb);const n=Math.max(0,Math.min(4,e[0]));if(e[0]=Bb()+" Agora-SDK [".concat(Wb(n),"]:"),this.appendLogToWaitingList(n,...e),n<this.logLevel)return;const s=Bb()+" %cAgora-SDK [".concat(Wb(n),"]:");let o=[];if(!Db("USE_NEW_LOG"))switch(n){case Hb.DEBUG:o=[s,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case Hb.INFO:o=[s,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case Hb.WARNING:o=[s,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case Hb.ERROR:o=[s,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Gb<100)return void setTimeout((()=>{this.uploadLog(...e)}),Date.now()-Gb);const n=Math.max(0,Math.min(4,e[0]));e[0]=Bb()+" Agora-SDK [".concat(Wb(n),"]:"),this.appendLogToWaitingList(n,...e)}appendLogToWaitingList(t){if(!Db("UPLOAD_LOG"))return;for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];Array.isArray(i[0])?i[0][0]=jb()+" Agora-SDK [".concat(Wb(t),"]:"):i[0]=jb()+" Agora-SDK [".concat(Wb(t),"]:");let s="";i.forEach((t=>{"object"==typeof t&&(t=JSON.stringify(t)),s+="".concat(t," ")})),this.uploadLogWaitingList.push({payload_str:s,log_level:t,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:Ob,process_id:Db("PROCESS_ID"),payload:JSON.stringify(t)};return JE((async()=>{const t=await gb.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(Db("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(Db("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if("OK"!==t.data){const e=new Error("unexpected upload log response");throw e.response=t,e}}),(()=>(this.uploadLogUploadingList=[],!1)),(t=>(t.response?Vb.reportLogUploadError({status:t.response.status,data:t.response.data,headers:t.response.headers,message:t.message}):t.request?Vb.reportLogUploadError({status:t.request.status,message:t.message}):Vb.reportLogUploadError({status:-1,message:t.message}),!0)),{timeout:Db("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:Db("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,Db("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),Db("UPLOAD_LOG_INTERVAL"))})).catch((t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),Db("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),Db("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var zb,qb;function Kb(t){return G_(t.reportId,"params.reportId",0,100,!1),G_(t.category,"params.category",0,100,!1),G_(t.event,"params.event",0,100,!1),G_(t.label,"params.label",0,100,!1),j_(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}!function(t){t.FREE="free",t.UPLOADING="uploading"}(zb||(zb={})),function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}(qb||(qb={}));const Yb={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var Jb,Xb,Zb,Qb;function ty(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function ey(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ty(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ty(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}!function(t){t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats"}(Jb||(Jb={})),function(t){t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats"}(Xb||(Xb={})),function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(Zb||(Zb={})),function(t){t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(Qb||(Qb={}));class iy{constructor(){nu(this,"baseInfoMap",new Map),nu(this,"proxyServer",void 0),nu(this,"eventUploadTimer",void 0),nu(this,"setSessionIdTimer",void 0),nu(this,"url",void 0),nu(this,"backupUrl",void 0),nu(this,"_appId",void 0),nu(this,"keyEventUploadPendingItems",[]),nu(this,"normalEventUploadPendingItems",[]),nu(this,"apiInvokeUploadPendingItems",[]),nu(this,"apiInvokeCount",0),nu(this,"ltsList",[]),nu(this,"lastSendNormalEventTime",Date.now()),nu(this,"customReportCounterTimer",void 0),nu(this,"customReportCount",0),nu(this,"extApiInvoke",(async t=>{for(const e of t){const t=ey(ey({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:rE.TRACER});this.sendApiInvoke(t)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),Db("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),Db("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void $b.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const e=this.baseInfoMap.get(t),i=Date.now(),n=e.startTime;e.startTime=i,$b.debug("rewrite session ".concat(t," startTime: ").concat(i," , ").concat(i-n,"ms")),this.baseInfoMap.set(t,e)}setAppId(t){this._appId=t}reportApiInvoke(t,e,i){e.timeout=e.timeout||6e4,e.reportResult=void 0===e.reportResult||e.reportResult;const n=Date.now();this.apiInvokeCount+=1;const s=this.apiInvokeCount,o=()=>({tag:e.tag,invokeId:s,sid:t,name:e.name,apiInvokeTime:n,options:e.options,states:e.states||null}),r=!!Db("SHOW_REPORT_INVOKER_LOG");r&&$b.info("".concat(e.name," start"),e.options);let a=!1;xE(e.timeout).then((()=>{a||(this.sendApiInvoke(ey(ey({},o()),{},{error:U_.API_INVOKE_TIMEOUT,success:!1})),$b.debug("".concat(e.name," timeout")))}));const c=new V_(U_.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:t=>{const n=()=>{if(a)throw c;return a=!0,this.sendApiInvoke(ey(ey({},o()),{},{success:!0},e.reportResult&&{result:t})),r&&$b.info("".concat(e.name," onSuccess")),t};return i?jE(n,e.name+"Success",i,(()=>a=!0)):n()},onError:t=>{const n=()=>{if(a)throw t;a=!0,this.sendApiInvoke(ey(ey({},o()),{},{success:!1,error:t})),r&&$b.info("".concat(e.name," onFailure"),t.toString())};return i?jE(n,e.name+"Error",i,(()=>a=!0)):n()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const i=Date.now(),n=this.createBaseInfo(t,i);n.cname=e.cname;const s=Object.assign({},{willUploadConsoleLog:Db("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Nb?"global":"oversea",areas:Db("AREAS")&&Db("AREAS").join(",")},e.extend),o=Date.now(),r=ey(ey({},n),{},{eventType:Jb.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,build:kb,lts:o,elapse:o-i,extend:JSON.stringify(s),mode:e.mode,process:Db("PROCESS_ID"),appType:Db("APP_TYPE"),success:!0,version:Ob});this.send({type:Xb.SESSION,data:r},!0)}joinChooseServer(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey({},n),{},{eventType:Jb.JOIN_CHOOSE_SERVER,lts:s,eventElapse:s-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:s-i.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3});this.send({type:Xb.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey({},n),{},{eventType:Jb.REQ_USER_ACCOUNT,lts:s,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:s-i.startTime,eventElapse:s-e.lts,extend:JSON.stringify(e.extend)});this.send({type:Xb.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info;e.vid&&(n.vid=e.vid),n.uid=e.uid,n.cid=e.cid;const s=Date.now(),{firstSuccess:o,avoidJoinStartTime:r,isProxy:a,addr:c}=e,d=s-(o&&r?r:i.startTime),l=ey(ey({},n),{},{eventType:Jb.JOIN_GATEWAY,lts:s,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,elapse:d,eventElapse:s-e.lts,firstSuccess:o,signalChannel:e.signalChannel}),h=l.success?1:0;if(e.succ&&(i.lastJoinSuccessTime=s),o)this.send({type:Xb.JOIN_GATEWAY,data:l},!0);else{let t;if(c)if(a){const e=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),i=c.match(/p=[0-9]{1,6}/g);t={isSuccess:h,gatewayIp:e&&e.length?e[0].split("=")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split("=")[1]:"",isProxy:a?1:0}}else{const e=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),i=c.match(/(:|p=)[0-9]{1,6}/g);t={isSuccess:h,gatewayIp:e&&e.length?e[0].split("//")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split(/:|p=/g)[1]:"",isProxy:a?1:0}}else t={isSuccess:h,gatewayIp:"",port:"",isProxy:a?1:0};delete l.success,delete l.eventType,delete l.firstSuccess,l.vid=Number(l.vid);const e=Object.assign({},l,t,{eventType:Jb.REJOIN_GATEWAY});this.send({type:Xb.RE_JOIN_GATEWAY,data:e},!0)}}joinChannelTimeout(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=Date.now(),s=ey(ey({},i.info),{},{lts:n,timeout:e,elapse:n-i.startTime});this.send({type:Xb.JOIN_CHANNEL_TIMEOUT,data:s},!0)}publish(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey({},n),{},{eventType:Jb.PUBLISH,lts:s,eventElapse:e.eventElapse,elapse:s-i.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:Xb.PUBLISH,data:o},!0)}subscribe(t,e,i){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,o=Date.now(),r=ey(ey({},s),{},{eventType:Jb.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-n.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof e.peerid?r.peerSuid=e.peerid:r.peer=e.peerid,this.send({type:Xb.SUBSCRIBE,data:r},!0)}wsCompressorInit(t){var e;const i=[...hu(e=this.baseInfoMap).call(e)],n=i.length?i[0]:"UnableToGetSid",s=this.baseInfoMap.get(n);if(!s)return;const o=s.info,r=Date.now(),a=ey(ey({},o),{},{eventType:Jb.WS_COMPRESSOR_INIT,lts:r,eventElapse:t.eventElapse,elapse:r-s.startTime,status:t.status?1:2});this.send({type:Xb.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(t,e,i,n){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),a=ey(ey(ey({},o),n),{},{elapse:r-s.startTime,eventType:e,lts:r,firstDecodeFrame:Math.max(r-s.startTime,0),apEnd:Math.max(n.apEnd-s.startTime,0),apStart:Math.max(n.apStart-s.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-s.startTime,0),joinGwStart:Math.max(n.joinGwStart-s.startTime,0),pcEnd:Math.max(n.pcEnd-s.startTime,0),pcStart:Math.max(n.pcStart-s.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-s.startTime,0),subscriberStart:Math.max(n.subscriberStart-s.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-s.startTime,0)});this.send({type:i,data:a},!0)}firstRemoteFrame(t,e,i,n){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),a=ey(ey(ey({},o),n),{},{elapse:r-s.startTime,eventType:e,lts:r});this.send({type:i,data:a},!0)}pcStats(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey(ey({},n),e),{},{vid:void 0===n.vid?0:Number(n.vid),elapse:s-i.startTime,eventType:Jb.PC_STATS,lts:s});this.send({type:Xb.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(t,e){this.reportApiInvoke(t,{name:"Client.updateRemoteRTPCapabilities",options:e,tag:rE.TRACER}).onSuccess()}onGatewayStream(t,e,i,n){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),a=ey(ey(ey({},o),n),{},{eventType:e,lts:r});this.send({type:i,data:a},!0)}streamSwitch(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey({},n),{},{eventType:Jb.STREAM_SWITCH,lts:s,isDual:e.isdual,elapse:s-i.startTime,success:e.succ});this.send({type:Xb.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey({},n),{},{eventType:Jb.REQUEST_PROXY_APPCENTER,lts:s,eventElapse:s-e.lts,elapse:s-i.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Xb.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey({},n),{},{eventType:Jb.REQUEST_PROXY_WORKER_MANAGER,lts:s,eventElapse:s-e.lts,elapse:s-i.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Xb.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?$b.debug("reportProxyServerurl: ".concat(t)):$b.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey({},n),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:s,elapse:s-i.startTime,joinChannelSuccessElapse:s-(i.lastJoinSuccessTime||s),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:Xb.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=function(t,e,i){const n=t[e];if(!n||"string"!=typeof n)return[t];t[e]="";const s=PE(JSON.stringify(t));let o=0;const r=[];let a=0;for(let c=0;c<n.length;c++)a+=n.charCodeAt(c)<=127?1:3,a<=i-s||(r[r.length]=yE(yE({},t),{},{[e]:n.substring(o,c)}),o=c,a=n.charCodeAt(c)<=127?1:3);return o!==n.length-1&&(r[r.length]=yE(yE({},t),{},{[e]:n.substring(o)})),r}(ey(ey(ey({},n),e),{},{elapse:s-i.startTime,lts:s,productType:"WebRTC"}),"payload",1300);o.forEach((t=>this.send({type:Xb.WORKER_EVENT,data:t},!0)))}apworkerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey(ey({},n),e),{},{elapse:s-i.startTime,lts:s});this.send({type:Xb.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey(ey({},n),e),{},{elapse:s-i.startTime,lts:s,extend:e.extend||void 0});this.send({type:Xb.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=ey(ey(ey({},n),e),{},{elapse:s-i.startTime,lts:s});this.send({type:Xb.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>Db("CUSTOM_REPORT_LIMIT"))throw new V_(U_.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const i=Date.now(),n=e.map((e=>({type:Xb.USER_ANALYTICS,data:ey(ey({sid:t},e),{},{lts:i})})));try{Db("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(t){throw $b.error("send custom report message failed",t.toString()),new V_(U_.CUSTOM_REPORT_SEND_FAILED,t.message)}}sendApiInvoke(t){const e=Db("NOT_REPORT_EVENT");if(t.tag&&Ps(e)&&Ps(e).call(e,t.tag))return!1;if(null===t.sid)return this.apiInvokeUploadPendingItems.push(t),!1;const i=this.baseInfoMap.get(t.sid);if(!i)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:n,uid:s,cid:o}=i.info;let r;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof V_){const{code:e,message:i}=t.error;r=e||i||t.error.toString()}else r=t.error.toString();const a={invokeId:t.invokeId,sid:t.sid,cname:n,cid:o,uid:s,lts:t.lts,success:t.success,elapse:t.lts-i.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?r:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:Xb.API_INVOKE,data:a},!1),!0}appendSessionId(){iy.__CLIENT_LIST__.forEach((t=>{if(t._sessionId){const e=this.apiInvokeUploadPendingItems.length;for(let i=0;i<e;i++){const e=this.apiInvokeUploadPendingItems.shift();e&&(e.sid=t._sessionId,this.sendApiInvoke(Object.assign({},e)))}}}))}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>Db("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const i=[],n=[];for(;t.length;){const e=t.shift();i.length<20?i.push(e):n.push(e)}t.push(...n);for(const t of[...i]){var s;-1!==this.ltsList.indexOf(t.data.lts)?(t.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(t.data.lts)):(this.ltsList.push(t.data.lts),Zu(s=this.ltsList).call(s,((t,e)=>t-e)))}return e||(this.lastSendNormalEventTime=Date.now()),Db("ENABLE_EVENT_REPORT")?(i.length&&(Db("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((t=>i=>{Db("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(t):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(t),this.normalEventUploadPendingItems.length>Db("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-Db("NORMAL_EVENT_QUEUE_CAPACITY")),$b.warning("report: drop normal events"))))})(i)),t):t}async postDataToStatsCollector2(t){TE.networkState===hE.OFFLINE&&await e_.race([TE.onlineWaiter,xE(2*KE.maxRetryTimeout)]);const e=t=>{let e=new Uint8Array;return t.forEach((t=>{const i=Z_(JSON.stringify(t.data)),n=new ArrayBuffer(5),s=(t=>{let e=0;return Object.entries(Xb).forEach((i=>{let[n,s]=i;s===t.type&&(e=EventNameToID[n])})),e})(t),o=new DataView(n);o.setUint16(0,i.byteLength,!0),o.setUint8(2,255&s),o.setUint8(3,s>>>8&255),o.setUint8(4,s>>>16&255),e=Q_(e,new Uint8Array(n)),e=Q_(e,i)})),e},i="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Db("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(Db("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let s=0;s<2;s+=1){1===s&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Db("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(Db("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await Tb(n,{timeout:1e4,data:e(t),headers:ey(ey({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(t){if(1===s)throw t;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map((t=>JSON.stringify(t))),vid:(t=>{const e=t&&t.data.sid&&this.baseInfoMap.get(t.data.sid);return e&&e.info.vid&&+e.info.vid||0})(t[0])};TE.networkState===hE.OFFLINE&&await e_.race([TE.onlineWaiter,xE(2*KE.maxRetryTimeout)]);const n=e?"/events/proto-raws":"/events/messages";let s=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Db("EVENT_REPORT_DOMAIN"),"&p=").concat(Db("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(Db("EVENT_REPORT_DOMAIN"),":").concat(Db("STATS_COLLECTOR_PORT")).concat(n));for(let t=0;t<2;t+=1){1===t&&(s=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Db("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(Db("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(Db("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(Db("STATS_COLLECTOR_PORT")).concat(n)));try{e?await bb(s,{timeout:1e4,data:i}):await Tb(s,{timeout:1e4,data:i})}catch(e){if(1===t)throw e;continue}return}}createBaseInfo(t,e){const i=Object.assign({},Yb);return i.sid=t,this.baseInfoMap.set(t,{info:i,startTime:e}),i}reportResourceTiming(t,e){const i=performance.getEntriesByName(t),n=i[i.length-1];n&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:n,tag:rE.TRACER}).onSuccess()}}function ny(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(e,i,n){const s=n.value;if("function"==typeof s){const o=t.className||e.__className__||("AgoraRTCClient"===e.constructor.name?"Client":e.constructor.name);n.value=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];let a=n;if(t.argsMap)try{a=t.argsMap(this,...n)}catch(t){$b.warning(t),a=[]}try{JSON.stringify(a)}catch(t){$b.warning("arguments for method ".concat(o,".").concat(String(i)," not serializable for apiInvoke.")),a=[]}const c=(t.report||sy).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(i)),options:a,tag:rE.TRACER,reportResult:t.reportResult},t.throttleTime);try{const e=s.apply(this,n);return e instanceof e_?e.then((e=>(c.onSuccess(t.reportResult&&e),e))).catch((t=>{throw c.onError(t),t})):(c.onSuccess(t.reportResult&&e),e)}catch(t){throw c.onError(t),t}}}return n}}nu(iy,"__CLIENT_LIST__",[]);const sy=new iy;Vb.on("REPORT_LOG_UPLOAD",(t=>{t.networkState=TE.networkState,sy.reportApiInvoke(null,{name:"logUploadError",options:t,tag:rE.TRACER})}));const oy=["CHINA","GLOBAL"],ry=function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let t=0;t<6;t++)s.push("1");const o=s.join(""),r={};return r[t]=n,r[e]=o,Object.assign(r,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=ry,Nb||(Lb.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Lb.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Lb.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Lb.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Lb.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Lb.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Lb.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Lb.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Lb.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Lb.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Lb.AREAS=["NORTH_AMERICA","OVERSEA"]);const ay=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],cy=[];function dy(t,e){return!!e&&cy.some((i=>i.uid===t&&i.channelName===e))}iy.__CLIENT_LIST__=cy;var ly,hy,uy,py,my,gy,fy,vy,_y,Ey,Sy,Ty,by,yy,Cy,wy,Ry,Iy=es("Array").values,Ay=fs,Oy=ni,Ny=gt,ky=Iy,Ly=Array.prototype,Py={DOMTokenList:!0,NodeList:!0},Dy=K((function(t){var e=t.values;return t===Ly||Ny(Ly,t)&&e===Ly.values||Oy(Py,Ay(t))?ky:e}));function My(t,e,i,n){var s,o=arguments.length,r=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(r=(o<3?s(r):o>3?s(e,i,r):s(e,i))||r);return o>3&&r&&Object.defineProperty(e,i,r),r}function xy(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}!function(t){t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY"}(ly||(ly={})),function(t){t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver"}(hy||(hy={})),function(t){t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(uy||(uy={})),function(t){t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(py||(py={})),function(t){t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(my||(my={})),function(t){t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(gy||(gy={})),function(t){t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(fy||(fy={})),function(t){t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed"}(vy||(vy={})),function(t){t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_CONNECTING="datachannel_connecting",t.DATACHANNEL_FAILBACK="datachannel_failback",t.P2P_START="p2p_start",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(_y||(_y={})),function(t){t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag"}(Ey||(Ey={})),function(t){t.PUBLISH_STATS="publish_stats",t.PUBLISH_RELATED_STATS="publish_related_stats",t.SUBSCRIBE_STATS="subscribe_stats",t.SUBSCRIBE_RELATED_STATS="subscribe_related_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.TRANSPORT_STATS="transport_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats"}(Sy||(Sy={})),function(t){t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list"}(Ty||(Ty={})),function(t){t.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",t.NEED_ANSWER="NEED_ANSWER",t.NEED_RENEGOTIATE="NEED_RENEGOTIATE",t.P2P_LOST="P2P_LOST",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NEED_UNPUB="NEED_UNPUB",t.NEED_UNSUB="NEED_UNSUB",t.NEED_UPLOAD="NEED_UPLOAD",t.NEED_CONTROL="NEED_CONTROL",t.START_RECONNECT="START_RECONNECT",t.END_RECONNECT="END_RECONNECT",t.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(by||(by={})),function(t){t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY"}(yy||(yy={})),function(t){t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(Cy||(Cy={}));class Uy extends V_{constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),nu(this,"name","AgoraRTCException")}print(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(t,$b)}throw(){super.throw($b)}}function Vy(t){if("string"!=typeof t||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw $b.error("Invalid Channel Name ".concat(t)),new Uy(U_.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Fy(t){if(!("number"==typeof(e=t)&&Math.floor(e)===e&&0<=e&&e<=4294967295||z_(t,1,255)))throw new Uy(U_.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;"string"==typeof t&&$b.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}!function(t){t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t.INJECT="inject_streaming"}(wy||(wy={})),function(t){t[t.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",t[t.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",t[t.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",t[t.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",t[t.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",t[t.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",t[t.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",t[t.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",t[t.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(Ry||(Ry={}));const By={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},jy={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Hy(t,e){G_(t.url,"".concat(e,".url"),1,1e3,!1),$_(t.x)||j_(t.x,"".concat(e,".x"),0,1e4),$_(t.y)||j_(t.y,"".concat(e,".y"),0,1e4),$_(t.width)||j_(t.width,"".concat(e,".width"),0,1e4),$_(t.height)||j_(t.height,"".concat(e,".height"),0,1e4),$_(t.zOrder)||j_(t.zOrder,"".concat(e,".zOrder"),0,255),$_(t.alpha)||j_(t.alpha,"".concat(e,".alpha"),0,1,!1)}const Gy={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Wy={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var $y,zy,qy,Ky,Yy,Jy,Xy,Zy,Qy,tC,eC,iC,nC,sC;function oC(t){if(!t.channelName)throw new Uy(U_.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof t.uid)throw new Uy(U_.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&G_(t.token,"info.token",1,2047),Fy(t.uid),Vy(t.channelName),!0}!function(t){t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.INJECT_STREAM_STATUS="@live_uap-inject-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address"}($y||($y={})),function(t){t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(zy||(zy={})),function(t){t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(qy||(qy={})),function(t){t.CONNECT_FAILED="connect failed",t.CONNECT_TIMEOUT="connect timeout",t.WS_DISCONNECTED="websocket disconnected",t.REQUEST_TIMEOUT="request timeout",t.REQUEST_FAILED="request failed",t.WAIT_STATUS_TIMEOUT="wait status timeout",t.WAIT_STATUS_ERROR="wait status error",t.BAD_STATE="bad state",t.WS_ABORT="ws abort",t.AP_REQUEST_TIMEOUT="AP request timeout",t.AP_JSON_PARSE_ERROR="AP json parse error",t.AP_REQUEST_ERROR="AP request error",t.AP_REQUEST_ABORT="AP request abort"}(Ky||(Ky={})),function(t){t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile"}(Yy||(Yy={})),function(t){t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(Jy||(Jy={})),function(t){t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(Xy||(Xy={})),function(t){t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(Zy||(Zy={})),function(t){t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low"}(Qy||(Qy={})),function(t){t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_FAILBACK="datachannel_failback",t.RESET_SIGNAL="reset-signal"}(tC||(tC={})),function(t){t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON"}(eC||(eC={})),function(t){t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7"}(iC||(iC={})),function(t){t[t.websocket=0]="websocket",t[t.datachannel=1]="datachannel"}(nC||(nC={})),function(t){t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS"}(sC||(sC={}));const rC=[sC.AFRICA,sC.ASIA,sC.CHINA,sC.EUROPE,sC.GLOBAL,sC.INDIA,sC.JAPAN,sC.NORTH_AMERICA,sC.OCEANIA,sC.OVERSEA,sC.SOUTH_AMERICA];var aC;!function(t){t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL"}(aC||(aC={}));const cC={CHINA:{},ASIA:{CODE:aC.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:aC.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:aC.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:aC.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","\tuap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:aC.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:aC.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:aC.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:aC.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:aC.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:aC.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:aC.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:aC.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:aC.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var dC,lC,hC,uC,pC,mC,gC,fC,vC,_C,EC,SC,TC,bC,yC,CC,wC,RC,IC,AC,OC,NC;Nb&&(cC.CHINA={CODE:aC.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(t){t.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(dC||(dC={}));class kC extends iE{constructor(t,e){super(),nu(this,"onICEConnectionStateChange",void 0),nu(this,"onConnectionStateChange",void 0),nu(this,"onDTLSTransportStateChange",void 0),nu(this,"onDTLSTransportError",void 0),nu(this,"onICETransportStateChange",void 0),nu(this,"onFirstAudioReceived",void 0),nu(this,"onFirstVideoReceived",void 0),nu(this,"onFirstAudioDecoded",void 0),nu(this,"onFirstVideoDecoded",void 0),nu(this,"onFirstVideoDecodedTimeout",void 0),nu(this,"onSelectedLocalCandidateChanged",void 0),nu(this,"onSelectedRemoteCandidateChanged",void 0)}}class LC extends kC{constructor(t,e){super(t,e)}}!function(t){t.SEND="sendonly",t.RECV="recvonly",t.SENDRECV="sendrecv",t.INACTIVE="inactive"}(lC||(lC={})),function(t){t.VIDEO="video",t.AUDIO="audio"}(hC||(hC={})),function(t){t[t.UDP=0]="UDP",t[t.TCP=1]="TCP",t[t.RELAY=2]="RELAY"}(uC||(uC={})),function(t){t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.TCP_RESTART=1]="TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(pC||(pC={})),function(t){t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack"}(mC||(mC={})),function(t){t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected"}(gC||(gC={})),function(t){t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PPublish="RequestP2PPublish",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE"}(fC||(fC={})),function(t){t.MUTE_LOCAL_VIDEO="mute_local_video",t.MUTE_LOCAL_AUDIO="mute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.MUTE_REMOTE_VIDEO="mute_remote_video",t.MUTE_REMOTE_AUDIO="mute_remote_audio",t.UNMUTE_REMOTE_VIDEO="unmute_remote_video",t.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(vC||(vC={})),function(t){t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED"}(_C||(_C={})),function(t){t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED"}(EC||(EC={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(SC||(SC={})),function(t){t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK"}(TC||(TC={})),function(t){t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback"}(bC||(bC={})),function(t){t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.SECURITY_POLICY_VIOLATION="security-policy-violation"}(yC||(yC={})),function(t){t[t.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",t[t.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",t[t.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",t[t.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",t[t.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",t[t.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",t[t.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",t[t.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",t[t.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",t[t.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",t[t.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",t[t.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",t[t.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",t[t.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",t[t.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",t[t.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",t[t.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",t[t.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",t[t.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",t[t.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(CC||(CC={})),function(t){t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED"}(wC||(wC={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(RC||(RC={})),function(t){t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED"}(IC||(IC={})),function(t){t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.SUBSCRIBE="subscribe",t.UNSUBSCRIBE="unsubscribe",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.JOIN="join",t.EXCHANGE_SDP="exchange_sdp",t.DO_SUBSCRIBE="do_subscribe",t.DO_UNSUBSCRIBE="do_unsubscribe"}(AC||(AC={})),function(t){t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(OC||(OC={})),function(t){t[t.SUCCESS=1]="SUCCESS",t[t.FAILED=0]="FAILED"}(NC||(NC={}));const PC={[uy.ACCESS_POINT]:{[gy.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[gy.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[gy.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[gy.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[gy.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[gy.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[gy.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[uy.UNILBS]:{[my.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[my.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[my.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[my.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[my.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[my.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[my.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[my.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[my.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[my.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[my.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[my.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[uy.STRING_UID_ALLOCATOR]:{[py.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[py.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[py.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function DC(t){const e=PC[Math.floor(t/1e4)];if(!e)return{desc:"unkonw error",retry:!1};const i=e[t%1e4];if(!i){if(Math.floor(t/1e4)===uy.ACCESS_POINT){const e=t%1e4;if("1"===e.toString()[0])return{desc:t.toString(),retry:!1};if("2"===e.toString()[0])return{desc:t.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const MC={[fy.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[fy.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[fy.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[fy.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[fy.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[fy.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[fy.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[fy.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[fy.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[fy.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[fy.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[fy.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[fy.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[fy.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[fy.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[fy.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[fy.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[fy.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[fy.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[fy.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[fy.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[fy.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[fy.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[fy.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[fy.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[fy.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[fy.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[fy.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[fy.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[fy.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[fy.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[fy.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[fy.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[fy.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[fy.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[fy.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[fy.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[fy.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[fy.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[fy.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[fy.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[fy.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[fy.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[fy.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[fy.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[fy.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[fy.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[fy.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[fy.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[fy.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[fy.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[fy.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[fy.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[fy.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[fy.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[fy.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[fy.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[fy.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[fy.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[fy.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[fy.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[fy.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[fy.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function xC(t){return MC[t]||{desc:"UNKNOW_ERROR_".concat(t),action:"failed"}}function UC(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function VC(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?UC(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UC(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function FC(t){return t.every((t=>t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING))}function BC(t,e){if("string"==typeof t)return t;const{proxy:i,host:n,port:s}=t;if(e){const t=Db("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===t?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(t,"/ws/?p=").concat(Number(s)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const jC=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,HC=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,GC=/wss:\/\/(.+):([0-9]+)\/?/,WC=/wss:\/\/(.[^\/]+)\/?/;let $C=0;class zC{constructor(t,e){nu(this,"id",0),nu(this,"store",void 0),nu(this,"recordIndex",void 0),nu(this,"websockets",[]),nu(this,"try443PortDuration",2e3),nu(this,"forceCloseWSDuration",5e3),nu(this,"try443PortTimeout",null),nu(this,"forceCloseTimeout",null),nu(this,"isTry443PortFailed",!1),nu(this,"isNormalPortFailed",!1),nu(this,"useDoubleDomain",!1),nu(this,"useProxy",!1),nu(this,"startTime",Date.now()),this.id=++$C,this.try443PortDuration=Db("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=e}closeAllWebsockets(){this.websockets.forEach((t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var t;const e=Date.now()-this.startTime;for(var i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];$b.debug("[choose-best-ws ".concat(null===(t=this.store)||void 0===t?void 0:t.clientId," ").concat(this.id,"] ").concat(e,"ms:"),...n)}createWebSocket(t,e,i){this.logger("createWebSocket:",t,{isTry443Port:e,hasTimeoutDetection:i});const n=Db("GATEWAY_DOMAINS"),s=Date.now(),o=[],r=n.find((e=>{var i;return Ps(i=t.host).call(i,e)}));r||(this.useDoubleDomain=!1);const a=[];if(this.useDoubleDomain)n.forEach((i=>{a.push(BC(VC(VC({},t),{},{host:t.host.replace(r,i)}),e))}));else{const i=VC({},t);if(e&&r){const t=n.find((t=>t!==r));t&&(i.host=i.host.replace(r,t))}a.push(BC(i,e))}try{a.forEach((t=>{const e=new WebSocket(t);e.binaryType="arraybuffer",o.push(e),this.logger("ws is connecting:",e.url)}))}catch(n){if(this.logger("ws create failed"),o.forEach((t=>t.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,e,i);if(!e&&443!==Number(t.port))return this.createWebSocket(t,!0,i);throw new Uy(U_.WS_ERR,"init websocket failed! Error: ".concat(n.toString()))}const c=n_();return this.store&&this.store.recordJoinChannelService({urls:o.map((t=>t.url)),service:"gateway"},this.recordIndex),o.forEach((t=>{t.onopen=()=>{this.logger("onopen: ws ".concat(t.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((e=>{e!==t&&(e.onopen=null,e.onclose=null,e.onmessage=null,e.close(),this.logger("close backup websocket: ".concat(e.url)))})),this.websockets.length=0,c.resolve(t)},t.onclose=i=>{this.logger("onclose: ws ".concat(t.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(t.readyState)),e?this.isTry443PortFailed=FC(o):this.isNormalPortFailed=FC(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(e&&this.isTry443PortFailed||!e&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(i.reason)),c.reject({code:i.code,reason:eC.A_ROUND_WS_FAILED}))},t.onmessage=e=>this.logger("".concat(t.url," onmessage: ").concat(e.data))})),this.websockets.push(...o),i||(()=>{const i=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((t=>t.readyState!==WebSocket.OPEN&&t.close()))};if(e||this.useProxy)return this.logger("add 5s timeout at ".concat(e?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return i();p_().os===a_.MAC_OS&&T_()&&i(),this.createWebSocket(t,!0,!0).then((t=>c.resolve(t))).catch((t=>{this.isNormalPortFailed&&c.reject(t),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(t,e,i,n){return this.useDoubleDomain=!!e,"string"==typeof t&&(t=function(t){let e,i,n;return[,e,i,n]=t.match(jC)||[],e||([,i,n]=t.match(HC)||[]),i&&n||([,i,n]=t.match(GC)||[]),i&&n||([,i]=t.match(WC)||[]),i||$b.warning("un-destructible url: ",t),{proxy:e,host:i,port:n||"443"}}(t)),this.recordIndex=n,this.useProxy=!!t.proxy,i&&this.useProxy&&($b.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(t,!!i,!1).finally((()=>this.clearTimeout()))}}function qC(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}class KC extends iE{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var e;Ps(e=["tryNext","recover"]).call(e,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,"reconnecting"===this._state?this.emit(Cy.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Cy.CONNECTED):"closed"===this._state?this.emit(Cy.CLOSED):"failed"===this._state&&this.emit(Cy.FAILED))}resetReconnectCount(t){$b.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),nu(this,"connectionID",0),nu(this,"currentURLIndex",0),nu(this,"urls",[]),nu(this,"_reconnectMode","tryNext"),nu(this,"reconnectReason",void 0),nu(this,"_initMutex",new zE("websocket")),nu(this,"name",void 0),nu(this,"_state","closed"),nu(this,"reconnectInterrupter",void 0),nu(this,"websocket",void 0),nu(this,"retryConfig",void 0),nu(this,"reconnectCount",0),nu(this,"forceCloseTimeout",5e3),nu(this,"onlineReconnectListener",void 0),nu(this,"useCompress",void 0),nu(this,"tryDoubleDomain",!1),nu(this,"use443PortOnly",!1),nu(this,"wsInflateLength",0),nu(this,"wsDeflateLength",0),nu(this,"closeEstablishingWs",(()=>{})),nu(this,"store",void 0),nu(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=t,this.retryConfig=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?qC(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):qC(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},e),this.useCompress=i,this.tryDoubleDomain=n,this.use443PortOnly=s;const{timeout:r,timeoutFactor:a}=e,c=Math.max(300,Math.floor(3*r/5)),d=Math.max(1.2,Math.floor(8*a)/10);hE.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),TE.on(uE.NETWORK_STATE_CHANGE,((t,e)=>{t!==e&&(this.resetReconnectCount("network state change: ".concat(e," -> ").concat(t)),t===hE.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=r,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=e,this.urls=t,this.state="connecting";try{const t=n_(),e=this.urls[this.currentURLIndex];this.createWebSocketConnection(e).then(t.resolve).catch(t.reject),this.once(Cy.CLOSED,(()=>{t.reject(new V_(U_.WS_DISCONNECT))})),this.once(Cy.CONNECTED,t.resolve),await t.promise}catch(t){}finally{i()}}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const t=this.websocket;e?setTimeout((()=>t.close()),500):t.close(),this.websocket=void 0}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,e){if(!this.websocket)return void $b.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==t&&(this.reconnectMode=t),$b.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(e)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:e})}sendMessage(t){let e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new V_(U_.WS_ABORT,"websocket is not ready");try{e||(t=JSON.stringify(t)),this.websocket.send(t)}catch(t){throw new V_(U_.WS_ERR,"send websocket message error"+t.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,e=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:e}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var e;const i=n_();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const n=t=>{var e;null===(e=this.store)||void 0===e||e.signalChannelOpen(),$b.debug("[".concat(this.name,"] websocket opened:"),t),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},s=async t=>{var e;if($b.debug("[".concat(this.name,"] websocket close ").concat(null===(e=this.websocket)||void 0===e?void 0:e.url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new V_(U_.WS_DISCONNECT,"websocket close: ".concat(t.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const e=EE(this,Cy.WILL_RECONNECT,this.reconnectMode,t.reason)||this.reconnectMode,n=await this.reconnectWithAction(e);if("closed"===this.state)return void $b.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!n)return i.reject(new V_(U_.WS_DISCONNECT,"websocket reconnect failed: ".concat(t.code))),this.close(!0);i.resolve()}},o=t=>{this.emit(Cy.ON_MESSAGE,t)},r=t=>{$b.warn("[".concat(this.connectionID,"] ws open error ").concat(t))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),Db("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=Db("GATEWAY_WSS_ADDRESS")),$b.debug("[".concat(this.name,"] start connect, url:"),t);const a=null===(e=this.store)||void 0===e?void 0:e.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var c;const e=await this.chooseBestWebsocketConnection(t);this.websocket=e,n&&n(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=o,this.websocket.onerror=r,null===(c=this.store)||void 0===c||c.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this.joinGatewayRecordIndex=a}catch(t){const e="closed"===this.state,n=t instanceof V_,o=n&&t.code===U_.WS_ABORT,r=n&&t.code===U_.WS_ERR,c=n?t.message:t&&(t.reason||t.toString());$b.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(c)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:o?"aborted":"error",errors:[t]},a),e||r?(i.reject(e?new V_(U_.WS_DISCONNECT,"websocket is closed: ".concat(c)):new V_(U_.WS_ERR,"init websocket failed: ".concat(c))),r&&$b.error("[".concat(this.name,"] init websocket failed: ").concat(c))):s&&s(t)}return i.promise}async reconnectWithAction(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;$b.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||TE.isOnline||!TE.onlineWaiter||(this.onlineReconnectListener=TE.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>i=!1,e){const e=YE(this.reconnectCount,this.retryConfig);$b.debug("[".concat(this.name,"] wait ").concat(e,"ms to reconnect websocket, mode: ").concat(t)),await e_.race([xE(e),this.onlineReconnectListener||new e_((()=>{}))])}if("closed"===this._state||!i)return!1;this.reconnectCount+=1;const n=async(t,e)=>{this.emit(Cy.RECONNECT_CREATE_CONNECTION,e),await this.createWebSocketConnection(t)};try{if("retry"===t)this.emit(Cy.RECONNECT_WAITTING_FINISH,t),await n(this.urls[this.currentURLIndex],t);else if("tryNext"===t){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);$b.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(Cy.RECONNECT_WAITTING_FINISH,t),await n(this.urls[this.currentURLIndex],t)}else"recover"===t&&($b.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Cy.RECONNECT_WAITTING_FINISH,t),this.urls=await vE(this,Cy.REQUEST_NEW_URLS),this.currentURLIndex=0,await n(this.urls[this.currentURLIndex],t))}catch(i){var s;$b.error("[".concat(this.name,"] reconnect failed ").concat(i&&i.toString()));const n=null==i||null===(s=i.data)||void 0===s?void 0:s.desc;return Array.isArray(n)&&Ps(n).call(n,"dynamic key expired")?(this.emit(Cy.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(t,e)}return!0}}class YC extends KC{constructor(t,e){super(t,e,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,e){const i=n_(),n=function(t,e){return new zC(t,e)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{$b.debug("[choose-best-ws] close establishing websockets"),n.closeAllWebsockets(),i.reject(new V_(U_.WS_ABORT,"choose best websocket aborted"))};const s=Db("GATEWAY_DOMAINS");return $b.debug("[choose-best-ws] currentDomain: ",t,", domains: ",s,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),n.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,e).then(i.resolve).catch(i.reject),i.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class JC extends KC{constructor(t,e){super(t,e,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,e){return new e_(((i,n)=>{let s=!1;const o=[];this.closeEstablishingWs=()=>{$b.debug("[choose-best-ws] close establishing websockets"),o.forEach((t=>{t.onclose=null,t.onopen=null,t.onmessage=null,t.close()})),n(new V_(U_.WS_ABORT,"choose best websocket aborted"))};const r=Db("GATEWAY_DOMAINS");let a;const c=t.indexOf("?h="),d=r.find((e=>-1!==c?Ps(t).call(t,e,c):Ps(t).call(t,e)));$b.debug("[choose-best-ws] currentDomain: ",d,", domains: ",r);let l=!this.tryDoubleDomain||!d;if(!l&&d){var h;const u=Date.now();try{r.forEach((e=>{const i=-1===c?t.replace(d,e):t.substr(0,c)+t.substr(c).replace(d,e),n=new WebSocket(i);n.binaryType="arraybuffer",o.push(n),$b.debug("[choose-best-ws] ws is connecting:",n.url)}))}catch(t){for($b.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach((t=>t.close()));o.length;)o.pop();l=!0}null===(h=this.store)||void 0===h||h.recordJoinChannelService({urls:o.map((t=>t.url)),service:"gateway"},e),o.forEach((t=>{t.onopen=()=>{if(s)return;const e=Date.now()-u;$b.debug("[choose-best-ws] ws open cost ".concat(e,"ms")),o.filter((e=>e!==t)).forEach((t=>{$b.debug("[choose-best-ws]close backup websocket: ".concat(t.url)),t.close()})),s=!0,i(t)},t.onclose=t=>{a=t,s||o.find((t=>!(t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING)))||($b.debug("[choose-best-ws] all websocket is closed"),s=!0,n(a))},t.onmessage=e=>{$b.debug("[choose-best-ws]".concat(t.url," onmessage: ").concat(e.data))}})),xE(this.forceCloseTimeout).then((()=>{o.forEach((t=>{t.readyState!==WebSocket.OPEN&&t.close()}))}))}if(l){var u;let s;$b.debug("[choose-best-ws] use single url: ",t),null===(u=this.store)||void 0===u||u.recordJoinChannelService({urls:[t],service:"gateway"},e);try{s=new WebSocket(t),o.push(s),s.binaryType="arraybuffer"}catch(t){const e=new V_(U_.WS_ERR,"init websocket failed! Error: ".concat(t.toString()));return $b.error("[".concat(this.name,"]").concat(e)),void n(e)}s.onopen=()=>{i(s)},s.onclose=t=>{n(t)},s.onmessage=t=>{$b.debug("[choose-best-ws]".concat(s.url," onmessage: ").concat(t.data))},xE(this.forceCloseTimeout).then((()=>{s&&s.readyState!==WebSocket.OPEN&&s.close()}))}})).then((t=>(this.closeEstablishingWs=void 0,t))).catch((t=>{throw this.closeEstablishingWs=void 0,t}))}}class XC extends iE{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===vy.CONNECTED?this.emit(_y.WS_CONNECTED):t===vy.RECONNECTING?this.emit(_y.WS_RECONNECTING,this._websocketReconnectReason):t===vy.CLOSED&&this.emit(_y.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),nu(this,"_disconnectedReason",void 0),nu(this,"_websocketReconnectReason",void 0),nu(this,"_connectionState",vy.CLOSED),nu(this,"reconnectToken",void 0),nu(this,"websocket",void 0),nu(this,"openConnectionTime",void 0),nu(this,"clientId",void 0),nu(this,"lastMsgTime",Date.now()),nu(this,"uploadCache",[]),nu(this,"uploadCacheInterval",void 0),nu(this,"rttRolling",new dS(5)),nu(this,"pingpongTimer",void 0),nu(this,"wsInflateDataTimer",void 0),nu(this,"pingpongTimeoutCount",0),nu(this,"joinResponse",void 0),nu(this,"multiIpOption",void 0),nu(this,"initError",void 0),nu(this,"spec",void 0),nu(this,"store",void 0),nu(this,"onWebsocketMessage",(t=>{if(t.data instanceof ArrayBuffer)return void this.emit(_y.ON_BINARY_DATA,t.data);const e=JSON.parse(t.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(e,"_id")){const t="res-@".concat(e._id);this.emit(t,e._result,e._message)}else if(Object.prototype.hasOwnProperty.call(e,"_type")){if(this.emit(e._type,e._message),e._type===Ty.ON_NOTIFICATION&&this.handleNotification(e._message),e._type===Ty.ON_USER_BANNED)switch(e._message.error_code){case 14:this.close(cE.UID_BANNED);break;case 15:this.close(cE.IP_BANNED);break;case 16:this.close(cE.CHANNEL_BANNED)}if(e._type===Ty.ON_USER_LICENSE_BANNED)switch(e._message.error_code){case fy.ERR_LICENSE_MISSING:this.close(cE.LICENSE_MISSING);break;case fy.ERR_LICENSE_EXPIRED:this.close(cE.LICENSE_EXPIRED);break;case fy.ERR_LICENSE_MINUTES_EXCEEDED:this.close(cE.LICENSE_MINUTES_EXCEEDED);break;case fy.ERR_LICENSE_PERIOD_INVALID:this.close(cE.LICENSE_PERIOD_INVALID);break;case fy.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(cE.LICENSE_MULTIPLE_SDK_SERVICE);break;case fy.ERR_LICENSE_ILLEGAL:this.close(cE.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new YC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Db("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Db("JOIN_GATEWAY_USE_443PORT_ONLY"),e),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===vy.CONNECTED&&this.reconnect("retry",lE.OFFLINE)}))}async request(t,e,i,n){const s=UE(6,""),o={_id:s,_type:t,_message:e},r=this.websocket.connectionID,a=()=>new e_(((e,i)=>{if(this.connectionState===vy.CONNECTED)return e();const n=()=>{this.off(_y.WS_CLOSED,s),e()},s=()=>{this.off(_y.WS_CONNECTED,n),i(new Uy(U_.WS_ABORT))};this.once(_y.WS_CONNECTED,n),this.once(_y.WS_CLOSED,s),t!==Ey.PUBLISH&&t!==Ey.SUBSCRIBE&&t!==Ey.UNSUBSCRIBE&&t!==Ey.UNPUBLISH&&t!==Ey.CONTROL&&t!==Ey.RESTART_ICE||this.once(_y.DISCONNECT_P2P,(()=>{i(new Uy(U_.DISCONNECT_P2P))})),t!==Ey.PUBLISH&&t!==Ey.RESTART_ICE||this.once(_y.ABORT_P2P_EXECUTION,(()=>{i(new Uy(U_.DISCONNECT_P2P))}))}));if(this.connectionState!==vy.CONNECTING&&this.connectionState!==vy.RECONNECTING||t===Ey.JOIN||t===Ey.REJOIN||await a(),this.websocket.sendMessage(o,!0),n)return;const c=new e_(((i,n)=>{let o=!1;const a=(n,s)=>{o=!0,i({isSuccess:"success"===n,message:s||{}}),this.off(_y.WS_CLOSED,c),this.off(_y.WS_RECONNECTING,c),this.emit(_y.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),a);const c=()=>{n(new Uy(U_.WS_ABORT,"type: ".concat(t))),this.off(_y.WS_CLOSED,c),this.off(_y.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once(_y.WS_CLOSED,c),this.once(_y.WS_RECONNECTING,c),xE(Db("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||o||($b.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(_y.REQUEST_TIMEOUT,t,e))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===vy.CLOSED||t===Ey.LEAVE)throw new Uy(U_.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():t===Ey.JOIN||t===Ey.REJOIN?null:(await a(),await this.request(t,e))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=xC(l),u=new Uy(U_.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:($b.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===fy.ERR_TOO_MANY_BROADCASTERS?t===Ey.JOIN||t===Ey.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===fy.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,$b.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",lE.MULTI_IP)):this.reconnect(h.action,lE.SERVER_ERROR),t===Ey.JOIN||t===Ey.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new e_((i=>{const n=s=>{(!e||e(s))&&(this.off(t,n),i(s))};this.on(t,n)}))}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch(t){const e=Db("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>e&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==vy.CONNECTED)return;const t=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(t._type,t._message)}),Db("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new e_(((e,i)=>{this.once(_y.WS_CONNECTED,(()=>e(this.joinResponse))),this.once(_y.WS_CLOSED,(()=>i(this.initError||new Uy(U_.WS_ABORT)))),this.connectionState=vy.CONNECTING,this.websocket.init(t).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||cE.LEAVE,this.connectionState=vy.CLOSED,$b.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===cE.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new YC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Db("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Db("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(_y.ABORT_P2P_EXECUTION);const t=await vE(this,_y.REQUEST_JOIN_INFO),e=await this.request(Ey.JOIN,t);if(!e)return this.emit(_y.REPORT_JOIN_GATEWAY,eC.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(_y.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=vy.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Uy(U_.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=SE(this,_y.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(Ey.REJOIN,t);return!!e&&(this.connectionState=vy.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach((t=>{this.emit(Ty.ON_USER_ONLINE,{uid:t.uid}),t.audio&&this.emit(Ty.ON_ADD_AUDIO_STREAM,{uid:t.uid,uint_id:t.uint_id,audio:!0,ssrcId:t.audio_ssrc}),t.video&&this.emit(Ty.ON_ADD_VIDEO_STREAM,{uid:t.uid,uint_id:t.uint_id,video:!0,ssrcId:t.video_ssrc}),t.audio_mute?this.emit(Ty.MUTE_AUDIO,{uid:t.uid}):this.emit(Ty.UNMUTE_AUDIO,{uid:t.uid}),t.video_mute?this.emit(Ty.MUTE_VIDEO,{uid:t.uid}):this.emit(Ty.UNMUTE_VIDEO,{uid:t.uid}),t.audio_enable_local?this.emit(Ty.ENABLE_LOCAL_AUDIO,{uid:t.uid}):this.emit(Ty.DISABLE_LOCAL_AUDIO,{uid:t.uid}),t.video_enable_local?this.emit(Ty.ENABLE_LOCAL_VIDEO,{uid:t.uid}):this.emit(Ty.DISABLE_LOCAL_VIDEO,{uid:t.uid}),t.audio||t.video||this.emit(Ty.ON_REMOVE_STREAM,{uid:t.uid,uint_id:t.uint_id})})),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){$b.debug("[".concat(this.clientId,"] receive notification: "),t);const e=xC(t.code);if("success"!==e.action){if("failed"!==e.action)return"quit"===e.action?("ERR_REPEAT_JOIN_CHANNEL"===e.desc&&this.close(cE.UID_BANNED),void this.close()):void this.reconnect(e.action,lE.SERVER_ERROR);$b.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=Db("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&($b.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>Db("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",lE.TIMEOUT):this.request(Ey.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const t=Date.now()-e;this.rttRolling.add(t),Db("REPORT_STATS")&&this.send(Ey.PING_BACK,{pingpongElapse:t})})).catch((t=>{}))}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:e}=this.websocket.getWsInflateData();0!==t&&0!==e&&this.upload(Sy.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(Cy.RECONNECT_WAITTING_FINISH,(t=>{this.emit(_y.WS_RECONNECT_WAITTING_FINISH,t)})),this.websocket.on(Cy.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(_y.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(Cy.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Cy.CLOSED,(()=>{this.connectionState=vy.CLOSED})),this.websocket.on(Cy.FAILED,(()=>{this._disconnectedReason=cE.NETWORK_ERROR,this.connectionState=vy.CLOSED})),this.websocket.on(Cy.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===vy.CONNECTED?this.connectionState=vy.RECONNECTING:this.connectionState=vy.CONNECTING})),this.websocket.on(Cy.WILL_RECONNECT,((t,e,i)=>{const n=SE(this,_y.IS_P2P_DISCONNECTED),s=n||"retry"!==t;n&&"retry"===t&&($b.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",e=eC.P2P_DISCONNECTED),s&&($b.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(_y.REPORT_JOIN_GATEWAY,e||eC.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(_y.NEED_RENEW_SESSION),this.emit(_y.DISCONNECT_P2P)),i(t)})),this.websocket.on(Cy.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{$b.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",lE.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(_y.REPORT_JOIN_GATEWAY,t.message||t.code||eC.UNKNOWN_REASON,this.url||""),t instanceof Uy&&t.code===U_.UNEXPECTED_RESPONSE&&t.data.code===fy.ERR_NO_AUTHORIZED)return $b.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",lE.SERVER_ERROR);$b.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",lE.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(Cy.REQUEST_NEW_URLS,((t,e)=>{vE(this,_y.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)})),this.websocket.on(Cy.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Ty.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}var ZC="\t\n\v\f\r                　\u2028\u2029\ufeff",QC=te,tw=Es,ew=ZC,iw=mt("".replace),nw=RegExp("^["+ew+"]+"),sw=RegExp("(^|[^"+ew+"])["+ew+"]+$"),ow=function(t){return function(e){var i=tw(QC(e));return 1&t&&(i=iw(i,nw,"")),2&t&&(i=iw(i,sw,"$1")),i}},rw={start:ow(1),end:ow(2),trim:ow(3)},aw=Yd.PROPER,cw=ct,dw=ZC,lw=rw.trim;Mn({target:"String",proto:!0,forced:function(t){return cw((function(){return!!dw[t]()||"​᠎"!=="​᠎"[t]()||aw&&dw[t].name!==t}))}("trim")},{trim:function(){return lw(this)}});var hw,uw,pw=es("String").trim,mw=gt,gw=pw,fw=String.prototype,vw=K((function(t){var e=t.trim;return"string"==typeof t||t===fw||mw(fw,t)&&e===fw.trim?gw:e}));function _w(t,e,i){return{sampleRate:t,stereo:e,bitrate:i}}function Ew(t,e,i,n,s){return{width:t,height:e,frameRate:i,bitrateMin:n,bitrateMax:s}}function Sw(t,e,i,n,s){return{width:{max:t},height:{max:e},frameRate:i,bitrateMin:n,bitrateMax:s}}function Tw(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}!function(t){t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"}(hw||(hw={})),function(t){t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change"}(uw||(uw={}));const bw={"90p":Ew(160,90),"90p_1":Ew(160,90),"120p":Ew(160,120,15,30,65),"120p_1":Ew(160,120,15,30,65),"120p_3":Ew(120,120,15,30,50),"120p_4":Ew(212,120),"180p":Ew(320,180,15,30,140),"180p_1":Ew(320,180,15,30,140),"180p_3":Ew(180,180,15,30,100),"180p_4":Ew(240,180,15,30,120),"240p":Ew(320,240,15,40,200),"240p_1":Ew(320,240,15,40,200),"240p_3":Ew(240,240,15,40,140),"240p_4":Ew(424,240,15,40,220),"360p":Ew(640,360,15,80,400),"360p_1":Ew(640,360,15,80,400),"360p_3":Ew(360,360,15,80,260),"360p_4":Ew(640,360,30,80,600),"360p_6":Ew(360,360,30,80,400),"360p_7":Ew(480,360,15,80,320),"360p_8":Ew(480,360,30,80,490),"360p_9":Ew(640,360,15,80,800),"360p_10":Ew(640,360,24,80,800),"360p_11":Ew(640,360,24,80,1e3),"480p":Ew(640,480,15,100,500),"480p_1":Ew(640,480,15,100,500),"480p_2":Ew(640,480,30,100,1e3),"480p_3":Ew(480,480,15,100,400),"480p_4":Ew(640,480,30,100,750),"480p_6":Ew(480,480,30,100,600),"480p_8":Ew(848,480,15,100,610),"480p_9":Ew(848,480,30,100,930),"480p_10":Ew(640,480,10,100,400),"720p":Ew(1280,720,15,120,1130),"720p_auto":Ew(1280,720,30,900,3e3),"720p_1":Ew(1280,720,15,120,1130),"720p_2":Ew(1280,720,30,120,2e3),"720p_3":Ew(1280,720,30,120,1710),"720p_5":Ew(960,720,15,120,910),"720p_6":Ew(960,720,30,120,1380),"1080p":Ew(1920,1080,15,120,2080),"1080p_1":Ew(1920,1080,15,120,2080),"1080p_2":Ew(1920,1080,30,120,3e3),"1080p_3":Ew(1920,1080,30,120,3150),"1080p_5":Ew(1920,1080,60,120,4780),"1440p":Ew(2560,1440,30,120,4850),"1440p_1":Ew(2560,1440,30,120,4850),"1440p_2":Ew(2560,1440,60,120,7350),"4k":Ew(3840,2160,30,120,8910),"4k_1":Ew(3840,2160,30,120,8910),"4k_3":Ew(3840,2160,60,120,13500)},yw=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],Cw={"480p":Sw(640,480,5),"480p_1":Sw(640,480,5),"480p_2":Sw(640,480,30),"480p_3":Sw(640,480,15),"720p":Sw(1280,720,5),"720p_auto":Ew(1280,720,30,900,3e3),"720p_1":Sw(1280,720,5),"720p_2":Sw(1280,720,30),"720p_3":Sw(1280,720,15),"1080p":Sw(1920,1080,5),"1080p_1":Sw(1920,1080,5),"1080p_2":Sw(1920,1080,30),"1080p_3":Sw(1920,1080,15)},ww={"1SL1TL":Tw(1,1),"3SL3TL":Tw(3,3),"2SL3TL":Tw(2,3)};function Rw(t){return t||(t="480p_1"),"string"==typeof t?Object.assign({},bw[t]):t}function Iw(t){return"string"==typeof t?Object.assign({},Cw[t]):t}function Aw(t){return"string"==typeof t?Object.assign({},ww[t]):t}const Ow={speech_low_quality:_w(16e3,!1),speech_standard:_w(32e3,!1,18),music_standard:_w(48e3,!1),standard_stereo:_w(48e3,!0,56),high_quality:_w(48e3,!1,128),high_quality_stereo:_w(48e3,!0,192)};function Nw(t){return"string"==typeof t?Object.assign({},Ow[t]):t}const kw=[];function Lw(t){return B_(t,"mediaSource",["screen","window","application"]),!0}var Pw,Dw,Mw,xw,Uw,Vw,Fw,Bw,jw,Hw;!function(t){t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track"}(Pw||(Pw={})),function(t){t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream"}(Dw||(Dw={})),function(t){t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM"}(Mw||(Mw={})),function(t){t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM"}(xw||(xw={})),function(t){t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY"}(Uw||(Uw={})),function(t){t.TRANSCEIVER_UPDATED="transceiver-updated"}(Vw||(Vw={})),function(t){t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed"}(Fw||(Fw={})),function(t){t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(Bw||(Bw={})),function(t){t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source"}(jw||(jw={})),function(t){t.UPDATE_TRACK_SOURCE="update-track-source"}(Hw||(Hw={}));const Gw={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},Ww={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},$w={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},zw={uplinkNetworkQuality:0,downlinkNetworkQuality:0},qw={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var Kw,Yw,Jw,Xw,Zw;!function(t){t.ON_TRACK="on_track",t.ON_NODE="on_node"}(Kw||(Kw={})),function(t){t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints"}(Yw||(Yw={})),function(t){t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND"}(Jw||(Jw={})),function(t){t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(Xw||(Xw={})),function(t){t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata"}(Zw||(Zw={}));const Qw={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var tR;!function(t){t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error"}(tR||(tR={}));class eR extends iE{constructor(t,e){super(),nu(this,"_ID",void 0),nu(this,"_rtpTransceiver",void 0),nu(this,"_lowRtpTransceiver",void 0),nu(this,"_hints",[]),nu(this,"_isClosed",!1),nu(this,"_originMediaStreamTrack",void 0),nu(this,"_mediaStreamTrack",void 0),nu(this,"_external",{}),this._ID=e||UE(8,"track-"),this._originMediaStreamTrack=t,this._mediaStreamTrack=t,function(t){Ps(kw).call(kw,t)||kw.push(t)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){if(!t){const t=sy.reportApiInvoke(null,{name:oE.GET_MEDIA_STREAM_TRACK,options:[],tag:rE.TRACER});this._mediaStreamTrack&&"string"==typeof this._mediaStreamTrack.label?t.onSuccess(this._mediaStreamTrack.label):t.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===Mw.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){const e=kw.indexOf(t);-1!==e&&kw.splice(e,1)}(this),this.emit(Fw.CLOSED)}_updateRtpTransceiver(t,e){if(e===Mw.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(Vw.TRANSCEIVER_UPDATED,t,e)}}class iR extends eR{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}constructor(t,e){super(t,e),nu(this,"_enabled",!0),nu(this,"_muted",!1),nu(this,"_isExternalTrack",!1),nu(this,"_isClosed",!1),nu(this,"_enabledMutex",void 0),nu(this,"processor",void 0),nu(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new zE("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,e;return null!==(t=null===(e=this._originMediaStreamTrack)||void 0===e?void 0:e.label)&&void 0!==t?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,$b.debug("[".concat(this.getTrackId(),"] close")),this.emit(Pw.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=i,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _E(this,Pw.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){$b.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Fw.TRACK_ENDED)}stateCheck(t,e){if($b.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(e,"]")),F_(e,t),this._enabled&&this._muted&&"enabled"===t&&!1===e)throw new V_(U_.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",$b);if(!this._enabled&&!this._muted&&"muted"===t&&!0===e)throw new V_(U_.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",$b)}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function nR(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}const sR=window.AudioContext||window.webkitAudioContext;let oR=null;const rR=new class extends iE{constructor(){super(...arguments),nu(this,"prevState",void 0),nu(this,"curState",void 0),nu(this,"currentTime",void 0),nu(this,"currentTimeStuckAt",void 0),nu(this,"interruptDetectorTrack",void 0),nu(this,"onLocalAudioTrackMute",(()=>{$b.info("ios15-interruption-start"),this.emit(uw.IOS_15_16_INTERRUPTION_START)})),nu(this,"onLocalAudioTrackUnmute",(async()=>{$b.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?$b.info("ios15-interruption-end-canceled"):(oR&&await oR.suspend(),this.emit(uw.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(t){$b.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){$b.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function aR(){if(!sR)return void $b.error("your browser is not support web audio");$b.info("create audio context");const t=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?nR(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):nR(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},Db("WEBAUDIO_INIT_OPTIONS"));$b.debug("audio context init option:",JSON.stringify(t)),oR=new sR(t),rR.curState=oR.state,oR.onstatechange=()=>{rR.prevState=rR.curState,rR.curState=oR?oR.state:void 0;const{prevState:t,curState:e}=rR,i="running"===e,n="interrupted"===e,s="running"===t,o="suspended"===t,r="interrupted"===t,a=p_().osVersion;(b_()||k_())&&s&&n&&($b.info("ios".concat(a,"-interruption-start")),rR.emit(uw.IOS_INTERRUPTION_START)),(b_()||k_())&&(o||r)&&i&&($b.info("ios".concat(a,"-interruption-end")),rR.emit(uw.IOS_INTERRUPTION_END)),t!==e&&($b.debug("AudioContext State Change","".concat(t,"=>").concat(e)),rR.emit(uw.STATE_CHANGE))},setInterval((()=>{var t;const e=null===(t=oR)||void 0===t?void 0:t.currentTime;rR.currentTime!==e?(rR.currentTimeStuckAt&&($b.debug("AudioContext current time resume at ".concat(e)),rR.currentTimeStuckAt=void 0),rR.currentTime=e):(e!==rR.currentTimeStuckAt&&(sy.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:e},tag:rE.TRACER}).onSuccess(),$b.warning("AudioContext current time stuck at ".concat(e))),rR.currentTimeStuckAt=e)}),5e3),async function(t){const e=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,n=!1,s=!1,o=!1;function r(e){"running"===t.state?a(!1):b_()||k_()?"suspended"===t.state&&(a(!0),e&&t.resume().then(d,d)):"closed"!==t.state&&(a(!0),e&&t.resume().then(d,d))}function a(t){if(n!==t){n=t;for(let i=0,n=e;i<n.length;i+=1){const e=n[i];t?window.addEventListener(e,l,{capture:!0,passive:!0}):window.removeEventListener(e,l,{capture:!0,passive:!0})}}}function c(){r(!0)}function d(){r(!1)}function l(){r(!0)}function h(t){if(!o)if(i.paused)if(t){let e;u(!1),o=!0;try{e=i.play(),e?e.then(p,p):(i.addEventListener("playing",p),i.addEventListener("abort",p),i.addEventListener("error",p))}catch(t){p()}}else u(!0);else u(!1)}function u(t){if(s!==t){s=t;for(let i=0,n=e;i<n.length;i++){const e=n[i];t?window.addEventListener(e,m,{capture:!0,passive:!0}):window.removeEventListener(e,m,{capture:!0,passive:!0})}}}function p(){i.removeEventListener("playing",p),i.removeEventListener("abort",p),i.removeEventListener("error",p),o=!1,h(!1)}function m(){h(!0)}if(b_()){const e=t.createMediaStreamDestination(),n=document.createElement("div");n.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=n.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=e.stream,h(!0)}rR.on(uw.STATE_CHANGE,c),r(!1)}(oR)}function cR(){if(!oR){if(aR(),!oR)throw new V_(U_.NOT_SUPPORTED,"can not create audio context");return oR}return oR}function dR(){return!!oR}function lR(t){if(function(){if(null!==hR)return hR;const t=cR(),e=t.createBufferSource(),i=t.createGain(),n=t.createGain();e.connect(i),e.connect(n),e.disconnect(i);let s=!1;try{e.disconnect(i)}catch(t){s=!0}return e.disconnect(),hR=s,s}())return;const e=t.connect,i=t.disconnect;t.connect=(i,n,s)=>{var o;return t._inputNodes||(t._inputNodes=[]),Ps(o=t._inputNodes).call(o,i)||(i instanceof AudioNode?(t._inputNodes.push(i),e.call(t,i,n,s)):e.call(t,i,n)),t},t.disconnect=(n,s,o)=>{i.call(t),n?CE(t._inputNodes,n):t._inputNodes=[];for(const i of t._inputNodes)e.call(t,i)}}let hR=null;function uR(t,e){let i=!1;const n=1/e;if(Db("DISABLE_WEBAUDIO")){const e=window.setInterval((()=>{i?window.clearInterval(e):t(performance.now()/1e3)}),1e3*n)}else{const e=cR();let s=e.createGain();s.gain.value=0,s.connect(e.destination);const o=()=>{if(i)return void(s=null);const r=e.createOscillator();r.onended=o,r.connect(s),r.start(0),r.stop(e.currentTime+n),t(e.currentTime)};o()}return()=>{i=!0}}const pR={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function mR(){return pR}class gR{constructor(){nu(this,"context",void 0),nu(this,"analyserNode",void 0),nu(this,"sourceNode",void 0),this.context=cR(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(t){}this.sourceNode=t,null==t||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode)return 0;if(!this.context||b_()||k_()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode)return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);for(let i=0;i<t.length;++i)t[i]=e[i]/128-1}const e=cS(t).call(t,((t,e)=>t+e*e),0)/t.length;return Math.max(10*Math.log10(e)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,e;null===(t=this.sourceNode)||void 0===t||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(e=this.sourceNode)||void 0===e||e.connect(this.analyserNode)}catch(t){$b.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class fR extends iE{get processSourceNode(){return this.sourceNode}set processedNode(t){var e;if(!this.isDestroyed&&this._processedNode!==t){try{var i;null===(i=this.sourceNode)||void 0===i||i.disconnect(this.outputNode)}catch(t){}null===(e=this._processedNode)||void 0===e||e.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),nu(this,"outputNode",void 0),nu(this,"outputTrack",void 0),nu(this,"isPlayed",!1),nu(this,"context",void 0),nu(this,"audioBufferNode",void 0),nu(this,"destNode",void 0),nu(this,"audioOutputLevel",0),nu(this,"volumeLevelAnalyser",void 0),nu(this,"_processedNode",void 0),nu(this,"playNode",void 0),nu(this,"isDestroyed",!1),nu(this,"onNoAudioInput",void 0),nu(this,"isNoAudioInput",!1),nu(this,"_noAudioInputCount",0),this.context=cR(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),lR(this.outputNode),this.volumeLevelAnalyser=new gR}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=t=>{this.emit(jw.ON_AUDIO_BUFFER,function(t){for(let e=0;e<t.outputBuffer.numberOfChannels;e+=1){const i=t.outputBuffer.getChannelData(e);for(let t=0;t<i.length;t+=1)i[t]=0}return t.inputBuffer}(t))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!mR().webAudioMediaStreamDest)throw new V_(U_.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){"running"!==this.context.state&&RE((()=>{rR.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(t){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;b_()||k_()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();const e=this.volumeLevelAnalyser.getAnalyserNode();let i;e.getFloatTimeDomainData?(i=new Float32Array(e.fftSize),e.getFloatTimeDomainData(i)):(i=new Uint8Array(e.fftSize),e.getByteTimeDomainData(i));let n=!1;for(let t=0;t<i.length;t++)0!==i[t]&&(n=!0);return n?(this.isNoAudioInput=!1,!0):(await xE(200),await this.checkHasAudioInput(t?t+1:1)&&n)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,e;null===(t=this.processedNode)||void 0===t||t.disconnect(),null===(e=this.sourceNode)||void 0===e||e.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?null===(t=this.processedNode)||void 0===t||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class vR extends fR{get isFreeze(){return!1}constructor(t,e,i){var n;if(super(),nu(this,"sourceNode",void 0),nu(this,"track",void 0),nu(this,"clonedTrack",void 0),nu(this,"audioElement",void 0),nu(this,"isCurrentTrackCloned",!1),nu(this,"isRemoteTrack",!1),nu(this,"originVolumeLevelAnalyser",void 0),nu(this,"rebuildWebAudio",(async()=>{if($b.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void $b.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>$b.info("resume success"))),$b.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const t=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?t.stop():this.isCurrentTrackCloned=!0;const e=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(e),lR(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const i=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(i,this.context.currentTime),lR(this.outputNode),this.emit(jw.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=e,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),"audio"!==t.kind)throw new V_(U_.UNEXPECTED_ERROR);this.track=t;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!e,this.sourceNode=this.context.createMediaStreamSource(s),lR(this.sourceNode),i){const t=i.clone();t.enabled=!0,this.clonedTrack=t,$b.debug("create an unmuted track ".concat(t.id," from the original track ").concat(i.id," to get the volume"));const e=this.context.createMediaStreamSource(new MediaStream([t]));lR(e),this.originVolumeLevelAnalyser=new gR,this.originVolumeLevelAnalyser.updateSource(e)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const o=p_();e&&o.os===a_.IOS&&Number(null===(n=o.osVersion)||void 0===n?void 0:n.split(".")[0])<15&&(rR.on(uw.STATE_CHANGE,(()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((t=>{t||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const e=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(e),lR(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(jw.UPDATE_SOURCE),this.audioElement.srcObject=e}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),rR.off("state-change",this.rebuildWebAudio),null===(t=this.originVolumeLevelAnalyser)||void 0===t||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const e=t.clone();e.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=e),$b.debug("create an unmuted track ".concat(e.id," from the original track ").concat(t.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([e]));lR(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function _R(t,e,i){const n=(t,e)=>t?"number"!=typeof t?t.max||t.exact||t.ideal||t.min||e:t:e,s={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:n(e.height,1080),maxWidth:n(e.width,1920)}}};return e.frameRate&&"number"!=typeof e.frameRate?(s.video.mandatory.maxFrameRate=e.frameRate.max,s.video.mandatory.minFrameRate=e.frameRate.min):"number"==typeof e.frameRate&&(s.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(s)}async function ER(t,e){const i=await SR(t.mediaSource),{sourceId:n,audio:s}=await function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new e_(((i,n)=>{const s=document.createElement("div");s.innerText="share screen",s.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const o=document.createElement("div");o.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const r=document.createElement("div");r.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",r.setAttribute("style","height: 12%;");const a=document.createElement("div");a.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const c=document.createElement("div");c.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const d=document.createElement("button");d.innerHTML="cancel",d.setAttribute("style","width: 85px;"),d.onclick=()=>{document.body.removeChild(u);const t=new Error("NotAllowedError");t.name="NotAllowedError",n(t)};let l=e;const h=document.createElement("div");if(e){const t=document.createElement("input");t.setAttribute("type","checkbox");const e=document.createElement("span");t.setAttribute("style","margin-right: 6px;"),e.innerText="Share audio",t.checked=l,t.onchange=()=>{l=t.checked},h.appendChild(t),h.appendChild(e)}c.appendChild(h),c.appendChild(d),o.appendChild(r),o.appendChild(a),o.appendChild(c);const u=document.createElement("div");u.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),u.appendChild(s),u.appendChild(o),document.body.appendChild(u),t.map((t=>{if(t.id){const e=document.createElement("div");e.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let n=t.thumbnail;try{const{width:t}=n.getSize();t>1920&&(n=n.resize({width:1920}))}catch(t){throw t&&t.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),t}e.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+n.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+t.name.replace(/[\u00A0-\u9999<>\&]/g,(function(t){return"&#"+t.charCodeAt(0)+";"}))+"</span>",e.onclick=()=>{document.body.removeChild(u),i({sourceId:t.id,audio:l})},a.appendChild(e)}}))}))}(i,e);return await _R(n,t,s)}async function SR(t){let e=["window","screen"];"application"!==t&&"window"!==t||(e=["window"]),"screen"===t&&(e=["screen"]);const i=sE();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new V_(U_.ELECTRON_IS_NULL);let n=null;try{var s;n=(null===(s=i.desktopCapturer)||void 0===s?void 0:s.getSources({types:e}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch(t){n=null}n&&n.then||(n=new e_(((t,n)=>{i.desktopCapturer.getSources({types:e},((e,i)=>{e?n(e):t(i)}))})));try{return await n}catch(t){throw new V_(U_.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,t.toString())}}function TR(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}const bR=new zE("safari");let yR=!1,CR=!1;async function wR(t,e){let i=0,n=null;for(;i<2;)try{n=await RR(t,e,i>0);break}catch(t){if(t instanceof V_)throw $b.error("[".concat(e,"] ").concat(t.toString())),t;const n=IR(t.name||t.code||t,t.message);if(n.code===U_.MEDIA_OPTION_INVALID){$b.debug("[".concat(e,"] detect media option invalid, retry")),i+=1,await xE(500);continue}throw $b.error("[".concat(e,"] ").concat(n.toString())),n}if(!n)throw new V_(U_.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function RR(t,e,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new V_(U_.NOT_SUPPORTED,"can not find getUserMedia");i&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const n=mR(),s=new MediaStream;if(t.audioSource&&s.addTrack(t.audioSource),t.videoSource&&s.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return $b.debug("Using Video Source/ Audio Source"),s;if(t.screen)if(sE())t.screen.sourceId?AR(s,await _R(t.screen.sourceId,t.screen,t.screenAudio)):AR(s,await ER(t.screen,t.screenAudio));else if(E_()&&t.screen.extensionId&&t.screen.mandatory){if(!n.getStreamFromExtension)throw new V_(U_.NOT_SUPPORTED,"This browser does not support screen sharing");$b.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const i=await(r=t.screen.extensionId,a=e,new e_(((t,e)=>{try{chrome.runtime.sendMessage(r,{getStream:!0},(i=>{if(!i||!i.streamId)return $b.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),i),void e(new V_(U_.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));t(i.streamId)}))}catch(t){$b.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(r,")"),t.toString()),e(new V_(U_.CHROME_PLUGIN_NOT_INSTALL))}})));t.screen.mandatory.chromeMediaSourceId=i,AR(s,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(n.getDisplayMedia){var o;t.screen.mediaSource&&Lw(t.screen.mediaSource);const i={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:null!==(o=t.screen.displaySurface)&&void 0!==o?o:"screen"===t.screen.mediaSource?"monitor":t.screen.mediaSource},{selfBrowserSurface:n,surfaceSwitching:r,systemAudio:a}=t.screen,c={selfBrowserSurface:n,surfaceSwitching:r,systemAudio:a};!n&&delete c.selfBrowserSurface,!r&&delete c.surfaceSwitching,!a&&delete c.systemAudio,$b.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:i,audio:!!t.screenAudio,controls:c}));const d=await navigator.mediaDevices.getDisplayMedia(function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?TR(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):TR(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({video:i,audio:!!t.screenAudio},c));AR(s,d)}else{if(!T_())throw $b.error("[".concat(e,"] This browser does not support screenSharing")),new V_(U_.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&Lw(t.screen.mediaSource);const i={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};$b.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(i))),AR(s,await navigator.mediaDevices.getUserMedia(i))}}var r,a;if(!t.video&&!t.audio)return s;let c={video:t.video,audio:t.audio},d=Db("MEDIA_DEVICE_CONSTRAINTS");if(d)try{"string"==typeof d&&(d=JSON.parse(d)),c=GE(c,d)}catch(t){}$b.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),p_();let l,h=null;(S_()||b_()||f_())&&(h=await bR.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(t){throw h&&h(),t}return c.audio&&(yR=!0),c.video&&(CR=!0),AR(s,l),h&&h(),s}function IR(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new V_(U_.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new V_(U_.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new V_(U_.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new V_(U_.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new V_(U_.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new V_(U_.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return $b.error("getUserMedia unexpected error",t),new V_(U_.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function AR(t,e){const i=t.getVideoTracks()[0],n=t.getAudioTracks()[0],s=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(n&&t.removeTrack(n),t.addTrack(o)),s&&(i&&t.removeTrack(i),t.addTrack(s))}const OR=new class extends iE{get state(){return this._state}set state(t){t!==this._state&&(this.emit(Xw.STATE_CHANGE,t),this._state=t)}constructor(){super(),nu(this,"_state",Jw.IDLE),nu(this,"isAccessMicrophonePermission",!1),nu(this,"isAccessCameraPermission",!1),nu(this,"lastAccessMicrophonePermission",!1),nu(this,"lastAccessCameraPermission",!1),nu(this,"checkdeviceMatched",!1),nu(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(Db("ENUMERATE_DEVICES_INTERVAL")||(M_()||m_()===a_.HARMONY_OS)&&D_())&&this.updateDevicesInfo()}),Db("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((t=>$b.error(t.toString())))}async enumerateDevices(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new V_(U_.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const n=await navigator.mediaDevices.enumerateDevices(),s=this.checkMediaDeviceInfoIsOk(n);let o=!this.isAccessMicrophonePermission&&t,r=!this.isAccessCameraPermission&&e;s.audio&&(o=!1),s.video&&(r=!1);let a=null,c=null,d=null;if(!i&&(o||r)){if(bR.isLocked&&($b.debug("[device manager] wait GUM lock"),(await bR.lock())(),$b.debug("[device manager] GUM unlock")),yR&&(o=!1,this.isAccessMicrophonePermission=!0),CR&&(r=!1,this.isAccessCameraPermission=!0),$b.debug("[device manager] check media device permissions",t,e,o,r),o&&r){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(t){const e=IR(t.name||t.code||t,t.message);if(e.code===U_.PERMISSION_DENIED)throw e;$b.warning("getUserMedia failed in getDevices",e)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:t})}catch(t){const e=IR(t.name||t.code||t,t.message);if(e.code===U_.PERMISSION_DENIED)throw e;$b.warning("getUserMedia failed in getDevices",e)}this.isAccessMicrophonePermission=!0}else if(r){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(t){const e=IR(t.name||t.code||t,t.message);if(e.code===U_.PERMISSION_DENIED)throw e;$b.warning("getUserMedia failed in getDevices",e)}this.isAccessCameraPermission=!0}$b.debug("[device manager] mic permission",t,"cam permission",e)}try{const t=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((t=>t.stop())),c&&c.getTracks().forEach((t=>t.stop())),d&&d.getTracks().forEach((t=>t.stop())),a=null,c=null,d=null,t}catch(t){return a&&a.getTracks().forEach((t=>t.stop())),c&&c.getTracks().forEach((t=>t.stop())),d&&d.getTracks().forEach((t=>t.stop())),a=null,c=null,d=null,new V_(U_.ENUMERATE_DEVICES_FAILED,t.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter((t=>"audioinput"===t.kind))}async getCamerasDevices(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter((t=>"videoinput"===t.kind))}async getSpeakers(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter((t=>"audiooutput"===t.kind))}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach((i=>{i.device.label===t&&(e=i.device.deviceId)})),e}async getDeviceById(t){const e=(await this.enumerateDevices(!0,!0,!0)).find((e=>e.deviceId===t));if(!e)throw new V_(U_.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=Jw.INITING;try{await this.updateDevicesInfo(),this.state=Jw.INITEND}catch(t){throw $b.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=Jw.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new V_(U_.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),i=[];if(t[0]&&t[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;const e=t.find((t=>"audioinput"===t.kind&&"default"===t.deviceId)),i=t.find((t=>"audiooutput"===t.kind&&"default"===t.deviceId));e&&i?i.groupId===e.groupId?$b.debug("[device-check] default input ".concat(e.label," and output ").concat(i.label," is the same group")):$b.warning("[device-check] default input ".concat(e.label," and output ").concat(i.label," is not the same group")):$b.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(t);if(t.forEach((t=>{if(!t.deviceId)return;const n=this.deviceInfoMap.get("".concat(t.kind,"_").concat(t.deviceId));if("ACTIVE"!==(n?n.state:"INACTIVE")){const n={initAt:e,updateAt:e,device:t,state:"ACTIVE"};this.deviceInfoMap.set("".concat(t.kind,"_").concat(t.deviceId),n),i.push(n)}n&&(n.updateAt=e)})),this.deviceInfoMap.forEach(((t,n)=>{"ACTIVE"===t.state&&t.updateAt!==e&&(t.state="INACTIVE",i.push(t))})),this.state!==Jw.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach((t=>{switch(t.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Xw.RECORDING_DEVICE_CHANGED,t);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Xw.CAMERA_DEVICE_CHANGED,t);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Xw.PLAYOUT_DEVICE_CHANGED,t)}})),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const e=t.filter((t=>"audioinput"===t.kind)),i=t.filter((t=>"videoinput"===t.kind)),n={audio:!1,video:!1};for(const t of e)if(t.label&&t.deviceId){n.audio=!0;break}for(const t of i)if(t.label&&t.deviceId){n.video=!0;break}return n}};let NR=!1;const kR=new class extends iE{constructor(){super(...arguments),nu(this,"onAutoplayFailed",void 0),nu(this,"onAudioAutoplayFailed",void 0)}};function LR(){if(p_(),!NR){const t=e=>{e.preventDefault(),NR=!1,x_()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};NR=!0,x_()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),$b.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),kR.onAutoplayFailed?kR.onAutoplayFailed():kR.onAudioAutoplayFailed?$b.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):$b.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),kR.emit("autoplay-failed")}}function PR(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function DR(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?PR(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):PR(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function MR(t,e,i,n){if(!t)return;const s=sy.getBaseInfoBySessionId(t);if(!s)return;const o=s.info,r=Date.now(),a=DR(DR({},o),{},{vid:void 0===o.vid?0:Number(o.vid),lts:r,elapse:r-s.startTime,cbRegistered:kR.onAutoplayFailed||kR.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:e,trackId:n,extend:void 0});sy.send({type:Xb.AUTOPLAY_FAILED,data:a},!0)}const xR=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],UR=new class{constructor(){nu(this,"onAutoplayFailed",void 0),nu(this,"elementMap",new Map),nu(this,"elementStateMap",new Map),nu(this,"elementsNeedToResume",[]),nu(this,"sinkIdMap",new Map),nu(this,"autoResumeAfterInterruption",(()=>{Array.from(this.elementMap.entries()).forEach((t=>{let[e,i]=t;const n=this.elementStateMap.get(e),s=i.srcObject.getAudioTracks()[0];A_()?s&&"live"===s.readyState&&"running"===rR.curState&&($b.debug("auto resume after interruption for iOS 15"),i.pause(),i.play()):n&&"paused"===n&&s&&"live"===s.readyState&&"running"===rR.curState&&($b.debug("auto resume after interruption for iOS"),i.play())}))})),nu(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((t=>{let[e,i]=t;const n=i.srcObject.getAudioTracks()[0];n&&"live"===n.readyState&&($b.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())}))})),this.autoResumeAudioElement(),rR.on(uw.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),rR.on(uw.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),rR.on(uw.STATE_CHANGE,(()=>{b_()&&"suspended"===rR.prevState&&"running"===rR.curState&&this.autoResumeAfterInterruption()}))}async setSinkID(t,e){const i=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),i)try{await i.setSinkId(e)}catch(t){throw new V_(U_.PERMISSION_DENIED,"can not set sink id: "+t.toString())}}play(t,e,i,n){if(this.elementMap.has(e))return;const s=document.createElement("audio");s.autoplay=!0,s.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,s),this.elementMap.set(e,s),this.elementStateMap.set(e,Zw.INIT),this.setVolume(e,i);const o=this.sinkIdMap.get(e);if(o)try{s.setSinkId(o).catch((t=>{$b.warning("[".concat(e,"] set sink id failed"),t.toString())}))}catch(t){$b.warning("[".concat(e,"] set sink id failed"),t.toString())}const r=s.play();r&&r.then&&r.catch((t=>{n&&MR(n,"audio",t.message,e),$b.warning("audio element play warning",t.toString()),this.elementMap.has(e)&&"NotAllowedError"===t.name&&($b.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(s),RE((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),LR()})))}))}updateTrack(t,e){const i=this.elementMap.get(t);i&&(i.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&"playing"===this.elementStateMap.get(t)}setVolume(t,e){const i=this.elementMap.get(t);i&&(e=Math.max(0,Math.min(100,e)),i.volume=e/100)}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const i=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(i,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){xR.forEach((i=>{e.addEventListener(i,(i=>{const n=this.elementStateMap.get(t),s="pause"===i.type?"paused":i.type;if($b.debug("[".concat(t,"] audio-element-status change ").concat(n," => ").concat(s)),"error"===i.type){const i=null==e?void 0:e.error;i&&$b.error("[".concat(t,"] media error, code: ").concat(i.code,", message: ").concat(i.message))}this.elementStateMap.set(t,s)}))}))}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach((t=>{t.play().then((t=>{$b.debug("Auto resume audio element success")})).catch((t=>{$b.warning("Auto resume audio element failed!",t)}))})),this.elementsNeedToResume=[]};new e_((t=>{document.body?t():window.addEventListener("load",(()=>t()))})).then((()=>{x_()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))}))}};function VR(){return function(t,e,i){const n=i.value;return"function"==typeof n&&(i.value=function(){this._isClosed&&new V_(U_.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",$b);for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=n.apply(this,e);return s instanceof e_?new e_(((t,e)=>{s.then(t).catch(e)})):s}),i}}function FR(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function BR(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?FR(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):FR(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class jR extends iE{constructor(t){super(),nu(this,"name","VideoProcessorDestination"),nu(this,"ID","0"),nu(this,"_source",void 0),nu(this,"videoContext",void 0),nu(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new V_(U_.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new V_(U_.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(Kw.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Kw.ON_TRACK,void 0)}}class HR extends iE{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e){super(),nu(this,"constraintsMap",new Map),nu(this,"statsRegistry",[]),nu(this,"usageRegistry",[]),nu(this,"trackId",void 0),nu(this,"direction",void 0),nu(this,"_chained",!1),this.trackId=t,this.direction=e}async getConstraints(){return await vE(this,Yw.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,e){var i;return $b.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),_E(this,Yw.REQUEST_UPDATE_CONSTRAINTS,Array.from(Dy(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return $b.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),_E(this,Yw.REQUEST_UPDATE_CONSTRAINTS,Array.from(Dy(e=this.constraintsMap).call(e)))}registerStats(t,e,i){this.statsRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:i})}unregisterStats(t,e){const i=this.statsRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:i,type:n,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:e,processorName:i,type:n,stats:o})}catch(t){$b.error(new V_(U_.UNEXPECTED_ERROR,t.message))}return t}registerUsage(t,e){this.usageRegistry.find((e=>e.processorID===t.ID&&e.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex((e=>e.processorID===t.ID&&e.processorName===t.name));-1!==e&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let i=e();i instanceof e_&&(i=await i),t.push(BR(BR({},i),{},{direction:this.direction}))}catch(t){$b.error("gather extension usage error",t)}return t}getDirection(){return this.direction}}class GR extends iE{constructor(t){super(),nu(this,"name","AudioProcessorDestination"),nu(this,"ID","0"),nu(this,"inputTrack",void 0),nu(this,"inputNode",void 0),nu(this,"audioProcessorContext",void 0),nu(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new V_(U_.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new V_(U_.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Kw.ON_TRACK,void 0),this.emit(Kw.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(Kw.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(Kw.ON_NODE,this.inputNode))}}class WR extends iE{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e,i){super(),nu(this,"constraintsMap",new Map),nu(this,"statsRegistry",[]),nu(this,"audioContext",void 0),nu(this,"trackId",void 0),nu(this,"direction",void 0),nu(this,"usageRegistry",[]),nu(this,"_chained",!1),this.audioContext=t,this.trackId=e,this.direction=i}async getConstraints(){return vE(this,Yw.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,e){var i;return $b.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),_E(this,Yw.REQUEST_UPDATE_CONSTRAINTS,Array.from(Dy(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),_E(this,Yw.REQUEST_UPDATE_CONSTRAINTS,Array.from(Dy(e=this.constraintsMap).call(e)))}registerStats(t,e,i){this.statsRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:i})}unregisterStats(t,e){const i=this.statsRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:i,type:n,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:e,processorName:i,type:n,stats:o})}catch(t){$b.error(new V_(U_.UNEXPECTED_ERROR,t.message))}return t}registerUsage(t,e){this.usageRegistry.find((e=>e.processorID===t.ID&&e.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex((e=>e.processorID===t.ID&&e.processorName===t.name));-1!==e&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let i=e();i instanceof e_&&(i=await i),t.push(BR(BR({},i),{},{direction:this.direction}))}catch(t){$b.error("gather extension usage error",t)}return t}getDirection(){return this.direction}}class $R extends iE{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),nu(this,"context",void 0),nu(this,"processSourceNode",void 0),nu(this,"outputTrack",void 0),nu(this,"processedNode",void 0),nu(this,"clonedTrack",void 0),nu(this,"outputNode",void 0),this.outputNode=new zR}setVolume(){}createOutputTrack(){throw new V_(U_.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class zR{disconnect(){}connect(){}}let qR=null;class KR{constructor(){nu(this,"state","open"),nu(this,"trigger",void 0),nu(this,"tasks",[]),$b.debug("[macro-task-queue] is created."),this.trigger=window.setTimeout((()=>{this.state="closed",$b.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map((t=>t.key)),"]")),this.trigger=void 0,this.tasks.forEach((t=>{let{func:e}=t;return e()})),this.tasks.length=0,$b.debug("[macro-task-queue] is closed.")}))}enqueue(t,e){"closed"!==this.state&&(this.tasks.push({key:t,func:e}),$b.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof t?t:"")))}runTask(t){if("closed"===this.state)return;const e=this.tasks.findIndex((e=>e.key===t));if(-1!==e){const i=this.tasks.splice(e,1);$b.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof t?t:"")),i[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,$b.debug("[macro-task-queue] is closed."))}}function YR(t){return function(e,i,n){var s;const o=null!==(s=n.value)&&void 0!==s?s:n.get,r=function(){qR&&"open"===qR.state&&qR.runTask(t);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return null==o?void 0:o.apply(this,...i)};return n.value?n.value=r:n.get=r,n}}function JR(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function XR(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?JR(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):JR(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class ZR extends iR{get _source(){return this._trackSource}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get processorDestination(){return this._processorDestination}set processorDestination(t){this._processorDestination=t}get isPlaying(){return this._useAudioElement?UR.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,i,n,s){super(t,i),nu(this,"trackMediaType","audio"),nu(this,"_encoderConfig",void 0),nu(this,"_trackSource",void 0),nu(this,"_enabled",!0),nu(this,"_volume",100),nu(this,"_useAudioElement",!1),nu(this,"_bypassWebAudio",!1),nu(this,"processor",void 0),nu(this,"_processorContext",void 0),nu(this,"_processorDestination",void 0),nu(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!n;const o=()=>{this.processorContext=new WR(this._source.context,this.getTrackId(),"local"),this.processorDestination=new GR(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(jw.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))},r=s&&S_()&&!dR();Db("DISABLE_WEBAUDIO")?(this._source=new $R,this._useAudioElement=!0,this._bypassWebAudio=!0):r?this._source=new $R:(this._source=new vR(t,!1,this._getOriginVolumeLevel?t:void 0),Db("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),o(),!Db("DISABLE_WEBAUDIO")&&r&&(qR||(qR=new KR),qR).enqueue("INIT_WEBAUDIO",(()=>{this._source=new vR(t,!1,this._getOriginVolumeLevel?t:void 0),Db("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),o(),this.emit(Hw.UPDATE_TRACK_SOURCE)}))}setVolume(t){j_(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&UR.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void $b.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,_E(this,Pw.NEED_REPLACE_TRACK,this).then((()=>{$b.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((t=>{$b.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),t)})))}catch(t){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement)throw new V_(U_.NOT_SUPPORTED,"your browser does not support setting the audio output device");await UR.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,i){return this._setEnabled(t,e,i)}async _setEnabled(t,e,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if($b.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await _E(this,Pw.NEED_ENABLE_TRACK,this),$b.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(t){throw i||(this._enabled=!1),$b.error("[".concat(this.getTrackId(),"] setEnabled to true error"),t.toString()),t}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await _E(this,Pw.NEED_DISABLE_TRACK,this)}catch(t){throw i||(this._enabled=!0),$b.error("[".concat(this.getTrackId(),"] setEnabled to false error"),t.toString()),t}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,$b.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await _E(this,Pw.NEED_MUTE_TRACK,this):await _E(this,Pw.NEED_UNMUTE_TRACK,this))}getStats(){return NE((()=>{$b.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),EE(this,Pw.GET_STATS)||XR({},Gw)}setAudioFrameCallback(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!t)return this._source.removeAllListeners(jw.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(jw.ON_AUDIO_BUFFER),this._source.on(jw.ON_AUDIO_BUFFER,(e=>t(e)))}play(){$b.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?($b.debug("[".concat(this.getTrackId(),"] start audio playback in element")),UR.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){$b.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?UR.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];$b.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&UR.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:t,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _E(this,Pw.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return e_.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new V_(U_.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new V_(U_.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;null===(t=this._source.processSourceNode)||void 0===t||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Kw.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await _E(this,Pw.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _E(this,Pw.NEED_REPLACE_TRACK,this))})),this.processorDestination.on(Kw.ON_NODE,(t=>{this._source.processedNode=t}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Kw.ON_TRACK),this.processorDestination.removeAllListeners(Kw.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Yw.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Yw.REQUEST_CONSTRAINTS)}}My([YR("INIT_WEBAUDIO"),xy("design:type",Object),xy("design:paramtypes",[Object])],ZR.prototype,"_source",null),My([YR("INIT_WEBAUDIO"),xy("design:type",WR),xy("design:paramtypes",[WR])],ZR.prototype,"processorContext",null),My([YR("INIT_WEBAUDIO"),xy("design:type",GR),xy("design:paramtypes",[GR])],ZR.prototype,"processorDestination",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),xy("design:type",Function),xy("design:paramtypes",[Number]),xy("design:returntype",void 0)],ZR.prototype,"setVolume",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],ZR.prototype,"setPlaybackDevice",null),My([qE("LocalAudioTrack","_enabledMutex"),ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Boolean,Object,Boolean]),xy("design:returntype",e_)],ZR.prototype,"setEnabled",null),My([qE("LocalAudioTrack","_enabledMutex"),ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Boolean]),xy("design:returntype",e_)],ZR.prototype,"setMuted",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",Object)],ZR.prototype,"getStats",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[Object,Number]),xy("design:returntype",void 0)],ZR.prototype,"setAudioFrameCallback",null),My([ny({argsMap:t=>[t.getTrackId()]}),VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],ZR.prototype,"play",null),My([ny({argsMap:t=>[t.getTrackId()]}),VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],ZR.prototype,"stop",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],ZR.prototype,"close",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e.name]}),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",Object)],ZR.prototype,"pipe",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],ZR.prototype,"unpipe",null);class QR extends ZR{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,i,n){super(t,e.encoderConfig?Nw(e.encoderConfig):{},n,Db("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),nu(this,"_config",void 0),nu(this,"_deviceName","default"),nu(this,"_constraints",void 0),nu(this,"_originalConstraints",void 0),nu(this,"_enabled",!0),this._config=e,this._constraints=i,this._originalConstraints=i,this._deviceName=t.label,"boolean"==typeof e.bypassWebAudio&&(this._bypassWebAudio=e.bypassWebAudio),(A_()||O_())&&rR.bindInterruptDetectorTrack(this),this.on(Hw.UPDATE_TRACK_SOURCE,(()=>{this.bindProcessorContextEvents()})),dR()&&this.bindProcessorContextEvents()}async setDevice(t){if($b.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await OR.getDeviceById(t),i={};i.audio=XR({},this._constraints),i.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let n=null;try{n=await wR(i,this.getTrackId())}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setDevice failed"),t.toString()),n=await wR({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),t}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const e=await OR.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}$b.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,i){if(e)return $b.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if($b.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(n=this._source.clonedTrack)||void 0===n||n.stop(),i||(this._enabled=!1);try{await _E(this,Pw.NEED_DISABLE_TRACK,this)}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setEnabled false failed"),t.toString()),t}return}const s=XR({},this._constraints),o=OR.searchDeviceIdByName(this._deviceName);o&&!s.deviceId&&(s.deviceId=o);try{i||(this._enabled=!0);const t=await wR({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(t.getAudioTracks()[0],!1),await _E(this,Pw.NEED_ENABLE_TRACK,this)}catch(t){throw i||(this._enabled=!1),$b.error("[".concat(this.getTrackId(),"] setEnabled true failed"),t.toString()),t}$b.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(A_()||O_())&&rR.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((b_()||k_())&&this._enabled&&!this._isClosed&&rR.duringInterruption){const t=async()=>{rR.off(uw.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&($b.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};rR.on(uw.IOS_INTERRUPTION_END,t)}else $b.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Fw.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=OR.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId=i),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const t=await wR({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(t.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(Yw.REQUEST_UPDATE_CONSTRAINTS,(async(t,e,i)=>{try{const i=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(i),e()}catch(t){i(t)}})),this.processorContext.on(Yw.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}}My([ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],QR.prototype,"setDevice",null),My([qE("MicrophoneAudioTrack","_enabledMutex"),ny({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Boolean,Boolean,Boolean]),xy("design:returntype",e_)],QR.prototype,"setEnabled",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],QR.prototype,"close",null);class tI extends ZR{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,i,n){super(e.createOutputTrack(),i,n),nu(this,"source",void 0),nu(this,"_bufferSource",void 0),this.source=t,this._bufferSource=e,this._bufferSource.on(jw.AUDIO_SOURCE_STATE_CHANGE,(t=>{this.safeEmit(Fw.SOURCE_STATE_CHANGE,t)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(t){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){j_(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}My([ny({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",void 0)],tI.prototype,"startProcessAudioBuffer",null),My([ny({argsMap:t=>[t.getTrackId()]}),VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],tI.prototype,"pauseProcessAudioBuffer",null),My([ny({argsMap:t=>[t.getTrackId()]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Number]),xy("design:returntype",void 0)],tI.prototype,"seekAudioBuffer",null),My([ny({argsMap:t=>[t.getTrackId()]}),VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],tI.prototype,"resumeProcessAudioBuffer",null),My([ny({argsMap:t=>[t.getTrackId()]}),VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],tI.prototype,"stopProcessAudioBuffer",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],tI.prototype,"close",null),My([ny({argsMap:t=>[t.getTrackId()]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Number]),xy("design:returntype",void 0)],tI.prototype,"setAudioBufferPlaybackSpeed",null);class eI extends ZR{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=cR().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,UE(8,"track-mix-")),nu(this,"trackList",void 0),nu(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(t){}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return-1!==this.trackList.indexOf(t)}addAudioTrack(t){-1===this.trackList.indexOf(t)?($b.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):$b.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(-1!==this.trackList.indexOf(t)){$b.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch(t){}CE(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach((e=>{e._encoderConfig&&((e._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=e._encoderConfig.bitrate),(e._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=e._encoderConfig.sampleRate),(e._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=e._encoderConfig.sampleSize),e._encoderConfig.stereo&&(t.stereo=!0))})),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach((e=>{e instanceof eI?e.emit(Vw.TRANSCEIVER_UPDATED,t):e._updateRtpTransceiver(t)})))}}function iI(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const i=Rw(t.encoderConfig);return null!=i.width&&(e.width=i.width),null!=i.height&&(e.height=i.height),!P_()&&i.frameRate&&(e.frameRate=i.frameRate),p_().name===c_.EDGE&&"object"==typeof e.frameRate&&(e.frameRate.max=60),T_()&&(e.frameRate={ideal:30,max:30}),e}function nI(t){const e={};if(P_()||(void 0!==t.AGC&&(e.autoGainControl=t.AGC),void 0!==t.AEC&&(e.echoCancellation=t.AEC),void 0!==t.ANS&&(e.noiseSuppression=t.ANS,E_()&&t.ANS&&(e.googHighpassFilter=t.ANS))),t.encoderConfig){const i=Nw(t.encoderConfig);e.channelCount=i.stereo?2:1,e.sampleRate=i.sampleRate,e.sampleSize=i.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),M_()&&(e.sampleRate=void 0),e}class sI extends fR{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(jw.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),nu(this,"audioBuffer",void 0),nu(this,"sourceNode",void 0),nu(this,"startPlayTime",0),nu(this,"startPlayOffset",0),nu(this,"pausePlayTime",0),nu(this,"options",void 0),nu(this,"currentLoopCount",0),nu(this,"currentPlaybackSpeed",100),nu(this,"_currentState","stopped"),this.audioBuffer=t,this.options=e,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){"stopped"===this.currentState?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):$b.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=t,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch(t){}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&("playing"===this.currentState&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const oI=new Map;async function rI(t,e){let i=null;if("string"==typeof t){const e=oI.get(t);if(e)return $b.debug("use cached audio resource: ",t),e;try{i=(await JE((()=>gb.get(t,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(t){throw new V_(U_.FETCH_AUDIO_FILE_FAILED,t.toString())}}else{const e=new e_(((e,i)=>{const n=new FileReader;n.onload=t=>{t.target?e(t.target.result):i(new V_(U_.READ_LOCAL_AUDIO_FILE_ERROR))},n.onerror=()=>{i(new V_(U_.READ_LOCAL_AUDIO_FILE_ERROR))},n.readAsArrayBuffer(t)}));i=await e}const n=await function(t){const e=cR();return new e_(((i,n)=>{e.decodeAudioData(t,(t=>{i(t)}),(t=>{n(new V_(U_.DECODE_AUDIO_FILE_FAILED,t.toString()))}))}))}(i);return"string"==typeof t&&e&&oI.set(t,n),n}const aI=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new e_(((i,n)=>{e.toBlob((async t=>{if(e.remove(),t){const n=await cI(t);i({buffer:n,width:e.width,height:e.height})}else n(new V_(U_.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,1)}))},cI=async t=>{const e=await t.arrayBuffer();return new Uint8Array(e)},dI=new class extends iE{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),nu(this,"_lastHiddenTime",0),nu(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),$b.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}};function lI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function hI(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?lI(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):lI(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class uI{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(t){t!==this._videoElementStatus&&($b.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}constructor(t){nu(this,"trackId",void 0),nu(this,"config",void 0),nu(this,"onFirstVideoFrameDecoded",void 0),nu(this,"freezeTimeCounterList",[]),nu(this,"renderFreezeAccTime",0),nu(this,"isKeepLastFrame",!1),nu(this,"timeUpdatedCount",0),nu(this,"freezeTime",0),nu(this,"playbackTime",0),nu(this,"lastTimeUpdatedTime",0),nu(this,"autoplayFailed",!1),nu(this,"videoTrack",void 0),nu(this,"videoElement",void 0),nu(this,"cacheVideoElement",void 0),nu(this,"videoElementCheckInterval",void 0),nu(this,"_videoElementStatus",Zw.NONE),nu(this,"isGettingVideoDimensions",!1),nu(this,"startGetVideoDimensions",(()=>{const t=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return $b.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(t,500)};!this.isGettingVideoDimensions&&t()})),nu(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===rR.curState&&($b.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(g_())),N_()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),nu(this,"handleVideoEvents",(t=>{switch(t.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Zw.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch(t){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Zw.CANPLAY;break;case"stalled":this.videoElementStatus=Zw.STALLED;break;case"suspend":this.videoElementStatus=Zw.SUSPEND;break;case"pause":this.videoElementStatus=Zw.PAUSED,b_()||k_()||S_()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||($b.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Zw.WAITING;break;case"abort":this.videoElementStatus=Zw.ABORT;break;case"ended":this.videoElementStatus=Zw.ENDED;break;case"emptied":this.videoElementStatus=Zw.EMPTIED;break;case"error":{this.videoElementStatus=Zw.ERROR;const t=this.videoElement.error;t&&$b.error("[".concat(this.trackId,"] media error, code: ").concat(t.code,", message: ").concat(t.message));break}case"timeupdate":{const t=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=t);const e=t-this.lastTimeUpdatedTime,i=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=t,dI.lastVisibleTime<dI.lastHiddenTime||i<dI.lastHiddenTime||i<dI.lastVisibleTime)return;for(e>Db("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=e),this.playbackTime+=e;this.playbackTime>=6e3;){this.playbackTime-=6e3;const t=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(t),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),nu(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&($b.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(g_())),N_()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),rR.on(uw.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),rR.on(uw.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return null!==(t=this.videoElement.parentElement)&&void 0!==t?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const e=this.videoElement.play();e&&e.catch&&e.catch((e=>{t&&MR(t,"video",e.message,this.trackId),"NotAllowedError"===e.name?($b.warning("detected video element autoplay failed",e),this.autoplayFailed=!0,this.handleAutoPlayFailed()):$b.warning("[".concat(this.trackId,"] play warning: "),e)}));const i=p_();if(("Safari"===i.name&&15===Number(i.version)||A_())&&e&&e.then){const t=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};e.then(t).catch(t)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const e=t.getContext("2d");if(!e)return $b.error("create canvas context failed!"),new ImageData(2,2);e.drawImage(this.videoElement,0,0,t.width,t.height);const i=e.getImageData(0,0,t.width,t.height);return t.remove(),i}async getCurrentFrameToUint8Array(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const n=i.getContext("2d");return n?(n.drawImage(this.videoElement,0,0,i.width,i.height),new e_(((n,s)=>{i.toBlob((async t=>{if(i.remove(),t){const e=await cI(t);n({buffer:e,width:i.width,height:i.height})}else s(new V_(U_.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,e<0?.1:e>1?1:e)}))):await aI(t)}destroy(){rR.off(uw.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),rR.off(uw.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=Zw.INIT,!this.videoElementCheckInterval&&(pI.forEach((t=>{this.videoElement.addEventListener(t,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{(function(t){return t!==document.body&&document.body.contains(t)})(this.videoElement)||(this.videoElementStatus=Zw.DESTROYED)}),1e3),Db("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,e;let i;const n=(t,e)=>{if(this.videoElementStatus===Zw.PLAYING){if(i){const t=e.presentationTime-i.presentationTime;t>Db("VIDEO_FREEZE_DURATION")&&dI.lastVisibleTime>=dI.lastHiddenTime&&i.timestamp>dI.lastVisibleTime&&i.timestamp>dI.lastHiddenTime&&(this.renderFreezeAccTime+=t)}i=hI(hI({},e),{},{timestamp:t})}var s,o;Db("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(s=(o=this.videoElement).requestVideoFrameCallback)||void 0===s||s.call(o,n))};null===(t=(e=this.videoElement).requestVideoFrameCallback)||void 0===t||t.call(e,n)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),M_()&&(this.videoElement.poster="noposter");const i=p_();"Safari"===i.name&&15===Number(i.version)||A_()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,T_()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,T_()&&this.videoElement.load());const n=this.videoElement.play();void 0!==n&&n.catch((t=>{$b.debug("[".concat(this.trackId,"] playback interrupted"),t.toString())}))}resetVideoElement(){pI.forEach((t=>{this.videoElement&&this.videoElement.removeEventListener(t,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Zw.NONE}handleAutoPlayFailed(){const t=e=>{e.preventDefault(),this.videoElement.play().then((()=>{$b.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((t=>{$b.error(t)})),this.autoplayFailed=!1,x_()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};x_()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),LR()}}const pI=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class mI extends uI{constructor(t){super(t),nu(this,"container",void 0),nu(this,"slot",void 0),this.slot=t.element,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const e=t.element;e!==this.slot&&(this.destroy(),this.slot=e),this.createElements()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var e;null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var e;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,i):await aI(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch(t){}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",Db("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var t;!this.container||null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if(null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(t){}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function gI(t){return new e_(((e,i)=>{let n=!1;const s=document.createElement("video");s.setAttribute("autoplay",""),s.setAttribute("muted",""),s.muted=!0,s.autoplay=!0,s.setAttribute("playsinline",""),s.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(s);const o=b_()?"canplay":"playing";s.addEventListener(o,(()=>{const t=s.videoWidth,i=s.videoHeight;!t&&T_()||(n=!0,s.srcObject=null,s.remove(),e([t,i]))})),s.srcObject=new MediaStream([t]),s.play().catch(FE),setTimeout((()=>{n||(s.srcObject=null,s.remove(),e([s.videoWidth,s.videoHeight]))}),4e3)}))}const fI=async(t,e,i)=>{const n=function(t){const e=[];for(let i=0;i<t.length;i+=2)e.push(parseInt(t.slice(i,i+2),16));return Uint8Array.from(e)}(function(t){const e="0123456789abcdef";function i(t){let i,n="";for(i=0;i<=3;i++)n+=e.charAt(t>>8*i+4&15)+e.charAt(t>>8*i&15);return n}function n(t,e){const i=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(i>>16)<<16|65535&i}function s(t,e,i,s,o,r){return n(function(t,e){return t<<e|t>>>32-e}(n(n(e,t),n(s,r)),o),i)}function o(t,e,i,n,o,r,a){return s(e&i|~e&n,t,e,o,r,a)}function r(t,e,i,n,o,r,a){return s(e&n|i&~n,t,e,o,r,a)}function a(t,e,i,n,o,r,a){return s(e^i^n,t,e,o,r,a)}function c(t,e,i,n,o,r,a){return s(i^(e|~n),t,e,o,r,a)}const d=function(t){let e;const i=1+(t.length+8>>6),n=new Array(16*i);for(e=0;e<16*i;e++)n[e]=0;for(e=0;e<t.length;e++)n[e>>2]|=t.charCodeAt(e)<<e%4*8;return n[e>>2]|=128<<e%4*8,n[16*i-2]=8*t.length,n}(t);let l,h,u,p,m,g=1732584193,f=-271733879,v=-1732584194,_=271733878;for(l=0;l<d.length;l+=16)h=g,u=f,p=v,m=_,g=o(g,f,v,_,d[l+0],7,-680876936),_=o(_,g,f,v,d[l+1],12,-389564586),v=o(v,_,g,f,d[l+2],17,606105819),f=o(f,v,_,g,d[l+3],22,-1044525330),g=o(g,f,v,_,d[l+4],7,-176418897),_=o(_,g,f,v,d[l+5],12,1200080426),v=o(v,_,g,f,d[l+6],17,-1473231341),f=o(f,v,_,g,d[l+7],22,-45705983),g=o(g,f,v,_,d[l+8],7,1770035416),_=o(_,g,f,v,d[l+9],12,-1958414417),v=o(v,_,g,f,d[l+10],17,-42063),f=o(f,v,_,g,d[l+11],22,-1990404162),g=o(g,f,v,_,d[l+12],7,1804603682),_=o(_,g,f,v,d[l+13],12,-40341101),v=o(v,_,g,f,d[l+14],17,-1502002290),f=o(f,v,_,g,d[l+15],22,1236535329),g=r(g,f,v,_,d[l+1],5,-165796510),_=r(_,g,f,v,d[l+6],9,-1069501632),v=r(v,_,g,f,d[l+11],14,643717713),f=r(f,v,_,g,d[l+0],20,-373897302),g=r(g,f,v,_,d[l+5],5,-701558691),_=r(_,g,f,v,d[l+10],9,38016083),v=r(v,_,g,f,d[l+15],14,-660478335),f=r(f,v,_,g,d[l+4],20,-405537848),g=r(g,f,v,_,d[l+9],5,568446438),_=r(_,g,f,v,d[l+14],9,-1019803690),v=r(v,_,g,f,d[l+3],14,-187363961),f=r(f,v,_,g,d[l+8],20,1163531501),g=r(g,f,v,_,d[l+13],5,-1444681467),_=r(_,g,f,v,d[l+2],9,-51403784),v=r(v,_,g,f,d[l+7],14,1735328473),f=r(f,v,_,g,d[l+12],20,-1926607734),g=a(g,f,v,_,d[l+5],4,-378558),_=a(_,g,f,v,d[l+8],11,-2022574463),v=a(v,_,g,f,d[l+11],16,1839030562),f=a(f,v,_,g,d[l+14],23,-35309556),g=a(g,f,v,_,d[l+1],4,-1530992060),_=a(_,g,f,v,d[l+4],11,1272893353),v=a(v,_,g,f,d[l+7],16,-155497632),f=a(f,v,_,g,d[l+10],23,-1094730640),g=a(g,f,v,_,d[l+13],4,681279174),_=a(_,g,f,v,d[l+0],11,-358537222),v=a(v,_,g,f,d[l+3],16,-722521979),f=a(f,v,_,g,d[l+6],23,76029189),g=a(g,f,v,_,d[l+9],4,-640364487),_=a(_,g,f,v,d[l+12],11,-421815835),v=a(v,_,g,f,d[l+15],16,530742520),f=a(f,v,_,g,d[l+2],23,-995338651),g=c(g,f,v,_,d[l+0],6,-198630844),_=c(_,g,f,v,d[l+7],10,1126891415),v=c(v,_,g,f,d[l+14],15,-1416354905),f=c(f,v,_,g,d[l+5],21,-57434055),g=c(g,f,v,_,d[l+12],6,1700485571),_=c(_,g,f,v,d[l+3],10,-1894986606),v=c(v,_,g,f,d[l+10],15,-1051523),f=c(f,v,_,g,d[l+1],21,-2054922799),g=c(g,f,v,_,d[l+8],6,1873313359),_=c(_,g,f,v,d[l+15],10,-30611744),v=c(v,_,g,f,d[l+6],15,-1560198380),f=c(f,v,_,g,d[l+13],21,1309151649),g=c(g,f,v,_,d[l+4],6,-145523070),_=c(_,g,f,v,d[l+11],10,-1120210379),v=c(v,_,g,f,d[l+2],15,718787259),f=c(f,v,_,g,d[l+9],21,-343485551),g=n(g,h),f=n(f,u),v=n(v,p),_=n(_,m);return i(g)+i(f)+i(v)+i(_)}(""+e+i)).slice(0,16),s=n.slice(0,12),o=await window.crypto.subtle.importKey("raw",n,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},o,t))},vI=async(t,e,i)=>await fI(t.buffer,e,i);function _I(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function EI(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?_I(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):_I(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class SI extends iR{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Zw.PLAYING)}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,e,i,n,s,o){if(super(t,s),nu(this,"trackMediaType","video"),nu(this,"_player",void 0),nu(this,"isUseScaleResolutionDownBy",!1),nu(this,"_videoVisibleTimer",null),nu(this,"_statsTimer",null),nu(this,"_previousVideoVisibleStatus",void 0),nu(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),nu(this,"_encoderConfig",void 0),nu(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),nu(this,"_optimizationMode",void 0),nu(this,"_videoHeight",void 0),nu(this,"_videoWidth",void 0),nu(this,"_forceBitrateLimit",void 0),nu(this,"_enabled",!0),nu(this,"processorDestination",void 0),nu(this,"_processorContext",void 0),S_()){const{width:e,height:i}=t.getSettings();this._videoWidth=e,this._videoHeight=i}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=e,this._scalabilityMode=i,this._optimizationMode=n,this._hints=o||[],-1===this._hints.indexOf(Dw.SCREEN_TRACK))this.updateBitrateFromProfile();else if(function(t,e,i){const n=p_();return!(n.name!==t||!n.osVersion)&&(i?Number(n.version)>=e&&Number(n.version)<=i:Number(n.version)===e)}(c_.CHROME,115)&&-1!==m_().indexOf("Windows")){const e=function(t,e){if("VideoFrame"in window&&"TransformStream"in window&&mR().supportWebRTCInsertableStream){const i=new MediaStreamTrackProcessor(t),n=new MediaStreamTrackGenerator({kind:"video"});let s,o,r=Date.now();const a=()=>{c&&(clearInterval(c),c=void 0),s&&(s.close(),s=void 0),t.stop(),o=void 0,n.removeEventListener("ended",a)};let c=window.setInterval((()=>{if(o&&s&&Date.now()-r>(null!=e?e:1e3))try{"live"===n.readyState?o.enqueue(s.clone()):a()}catch(t){a()}}),null!=e?e:1e3);const d=new TransformStream({transform:(t,e)=>{"live"===n.readyState?(o=e,r=Date.now(),void 0===s?(s=t,e.enqueue(t.clone())):(e.enqueue(s),s=t)):t.close()}});return n.addEventListener("ended",a),i.readable.pipeThrough(d).pipeTo(n.writable),n}}(t);e&&($b.info("local screen video track begin to inject frame"),this._mediaStreamTrack=e)}e&&-1!==this._hints.indexOf(Dw.CUSTOM_TRACK)&&this.setEncoderConfiguration(e),this.processorContext=new HR(this.getTrackId(),"local"),this.processorDestination=new jR(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t){const e=document.getElementById(t);e?t=e:($b.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}$b.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=EI(EI(EI({},this._getDefaultPlayerConfig()),e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new uI(i):this._player=new mI(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const t=this.getVideoElementVisibleStatus();this.safeEmit(Fw.VIDEO_ELEMENT_VISIBLE_STATUS,t)}catch(t){}}),Db("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,$b.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if($b.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await _E(this,Pw.NEED_DISABLE_TRACK,this)}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setEnabled to false error"),t.toString()),t}return e||(this._enabled=!1),void $b.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await _E(this,Pw.NEED_ENABLE_TRACK,this)}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setEnabled to true error"),t.toString()),t}$b.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,$b.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await _E(this,Pw.NEED_MUTE_TRACK,this):await _E(this,Pw.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(t,e){if(!this._enabled)throw new V_(U_.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if("720p_auto"===t?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=Rw(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const e=iI({encoderConfig:t});(S_()||b_()||k_())&&(e.deviceId=void 0),$b.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(e));try{await this._originMediaStreamTrack.applyConstraints(e),this.updateMediaStreamTrackResolution()}catch(t){const e=new V_(U_.UNEXPECTED_ERROR,t.toString());throw $b.error("[".concat(this.getTrackId(),"] applyConstraints error"),e.toString()),e}}this._encoderConfig=t,-1===this._hints.indexOf(Dw.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await _E(this,Pw.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw($b)}}getStats(){return NE((()=>{$b.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),EE(this,Pw.GET_STATS)||EI({},Ww)}async setBeautyEffect(t){$b.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,e):await aI(t)}async setBitrateLimit(t){if($b.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t){this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate);try{await _E(this,Pw.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw($b)}}}async setOptimizationMode(t){if("motion"!==t&&"detail"!==t&&"balanced"!==t)return void $b.error(U_.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const e=this._optimizationMode;try{this._optimizationMode=t,await _E(this,Pw.SET_OPTIMIZATION_MODE,this)}catch(t){throw this._optimizationMode=e,$b.error("[".concat(this.getTrackId(),"] set optimization mode failed"),t.toString()),t}$b.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(1===t.numSpatialLayers&&1!==t.numTemporalLayers)return $b.error(U_.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,$b.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){gI(this._originMediaStreamTrack).then((t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e})).catch(FE)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new V_(U_.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");$b.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=Rw(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,-1===this._hints.indexOf(Dw.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await _E(this,Pw.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw($b)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:e,frameRate:i}=this.getMediaStreamTrackSettings();if(!t||!e||!i)return;const[n,s]=function(t,e,i,n){let s;const o=200*Math.pow(i/15,.6)*Math.pow(t*e/640/360,.75),r=o;if("STANDARD_BITRATE"===n)s=4*o;else{if("COMPATIABLE_BITRATE"!==n)return;s=2*o}return[Math.floor(s),Math.floor(r)]}(t,e,i,Db("BITRATE_ADAPTER_TYPE"))||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=s,this._encoderConfig.bitrateMax=n,$b.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(e,", fps: ").concat(i,"] => [brMax: ").concat(n,", brMin: ").concat(s,"]")))}getVideoElementVisibleStatus(){try{var t,e;const i=null==this||null===(t=this._player)||void 0===t?void 0:t.getContainerElement(),n={track:this,element:null==this||null===(e=this._player)||void 0===e?void 0:e.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:s,slot:o}=n;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const t=X_.checkOneElementVisible(s),e=Object.assign({},t);if(e.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=e.visible;const t=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});e.visible?t.onSuccess("Video is visible"):t.onSuccess("Invisible because of ".concat(e.reason))}return e}return}catch(t){throw new V_(U_.GET_VIDEO_ELEMENT_VISIBLE_ERROR,t.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new V_(U_.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._encoderConfig;t&&(i=EI(EI({},i),Rw(t))),i=AE(i);const n=UE(8,"track-video-cloned-"),s=new SI(e?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,AE(this._scalabilityMode),this._optimizationMode,n,AE(this._hints));return t&&i&&s.setEncoderConfiguration(i),$b.debug("clone video track from ".concat(this.getTrackId()," to ").concat(n,", clone ").concat(e)),s}async replaceTrack(t,e){if(!(t instanceof MediaStreamTrack))throw new V_(U_.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==t.kind)throw new V_(U_.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,e,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!S_()&&!b_())return;this._statsTimer&&window.clearInterval(this._statsTimer);let t=2,e=yw[t],i=-1,n=Date.now();const s=t=>{t>2||t<0||(n=Date.now(),e=yw[t],this.setSenderConfiguration(e))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval((()=>{const o=this.getStats(),r=EE(this,Pw.GET_RTC_STATS);if(o.sendPackets>0&&r){-1===i&&(i=Date.now());const a=Date.now();if(a-i<1e3||a-n<Db("PROFILE_SWITCH_INTERVAL"))return;const c=o.sendFrameRate,d=.6*e.frameRate,l=.9*e.frameRate;"number"==typeof c&&c>0&&c<d?t>0&&(t--,s(t),$b.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(c,", switchProfile to ").concat(t))):r.OutgoingAvailableBandwidth<e.bitrateMin?t>0&&(t--,s(t),$b.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(r.OutgoingAvailableBandwidth,", bitrateMin ").concat(e.bitrateMin,", switchProfile to ").concat(t))):"number"==typeof c&&c>l&&t<yw.length-1&&r.OutgoingAvailableBandwidth>1.2*yw[t+1].bitrateMin&&(t++,s(t),$b.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(c,", OutgoingAvailableBandwidth ").concat(r.OutgoingAvailableBandwidth,", switchProfile to ").concat(t)))}}),Db("CHECK_LOCAL_STATS_INTERVAL"))}bindProcessorDestinationEvents(){this.processorDestination.on(Kw.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await _E(this,Pw.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _E(this,Pw.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Kw.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Yw.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Yw.REQUEST_CONSTRAINTS)}}My([ny({argsMap:(t,e,i)=>[t.getTrackId(),"string"==typeof e?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Object,Object]),xy("design:returntype",void 0)],SI.prototype,"play",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],SI.prototype,"stop",null),My([qE("LocalVideoTrack","_enabledMutex"),ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Boolean,Boolean]),xy("design:returntype",e_)],SI.prototype,"setEnabled",null),My([qE("LocalVideoTrack","_enabledMutex"),ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Boolean]),xy("design:returntype",e_)],SI.prototype,"setMuted",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Object,Boolean]),xy("design:returntype",e_)],SI.prototype,"setEncoderConfiguration",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",Object)],SI.prototype,"getStats",null),My([ny({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Boolean,Object]),xy("design:returntype",e_)],SI.prototype,"setBeautyEffect",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",ImageData)],SI.prototype,"getCurrentFrameData",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[String,Number]),xy("design:returntype",e_)],SI.prototype,"getCurrentFrameImage",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],SI.prototype,"setBitrateLimit",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],SI.prototype,"setOptimizationMode",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",void 0)],SI.prototype,"setScalabiltyMode",null),My([VR(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],SI.prototype,"updateMediaStreamTrackResolution",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e.name]}),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",Object)],SI.prototype,"pipe",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],SI.prototype,"unpipe",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],SI.prototype,"close",null),My([ny({argsMap:(t,e,i)=>[t.getTrackId(),e.label,i]}),xy("design:type",Function),xy("design:paramtypes",[MediaStreamTrack,Boolean]),xy("design:returntype",e_)],SI.prototype,"replaceTrack",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],SI.prototype,"startMonitorStats",null);class TI extends SI{get __className__(){return"CameraVideoTrack"}constructor(t,e,i,n,s,o){super(t,Rw(e.encoderConfig),n,s,o),nu(this,"_config",void 0),nu(this,"_originalConstraints",void 0),nu(this,"_constraints",void 0),nu(this,"_enabled",!0),nu(this,"_deviceName","default"),nu(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(A_()||O_())&&!function(){const t=p_();if(t.os!==a_.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])&&Number(e[1])>=2}()&&L_()&&this._enabled&&!this._isClosed&&($b.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=e,this._originalConstraints=i,this._constraints=i,this._deviceName=t.label,this._encoderConfig=Rw(this._config.encoderConfig),rR.on(uw.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),rR.on(uw.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return"string"==typeof t?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if($b.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const e=await OR.getDeviceById(t),i={};i.video=EI({},this._constraints),i.video.deviceId={exact:t},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let n=null;try{n=await wR(i,this.getTrackId())}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setDevice failed"),t.toString()),n=await wR({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),t}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const e=await OR.getDeviceById(t);this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}$b.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){$b.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const e={video:EI(EI({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let t=null;try{t=await wR(e,this.getTrackId())}catch(e){throw $b.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),e.toString()),t=await wR({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(t.getVideoTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(t.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=EI({},e.video),$b.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if($b.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const t=await wR({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(t.getVideoTracks()[0],!1)}await _E(this,Pw.NEED_ENABLE_TRACK,this)}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setEnabled true error"),t.toString()),t}this.updateMediaStreamTrackResolution(),$b.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),e||(this._enabled=!1);try{await _E(this,Pw.NEED_DISABLE_TRACK,this)}catch(t){throw $b.error("[".concat(this.getTrackId(),"] setEnabled to false error"),t.toString()),t}$b.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,e){if(!this._enabled)throw new V_(U_.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");"720p_auto"===t?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=Rw(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin);const i=IE(this._config);i.encoderConfig=t;const n=iI(i);(S_()||b_()||k_())&&(n.deviceId=void 0),$b.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(t){const e=new V_(U_.UNEXPECTED_ERROR,t.toString());throw $b.error("[".concat(this.getTrackId(),"] applyConstraints error"),e.toString()),e}this._config=i,this._constraints=n,this._originalConstraints=n,this._encoderConfig=t,-1===this._hints.indexOf(Dw.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await _E(this,Pw.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw($b)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((b_()||k_())&&this._enabled&&!this._isClosed&&rR.duringInterruption){const t=async()=>{rR.off(uw.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&($b.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};rR.on(uw.IOS_INTERRUPTION_END,t)}else $b.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Fw.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=OR.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId={exact:i}),this._enabled){const t=await wR({video:e},this.getTrackId());this._constraints=e,await this._updateOriginMediaStreamTrack(t.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),rR.off(uw.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),rR.off(uw.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._encoderConfig;t&&(i=EI(EI({},i),Rw(t))),i=AE(i);const n=UE(8,"track-cam-cloned-"),s=new TI(e?this._mediaStreamTrack.clone():this._mediaStreamTrack,AE(EI(EI({},this._config),{},{encoderConfig:i})),AE(this._constraints),AE(this._scalabilityMode),this._optimizationMode,n);return t&&i&&s.setEncoderConfiguration(i),$b.debug("clone track from ".concat(this.getTrackId()," to ").concat(n,", clone ").concat(e)),s}bindProcessorContextEvents(){this.processorContext.on(Yw.REQUEST_UPDATE_CONSTRAINTS,(async(t,e,i)=>{try{const i=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(i),e()}catch(t){i(t)}})),this.processorContext.on(Yw.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}}function bI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function yI(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?bI(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):bI(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function CI(t,e,i,n){i.optimizationMode&&(n&&n.width&&n.height?(i.encoderConfig=yI(yI({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),"motion"!==i.optimizationMode&&"detail"!==i.optimizationMode||(e.contentHint=i.optimizationMode,e.contentHint===i.optimizationMode?$b.debug("[".concat(t,"] set content hint to"),i.optimizationMode):$b.debug("[".concat(t,"] set content hint failed")))):$b.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}function wI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function RI(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?wI(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wI(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}My([ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],TI.prototype,"setDevice",null),My([qE("CameraVideoTrack","_enabledMutex"),ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Boolean,Boolean]),xy("design:returntype",e_)],TI.prototype,"setEnabled",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e]}),VR(),xy("design:type",Function),xy("design:paramtypes",[Object,Boolean]),xy("design:returntype",e_)],TI.prototype,"setEncoderConfiguration",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],TI.prototype,"close",null);class II extends eR{getUserId(){return this._userId}constructor(t,e,i,n){super(t,"track-".concat(t.kind,"-").concat(e,"-").concat(n.clientId,"_").concat(UE(5,""))),nu(this,"_userId",void 0),nu(this,"_uintId",void 0),nu(this,"_isDestroyed",!1),nu(this,"store",void 0),nu(this,"processor",void 0),this._userId=e,this._uintId=i,this.store=n}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,$b.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class AI extends II{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Zw.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,i,n){super(t,e,i,n),nu(this,"_videoVisibleTimer",null),nu(this,"_previousVideoVisibleStatus",void 0),nu(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),nu(this,"trackMediaType","video"),nu(this,"_videoWidth",void 0),nu(this,"_videoHeight",void 0),nu(this,"_player",void 0),nu(this,"processorDestination",void 0),nu(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new HR(this.getTrackId(),"remote"),this.processorDestination=new jR(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return NE((()=>{$b.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),EE(this,Pw.GET_STATS)||RI({},qw)}play(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t){const e=document.getElementById(t);e?t=e:($b.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}$b.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=RI(RI({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new uI(i):this._player=new mI(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Bw.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const t=this.getVideoElementVisibleStatus();this.safeEmit(Bw.VIDEO_ELEMENT_VISIBLE_STATUS,t)}catch(t){}}),Db("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,$b.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){gI(this._originMediaStreamTrack).then((t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e})).catch(FE)}_updatePlayerSource(){$b.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const i=null==this||null===(t=this._player)||void 0===t?void 0:t.getContainerElement(),n={track:this,element:null==this||null===(e=this._player)||void 0===e?void 0:e.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:s,slot:o}=n;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const t=X_.checkOneElementVisible(s),e=Object.assign({},t);if(e.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=e.visible;const t=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});e.visible?t.onSuccess("Video is visible"):t.onSuccess("Invisible because of ".concat(e.reason))}return e}return}catch(t){throw new V_(U_.GET_VIDEO_ELEMENT_VISIBLE_ERROR,t.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new V_(U_.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Kw.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Kw.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}My([ny({argsMap:(t,e,i)=>[t.getTrackId(),"string"==typeof e?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),xy("design:type",Function),xy("design:paramtypes",[Object,Object]),xy("design:returntype",void 0)],AI.prototype,"play",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],AI.prototype,"stop",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e.name]}),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",Object)],AI.prototype,"pipe",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],AI.prototype,"unpipe",null);class OI extends II{get isPlaying(){return this._useAudioElement?UR.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,i,n){super(t,e,i,n),nu(this,"trackMediaType","audio"),nu(this,"_source",void 0),nu(this,"_useAudioElement",!0),nu(this,"_volume",100),nu(this,"processorContext",void 0),nu(this,"processorDestination",void 0),nu(this,"_played",!1),nu(this,"_bypassWebAudio",!1),Db("DISABLE_WEBAUDIO")?(this._source=new $R,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new vR(t,!0),Db("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(jw.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(Bw.FIRST_FRAME_DECODED)})),this.processorContext=new WR(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new GR(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(jw.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!t)return this._source.removeAllListeners(jw.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(jw.ON_AUDIO_BUFFER),this._source.on(jw.ON_AUDIO_BUFFER,(e=>t(e)))}setVolume(t){this._volume=t,this._useAudioElement?UR.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement)throw new V_(U_.NOT_SUPPORTED,"your browser does not support setting the audio output device");await UR.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return NE((()=>{$b.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),EE(this,Pw.GET_STATS)||RI({},$w)}play(){$b.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?($b.debug("[".concat(this.getTrackId(),"] use audio element to play")),UR.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){$b.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?UR.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];$b.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&UR.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new V_(U_.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new V_(U_.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new V_(U_.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;null===(t=this._source.processSourceNode)||void 0===t||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Kw.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(Kw.ON_NODE,(t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Kw.ON_TRACK),this.processorDestination.removeAllListeners(Kw.ON_NODE)}}function NI(t){let e=t.length;for(;--e>=0;)t[e]=0}My([ny({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),xy("design:type",Function),xy("design:paramtypes",[Number]),xy("design:returntype",void 0)],OI.prototype,"setVolume",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e]}),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],OI.prototype,"setPlaybackDevice",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],OI.prototype,"play",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],OI.prototype,"stop",null),My([ny({argsMap:(t,e)=>[t.getTrackId(),e.name]}),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",Object)],OI.prototype,"pipe",null),My([ny({argsMap:t=>[t.getTrackId()]}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],OI.prototype,"unpipe",null);const kI=256,LI=286,PI=30,DI=15,MI=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),xI=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),UI=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),VI=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),FI=new Array(576);NI(FI);const BI=new Array(60);NI(BI);const jI=new Array(512);NI(jI);const HI=new Array(256);NI(HI);const GI=new Array(29);NI(GI);const WI=new Array(PI);function $I(t,e,i,n,s){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=n,this.max_length=s,this.has_stree=t&&t.length}let zI,qI,KI;function YI(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}NI(WI);const JI=t=>t<256?jI[t]:jI[256+(t>>>7)],XI=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},ZI=(t,e,i)=>{t.bi_valid>16-i?(t.bi_buf|=e<<t.bi_valid&65535,XI(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=i-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)},QI=(t,e,i)=>{ZI(t,i[2*e],i[2*e+1])},tA=(t,e)=>{let i=0;do{i|=1&t,t>>>=1,i<<=1}while(--e>0);return i>>>1},eA=(t,e,i)=>{const n=new Array(16);let s,o,r=0;for(s=1;s<=DI;s++)r=r+i[s-1]<<1,n[s]=r;for(o=0;o<=e;o++){let e=t[2*o+1];0!==e&&(t[2*o]=tA(n[e]++,e))}},iA=t=>{let e;for(e=0;e<LI;e++)t.dyn_ltree[2*e]=0;for(e=0;e<PI;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},nA=t=>{t.bi_valid>8?XI(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},sA=(t,e,i,n)=>{const s=2*e,o=2*i;return t[s]<t[o]||t[s]===t[o]&&n[e]<=n[i]},oA=(t,e,i)=>{const n=t.heap[i];let s=i<<1;for(;s<=t.heap_len&&(s<t.heap_len&&sA(e,t.heap[s+1],t.heap[s],t.depth)&&s++,!sA(e,n,t.heap[s],t.depth));)t.heap[i]=t.heap[s],i=s,s<<=1;t.heap[i]=n},rA=(t,e,i)=>{let n,s,o,r,a=0;if(0!==t.sym_next)do{n=255&t.pending_buf[t.sym_buf+a++],n+=(255&t.pending_buf[t.sym_buf+a++])<<8,s=t.pending_buf[t.sym_buf+a++],0===n?QI(t,s,e):(o=HI[s],QI(t,o+kI+1,e),r=MI[o],0!==r&&(s-=GI[o],ZI(t,s,r)),n--,o=JI(n),QI(t,o,i),r=xI[o],0!==r&&(n-=WI[o],ZI(t,n,r)))}while(a<t.sym_next);QI(t,256,e)},aA=(t,e)=>{const i=e.dyn_tree,n=e.stat_desc.static_tree,s=e.stat_desc.has_stree,o=e.stat_desc.elems;let r,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,r=0;r<o;r++)0!==i[2*r]?(t.heap[++t.heap_len]=d=r,t.depth[r]=0):i[2*r+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,i[2*c]=1,t.depth[c]=0,t.opt_len--,s&&(t.static_len-=n[2*c+1]);for(e.max_code=d,r=t.heap_len>>1;r>=1;r--)oA(t,i,r);c=o;do{r=t.heap[1],t.heap[1]=t.heap[t.heap_len--],oA(t,i,1),a=t.heap[1],t.heap[--t.heap_max]=r,t.heap[--t.heap_max]=a,i[2*c]=i[2*r]+i[2*a],t.depth[c]=(t.depth[r]>=t.depth[a]?t.depth[r]:t.depth[a])+1,i[2*r+1]=i[2*a+1]=c,t.heap[1]=c++,oA(t,i,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((t,e)=>{const i=e.dyn_tree,n=e.max_code,s=e.stat_desc.static_tree,o=e.stat_desc.has_stree,r=e.stat_desc.extra_bits,a=e.stat_desc.extra_base,c=e.stat_desc.max_length;let d,l,h,u,p,m,g=0;for(u=0;u<=DI;u++)t.bl_count[u]=0;for(i[2*t.heap[t.heap_max]+1]=0,d=t.heap_max+1;d<573;d++)l=t.heap[d],u=i[2*i[2*l+1]+1]+1,u>c&&(u=c,g++),i[2*l+1]=u,l>n||(t.bl_count[u]++,p=0,l>=a&&(p=r[l-a]),m=i[2*l],t.opt_len+=m*(u+p),o&&(t.static_len+=m*(s[2*l+1]+p)));if(0!==g){do{for(u=c-1;0===t.bl_count[u];)u--;t.bl_count[u]--,t.bl_count[u+1]+=2,t.bl_count[c]--,g-=2}while(g>0);for(u=c;0!==u;u--)for(l=t.bl_count[u];0!==l;)h=t.heap[--d],h>n||(i[2*h+1]!==u&&(t.opt_len+=(u-i[2*h+1])*i[2*h],i[2*h+1]=u),l--)}})(t,e),eA(i,d,t.bl_count)},cA=(t,e,i)=>{let n,s,o=-1,r=e[1],a=0,c=7,d=4;for(0===r&&(c=138,d=3),e[2*(i+1)+1]=65535,n=0;n<=i;n++)s=r,r=e[2*(n+1)+1],++a<c&&s===r||(a<d?t.bl_tree[2*s]+=a:0!==s?(s!==o&&t.bl_tree[2*s]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,o=s,0===r?(c=138,d=3):s===r?(c=6,d=3):(c=7,d=4))},dA=(t,e,i)=>{let n,s,o=-1,r=e[1],a=0,c=7,d=4;for(0===r&&(c=138,d=3),n=0;n<=i;n++)if(s=r,r=e[2*(n+1)+1],!(++a<c&&s===r)){if(a<d)do{QI(t,s,t.bl_tree)}while(0!=--a);else 0!==s?(s!==o&&(QI(t,s,t.bl_tree),a--),QI(t,16,t.bl_tree),ZI(t,a-3,2)):a<=10?(QI(t,17,t.bl_tree),ZI(t,a-3,3)):(QI(t,18,t.bl_tree),ZI(t,a-11,7));a=0,o=s,0===r?(c=138,d=3):s===r?(c=6,d=3):(c=7,d=4)}};let lA=!1;const hA=(t,e,i,n)=>{ZI(t,0+(n?1:0),3),nA(t),XI(t,i),XI(t,~i),i&&t.pending_buf.set(t.window.subarray(e,e+i),t.pending),t.pending+=i};var uA=t=>{lA||((()=>{let t,e,i,n,s;const o=new Array(16);for(i=0,n=0;n<28;n++)for(GI[n]=i,t=0;t<1<<MI[n];t++)HI[i++]=n;for(HI[i-1]=n,s=0,n=0;n<16;n++)for(WI[n]=s,t=0;t<1<<xI[n];t++)jI[s++]=n;for(s>>=7;n<PI;n++)for(WI[n]=s<<7,t=0;t<1<<xI[n]-7;t++)jI[256+s++]=n;for(e=0;e<=DI;e++)o[e]=0;for(t=0;t<=143;)FI[2*t+1]=8,t++,o[8]++;for(;t<=255;)FI[2*t+1]=9,t++,o[9]++;for(;t<=279;)FI[2*t+1]=7,t++,o[7]++;for(;t<=287;)FI[2*t+1]=8,t++,o[8]++;for(eA(FI,287,o),t=0;t<PI;t++)BI[2*t+1]=5,BI[2*t]=tA(t,5);zI=new $I(FI,MI,257,LI,DI),qI=new $I(BI,xI,0,PI,DI),KI=new $I(new Array(0),UI,0,19,7)})(),lA=!0),t.l_desc=new YI(t.dyn_ltree,zI),t.d_desc=new YI(t.dyn_dtree,qI),t.bl_desc=new YI(t.bl_tree,KI),t.bi_buf=0,t.bi_valid=0,iA(t)},pA=(t,e,i,n)=>{let s,o,r=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=(t=>{let e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<kI;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0})(t)),aA(t,t.l_desc),aA(t,t.d_desc),r=(t=>{let e;for(cA(t,t.dyn_ltree,t.l_desc.max_code),cA(t,t.dyn_dtree,t.d_desc.max_code),aA(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*VI[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e})(t),s=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=s&&(s=o)):s=o=i+5,i+4<=s&&-1!==e?hA(t,e,i,n):4===t.strategy||o===s?(ZI(t,2+(n?1:0),3),rA(t,FI,BI)):(ZI(t,4+(n?1:0),3),((t,e,i,n)=>{let s;for(ZI(t,e-257,5),ZI(t,i-1,5),ZI(t,n-4,4),s=0;s<n;s++)ZI(t,t.bl_tree[2*VI[s]+1],3);dA(t,t.dyn_ltree,e-1),dA(t,t.dyn_dtree,i-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,r+1),rA(t,t.dyn_ltree,t.dyn_dtree)),iA(t),n&&nA(t)},mA=(t,e,i)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=i,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(HI[i]+kI+1)]++,t.dyn_dtree[2*JI(e)]++),t.sym_next===t.sym_end),gA={_tr_init:uA,_tr_stored_block:hA,_tr_flush_block:pA,_tr_tally:mA,_tr_align:t=>{ZI(t,2,3),QI(t,256,FI),(t=>{16===t.bi_valid?(XI(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(t)}},fA=(t,e,i,n)=>{let s=65535&t|0,o=t>>>16&65535|0,r=0;for(;0!==i;){r=i>2e3?2e3:i,i-=r;do{s=s+e[n++]|0,o=o+s|0}while(--r);s%=65521,o%=65521}return s|o<<16|0};const vA=new Uint32Array((()=>{let t,e=[];for(var i=0;i<256;i++){t=i;for(var n=0;n<8;n++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e})());var _A=(t,e,i,n)=>{const s=vA,o=n+i;t^=-1;for(let i=n;i<o;i++)t=t>>>8^s[255&(t^e[i])];return-1^t},EA={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},SA={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:TA,_tr_stored_block:bA,_tr_flush_block:yA,_tr_tally:CA,_tr_align:wA}=gA,{Z_NO_FLUSH:RA,Z_PARTIAL_FLUSH:IA,Z_FULL_FLUSH:AA,Z_FINISH:OA,Z_BLOCK:NA,Z_OK:kA,Z_STREAM_END:LA,Z_STREAM_ERROR:PA,Z_DATA_ERROR:DA,Z_BUF_ERROR:MA,Z_DEFAULT_COMPRESSION:xA,Z_FILTERED:UA,Z_HUFFMAN_ONLY:VA,Z_RLE:FA,Z_FIXED:BA,Z_DEFAULT_STRATEGY:jA,Z_UNKNOWN:HA,Z_DEFLATED:GA}=SA,WA=286,$A=30,zA=19,qA=2*WA+1,KA=15,YA=258,JA=262,XA=42,ZA=113,QA=666,tO=(t,e)=>(t.msg=EA[e],e),eO=t=>2*t-(t>4?9:0),iO=t=>{let e=t.length;for(;--e>=0;)t[e]=0},nO=t=>{let e,i,n,s=t.w_size;e=t.hash_size,n=e;do{i=t.head[--n],t.head[n]=i>=s?i-s:0}while(--e);e=s,n=e;do{i=t.prev[--n],t.prev[n]=i>=s?i-s:0}while(--e)};let sO=(t,e,i)=>(e<<t.hash_shift^i)&t.hash_mask;const oO=t=>{const e=t.state;let i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+i),t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))},rO=(t,e)=>{yA(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,oO(t.strm)},aO=(t,e)=>{t.pending_buf[t.pending++]=e},cO=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},dO=(t,e,i,n)=>{let s=t.avail_in;return s>n&&(s=n),0===s?0:(t.avail_in-=s,e.set(t.input.subarray(t.next_in,t.next_in+s),i),1===t.state.wrap?t.adler=fA(t.adler,e,s,i):2===t.state.wrap&&(t.adler=_A(t.adler,e,s,i)),t.next_in+=s,t.total_in+=s,s)},lO=(t,e)=>{let i,n,s=t.max_chain_length,o=t.strstart,r=t.prev_length,a=t.nice_match;const c=t.strstart>t.w_size-JA?t.strstart-(t.w_size-JA):0,d=t.window,l=t.w_mask,h=t.prev,u=t.strstart+YA;let p=d[o+r-1],m=d[o+r];t.prev_length>=t.good_match&&(s>>=2),a>t.lookahead&&(a=t.lookahead);do{if(i=e,d[i+r]===m&&d[i+r-1]===p&&d[i]===d[o]&&d[++i]===d[o+1]){o+=2,i++;do{}while(d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&o<u);if(n=YA-(u-o),o=u-YA,n>r){if(t.match_start=e,r=n,n>=a)break;p=d[o+r-1],m=d[o+r]}}}while((e=h[e&l])>c&&0!=--s);return r<=t.lookahead?r:t.lookahead},hO=t=>{const e=t.w_size;let i,n,s;do{if(n=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-JA)&&(t.window.set(t.window.subarray(e,e+e-n),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),nO(t),n+=e),0===t.strm.avail_in)break;if(i=dO(t.strm,t.window,t.strstart+t.lookahead,n),t.lookahead+=i,t.lookahead+t.insert>=3)for(s=t.strstart-t.insert,t.ins_h=t.window[s],t.ins_h=sO(t,t.ins_h,t.window[s+1]);t.insert&&(t.ins_h=sO(t,t.ins_h,t.window[s+3-1]),t.prev[s&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=s,s++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<JA&&0!==t.strm.avail_in)},uO=(t,e)=>{let i,n,s,o=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,r=0,a=t.strm.avail_in;do{if(i=65535,s=t.bi_valid+42>>3,t.strm.avail_out<s)break;if(s=t.strm.avail_out-s,n=t.strstart-t.block_start,i>n+t.strm.avail_in&&(i=n+t.strm.avail_in),i>s&&(i=s),i<o&&(0===i&&e!==OA||e===RA||i!==n+t.strm.avail_in))break;r=e===OA&&i===n+t.strm.avail_in?1:0,bA(t,0,0,r),t.pending_buf[t.pending-4]=i,t.pending_buf[t.pending-3]=i>>8,t.pending_buf[t.pending-2]=~i,t.pending_buf[t.pending-1]=~i>>8,oO(t.strm),n&&(n>i&&(n=i),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+n),t.strm.next_out),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n,t.block_start+=n,i-=n),i&&(dO(t.strm,t.strm.output,t.strm.next_out,i),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i)}while(0===r);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),r?4:e!==RA&&e!==OA&&0===t.strm.avail_in&&t.strstart===t.block_start?2:(s=t.window_size-t.strstart,t.strm.avail_in>s&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,s+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),s>t.strm.avail_in&&(s=t.strm.avail_in),s&&(dO(t.strm,t.window,t.strstart,s),t.strstart+=s,t.insert+=s>t.w_size-t.insert?t.w_size-t.insert:s),t.high_water<t.strstart&&(t.high_water=t.strstart),s=t.bi_valid+42>>3,s=t.pending_buf_size-s>65535?65535:t.pending_buf_size-s,o=s>t.w_size?t.w_size:s,n=t.strstart-t.block_start,(n>=o||(n||e===OA)&&e!==RA&&0===t.strm.avail_in&&n<=s)&&(i=n>s?s:n,r=e===OA&&0===t.strm.avail_in&&i===n?1:0,bA(t,t.block_start,i,r),t.block_start+=i,oO(t.strm)),r?3:1)},pO=(t,e)=>{let i,n;for(;;){if(t.lookahead<JA){if(hO(t),t.lookahead<JA&&e===RA)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=sO(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-JA&&(t.match_length=lO(t,i)),t.match_length>=3)if(n=CA(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=sO(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=sO(t,t.ins_h,t.window[t.strstart+1]);else n=CA(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(n&&(rO(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,e===OA?(rO(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(rO(t,!1),0===t.strm.avail_out)?1:2},mO=(t,e)=>{let i,n,s;for(;;){if(t.lookahead<JA){if(hO(t),t.lookahead<JA&&e===RA)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=sO(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-JA&&(t.match_length=lO(t,i),t.match_length<=5&&(t.strategy===UA||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){s=t.strstart+t.lookahead-3,n=CA(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=s&&(t.ins_h=sO(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,n&&(rO(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if(n=CA(t,0,t.window[t.strstart-1]),n&&rO(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(n=CA(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===OA?(rO(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(rO(t,!1),0===t.strm.avail_out)?1:2};function gO(t,e,i,n,s){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=n,this.func=s}const fO=[new gO(0,0,0,0,uO),new gO(4,4,8,4,pO),new gO(4,5,16,8,pO),new gO(4,6,32,32,pO),new gO(4,4,16,16,mO),new gO(8,16,32,32,mO),new gO(8,16,128,128,mO),new gO(8,32,128,256,mO),new gO(32,128,258,1024,mO),new gO(32,258,258,4096,mO)];function vO(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=GA,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*qA),this.dyn_dtree=new Uint16Array(2*(2*$A+1)),this.bl_tree=new Uint16Array(2*(2*zA+1)),iO(this.dyn_ltree),iO(this.dyn_dtree),iO(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(KA+1),this.heap=new Uint16Array(2*WA+1),iO(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*WA+1),iO(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const _O=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==XA&&57!==e.status&&69!==e.status&&73!==e.status&&91!==e.status&&103!==e.status&&e.status!==ZA&&e.status!==QA?1:0},EO=t=>{if(_O(t))return tO(t,PA);t.total_in=t.total_out=0,t.data_type=HA;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=2===e.wrap?57:e.wrap?XA:ZA,t.adler=2===e.wrap?0:1,e.last_flush=-2,TA(e),kA},SO=t=>{const e=EO(t);var i;return e===kA&&((i=t.state).window_size=2*i.w_size,iO(i.head),i.max_lazy_match=fO[i.level].max_lazy,i.good_match=fO[i.level].good_length,i.nice_match=fO[i.level].nice_length,i.max_chain_length=fO[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0),e},TO=(t,e,i,n,s,o)=>{if(!t)return PA;let r=1;if(e===xA&&(e=6),n<0?(r=0,n=-n):n>15&&(r=2,n-=16),s<1||s>9||i!==GA||n<8||n>15||e<0||e>9||o<0||o>BA||8===n&&1!==r)return tO(t,PA);8===n&&(n=9);const a=new vO;return t.state=a,a.strm=t,a.status=XA,a.wrap=r,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=o,a.method=i,SO(t)};var bO=(t,e)=>{if(_O(t)||e>NA||e<0)return t?tO(t,PA):PA;const i=t.state;if(!t.output||0!==t.avail_in&&!t.input||i.status===QA&&e!==OA)return tO(t,0===t.avail_out?MA:PA);const n=i.last_flush;if(i.last_flush=e,0!==i.pending){if(oO(t),0===t.avail_out)return i.last_flush=-1,kA}else if(0===t.avail_in&&eO(e)<=eO(n)&&e!==OA)return tO(t,MA);if(i.status===QA&&0!==t.avail_in)return tO(t,MA);if(i.status===XA&&0===i.wrap&&(i.status=ZA),i.status===XA){let e=GA+(i.w_bits-8<<4)<<8,n=-1;if(n=i.strategy>=VA||i.level<2?0:i.level<6?1:6===i.level?2:3,e|=n<<6,0!==i.strstart&&(e|=32),e+=31-e%31,cO(i,e),0!==i.strstart&&(cO(i,t.adler>>>16),cO(i,65535&t.adler)),t.adler=1,i.status=ZA,oO(t),0!==i.pending)return i.last_flush=-1,kA}if(57===i.status)if(t.adler=0,aO(i,31),aO(i,139),aO(i,8),i.gzhead)aO(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),aO(i,255&i.gzhead.time),aO(i,i.gzhead.time>>8&255),aO(i,i.gzhead.time>>16&255),aO(i,i.gzhead.time>>24&255),aO(i,9===i.level?2:i.strategy>=VA||i.level<2?4:0),aO(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(aO(i,255&i.gzhead.extra.length),aO(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(t.adler=_A(t.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(aO(i,0),aO(i,0),aO(i,0),aO(i,0),aO(i,0),aO(i,9===i.level?2:i.strategy>=VA||i.level<2?4:0),aO(i,3),i.status=ZA,oO(t),0!==i.pending)return i.last_flush=-1,kA;if(69===i.status){if(i.gzhead.extra){let e=i.pending,n=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+n>i.pending_buf_size;){let s=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+s),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>e&&(t.adler=_A(t.adler,i.pending_buf,i.pending-e,e)),i.gzindex+=s,oO(t),0!==i.pending)return i.last_flush=-1,kA;e=0,n-=s}let s=new Uint8Array(i.gzhead.extra);i.pending_buf.set(s.subarray(i.gzindex,i.gzindex+n),i.pending),i.pending+=n,i.gzhead.hcrc&&i.pending>e&&(t.adler=_A(t.adler,i.pending_buf,i.pending-e,e)),i.gzindex=0}i.status=73}if(73===i.status){if(i.gzhead.name){let e,n=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>n&&(t.adler=_A(t.adler,i.pending_buf,i.pending-n,n)),oO(t),0!==i.pending)return i.last_flush=-1,kA;n=0}e=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,aO(i,e)}while(0!==e);i.gzhead.hcrc&&i.pending>n&&(t.adler=_A(t.adler,i.pending_buf,i.pending-n,n)),i.gzindex=0}i.status=91}if(91===i.status){if(i.gzhead.comment){let e,n=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>n&&(t.adler=_A(t.adler,i.pending_buf,i.pending-n,n)),oO(t),0!==i.pending)return i.last_flush=-1,kA;n=0}e=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,aO(i,e)}while(0!==e);i.gzhead.hcrc&&i.pending>n&&(t.adler=_A(t.adler,i.pending_buf,i.pending-n,n))}i.status=103}if(103===i.status){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(oO(t),0!==i.pending))return i.last_flush=-1,kA;aO(i,255&t.adler),aO(i,t.adler>>8&255),t.adler=0}if(i.status=ZA,oO(t),0!==i.pending)return i.last_flush=-1,kA}if(0!==t.avail_in||0!==i.lookahead||e!==RA&&i.status!==QA){let n=0===i.level?uO(i,e):i.strategy===VA?((t,e)=>{let i;for(;;){if(0===t.lookahead&&(hO(t),0===t.lookahead)){if(e===RA)return 1;break}if(t.match_length=0,i=CA(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(rO(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===OA?(rO(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(rO(t,!1),0===t.strm.avail_out)?1:2})(i,e):i.strategy===FA?((t,e)=>{let i,n,s,o;const r=t.window;for(;;){if(t.lookahead<=YA){if(hO(t),t.lookahead<=YA&&e===RA)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(s=t.strstart-1,n=r[s],n===r[++s]&&n===r[++s]&&n===r[++s])){o=t.strstart+YA;do{}while(n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&s<o);t.match_length=YA-(o-s),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(i=CA(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=CA(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(rO(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===OA?(rO(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(rO(t,!1),0===t.strm.avail_out)?1:2})(i,e):fO[i.level].func(i,e);if(3!==n&&4!==n||(i.status=QA),1===n||3===n)return 0===t.avail_out&&(i.last_flush=-1),kA;if(2===n&&(e===IA?wA(i):e!==NA&&(bA(i,0,0,!1),e===AA&&(iO(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),oO(t),0===t.avail_out))return i.last_flush=-1,kA}return e!==OA?kA:i.wrap<=0?LA:(2===i.wrap?(aO(i,255&t.adler),aO(i,t.adler>>8&255),aO(i,t.adler>>16&255),aO(i,t.adler>>24&255),aO(i,255&t.total_in),aO(i,t.total_in>>8&255),aO(i,t.total_in>>16&255),aO(i,t.total_in>>24&255)):(cO(i,t.adler>>>16),cO(i,65535&t.adler)),oO(t),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?kA:LA)},yO=(t,e)=>{let i=e.length;if(_O(t))return PA;const n=t.state,s=n.wrap;if(2===s||1===s&&n.status!==XA||n.lookahead)return PA;if(1===s&&(t.adler=fA(t.adler,e,i,0)),n.wrap=0,i>=n.w_size){0===s&&(iO(n.head),n.strstart=0,n.block_start=0,n.insert=0);let t=new Uint8Array(n.w_size);t.set(e.subarray(i-n.w_size,i),0),e=t,i=n.w_size}const o=t.avail_in,r=t.next_in,a=t.input;for(t.avail_in=i,t.next_in=0,t.input=e,hO(n);n.lookahead>=3;){let t=n.strstart,e=n.lookahead-2;do{n.ins_h=sO(n,n.ins_h,n.window[t+3-1]),n.prev[t&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=t,t++}while(--e);n.strstart=t,n.lookahead=2,hO(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,t.next_in=r,t.input=a,t.avail_in=o,n.wrap=s,kA},CO={deflateInit:(t,e)=>TO(t,e,GA,15,8,jA),deflateInit2:TO,deflateReset:SO,deflateResetKeep:EO,deflateSetHeader:(t,e)=>_O(t)||2!==t.state.wrap?PA:(t.state.gzhead=e,kA),deflate:bO,deflateEnd:t=>{if(_O(t))return PA;const e=t.state.status;return t.state=null,e===ZA?tO(t,DA):kA},deflateSetDictionary:yO,deflateInfo:"pako deflate (from Nodeca project)"};const wO=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var RO={assign:function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(const e in i)wO(i,e)&&(t[e]=i[e])}}return t},flattenChunks:t=>{let e=0;for(let i=0,n=t.length;i<n;i++)e+=t[i].length;const i=new Uint8Array(e);for(let e=0,n=0,s=t.length;e<s;e++){let s=t[e];i.set(s,n),n+=s.length}return i}};let IO=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){IO=!1}const AO=new Uint8Array(256);for(let t=0;t<256;t++)AO[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;AO[254]=AO[254]=1;var OO={string2buf:t=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(t);let e,i,n,s,o,r=t.length,a=0;for(s=0;s<r;s++)i=t.charCodeAt(s),55296==(64512&i)&&s+1<r&&(n=t.charCodeAt(s+1),56320==(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),s++)),a+=i<128?1:i<2048?2:i<65536?3:4;for(e=new Uint8Array(a),o=0,s=0;o<a;s++)i=t.charCodeAt(s),55296==(64512&i)&&s+1<r&&(n=t.charCodeAt(s+1),56320==(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),s++)),i<128?e[o++]=i:i<2048?(e[o++]=192|i>>>6,e[o++]=128|63&i):i<65536?(e[o++]=224|i>>>12,e[o++]=128|i>>>6&63,e[o++]=128|63&i):(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63,e[o++]=128|i>>>6&63,e[o++]=128|63&i);return e},buf2string:(t,e)=>{const i=e||t.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(t.subarray(0,e));let n,s;const o=new Array(2*i);for(s=0,n=0;n<i;){let e=t[n++];if(e<128){o[s++]=e;continue}let r=AO[e];if(r>4)o[s++]=65533,n+=r-1;else{for(e&=2===r?31:3===r?15:7;r>1&&n<i;)e=e<<6|63&t[n++],r--;r>1?o[s++]=65533:e<65536?o[s++]=e:(e-=65536,o[s++]=55296|e>>10&1023,o[s++]=56320|1023&e)}}return((t,e)=>{if(e<65534&&t.subarray&&IO)return String.fromCharCode.apply(null,t.length===e?t:t.subarray(0,e));let i="";for(let n=0;n<e;n++)i+=String.fromCharCode(t[n]);return i})(o,s)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let i=e-1;for(;i>=0&&128==(192&t[i]);)i--;return i<0||0===i?e:i+AO[t[i]]>e?i:e}},NO=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const kO=Object.prototype.toString,{Z_NO_FLUSH:LO,Z_SYNC_FLUSH:PO,Z_FULL_FLUSH:DO,Z_FINISH:MO,Z_OK:xO,Z_STREAM_END:UO,Z_DEFAULT_COMPRESSION:VO,Z_DEFAULT_STRATEGY:FO,Z_DEFLATED:BO}=SA;function jO(t){this.options=RO.assign({level:VO,method:BO,chunkSize:16384,windowBits:15,memLevel:8,strategy:FO},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new NO,this.strm.avail_out=0;let i=CO.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==xO)throw new Error(EA[i]);if(e.header&&CO.deflateSetHeader(this.strm,e.header),e.dictionary){let t;if(t="string"==typeof e.dictionary?OO.string2buf(e.dictionary):"[object ArrayBuffer]"===kO.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,i=CO.deflateSetDictionary(this.strm,t),i!==xO)throw new Error(EA[i]);this._dict_set=!0}}function HO(t,e){const i=new jO(e);if(i.push(t,!0),i.err)throw i.msg||EA[i.err];return i.result}jO.prototype.push=function(t,e){const i=this.strm,n=this.options.chunkSize;let s,o;if(this.ended)return!1;for(o=e===~~e?e:!0===e?MO:LO,"string"==typeof t?i.input=OO.string2buf(t):"[object ArrayBuffer]"===kO.call(t)?i.input=new Uint8Array(t):i.input=t,i.next_in=0,i.avail_in=i.input.length;;)if(0===i.avail_out&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),(o===PO||o===DO)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(s=CO.deflate(i,o),s===UO)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),s=CO.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===xO;if(0!==i.avail_out){if(o>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(0===i.avail_in)break}else this.onData(i.output)}return!0},jO.prototype.onData=function(t){this.chunks.push(t)},jO.prototype.onEnd=function(t){t===xO&&(this.result=RO.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var GO={Deflate:jO,deflate:HO,deflateRaw:function(t,e){return(e=e||{}).raw=!0,HO(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,HO(t,e)},constants:SA};const WO=16209;var $O=function(t,e){let i,n,s,o,r,a,c,d,l,h,u,p,m,g,f,v,_,E,S,T,b,y,C,w;const R=t.state;i=t.next_in,C=t.input,n=i+(t.avail_in-5),s=t.next_out,w=t.output,o=s-(e-t.avail_out),r=s+(t.avail_out-257),a=R.dmax,c=R.wsize,d=R.whave,l=R.wnext,h=R.window,u=R.hold,p=R.bits,m=R.lencode,g=R.distcode,f=(1<<R.lenbits)-1,v=(1<<R.distbits)-1;t:do{p<15&&(u+=C[i++]<<p,p+=8,u+=C[i++]<<p,p+=8),_=m[u&f];e:for(;;){if(E=_>>>24,u>>>=E,p-=E,E=_>>>16&255,0===E)w[s++]=65535&_;else{if(!(16&E)){if(0==(64&E)){_=m[(65535&_)+(u&(1<<E)-1)];continue e}if(32&E){R.mode=16191;break t}t.msg="invalid literal/length code",R.mode=WO;break t}S=65535&_,E&=15,E&&(p<E&&(u+=C[i++]<<p,p+=8),S+=u&(1<<E)-1,u>>>=E,p-=E),p<15&&(u+=C[i++]<<p,p+=8,u+=C[i++]<<p,p+=8),_=g[u&v];i:for(;;){if(E=_>>>24,u>>>=E,p-=E,E=_>>>16&255,!(16&E)){if(0==(64&E)){_=g[(65535&_)+(u&(1<<E)-1)];continue i}t.msg="invalid distance code",R.mode=WO;break t}if(T=65535&_,E&=15,p<E&&(u+=C[i++]<<p,p+=8,p<E&&(u+=C[i++]<<p,p+=8)),T+=u&(1<<E)-1,T>a){t.msg="invalid distance too far back",R.mode=WO;break t}if(u>>>=E,p-=E,E=s-o,T>E){if(E=T-E,E>d&&R.sane){t.msg="invalid distance too far back",R.mode=WO;break t}if(b=0,y=h,0===l){if(b+=c-E,E<S){S-=E;do{w[s++]=h[b++]}while(--E);b=s-T,y=w}}else if(l<E){if(b+=c+l-E,E-=l,E<S){S-=E;do{w[s++]=h[b++]}while(--E);if(b=0,l<S){E=l,S-=E;do{w[s++]=h[b++]}while(--E);b=s-T,y=w}}}else if(b+=l-E,E<S){S-=E;do{w[s++]=h[b++]}while(--E);b=s-T,y=w}for(;S>2;)w[s++]=y[b++],w[s++]=y[b++],w[s++]=y[b++],S-=3;S&&(w[s++]=y[b++],S>1&&(w[s++]=y[b++]))}else{b=s-T;do{w[s++]=w[b++],w[s++]=w[b++],w[s++]=w[b++],S-=3}while(S>2);S&&(w[s++]=w[b++],S>1&&(w[s++]=w[b++]))}break}}break}}while(i<n&&s<r);S=p>>3,i-=S,p-=S<<3,u&=(1<<p)-1,t.next_in=i,t.next_out=s,t.avail_in=i<n?n-i+5:5-(i-n),t.avail_out=s<r?r-s+257:257-(s-r),R.hold=u,R.bits=p};const zO=15,qO=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),KO=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),YO=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),JO=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var XO=(t,e,i,n,s,o,r,a)=>{const c=a.bits;let d,l,h,u,p,m,g=0,f=0,v=0,_=0,E=0,S=0,T=0,b=0,y=0,C=0,w=null;const R=new Uint16Array(16),I=new Uint16Array(16);let A,O,N,k=null;for(g=0;g<=zO;g++)R[g]=0;for(f=0;f<n;f++)R[e[i+f]]++;for(E=c,_=zO;_>=1&&0===R[_];_--);if(E>_&&(E=_),0===_)return s[o++]=20971520,s[o++]=20971520,a.bits=1,0;for(v=1;v<_&&0===R[v];v++);for(E<v&&(E=v),b=1,g=1;g<=zO;g++)if(b<<=1,b-=R[g],b<0)return-1;if(b>0&&(0===t||1!==_))return-1;for(I[1]=0,g=1;g<zO;g++)I[g+1]=I[g]+R[g];for(f=0;f<n;f++)0!==e[i+f]&&(r[I[e[i+f]]++]=f);if(0===t?(w=k=r,m=20):1===t?(w=qO,k=KO,m=257):(w=YO,k=JO,m=0),C=0,f=0,g=v,p=o,S=E,T=0,h=-1,y=1<<E,u=y-1,1===t&&y>852||2===t&&y>592)return 1;for(;;){A=g-T,r[f]+1<m?(O=0,N=r[f]):r[f]>=m?(O=k[r[f]-m],N=w[r[f]-m]):(O=96,N=0),d=1<<g-T,l=1<<S,v=l;do{l-=d,s[p+(C>>T)+l]=A<<24|O<<16|N|0}while(0!==l);for(d=1<<g-1;C&d;)d>>=1;if(0!==d?(C&=d-1,C+=d):C=0,f++,0==--R[g]){if(g===_)break;g=e[i+r[f]]}if(g>E&&(C&u)!==h){for(0===T&&(T=E),p+=v,S=g-T,b=1<<S;S+T<_&&(b-=R[S+T],!(b<=0));)S++,b<<=1;if(y+=1<<S,1===t&&y>852||2===t&&y>592)return 1;h=C&u,s[h]=E<<24|S<<16|p-o|0}}return 0!==C&&(s[p+C]=g-T<<24|64<<16|0),a.bits=E,0};const{Z_FINISH:ZO,Z_BLOCK:QO,Z_TREES:tN,Z_OK:eN,Z_STREAM_END:iN,Z_NEED_DICT:nN,Z_STREAM_ERROR:sN,Z_DATA_ERROR:oN,Z_MEM_ERROR:rN,Z_BUF_ERROR:aN,Z_DEFLATED:cN}=SA,dN=16180,lN=16190,hN=16191,uN=16192,pN=16194,mN=16199,gN=16200,fN=16206,vN=16209,_N=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function EN(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const SN=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<dN||e.mode>16211?1:0},TN=t=>{if(SN(t))return sN;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=dN,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,eN},bN=t=>{if(SN(t))return sN;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,TN(t)},yN=(t,e)=>{let i;if(SN(t))return sN;const n=t.state;return e<0?(i=0,e=-e):(i=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?sN:(null!==n.window&&n.wbits!==e&&(n.window=null),n.wrap=i,n.wbits=e,bN(t))},CN=(t,e)=>{if(!t)return sN;const i=new EN;t.state=i,i.strm=t,i.window=null,i.mode=dN;const n=yN(t,e);return n!==eN&&(t.state=null),n};let wN,RN,IN=!0;const AN=t=>{if(IN){wN=new Int32Array(512),RN=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(XO(1,t.lens,0,288,wN,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;XO(2,t.lens,0,32,RN,0,t.work,{bits:5}),IN=!1}t.lencode=wN,t.lenbits=9,t.distcode=RN,t.distbits=5},ON=(t,e,i,n)=>{let s;const o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),n>=o.wsize?(o.window.set(e.subarray(i-o.wsize,i),0),o.wnext=0,o.whave=o.wsize):(s=o.wsize-o.wnext,s>n&&(s=n),o.window.set(e.subarray(i-n,i-n+s),o.wnext),(n-=s)?(o.window.set(e.subarray(i-n,i),0),o.wnext=n,o.whave=o.wsize):(o.wnext+=s,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=s))),0};var NN=(t,e)=>{let i,n,s,o,r,a,c,d,l,h,u,p,m,g,f,v,_,E,S,T,b,y,C=0;const w=new Uint8Array(4);let R,I;const A=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(SN(t)||!t.output||!t.input&&0!==t.avail_in)return sN;i=t.state,i.mode===hN&&(i.mode=uN),r=t.next_out,s=t.output,c=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,d=i.hold,l=i.bits,h=a,u=c,y=eN;t:for(;;)switch(i.mode){case dN:if(0===i.wrap){i.mode=uN;break}for(;l<16;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(2&i.wrap&&35615===d){0===i.wbits&&(i.wbits=15),i.check=0,w[0]=255&d,w[1]=d>>>8&255,i.check=_A(i.check,w,2,0),d=0,l=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",i.mode=vN;break}if((15&d)!==cN){t.msg="unknown compression method",i.mode=vN;break}if(d>>>=4,l-=4,b=8+(15&d),0===i.wbits&&(i.wbits=b),b>15||b>i.wbits){t.msg="invalid window size",i.mode=vN;break}i.dmax=1<<i.wbits,i.flags=0,t.adler=i.check=1,i.mode=512&d?16189:hN,d=0,l=0;break;case 16181:for(;l<16;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(i.flags=d,(255&i.flags)!==cN){t.msg="unknown compression method",i.mode=vN;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=vN;break}i.head&&(i.head.text=d>>8&1),512&i.flags&&4&i.wrap&&(w[0]=255&d,w[1]=d>>>8&255,i.check=_A(i.check,w,2,0)),d=0,l=0,i.mode=16182;case 16182:for(;l<32;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}i.head&&(i.head.time=d),512&i.flags&&4&i.wrap&&(w[0]=255&d,w[1]=d>>>8&255,w[2]=d>>>16&255,w[3]=d>>>24&255,i.check=_A(i.check,w,4,0)),d=0,l=0,i.mode=16183;case 16183:for(;l<16;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}i.head&&(i.head.xflags=255&d,i.head.os=d>>8),512&i.flags&&4&i.wrap&&(w[0]=255&d,w[1]=d>>>8&255,i.check=_A(i.check,w,2,0)),d=0,l=0,i.mode=16184;case 16184:if(1024&i.flags){for(;l<16;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}i.length=d,i.head&&(i.head.extra_len=d),512&i.flags&&4&i.wrap&&(w[0]=255&d,w[1]=d>>>8&255,i.check=_A(i.check,w,2,0)),d=0,l=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&i.flags&&(p=i.length,p>a&&(p=a),p&&(i.head&&(b=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(n.subarray(o,o+p),b)),512&i.flags&&4&i.wrap&&(i.check=_A(i.check,n,p,o)),a-=p,o+=p,i.length-=p),i.length))break t;i.length=0,i.mode=16186;case 16186:if(2048&i.flags){if(0===a)break t;p=0;do{b=n[o+p++],i.head&&b&&i.length<65536&&(i.head.name+=String.fromCharCode(b))}while(b&&p<a);if(512&i.flags&&4&i.wrap&&(i.check=_A(i.check,n,p,o)),a-=p,o+=p,b)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&i.flags){if(0===a)break t;p=0;do{b=n[o+p++],i.head&&b&&i.length<65536&&(i.head.comment+=String.fromCharCode(b))}while(b&&p<a);if(512&i.flags&&4&i.wrap&&(i.check=_A(i.check,n,p,o)),a-=p,o+=p,b)break t}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&i.flags){for(;l<16;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(4&i.wrap&&d!==(65535&i.check)){t.msg="header crc mismatch",i.mode=vN;break}d=0,l=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=hN;break;case 16189:for(;l<32;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}t.adler=i.check=_N(d),d=0,l=0,i.mode=lN;case lN:if(0===i.havedict)return t.next_out=r,t.avail_out=c,t.next_in=o,t.avail_in=a,i.hold=d,i.bits=l,nN;t.adler=i.check=1,i.mode=hN;case hN:if(e===QO||e===tN)break t;case uN:if(i.last){d>>>=7&l,l-=7&l,i.mode=fN;break}for(;l<3;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}switch(i.last=1&d,d>>>=1,l-=1,3&d){case 0:i.mode=16193;break;case 1:if(AN(i),i.mode=mN,e===tN){d>>>=2,l-=2;break t}break;case 2:i.mode=16196;break;case 3:t.msg="invalid block type",i.mode=vN}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",i.mode=vN;break}if(i.length=65535&d,d=0,l=0,i.mode=pN,e===tN)break t;case pN:i.mode=16195;case 16195:if(p=i.length,p){if(p>a&&(p=a),p>c&&(p=c),0===p)break t;s.set(n.subarray(o,o+p),r),a-=p,o+=p,c-=p,r+=p,i.length-=p;break}i.mode=hN;break;case 16196:for(;l<14;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(i.nlen=257+(31&d),d>>>=5,l-=5,i.ndist=1+(31&d),d>>>=5,l-=5,i.ncode=4+(15&d),d>>>=4,l-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=vN;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;l<3;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}i.lens[A[i.have++]]=7&d,d>>>=3,l-=3}for(;i.have<19;)i.lens[A[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,R={bits:i.lenbits},y=XO(0,i.lens,0,19,i.lencode,0,i.work,R),i.lenbits=R.bits,y){t.msg="invalid code lengths set",i.mode=vN;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;C=i.lencode[d&(1<<i.lenbits)-1],f=C>>>24,v=C>>>16&255,_=65535&C,!(f<=l);){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(_<16)d>>>=f,l-=f,i.lens[i.have++]=_;else{if(16===_){for(I=f+2;l<I;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(d>>>=f,l-=f,0===i.have){t.msg="invalid bit length repeat",i.mode=vN;break}b=i.lens[i.have-1],p=3+(3&d),d>>>=2,l-=2}else if(17===_){for(I=f+3;l<I;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}d>>>=f,l-=f,b=0,p=3+(7&d),d>>>=3,l-=3}else{for(I=f+7;l<I;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}d>>>=f,l-=f,b=0,p=11+(127&d),d>>>=7,l-=7}if(i.have+p>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=vN;break}for(;p--;)i.lens[i.have++]=b}}if(i.mode===vN)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=vN;break}if(i.lenbits=9,R={bits:i.lenbits},y=XO(1,i.lens,0,i.nlen,i.lencode,0,i.work,R),i.lenbits=R.bits,y){t.msg="invalid literal/lengths set",i.mode=vN;break}if(i.distbits=6,i.distcode=i.distdyn,R={bits:i.distbits},y=XO(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,R),i.distbits=R.bits,y){t.msg="invalid distances set",i.mode=vN;break}if(i.mode=mN,e===tN)break t;case mN:i.mode=gN;case gN:if(a>=6&&c>=258){t.next_out=r,t.avail_out=c,t.next_in=o,t.avail_in=a,i.hold=d,i.bits=l,$O(t,u),r=t.next_out,s=t.output,c=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,d=i.hold,l=i.bits,i.mode===hN&&(i.back=-1);break}for(i.back=0;C=i.lencode[d&(1<<i.lenbits)-1],f=C>>>24,v=C>>>16&255,_=65535&C,!(f<=l);){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(v&&0==(240&v)){for(E=f,S=v,T=_;C=i.lencode[T+((d&(1<<E+S)-1)>>E)],f=C>>>24,v=C>>>16&255,_=65535&C,!(E+f<=l);){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}d>>>=E,l-=E,i.back+=E}if(d>>>=f,l-=f,i.back+=f,i.length=_,0===v){i.mode=16205;break}if(32&v){i.back=-1,i.mode=hN;break}if(64&v){t.msg="invalid literal/length code",i.mode=vN;break}i.extra=15&v,i.mode=16201;case 16201:if(i.extra){for(I=i.extra;l<I;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}i.length+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;C=i.distcode[d&(1<<i.distbits)-1],f=C>>>24,v=C>>>16&255,_=65535&C,!(f<=l);){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(0==(240&v)){for(E=f,S=v,T=_;C=i.distcode[T+((d&(1<<E+S)-1)>>E)],f=C>>>24,v=C>>>16&255,_=65535&C,!(E+f<=l);){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}d>>>=E,l-=E,i.back+=E}if(d>>>=f,l-=f,i.back+=f,64&v){t.msg="invalid distance code",i.mode=vN;break}i.offset=_,i.extra=15&v,i.mode=16203;case 16203:if(i.extra){for(I=i.extra;l<I;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}i.offset+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=vN;break}i.mode=16204;case 16204:if(0===c)break t;if(p=u-c,i.offset>p){if(p=i.offset-p,p>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=vN;break}p>i.wnext?(p-=i.wnext,m=i.wsize-p):m=i.wnext-p,p>i.length&&(p=i.length),g=i.window}else g=s,m=r-i.offset,p=i.length;p>c&&(p=c),c-=p,i.length-=p;do{s[r++]=g[m++]}while(--p);0===i.length&&(i.mode=gN);break;case 16205:if(0===c)break t;s[r++]=i.length,c--,i.mode=gN;break;case fN:if(i.wrap){for(;l<32;){if(0===a)break t;a--,d|=n[o++]<<l,l+=8}if(u-=c,t.total_out+=u,i.total+=u,4&i.wrap&&u&&(t.adler=i.check=i.flags?_A(i.check,s,u,r-u):fA(i.check,s,u,r-u)),u=c,4&i.wrap&&(i.flags?d:_N(d))!==i.check){t.msg="incorrect data check",i.mode=vN;break}d=0,l=0}i.mode=16207;case 16207:if(i.wrap&&i.flags){for(;l<32;){if(0===a)break t;a--,d+=n[o++]<<l,l+=8}if(4&i.wrap&&d!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=vN;break}d=0,l=0}i.mode=16208;case 16208:y=iN;break t;case vN:y=oN;break t;case 16210:return rN;default:return sN}return t.next_out=r,t.avail_out=c,t.next_in=o,t.avail_in=a,i.hold=d,i.bits=l,(i.wsize||u!==t.avail_out&&i.mode<vN&&(i.mode<fN||e!==ZO))&&ON(t,t.output,t.next_out,u-t.avail_out),h-=t.avail_in,u-=t.avail_out,t.total_in+=h,t.total_out+=u,i.total+=u,4&i.wrap&&u&&(t.adler=i.check=i.flags?_A(i.check,s,u,t.next_out-u):fA(i.check,s,u,t.next_out-u)),t.data_type=i.bits+(i.last?64:0)+(i.mode===hN?128:0)+(i.mode===mN||i.mode===pN?256:0),(0===h&&0===u||e===ZO)&&y===eN&&(y=aN),y},kN={inflateReset:bN,inflateReset2:yN,inflateResetKeep:TN,inflateInit:t=>CN(t,15),inflateInit2:CN,inflate:NN,inflateEnd:t=>{if(SN(t))return sN;let e=t.state;return e.window&&(e.window=null),t.state=null,eN},inflateGetHeader:(t,e)=>{if(SN(t))return sN;const i=t.state;return 0==(2&i.wrap)?sN:(i.head=e,e.done=!1,eN)},inflateSetDictionary:(t,e)=>{const i=e.length;let n,s,o;return SN(t)?sN:(n=t.state,0!==n.wrap&&n.mode!==lN?sN:n.mode===lN&&(s=1,s=fA(s,e,i,0),s!==n.check)?oN:(o=ON(t,e,i,i),o?(n.mode=16210,rN):(n.havedict=1,eN)))},inflateInfo:"pako inflate (from Nodeca project)"},LN=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const PN=Object.prototype.toString,{Z_NO_FLUSH:DN,Z_FINISH:MN,Z_OK:xN,Z_STREAM_END:UN,Z_NEED_DICT:VN,Z_STREAM_ERROR:FN,Z_DATA_ERROR:BN,Z_MEM_ERROR:jN}=SA;function HN(t){this.options=RO.assign({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new NO,this.strm.avail_out=0;let i=kN.inflateInit2(this.strm,e.windowBits);if(i!==xN)throw new Error(EA[i]);if(this.header=new LN,kN.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=OO.string2buf(e.dictionary):"[object ArrayBuffer]"===PN.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=kN.inflateSetDictionary(this.strm,e.dictionary),i!==xN)))throw new Error(EA[i])}function GN(t,e){const i=new HN(e);if(i.push(t),i.err)throw i.msg||EA[i.err];return i.result}HN.prototype.push=function(t,e){const i=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let o,r,a;if(this.ended)return!1;for(r=e===~~e?e:!0===e?MN:DN,"[object ArrayBuffer]"===PN.call(t)?i.input=new Uint8Array(t):i.input=t,i.next_in=0,i.avail_in=i.input.length;;){for(0===i.avail_out&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),o=kN.inflate(i,r),o===VN&&s&&(o=kN.inflateSetDictionary(i,s),o===xN?o=kN.inflate(i,r):o===BN&&(o=VN));i.avail_in>0&&o===UN&&i.state.wrap>0&&0!==t[i.next_in];)kN.inflateReset(i),o=kN.inflate(i,r);switch(o){case FN:case BN:case VN:case jN:return this.onEnd(o),this.ended=!0,!1}if(a=i.avail_out,i.next_out&&(0===i.avail_out||o===UN))if("string"===this.options.to){let t=OO.utf8border(i.output,i.next_out),e=i.next_out-t,s=OO.buf2string(i.output,t);i.next_out=e,i.avail_out=n-e,e&&i.output.set(i.output.subarray(t,t+e),0),this.onData(s)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(o!==xN||0!==a){if(o===UN)return o=kN.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===i.avail_in)break}}return!0},HN.prototype.onData=function(t){this.chunks.push(t)},HN.prototype.onEnd=function(t){t===xN&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=RO.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var WN={Inflate:HN,inflate:GN,inflateRaw:function(t,e){return(e=e||{}).raw=!0,GN(t,e)},ungzip:GN,constants:SA};const{Deflate:$N,deflate:zN,deflateRaw:qN,gzip:KN}=GO,{Inflate:YN,inflate:JN,inflateRaw:XN,ungzip:ZN}=WN;var QN,tk=zN,ek=JN;!function(t){t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE"}(QN||(QN={}));class ik{constructor(){nu(this,"_sequence",0),nu(this,"_startTime",Date.now()),nu(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const e={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const i=new Uint8Array(4);i.set([1,0,0,0]);const n={id:0,length:4,data:i.buffer},s={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[n]};e.commonPacketHeader.extension=1,e.extension=s,e.payload=this.compress(t),e.commonPacketHeader.length=8+(e.extension.length+2)+e.payload.byteLength}else e.commonPacketHeader.length=8+e.payload.byteLength;const i=new ArrayBuffer(e.commonPacketHeader.length),n=new Uint8Array(i),s=new DataView(i);let o=0;if(s.setUint16(o,e.commonPacketHeader.extension<<15|e.commonPacketHeader.reserved<<14|e.commonPacketHeader.length,!0),o+=2,s.setUint32(o,e.commonPacketHeader.sequence,!0),o+=4,s.setUint16(o,e.commonStreamHeader,!0),o+=2,e.extension){const t=this.serializeExtension(e.extension);n.set(new Uint8Array(t),o),o+=t.byteLength}if(n.set(new Uint8Array(e.payload),o),o+=e.payload.byteLength,o!==e.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const e=new DataView(t);let i=0;const n=e.getUint16(i,!0);i+=2;const s=(32768&n)>>15;let o,r;if(e.getUint16(i+2,!0),e.getUint16(i,!0),i+=4,e.getUint16(i,!0),i+=2,s){r=this.deserializeExtension(t.slice(i)),i+=2+r.length,o=t.slice(i);let e=!1;if(r.datas.length>0){const t=r.datas.find((t=>0===t.id));t&&(e=1==(1&new DataView(t.data).getUint32(0,!0)))}o=e?this.decompress(o):o}else o=t.slice(8);return o}serializeExtension(t){const{profile:e,length:i,datas:n}=t,s=new ArrayBuffer(i+2),o=new Uint8Array(s),r=new DataView(s);let a=0;if(r.setUint8(a++,e),r.setUint8(a++,i),n.forEach((t=>{e?(r.setUint8(a++,t.id),r.setUint8(a++,t.length),o.set(new Uint8Array(t.data),a),a+=t.data.byteLength):(r.setUint8(a++,t.id|t.length<<4),o.set(new Uint8Array(t.data),a),a+=t.data.byteLength)})),a!==i+2)throw Error("serialize extension error, is ".concat(a,"!==").concat(i+2));return s}deserializeExtension(t){const e=new DataView(t);let i=0;const n=e.getUint8(i);i++;const s=e.getUint8(i);i++;const o=n===QN.TWO_BYTE,r=[],a=new DataView(t,2);let c=0;for(;c<s;){let t=0,e=0,i=new ArrayBuffer(0);o?(t=a.getUint8(c),c++,e=a.getUint8(c),c++):(t=15&a.getUint8(c),e=a.getUint8(c)>>4,c++),e>0&&(i=a.buffer.slice(c+2,c+2+e),c+=i.byteLength),r.push({id:t,length:e,data:i})}if(c!==s)throw Error("parse error");return{profile:n,length:s,datas:r}}decompress(t){return ek(new Uint8Array(t))}compress(t){return tk(new Uint8Array(t))}}class nk extends iE{constructor(t,e){super(),nu(this,"_version",1),nu(this,"_type",3),nu(this,"_config",void 0),nu(this,"_originDataChannel",void 0),nu(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),nu(this,"_dataStreamPacketHandler",void 0),nu(this,"_datachannelEventMap",new Map),this._config=t,e&&(this._originDataChannel=e,this._bandDataChannelEvents(e)),this._initPacketHeader(),this._dataStreamPacketHandler=new ik}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return Db("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,e;return null!==(t=null===(e=this._originDataChannel)||void 0===e?void 0:e.readyState)&&void 0!==t?t:"connecting"}get _originDataChannelId(){var t,e;return null!==(t=null===(e=this._originDataChannel)||void 0===e?void 0:e.id)&&void 0!==t?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new e_(((t,e)=>{if(this._originDataChannel){"open"===this._originDataChannel.readyState&&t();const i=setTimeout((()=>{var t;e(new V_(U_.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat(null===(t=this._originDataChannel)||void 0===t?void 0:t.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new V_(U_.DATACHANNEL_CONNECTION_TIMEOUT)}}else e(new V_(U_.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[tR.OPEN,tR.CLOSE,tR.ERROR].forEach((e=>{const i=()=>{this.emit(e)};this._datachannelEventMap.set(e,i),t.addEventListener(e,i)}))}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach((e=>{let[i,n]=e;t.removeEventListener(i,n)})),this._datachannelEventMap.clear()}}class sk extends nk{constructor(t){super(t),nu(this,"_messageListener",void 0),this._messageListener=t=>{if(t.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const e=t.data.slice(0,this._dataStreamPacketHeader.byteLength);if(new DataView(e).getUint8(3)!==this.id)return;let i=t.data.slice(this._dataStreamPacketHeader.byteLength);i=this._dataStreamPacketHandler.deserialize(i),this.emit(tR.MESSAGE,i)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class ok extends nk{send(t){if(this._originDataChannel){let e=t;e=this._dataStreamPacketHandler.serialize(t);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+e.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(e),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}class rk extends iE{constructor(){super(...arguments),nu(this,"resultStorage",new Map)}setLocalAudioStats(t,e,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(i,e)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(i,e))}setLocalVideoStats(t,e,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(i,e)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(i,e)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(i))}setRemoteAudioStats(t,e){const i=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(e))}setRemoteVideoStats(t,e){const i=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(e))}record(t,e,i){if(Db("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(t);if(n&&(n.result.push(i),n.result.length>=5)){var s;const i=Ps(s=n.result).call(s,!0);n.isPrevNormal&&!i&&this.emit("exception",ak[t],t,e),!n.isPrevNormal&&i&&this.emit("exception",ak[t]+2e3,t+"_RECOVER",e),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&0===t.receiveLevel)}checkAudioInputLevel(t,e){return e instanceof eI&&!e.isActive||!!e.muted||0!==t.sendVolumeLevel}checkFramerateInput(t,e){let i=null;e._encoderConfig&&e._encoderConfig.frameRate&&(i=fk(e._encoderConfig.frameRate));const n=t.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checkSendVideoBitrate(t,e){return!!e.muted||0!==t.sendBitrate}checkSendAudioBitrate(t,e){return e instanceof eI&&!e.isActive||!!e.muted||0!==t.sendBitrate}checkVideoDecode(t){return 0===t.receiveBitrate||0!==t.decodeFrameRate}}const ak={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},ck=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(i.length>0){const t=i[i.length-1];return Math.round(performance.now()-t.startTime)}return 0}measureFromPublishStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(i.length>0){const t=i[i.length-1];return Math.round(performance.now()-t.startTime)}return 0}};function dk(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function lk(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?dk(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):dk(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class hk{constructor(t){nu(this,"store",void 0),nu(this,"onStatsException",void 0),nu(this,"onUploadPublishDuration",void 0),nu(this,"onStatsChanged",void 0),nu(this,"localStats",new Map),nu(this,"remoteStats",new Map),nu(this,"updateStatsInterval",void 0),nu(this,"trafficStats",void 0),nu(this,"trafficStatsPeerList",[]),nu(this,"uplinkStats",void 0),nu(this,"exceptionMonitor",void 0),nu(this,"p2pChannel",void 0),nu(this,"scalabilityMode",ly.L1T1),nu(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=t,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new rk,this.exceptionMonitor.on("exception",((t,e,i)=>{this.onStatsException&&this.onStatsException(t,e,i)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(mC.LocalAudioTrack)||lk({},Gw)}getLocalVideoTrackStats(){return this.localStats.get(mC.LocalVideoTrack)||lk({},Ww)}getRemoteAudioTrackStats(t){const e=(t,e)=>{if(!this.trafficStats)return e;const i=this.trafficStats.peer_delay.find((e=>e.peer_uid===t));return i&&(e.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),e},i={};if(t){var n;const s=null===(n=this.remoteStats.get(t))||void 0===n?void 0:n.audioStats;s&&(i[t]=e(t,s))}else Array.from(this.remoteStats.entries()).forEach((t=>{let[n,{audioStats:s}]=t;s&&(i[n]=e(n,s))}));return i}getRemoteNetworkQualityStats(t){const e={};if(t){var i;const n=null===(i=this.remoteStats.get(t))||void 0===i?void 0:i.networkStats;n&&(e[t]=n)}else Array.from(this.remoteStats.entries()).forEach((t=>{let[i,{networkStats:n}]=t;n&&(e[i]=n)}));return e}getRemoteVideoTrackStats(t){const e=(t,e)=>{if(!this.trafficStats)return e;const i=this.trafficStats.peer_delay.find((e=>e.peer_uid===t));return i&&(e.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),e},i={};if(t){var n;const s=null===(n=this.remoteStats.get(t))||void 0===n?void 0:n.videoStats;s&&(i[t]=e(t,s))}else Array.from(this.remoteStats.entries()).forEach((t=>{let[n,{videoStats:s}]=t;s&&(i[n]=e(n,s))}));return i}getRTCStats(){let t=0,e=0,i=0,n=0;const s=this.localStats.get(mC.LocalAudioTrack);s&&(t+=s.sendBytes,e+=s.sendBitrate);const o=this.localStats.get(mC.LocalVideoTrack);o&&(t+=o.sendBytes,e+=o.sendBitrate);const r=this.localStats.get(mC.LocalVideoLowTrack);r&&(t+=r.sendBytes,e+=r.sendBitrate),this.remoteStats.forEach((t=>{let{audioStats:e,videoStats:s}=t;e&&(i+=e.receiveBytes,n+=e.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:e,SendBytes:t,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter((t=>void 0!==t.B_ppad||void 0!==t.B_ppvd)),t.peer_delay.filter((t=>-1===this.trafficStatsPeerList.indexOf(t.peer_uid))).forEach((t=>{var e;const i=null===(e=this.p2pChannel)||void 0===e?void 0:e.getRemoteMedia(t.peer_uid),n=null!=i&&i.videoSSRC?ck.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?ck.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==t.B_ppad&&void 0!==t.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(t.peer_uid,t.B_ppad,t.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(t.peer_uid))})),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&$b.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,e,i){if(!t)return!1;const n=!!i&&e.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||e.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach((e=>{let[i,n]=e;switch(i){case mC.LocalVideoTrack:case mC.LocalVideoLowTrack:{const e=n,o=lk({},Ww),r=t.getStats(),a=t.getLocalMedia(i);if(r){const i=r.videoSend.find((t=>t.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(i){const n=t.getLocalVideoSize(),s=t.getEncoderConfig(mC.LocalVideoTrack);"H264"!==i.codec&&"H265"!==i.codec&&"VP8"!==i.codec&&"VP9"!==i.codec&&"AV1X"!==i.codec&&"AV1"!==i.codec||(o.codecType=i.codec),o.sendBytes=i.bytes,o.sendBitrate=e?8*Math.max(0,o.sendBytes-e.sendBytes):0,i.inputFrame?(o.captureFrameRate=i.inputFrame.frameRate,o.captureResolutionHeight=i.inputFrame.height,o.captureResolutionWidth=i.inputFrame.width):n&&(o.captureResolutionWidth=n.width,o.captureResolutionHeight=n.height),i.sentFrame?(o.sendFrameRate=i.sentFrame.frameRate,o.sendResolutionHeight=i.sentFrame.height,o.sendResolutionWidth=i.sentFrame.width):n&&(o.sendResolutionWidth=n.width,o.sendResolutionHeight=n.height),i.avgEncodeMs&&(o.encodeDelay=i.avgEncodeMs),s&&s.bitrateMax&&(o.targetSendBitrate=1e3*s.bitrateMax),o.sendPackets=i.packets,o.sendPacketsLost=i.packetsLost,o.sendJitterMs=i.jitterMs,o.sendRttMs=i.rttMs,o.totalDuration=e?e.totalDuration+1:1,o.totalFreezeTime=e?e.totalFreezeTime:0,this.isLocalVideoFreeze(i)&&(o.totalFreezeTime+=1),i.scalabilityMode&&this.scalabilityMode!==i.scalabilityMode&&($b.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(i.scalabilityMode)),this.scalabilityMode=i.scalabilityMode)}this.trafficStats&&(o.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(i,o),((null==e?void 0:e.sendResolutionWidth)!==o.sendResolutionWidth||(null==e?void 0:e.sendResolutionHeight)!==o.sendResolutionHeight)&&(null===(s=this.onStatsChanged)||void 0===s||s.call(this,"resolution",{width:o.sendResolutionWidth,height:o.sendResolutionHeight})),o&&a&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,a.track,o);break}case mC.LocalAudioTrack:{const e=n,s=lk({},Gw),o=t.getStats(),r=t.getLocalMedia(i);if(o){const i=o.audioSend.find((t=>t.ssrc===(null==r?void 0:r.ssrcs[0].ssrcId)));if(i){if("opus"!==i.codec&&"aac"!==i.codec&&"PCMU"!==i.codec&&"PCMA"!==i.codec&&"G722"!==i.codec||(s.codecType=i.codec),i.inputLevel)s.sendVolumeLevel=Math.round(32767*i.inputLevel);else{const e=t.getLocalAudioVolume();e&&(s.sendVolumeLevel=Math.round(32767*e))}s.sendBytes=i.bytes,s.sendPackets=i.packets,s.sendPacketsLost=i.packetsLost,s.sendJitterMs=i.jitterMs,s.sendRttMs=i.rttMs,s.sendBitrate=e?8*Math.max(0,s.sendBytes-e.sendBytes):0}}this.trafficStats&&(s.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(mC.LocalAudioTrack,s),s&&r&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,r.track,s);break}}}))}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{videoStats:n,audioStats:s,videoPcStats:o}]=e;const r=s,a=n,c=o,d=lk({},$w),l=lk({},qw),h=lk({},zw),{audioTrack:u,videoTrack:p,audioSSRC:m,videoSSRC:g}=t.getRemoteMedia(i),f=t.getStats(),v=null==f?void 0:f.audioRecv.find((t=>t.ssrc===m)),_=null==f?void 0:f.videoRecv.find((t=>t.ssrc===g)),E=this.trafficStats&&this.trafficStats.peer_delay.find((t=>t.peer_uid===i));if(v&&("opus"!==v.codec&&"aac"!==v.codec&&"PCMU"!==v.codec&&"PCMA"!==v.codec&&"G722"!==v.codec||(d.codecType=v.codec),v.outputLevel?d.receiveLevel=Math.round(32767*v.outputLevel):u&&(d.receiveLevel=Math.round(32767*u.getVolumeLevel())),d.receiveBytes=v.bytes,d.receivePackets=v.packets,d.receivePacketsLost=v.packetsLost,d.packetLossRate=d.receivePacketsLost/(d.receivePackets+d.receivePacketsLost),d.receiveBitrate=r?8*Math.max(0,d.receiveBytes-r.receiveBytes):0,d.totalDuration=r?r.totalDuration+1:1,d.totalFreezeTime=r?r.totalFreezeTime:0,d.freezeRate=d.totalFreezeTime/d.totalDuration,d.receiveDelay=v.jitterBufferMs,d.totalDuration>10&&hk.isRemoteAudioFreeze(u)&&(d.totalFreezeTime+=1)),_){"H264"!==_.codec&&"H265"!==_.codec&&"VP8"!==_.codec&&"VP9"!==_.codec&&"AV1X"!==_.codec&&"AV1"!==_.codec||(l.codecType=_.codec),l.receiveBytes=_.bytes,l.receiveBitrate=a?8*Math.max(0,l.receiveBytes-a.receiveBytes):0,l.decodeFrameRate=_.decodeFrameRate<0?0:_.decodeFrameRate,l.renderFrameRate=_.decodeFrameRate<0?0:_.decodeFrameRate,_.outputFrame&&(l.renderFrameRate=_.outputFrame.frameRate),_.receivedFrame?(l.receiveFrameRate=_.receivedFrame.frameRate,l.receiveResolutionHeight=_.receivedFrame.height,l.receiveResolutionWidth=_.receivedFrame.width):p&&(l.receiveResolutionHeight=p._videoHeight||0,l.receiveResolutionWidth=p._videoWidth||0),void 0!==_.framesRateFirefox&&(l.receiveFrameRate=Math.round(_.framesRateFirefox)),l.receivePackets=_.packets,l.receivePacketsLost=_.packetsLost,l.packetLossRate=l.receivePacketsLost/(l.receivePackets+l.receivePacketsLost),l.totalDuration=a?a.totalDuration+1:1,l.totalFreezeTime=a?a.totalFreezeTime:0,l.receiveDelay=_.jitterBufferMs||0;const e=!!g&&t.getRemoteVideoIsReady(g);p&&e&&hk.isRemoteVideoFreeze(p,_,c)&&(l.totalFreezeTime+=1),l.freezeRate=l.totalFreezeTime/l.totalDuration}E&&(d.end2EndDelay=E.B_ad,l.end2EndDelay=E.B_vd,d.transportDelay=E.B_ed,l.transportDelay=E.B_ed,d.currentPacketLossRate=E.B_ealr4/100,l.currentPacketLossRate=E.B_evlr4/100,h.uplinkNetworkQuality=E.B_punq?E.B_punq:0,h.downlinkNetworkQuality=E.B_pdnq?E.B_pdnq:0),this.remoteStats.set(i,{audioStats:d,videoStats:l,videoPcStats:_,networkStats:h}),u&&this.exceptionMonitor.setRemoteAudioStats(u,d),p&&this.exceptionMonitor.setRemoteVideoStats(p,l)}))}}function uk(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function pk(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?uk(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):uk(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function mk(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(Db("TURN_DOMAIN")):($b.info("Cannot recognized as IP address ".concat(t,". Used As Host instead")),t)}function gk(t,e){var i,n;const s=Db("GATEWAY_DOMAINS");let o=s[1]&&-1!==e.indexOf(s[1])?1:0;t.addresses=t.addresses||[];const r=t.addresses.map((t=>t.domain_prefix?{address:"".concat(t.domain_prefix,".").concat(s[o++%s.length],":").concat(t.port)}:t.ip.match(/^[\.\:\d]+$/)?{ip:t.ip,port:t.port,address:"".concat(t.ip.replace(/[^\d]/g,"-"),".").concat(s[o++%s.length],":").concat(t.port)}:($b.info("Cannot recognized as IP address ".concat(t.ip,". Used As Host instead")),{ip:t.ip,port:t.port,address:"".concat(t.ip,":").concat(t.port)})));if(null!==(i=t.detail)&&void 0!==i&&i[18]&&"string"==typeof(null===(n=t.detail)||void 0===n?void 0:n[18])){const e=t.detail[18],i=null==e?void 0:e.split(";");for(let t=0;t<i.length;t++){var a;const e=vw(a=i[t]).call(a);r[t]&&e&&(r[t].ip6=e)}}return{gatewayAddrs:r,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function fk(t){return"number"==typeof t?t:t.exact||t.ideal||t.max||t.min||0}function vk(t){const e=t._encoderConfig;if(!e)return{};const i={resolution:e.width&&e.height?"".concat(fk(e.width),"x").concat(fk(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return"number"==typeof e.frameRate?(i.maxFrameRate=e.frameRate,i.minFrameRate=e.frameRate):e.frameRate&&(i.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,i.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),i}function _k(t){const e={connectionType:0,googRtt:t.rtt};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=t.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(e.connectionType=1),"tcp"===i&&(e.connectionType=3),"tls"===i&&(e.connectionType=4);break}case"srflx":e.connectionType=2}return e}function Ek(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function Sk(t,e){let i,n,s;switch(e){case hw.CHOOSE_SERVER:n=4096,s="choose server";break;case hw.CLOUD_PROXY:n=1048576,s="proxy";break;case hw.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case hw.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new Uy(U_.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach((e=>{e.buffer&&e.buffer.flag===n&&(i={code:e.buffer.code,addresses:(e.buffer.edges_services||[]).map((t=>pk(pk({},t),{},{ticket:e.buffer.cert}))),server_ts:t.enter_ts,uid:e.buffer.uid,cid:e.buffer.cid,cname:e.buffer.cname,detail:pk(pk({},e.buffer.detail),t.detail),flag:e.buffer.flag,opid:t.opid,cert:e.buffer.cert})})),!i)throw new Uy(U_.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return i}async function Tk(t,e){return await e_.all(t.addresses.map((async t=>({address:mk(t.ip),tcpport:t.port,udpport:t.port,username:e&&Db("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():ry.username,password:e&&Db("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await eE(e.toString()):ry.password}))))}function bk(t,e){const i=e._videoHeight||e.getMediaStreamTrack(!0).getSettings().height;return i?Math.max(i/fk(t.height),1):($b.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function yk(t){let{candidateType:e,relayProtocol:i,type:n,address:s,port:o,protocol:r}=t;return"local-candidate"===n?{candidateType:e,relayProtocol:i,protocol:r}:{candidateType:e,relayProtocol:i,address:s,port:o,protocol:r}}function Ck(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}class wk extends iE{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var e;Ps(e=["tryNext","recover"]).call(e,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,"reconnecting"===this._state?this.emit(bC.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(bC.CONNECTED):"closed"===this._state?this.emit(bC.CLOSED):"failed"===this._state&&this.emit(bC.FAILED))}constructor(t,e,i,n){super(),nu(this,"connectionID",0),nu(this,"currentURLIndex",0),nu(this,"reconnectReason",void 0),nu(this,"_reconnectMode","tryNext"),nu(this,"_name",void 0),nu(this,"_state","closed"),nu(this,"_retryConfig",void 0),nu(this,"_reconnectCount",0),nu(this,"_forceCloseTimeout",5e3),nu(this,"_onlineReconnectListener",void 0),nu(this,"_closeEstablishingTransmitter",(()=>{})),nu(this,"_store",void 0),nu(this,"_joinChannelServiceRecordIndex",void 0),nu(this,"_useCompress",void 0),nu(this,"_inflateLength",0),nu(this,"_deflateLength",0),this._store=n,this._name=t,this._retryConfig=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ck(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ck(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},e),this._useCompress=i}resetReconnectCount(t){$b.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const t=this._transmitter;e?setTimeout((()=>t.close()),500):t.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,e){if(!this._transmitter)return void $b.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;void 0!==t&&(this.reconnectMode=t),$b.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex&&(null===(i=this._store)||void 0===i||i.recordJoinChannelService({status:"error",errors:[new Error(e)]},this._joinChannelServiceRecordIndex));const n=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),n&&n.bind(this._transmitter)({code:9999,reason:e})}getInflateData(){const t=this._inflateLength,e=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:e}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}var Rk;!function(t){t[t.Default=0]="Default",t[t.Ack=1]="Ack"}(Rk||(Rk={}));class Ik{constructor(t,e,i){nu(this,"version",1),nu(this,"initialRTO",void 0),nu(this,"maxBatchAckCount",void 0),nu(this,"maxRTO",void 0),nu(this,"initialRTT",void 0),nu(this,"ID",void 0),nu(this,"rtt",void 0),nu(this,"packetNumber",1),nu(this,"rtoRatioMap",new Map),nu(this,"timeoutMap",new Map),nu(this,"unorderedPacketQueue",[]),nu(this,"batchAckPacketQueue",[]),nu(this,"lastOrderedPacketNumber",0),nu(this,"batchAckTimer",void 0),nu(this,"sendImpl",void 0),nu(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=e,this.ID=UE(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:Db("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:Db("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:Db("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:Db("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:Db("TRANSMITTER_MAX_RTO")}packetize(t,e){return{type:Rk.Default,version:this.version,packetNumber:e,payload:t}}serialize(t){switch(t.type){case Rk.Default:{let e;e="string"==typeof t.payload?(new TextEncoder).encode(t.payload):t.payload;const i=new ArrayBuffer(e.length+15),n=new DataView(i);return n.setUint16(0,t.version),n.setUint8(2,t.type),n.setUint32(3,t.packetNumber),K_(n,7,BigInt(t.sendTs)),new Uint8Array(n.buffer).set(e,15),i}case Rk.Ack:{const e=new ArrayBuffer(16),i=new DataView(e);return i.setUint16(0,t.version),i.setUint8(2,t.type),i.setUint32(3,t.maxAckPacketNumber),i.setUint8(7,t.shift),K_(i,8,BigInt(t.ackSendTs)),e}}}deserialize(t){const e=new DataView(t),i=e.getUint16(0),n=e.getUint8(2);switch(n){case Rk.Default:{const s=e.getUint32(3),o=q_(e,7),r=t.slice(15),a=(new TextDecoder).decode(r);return{version:i,type:n,packetNumber:s,sendTs:Number(o),payload:a}}case Rk.Ack:{const t=e.getUint32(3),s=e.getUint8(7),o=q_(e,8);return{version:i,type:n,maxAckPacketNumber:t,shift:s,ackSendTs:Number(o)}}default:throw $b.error("[".concat(this.ID,"] Unrecognized packet type ").concat(n)),new Error("Unrecognized packet type ".concat(n))}}sendMessage(t){const e=this.packetize(t,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(e),n=window.setTimeout((()=>{this.resendMessage(e)}),i);this.timeoutMap.set(e.packetNumber,n),this.sendPacket(e)}onData(t){const e=this.deserialize(t);e.type===Rk.Default?this.ack(e):e.type===Rk.Ack&&(this.updateRTT(e,Math.round(performance.now())),this.clearRTO(e))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((t=>{let[e,i]=t;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const e=this.calculateRTO(t),i=window.setTimeout((()=>{this.resendMessage(t)}),e);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}calculateRTO(t){const e=this.rtoRatioMap.get(t.packetNumber);if(void 0===e)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*e;return this.rtoRatioMap.set(t.packetNumber,e+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(t,e){const i=t.ackSendTs;this.rtt=this.rtt*(7/8)+(e-i-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const t=this.unorderedPacketQueue[0];if(!t){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(t.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Rk.Ack,version:this.version};this.sendPacket(e)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Rk.Ack,version:this.version};this.sendPacket(e)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Rk.Ack,version:this.version};this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===Rk.Default&&(t.sendTs=Math.round(performance.now()));const e=this.serialize(t);this.sendImpl(e)}clearRTO(t){for(let e=t.maxAckPacketNumber-t.shift;e<=t.maxAckPacketNumber;e++){const t=this.timeoutMap.get(e);void 0!==t&&window.clearTimeout(t),this.timeoutMap.delete(e),this.rtoRatioMap.delete(e)}}}class Ak extends wk{constructor(t,e){super(t,e,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),nu(this,"_initMutex",void 0),nu(this,"_reconnectInterrupter",void 0),nu(this,"_url",void 0),nu(this,"_transmitter",void 0),nu(this,"_addresses",void 0),nu(this,"_reliableTransmission",void 0),this._initMutex=new zE("datachannel");const{timeout:i,timeoutFactor:n}=e,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*n)/10);hE.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),TE.on(uE.NETWORK_STATE_CHANGE,((t,e)=>{t!==e&&(this.resetReconnectCount("network state change: ".concat(e," -> ").concat(t)),t===hE.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=e;const i=(e,i)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex((t=>t.fingerprint||Db("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(e).catch(i),this.once(bC.CLOSED,(()=>i(new Uy(U_.WS_DISCONNECT)))),this.once(bC.CONNECTED,(()=>e()))};return this._initMutex.lock().then((t=>new e_(((t,e)=>{i(t,e)})).then((()=>{t()})).catch((()=>{t()}))))}sendMessage(t){let e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new Uy(U_.WS_ABORT,"datachannel is not ready");try{e||(t=JSON.stringify(t)),this._reliableTransmission.sendMessage(t)}catch(t){throw new Uy(U_.WS_ERR,"send datachannel signal message error"+t.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const e=JSON.stringify(t);return{compressed:e,compressedLength:e.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new e_(((e,i)=>{var n;const s=()=>{$b.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),e()},o=async t=>{var n;if(null===(n=this._closeEstablishingTransmitter)||void 0===n||n.call(this),$b.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const n=EE(this,bC.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,s=await this.reconnectWithAction(n);if("closed"===this.state)return void $b.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!s)return i(new Uy(U_.WS_DISCONNECT,"datachannel reconnect failed: ".concat(t.code))),void this.close(!0);e()}else i(new Uy(U_.WS_DISCONNECT,"datachannel close: ".concat(t.code))),this.close()},r=t=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.onData(t.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),$b.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const a=null===(n=this._store)||void 0===n?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),c=Date.now();vE(this,bC.TO_CONNECT_DATACHANNEL,t).then((t=>{var e,i;if(!t)throw new Error("transmissonInfo not exist yet");const{transmitter:n,close:d}=t;this._transmitter=n,null===(e=this._store)||void 0===e||e.signalChannelOpen();const l=Date.now()-c;$b.debug("[choose dc] dc open cost ".concat(l,"ms")),this._reliableTransmission=new Ik((t=>{var e;this._transmitter&&"open"===this._transmitter.readyState&&(null===(e=this._transmitter)||void 0===e||e.send(t))}),(t=>{"string"==typeof t&&this.emit(bC.ON_MESSAGE,t)})),this._closeEstablishingTransmitter=()=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.close(),this._reliableTransmission=void 0,d()},s&&s(),n.onclose=o,n.onmessage=r,null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this._joinChannelServiceRecordIndex=a})).catch((t=>{var e;if(null===(e=this._store)||void 0===e||e.recordJoinChannelService({endTs:Date.now(),status:t instanceof Uy&&t.code===U_.WS_ABORT?"aborted":"error",errors:[t]},a),"closed"!==this.state){if(t instanceof Uy&&t.code===U_.WS_ERR){const e=new Uy(U_.WS_ERR,"init datachannel failed! Error: ".concat(t.toString()));return $b.error("[".concat(this._name,"]").concat(e)),void i(e)}o&&o(t)}else i(new Uy(U_.WS_DISCONNECT,"datachannel is closed: ".concat(t.toString())))}))}))}async reconnectWithAction(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||TE.networkState!==hE.OFFLINE||(this._onlineReconnectListener=TE.onlineWaiter&&TE.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},e){const e=YE(this._reconnectCount,this._retryConfig);$b.debug("[".concat(this._name,"] wait ").concat(e,"ms to reconnect datachannel, mode: ").concat(t)),await e_.race([xE(e),this._onlineReconnectListener||new e_((()=>{}))])}if("closed"===this.state||!i)return!1;this._reconnectCount+=1;const n=async(t,e)=>{this.emit(bC.RECONNECT_CREATE_CONNECTION,e),await this.createTransmitterConnection(t)};try{if("retry"===t){const e=this._addresses[this.currentURLIndex];this.emit(bC.RECONNECT_WAITTING_FINISH,t),await n(e,t)}else if("tryNext"===t){this.currentURLIndex+=1;for(let t=this.currentURLIndex;t<this._addresses.length;t++){if(this._addresses[t].fingerprint||Db("FINGERPRINT")){this.currentURLIndex=t;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return $b.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);$b.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const e=this._addresses[this.currentURLIndex];this.emit(bC.RECONNECT_WAITTING_FINISH,t),await n(e,t)}else"recover"===t&&($b.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(bC.RECONNECT_WAITTING_FINISH,t),this.emit(bC.FAILBACK));return!0}catch(i){var s,o;return $b.error("[".concat(this._name,"] reconnect failed"),i.toString()),null!=i&&null!==(s=i.data)&&void 0!==s&&s.desc&&Array.isArray(i.data.desc)&&i.data.desc.length&&Ps(o=i.data.desc).call(o,"dynamic key expired")?(this.emit(bC.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,e)}}}class Ok extends iE{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===vy.CONNECTED?this.emit(_y.WS_CONNECTED):t===vy.RECONNECTING?this.emit(_y.WS_RECONNECTING,this._websocketReconnectReason):t===vy.CLOSED&&this.emit(_y.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),nu(this,"_disconnectedReason",void 0),nu(this,"_websocketReconnectReason",void 0),nu(this,"_connectionState",vy.CLOSED),nu(this,"reconnectToken",void 0),nu(this,"websocket",void 0),nu(this,"openConnectionTime",void 0),nu(this,"clientId",void 0),nu(this,"lastMsgTime",Date.now()),nu(this,"uploadCache",[]),nu(this,"uploadCacheInterval",void 0),nu(this,"rttRolling",new dS(5)),nu(this,"pingpongTimer",void 0),nu(this,"inflateDataTimer",void 0),nu(this,"pingpongTimeoutCount",0),nu(this,"joinResponse",void 0),nu(this,"multiIpOption",void 0),nu(this,"initError",void 0),nu(this,"spec",void 0),nu(this,"store",void 0),nu(this,"onWebsocketMessage",(t=>{if(t instanceof ArrayBuffer)return void this.emit(_y.ON_BINARY_DATA,t);const e=JSON.parse(t);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(e,"_id")){const t="res-@".concat(e._id);this.emit(t,e._result,e._message)}else if(Object.prototype.hasOwnProperty.call(e,"_type")&&(this.emit(e._type,e._message),e._type===Ty.ON_NOTIFICATION&&this.handleNotification(e._message),e._type===Ty.ON_USER_BANNED))switch(e._message.error_code){case 14:this.close(cE.UID_BANNED);break;case 15:this.close(cE.IP_BANNED);break;case 16:this.close(cE.CHANNEL_BANNED)}})),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new Ak("gateway-".concat(this.clientId),this.spec.retryConfig,!0,e),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===vy.CONNECTED&&this.reconnect("retry",TC.OFFLINE)}))}async request(t,e,i,n){const s=UE(6,""),o={_id:s,_type:t,_message:e},r=this.websocket.connectionID,a=()=>new e_(((e,i)=>{if(this.connectionState===vy.CONNECTED)return e();const n=()=>{this.off(_y.WS_CLOSED,s),e()},s=()=>{this.off(_y.WS_CONNECTED,n),i(new Uy(U_.WS_ABORT))};this.once(_y.WS_CONNECTED,n),this.once(_y.WS_CLOSED,s),t!==Ey.PUBLISH&&t!==Ey.SUBSCRIBE&&t!==Ey.UNSUBSCRIBE&&t!==Ey.UNPUBLISH&&t!==Ey.CONTROL&&t!==Ey.RESTART_ICE||this.once(_y.DISCONNECT_P2P,(()=>{i(new Uy(U_.DISCONNECT_P2P))})),t!==Ey.PUBLISH&&t!==Ey.RESTART_ICE||this.once(_y.ABORT_P2P_EXECUTION,(()=>{i(new Uy(U_.DISCONNECT_P2P))}))}));if(this.connectionState!==vy.CONNECTING&&this.connectionState!==vy.RECONNECTING||t===Ey.JOIN||t===Ey.REJOIN||await a(),t===Ey.LEAVE&&(this.websocket.unbindDcCloseEventListener(),n=!0),this.websocket.sendMessage(o,!0,!1),n)return;const c=new e_(((i,n)=>{let o=!1;const a=(n,s)=>{o=!0,i({isSuccess:"success"===n,message:s||{}}),this.off(_y.WS_CLOSED,c),this.off(_y.WS_RECONNECTING,c),this.emit(_y.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),a);const c=()=>{n(new Uy(U_.WS_ABORT,"type: ".concat(t))),this.off(_y.WS_CLOSED,c),this.off(_y.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once(_y.WS_CLOSED,c),this.once(_y.WS_RECONNECTING,c),xE(Db("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||o||($b.warning("dc request timeout, type: ".concat(t)),this.emit(_y.REQUEST_TIMEOUT,t,e))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===vy.CLOSED||t===Ey.LEAVE)throw new Uy(U_.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():t===Ey.JOIN||t===Ey.REJOIN?null:(await a(),await this.request(t,e))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=xC(l),u=new Uy(U_.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:($b.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===fy.ERR_TOO_MANY_BROADCASTERS?t===Ey.JOIN||t===Ey.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===fy.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,$b.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",TC.MULTI_IP)):this.reconnect(h.action,TC.SERVER_ERROR),t===Ey.JOIN||t===Ey.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new e_((i=>{const n=s=>{(!e||e(s))&&(this.off(t,n),i(s))};this.on(t,n)}))}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch(t){const e=Db("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>e&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==vy.CONNECTED)return;const t=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(t._type,t._message)}),Db("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new e_(((i,n)=>{this.once(_y.WS_CONNECTED,(()=>i(this.joinResponse))),this.once(_y.WS_CLOSED,(()=>n(this.initError||new Uy(U_.WS_ABORT)))),this.connectionState=vy.CONNECTING,this.websocket.init(t).catch(n),this.websocket.once(bC.FAILBACK,(()=>{void 0===this.openConnectionTime&&n(new Uy(U_.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{e&&void 0===this.openConnectionTime&&($b.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),n(new Uy(U_.INIT_DATACHANNEL_TIMEOUT)))}),Db("DC_JOIN_WITH_FAILBACK"))}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||cE.LEAVE,this.connectionState=vy.CLOSED,$b.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===cE.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Ak("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(_y.ABORT_P2P_EXECUTION);const t=await vE(this,_y.DATACHANNEL_CONNECTING),e=await this.request(Ey.JOIN,t);if(!e)return this.emit(_y.REPORT_JOIN_GATEWAY,U_.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(_y.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=vy.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Uy(U_.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=SE(this,_y.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(Ey.REJOIN,t);return!!e&&(this.connectionState=vy.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach((t=>{this.emit(Ty.ON_USER_ONLINE,{uid:t.uid}),t.audio&&this.emit(Ty.ON_ADD_AUDIO_STREAM,{uid:t.uid,uint_id:t.uint_id,audio:!0,ssrcId:t.audio_ssrc}),t.video&&this.emit(Ty.ON_ADD_VIDEO_STREAM,{uid:t.uid,uint_id:t.uint_id,video:!0,ssrcId:t.video_ssrc}),t.audio_mute?this.emit(Ty.MUTE_AUDIO,{uid:t.uid}):this.emit(Ty.UNMUTE_AUDIO,{uid:t.uid}),t.video_mute?this.emit(Ty.MUTE_VIDEO,{uid:t.uid}):this.emit(Ty.UNMUTE_VIDEO,{uid:t.uid}),t.audio_enable_local?this.emit(Ty.ENABLE_LOCAL_AUDIO,{uid:t.uid}):this.emit(Ty.DISABLE_LOCAL_AUDIO,{uid:t.uid}),t.video_enable_local?this.emit(Ty.ENABLE_LOCAL_VIDEO,{uid:t.uid}):this.emit(Ty.DISABLE_LOCAL_VIDEO,{uid:t.uid}),t.audio||t.video||this.emit(Ty.ON_REMOVE_STREAM,{uid:t.uid,uint_id:t.uint_id})})),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){$b.debug("[".concat(this.clientId,"] receive notification: "),t);const e=xC(t.code);if("success"!==e.action){if("failed"!==e.action)return"quit"===e.action?("ERR_REPEAT_JOIN_CHANNEL"===e.desc&&this.close(cE.UID_BANNED),void this.close()):void this.reconnect(e.action,TC.SERVER_ERROR);$b.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=Db("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&($b.warning("PINGPONG Timeout. Last Socket Message: ".concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>Db("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",TC.TIMEOUT):this.request(Ey.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const t=Date.now()-e;this.rttRolling.add(t),Db("REPORT_STATS")&&this.send(Ey.PING_BACK,{pingpongElapse:t})})).catch((t=>{}))}handleInflateData(){const{inflateLength:t,deflateLength:e}=this.websocket.getInflateData();0!==t&&0!==e&&this.upload(Sy.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(bC.RECONNECT_WAITTING_FINISH,(t=>{this.emit(_y.WS_RECONNECT_WAITTING_FINISH,t)})),this.websocket.on(bC.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(_y.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(bC.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(bC.CLOSED,(()=>{this.connectionState=vy.CLOSED})),this.websocket.on(bC.FAILED,(()=>{this._disconnectedReason=cE.NETWORK_ERROR,this.connectionState=vy.CLOSED})),this.websocket.on(bC.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===vy.CONNECTED?this.connectionState=vy.RECONNECTING:this.connectionState=vy.CONNECTING})),this.websocket.on(bC.WILL_RECONNECT,((t,e)=>{if(SE(this,_y.IS_P2P_DISCONNECTED)&&"retry"===t)return $b.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(_y.NEED_RENEW_SESSION),this.emit(_y.DISCONNECT_P2P),e("tryNext");"retry"!==t&&($b.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(_y.NEED_RENEW_SESSION),this.emit(_y.DISCONNECT_P2P)),e(t)})),this.websocket.on(bC.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{$b.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",TC.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(_y.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof Uy&&t.code===U_.UNEXPECTED_RESPONSE&&t.data.code===fy.ERR_NO_AUTHORIZED)return $b.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",TC.SERVER_ERROR);$b.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",TC.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(bC.REQUEST_NEW_URLS,((t,e)=>{vE(this,_y.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)})),this.websocket.on(bC.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Ty.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(bC.TO_CONNECT_DATACHANNEL,(async(t,e,i)=>vE(this,_y.DATACHANNEL_PRECONNECT,t).then(e).catch(i))),this.websocket.on(bC.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(_y.DATACHANNEL_FAILBACK)}))}}class Nk extends iE{constructor(t){super(),nu(this,"_signal",void 0),nu(this,"_sequence",0),nu(this,"_userMap",new Map),nu(this,"_encoder",new TextEncoder),this._signal=t}async send(t,e,i,n,s){var o,r,a;"string"!=typeof e&&(e=JSON.stringify(e)),n=null!==(o=n)&&void 0!==o?o:UE(6,""),s=null!==(r=s)&&void 0!==r?r:this._sequence++;const c={_id:n,_type:t,_seq:null!==(a=s)&&void 0!==a?a:this._sequence++,_message:e};if(Db("SHOW_P2P_LOG")&&$b.debug("send message",c),this.sendStreamMessage(JSON.stringify(c)),i)return;const d=new e_(((e,i)=>{const s=window.setTimeout((()=>{this.off("res-@".concat(n),o),$b.warning("[external-signal] request timeout, type: ".concat(t)),0===this._userMap.size?i(new V_(U_.INVALID_REMOTE_USER)):i(new V_(U_.TIMEOUT))}),Db("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),o=(t,n)=>{s&&window.clearTimeout(s),"success"===t?e({isSuccess:!0,message:n}):i(new V_(U_.UNEXPECTED_ERROR,n))};this.once("res-@".concat(n),o)}));let l;try{l=await d}catch(i){if(i.code===U_.TIMEOUT)return await this.send(t,e,!1,n,s);throw i}return l.isSuccess?l.message:void 0}sendStreamMessage(t){this._splitMessage(t).forEach((t=>{this._signal.request(Ey.DATA_STREAM,{payload:LE(this._encoder.encode(t))})}))}onMessage(t){const{_uid:e}=t;let i;const n=this._userMap.get(e);if(n?i=n.splitMessageMap:(i=new Map,this._userMap.set(e,{isStart:!1,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map})),"id"in t&&"total"in t){var s;const{id:n,total:o}=t,r=null!==(s=i.get(n))&&void 0!==s?s:[];if(r.push(t),i.has(n)||i.set(n,r),r.length!==o)return;{const s=Zu(r).call(r,((t,e)=>t.index-e.index)).map((t=>t.payload)).join("");i.delete(n),(t=JSON.parse(s))._uid=e}}this.handleReceivedMessage(t)}setStart(t){this._userMap.has(t)?this._userMap.get(t).isStart=!0:this._userMap.set(t,{isStart:!0,splitMessageMap:new Map,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map}),this.handleReceivedMessage()}setEnd(t){return this._userMap.delete(t),0===this._userMap.size}ack(t,e,i){this.send(AC.ACK,JSON.stringify({success:!i,message:e}),!0,t)}handleReceivedMessage(t){const e=()=>{this._userMap.forEach((t=>{const{receivedMessagesMap:e,nextExpectedSequenceNumber:i}=t;for(;e.has(i);){const n=e.get(i);e.delete(i),this.receiveMessage(n),t.nextExpectedSequenceNumber++}}))};if(!t)return void e();const{_uid:i,_seq:n}=t,s=this._userMap.get(i),{receivedMessagesMap:o,isStart:r,nextExpectedSequenceNumber:a}=s;n<a?$b.debug("[external-signal] receive old message, seq: ".concat(n)):(o.set(n,t),r&&n===a&&(this.receiveMessage(t),o.delete(a),s.nextExpectedSequenceNumber++,e()))}receiveMessage(t){const{_id:e,_type:i,_message:n,_uid:s}=t;if(Db("SHOW_P2P_LOG")&&$b.debug("收到消息",t),e)switch(t._type){case AC.PUBLISH:const o=JSON.parse(n);this._signal.emit(i,o,s),this.ack(t._id);break;case AC.CONTROL:case AC.UNPUBLISH:case AC.DO_SUBSCRIBE:case AC.DO_UNSUBSCRIBE:{const e=JSON.parse(n);e.uid=s,vE(this._signal,i,e).then((e=>{this.ack(t._id,e)})).catch((e=>{this.ack(t._id,void 0,!0)}));break}case AC.ACK:{const{success:t,message:i}=JSON.parse(n);this.emit("res-@".concat(e),t?"success":"failed",i);break}case AC.CALL:vE(this,i,n).then((t=>{this.ack(e,t)}));break;case AC.RESTART_ICE:case AC.EXCHANGE_SDP:case AC.SUBSCRIBE:case AC.UNSUBSCRIBE:vE(this._signal,i,n).then((t=>{this.ack(e,t)})).catch((e=>{this.ack(t._id,void 0,!0)}));break;case AC.CANDIDATE:this._signal.emit(i,n),this.ack(e);break;case AC.JOIN:this.emit(i,JSON.parse(n));break;default:this.emit(i,n),this.ack(e)}}_splitMessage(t){if(t.length<Nk.MAX_MESSAGE_SIZE)return[t];const e=[],i=UE(6,"");let n=0;const s=Math.ceil(t.length/800);for(;t.length>0;){n++;const o=t.slice(0,800);e.push({id:i,index:n,total:s,payload:o}),t=t.slice(800)}return e.map((t=>JSON.stringify(t)))}clear(){this._sequence=0,this._userMap.clear()}}nu(Nk,"MAX_MESSAGE_SIZE",1024);class kk extends iE{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===vy.CONNECTED?this.emit(_y.WS_CONNECTED):t===vy.RECONNECTING?this.emit(_y.WS_RECONNECTING,this._websocketReconnectReason):t===vy.CLOSED&&this.emit(_y.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),nu(this,"_disconnectedReason",void 0),nu(this,"_websocketReconnectReason",void 0),nu(this,"_connectionState",vy.CLOSED),nu(this,"reconnectToken",void 0),nu(this,"_userInRoom",!1),nu(this,"_userOnlineTime",void 0),nu(this,"websocket",void 0),nu(this,"openConnectionTime",void 0),nu(this,"clientId",void 0),nu(this,"lastMsgTime",Date.now()),nu(this,"uploadCache",[]),nu(this,"uploadCacheInterval",void 0),nu(this,"rttRolling",new dS(5)),nu(this,"pingpongTimer",void 0),nu(this,"wsInflateDataTimer",void 0),nu(this,"pingpongTimeoutCount",0),nu(this,"joinResponse",void 0),nu(this,"multiIpOption",void 0),nu(this,"initError",void 0),nu(this,"spec",void 0),nu(this,"store",void 0),nu(this,"_external_signal",void 0),nu(this,"onWebsocketMessage",(t=>{if(t.data instanceof ArrayBuffer)return void this.emit(_y.ON_BINARY_DATA,t.data);const e=JSON.parse(t.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(e,"_id")){const t="res-@".concat(e._id);this.emit(t,e._result,e._message)}else if(Object.prototype.hasOwnProperty.call(e,"_type")){switch(e._type){case Ty.ON_DATA_STREAM:return void this.handleDataStream(e._message);case Ty.MUTE_AUDIO:case Ty.MUTE_VIDEO:case Ty.ON_P2P_LOST:return;case Ty.ON_USER_ONLINE:this.emit(e._type,e._message);const{uid:t}=e._message;return this._external_signal.setStart(t),void this._external_signal.send(AC.JOIN,{onlineTime:this._userOnlineTime},!0)}if(this.emit(e._type,e._message),e._type===Ty.ON_NOTIFICATION&&this.handleNotification(e._message),e._type===Ty.ON_USER_BANNED)switch(e._message.error_code){case 14:this.close(cE.UID_BANNED);break;case 15:this.close(cE.IP_BANNED);break;case 16:this.close(cE.CHANNEL_BANNED)}if(e._type===Ty.ON_USER_LICENSE_BANNED)switch(e._message.error_code){case fy.ERR_LICENSE_MISSING:this.close(cE.LICENSE_MISSING);break;case fy.ERR_LICENSE_EXPIRED:this.close(cE.LICENSE_EXPIRED);break;case fy.ERR_LICENSE_MINUTES_EXCEEDED:this.close(cE.LICENSE_MINUTES_EXCEEDED);break;case fy.ERR_LICENSE_PERIOD_INVALID:this.close(cE.LICENSE_PERIOD_INVALID);break;case fy.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(cE.LICENSE_MULTIPLE_SDK_SERVICE);break;case fy.ERR_LICENSE_ILLEGAL:this.close(cE.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new YC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Db("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Db("JOIN_GATEWAY_USE_443PORT_ONLY"),e),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===vy.CONNECTED&&this.reconnect("retry",lE.OFFLINE)})),this._external_signal=new Nk(this),this._handleSignalP2PEvents()}async request(t,e,i,n){const s=UE(6,""),o={_id:s,_type:t,_message:e},r=this.websocket.connectionID,a=()=>new e_(((e,i)=>{if(this.connectionState===vy.CONNECTED)return e();const n=()=>{this.off(_y.WS_CLOSED,s),e()},s=()=>{this.off(_y.WS_CONNECTED,n),i(new V_(U_.WS_ABORT))};this.once(_y.WS_CONNECTED,n),this.once(_y.WS_CLOSED,s),t!==Ey.PUBLISH&&t!==Ey.SUBSCRIBE&&t!==Ey.UNSUBSCRIBE&&t!==Ey.UNPUBLISH&&t!==Ey.CONTROL&&t!==Ey.RESTART_ICE||this.once(_y.DISCONNECT_P2P,(()=>{i(new V_(U_.DISCONNECT_P2P))})),t!==Ey.PUBLISH&&t!==Ey.RESTART_ICE||this.once(_y.ABORT_P2P_EXECUTION,(()=>{i(new V_(U_.DISCONNECT_P2P))}))}));if(this.connectionState!==vy.CONNECTING&&this.connectionState!==vy.RECONNECTING||t===Ey.JOIN||t===Ey.REJOIN||await a(),this.websocket.sendMessage(o,!0),n)return;const c=new e_(((i,n)=>{let o=!1;const a=(n,s)=>{o=!0,i({isSuccess:"success"===n,message:s||{}}),this.off(_y.WS_CLOSED,c),this.off(_y.WS_RECONNECTING,c),this.emit(_y.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),a);const c=()=>{n(new V_(U_.WS_ABORT,"type: ".concat(t))),this.off(_y.WS_CLOSED,c),this.off(_y.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once(_y.WS_CLOSED,c),this.once(_y.WS_RECONNECTING,c),xE(Db("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||o||($b.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(_y.REQUEST_TIMEOUT,t,e))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===vy.CLOSED||t===Ey.LEAVE)throw new V_(U_.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():t===Ey.JOIN||t===Ey.REJOIN?null:(await a(),await this.request(t,e))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=xC(l),u=new V_(U_.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:($b.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===fy.ERR_TOO_MANY_BROADCASTERS?t===Ey.JOIN||t===Ey.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===fy.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,$b.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",lE.MULTI_IP)):this.reconnect(h.action,lE.SERVER_ERROR),t===Ey.JOIN||t===Ey.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new e_((i=>{const n=s=>{(!e||e(s))&&(this.off(t,n),i(s))};this.on(t,n)}))}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch(t){const e=Db("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>e&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==vy.CONNECTED)return;const t=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(t._type,t._message)}),Db("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}async sendExtensionMessage(t,e,i){return await this.waitTillUserOnline(),await this._external_signal.send(t,e,i)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new e_(((e,i)=>{this.once(_y.WS_CONNECTED,(()=>e(this.joinResponse))),this.once(_y.WS_CLOSED,(()=>i(this.initError||new V_(U_.WS_ABORT)))),this.connectionState=vy.CONNECTING,this.websocket.init(t).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||cE.LEAVE,this.connectionState=vy.CLOSED,$b.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===cE.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new YC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Db("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Db("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(_y.ABORT_P2P_EXECUTION);const t=await vE(this,_y.REQUEST_JOIN_INFO),e=await this.request(Ey.JOIN,t);if(!e)return this.emit(_y.REPORT_JOIN_GATEWAY,U_.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(_y.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=vy.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),this._userOnlineTime=(new Date).getTime(),this._external_signal.clear(),!0}async rejoin(){if(!this.reconnectToken)throw new V_(U_.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=SE(this,_y.REQUEST_REJOIN_INFO);return t.token=this.reconnectToken,!!await this.request(Ey.REJOIN,t)&&(this.connectionState=vy.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleDataStream(t){try{var e;const i=kE(t.payload),n=(new TextDecoder).decode(i),s=JSON.parse(n);"total"in s&&"id"in s||Ps(e=Object.values(AC)).call(e,s._type)?(t.seq&&delete t.seq,s._uid=t.uid,this._external_signal.onMessage(s)):this.emit(Ty.ON_DATA_STREAM,t)}catch(t){}}handleNotification(t){$b.debug("[".concat(this.clientId,"] receive notification: "),t);const e=xC(t.code);if("success"!==e.action){if("failed"!==e.action)return"quit"===e.action?("ERR_REPEAT_JOIN_CHANNEL"===e.desc&&this.close(cE.UID_BANNED),void this.close()):void this.reconnect(e.action,lE.SERVER_ERROR);$b.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=Db("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&($b.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>Db("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",lE.TIMEOUT):this.request(Ey.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const t=Date.now()-e;this.rttRolling.add(t),Db("REPORT_STATS")&&this.send(Ey.PING_BACK,{pingpongElapse:t})})).catch((t=>{}))}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:e}=this.websocket.getWsInflateData();0!==t&&0!==e&&this.upload(Sy.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(Cy.RECONNECT_WAITTING_FINISH,(t=>{this.emit(_y.WS_RECONNECT_WAITTING_FINISH,t)})),this.websocket.on(Cy.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(_y.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(Cy.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Cy.CLOSED,(()=>{this.connectionState=vy.CLOSED})),this.websocket.on(Cy.FAILED,(()=>{this._disconnectedReason=cE.NETWORK_ERROR,this.connectionState=vy.CLOSED})),this.websocket.on(Cy.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===vy.CONNECTED?this.connectionState=vy.RECONNECTING:this.connectionState=vy.CONNECTING})),this.websocket.on(Cy.WILL_RECONNECT,((t,e,i)=>{if(SE(this,_y.IS_P2P_DISCONNECTED)&&"retry"===t)return $b.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(_y.NEED_RENEW_SESSION),this.emit(_y.DISCONNECT_P2P),i("tryNext");"retry"!==t&&($b.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(_y.NEED_RENEW_SESSION),this.emit(_y.DISCONNECT_P2P)),i(t)})),this.websocket.on(Cy.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{$b.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",lE.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(_y.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof V_&&t.code===U_.UNEXPECTED_RESPONSE&&t.data.code===fy.ERR_NO_AUTHORIZED)return $b.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",lE.SERVER_ERROR);$b.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",lE.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(Cy.REQUEST_NEW_URLS,((t,e)=>{vE(this,_y.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)})),this.websocket.on(Cy.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Ty.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}_handleSignalP2PEvents(){this._external_signal.on(AC.JOIN,(async t=>{if(this._userOnlineTime&&this._userOnlineTime<t.onlineTime){const t=await vE(this,_y.P2P_START,void 0),e=await this._external_signal.send(AC.CALL,t);this.emit(_y.P2P_CONNECTION,e,!0)}this._userInRoom=!0,this.emit("user-online")})),this.on(Ty.ON_USER_OFFLINE,(async t=>{this._external_signal.clear(),this._userInRoom=!1})),this._external_signal.on(AC.CALL,(async(t,e,i)=>{this._userInRoom=!0,this.emit("user-online");try{e(await vE(this,_y.P2P_START,t))}catch(t){i(t)}}))}async waitTillUserOnline(){return new e_((t=>{if(this._userInRoom)t();else{const e=()=>{this.off("user-online",e),t()};this.on("user-online",e)}}))}}function Lk(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Pk(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Lk(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Lk(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}const Dk=new Map;class Mk extends iE{get state(){return this._state}set state(t){if(t===this._state)return;const e=this._state;this._state=t,"DISCONNECTED"===t&&this._disconnectedReason?this.emit(tC.CONNECTION_STATE_CHANGE,t,e,this._disconnectedReason):this.emit(tC.CONNECTION_STATE_CHANGE,t,e)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){$b.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,e){super(),nu(this,"store",void 0),nu(this,"joinInfo",void 0),nu(this,"key",void 0),nu(this,"ntpOffset",0),nu(this,"signal",void 0),nu(this,"role",void 0),nu(this,"inChannelInfo",{joinAt:null,duration:0}),nu(this,"spec",void 0),nu(this,"_state","DISCONNECTED"),nu(this,"_statsCollector",void 0),nu(this,"_disconnectedReason",void 0),nu(this,"isSignalRecover",!1),nu(this,"hasChangeBGPAddress",!1),nu(this,"trafficStatsInterval",void 0),nu(this,"networkQualityInterval",void 0),nu(this,"_joinGatewayStartTime",0),nu(this,"_signalTimeout",!1),nu(this,"_clientRoleOptions",void 0),nu(this,"_isProactiveJoin",!1),this.store=t,this.spec=e,this.signal=this.store.useP2P?new kk(Pk(Pk({},e),{},{retryConfig:e.websocketRetryConfig}),t):this.store.useDataChannel?new Ok(Pk(Pk({},e),{},{retryConfig:e.websocketRetryConfig}),t):new XC(Pk(Pk({},e),{},{retryConfig:e.websocketRetryConfig}),t),this._statsCollector=e.statsCollector,this.role=e.role||"audience",this._clientRoleOptions=e.clientRoleOptions,this.handleSignalEvents()}async join(t,e,i){if(this.signal instanceof Ok){let e=!1;"disabled"!==t.cloudProxyServer?($b.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),e=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?($b.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),e=!0):t.apResponse.addresses.some((t=>t.fingerprint))||Db("FINGERPRINT")||($b.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),e=!0),e&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==t.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const n=Date.now();let s=Dk.get(t.cname);if(s||(s=new Map,Dk.set(t.cname,s)),this._isProactiveJoin=!0,s.has(t.uid)){const e=new Uy(U_.UID_CONFLICT);throw sy.joinGateway(t.sid,{lts:n,succ:!1,ec:e.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof Ok?"1":"0"}),this._isProactiveJoin=!1,e}s.set(t.uid,!0),this.joinInfo=t,this.key=e;let o=0;this.joinGatewayStartTime=n;const r=t.proxyServer;try{let e;if($b.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Ok?"datachannel":"websocket"," join uid ").concat(o)),this.signal instanceof Ok)e=await this.signal.init(t.apResponse.addresses,i);else{const n=t.gatewayAddrs.map((e=>{let{address:i}=e;const[n,s]=i.split(":"),o={host:n,port:s};return t.proxyServer&&(o.proxy=t.proxyServer),o}));e=await this.signal.init(n,i)}o=e.uid,$b.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Ok?"datachannel":"websocket"," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(e){if(e&&e.code===U_.INIT_WEBSOCKET_TIMEOUT)throw $b.warning("[".concat(this.store.clientId,"] User join failed"),e.toString()),e;if(e&&e.code===U_.INIT_DATACHANNEL_TIMEOUT)throw $b.warning("[".concat(this.store.clientId,"] User join datachannel failed"),e.toString()),this.resetSignal(),e;throw $b.error("[".concat(this.store.clientId,"] User join failed"),e.toString()),sy.joinGateway(t.sid,{lts:n,succ:!1,ec:e.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!r,signalChannel:this.signal instanceof Ok?"1":"0"}),this._isProactiveJoin=!1,s.delete(t.uid),this.signal.close(),e}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),$b.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((t=>{$b.warning("[".concat(this.store.clientId,"] get traffic stats error"),t.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(tC.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(tC.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(tC.NETWORK_QUALITY,{uplinkNetworkQuality:Ek(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Ek(this._statsCollector.trafficStats.B_dnq)}):this.emit(tC.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),o}async leave(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){e!==cE.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==vy.CONNECTED||await function(t,e){return e===1/0?t:e_.race([t,ME(e)])}(this.signal.request(Ey.LEAVE,void 0,!0),3e3)}catch(t){$b.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),t)}this.signal.close(e),e!==cE.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const n={state:"offer",p2p_id:this.store.p2pId,ortc:e,mode:this.spec.mode,extend:Db("PUB_EXTEND"),twcc:!!Db("PUBLISH_TWCC"),rtx:!!Db("USE_PUB_RTX")};try{return(await this.signal.request(Ey.PUBLISH,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===fy.ERR_PUBLISH_REQUEST_INVALID)return $b.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),n.toString()),await this.tryUnpubBeforeRepub(t,e),this.publish(t,e,!1);throw n}}async publishDataChannel(t,e,i){var n;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:e.streamId,ordered:e.ordered?1:0,max_retrans_times:null!==(n=e.maxRetransmits)&&void 0!==n?n:10,channel_id:e.channelId,metadata:e.metadata};try{await this.signal.request(Ey.PUBLISH_DATASTREAM,s,!0)}catch(n){if(i&&n.data&&n.data.code===fy.ERR_PUBLISH_REQUEST_INVALID)return $b.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),n.toString()),await this.tryUnpubDataChannelBeforeRepub(t,e),this.publishDataChannel(t,e,!1);throw n}}async unpublish(t,e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Ey.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(t){$b.warning("[".concat(this.store.clientId,"] unpublish warning: "),t)}}async unpublishDataChannel(t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await e_.all(t.map((t=>this.signal.request(Ey.UNPUBLISH_DATASTREAM,{channel_id:t},!0))))}catch(t){$b.warning("unpublish datachannels warning: ",t)}}async subscribe(t,e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const n={stream_id:t,stream_type:e.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Db("SUBSCRIBE_TWCC"),rtx:!!Db("USE_SUB_RTX"),extend:Db("SUB_EXTEND"),ssrcId:e.ssrcId,svc:Array.isArray(Db("SVC"))&&0!==Db("SVC").length?Db("SVC"):void 0};try{return(await this.signal.request(Ey.SUBSCRIBE,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===fy.ERR_SUBSCRIBE_REQUEST_INVALID)return $b.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),n.toString()),await this.tryUnsubBeforeResub(t,e),await this.subscribe(t,e,!1);throw n}}async subscribeDataChannel(t,e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const n={uid:t,stream_id:e.id,channel_id:e.datachannelId};try{return void await this.signal.request(Ey.SUBSCRIBE_DATASTREAM,n,!0)}catch(n){if(i&&n.data&&n.data.code===fy.ERR_SUBSCRIBE_REQUEST_INVALID)return $b.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),n.toString()),await this.tryUnsubDataChannelBeforeResub(t,e),await this.subscribeDataChannel(t,e,!1);throw n}}async subscribeAll(t,e){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!Db("USE_SUB_RTX")};try{return await this.signal.request(Ey.SUBSCRIBE_STREAMS,i,!0)}catch(i){if(e&&i.data&&i.data.code===fy.ERR_SUBSCRIBE_REQUEST_INVALID)return $b.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),i.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw i}}async setVideoProfile(t){const e=function(t){if(!(t.bitrateMax&&t.bitrateMin&&t.frameRate&&t.height&&t.width))return;let e=t.frameRate,i=t.width,n=t.height,s=!0;return"number"!=typeof e&&(e=e.exact||e.ideal||e.max||e.min||0,e||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,e||(s=!1)),s?{stream_type:0,width:i,height:n,fps:e,start_bps:1e3*t.bitrateMax,min_bps:1e3*t.bitrateMin,target_bps:1e3*t.bitrateMax}:void 0}(t);if(e)return this.signal.request(Ey.SET_VIDEO_PROFILE,e);$b.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,e){try{await this.signal.request(Ey.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:e},!0)}catch(t){$b.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),t)}}async unsubscribeDataChannel(t,e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Uy(U_.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await e_.all(t.map((t=>this.signal.request(Ey.UNSUBSCRIBE_DATASTREAM,{stream_id:t,uid:e},!0))))}catch(t){$b.warning("unsubscribeDataChannel warning: ",t)}}async massUnsubscribe(t){try{await this.signal.request(Ey.UNSUBSCRIBE_STREAMS,t,!0)}catch(t){$b.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),t)}}async reconnectPC(t){const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=t;return{gatewayEstablishParams:await this.signal.request(Ey.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Ey.GATEWAY_INFO)}async renewToken(t){await this.signal.request(Ey.RENEW_TOKEN,t),this.key=t.token}async setClientRole(t,e){if(e&&(this._clientRoleOptions=Object.assign({},e)),"CONNECTED"!==this.state)return void(this.role=t);let i,n=0;"audience"===t?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(Ey.SET_CLIENT_ROLE,{role:t,level:n,delay:i,client_ts:Date.now()}),this.role=t}async setRemoteVideoStreamType(t,e){await this.signal.request(Ey.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:e})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(Ey.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,e){await this.signal.request(Ey.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:e})}async pickSVCLayer(t,e){await this.signal.request(Ey.PICK_SVC_LAYER,{stream_id:t,spatial_layer:e.spatialLayer,temporal_layer:e.temporalLayer})}async setRTM2Flag(t){await this.signal.request(Ey.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,e,i){if(this.signal instanceof kk)return this.signal.sendExtensionMessage(t,e,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Pk({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(Ey.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=Dk.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(t){let e;return e=t.startsWith("dc")?t.match(/(dc\:\/\/)?([^:]+):(\d+)/):t.match(/(wss\:\/\/)?([^:]+):(\d+)/),e?{username:ry.username,password:ry.password,turnServerURL:e[2],tcpport:parseInt(e[3])+30,udpport:parseInt(e[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(Pk(Pk({},ry),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const t=await this.signal.request(Ey.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),null!=t.ntp_offset&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach((t=>{const e=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((e=>e.peer_uid===t.peer_uid));e&&e.B_st!==t.B_st&&RE((()=>{this.emit(tC.STREAM_TYPE_CHANGE,t.peer_uid,t.B_st)}))})),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){if(!this.joinInfo||!this.key)throw new Uy(U_.UNEXPECTED_ERROR,"can not generate join message, no join info");const e=Object.assign({},this.joinInfo.apResponse);let i=Db("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(t){i=void 0}i&&i.length>128&&(i=void 0);const n=Pk({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Ob,browser:navigator.userAgent,process_id:Db("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:e,extend:Db("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:Db("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:Db("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof Db("SUBSCRIBE_AUDIO_FILTER_TOPN")?Db("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof Db("ENABLE_PUBLISH_AUDIO_FILTER")?Db("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof Db("ENABLE_USER_LICENSE_CHECK")?Db("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===Db("USE_PUB_RTX")||!0===Db("USE_SUB_RTX")||void 0,disableFEC:Db("DISABLE_FEC"),enableNTPReport:!!Db("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!Db("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof Db("ENABLE_DATASTREAM_2")?Db("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof Db("RTM2_FLAG")?Db("RTM2_FLAG"):void 0,enableUserAutoRebalanceCheck:!!Db("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:"boolean"==typeof Db("USE_XR")?Db("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,Db("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),e.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=e.addresses[this.signal.websocket.currentURLIndex].ticket,delete e.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new Uy(U_.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(_y.WS_RECONNECT_WAITTING_FINISH,(t=>{var e;Ps(e=["tryNext","recover"]).call(e,t)&&this.joinInfo&&sy.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(_y.WS_RECONNECT_CREATE_CONNECTION,(t=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(_y.WS_RECONNECTING,(t=>{this.joinInfo&&sy.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||lE.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",sy.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(_y.WS_CLOSED,(t=>{let e;switch(t){case cE.LEAVE:e=lE.LEAVE;break;case cE.UID_BANNED:case cE.IP_BANNED:case cE.CHANNEL_BANNED:case cE.SERVER_ERROR:e=lE.SERVER_ERROR;break;case cE.FALLBACK:e=lE.FALLBACK;break;case cE.LICENSE_MISSING:case cE.LICENSE_EXPIRED:case cE.LICENSE_MINUTES_EXCEEDED:case cE.LICENSE_PERIOD_INVALID:case cE.LICENSE_MULTIPLE_SDK_SERVICE:case cE.LICENSE_ILLEGAL:case cE.TOKEN_EXPIRE:e=t;break;default:e=lE.NETWORK_ERROR}$b.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(e||"undefined -> "+lE.NETWORK_ERROR)),this.joinInfo&&sy.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===cE.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e}),this._disconnectedReason=t,t!==cE.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(_y.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&($b.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),sy.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Ok?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void $b.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));Pb("EVENT_REPORT_DOMAIN",t[1]),Pb("EVENT_REPORT_BACKUP_DOMAIN",t[1]),Pb("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}})),this.signal.on(Ty.ON_UPLINK_STATS,(t=>{this._statsCollector.updateUplinkStats(t)})),this.signal.on(_y.REQUEST_RECOVER,((t,e,i)=>{if(!this.joinInfo)return i(new Uy(U_.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,vE(this,tC.REQUEST_NEW_GATEWAY_LIST).then(e).catch(i)})),this.signal.on(_y.REQUEST_JOIN_INFO,(async t=>{var e;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await vE(this,tC.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(e=this.joinInfo)||void 0===e?void 0:e.turnServer});t(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on(_y.REQUEST_REJOIN_INFO,(t=>{t(this.getRejoinMessage())})),this.signal.on(_y.REPORT_JOIN_GATEWAY,((t,e)=>{this.joinInfo&&(sy.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:t,addr:e,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Ok?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(_y.IS_P2P_DISCONNECTED,(t=>{t(SE(this,tC.IS_P2P_DISCONNECTED))})),this.signal.on(_y.DISCONNECT_P2P,(()=>{this.emit(tC.DISCONNECT_P2P)})),this.signal.on(_y.NEED_RENEW_SESSION,(()=>{this.emit(tC.NEED_RENEW_SESSION)})),this.signal.on(_y.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(_y.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(_y.JOIN_RESPONSE,(t=>{const e=this.getCurrentGatewayAddress();this.emit(tC.JOIN_RESPONSE,t,e)})),this.signal.on(_y.DATACHANNEL_PRECONNECT,(async(t,e,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return vE(this,tC.DATACHANNEL_PRECONNECT,t,n).then(e).catch(i)})),this.signal.on(_y.DATACHANNEL_CONNECTING,(async t=>{const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=await vE(this,tC.REQUEST_DC_CONNECTION_PARAMS);t(this.getJoinMessage({ortc:{iceParameters:e,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on(_y.DATACHANNEL_FAILBACK,(()=>{$b.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(tC.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(t,e){try{await this.signal.request(Ey.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[e]},!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),t),t}}async tryUnsubDataChannelBeforeResub(t,e){try{await this.signal.request(Ey.UNSUBSCRIBE,{stream_id:e.id},!0)}catch(t){throw $b.warning("unsubscribe datachannel warning",t),t}}async tryUnpubBeforeRepub(t,e){try{await this.signal.request(Ey.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),t),t}}async tryUnpubDataChannelBeforeRepub(t,e){try{await this.signal.request(Ey.UNPUBLISH_DATASTREAM,{channnel_id:e.channelId},!0)}catch(t){throw $b.warning("unpublish datastream warning: ",t),t}}async tryMassUnsubBeforeResub(t){const e={users:t.map((t=>({stream_id:t.stream_id,stream_type:t.stream_type})))};try{await this.signal.request(Ey.UNSUBSCRIBE_STREAMS,e,!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),t),t}}async muteLocal(t,e){const i={action:t.find((t=>t.stream_type===Qy.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(Ey.CONTROL,i,!0,!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),t),t}}async unmuteLocal(t,e){const i={action:t.find((t=>t.stream_type===Qy.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(Ey.CONTROL,i,!0,!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),t),t}}async muteRemote(t,e){const i={action:t===hC.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:e};try{await this.signal.request(Ey.CONTROL,i,!0,!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),t),t}}async unmuteRemote(t,e){const i={action:t===hC.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:e};try{await this.signal.request(Ey.CONTROL,i,!0,!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),t),t}}uploadStats(t,e){this.signal.upload(t,e)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const e={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(Ey.RESTART_ICE,e,!0)}catch(t){throw $b.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),t),t}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,lE.P2P_FAILED)}getCurrentGatewayAddress(){var t;if(!Db("GATEWAY_WSS_ADDRESS"))return null!==(t=this.joinInfo)&&void 0!==t&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(Ey.SET_PARAMETER,{enablePublishAudioFilter:t})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(cE.FALLBACK)),this.store.useDataChannel=!1,this.signal=new XC(Pk(Pk({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(tC.RESET_SIGNAL,nC.websocket)}}let xk=0,Uk=0;function Vk(t,e,i,n){return new e_(((s,o)=>{e.timeout=e.timeout||Db("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),xk+=PE(e.data)):i&&(e.data.size?xk+=e.data.size:e.data instanceof FormData?xk+=DE(e.data):xk+=PE(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,gb.request(e).then((t=>{"string"==typeof t.data?Uk+=PE(t.data):t.data instanceof ArrayBuffer||t.data instanceof Uint8Array?Uk+=t.data.byteLength:Uk+=PE(JSON.stringify(t.data)),n&&s({data:t.data,headers:t.headers}),s(t.data)})).catch((t=>{gb.isCancel(t)?o(new Uy(U_.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===t.code?o(new Uy(U_.NETWORK_TIMEOUT,t.message)):t.response?o(new Uy(U_.NETWORK_RESPONSE_ERROR,t.response.status)):o(new Uy(U_.NETWORK_ERROR,t.message))}))}))}
/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */!function(){var t;function e(t){var e=0;return function(){return e<t.length?{done:!1,value:t[e++]}:{done:!0}}}var i,n="function"==typeof Object.defineProperties?Object.defineProperty:function(t,e,i){return t==Array.prototype||t==Object.prototype||(t[e]=i.value),t},s=function(t){t=["object"==typeof globalThis&&globalThis,t,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof q&&q];for(var e=0;e<t.length;++e){var i=t[e];if(i&&i.Math==Math)return i}throw Error("Cannot find global object")}(this);function o(t,e){if(e)t:{var i=s;t=t.split(".");for(var o=0;o<t.length-1;o++){var r=t[o];if(!(r in i))break t;i=i[r]}(e=e(o=i[t=t[t.length-1]]))!=o&&null!=e&&n(i,t,{configurable:!0,writable:!0,value:e})}}function r(t){return(t={next:t})[Symbol.iterator]=function(){return this},t}function a(t){var i="undefined"!=typeof Symbol&&Symbol.iterator&&t[Symbol.iterator];return i?i.call(t):{next:e(t)}}if(o("Symbol",(function(t){function e(t,e){this.A=t,n(this,"description",{configurable:!0,writable:!0,value:e})}if(t)return t;e.prototype.toString=function(){return this.A};var i="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",s=0;return function t(n){if(this instanceof t)throw new TypeError("Symbol is not a constructor");return new e(i+(n||"")+"_"+s++,n)}})),o("Symbol.iterator",(function(t){if(t)return t;t=Symbol("Symbol.iterator");for(var i="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),o=0;o<i.length;o++){var a=s[i[o]];"function"==typeof a&&"function"!=typeof a.prototype[t]&&n(a.prototype,t,{configurable:!0,writable:!0,value:function(){return r(e(this))}})}return t})),"function"==typeof Object.setPrototypeOf)i=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch(t){}c=!1}i=c?function(t,e){if(t.__proto__=e,t.__proto__!==e)throw new TypeError(t+" is not extensible");return t}:null}var l=i;function h(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function u(t){if(t.m)throw new TypeError("Generator is already running");t.m=!0}function p(t,e){return t.h=3,{value:e}}function m(t){this.g=new h,this.G=t}function g(t,e,i,n){try{var s=e.call(t.g.j,i);if(!(s instanceof Object))throw new TypeError("Iterator result "+s+" is not an object");if(!s.done)return t.g.m=!1,s;var o=s.value}catch(e){return t.g.j=null,t.g.s(e),f(t)}return t.g.j=null,n.call(t.g,o),f(t)}function f(t){for(;t.g.h;)try{var e=t.G(t.g);if(e)return t.g.m=!1,{value:e.value,done:!1}}catch(e){t.g.v=void 0,t.g.s(e)}if(t.g.m=!1,t.g.l){if(e=t.g.l,t.g.l=null,e.F)throw e.D;return{value:e.return,done:!0}}return{value:void 0,done:!0}}function v(t){this.next=function(e){return t.o(e)},this.throw=function(e){return t.s(e)},this.return=function(e){return function(t,e){u(t.g);var i=t.g.j;return i?g(t,"return"in i?i.return:function(t){return{value:t,done:!0}},e,t.g.return):(t.g.return(e),f(t))}(t,e)},this[Symbol.iterator]=function(){return this}}function _(t,e){return e=new v(new m(e)),l&&t.prototype&&l(e,t.prototype),e}if(h.prototype.o=function(t){this.v=t},h.prototype.s=function(t){this.l={D:t,F:!0},this.h=this.C||this.u},h.prototype.return=function(t){this.l={return:t},this.h=this.u},m.prototype.o=function(t){return u(this.g),this.g.j?g(this,this.g.j.next,t,this.g.o):(this.g.o(t),f(this))},m.prototype.s=function(t){return u(this.g),this.g.j?g(this,this.g.j.throw,t,this.g.o):(this.g.s(t),f(this))},o("Array.prototype.entries",(function(t){return t||function(){return function(t,e){t instanceof String&&(t+="");var i=0,n=!1,s={next:function(){if(!n&&i<t.length){var s=i++;return{value:e(s,t[s]),done:!1}}return n=!0,{done:!0,value:void 0}}};return s[Symbol.iterator]=function(){return s},s}(this,(function(t,e){return[t,e]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var E=function(t,e){for(var i=0;i<t.length;i++)e(t[i])},S=function(t){return t.replace(/\r?\n|\r/g,"\r\n")},T=function(t,e,i){return e instanceof Blob?(i=void 0!==i?String(i+""):"string"==typeof e.name?e.name:"blob",e.name===i&&"[object Blob]"!==Object.prototype.toString.call(e)||(e=new File([e],i)),[String(t),e]):[String(t),String(e)]},b=function(t,e){if(t.length<e)throw new TypeError(e+" argument required, but only "+t.length+" present.")},y="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,C=y.FormData,w=y.XMLHttpRequest&&y.XMLHttpRequest.prototype.send,R=y.Request&&y.fetch,I=y.navigator&&y.navigator.sendBeacon,A=y.Element&&y.Element.prototype,O=y.Symbol&&Symbol.toStringTag;O&&(Blob.prototype[O]||(Blob.prototype[O]="Blob"),"File"in y&&!File.prototype[O]&&(File.prototype[O]="File"));try{new File([],"")}catch(t){y.File=function(t,e,i){return t=new Blob(t,i||{}),Object.defineProperties(t,{name:{value:e},lastModified:{value:+(i&&void 0!==i.lastModified?new Date(i.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),O&&Object.defineProperty(t,O,{value:"File"}),t}}var N=function(t){return t.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},k=function(t){this.i=[];var e=this;t&&E(t.elements,(function(t){if(t.name&&!t.disabled&&"submit"!==t.type&&"button"!==t.type&&!t.matches("form fieldset[disabled] *"))if("file"===t.type){var i=t.files&&t.files.length?t.files:[new File([],"",{type:"application/octet-stream"})];E(i,(function(i){e.append(t.name,i)}))}else"select-multiple"===t.type||"select-one"===t.type?E(t.options,(function(i){!i.disabled&&i.selected&&e.append(t.name,i.value)})):"checkbox"===t.type||"radio"===t.type?t.checked&&e.append(t.name,t.value):(i="textarea"===t.type?S(t.value):t.value,e.append(t.name,i))}))};if((t=k.prototype).append=function(t,e,i){b(arguments,2),this.i.push(T(t,e,i))},t.delete=function(t){b(arguments,1);var e=[];t=String(t),E(this.i,(function(i){i[0]!==t&&e.push(i)})),this.i=e},t.entries=function t(){var e,i=this;return _(t,(function(t){if(1==t.h&&(e=0),3!=t.h)return e<i.i.length?t=p(t,i.i[e]):(t.h=0,t=void 0),t;e++,t.h=2}))},t.forEach=function(t,e){b(arguments,1);for(var i=a(this),n=i.next();!n.done;n=i.next()){var s=a(n.value);n=s.next().value,s=s.next().value,t.call(e,s,n,this)}},t.get=function(t){b(arguments,1);var e=this.i;t=String(t);for(var i=0;i<e.length;i++)if(e[i][0]===t)return e[i][1];return null},t.getAll=function(t){b(arguments,1);var e=[];return t=String(t),E(this.i,(function(i){i[0]===t&&e.push(i[1])})),e},t.has=function(t){b(arguments,1),t=String(t);for(var e=0;e<this.i.length;e++)if(this.i[e][0]===t)return!0;return!1},t.keys=function t(){var e,i,n,s=this;return _(t,(function(t){if(1==t.h&&(e=a(s),i=e.next()),3!=t.h)return i.done?void(t.h=0):(n=i.value,p(t,a(n).next().value));i=e.next(),t.h=2}))},t.set=function(t,e,i){b(arguments,2),t=String(t);var n=[],s=T(t,e,i),o=!0;E(this.i,(function(e){e[0]===t?o&&(o=!n.push(s)):n.push(e)})),o&&n.push(s),this.i=n},t.values=function t(){var e,i,n,s,o=this;return _(t,(function(t){if(1==t.h&&(e=a(o),i=e.next()),3!=t.h)return i.done?void(t.h=0):(n=i.value,(s=a(n)).next(),p(t,s.next().value));i=e.next(),t.h=2}))},k.prototype._asNative=function(){for(var t=new C,e=a(this),i=e.next();!i.done;i=e.next()){var n=a(i.value);i=n.next().value,n=n.next().value,t.append(i,n)}return t},k.prototype._blob=function(){var t="----formdata-polyfill-"+Math.random(),e=[],i="--"+t+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(t,n){return"string"==typeof t?e.push(i+N(S(n))+'"\r\n\r\n'+S(t)+"\r\n"):e.push(i+N(S(n))+'"; filename="'+N(t.name)+'"\r\nContent-Type: '+(t.type||"application/octet-stream")+"\r\n\r\n",t,"\r\n")})),e.push("--"+t+"--"),new Blob(e,{type:"multipart/form-data; boundary="+t})},k.prototype[Symbol.iterator]=function(){return this.entries()},k.prototype.toString=function(){return"[object FormData]"},A&&!A.matches&&(A.matches=A.matchesSelector||A.mozMatchesSelector||A.msMatchesSelector||A.oMatchesSelector||A.webkitMatchesSelector||function(t){for(var e=(t=(this.document||this.ownerDocument).querySelectorAll(t)).length;0<=--e&&t.item(e)!==this;);return-1<e}),O&&(k.prototype[O]="FormData"),w){var L=y.XMLHttpRequest.prototype.setRequestHeader;y.XMLHttpRequest.prototype.setRequestHeader=function(t,e){L.call(this,t,e),"content-type"===t.toLowerCase()&&(this.B=!0)},y.XMLHttpRequest.prototype.send=function(t){t instanceof k?(t=t._blob(),this.B||this.setRequestHeader("Content-Type",t.type),w.call(this,t)):w.call(this,t)}}R&&(y.fetch=function(t,e){return e&&e.body&&e.body instanceof k&&(e.body=e.body._blob()),R.call(this,t,e)}),I&&(y.navigator.sendBeacon=function(t,e){return e instanceof k&&(e=e._asNative()),I.call(this,t,e)}),y.FormData=k}}();const Fk=()=>{const t=Db("AREAS");return 0===t.length&&t.push(sC.GLOBAL),cS(t).call(t,((t,e,i)=>{const n=Bk(e);return n?0===i?n:"".concat(t,",").concat(n):t}),"")},Bk=t=>t===sC.OVERSEA?"".concat(aC.ASIA,",").concat(aC.EUROPE,",").concat(aC.AFRICA,",").concat(aC.NORTH_AMERICA,",").concat(aC.SOUTH_AMERICA,",").concat(aC.OCEANIA):aC[t],jk=t=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map((t=>{const i=cC[t],n=Object.keys(i);n&&n.map((t=>{"CODE"!==t&&(e[t]=e[t].concat(i[t]))}))})),e},Hk={GLOBAL:{ASIA:[sC.CHINA,sC.JAPAN,sC.INDIA,sC.KOREA,sC.HKMC],EUROPE:[],NORTH_AMERICA:[sC.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Gk=Object.keys(Hk[sC.GLOBAL]),Wk=[sC.CHINA,sC.NORTH_AMERICA,sC.EUROPE,sC.ASIA,sC.JAPAN,sC.INDIA,sC.OCEANIA,sC.SOUTH_AMERICA,sC.AFRICA,sC.KOREA,sC.HKMC,sC.US],$k=function(t,e){let i=[];if(Ps(t).call(t,sC.GLOBAL)){const o=[sC.GLOBAL,sC.OVERSEA],r=Object.keys(cC);if(e===sC.GLOBAL)throw new Uy(U_.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===sC.CHINA)i=[sC.OVERSEA];else if(s=e,Ps(Gk).call(Gk,s)){const t=(n=e,Hk[sC.GLOBAL][n]||[]),s=[...o,e,...t];i=r.filter((t=>!Ps(s).call(s,t)))}else if(function(t){let e=!1;return Gk.forEach((i=>{var n;Ps(n=Hk[sC.GLOBAL][i]).call(n,t)&&(e=!0)})),e}(e)){const t=function(t){let e;return Gk.forEach((i=>{var n;Ps(n=Hk[sC.GLOBAL][i]).call(n,t)&&(e=i)})),e}(e),n=[...o,t,e];i=r.filter((t=>!Ps(n).call(n,t)))}else i=t;i=function(t){const e=[];return Wk.forEach((i=>{Ps(t).call(t,i)&&e.push(i)})),e.concat(t.filter((t=>!Ps(Wk).call(Wk,t))))}(i)}else i=t;var n,s;return i};function zk(t){var e,i;if(!t&&Ps(e=Db("AREAS")).call(e,sC.EXTENSIONS))return $b.debug("update area from ap : reset"),void qk(oy,!0);if(!Ps(i=Db("AREAS")).call(i,sC.GLOBAL)||!t)return;let n=cC.EXTENSIONS;n&&(n={CODE:Bk(sC.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},$b.debug("update area from ap success: ".concat(t,",config is "),n),Pb("AREAS",[sC.EXTENSIONS],!0),Object.keys(n).map((t=>{Pb(t,"LOG_UPLOAD_SERVER"===t||"EVENT_REPORT_DOMAIN"===t||"EVENT_REPORT_BACKUP_DOMAIN"===t||"PROXY_SERVER_TYPE3"===t?n[t][0]:n[t])})))}function qk(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=sy.reportApiInvoke(null,{name:oE.SET_AREA,options:t,tag:rE.TRACER});try{let n=[];if("string"==typeof t&&(n=[t]),Array.isArray(t)&&(t.forEach((t=>{if(!Ps(rC).call(rC,t))throw new Uy(U_.INVALID_PARAMS,"invalid area code")})),n=t),"[object Object]"===Object.prototype.toString.call(t)){const{areaCode:e,excludedArea:i}=t;if(!e)throw new Uy(U_.INVALID_PARAMS,"area code is needed");let s=e;"string"==typeof e&&(s=[e]),n=i?$k(s,i):s}if(!e){if(Mb.AREAS){const t=new Uy(U_.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(t),void $b.warning("setArea is prohibited because of config-distribute")}if(Ps(n).call(n,sC.GLOBAL)&&Db("AREAS")===sC.EXTENSIONS){const t=new Uy(U_.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(t),void $b.warning("setArea is prohibited because of ap extensions")}}Pb("AREAS",n,e);const s=jk(n);Object.keys(s).map((t=>{Pb(t,"LOG_UPLOAD_SERVER"===t||"EVENT_REPORT_DOMAIN"===t||"EVENT_REPORT_BACKUP_DOMAIN"===t||"PROXY_SERVER_TYPE3"===t?s[t][0]:s[t])})),$b.debug("set area success:",n.join(","))}catch(t){throw i.onError(t),t}i.onSuccess()}function Kk(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Yk(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Kk(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Kk(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let Jk=1;function Xk(t,e,i,n,s){Jk+=1;const o={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:Jk,requestId:Jk,version:Ob,cname:i.cname},r={service_name:e,json_body:JSON.stringify(o)};let a,c,d=t[0];return JE((async()=>{a=Date.now();const t=await Vk(d,{data:r,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,0!==t.code){const e=new Uy(U_.UNEXPECTED_RESPONSE,"live streaming ap error, code"+t.code,{retry:!0,responseTime:c});throw $b.error(e.toString()),e}const i=JSON.parse(t.json_body);if(200!==i.code){const t=new Uy(U_.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:c});throw $b.error(t.toString()),t}if(!i.servers||0===i.servers.length){const t=new Uy(U_.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:c});throw $b.error(t.toString()),t}const s=function(t,e){return{addressList:t.servers.map((t=>"wss://".concat(t.address.replace(/\./g,"-"),".").concat(Db("WORKER_DOMAIN"),":").concat(t.wss,"?serviceName=").concat(encodeURIComponent(e)))),workerToken:t.workerToken,vid:t.vid}}(i,e);return Db("LIVE_STREAMING_ADDRESS")&&(s.addressList=Db("LIVE_STREAMING_ADDRESS")instanceof Array?Db("LIVE_STREAMING_ADDRESS"):[Db("LIVE_STREAMING_ADDRESS")]),Yk(Yk({},s),{},{responseTime:c})}),((n,s)=>(sy.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(n.addressList),firstSuccess:0===s,responseTime:c,serverIp:t[s%t.length]}),!1)),((n,s)=>(sy.apworkerEvent(i.sid,{success:!1,sc:n.data&&n.data.code||200,serviceName:e,responseTime:c,serverIp:t[s%t.length]}),!!(n.code!==U_.OPERATION_ABORTED&&n.code!==U_.UNEXPECTED_RESPONSE||n.data&&n.data.retry)&&(d=t[(s+1)%t.length],!0))),s)}let Zk=1;function Qk(t,e,i,n){let{url:s,areaCode:o}=t;const r=Date.now();let a;const[c,d]=sL(e,o,[hw.CHOOSE_SERVER]);let l=TE.networkState;return JE((async()=>{l&&TE.networkState===hE.OFFLINE&&TE.onlineWaiter&&await e_.race([TE.onlineWaiter,xE(n&&n.maxRetryTimeout||KE.maxRetryTimeout)]),l=TE.networkState;const{data:t,headers:o}=await Vk(s,{data:c,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a="1"===o.http3?1:-1,sy.reportResourceTiming(s,e.sid),eL(t,s,e,r,[hw.CHOOSE_SERVER],a);const d=Sk(t,hw.CHOOSE_SERVER);return iL(d),gk(d,s)}),(t=>(t&&sy.joinChooseServer(e.sid,{lts:r,succ:!0,csAddr:s,opid:d,serverList:t.gatewayAddrs.map((t=>t.address)),ec:null,cid:t.cid.toString(),uid:t.uid.toString(),csIp:t.csIp,unilbsServerIds:[hw.CHOOSE_SERVER].toString(),isHttp3:a}),!1)),(t=>t.code!==U_.OPERATION_ABORTED&&(t.code===U_.CAN_NOT_GET_GATEWAY_SERVER?t.data.retry:(sy.joinChooseServer(e.sid,{lts:r,succ:!1,csAddr:s,serverList:null,opid:d,ec:t.code,csIp:t.data&&t.data.csIp,unilbsServerIds:[hw.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:l}),isHttp3:a}),$b.warning("[".concat(e.clientId,"] Choose server network error, retry"),t),!0))),n)}function tL(t,e,i,n){let s,{url:o,areaCode:r,serviceIds:a}=t;const c=Date.now(),[d,l]=sL(e,r,a);let h;return JE((async()=>{h&&TE.networkState===hE.OFFLINE&&TE.onlineWaiter&&await e_.race([TE.onlineWaiter,xE(n&&n.maxRetryTimeout||KE.maxRetryTimeout)]),h=TE.networkState;const{data:t,headers:r}=await Vk(o,{data:d,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);s="1"===r.http3?1:-1,sy.reportResourceTiming(o,e.sid),eL(t,o,e,c,a,s);const l=Sk(t,hw.CHOOSE_SERVER),u=Sk(t,"proxy5"===e.cloudProxyServer?hw.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?hw.CLOUD_PROXY:hw.CLOUD_PROXY_FALLBACK);return iL(l),{gatewayInfo:gk(l,o),proxyInfo:u,url:o}}),(t=>(t.gatewayInfo&&sy.joinChooseServer(e.sid,{lts:c,succ:!0,csAddr:o,serverList:t.gatewayInfo.gatewayAddrs.map((t=>t.address)),ec:null,opid:l,cid:t.gatewayInfo.cid.toString(),uid:t.gatewayInfo.uid.toString(),csIp:t.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:s}),t.proxyInfo&&sy.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:t.proxyInfo.addresses.map((t=>t.ip)).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1)),(t=>t.code!==U_.OPERATION_ABORTED&&(t.code===U_.CAN_NOT_GET_GATEWAY_SERVER?t.data.retry:(sy.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:t.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),$b.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),t),!0))),n)}const eL=(t,e,i,n,s,o)=>{const r=[],a=r=>{4096===r.flag?sy.joinChooseServer(i.sid,{lts:n,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:r.error.message,csIp:r.error.data&&r.error.data.csIp,unilbsServerIds:s.toString(),isHttp3:o}):1048576!==r.flag&&4194304!==r.flag&&4194310!==r.flag||sy.joinWebProxyAP(i.sid,{lts:n,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:r.error.code,eventType:i.cloudProxyServer,unilbsServerIds:s.toString()})};if(t.response_body.forEach((e=>{const i=e.buffer.code;if(23===e.uri&&0===i&&!e.buffer.edges_services)if(4194310===e.buffer.flag)$b.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),e.buffer.edges_services=[];else{const i={error:new Uy(U_.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:e.buffer.flag};r.push(i),a(i)}if(0!==i){const n=DC(i),s={error:new Uy(U_.CAN_NOT_GET_GATEWAY_SERVER,n.desc,{desc:n.desc,retry:n.retry,csIp:t.detail[502]}),flag:e.buffer.flag};4194310===e.buffer.flag?$b.warning(s.error.toString()):r.push(s),a(s)}})),r.length)throw $b.warning("[".concat(i.clientId,"] multi unilbs ").concat(e," failed, ").concat(r.map((t=>"flag: ".concat(t.flag,", message: ").concat(t.error.message,", retry: ").concat(t.error.data.retry))).join(" | "))),new Uy(U_.CAN_NOT_GET_GATEWAY_SERVER,r.map((t=>"flag: ".concat(t.flag,", message: ").concat(t.error.message))).join(" | "),{retry:!!r.find((t=>t.error.data.retry)),csIp:t.detail[502],desc:[...new Set(r.map((t=>{var e;return null==t||null===(e=t.error)||void 0===e||null===(e=e.data)||void 0===e?void 0:e.desc})).filter((t=>!!t)))]})},iL=t=>{var e,i,n,s;if(t.addresses&&0===t.addresses.length&&0===t.code)throw new Uy(U_.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(Db("AP_AREA")&&(null!==(n=t.detail)&&void 0!==n&&n[23]&&"string"==typeof(null===(s=t.detail)||void 0===s?void 0:s[23])?zk(t.detail[23].toLowerCase()):zk()),null!==(e=t.detail)&&void 0!==e&&e[19]&&"string"==typeof(null===(i=t.detail)||void 0===i?void 0:i[19])){const e=t.detail[19],i=null==e?void 0:e.split(";");for(let e=0;e<i.length;e++){var o;const n=vw(o=i[e]).call(o);t.addresses[e]&&i&&(t.addresses[e].fingerprint=n)}}if(Db("GATEWAY_ADDRESS")&&Db("GATEWAY_ADDRESS").length>0){$b.debug("assign gateway address to",Db("GATEWAY_ADDRESS"));const e=Db("GATEWAY_ADDRESS").map((e=>{var i,n;const s=null!==(i=null===(n=t.addresses.find((t=>t.ip===e.ip&&t.port===e.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:e.ip,port:e.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:s}}));t.addresses=e}},nL=(t,e)=>{if(t.response_body&&t.response_body.length){const e=t.response_body[0];if(0!==e.buffer.code){const t=DC(e.buffer.code);throw new Uy(U_.UPDATE_TICKET_FAILED,"[".concat(e.buffer.code,"]: ").concat(t.desc),{retry:t.retry})}return e.buffer.ticket}throw $b.debug("update ticket request received ap response without response body:",e),new Uy(U_.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},sL=(t,e,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:Yk({6:t.stringUid,11:e,12:Db("USE_NEW_TOKEN")?"1":void 0,22:e},Db("AP_RTM")?{26:"RTM2"}:{}),key:t.token,service_ids:i,uid:t.uid||0}}]};s.request_bodies.forEach((e=>{t.multiIP&&t.multiIP.gateway_ip&&(e.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},oL=(t,e)=>{const i=Math.floor(Math.random()*10**12),n={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map((t=>({ip:t.ip,port:t.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};let rL=0;function aL(t){return e_.all(t.map((t=>t.then((t=>{throw t}),(t=>t))))).then((t=>{throw t}),(t=>t))}const cL=async t=>{let{fragementLength:e,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:o}=t,r=0;const a=e;let c,d=0;const l=async()=>{const t=(()=>{const t=r*a,e=t+a;return i.slice(t,e).map(n)})();o&&o.push(...t);try{c=await aL(t)}catch(t){if(d+=a,r++,!(d>=i.length))return void await l();s(t)}t.forEach((t=>t.cancel()))};return await l(),c};async function dL(t,e,i,n){const s=async function(t,e,i,n){let s=null;const o=[],r=async()=>{const s=Db("WEBCS_DOMAIN").slice(0,Db("AJAX_REQUEST_CONCURRENT")).map((e=>({url:t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:Fk()}))),r=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((t=>t.url))}),a=await cL({fragementLength:Db("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>($b.debug("[".concat(t.clientId,"] Connect to choose_server:"),n.url),Qk(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},r),t[0]},promisesCollector:o});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},r),a},a=async()=>{if(await xE(1e3),null!==s)return s;const r=Db("WEBCS_DOMAIN_BACKUP_LIST").map((e=>({url:t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:Fk()}))),a=n.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((t=>t.url))}),c=await cL({fragementLength:Db("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:n=>($b.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),n.url),Qk(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},a),t[0]},promisesCollector:o});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c};try{return s=await aL([r(),a()]),o.length&&o.forEach((t=>t.cancel&&"function"==typeof t.cancel&&t.cancel())),s}catch(t){throw t[0]}}(t,e,i,n);return{gatewayInfo:await s}}async function lL(t,e,i,n,s){const o=t.cloudProxyServer;if("disabled"===o){if(!n)return;if(t.useLocalAccessPoint)return await dL(t,e,i,s);if(Db("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:n,proxyInfo:o}=await pL(t,e,i,s);return t.turnServer&&"auto"!==t.turnServer.mode||(t.turnServer={mode:"manual",servers:o.map((t=>({turnServerURL:t.address,tcpport:t.tcpport||ry.tcpport,udpport:t.udpport||ry.udpport,username:t.username||ry.username,password:t.password||ry.password,forceturn:!1,security:!0})))}),{gatewayInfo:n}}return await dL(t,e,i,s)}const{proxyInfo:r,gatewayInfo:a}=await pL(t,e,i,s),c={gatewayInfo:a};return t.turnServer={mode:"manual",servers:r.map((t=>({turnServerURL:t.address,tcpport:"proxy3"===o?void 0:t.tcpport?t.tcpport:ry.tcpport,udpport:"proxy4"===o?void 0:t.udpport?t.udpport:ry.udpport,username:t.username||ry.username,password:t.password||ry.password,forceturn:"proxy4"!==o,security:"proxy5"===o})))},$b.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),c}async function hL(t,e,i,n,s){const o=Db("ACCOUNT_REGISTER").slice(0,Db("AJAX_REQUEST_CONCURRENT"));let r=[];r=e.proxyServer?o.map((t=>"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"))):o.map((t=>"https://".concat(t,"/api/v1")));const a=null==s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:r});try{const o=await async function(t,e,i,n,s){const o=Date.now(),r={sid:i.sid,opid:10,appid:i.appId,string_uid:e};let a=t[0];const c=await JE((()=>Vk(a+"".concat(-1===a.indexOf("?")?"?":"&","action=stringuid"),{data:r,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((i,n)=>{if(0===i.code){if(i.uid<=0||i.uid>=Math.pow(2,32))throw $b.error("Invalid Uint Uid ".concat(e," => ").concat(i.uid),i),sy.reqUserAccount(r.sid,{lts:o,success:!1,serverAddr:a,stringUid:r.string_uid,uid:i.uid,errorCode:U_.INVALID_UINT_UID_FROM_STRING_UID,extend:r}),new Uy(U_.INVALID_UINT_UID_FROM_STRING_UID);return sy.reqUserAccount(r.sid,{lts:o,success:!0,serverAddr:a,stringUid:r.string_uid,uid:i.uid,errorCode:null,extend:r}),!1}const s=DC(i.code);return s.retry&&(a=t[(n+1)%t.length]),sy.reqUserAccount(r.sid,{lts:o,success:!1,serverAddr:a,stringUid:r.string_uid,uid:i.uid,errorCode:s.desc,extend:r}),s.retry}),((e,i)=>e.code!==U_.OPERATION_ABORTED&&(sy.reqUserAccount(r.sid,{lts:o,success:!1,serverAddr:a,stringUid:r.string_uid,uid:null,errorCode:e.code,extend:r}),a=t[(i+1)%t.length],!0)),s);if(0!==c.code){const t=DC(c.code);throw new Uy(U_.UNEXPECTED_RESPONSE,t.desc)}return c}(r,t,e,i,n);return null==s||s.recordJoinChannelService({status:"success",endTs:Date.now()},a),o.uid}catch(t){throw null==s||s.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[t]},a),t}}async function uL(t,e,i){const n=Db("CDS_AP").slice(0,Db("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"):"https://".concat(e,"/api/v1?action=config"))).map((n=>function(t,e,i,n){const s=p_(),o={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:e.appId,version:Ob,cname:e.cname,sid:e.sid,session_id:e.sid,detail:"",proxyServer:e.proxyServer}};return JE((()=>Vk(t,{data:o,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(t=>t.code!==U_.OPERATION_ABORTED),n)}(n,t,e,i)));let s=null,o=null,r={};try{s=await aL(n)}catch(t){if(t.code===U_.OPERATION_ABORTED)throw t;o=t}if(n.forEach((t=>t.cancel())),sy.reportApiInvoke(t.sid,{name:oE.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:s}}).onSuccess(),s&&s.test_tags)try{r=function(t){if(!t.test_tags)return{};const e=t.test_tags,i=Object.keys(e),n={};return i.forEach((t=>{var i;const s=vw(i=t.slice(4)).call(i),o=JSON.parse(e[t])[1];n[s]=o})),n}(s)}catch(t){}return r}async function pL(t,e,i,n){const s=Db("PROXY_SERVER_TYPE3"),o=(t,e,i)=>{let n=i||s;return Array.isArray(n)&&(n=e%2==0?s[1]:s[0]),"https://".concat(n,"/ap/?url=").concat(t)};let r=null;const a=[],c=async()=>{const s=Db("WEBCS_DOMAIN").slice(0,Db("AJAX_REQUEST_CONCURRENT")).map(((e,i)=>{let n;return n="disabled"===t.cloudProxyServer&&t.proxyServer?o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(e,"/api/v2/transpond/webrtc?v=2"):o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Fk(),serviceIds:[hw.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?hw.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?hw.CLOUD_PROXY:hw.CLOUD_PROXY_FALLBACK]}})),r=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((t=>t.url))}),c=await cL({fragementLength:Db("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>($b.debug("[".concat(t.clientId,"] Connect to choose_server:"),n.url),tL(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},r),t[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},r),c},d=async()=>{if(await xE(1e3),null!==r)return r;const s=Db("WEBCS_DOMAIN_BACKUP_LIST").map(((e,i)=>{let n;return n="disabled"===t.cloudProxyServer&&t.proxyServer?o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(e,"/api/v2/transpond/webrtc?v=2"):o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Fk(),serviceIds:[hw.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?hw.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?hw.CLOUD_PROXY:hw.CLOUD_PROXY_FALLBACK]}})),c=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((t=>t.url))}),d=await cL({fragementLength:Db("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>($b.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),n.url),tL(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},c),t[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};let l,h,u;try{({gatewayInfo:l,proxyInfo:h,url:u}=await aL([c(),d()]))}catch(t){throw t[0]}if(a.length&&a.forEach((t=>t.cancel&&"function"==typeof t.cancel&&t.cancel())),!l||!h)throw new Uy(U_.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=u,"disabled"!==t.cloudProxyServer&&Array.isArray(s)&&u){const e=/^https?:\/\/(.+?)(\/.*)?$/.exec(u)[1];Ps(s).call(s,e)&&(t.proxyServer=e,$b.setProxyServer(e),sy.setProxyServer(e))}return r={gatewayInfo:l,proxyInfo:await Tk(h,l.uid)},r}async function mL(t,e,i,n){const s=Db("UAP_AP").slice(0,Db("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap")));return await Xk(s,t,e,i,n)}async function gL(t,e,i){const n=Db("UAP_AP").slice(0,Db("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap"))).map((n=>function(t,e,i,n){const s={command:"convergeAllocateEdge",sid:e.sid,appId:e.appId,token:e.token,ts:Date.now(),version:Ob,cname:e.cname,uid:e.uid.toString(),requestId:Zk,seq:Zk};Zk+=1;const o={service_name:"tele_channel",json_body:JSON.stringify(s)};return JE((async()=>{const e=await Vk(t,{data:o,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==e.code){const t=new Uy(U_.UNEXPECTED_RESPONSE,"cross channel ap error, code"+e.code,{retry:!0});throw $b.error(t.toString()),t}const n=JSON.parse(e.json_body);if(200!==n.code){const t=new Uy(U_.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(n.code,", reason: ").concat(n.reason));throw $b.error(t.toString()),t}if(!n.servers||0===n.servers.length){const t=new Uy(U_.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw $b.error(t.toString()),t}return{vid:n.vid,workerToken:n.workerToken,addressList:(Db("CHANNEL_MEDIA_RELAY_SERVERS")||n.servers).map((t=>"wss://".concat(t.address.replace(/\./g,"-"),".").concat(Db("WORKER_DOMAIN"),":").concat(t.wss)))}}),void 0,(t=>!!(t.code!==U_.OPERATION_ABORTED&&t.code!==U_.UNEXPECTED_RESPONSE||t.data&&t.data.retry)),n)}(n,t,e,i)));try{const t=await aL(n);return n.forEach((t=>t.cancel())),t}catch(t){throw t[0]}}async function fL(t,e,i){let n=null;const s=[],o=async o=>{const r=Db(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2")));return o&&(await xE(1e3),null!==n)?n:await cL({fragementLength:Db("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:n=>($b.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),n),function(t,e,i,n){const[s]=oL(e,[hw.CHOOSE_SERVER]);let o=TE.networkState;return JE((async()=>{o&&TE.networkState===hE.OFFLINE&&TE.onlineWaiter&&await e_.race([TE.onlineWaiter,xE(n&&n.maxRetryTimeout||KE.maxRetryTimeout)]),o=TE.networkState;const e=await Vk(t,{data:s,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0);return nL(e,t)}),(()=>!1),(t=>t.code!==U_.OPERATION_ABORTED&&(t.code===U_.UPDATE_TICKET_FAILED?t.data.retry:($b.warning("[".concat(e.clientId,"] update ticket network error, retry"),t),!0))),n)}(n,t,e,i)),allFailedhandler:t=>{throw t[0]},promisesCollector:s})};try{return n=await aL([o(!1),o(!0)]),s.length&&s.forEach((t=>t.cancel&&"function"==typeof t.cancel&&t.cancel())),n}catch(t){throw t[0]}}function vL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function _L(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?vL(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):vL(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class EL extends iE{constructor(){super(),nu(this,"configs",void 0),nu(this,"joinInfo",void 0),nu(this,"cancelToken",void 0),nu(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),nu(this,"interval",void 0),nu(this,"mutex",new zE("config-distribute")),nu(this,"mutableParamsRead",!1)}startGetConfigDistribute(t,e){this.joinInfo=t,this.cancelToken=e,this.interval&&this.stopGetConfigDistribute(),Db("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),Db("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,sy.reportApiInvoke(null,{options:void 0,name:oE.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:rE.TRACER}).onSuccess(JSON.stringify(Mb))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void $b.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const e=await this.mutex.lock();try{t=await uL(this.joinInfo,this.cancelToken,this.retryConfig),$b.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(t){const e=new Uy(U_.NETWORK_RESPONSE_ERROR,t);$b.warning("[config-distribute] ".concat(e.toString()))}finally{e()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(t){var e;(e=t)&&e.uplink&&e.id&&void 0!==e.uplink.max_bitrate&&void 0!==e.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==t.id&&this.emit(dC.UPDATE_BITRATE_LIMIT,t):this.emit(dC.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&_L({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){var e;const i=Zu(e=Object.keys(t).filter((t=>/^webrtc_ng_global_parameter/.test(t)))).call(e);for(let e=0;e<i.length;e++)for(let n=i.length-1;n>e;n--){const e=i[n];if("number"==typeof t[e].__priority){const s=t[e].__priority,o=i[n-1];if("number"==typeof t[o].__priority){if(!(s>t[o].__priority))continue;{const t=e;i[n]=i[n-1],i[n-1]=t}}else{const t=e;i[n]=i[n-1],i[n-1]=t}}}const n={};i.forEach((e=>{const i=t[e],s=i.__expires;Object.keys(i).forEach((t=>{"__priority"===t||"__expires"===t||Object.prototype.hasOwnProperty.call(n,t)||(n[t]=_L({value:i[t]},s&&{expires:s}))}))}));try{!function(t){try{const e=Date.now();Object.keys(t).forEach((i=>{switch(i){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(Lb,i)){const{value:n,expires:s}=t[i];if(s&&s<=e)return;Mb[i]=n,Lb[i]=n,$b.debug("Update global parameters from config distribute",i,n)}}}))}catch(e){$b.error("Error update config immediately: ".concat(t),e.message)}}(n);const t=JSON.stringify(n),e=window.btoa(t);window.localStorage.setItem("websdk_ng_global_parameter",e),$b.debug("Caching global parameters ".concat(t))}catch(t){$b.error("Error caching global parameters:",t.message)}}}function SL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function TL(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?SL(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):SL(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class bL extends iE{constructor(t,e,i,n){super(),nu(this,"spec",void 0),nu(this,"token",void 0),nu(this,"websocket",void 0),nu(this,"pingpongTimer",void 0),nu(this,"reconnectMode","retry"),nu(this,"serviceMode",void 0),nu(this,"reqId",0),nu(this,"commandReqId",0),nu(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),nu(this,"handleWebSocketMessage",(t=>{if(!t.data)return;const e=JSON.parse(t.data);e.requestId?this.emit("@".concat(e.requestId,"-").concat(e.sid),e):this.serviceMode===wy.INJECT?this.emit($y.INJECT_STREAM_STATUS,e):(sy.workerEvent(this.spec.sid,{actionType:"status",serverCode:e.code,workerType:this.serviceMode===wy.TRANSCODE?1:2}),this.emit($y.PUBLISH_STREAM_STATUS,e))})),this.spec=e,this.token=t,this.serviceMode=n,this.websocket=new JC("live-streaming",i),this.websocket.on(Cy.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Cy.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Cy.REQUEST_NEW_URLS,((t,e)=>{vE(this,$y.REQUEST_NEW_ADDRESS).then(t).catch(e)})),this.websocket.on(Cy.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(t){return this.websocket.init(t)}async request(t,e,i,n){this.reqId+=1,"request"===t&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new Uy(U_.UNEXPECTED_ERROR);const r=TL({command:t,sdkVersion:"4.19.3"===Ob?"0.0.1":Ob,seq:o,requestId:o,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},e);if("closed"===this.websocket.state)throw new Uy(U_.WS_DISCONNECT);const a=()=>new e_(((t,e)=>{this.websocket.once(Cy.CLOSED,(()=>e(new Uy(U_.WS_ABORT)))),this.websocket.once(Cy.CONNECTED,t)}));"connected"!==this.websocket.state&&await a(),r.clientRequest&&(r.clientRequest.workerToken=this.token);const c=new e_(((t,e)=>{const i=()=>{e(new Uy(U_.WS_ABORT))};this.websocket.once(Cy.RECONNECTING,i),this.websocket.once(Cy.CLOSED,i),this.once("@".concat(o,"-").concat(this.spec.sid),(e=>{t(e)}))}));n&&sy.workerEvent(this.spec.sid,TL(TL({},n),{},{requestId:s,actionType:"request",payload:JSON.stringify(e.clientRequest),serverCode:0,code:0}));const d=Date.now();this.websocket.sendMessage(r);let l=null;try{l=await c}catch(n){if("closed"===this.websocket.state)throw n;return await a(),await this.request(t,e,i)}return n&&sy.workerEvent(this.spec.sid,TL(TL({},n),{},{requestId:s,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:200===l.code,responseTime:Date.now()-d})),200!==l.code&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t="4.19.3"===Ob?"0.0.1":Ob;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case qy.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void $b.warning("live stream response already exists stream");case qy.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case qy.LIVE_STREAM_RESPONSE_BAD_STREAM:case qy.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Uy(U_.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case qy.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;throw new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case qy.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Uy(U_.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case qy.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new Uy(U_.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit($y.WARNING,e,t.serverResponse.url)}case qy.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const e=new Uy(U_.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit($y.WARNING,e,t.serverResponse.url)}case qy.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case qy.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Uy(U_.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case qy.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const e=new Uy(U_.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit($y.WARNING,e,t.serverResponse.url)}case qy.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case qy.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case qy.LIVE_STREAM_RESPONSE_WORKER_LOST:case qy.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;throw new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case qy.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;if("UpdateTranscoding"===t.serverResponse.command||"ControlStream"===t.serverResponse.command)return new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case qy.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case qy.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case qy.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case qy.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Uy(U_.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(FE)}),6e3)}}function yL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function CL(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?yL(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):yL(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class wL extends iE{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:KE,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:KE;super(),nu(this,"onLiveStreamWarning",void 0),nu(this,"onLiveStreamError",void 0),nu(this,"onInjectStatusChange",void 0),nu(this,"spec",void 0),nu(this,"retryTimeout",1e4),nu(this,"connection",void 0),nu(this,"httpRetryConfig",void 0),nu(this,"wsRetryConfig",void 0),nu(this,"streamingTasks",new Map),nu(this,"isStartingStreamingTask",!1),nu(this,"taskMutex",new zE("live-streaming")),nu(this,"cancelToken",gb.CancelToken.source()),nu(this,"transcodingConfig",void 0),nu(this,"injectConfig",CL({},Wy)),nu(this,"injectLoopTimes",0),nu(this,"uapResponse",void 0),nu(this,"lastTaskId",1),nu(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=i,this.wsRetryConfig=e}async setTranscodingConfig(t){const e=CL(CL({},Gy),t);66!==e.videoCodecProfile&&77!==e.videoCodecProfile&&100!==e.videoCodecProfile&&($b.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(e.videoCodecProfile," -> 100")),e.videoCodecProfile=100),e.transcodingUsers||(e.transcodingUsers=e.userConfigs),e.transcodingUsers&&(e.transcodingUsers=e.transcodingUsers.map((t=>CL(CL(CL({},By),t),{},{zOrder:t.zOrder?t.zOrder+1:1})))),function(t){$_(t.width)||j_(t.width,"config.width",0,1e4),$_(t.height)||j_(t.height,"config.height",0,1e4),$_(t.videoBitrate)||j_(t.videoBitrate,"config.videoBitrate",1,1e6),$_(t.videoFrameRate)||j_(t.videoFrameRate,"config.videoFrameRate"),$_(t.lowLatency)||F_(t.lowLatency,"config.lowLatency"),$_(t.audioSampleRate)||B_(t.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),$_(t.audioBitrate)||j_(t.audioBitrate,"config.audioBitrate",1,128),$_(t.audioChannels)||B_(t.audioChannels,"config.audioChannels",[1,2,3,4,5]),$_(t.videoGop)||j_(t.videoGop,"config.videoGop"),$_(t.videoCodecProfile)||B_(t.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),$_(t.userCount)||j_(t.userCount,"config.userCount",0,17),$_(t.backgroundColor)||j_(t.backgroundColor,"config.backgroundColor",0,16777215),$_(t.userConfigExtraInfo)||G_(t.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),t.transcodingUsers&&!$_(t.transcodingUsers)&&(W_(t.transcodingUsers,"config.transcodingUsers"),t.transcodingUsers.forEach(((t,e)=>{Fy(t.uid),$_(t.x)||j_(t.x,"transcodingUser[".concat(e,"].x"),0,1e4),$_(t.y)||j_(t.y,"transcodingUser[".concat(e,"].y"),0,1e4),$_(t.width)||j_(t.width,"transcodingUser[".concat(e,"].width"),0,1e4),$_(t.height)||j_(t.height,"transcodingUser[".concat(e,"].height"),0,1e4),$_(t.zOrder)||j_(t.zOrder-1,"transcodingUser[".concat(e,"].zOrder"),0,100),$_(t.alpha)||j_(t.alpha,"transcodingUser[".concat(e,"].alpha"),0,1,!1)}))),$_(t.watermark)||Hy(t.watermark,"watermark"),$_(t.backgroundImage)||Hy(t.backgroundImage,"backgroundImage"),t.images&&!$_(t.images)&&(W_(t.images,"config.images"),t.images.forEach(((t,e)=>{Hy(t,"images[".concat(e,"]"))})))}(e);const i=[];e.images&&i.push(...e.images.map((t=>CL(CL(CL({},jy),t),{},{zOrder:255})))),e.backgroundImage&&(i.push(CL(CL(CL({},jy),e.backgroundImage),{},{zOrder:0})),delete e.backgroundImage),e.watermark&&(i.push(CL(CL(CL({},jy),e.watermark),{},{zOrder:255})),delete e.watermark),e.images=i,e.transcodingUsers&&(e.userConfigs=e.transcodingUsers.map((t=>CL({},t))),e.userCount=e.transcodingUsers.length,delete e.transcodingUsers);const n=(e.userConfigs||[]).map((t=>"number"==typeof t.uid?e_.resolve(t.uid):hL(t.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await e_.all(n)).forEach(((t,i)=>{e.userConfigs&&e.userConfigs[i]&&(e.userConfigs[i].uid=t)})),this.transcodingConfig=e,this.connection)try{var s;const t=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Dy(s=this.streamingTasks).call(s)).map((t=>t.taskId)).join("#")});$b.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(t.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(t){if(!t.data||!t.data.retry)throw t;t.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((e=>{$b.warning("[".concat(this.spec.clientId,"] live streaming receive error"),t.toString(),"try to republish",e.url),this.startLiveStreamingTask(e.url,e.mode,t).then((()=>{$b.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(e.url," success"))})).catch((t=>{$b.error("[".concat(this.spec.clientId,"] live streaming republish failed"),e.url,t.toString()),this.onLiveStreamError&&this.onLiveStreamError(e.url,t)}))}))}}setInjectStreamConfig(t,e){this.injectConfig=Object.assign({},this.injectConfig,t),this.injectLoopTimes=e}async startLiveStreamingTask(t,e,i){var n;if(Array.from(Dy(n=this.streamingTasks).call(n)).find((t=>t.mode===wy.INJECT))&&e===wy.INJECT)return new Uy(U_.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&e===wy.TRANSCODE)throw new Uy(U_.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let s={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};$b.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(e));const o=await this.taskMutex.lock();if(!this.connection&&i)return void o();if(this.streamingTasks.get(t)&&!i)return o(),new Uy(U_.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(e))}catch(t){throw o(),t}switch(e){case wy.TRANSCODE:s.transcodingConfig=CL({},this.transcodingConfig);break;case wy.RAW:break;case wy.INJECT:s={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(s.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const r=this.lastTaskId++;try{const n=new e_(((e,n)=>{xE(this.retryTimeout).then((()=>{if(i)return n(i);const e=this.statusError.get(t);return e?(this.statusError.delete(t),n(e)):void 0}))})),a=await e_.race([this.connection.request("request",{clientRequest:s},!0,{url:t,command:"PublishStream",workerType:e===wy.TRANSCODE?1:2,requestByUser:!i,tid:r.toString()}),n]);this.isStartingStreamingTask=!1,$b.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(a.code)),this.streamingTasks.set(t,{clientRequest:s,mode:e,url:t,taskId:r}),o()}catch(n){if(o(),this.isStartingStreamingTask=!1,!n.data||!n.data.retry||i)throw n;return n.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,e,n)):await this.startLiveStreamingTask(t,e,n)}}stopLiveStreamingTask(t){return new e_(((e,i)=>{const n=this.streamingTasks.get(t);if(!n||!this.connection)return new Uy(U_.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=n.mode;n.abortTask=()=>{$b.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),e()},this.connection.request("request",{clientRequest:{command:s===wy.INJECT?"UninjectStream":"UnpublishStream",url:n.url}},!1,{url:t,command:"UnPublishStream",workerType:s===wy.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((i=>{$b.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(i.code)),this.streamingTasks.delete(t),0===this.streamingTasks.size&&s!==wy.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),e(),s===wy.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Ry.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)})).catch(i)}))}async controlInjectStream(t,e,i,n){const s=this.streamingTasks.get(t);if(!s||!this.connection||s.mode!==wy.INJECT)throw new Uy(U_.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:t,control:e,audioVolume:i,position:n}})).serverResponse}resetAllTask(){var t;const e=Array.from(Dy(t=this.streamingTasks).call(t));this.terminate();for(const t of e)this.startLiveStreamingTask(t.url,t.mode).catch((e=>{this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=gb.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new Uy(U_.UNEXPECTED_ERROR,"live streaming connection has already connected");const e=await vE(this,zy.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=e,this.connection=new bL(e.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on($y.WARNING,((t,e)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(e,t))),this.connection.on($y.PUBLISH_STREAM_STATUS,(t=>this.handlePublishStreamServer(t))),this.connection.on($y.INJECT_STREAM_STATUS,(t=>this.handleInjectStreamServerStatus(t))),this.connection.on($y.REQUEST_NEW_ADDRESS,((e,i)=>{if(!this.connection)return i(new Uy(U_.UNEXPECTED_ERROR,"can not get new live streaming address list"));vE(this,zy.REQUEST_WORKER_MANAGER_LIST,t).then((t=>{this.uapResponse=t,e(t.addressList)})).catch(i)})),await this.connection.init(e.addressList),this.connection}handlePublishStreamServer(t){const e=t.serverStatus&&t.serverStatus.url||"empty_url",i=this.streamingTasks.get(e),n=t.reason;switch(t.code){case qy.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case qy.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case qy.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case qy.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const n=new Uy(U_.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(i)return $b.error(n.toString()),this.onLiveStreamError&&this.onLiveStreamError(e,n);if(!this.isStartingStreamingTask)return;this.statusError.set(e,n)}case qy.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new Uy(U_.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,n);return this.onLiveStreamWarning&&this.onLiveStreamWarning(e,t)}case qy.LIVE_STREAM_RESPONSE_WORKER_LOST:case qy.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const e=Array.from(Dy(s=this.streamingTasks).call(s));for(const i of e)i.abortTask?i.abortTask():($b.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,new Uy(U_.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then((()=>{$b.debug("[".concat(this.spec.clientId,"] republish live stream success"),i.url)})).catch((t=>{$b.error(t.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,t)})));return}}}handleInjectStreamServerStatus(t){const e=Number(t.uid),i=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Ry.INJECT_STREAM_STATUS_START_SUCCESS,e,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Ry.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,e,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Ry.INJECT_STREAM_STATUS_START_UNAUTHORIZED,e,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Ry.INJECT_STREAM_STATUS_BROKEN,e,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Ry.INJECT_STREAM_STATUS_START_TIMEOUT,e,i),void this.streamingTasks.delete(i);default:return void $b.debug("inject stream server status",t)}}hasUrl(t){return this.streamingTasks.has(t)}}class RL{constructor(){nu(this,"destChannelMediaInfos",new Map),nu(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){oC(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){oC(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Vy(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function IL(t){if(!(t instanceof RL))return new Uy(U_.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),i=t.getDestChannelMediaInfo();return e?0===i.size?new Uy(U_.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new Uy(U_.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}class AL extends iE{constructor(t,e,i){super(),nu(this,"ws",void 0),nu(this,"requestId",1),nu(this,"heartBeatTimer",void 0),nu(this,"joinInfo",void 0),nu(this,"clientId",void 0),nu(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),nu(this,"onClose",(t=>{this.emit("close"),this.dispose()})),nu(this,"onMessage",(t=>{const e=JSON.parse(t.data);if(!e||"serverResponse"!==e.command||!e.requestId)return e&&"serverStatus"===e.command&&e.serverStatus&&e.serverStatus.command?(this.emit("status",e.serverStatus),void this.emit(e.serverStatus.command,e.serverStatus)):void 0;this.emit("req_".concat(e.requestId),e)})),this.joinInfo=t,this.clientId=e,this.ws=new JC("cross-channel-".concat(this.clientId),i),this.ws.on(Cy.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Cy.CONNECTED,this.onOpen),this.ws.on(Cy.ON_MESSAGE,this.onMessage),this.ws.on(Cy.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(t){const e=this.requestId++;return t.requestId=e,t.seq=e,this.ws.sendMessage(t),e}waitStatus(t){return new e_(((e,i)=>{const n=window.setTimeout((()=>{i(new Uy(U_.TIMEOUT,"wait status timeout, status: ".concat(t)))}),5e3);this.once(t,(s=>{window.clearTimeout(n),s.state&&0!==s.state?i(new Uy(U_.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):e(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new Uy(U_.WS_ABORT))}))}))}async request(t){if("closed"===this.ws.state)throw new Uy(U_.WS_DISCONNECT);const e=()=>new e_(((t,e)=>{this.ws.once(Cy.CLOSED,(()=>e(new Uy(U_.WS_ABORT)))),this.ws.once(Cy.CONNECTED,t)}));"connected"!==this.ws.state&&await e();const i=this.sendMessage(t),n=new e_(((t,e)=>{const n=()=>{e(new Uy(U_.WS_ABORT))};this.ws.once(Cy.RECONNECTING,n),this.ws.once(Cy.CLOSED,n),this.once("req_".concat(i),t),xE(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(Cy.RECONNECTING,n),this.ws.off(Cy.CLOSED,n),e(new Uy(U_.TIMEOUT,"cross channel ws request timeout"))}))})),s=await n;if(!s||200!==s.code)throw new Uy(U_.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(t){this.ws.removeAllListeners(Cy.REQUEST_NEW_URLS),this.ws.on(Cy.REQUEST_NEW_URLS,(e=>{e(t)})),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const e=this.requestId++;return t.requestId=e,this.ws.sendMessage(t),e}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class OL extends iE{set state(t){t!==this._state&&(t!==Xy.RELAY_STATE_FAILURE&&(this.errorCode=Zy.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,e,i,n,s){super(),nu(this,"joinInfo",void 0),nu(this,"sid",void 0),nu(this,"clientId",void 0),nu(this,"cancelToken",gb.CancelToken.source()),nu(this,"workerToken",void 0),nu(this,"requestId",0),nu(this,"signal",void 0),nu(this,"prevChannelMediaConfig",void 0),nu(this,"httpRetryConfig",void 0),nu(this,"_resolution",void 0),nu(this,"_state",Xy.RELAY_STATE_IDLE),nu(this,"errorCode",Zy.RELAY_OK),nu(this,"onStatus",(t=>{$b.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(t))),t&&t.command&&("onAudioPacketReceived"===t.command&&this.emit("event",Jy.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===t.command&&this.emit("event",Jy.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===t.command&&(this.errorCode=Zy.SRC_TOKEN_EXPIRED,this.state=Xy.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===t.command&&(this.errorCode=Zy.DEST_TOKEN_EXPIRED,this.state=Xy.RELAY_STATE_FAILURE))})),nu(this,"onReconnect",(async()=>{$b.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Jy.NETWORK_DISCONNECTED),this.state=Xy.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((t=>{this.state!==Xy.RELAY_STATE_IDLE&&($b.error("auto restart channel media relay failed",t.toString()),this.errorCode=Zy.SERVER_CONNECTION_LOST,this.state=Xy.RELAY_STATE_FAILURE)}))})),this.joinInfo=t,this.clientId=e,this.sid=VE(),this.signal=new AL(this.joinInfo,this.clientId,i),this.httpRetryConfig=n,this._resolution=s}async startChannelMediaRelay(t){if(this.state!==Xy.RELAY_STATE_IDLE)throw new Uy(U_.INVALID_OPERATION);this.state=Xy.RELAY_STATE_CONNECTING,await this.connect(),$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(t){if(t.data&&t.data.serverResponse&&"SetSourceChannel"===t.data.serverResponse.command)throw new Uy(U_.CROSS_CHANNEL_FAILED_JOIN_SRC);if(t.data&&t.data.serverResponse&&"SetDestChannelStatus"===t.serverResponse.command)throw new Uy(U_.CROSS_CHANNEL_FAILED_JOIN_DEST);if(t.data&&t.data.serverResponse&&"StartPacketTransfer"===t.serverResponse.command)throw new Uy(U_.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw t}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==Xy.RELAY_STATE_RUNNING)throw new Uy(U_.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==Xy.RELAY_STATE_RUNNING)throw new Uy(U_.INVALID_OPERATION);const e=this.genMessage(Yy.SetVideoProfile);await this.signal.request(e),$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),$b.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Xy.RELAY_STATE_IDLE,this.dispose()}dispose(){$b.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=gb.CancelToken.source(),this.state=Xy.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await gL(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",Jy.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const e=this.genMessage(Yy.StopPacketTransfer);await this.signal.request(e),await this.signal.waitStatus("Normal Quit"),$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=this.genMessage(Yy.SetSdkProfile,t);await this.signal.request(i),$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const n=this.genMessage(Yy.SetSourceChannel,t);await this.signal.request(n),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Jy.PACKET_JOINED_SRC_CHANNEL),$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const s=this.genMessage(Yy.SetSourceUserId,t);await this.signal.request(s),$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(Yy.SetDestChannel,t);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Jy.PACKET_JOINED_DEST_CHANNEL),$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const r=this.genMessage(Yy.StartPacketTransfer,t);await this.signal.request(r),this.emit("event",Jy.PACKET_SENT_TO_DEST_CHANNEL),this.state=Xy.RELAY_STATE_RUNNING,$b.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const e=this.genMessage(Yy.UpdateDestChannel,t);await this.signal.request(e),this.emit("event",Jy.PACKET_UPDATE_DEST_CHANNEL),$b.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(Yy.StopPacketTransfer);await this.signal.request(t),$b.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,e){const i=[],n=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Ob,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.19.3"===o.sdkVersion&&(o.sdkVersion="0.0.1");let r=null,a=null;switch(t){case Yy.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case Yy.SetSourceChannel:if(a=e&&e.getSrcChannelMediaInfo(),!a)throw new Uy(U_.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case Yy.SetSourceUserId:if(a=e&&e.getSrcChannelMediaInfo(),!a)throw new Uy(U_.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case Yy.SetDestChannel:if(r=e&&e.getDestChannelMediaInfo(),!r)throw new Uy(U_.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((t=>{i.push(t.channelName),n.push(t.uid+""),s.push(t.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:s},o;case Yy.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case Yy.Reconnect:return o.clientRequest={command:"Reconnect"},o;case Yy.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case Yy.UpdateDestChannel:if(r=e&&e.getDestChannelMediaInfo(),!r)throw new Uy(U_.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((t=>{i.push(t.channelName),n.push(t.uid+""),s.push(t.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:s},o;case Yy.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}class NL{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio)return this._audioTrack}get videoTrack(){if(this.hasVideo)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,e){nu(this,"uid",void 0),nu(this,"_uintid",void 0),nu(this,"_trust_in_room_",!0),nu(this,"_trust_audio_enabled_state_",!0),nu(this,"_trust_video_enabled_state_",!0),nu(this,"_trust_audio_mute_state_",!0),nu(this,"_trust_video_mute_state_",!0),nu(this,"_audio_muted_",!1),nu(this,"_video_muted_",!1),nu(this,"_audio_enabled_",!0),nu(this,"_video_enabled_",!0),nu(this,"_audio_added_",!1),nu(this,"_video_added_",!1),nu(this,"_trust_video_stream_added_state_",!0),nu(this,"_trust_audio_stream_added_state_",!0),nu(this,"_audioTrack",void 0),nu(this,"_videoTrack",void 0),nu(this,"_dataChannels",[]),nu(this,"_audioSSRC",void 0),nu(this,"_videoSSRC",void 0),nu(this,"_audioOrtc",void 0),nu(this,"_videoOrtc",void 0),nu(this,"_cname",void 0),nu(this,"_rtxSsrcId",void 0),this.uid=t,this._uintid=e}}var kL=t_,LL=of;Mn({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var t=LL.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var PL=of,DL=Fg;Mn({target:"Promise",stat:!0,forced:!0},{try:function(t){var e=PL.f(this),i=DL(t);return(i.error?e.reject:e.resolve)(i.value),e.promise}});var ML=K(kL),xL=Br.f("asyncIterator"),UL=K(xL);function VL(t,e){this.v=t,this.k=e}function FL(t){var e,i;function n(e,i){try{var o=t[e](i),r=o.value,a=r instanceof VL;ML.resolve(a?r.v:r).then((function(i){if(a){var c="return"===e?"return":"next";if(!r.k||i.done)return n(c,i);i=t[c](i).value}s(o.done?"return":"normal",i)}),(function(t){n("throw",t)}))}catch(t){s("throw",t)}}function s(t,s){switch(t){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?n(e.key,e.arg):i=null}this._invoke=function(t,s){return new ML((function(o,r){var a={key:t,arg:s,resolve:o,reject:r,next:null};i?i=i.next=a:(e=i=a,n(t,s))}))},"function"!=typeof t.return&&(this.return=void 0)}function BL(t){return function(){return new FL(t.apply(this,arguments))}}function jL(t){return new VL(t,0)}function HL(t){var e={},i=!1;function n(e,n){return i=!0,{done:!1,value:new VL(n=new ML((function(i){i(t[e](n))})),1)}}return e[void 0!==xh&&Qh||"@@iterator"]=function(){return this},e.next=function(t){return i?(i=!1,t):n("next",t)},"function"==typeof t.throw&&(e.throw=function(t){if(i)throw i=!1,t;return n("throw",t)}),"function"==typeof t.return&&(e.return=function(t){return i?(i=!1,t):n("return",t)}),e}FL.prototype["function"==typeof xh&&UL||"@@asyncIterator"]=function(){return this},FL.prototype.next=function(t){return this._invoke("next",t)},FL.prototype.throw=function(t){return this._invoke("throw",t)},FL.prototype.return=function(t){return this._invoke("return",t)};var GL=K(xL),WL={exports:{}};!function(t,e){t.exports=(()=>{var t={8:(t,e,i)=>{i.r(e),i.d(e,{Parser:()=>b,Printer:()=>I,parse:()=>k,print:()=>L});const n="\n",s="".concat("\r").concat(n),o=" ";let r;function a(t){return t>="0"&&t<="9"}function c(t){return t>="!"&&t<="~"}function d(t){return c(t)||t>=""&&t<="ÿ"}function l(t){return"!"===t||t>="#"&&t<="'"||t>="*"&&t<="+"||t>="-"&&t<="."||t>="0"&&t<="9"||t>="A"&&t<="Z"||t>="^"&&t<="~"}function h(t){return t>="1"&&t<="9"}function u(t){return t>="A"&&t<="Z"||t>="a"&&t<="z"}function p(t){return"d"===t||"h"===t||"m"===t||"s"===t}function m(t){return t>""&&t<"\t"||t>"\v"&&t<"\f"||t>""&&t<"ÿ"}function g(t){return u(t)||a(t)||"+"===t||"/"===t}function f(t){return a(t)||u(t)||"+"===t||"/"===t||"-"===t||"_"===t}function v(t){return u(t)||a(t)||"+"===t||"/"===t}function _(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function E(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?_(Object(i),!0).forEach((function(e){S(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):_(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function S(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}!function(t){t.VERSION="v",t.ORIGIN="o",t.SESSION_NAME="s",t.INFORMATION="i",t.URI="u",t.EMAIL="e",t.PHONE="p",t.CONNECTION="c",t.BANDWIDTH="b",t.TIME="t",t.REPEAT="r",t.ZONE_ADJUSTMENTS="z",t.KEY="k",t.ATTRIBUTE="a",t.MEDIA="m"}(r||(r={}));class T{consumeText(t,e){let i=e;for(;i<t.length;){const e=t[i];if("\0"===e||"\r"===e||e===n)break;i+=1}if(i-e==0)throw new Error("Invalid text, at ".concat(t));return i}consumeUnicastAddress(t,e,i){return this.consumeTill(t,e,o)}consumeOneOrMore(t,e,i){let n=e;for(;i(t[n]);)n++;if(n-e==0)throw new Error("Invalid rule at ".concat(e,"."));return n}consumeSpace(t,e){if(t[e]===o)return e+1;throw new Error("Invalid space at ".concat(e,"."))}consumeIP4Address(t,e){let i=e;for(let e=0;e<4;e++)if(i=this.consumeDecimalUChar(t,i),3!==e){if("."!==t[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(t,e){let i=e;for(let e=0;e<3&&a(t[i]);e++,i++);if(i-e==0)throw new Error("Invalid decimal uchar.");const n=parseInt(t.slice(e,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(t,e){let i=this.consumeHexpart(t,e);return":"===t[i]?(i+=1,i=this.consumeIP4Address(t,i),i):i}consumeHexpart(t,e){let i=e;if(":"===t[i]&&":"===t[i+1]){i+=2;try{i=this.consumeHexseq(t,i)}catch(t){}return i}if(i=this.consumeHexseq(t,i),":"===t[i]&&":"===t[i+1]){i+=2;try{i=this.consumeHexseq(t,i)}catch(t){}return i}return i}consumeHexseq(t,e){let i=e;for(;i=this.consumeHex4(t,i),":"===t[i]&&":"!==t[i+1];)i+=1;return i}consumeHex4(t,e){let i=0;for(;i<4;i++)if(!((n=t[e+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return e+i}consumeFQDN(t,e){let i=e;for(;a(t[i])||u(t[i])||"-"===t[i]||"."===t[i];)i+=1;if(i-e<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(t,e){return this.consumeOneOrMore(t,e,d)}consumeMulticastAddress(t,e,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(t,e);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(t,e);default:try{return this.consumeFQDN(t,e)}catch(i){return this.consumeExtnAddr(t,e)}}}consumeIP6MulticastAddress(t,e){const i=this.consumeHexpart(t,e);return"/"===t[i]?this.consumeInteger(t,i+1):i}consumeIP4MulticastAddress(t,e){let i=e+3;const n=t.slice(e,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let e=0;e<3;e++){if("."!==t[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(t,i)}return"/"===t[i]&&(i+=1),i=this.consumeTTL(t,i),"/"===t[i]&&(i=this.consumeInteger(t,i)),i}consumeInteger(t,e){if(!h(t[e]))throw new Error("Invalid integer.");for(e+=1;a(t[e]);)e+=1;return e}consumeTTL(t,e){if("0"===t[e])return e+1;if(!h(t[e]))throw new Error("Invalid TTL.");e+=1;for(let i=0;i<2&&a(t[e]);i++)e+=1;return e}consumeToken(t,e){return this.consumeOneOrMore(t,e,l)}consumeTime(t,e){let i=e;if("0"===t[i])return i+1;for(h(t[i])&&(i+=1);a(t[i]);)i++;if(i-e<10)throw new Error("Invalid time");return i}consumeAddress(t,e){return this.consumeTill(t,e,o)}consumeTypedTime(t,e){let i=e;return i=this.consumeOneOrMore(t,i,a),p(t[i])?i+1:i}consumeRepeatInterval(t,e){if(!h(t[e]))throw new Error("Invalid repeat interval");for(e+=1;a(t[e]);)e+=1;return p(t[e])&&(e+=1),e}consumePort(t,e){return this.consumeOneOrMore(t,e,a)}consume(t,e,i){for(let n=0;n<i.length;n++){if(e+n>=t.length)throw new Error("consume exceeding value length");if(t[e+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return e+i.length}consumeTill(t,e,i){let n=e;for(;n<t.length&&("string"!=typeof i||t[n]!==i)&&("function"!=typeof i||!i(t[n]));)n++;return n}}class b extends T{constructor(){super(),S(this,"records",[]),S(this,"currentLine",0)}parse(t){const e=this.probeEOL(t);this.records=t.split(e).filter((t=>!!t.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),o=this.parseInformation(),r=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),m=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:o,uri:r,emails:a,phones:c,connection:d,bandwidths:l,timeFields:h,key:u,attributes:p,mediaDescriptions:m}}getCurrentRecord(){const t=this.records[this.currentLine];if(!t)throw new Error("Record doesn't exit.");return t}probeEOL(t){for(let e=0;e<t.length;e++)if(t[e]===n)return"\r"===t[e-1]?s:n;throw new Error("Invalid newline character.")}parseLine(t,e){if(t.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=t[0];if("="!==t[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:t.slice(2),line:e,cur:0}}parseSessionAttribute(){const t=new C;for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(t=>l(t)&&":"!==t)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,m)),t.parse(i),this.currentLine++}return t.digest()}parseMediaAttributes(t){const e=new w(t);for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(t=>l(t)&&":"!==t)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,m)),e.parse(i),this.currentLine++}return e.digest()}parseKey(){const t=this.getCurrentRecord();if(t.type===r.KEY){if("prompt"===t.value||"clear:"===t.value||"base64:"===t.value||"uri:"===t.value)return t.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const t=this.getCurrentRecord();if(t.type===r.ZONE_ADJUSTMENTS){const e=[];for(;;)try{const i=this.extract(t,this.consumeTime);this.consumeSpaceForRecord(t);let n=!1;"-"===t.value[t.cur]&&(n=!0,t.cur+=1);const s=this.extract(t,this.consumeTypedTime);e.push({time:i,typedTime:s,back:n})}catch(t){break}if(0===e.length)throw new Error("Invalid zone adjustments");return this.currentLine++,e}return[]}parseRepeat(){const t=[];for(;;){const e=this.getCurrentRecord();if(e.type!==r.REPEAT)break;{const i=this.extract(e,this.consumeRepeatInterval),n=this.parseTypedTime(e);t.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return t}parseTypedTime(t){const e=[];for(;;)try{this.consumeSpaceForRecord(t),e.push(this.extract(t,this.consumeTypedTime))}catch(t){break}if(0===e.length)throw new Error("Invalid typed time.");return e}parseTime(){const t=this.getCurrentRecord(),e=this.extract(t,this.consumeTime);this.consumeSpaceForRecord(t);const i=this.extract(t,this.consumeTime);return this.currentLine++,{startTime:e,stopTime:i}}parseBandWidth(){const t=[];for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==r.BANDWIDTH)break;{const i=this.extractOneOrMore(e,l);if(":"!==e.value[e.cur])throw new Error("Invalid bandwidth field.");e.cur++;const n=this.extractOneOrMore(e,a);t.push({bwtype:i,bandwidth:n}),this.currentLine++}}return t}parseVersion(){const t=this.getCurrentRecord();if(t.type!==r.VERSION)throw new Error("first sdp record must be version");const e=t.value.slice(0,this.consumeOneOrMore(t.value,0,a));if(e.length!==t.value.length)throw new Error('invalid proto version, "v='.concat(t.value,'"'));return this.currentLine++,e}parseOrigin(){const t=this.getCurrentRecord();if(t.type!==r.ORIGIN)throw new Error("second line of sdp must be origin");const e=this.extractOneOrMore(t,d);this.consumeSpaceForRecord(t);const i=this.extractOneOrMore(t,a);this.consumeSpaceForRecord(t);const n=this.extractOneOrMore(t,a);this.consumeSpaceForRecord(t);const s=this.extractOneOrMore(t,l);this.consumeSpaceForRecord(t);const o=this.extractOneOrMore(t,l);this.consumeSpaceForRecord(t);const c=this.extract(t,this.consumeUnicastAddress);return this.currentLine++,{username:e,sessId:i,sessVersion:n,nettype:s,addrtype:o,unicastAddress:c}}parseSessionName(){const t=this.getCurrentRecord();if(t.type===r.SESSION_NAME){const e=this.extract(t,this.consumeText);return this.currentLine++,e}}parseInformation(){const t=this.getCurrentRecord();if(t.type!==r.INFORMATION)return;const e=this.extract(t,this.consumeText);return this.currentLine++,e}parseUri(){const t=this.getCurrentRecord();if(t.type===r.URI)return this.currentLine++,t.value}parseEmail(){const t=[];for(;;){const e=this.getCurrentRecord();if(e.type!==r.EMAIL)break;t.push(e.value),this.currentLine++}return t}parsePhone(){const t=[];for(;;){const e=this.getCurrentRecord();if(e.type!==r.PHONE)break;t.push(e.value),this.currentLine++}return t}parseConnection(){const t=this.getCurrentRecord();if(t.type===r.CONNECTION){const e=this.extractOneOrMore(t,l);this.consumeSpaceForRecord(t);const i=this.extractOneOrMore(t,l);this.consumeSpaceForRecord(t);const n=this.extract(t,this.consumeAddress);return this.currentLine++,{nettype:e,addrtype:i,address:n}}}parseMedia(){const t=this.getCurrentRecord(),e=this.extract(t,this.consumeToken);this.consumeSpaceForRecord(t);let i=this.extract(t,this.consumePort);"/"===t.value[t.cur]&&(t.cur+=1,i+=this.extract(t,this.consumeInteger)),this.consumeSpaceForRecord(t);const n=[];for(n.push(this.extract(t,this.consumeToken));"/"===t.value[t.cur];)t.cur+=1,n.push(this.extract(t,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(t);return this.currentLine++,{mediaType:e,port:i,protos:n,fmts:s}}parseTimeFields(){const t=[];for(;this.getCurrentRecord().type===r.TIME;){const e=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();t.push({time:e,repeats:i,zones:n})}return t}parseMediaDescription(){const t=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.MEDIA;){const e=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),o=this.parseKey(),r=this.parseMediaAttributes(e);t.push({media:e,information:i,connections:n,bandwidths:s,key:o,attributes:r})}return t}parseConnections(){const t=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.CONNECTION;)t.push(this.parseConnection());return t}parseFmt(t){const e=[];for(;;)try{this.consumeSpaceForRecord(t),e.push(this.extract(t,this.consumeToken))}catch(t){break}if(0===e.length)throw new Error("Invalid fmts");return e}extract(t,e,...i){const n=e.call(this,t.value,t.cur,...i),s=t.value.slice(t.cur,n);return t.cur=n,s}extractOneOrMore(t,e){const i=this.consumeOneOrMore(t.value,t.cur,e),n=t.value.slice(t.cur,i);return t.cur=i,n}consumeSpaceForRecord(t){if(t.value[t.cur]!==o)throw new Error("Invalid space at ".concat(t.cur,"."));t.cur+=1}}class y extends T{constructor(...t){super(...t),S(this,"attributes",void 0),S(this,"digested",!1)}extractOneOrMore(t,e,i){const n=this.consumeOneOrMore(t.attValue,t._cur,e),s=t.attValue.slice(t._cur,n),[o,r]=i||[];if("number"==typeof o&&s.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof r&&s.length>r)throw new Error("error in length, should be less or equal than ".concat(r," characters."));return t._cur=n,s}consumeAttributeSpace(t){if(t.attValue[t._cur]!==o)throw new Error("Invalid space at ".concat(t._cur,"."));t._cur+=1}extract(t,e,...i){if(!t.attValue)throw new Error("Nothing to extract from attValue.");const n=e.call(this,t.attValue,t._cur,...i),s=t.attValue.slice(t._cur,n);return t._cur=n,s}atEnd(t){if(!t.attValue)throw new Error;return t._cur>=t.attValue.length}peekChar(t){if(!t.attValue)throw new Error;return t.attValue[t._cur]}peek(t,e){if(!t.attValue)throw new Error;for(let i=0;i<e.length;i++)if(e[i]!==t.attValue[t._cur+i])return!1;return!0}parseIceUfrag(t){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(t,g,[4,256])}parseIcePwd(t){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(t,g,[22,256])}parseIceOptions(t){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const e=[];for(;!this.atEnd(t);){e.push(this.extractOneOrMore(t,g));try{this.consumeAttributeSpace(t)}catch(e){if(this.atEnd(t))break;throw e}}this.attributes.iceOptions=e}parseFingerprint(t){const e=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill);this.attributes.fingerprints.push({hashFunction:e,fingerprint:i})}parseExtmap(t){const e=this.extractOneOrMore(t,a);let i;"/"===this.peekChar(t)&&(this.extract(t,this.consume,"/"),i=this.extract(t,this.consumeToken)),this.consumeAttributeSpace(t);const n=this.extract(t,this.consumeTill,o),s=E(E({entry:parseInt(e,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(t)===o&&(this.consumeAttributeSpace(t),s.extensionAttributes=this.extract(t,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(t){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const e=this.extract(t,this.consumeTill);if("active"!==e&&"passive"!==e&&"actpass"!==e&&"holdconn"!==e)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=e}}class C extends y{constructor(...t){super(...t),S(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(t){if(this.digested)throw new Error("already digested");try{switch(t.attField){case"group":this.parseGroup(t);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(t);break;case"ice-pwd":this.parseIcePwd(t);break;case"ice-options":this.parseIceOptions(t);break;case"fingerprint":this.parseFingerprint(t);break;case"setup":this.parseSetup(t);break;case"tls-id":this.parseTlsId(t);break;case"identity":this.parseIdentity(t);break;case"extmap":this.parseExtmap(t);break;case"msid-semantic":this.parseMsidSemantic(t);break;default:t.ignored=!0,this.attributes.unrecognized.push(t)}}catch(e){throw console.error("parsing session attribute ".concat(t.attField,' error, "a=').concat(t.attField,":").concat(t.attValue,'"')),e}if(!t.ignored&&t.attValue&&!this.atEnd(t))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(t){const e=this.extract(t,this.consumeToken),i=[];for(;!this.atEnd(t)&&this.peekChar(t)===o;)this.consumeAttributeSpace(t),i.push(this.extract(t,this.consumeToken));this.attributes.groups.push({semantic:e,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(t){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(t,f)}parseIdentity(t){const e=this.extractOneOrMore(t,v),i=[];for(;!this.atEnd(t)&&this.peekChar(t)===o;){this.consumeAttributeSpace(t);const e=this.extract(t,this.consumeToken);this.extract(t,this.consume,"=");const n=this.extractOneOrMore(t,(t=>t!==o&&m(t)));i.push({name:e,value:n})}this.attributes.identities.push({assertionValue:e,extensions:i})}parseMsidSemantic(t){this.peekChar(t)===o&&this.consumeAttributeSpace(t);const e={semantic:this.extract(t,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(t)}catch(t){break}if("*"===this.peekChar(t)){this.extract(t,this.consume,"*"),e.applyForAll=!0;break}{const i=this.extract(t,this.consumeTill,o);e.identifierList.push(i)}}this.attributes.msidSemantic=e}}class w extends y{constructor(t){super(),S(this,"attributes",void 0),-1!==t.protos.indexOf("RTP")||t.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(t){if(this.digested)throw new Error("already digested");try{switch(t.attField){case"extmap":this.parseExtmap(t);break;case"setup":this.parseSetup(t);break;case"ice-ufrag":this.parseIceUfrag(t);break;case"ice-pwd":this.parseIcePwd(t);break;case"ice-options":this.parseIceOptions(t);break;case"candidate":this.parseCandidate(t);break;case"remote-candidate":this.parseRemoteCandidate(t);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(t);break;case"rtpmap":this.parseRtpmap(t);break;case"ptime":this.parsePtime(t);break;case"maxptime":this.parseMaxPtime(t);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(t);break;case"ssrc":this.parseSSRC(t);break;case"fmtp":this.parseFmtp(t);break;case"rtcp-fb":this.parseRtcpFb(t);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(t);break;case"mid":this.parseMid(t);break;case"msid":this.parseMsid(t);break;case"imageattr":this.parseImageAttr(t);break;case"rid":this.parseRid(t);break;case"simulcast":this.parseSimulcast(t);break;case"sctp-port":this.parseSctpPort(t);break;case"max-message-size":this.parseMaxMessageSize(t);break;case"ssrc-group":this.parseSSRCGroup(t);break;default:t.ignored=!0,this.attributes.unrecognized.push(t)}}catch(e){throw console.error("parsing media attribute ".concat(t.attField,' error, "a=').concat(t.attField,":").concat(t.attValue,'"')),e}if(!t.ignored&&t.attValue&&!this.atEnd(t))throw new Error("attribute parsing error")}parseCandidate(t){const e=this.extractOneOrMore(t,g,[1,32]);this.consumeAttributeSpace(t);const i=this.extractOneOrMore(t,a,[1,5]);this.consumeAttributeSpace(t);const n=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t);const s=this.extractOneOrMore(t,a,[1,10]);this.consumeAttributeSpace(t);const r=this.extract(t,this.consumeAddress);this.consumeAttributeSpace(t);const d=this.extract(t,this.consumePort);this.consumeAttributeSpace(t),this.extract(t,this.consume,"typ"),this.consumeAttributeSpace(t);const l={foundation:e,componentId:i,transport:n,priority:s,connectionAddress:r,port:d,type:this.extract(t,this.consumeToken),extension:{}};for(this.peek(t," raddr")&&(this.extract(t,this.consume," raddr"),this.consumeAttributeSpace(t),l.relAddr=this.extract(t,this.consumeAddress)),this.peek(t," rport")&&(this.extract(t,this.consume," rport"),this.consumeAttributeSpace(t),l.relPort=this.extract(t,this.consumePort));this.peekChar(t)===o;){this.consumeAttributeSpace(t);const e=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t),l.extension[e]=this.extractOneOrMore(t,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(t){const e=[];for(;;){const i=this.extractOneOrMore(t,a,[1,5]);this.consumeAttributeSpace(t);const n=this.extract(t,this.consumeAddress);this.consumeAttributeSpace(t);const s=this.extract(t,this.consumePort);e.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(t)}catch(t){break}}this.attributes.remoteCandidatesList.push(e)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(t){const e=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill,"/");this.extract(t,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(t,a)};this.atEnd(t)||"/"!==this.peekChar(t)||(this.extract(t,this.consume,"/"),n.encodingParameters=parseInt(this.extract(t,this.consumeTill),10));const s=this.attributes.payloads.find((t=>t.payloadType===parseInt(e,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(e,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(t){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(t,this.consumeTill)}parseMaxPtime(t){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(t,this.consumeTill)}parseDirection(t){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=t.attField}parseSSRC(t){const e=this.extractOneOrMore(t,a);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill,":");let n;":"===this.peekChar(t)&&(this.extract(t,this.consume,":"),n=this.extract(t,this.consumeTill));const s=this.attributes.ssrcs.find((t=>t.ssrcId===parseInt(e,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(e,10),attributes:{[i]:n}})}parseFmtp(t){const e=this.extract(t,this.consumeTill,o);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill),n={};i.split(";").forEach((t=>{let[e,i]=t.split("=");e=e.trim();const s="string"==typeof i?i.trim():null;"string"==typeof e&&e.length>0&&(n[e]=s)}));const s=this.attributes.payloads.find((t=>t.payloadType===parseInt(e,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(e,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(t){const e={},i=this.extract(t,this.consumeTill,"=");t._cur++;const n=this.extract(t,this.consumeTill,";");for(e[i]=n;";"===t.attValue[t._cur];){const i=this.extract(t,this.consumeTill,"=");t._cur++;const n=this.extract(t,this.consumeTill,";");e[i]=n}return e}parseRtcpFb(t){let e="";e="*"===this.peekChar(t)?this.extract(t,this.consume,"*"):this.extract(t,this.consumeTill,o),this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill,o);let n;if("trr-int"===i)n={type:i,interval:this.extract(t,this.consumeTill)};else{const e={type:i};this.peekChar(t)===o&&(this.consumeAttributeSpace(t),e.parameter=this.extract(t,this.consumeToken),this.peekChar(t)===o&&(e.additional=this.extract(t,this.consumeTill))),n=e}if("*"===e)this.attributes.rtcpFeedbackWildcards.push(n);else{const t=this.attributes.payloads.find((t=>t.payloadType===parseInt(e,10)));t?t.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(e,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(t){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const e={port:this.extract(t,this.consumePort)};this.peekChar(t)===o&&(this.consumeAttributeSpace(t),e.netType=this.extractOneOrMore(t,l),this.consumeAttributeSpace(t),e.addressType=this.extractOneOrMore(t,l),this.consumeAttributeSpace(t),e.address=this.extract(t,this.consumeAddress)),this.attributes.rtcp=e}parseMsid(t){const e={id:this.extractOneOrMore(t,l,[1,64])};this.peekChar(t)===o&&(this.consumeAttributeSpace(t),e.appdata=this.extractOneOrMore(t,l,[1,64])),this.attributes.msids.push(e)}parseImageAttr(t){this.attributes.imageattr.push(t.attValue)}parseRid(t){const e=this.extractOneOrMore(t,(t=>u(t)||a(t)||"_"===t||"-"===t));this.consumeAttributeSpace(t);const i={id:e,direction:this.extract(t,this.consumeToken),params:[]};if(this.peekChar(t)===o){if(this.consumeAttributeSpace(t),this.peek(t,"pt=")){this.extract(t,this.consume,"pt=");const e=[];for(;;){const i=this.extract(t,this.consumeToken);e.push(i);try{this.extract(t,this.consume,",")}catch(t){break}}i.payloads=e,this.peekChar(t)===o&&this.extract(t,this.consume,o)}for(;;){const e=this.extract(t,this.consumeToken);switch(e){case"depend":{const n={type:e,rids:this.extract(t,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:e};"="===this.peekChar(t)&&(this.extract(t,this.consume,"="),n.val=this.extract(t,this.consumeTill,";")),i.params.push(n)}}try{this.extract(t,this.consume,";")}catch(t){break}}}this.attributes.rids.push(i)}parseSimulcast(t){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=t.attValue,this.extract(t,this.consumeTill)}parseSctpPort(t){this.attributes.sctpPort=this.extractOneOrMore(t,a,[1,5])}parseMaxMessageSize(t){this.attributes.maxMessageSize=this.extractOneOrMore(t,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(t){this.attributes.mid=this.extract(t,this.consumeToken)}parseSSRCGroup(t){const e=this.extract(t,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(t);const e=this.extract(t,this.consumeInteger);i.push(parseInt(e,10))}catch(t){break}this.attributes.ssrcGroups.push({semantic:e,ssrcIds:i})}}function R(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class I{constructor(){R(this,"eol",s)}print(t,e){let i="";return e&&(this.eol=e),i+=this.printVersion(t.version),i+=this.printOrigin(t.origin),i+=this.printSessionName(t.sessionName),i+=this.printInformation(t.information),i+=this.printUri(t.uri),i+=this.printEmail(t.emails),i+=this.printPhone(t.phones),i+=this.printConnection(t.connection),i+=this.printBandwidth(t.bandwidths),i+=this.printTimeFields(t.timeFields),i+=this.printKey(t.key),i+=this.printSessionAttributes(t.attributes),i+=this.printMediaDescription(t.mediaDescriptions),i}printVersion(t){return"v=".concat(t).concat(this.eol)}printOrigin(t){return"o=".concat(t.username," ").concat(t.sessId," ").concat(t.sessVersion," ").concat(t.nettype," ").concat(t.addrtype," ").concat(t.unicastAddress).concat(this.eol)}printSessionName(t){return t?"s=".concat(t).concat(this.eol):""}printInformation(t){return t?"i=".concat(t).concat(this.eol):""}printUri(t){return t?"u=".concat(t).concat(this.eol):""}printEmail(t){let e="";for(const i of t)e+="e=".concat(i).concat(this.eol);return e}printPhone(t){let e="";for(const i of t)e+="e=".concat(i).concat(this.eol);return e}printConnection(t){return t?"c=".concat(t.nettype," ").concat(t.addrtype," ").concat(t.address).concat(this.eol):""}printBandwidth(t){let e="";for(const i of t)e+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return e}printTimeFields(t){let e="";for(const i of t){e+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const t of i.repeats)e+="r=".concat(t.repeatInterval," ").concat(t.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(e+="z=",e+="z=".concat(i.zoneAdjustments.map((t=>"".concat(t.time," ").concat(t.back?"-":""," ").concat(t.typedTime))).join(" ")).concat(this.eol),e+=this.eol)}return e}printKey(t){return t?"k=".concat(t).concat(this.eol):""}printAttributes(t){let e="";for(const i of t)e+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return e}printMediaDescription(t){let e="";for(const i of t)e+=this.printMedia(i.media),e+=this.printInformation(i.information),e+=this.printConnections(i.connections),e+=this.printBandwidth(i.bandwidths),e+=this.printKey(i.key),e+=this.printMediaAttributes(i);return e}printConnections(t){let e="";for(const i of t)e+=this.printConnection(i);return e}printMedia(t){return"m=".concat(t.mediaType," ").concat(t.port," ").concat(t.protos.join("/")," ").concat(t.fmts.join(" ")).concat(this.eol)}printSessionAttributes(t){return new O(this.eol).print(t)}printMediaAttributes(t){return new N(this.eol).print(t)}}class A{constructor(t){R(this,"eol",void 0),this.eol=t}printIceUfrag(t){return void 0===t?"":"a=ice-ufrag:".concat(t).concat(this.eol)}printIcePwd(t){return void 0===t?"":"a=ice-pwd:".concat(t).concat(this.eol)}printIceOptions(t){return void 0===t?"":"a=ice-options:".concat(t.join(o)).concat(this.eol)}printFingerprints(t){return t.length>0?t.map((t=>"a=fingerprint:".concat(t.hashFunction).concat(o).concat(t.fingerprint))).join(this.eol)+this.eol:""}printExtmap(t){return t.map((t=>"a=extmap:".concat(t.entry).concat(t.direction?"/".concat(t.direction):"").concat(o).concat(t.extensionName).concat(t.extensionAttributes?"".concat(o).concat(t.extensionAttributes):"").concat(this.eol))).join("")}printSetup(t){return void 0===t?"":"a=setup:".concat(t).concat(this.eol)}printUnrecognized(t){return t.map((t=>"a=".concat(t.attField).concat(t.attValue?":".concat(t.attValue):"").concat(this.eol))).join("")}}class O extends A{print(t){let e="";return e+=this.printGroups(t.groups),e+=this.printMsidSemantic(t.msidSemantic),e+=this.printIceLite(t.iceLite),e+=this.printIceUfrag(t.iceUfrag),e+=this.printIcePwd(t.icePwd),e+=this.printIceOptions(t.iceOptions),e+=this.printFingerprints(t.fingerprints),e+=this.printSetup(t.setup),e+=this.printTlsId(t.tlsId),e+=this.printIdentity(t.identities),e+=this.printExtmap(t.extmaps),e+=this.printUnrecognized(t.unrecognized),e}printGroups(t){let e="";return t.length>0&&(e+=t.map((t=>"a=group:".concat(t.semantic).concat(t.identificationTag.map((t=>"".concat(o).concat(t))).join("")).concat(this.eol))).join("")),e}printIceLite(t){return void 0===t?"":"a=ice-lite"+this.eol}printTlsId(t){return t?"a=tls-id:".concat(t).concat(this.eol):""}printIdentity(t){return 0===t.length?"":t.map((t=>"a=identity:".concat(t.assertionValue).concat(t.extensions.map((t=>"".concat(o).concat(t.name).concat(t.value?"=".concat(t.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(t){if(!t)return"";let e="a=msid-semantic:".concat(t.semantic);return t.applyForAll?e+="".concat(o,"*"):t.identifierList.length>0&&(e+=t.identifierList.map((t=>"".concat(o).concat(t)))),e+this.eol}}class N extends A{print(t){const e=t.attributes;let i="";return i+=this.printRTCP(e.rtcp),i+=this.printIceUfrag(e.iceUfrag),i+=this.printIcePwd(e.icePwd),i+=this.printIceOptions(e.iceOptions),i+=this.printCandidates(e.candidates),i+=this.printRemoteCandidatesList(e.remoteCandidatesList),i+=this.printEndOfCandidates(e.endOfCandidates),i+=this.printFingerprints(e.fingerprints),i+=this.printSetup(e.setup),i+=this.printMid(e.mid),i+=this.printExtmap(e.extmaps),i+=this.printRTPRelated(e),i+=this.printPtime(e.ptime),i+=this.printMaxPtime(e.maxPtime),i+=this.printDirection(e.direction),i+=this.printSSRCGroups(e.ssrcGroups),i+=this.printSSRC(e.ssrcs),i+=this.printRTCPMux(e.rtcpMux),i+=this.printRTCPMuxOnly(e.rtcpMuxOnly),i+=this.printRTCPRsize(e.rtcpRsize),i+=this.printMSId(e.msids),i+=this.printImageattr(e.imageattr),i+=this.printRid(e.rids),i+=this.printSimulcast(e.simulcast),i+=this.printSCTPPort(e.sctpPort),i+=this.printMaxMessageSize(e.maxMessageSize),i+=this.printUnrecognized(e.unrecognized),i}printCandidates(t){return t.map((t=>"a=candidate:".concat(t.foundation).concat(o).concat(t.componentId).concat(o).concat(t.transport).concat(o).concat(t.priority).concat(o).concat(t.connectionAddress).concat(o).concat(t.port).concat(o,"typ").concat(o).concat(t.type).concat(t.relAddr?"".concat(o,"raddr").concat(o).concat(t.relAddr):"").concat(t.relPort?"".concat(o,"rport").concat(o).concat(t.relPort):"").concat(Object.keys(t.extension).map((e=>"".concat(o).concat(e).concat(o).concat(t.extension[e]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(t){return t.map((t=>"a=remote-candidates:".concat(t.join(o)).concat(this.eol))).join("")}printEndOfCandidates(t){return void 0===t?"":"a=end-of-candidates"+this.eol}printRTPRelated(t){if(!t.payloads)return"";const e=t.payloads;let i="";i+=t.rtcpFeedbackWildcards.map((t=>this.printRTCPFeedback("*",t))).join("");for(const t of e)i+=this.printRtpMap(t.payloadType,t.rtpMap),i+=this.printFmtp(t.payloadType,t.fmtp),i+=t.rtcpFeedbacks.map((e=>this.printRTCPFeedback(t.payloadType,e))).join("");return i}printFmtp(t,e){if(!e)return"";const i=Object.keys(e.parameters);return 1===i.length&&null===e.parameters[i[0]]?"a=fmtp:".concat(t).concat(o).concat(i[0]).concat(this.eol):"a=fmtp:".concat(t).concat(o).concat(Object.keys(e.parameters).map((t=>"".concat(t,"=").concat(e.parameters[t]))).join(";")).concat(this.eol)}printRtpMap(t,e){return e?"a=rtpmap:".concat(t).concat(o).concat(e.encodingName,"/").concat(e.clockRate).concat(e.encodingParameters?"/".concat(e.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(t,e){let i="a=rtcp-fb:".concat(t).concat(o),n=e;return"trr-int"===n.type?i+="ttr-int".concat(o).concat(n.interval):(i+="".concat(n.type),n.parameter&&(i+="".concat(o).concat(n.parameter),n.additional&&(i+="".concat(o).concat(n.additional)))),i+this.eol}printPtime(t){return void 0===t?"":"a=ptime:".concat(t).concat(this.eol)}printMaxPtime(t){return void 0===t?"":"a=maxptime:".concat(t).concat(this.eol)}printDirection(t){return void 0===t?"":"a=".concat(t).concat(this.eol)}printSSRC(t){return t.map((t=>Object.keys(t.attributes).map((e=>"a=ssrc:".concat(t.ssrcId.toString(10)).concat(o).concat(e).concat(t.attributes[e]?":".concat(t.attributes[e]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(t){return void 0===t?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(t){return void 0===t?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(t){return void 0===t?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(t){if(void 0===t)return"";let e="a=rtcp:".concat(t.port);return t.netType&&(e+="".concat(o).concat(t.netType)),t.addressType&&(e+="".concat(o).concat(t.addressType)),t.address&&(e+="".concat(o).concat(t.address)),e+this.eol}printMSId(t){return t.map((t=>"a=msid:".concat(t.id).concat(t.appdata?"".concat(o).concat(t.appdata):"").concat(this.eol))).join("")}printImageattr(t){return t.map((t=>"a=imageattr:".concat(t).concat(this.eol))).join("")}printRid(t){return t.map((t=>{let e="a=rid:".concat(t.id).concat(o).concat(t.direction);return t.payloads&&(e+="".concat(o,"pt=").concat(t.payloads.join(","))),t.params.length>0&&(e+="".concat(o).concat(t.params.map((t=>"depend"===t.type?"depend=".concat(t.rids.join(",")):"".concat(t.type,"=").concat(t.val))).join(";"))),e+this.eol})).join("")}printSimulcast(t){return void 0===t?"":"a=simulcast:".concat(t).concat(this.eol)}printSCTPPort(t){return void 0===t?"":"a=sctp-port:".concat(t).concat(this.eol)}printMaxMessageSize(t){return void 0===t?"":"a=max-message-size:".concat(t).concat(this.eol)}printMid(t){return void 0===t?"":"a=mid:".concat(t).concat(this.eol)}printSSRCGroups(t){return t.map((t=>"a=ssrc-group:".concat(t.semantic).concat(t.ssrcIds.map((t=>"".concat(o).concat(t.toString(10)))).join("")).concat(this.eol))).join("")}}function k(t){return(new b).parse(t)}function L(t,e){return(new I).print(t,e)}}},e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={exports:{}};return t[n](s,s.exports,i),s.exports}return i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(8)})()}(WL);var $L=WL.exports;function zL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function qL(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?zL(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):zL(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function KL(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:o,filterAudioFec:r,filterAudioCodec:a,filterVideoCodec:c}=e,{useXR:d}=i;let l=[],h=[],u=[],p=[],m=!1,g=!1;if($L.parse(t).mediaDescriptions.forEach((t=>{n&&n!==t.attributes.direction||("video"!==t.media.mediaType||m||(h=t.attributes.payloads,p=t.attributes.extmaps,m=!0),"audio"!==t.media.mediaType||g||(l=t.attributes.payloads,u=t.attributes.extmaps,g=!0))})),!p||0===h.length)throw new Error("Cannot get video capabilities from SDP.");if(!u||0===l.length)throw new Error("Cannot get audio capabilities from SDP.");h.forEach((t=>{var e;null!==(e=t.rtpMap)&&void 0!==e&&e.clockRate&&(t.rtpMap.clockRate=parseInt(t.rtpMap.clockRate)),d&&t.rtcpFeedbacks.push({type:"rrtr"})})),l.forEach((t=>{var e;null!==(e=t.rtpMap)&&void 0!==e&&e.clockRate&&(t.rtpMap.clockRate=parseInt(t.rtpMap.clockRate)),d&&t.rtcpFeedbacks.push({type:"rrtr"})})),s&&(l=l.filter((t=>{var e;return"rtx"!==(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())})),h=h.filter((t=>{var e;return"rtx"!==(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())}))),o&&(h=h.filter((t=>{var e;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName)||"")}))),r&&(l=l.filter((t=>{var e;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName)||"")}))),a&&(null==a?void 0:a.length)>0&&(l=l.filter((t=>{var e;return Ps(a).call(a,(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0&&(h=h.filter((t=>{var e;return Ps(c).call(c,(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"")})));const f=Db("UNSUPPORTED_VIDEO_CODEC");return f&&f.length>0&&(h=h.filter((t=>!(t.rtpMap&&Ps(f).call(f,t.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:l,videoCodecs:h,audioExtensions:u,videoExtensions:p}}function YL(t){const e=$L.parse(t);let i,n;for(const t of e.mediaDescriptions){if(!i){const e=t.attributes.iceUfrag,n=t.attributes.icePwd;if(!e||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:e,icePwd:n}}if(!n){const e=t.attributes.fingerprints;e.length>0&&(n={fingerprints:e})}}if(!n&&e.attributes.fingerprints.length>0&&(n={fingerprints:e.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function JL(t,e){const i=[],n=t.attributes.ssrcGroups.filter((t=>"FID"===t.semantic)),s=t.attributes.ssrcGroups.find((t=>"SIM"===t.semantic)),o=t.attributes.ssrcs;if(s)s.ssrcIds.forEach((t=>{var s;const o=null===(s=n.find((e=>e.ssrcIds[0]===t)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:t,rtx:e?o:void 0})}));else if(n.length>0){const t=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:t,rtx:e?s:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function XL(t,e){const{cname:i}=t;let n;e&&e.ip&&"number"==typeof e.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],$b.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),$b.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):n=t.iceParameters.candidates.map((t=>({foundation:t.foundation,componentId:"1",transport:t.protocol,priority:t.priority.toString(),connectionAddress:t.ip,port:t.port.toString(),type:t.type,extension:{}})));const s={fingerprints:t.dtlsParameters.fingerprints.map((t=>({hashFunction:t.algorithm,fingerprint:t.fingerprint})))},o={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let r;switch(t.dtlsParameters.role){case"server":r="passive";break;case"client":r="active";break;case"auto":r="actpass"}return{dtlsParameters:s,iceParameters:o,candidates:n,rtpCapabilities:aP(t.rtpCapabilities),setup:r,cname:i}}function ZL(t,e,i){const n=[],s=[];return t.forEach((t=>{let{ssrcId:o,rtx:r}=t;const a=UE(8,"track-"),c={ssrcId:o,attributes:qL({label:a,mslabel:i=i||UE(10,""),msid:"".concat(i," ").concat(a)},e&&{cname:e})};if(n.push(c),void 0!==r){const t={ssrcId:r,attributes:qL({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},e&&{cname:e})};n.push(t),s.push({semantic:"FID",ssrcIds:[o,r]})}})),t.length>1&&s.push({semantic:"SIM",ssrcIds:t.map((t=>{let{ssrcId:e}=t;return e}))}),{ssrcs:n,ssrcGroups:s}}function QL(t,e){e instanceof ZR&&t.attributes.payloads.forEach((t=>{var i;const n=null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.minptime="10",t.fmtp.parameters.useinbandfec="1";const s=e._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!T_()&&(t.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(t.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),t.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"))}))}function tP(t){const e=t.attributes.unrecognized.findIndex((t=>"x-google-flag"===t.attField&&"conference"===t.attValue));-1!==e&&t.attributes.unrecognized.splice(e,1)}function eP(t,e){var i;if(!(e instanceof SI&&e._encoderConfig&&-1===e._hints.indexOf(Dw.SCREEN_TRACK)))return;const n=e._encoderConfig;mR().supportMinBitrate&&n.bitrateMin&&t.attributes.payloads.forEach((t=>{var e,i;Ps(e=["h264","h265","vp8","vp9","av1"]).call(e,(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))})),mR().supportMinBitrate&&!Ps(i=e._hints).call(i,Dw.LOW_STREAM)&&n.bitrateMax&&t.attributes.payloads.forEach((t=>{var e,i;Ps(e=["h264","h265","vp8","vp9","av1"]).call(e,(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters["x-google-start-bitrate"]="".concat(Db("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))}))}function iP(t){if("video"!==t.media.mediaType)return;const e=p_();if(e.name!==c_.SAFARI&&e.os!==a_.IOS)return;const i=t.attributes.extmaps.findIndex((t=>/video-orientation/g.test(t.extensionName)));-1!==i&&t.attributes.extmaps.splice(i,1)}function nP(t,e,i){if(!e)return;let n,s;if("video"===t.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===e.twcc){const e=n.find((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName));if(e){t.attributes.extmaps.find((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName))||t.attributes.extmaps.push({entry:e.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const i=function(t,e){return e.filter((e=>!!t.find((t=>t.payloadType===e.payloadType&&!!t.rtcpFeedbacks.find((t=>"transport-cc"===t.type))))))}(s,t.attributes.payloads);i.forEach((t=>{t.rtcpFeedbacks.find((t=>"transport-cc"===t.type))||t.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===e.twcc){const e=t.attributes.extmaps.findIndex((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName));-1!==e&&t.attributes.extmaps.splice(e,1),t.attributes.payloads.forEach((t=>{const e=t.rtcpFeedbacks.findIndex((t=>"transport-cc"===t.type));-1!==e&&t.rtcpFeedbacks.splice(e,1)}))}if(!0===e.remb){const e=n.find((t=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===t.extensionName));if(e){t.attributes.extmaps.find((t=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===t.extensionName))||t.attributes.extmaps.push({entry:e.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const i=function(t,e){return e.filter((e=>!!t.find((t=>t.payloadType===e.payloadType&&!!t.rtcpFeedbacks.find((t=>"goog-remb"===t.type))))))}(s,t.attributes.payloads);i.forEach((t=>{t.rtcpFeedbacks.find((t=>"goog-remb"===t.type))||t.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===e.remb){const e=t.attributes.extmaps.findIndex((t=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===t.extensionName));-1!==e&&t.attributes.extmaps.splice(e,1),t.attributes.payloads.forEach((t=>{const e=t.rtcpFeedbacks.findIndex((t=>"goog-remb"===t.type));-1!==e&&t.rtcpFeedbacks.splice(e,1)}))}}function sP(t,e,i){if(T_())return;if("video"!==t.media.mediaType)return;if(!(e instanceof SI))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!Db("SIMULCAST"))return;if(void 0===e._scalabilityMode||e._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===i?2:e._scalabilityMode.numSpatialLayers,s=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find((t=>"FID"===t.semantic&&t.ssrcIds[0]===s.ssrcId)),r={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let e=1;e<n;e++)t.attributes.ssrcs.push({ssrcId:s.ssrcId+e,attributes:IE(s.attributes)}),r.ssrcIds.push(s.ssrcId+e),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+e,attributes:IE(s.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+e,o.ssrcIds[1]+e]}));t.attributes.ssrcGroups.unshift(r)}async function oP(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{filterRTX:i,filterVideoFec:n,filterAudioFec:s,filterAudioCodec:o,filterVideoCodec:r}=t,{useXR:a}=e,c=new RTCPeerConnection;c.addTransceiver("video",{direction:"sendonly"}),c.addTransceiver("audio",{direction:"sendonly"}),c.addTransceiver("video",{direction:"recvonly"}),c.addTransceiver("audio",{direction:"recvonly"});const d=(await c.createOffer()).sdp,l=KL(d,{filterRTX:i,filterVideoFec:n,filterAudioFec:s,filterAudioCodec:o,filterVideoCodec:r},{useXR:a},"sendonly"),h=KL(d,{filterRTX:i,filterVideoFec:n,filterAudioFec:s,filterAudioCodec:o,filterVideoCodec:r},{useXR:a},"recvonly"),u={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(rP(l,h,"videoExtensions",u,p,m),rP(l,h,"videoCodecs",u,p,m),rP(l,h,"audioExtensions",u,p,m),rP(l,h,"audioCodecs",u,p,m),Db("RAISE_H264_BASELINE_PRIORITY")){const t=m.videoCodecs.findIndex((t=>{var e,i;return"h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==t){const e=m.videoCodecs.findIndex((t=>{var e;return"h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())}));if(e<t){$b.debug("raising H264 baseline profile priority");const i=m.videoCodecs[t];m.videoCodecs.splice(t,1),m.videoCodecs.splice(e,0,i)}-1!==e&&(p.videoCodecs=p.videoCodecs.filter((t=>{var e,i;return!("h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==e&&Db("FILTER_SEND_H264_BASELINE")&&(u.videoCodecs=u.videoCodecs.filter((t=>{var e,i;return!("h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}try{c.close()}catch(t){}return{send:u,recv:p,sendrecv:m}}function rP(t,e,i,n,s,o){if("videoExtensions"===i||"audioExtensions"===i){const r=[];return t[i].forEach((t=>{e[i].some(((e,i)=>{if(t.entry===e.entry&&t.extensionName===e.extensionName)return r.push(i),!0}))?o[i].push(t):n[i].push(t)})),void e[i].forEach(((t,e)=>{-1===r.indexOf(e)&&s[i].push(t)}))}if("videoCodecs"===i||"audioCodecs"===i){const r=[];return t[i].forEach((t=>{e[i].some(((e,i)=>{if(t.payloadType===e.payloadType&&JSON.stringify(t)===JSON.stringify(e))return r.push(i),!0}))?o[i].push(t):n[i].push(t)})),void e[i].forEach(((t,e)=>{-1===r.indexOf(e)&&s[i].push(t)}))}}function aP(t){const{send:e,recv:i,sendrecv:n}=t;if(!n){if(!e||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:i}}let s,o;return e?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...e.audioCodecs,...n.audioCodecs],s.videoCodecs=[...e.videoCodecs,...n.videoCodecs],s.audioExtensions=[...e.audioExtensions,...n.audioExtensions],s.videoExtensions=[...e.videoExtensions,...n.videoExtensions]):s=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:s,recv:o}}function cP(t){"audio"===t.media.mediaType&&t.attributes.payloads.filter((t=>{var e;return"opus"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())})).forEach((t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"}))}function dP(t){t.mediaDescriptions.forEach((t=>{"video"!==t.media.mediaType&&"audio"!==t.media.mediaType||t.attributes.payloads.forEach((t=>{-1===t.rtcpFeedbacks.findIndex((t=>"rrtr"===t.type))&&t.rtcpFeedbacks.push({type:"rrtr"})}))}))}function lP(t,e,i,n){let s=[];if(t===hC.VIDEO){if(Db("H264_PROFILE_LEVEL_ID")&&"h264"===n&&(s=e.videoCodecs.filter((t=>{var e;return Ps(e=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(e,n)&&t&&t.fmtp&&t.fmtp.parameters["profile-level-id"]===Db("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(s)||0===s.length){const t=i.videoCodecs.filter((t=>{var e;return Ps(e=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(e,n)}));0!==t.length&&(s=e.videoCodecs.filter((e=>t.some((t=>t.payloadType===e.payloadType)))))}if(Db("USE_PUB_RTX")){const t=s.map((t=>t.payloadType.toString())),i=e.videoCodecs.filter((e=>e.rtpMap&&"rtx"===e.rtpMap.encodingName&&Ps(t).call(t,e.fmtp&&e.fmtp.parameters.apt||"")));s=[...s,...i]}0===s.length&&($b.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),s=e.videoCodecs)}else s=e.audioCodecs.filter((t=>{var e;return Ps(e=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(e,n)})),0===s.length&&($b.warning("codec ".concat(n," not included in rtpCapabilities, fallback to opus")),s=e.audioCodecs.filter((t=>{var e;return Ps(e=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(e,"opus")})));return s}function hP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function uP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?hP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):hP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function pP(t){if(Array.isArray(t))return t.map((t=>t));if(!mP(t))return t;const e={};for(const i in t){const n=t[i];mP(n)||Array.isArray(n)?e[i]=pP(n):e[i]=n}return e}function mP(t){return!("object"!=typeof t||Array.isArray(t)||!t)}class gP{constructor(t){nu(this,"input",[]),nu(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const fP={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},vP={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:fP,remoteCandidate:fP}},_P={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},EP={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},SP={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},TP={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function bP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function yP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?bP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):bP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class CP{constructor(t,e){nu(this,"onFirstVideoReceived",void 0),nu(this,"onFirstVideoDecoded",void 0),nu(this,"onFirstAudioReceived",void 0),nu(this,"onFirstVideoDecodedTimeout",void 0),nu(this,"onFirstAudioDecoded",void 0),nu(this,"onSelectedLocalCandidateChanged",void 0),nu(this,"onSelectedRemoteCandidateChanged",void 0),nu(this,"videoIsReady",!1),nu(this,"videoIsReady2",{}),nu(this,"pc",void 0),nu(this,"options",void 0),nu(this,"intervalTimer",void 0),nu(this,"stats",pP(vP)),nu(this,"isFirstVideoReceived",{}),nu(this,"isFirstVideoDecoded",{}),nu(this,"isFirstAudioReceived",{}),nu(this,"isFirstAudioDecoded",{}),nu(this,"isFirstVideoDecodedTimeout",{}),nu(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new e_((t=>{t({local:yP({},fP),remote:yP({},fP)})}))}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const e=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,o=0,r=0;for(const a of i)t[a].forEach(((t,i)=>{if(!this.lossRateWindowStats[e-1][a][i]||!this.lossRateWindowStats[0][a][i])return;const c=this.lossRateWindowStats[e-1][a][i].packets-this.lossRateWindowStats[0][a][i].packets,d=this.lossRateWindowStats[e-1][a][i].packetsLost-this.lossRateWindowStats[0][a][i].packetsLost;"videoSend"===a||"audioSend"===a?(n+=c,o+=d):(s+=c,r+=d),Number.isNaN(c)||Number.isNaN(c)?t.packetLostRate=0:t.packetLostRate=c<=0||d<=0?0:d/(c+d)}));t.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),t.recvPacketLossRate=s<=0||r<=0?0:r/(s+r)}}function wP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function RP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?wP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class IP extends CP{constructor(){super(...arguments),nu(this,"_stats",vP),nu(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=pP(vP);const i=e.filter((t=>"ssrc"===t.type));this.processSSRCStats(i);const n=e.find((t=>"VideoBwe"===t.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach((t=>{var e;const i=Ps(e=t.id).call(e,"send");switch("".concat(t.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const e=pP(EP);e.codec=t.googCodecName,e.adaptionChangeReason="none",t.googCpuLimitedResolution&&(e.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(e.adaptionChangeReason="bandwidth"),e.avgEncodeMs=Number(t.googAvgEncodeMs),e.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},e.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},e.firsCount=Number(t.googFirReceived),e.nacksCount=Number(t.googNacksReceived),e.plisCount=Number(t.googPlisReceived),e.frameCount=Number(t.framesEncoded),e.bytes=Number(t.bytesSent),e.packets=Number(t.packetsSent),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(e),this._stats.rtt=e.rttMs;break}case"video_recv":{const e=pP(_P),i=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(e.codec=t.googCodecName,e.targetDelayMs=Number(t.googTargetDelayMs),e.renderDelayMs=Number(t.googRenderDelayMs),e.currentDelayMs=Number(t.googCurrentDelayMs),e.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),e.decodeMs=Number(t.googDecodeMs),e.maxDecodeMs=Number(t.googMaxDecodeMs),e.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},e.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},e.decodeFrameRate=Number(t.googFrameRateDecoded),e.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},e.jitterBufferMs=Number(t.googJitterBufferMs),e.firsCount=Number(t.googFirsSent),e.nacksCount=Number(t.googNacksSent),e.plisCount=Number(t.googPlisSent),e.framesDecodeCount=Number(t.framesDecoded),e.bytes=Number(t.bytesReceived),e.packets=Number(t.packetsReceived),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,e.decodedFrame.width,e.decodedFrame.height),this.isFirstVideoDecoded[e.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;e.framesDecodeFreezeTime=n.framesDecodeFreezeTime,e.framesDecodeInterval=n.framesDecodeInterval,e.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(i.lts=Date.now(),e.framesDecodeInterval=s,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<i.stats.framesDecodeCount&&(e.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:RP({},e),lts:Date.now()}),this._stats.videoRecv.push(e);break}case"audio_recv":{const e=pP(TP);e.codec=t.googCodecName,e.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,e.decodingCNG=Number(t.googDecodingCNG),e.decodingCTN=Number(t.googDecodingCTN),e.decodingCTSG=Number(t.googDecodingCTSG),e.decodingNormal=Number(t.googDecodingNormal),e.decodingPLC=Number(t.googDecodingPLC),e.decodingPLCCNG=Number(t.googDecodingPLCCNG),e.expandRate=Number(t.googExpandRate),e.accelerateRate=Number(t.googAccelerateRate),e.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),e.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),e.speechExpandRate=Number(t.googSpeechExpandRate),e.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),e.jitterBufferMs=Number(t.googJitterBufferMs),e.jitterMs=Number(t.googJitterReceived),e.bytes=Number(t.bytesReceived),e.packets=Number(t.packetsReceived),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),e.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.decodingNormal>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),this._stats.audioRecv.push(e);break}case"audio_send":{const e=pP(SP);e.codec=t.googCodecName,e.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,e.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),e.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),e.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),e.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),e.bytes=Number(t.bytesSent),e.packets=Number(t.packetsSent),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.rttMs=Number(t.googRtt||0),this._stats.rtt=e.rttMs,this._stats.audioSend.push(e);break}}}))}_getStats(){return new e_(((t,e)=>{this.pc.getStats(t,e)}))}statsResponsesToObjects(t){const e=[];return t.result().forEach((t=>{const i={id:t.id,timestamp:t.timestamp.valueOf().toString(),type:t.type};t.names().forEach((e=>{i[e]=t.stat(e)})),e.push(i)})),e}}function AP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function OP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?AP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):AP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class NP extends CP{constructor(){super(...arguments),nu(this,"_stats",vP),nu(this,"report",void 0),nu(this,"lastDecodeVideoReceiverStats",new Map),nu(this,"lastVideoFramesRecv",new Map),nu(this,"lastVideoFramesSent",new Map),nu(this,"lastVideoFramesDecode",new Map),nu(this,"lastVideoJBDelay",new Map),nu(this,"lastAudioJBDelay",new Map),nu(this,"mediaBytesSent",new Map),nu(this,"mediaBytesRetransmit",new Map),nu(this,"mediaBytesTargetEncode",new Map),nu(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=pP(vP),this.report.forEach((t=>{switch(t.type){case hy.OUTBOUND:case hy.INBOUND:{const e=t.mediaType||t.kind,i=!e&&"frameWidth"in t,n=!e&&!("frameWidth"in t);t.type===hy.OUTBOUND?"audio"===e||n?this.processAudioOutboundStats(t):("video"===e||i)&&this.processVideoOutboundStats(t):t.type===hy.INBOUND&&("audio"===e||n?this.processAudioInboundStats(t):("video"===e||i)&&this.processVideoInboundStats(t));break}case hy.TRANSPORT:{const e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case hy.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),e={local:OP({},fP),remote:OP({},fP)};return t.forEach((i=>{let n;if(i.type===hy.TRANSPORT&&(n=t.get(i.selectedCandidatePairId)),i.type===hy.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(t,e)=>{t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol)};if(n.localCandidateId){const s=t.get(n.localCandidateId);s&&i(e.local,s)}if(n.remoteCandidateId){const s=t.get(n.remoteCandidateId);s&&i(e.remote,s)}}})),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach((e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)})),this._stats.audioSend.forEach((e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){const e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===hy.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===hy.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===hy.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(OP({},e),OP({},this.stats.selectedCandidatePair.localCandidate)),t.type===hy.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(OP({},e),OP({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find((e=>e.ssrc===t.ssrc));e||(e=pP(TP),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,this.processAudioTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),"number"==typeof t.concealedSamples&&(e.concealedSamples=t.concealedSamples)}processVideoInboundStats(t){let e=this._stats.videoRecv.find((e=>e.ssrc===t.ssrc));e||(e=pP(_P),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(e.ssrc),n=this.lastVideoFramesDecode.get(e.ssrc),s=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){const t=e.decodedFrame?e.decodedFrame.width:0,i=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,t,i),this.isFirstVideoDecoded[e.ssrc]=!0}if(i){const n=i.stats,o=s-i.lts;e.framesDecodeFreezeTime=n.framesDecodeFreezeTime,e.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&o>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(i.lts=Date.now(),e.framesDecodeInterval=o,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<n.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(i.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-i.qpSum)/(t.framesDecoded-i.stats.framesDecodeCount))}n&&s-n.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-n.count)/((s-n.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:e.decodeFrameRate})):n?e.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:0}),t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:OP({},e),lts:i?i.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find((e=>e.ssrc===t.ssrc));e||(e=pP(EP),this._stats.videoSend.push(e));const i=this.mediaBytesSent.get(t.ssrc);if(i)i.add(t.bytesSent);else{const e=new gP(10);e.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,e)}if(void 0!==t.retransmittedBytesSent){const e=this.mediaBytesRetransmit.get(t.ssrc);if(e)e.add(t.retransmittedBytesSent);else{const e=new gP(10);e.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,e)}}if(t.totalEncodedBytesTarget){const e=this.mediaBytesTargetEncode.get(t.ssrc);if(e)e.add(t.totalEncodedBytesTarget);else{const e=new gP(10);e.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,e)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,t.totalEncodeTime&&t.framesEncoded){const i=this.lastEncoderMs.get(t.ssrc);if(!i||i.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const n=t.framesEncoded-i.lastFrameCount,s=t.totalEncodeTime-i.lastEncoderTime;e.avgEncodeMs=1e3*s/n}}if(t.framesEncoded&&t.qpSum){const i=this.lastEncoderMs.get(t.ssrc);!i||i.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-i.lastQpSum)/(t.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const i=this.findRemoteStatsId(t.ssrc,hy.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find((e=>e.ssrc===t.ssrc));if(e||(e=pP(SP),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const i=this.findRemoteStatsId(t.ssrc,hy.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}findRemoteStatsId(t,e){var i;const n=Array.from(Dy(i=this.report).call(i)).find((i=>i.type===e&&i.ssrc===t));return n?n.id:null}processVideoMediaSource(t,e){const i=this.report.get(t);i&&i.width&&i.height&&i.framesPerSecond&&(e.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(t,e){const i=this.report.get(t);i&&(e.inputLevel=i.audioLevel)}processVideoTrackSenderStats(t,e,i){var n,s,o,r;const a=e?this.report.get(e):void 0,c=null!==(n=null==a?void 0:a.framesSent)&&void 0!==n?n:t.framesSent;if("number"!=typeof c)return;let d=null!==(s=null==a?void 0:a.frameWidth)&&void 0!==s?s:t.frameWidth,l=null!==(o=null==a?void 0:a.frameHeight)&&void 0!==o?o:t.frameHeight,h=null!==(r=null==a?void 0:a.framesPerSecond)&&void 0!==r?r:t.framesPerSecond;if("number"==typeof d&&"number"==typeof l||(d=0,l=0),null==h){const t=Date.now(),e=this.lastVideoFramesSent.get(i.ssrc);e&&t-e.lts>=800?(h=Math.round((c-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:t,rate:h})):e?h=e.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:t,rate:0})}i.sentFrame={width:d,height:l,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(t,e,i){var n,s,o,r,a;const c=e?this.report.get(e):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:t.framesReceived,l=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:t.frameWidth,h=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:t.frameHeight,u=null!==(r=null==c?void 0:c.jitterBufferDelay)&&void 0!==r?r:t.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:t.jitterBufferEmittedCount;if("number"==typeof d){const t=this.lastVideoFramesRecv.get(i.ssrc),e=Date.now();i.framesReceivedCount=d;let n=0;t&&e-t.lts>=800?(n=Math.round((d-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:e,rate:n})):t?n=t.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:e,rate:0}),i.receivedFrame={width:l||0,height:h||0,frameRate:n||0},i.decodedFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0}}if(u&&p){const t=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let e=t.jitterBufferMs;const n=p-t.jitterBufferEmittedCount;n>0&&(e=1e3*(u-t.jitterBufferDelay)/n),i.jitterBufferMs=e,i.currentDelayMs=Math.round(e),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(t,e,i){var n,s,o,r;const a=e?this.report.get(e):void 0,c=null!==(n=null!==(s=null==a?void 0:a.echoReturnLoss)&&void 0!==s?s:t.echoReturnLoss)&&void 0!==n?n:0,d=null!==(o=null!==(r=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==r?r:t.echoReturnLossEnhancement)&&void 0!==o?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(t,e,i){var n,s,o,r,a,c,d;const l=e?this.report.get(e):void 0,h=null!==(n=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==n?n:t.removedSamplesForAcceleration,u=null!==(s=null==l?void 0:l.totalSamplesReceived)&&void 0!==s?s:t.totalSamplesReceived,p=null!==(o=null==l?void 0:l.jitterBufferDelay)&&void 0!==o?o:t.jitterBufferDelay,m=null!==(r=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==r?r:t.jitterBufferEmittedCount,g=null!==(a=null==l?void 0:l.audioLevel)&&void 0!==a?a:null==t?void 0:t.audioLevel,f=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==t?void 0:t.totalSamplesDuration,v=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:t.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&m){const t=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let e=t.jitterBufferMs;const n=m-t.jitterBufferEmittedCount;n>0&&(e=1e3*(p-t.jitterBufferDelay)/n),i.jitterBufferMs=Math.round(e),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:m,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=g;let _=1920;f&&u&&(_=u/f/50,i.receivedFrames=Math.round(u/_)),v&&(i.droppedFrames=Math.round(v/_))}processRemoteInboundStats(t,e){const i=this.report.get(t);i&&(e.packetsLost=i.packetsLost,i.roundTripTime&&(e.rttMs=1e3*i.roundTripTime),i.jitter&&(e.jitterMs=1e3*i.jitter),i.timestamp&&(e.timestamp=i.timestamp))}getCodecFromCodecStats(t){const e=this.report.get(t);if(!e)return"";const i=e.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let t=0,e=null,i=null;this.mediaBytesSent.forEach((e=>{t+=e.diffMean()})),this.mediaBytesRetransmit.forEach((t=>{e=null===e?t.diffMean():e+t.diffMean()})),this.mediaBytesTargetEncode.forEach((t=>{i=null===i?t.diffMean():i+t.diffMean()}));const n=null!==e?t-e:t;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},null!==e&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class kP extends CP{updateStats(){return e_.resolve()}}function LP(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const t=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return t&&t[0]?Number(t[0].split("/")[1]):null}();return o?o<76?new IP(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new NP(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(t){return!!window.RTCStatsReport&&t.getStats()instanceof e_}(t)?new NP(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new kP(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}function PP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function DP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?PP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):PP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class MP extends LC{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}constructor(t,e){super(t,e),nu(this,"store",void 0),nu(this,"peerConnection",void 0),nu(this,"remoteSDP",void 0),nu(this,"initialOffer",void 0),nu(this,"statsFilter",void 0),nu(this,"useRTX",!1),nu(this,"localCapabilities",void 0),nu(this,"localCandidateCount",0),nu(this,"allCandidatesReceived",!1),nu(this,"establishPromise",void 0),nu(this,"mutex",new zE("P2PConnection-mutex")),this.store=e,this.peerConnection=new RTCPeerConnection(MP.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=LP(this.peerConnection,Db("STATS_UPDATE_INTERVAL"),void 0,T_()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=YL(t.sdp),i=KL(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:Db("FILTER_VIDEO_FEC"),filterAudioFec:Db("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=t,DP(DP({},e),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:t.sdp})}catch(t){throw new V_(U_.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(t){nu(this,"sessionDesc",void 0),nu(this,"localCapabilities",void 0),nu(this,"rtpCapabilities",void 0),nu(this,"candidates",void 0),nu(this,"iceParameters",void 0),nu(this,"dtlsParameters",void 0),nu(this,"setup",void 0),nu(this,"currentMidIndex",void 0),nu(this,"cname",void 0),t=IE(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,sdkCodec:a,cname:c}=t,d=$L.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=e,this.dtlsParameters=i,this.setup=o,this.localCapabilities=r,this.cname=c;for(let t=0;t<d.mediaDescriptions.length;t++){const r=d.mediaDescriptions[t];if(r.attributes.iceUfrag=e.iceUfrag,r.attributes.icePwd=e.icePwd,r.attributes.fingerprints=i.fingerprints,r.attributes.candidates=n,r.attributes.setup=o,"video"===r.media.mediaType){r.media.fmts=s.videoCodecs.map((t=>t.payloadType.toString(10)));let t=s.videoCodecs.filter((t=>{var e,i;return null===(e=t.rtpMap)||void 0===e?void 0:Ps(i=e.encodingName.toLowerCase()).call(i,a)}));0===t.length&&(t=s.videoCodecs),r.attributes.payloads=t,r.attributes.extmaps=s.videoExtensions}"audio"===r.media.mediaType&&(r.media.fmts=s.audioCodecs.map((t=>t.payloadType.toString(10))),r.attributes.payloads=s.audioCodecs,r.attributes.extmaps=s.audioExtensions),d.mediaDescriptions[t]=this.mungMediaDesc(r)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return $L.print(this.sessionDesc)}send(t,e,i){const{ssrcs:n,ssrcGroups:s}=ZL(e,this.cname),o=this.sessionDesc.mediaDescriptions.find((e=>t===hC.VIDEO?"video"===e.media.mediaType:"audio"===e.media.mediaType)),r=n[0].attributes.label,a=n[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(n),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:r,mslabel:a}}batchSend(t){return t.map((t=>{let{kind:e,ssrcMsg:i}=t;return this.send(e,i,void 0)}))}stopSending(t){this.sessionDesc.mediaDescriptions.forEach((e=>{const i=[],n=[],s=[];e.attributes.ssrcs.forEach((e=>{Ps(t).call(t,e.attributes.label||"")?s.push(e):i.push(e)})),e.attributes.ssrcGroups.forEach((t=>{var e;Ps(e=s.map((t=>t.ssrcId))).call(e,t.ssrcIds[0])||n.push(t)})),e.attributes.ssrcs=i,e.attributes.ssrcGroups=n}))}mute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}receive(t,e,i){t.forEach(((t,e)=>{const i=t._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(t){}updateCandidates(t){t===uC.TCP?this.candidates.forEach((t=>{-1===this.candidates.findIndex((e=>"tcp"===e.transport&&e.connectionAddress===t.connectionAddress&&e.port===t.port))&&this.candidates.push(uP(uP({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})):this.candidates=this.candidates.filter((t=>"tcp"!==t.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(t){t=IE(t),this.iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}mungRecvMediaDsec(t,e){const i=IE(t);return QL(i,e),eP(i,e),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===t));if(-1!==i){const t=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=t}}bumpMid(t){this.currentMidIndex+=t}updateTrackLabel(t,e,i){const n=this.sessionDesc.mediaDescriptions.find((e=>t===hC.VIDEO?"video"===e.attributes.mid:"audio"===e.attributes.mid));if(n){const t=n.attributes.ssrcs.find((t=>t.attributes.label===e));var s;t&&(t.attributes.label=i,null===(s=t.attributes.msid)||void 0===s||s.replace(e,i))}}mungMediaDesc(t){const e=IE(t);return tP(e),function(t){const e=t.attributes.extmaps.find((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName));e&&t.attributes.extmaps.splice(t.attributes.extmaps.indexOf(e),1),t.attributes.payloads.forEach((t=>{const e=t.rtcpFeedbacks.findIndex((t=>"transport-cc"===t.type));-1!==e&&t.rtcpFeedbacks.splice(e,1)}))}(e),e}getSSRC(t){for(const e of this.sessionDesc.mediaDescriptions)for(const i of e.attributes.ssrcs)if(i.attributes.label===t)return[i]}}({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const r=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}async updateRemoteRTPCapabilities(t,e){throw new V_(U_.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(t,e){var i=this;return BL((function*(){const n=yield jL(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=t.map((t=>i.peerConnection.addTrack(t._mediaStreamTrack))),o=yield jL(i.peerConnection.createOffer()),r=$L.parse(o.sdp),a=t.map((t=>{const e=t._mediaStreamTrack,n=r.mediaDescriptions.find((t=>t.attributes.mid===e.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(t,e,i){const n=t.attributes.ssrcs.filter((t=>t.attributes.label===e)),s=t.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const t=s.find((t=>-1!==t.ssrcIds.indexOf(n[0].ssrcId)));return t?[{ssrcId:t.ssrcIds[0],rtx:i?t.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,e.id,i.useRTX)}));let c;try{c=yield a}catch(t){throw s.forEach((t=>{S_()&&t.replaceTrack(null),i.peerConnection.removeTrack(t)})),t}const d=i.mungSendOfferSDP(o.sdp,t);i.remoteSDP.receive(t,e,c);const l=i.remoteSDP.toString();return yield jL(i.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield jL(i.applySendEncodings(s,t)),yield jL(i.peerConnection.setRemoteDescription({type:"answer",sdp:l})),t.map(((t,e)=>{const i=t._mediaStreamTrack.id;return{localSSRC:a[e],id:i}}))}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(t.toString()))}finally{n()}}))()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const e=this.peerConnection.getSenders().filter((e=>{var i;return-1!==t.indexOf((null===(i=e.track)||void 0===i?void 0:i.id)||"")}));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");e.map((t=>{S_()&&t.replaceTrack(null),this.peerConnection.removeTrack(t)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(t.toString()))}}async receive(t,e,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(t,e,n),o=new e_(((e,n)=>{const o=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),r=n=>{const a=p_();if(("Safari"===a.name&&11===Number(a.version)||b_())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(t,i,n.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(o),void e(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",r),clearTimeout(o),void e(n.track)};this.peerConnection.addEventListener("track",r)})),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const a=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(a),{track:await o,id:i}}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter((e=>{var i;return-1!==t.indexOf((null===(i=e.track)||void 0===i?void 0:i.id)||"")}));if(e.length!==t.length)throw new Error("sender' length doesn't match mids' length.");e.map((t=>{if(S_()&&t.track)t.track.enabled=!1;else{const e=t.getParameters();e.encodings.forEach((t=>t.active=!1)),t.setParameters(e)}}))}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter((e=>{var i;return-1!==t.indexOf((null===(i=e.track)||void 0===i?void 0:i.id)||"")}));if(e.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");e.map((async t=>{if(S_()&&t.track)t.track.enabled=!0;else{const e=t.getParameters();e.encodings.forEach((t=>t.active=!0)),await t.setParameters(e)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(t){var e=this;return BL((function*(){const i=yield jL(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(mR().supportPCSetConfiguration){const i=e.peerConnection.getConfiguration(),n=t===uC.RELAY?"relay":"all";i.iceTransportPolicy!==n&&($b.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,e.peerConnection.setConfiguration(i))}else if(t===uC.RELAY)return;t!==uC.RELAY&&e.remoteSDP.updateCandidates(t);const n=yield jL(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=YL(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const r=e.remoteSDP.toString();yield jL(e.peerConnection.setLocalDescription(n)),yield jL(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){$b.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),t)}finally{i()}}))()}close(){var t;this.peerConnection.close(),null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const t=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(t.sdp,[e]);this.remoteSDP.updateRecvMedia(e._mediaStreamTrack.kind,e);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,t.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getSenders().filter((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));1===i.length&&await this.applySendEncodings(i,[e])}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getSenders().find((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));i&&await i.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,e){throw new V_(U_.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new V_(U_.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,$b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,$b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Db("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(mE(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...MP.turnServerConfigToIceServers(t.turnServer.servers)),Db("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...MP.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(e.iceTransportPolicy="relay")})))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}async updateRtpSenderEncodings(t,e){var i;if(e||(e=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t._mediaStreamTrack.id}))),!e)return $b.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!mR().supportSetRtpSenderParameters)return $b.warn("Browser not support set rtp-sender parameters");const n={},s={};if(t instanceof SI)switch(t._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(Db("DSCP_TYPE")&&D_()){var o;const t=Db("DSCP_TYPE");Ps(o=["very-low","low","medium","high"]).call(o,t)&&(s.networkPriority=t)}const r=e.getParameters(),a=null===(i=r.encodings)||void 0===i?void 0:i[0];a&&Object.assign(a,s),Object.assign(r,n),$b.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(r.encodings))),await e.setParameters(r)}async applySendEncodings(t,e){try{if(!mR().supportSetRtpSenderParameters)return;if(t.length!==e.length)return;for(let i=0;i<t.length;i++){const n=t[i],s=e[i];n&&s&&await this.updateRtpSenderEncodings(s,n)}}catch(t){$b.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e){const i=$L.parse(t);return e.forEach(((t,e)=>{const n=t._mediaStreamTrack,s=i.mediaDescriptions.find((t=>t.attributes.mid===n.kind));s&&QL(s,t)})),$L.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;null===(e=this.onFirstAudioReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;null===(e=this.onFirstVideoReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;null===(e=this.onFirstAudioDecoded)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,t,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const e=this.remoteSDP.batchSend(t).map(((e,i)=>{let{id:n,mslabel:s}=e;const{kind:o}=t[i];return new e_(((t,e)=>{const i=setTimeout((()=>{e(new Error("Cannot receive track, id: ".concat(n)))}),1e4),r=e=>{const a=p_();if("Safari"===a.name&&11===Number(a.version)&&e.track.id!==n&&e.streams[0].id===s){var c;const s=e.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,n,e.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(i),void t({track:s,id:n})}if(e.track.id===n)return this.peerConnection.removeEventListener("track",r),clearTimeout(i),void t({track:e.track,id:n})};this.peerConnection.addEventListener("track",r)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await e_.all(e)}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return null==e?void 0:e[0].ssrcId}setConfiguration(t){if(mR().supportPCSetConfiguration){const e=MP.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function xP(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function UP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function VP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?UP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}My([xP,xy("design:type",Function),xy("design:paramtypes",[Object,Object,Array,Object,String,String]),xy("design:returntype",e_)],MP.prototype,"connect",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],MP.prototype,"stopSending",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[String,Array,String,Object]),xy("design:returntype",e_)],MP.prototype,"receive",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],MP.prototype,"stopReceiving",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],MP.prototype,"muteRemote",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],MP.prototype,"unmuteRemote",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],MP.prototype,"muteLocal",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],MP.prototype,"unmuteLocal",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],MP.prototype,"close",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],MP.prototype,"updateEncoderConfig",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],MP.prototype,"updateSendParameters",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[iR,String]),xy("design:returntype",e_)],MP.prototype,"replaceTrack",null),My([xP,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],MP.prototype,"getRemoteSSRC",null);const FP="9",BP=4e4;function jP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function HP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?jP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):jP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let GP=class t extends LC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,e;return null!==(t=null===(e=this.peerConnection.getReceivers()[0])||void 0===e||null===(e=e.transport)||void 0===e?void 0:e.state)&&void 0!==t?t:null}constructor(e,i){super(e,i),nu(this,"store",void 0),nu(this,"peerConnection",void 0),nu(this,"remoteSDP",void 0),nu(this,"initialOffer",void 0),nu(this,"transportEventReceiver",void 0),nu(this,"statsFilter",void 0),nu(this,"useXR",Db("USE_XR")),nu(this,"localCapabilities",void 0),nu(this,"remoteCodecs",void 0),nu(this,"localCandidateCount",0),nu(this,"allCandidatesReceived",!1),nu(this,"dataStreamChannelMap",new Map),nu(this,"establishPromise",void 0),nu(this,"mutex",new zE("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(t.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=LP(this.peerConnection,Db("STATS_UPDATE_INTERVAL"),void 0,T_()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(t,e){this.remoteCodecs=e;const i=[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var e;return Ps(e=Object.keys(xb)).call(e,t)})))];if(sy.updateRemoteRTPCapabilities(this.store.sessionId,{mids:t,localCodecs:i,remoteCodecs:this.remoteCodecs}),this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(t,e,this.store.codec)){const t=await this.peerConnection.createOffer(),e=this.logSDPExchange(t.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(t);const i=this.remoteSDP.toString();null==e||e(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else $b.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else $b.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(i,", codecs: ").concat(e))}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=YL(t.sdp),i=await oP({filterRTX:!Db("USE_PUB_RTX")&&!Db("USE_SUB_RTX"),filterVideoFec:Db("FILTER_VIDEO_FEC"),filterAudioFec:Db("FILTER_AUDIO_FEC"),filterVideoCodec:Db("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=aP(i),this.initialOffer=t,HP(HP({},e),{},{rtpCapabilities:i,offerSDP:t.sdp})}catch(t){throw new V_(U_.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return IE(this._localCapabilities)}get rtpCapabilities(){return IE(this._rtpCapabilities)}get candidates(){return IE(this._candidates)}get iceParameters(){return IE(this._iceParameters)}get dtlsParameters(){return IE(this._dtlsParameters)}constructor(t){nu(this,"sessionDesc",void 0),nu(this,"_localCapabilities",void 0),nu(this,"_rtpCapabilities",void 0),nu(this,"_candidates",void 0),nu(this,"_iceParameters",void 0),nu(this,"_dtlsParameters",void 0),nu(this,"setup",void 0),nu(this,"currentMidIndex",void 0),nu(this,"cname",void 0),nu(this,"firefoxSsrcMidMap",new Map),t=IE(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=t,c=$L.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=s,this._candidates=n,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const t of c.mediaDescriptions){if(t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd,t.attributes.fingerprints=i.fingerprints,t.attributes.candidates=n,t.attributes.setup=o,"video"===t.media.mediaType&&(t.media.fmts=d.videoCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=d.videoCodecs,t.attributes.extmaps=d.videoExtensions,Db("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=ZL([{ssrcId:BP,rtx:Db("USE_SUB_RTX")?40001:void 0}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}if("audio"===t.media.mediaType&&(t.media.fmts=d.audioCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=d.audioCodecs,t.attributes.extmaps=d.audioExtensions,cP(t),Db("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=ZL([{ssrcId:2e4}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const t=Db("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const e=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<t;o++){const t=2*o+2e4,r=2*o+BP,{ssrcs:a,ssrcGroups:c}=ZL([{ssrcId:t}],this.cname),{ssrcs:d,ssrcGroups:l}=ZL([{ssrcId:r,rtx:Db("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:FP,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:FP,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return $L.print(this.sessionDesc)}send(t,e,i,n){const{ssrcs:s,ssrcGroups:o}=ZL(e,this.cname,Db("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(T_()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const t=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const e=this.findAvailableMediaIndex(t,s);let i;return-1===e||1===e&&(S_()||R_())||0===e&&Db("USE_SUB_RTX")||I_()?(i=this.createOrRecycleSendMedia(t,s,o,"sendonly",n),this.updateBundleMids()):(i=IE(this.sessionDesc.mediaDescriptions[e]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(i,n)),T_()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:t,needExchangeSDP:e}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:t.attributes.mid,needExchangeSDP:e}}batchSend(t){const e=t.map((t=>{let{kind:e,ssrcMsg:i,mslabel:n}=t;return this.send(e,i,n)})),i=[];let n=!1;return e.forEach((t=>{let{mid:e,needExchangeSDP:s}=t;s&&(n=!0),i.push(e)})),{mids:i,needExchangeSDP:n}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>e.attributes.mid&&-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach((t=>{"0"===t.attributes.mid||T_()||I_()?t.attributes.ssrcs=[]:(t.attributes.ssrcs=[],t.attributes.direction="inactive",t.media.port="0")})),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>Ps(t).call(t,e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="inactive"}))}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>Ps(t).call(t,e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="recvonly"}))}receive(t,e,i,n){t.forEach(((t,s)=>{this.createOrRecycleRecvMedia(t,[],"recvonly",e,i,n[s])})),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach((t=>{t.media.port="0",t.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(t){const e=this._candidates.filter((t=>"udp"===t.transport));if(t===uC.TCP){if(0===e.length)return;if(Db("TCP_CANDIDATE_ONLY")){const t=this._candidates.filter((t=>"tcp"===t.transport));e.forEach((e=>{-1===t.findIndex((t=>t.connectionAddress===e.connectionAddress))&&t.push(VP(VP({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})),this._candidates=t}else{const t=[];e.forEach((e=>{t.push(VP(VP({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})),this._candidates=[...e,...t]}}else if(t===uC.RELAY){if(0!==e.length)return;{const t=this._candidates.filter((t=>"tcp"===t.transport));t.forEach((t=>{e.push(VP(VP({},t),{},{foundation:"udpcandidate",priority:Number(t.priority)+1+"",transport:"udp",port:Number(t.port)-90+""}))})),this._candidates=[...e,...t]}}else 0===e.length?(this._candidates.filter((t=>"tcp"===t.transport)).forEach((t=>{e.push(VP(VP({},t),{},{foundation:"udpcandidate",priority:Number(t.priority)+1+"",transport:"udp",port:Number(t.port)-90+""}))})),this._candidates=e):this._candidates=this._candidates.filter((t=>"tcp"!==t.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(t){t=IE(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===t&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(T_()){if(n){const t=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(t||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!t||t!==i.attributes.mid)}return!1}return n}))}createOrRecycleDataChannel(){for(const t of this.sessionDesc.mediaDescriptions)if("application"===t.media.mediaType)return{mediaDesc:t,needExchangeSDP:!1};this.currentMidIndex+=1;const t="".concat(this.currentMidIndex),e={media:{mediaType:"application",port:FP,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(t),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(e),{mediaDesc:e,needExchangeSDP:!0}}createOrRecycleRecvMedia(t,e,i,n,s,o){const r=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=lP(r,a,this.localCapabilities.send,r===hC.VIDEO?n:s),d=r===hC.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:r,port:FP,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,t,o);const u=this.findFirstClosedMedia(r);if(u){const t=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[t]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(t,e,i){const n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var e;return Ps(e=Object.keys(xb)).call(e,t)})))],s=new Set(e);if(n.every((t=>s.has(t))))return $b.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter((t=>e.some((e=>{var i;return Ps(i=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(i,e)}))));if(0===o.length)return $b.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(e)),!1;const r=[...new Set(o.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")))];let a;if($b.debug("updateRemoteCodec, from ".concat(n," to ").concat(r)),0===t.length)a=this.sessionDesc.mediaDescriptions.filter((t=>"video"===t.media.mediaType&&"recvonly"===t.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((e=>e.attributes.mid&&Ps(t).call(t,e.attributes.mid)&&"recvonly"===e.attributes.direction)),a.length!==t.length)return $b.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(e)),!1;this._rtpCapabilities.recv.videoCodecs=o;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=lP(hC.VIDEO,d,c,i);return a.forEach((t=>{const e=l.map((t=>t.payloadType.toString(10)));$b.debug("updateRemoteCodec mid: ".concat(t.attributes.mid,", from ").concat(t.attributes.payloads," to ").concat(l)),t.attributes.payloads=l,t.media.fmts=e})),!0}createOrRecycleSendMedia(t,e,i,n,s){const o=this.rtpCapabilities.send,r=t===hC.VIDEO?o.videoCodecs:o.audioCodecs,a=t===hC.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:t,port:FP,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(t);if(l){const t=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[t]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((t=>"0"!==t.media.port)).map((t=>t.attributes.mid))}mungRecvMediaDsec(t,e,i){const n=IE(t);return tP(n),QL(n,e),eP(n,e),iP(n),nP(n,i,this.localCapabilities.send),n}mungSendMediaDesc(t,e){const i=IE(t);return nP(i,e,this.localCapabilities.recv),cP(i),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===t));if(-1!==i){const t=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=t}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find((e=>T_()?"0"===e.media.port&&e.media.mediaType===t:"0"===e.media.port))}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find((e=>{var i;return(null===(i=e.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===t[0].ssrcId}))}getSSRC(t){var e;return null===(e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t)))||void 0===e?void 0:e.attributes.ssrcs}}({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:this.localCapabilities,cname:o}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const r=this.remoteSDP.toString(),a=$L.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((t=>"audio"===t.media.mediaType));c&&cP(c),this.useXR&&dP(a);const d=$L.print(a),l=this.logSDPExchange(d||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r});const h=this.peerConnection.getTransceivers()[0];if(null!=h&&h.receiver&&this.tryBindTransportEvents(h.receiver),Db("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e)}}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}send(t,e,i){var n=this;return BL((function*(){const s=yield jL(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];t.forEach((t=>{const e=n.peerConnection.addTransceiver(t._mediaStreamTrack,{direction:"sendonly"});o.push(e),t._updateRtpTransceiver(e)})),T_()&&!0===Db("SIMULCAST")&&(yield jL(n.applySimulcastForFirefox(o,t)));const r=yield jL(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(t.length),c=n.mungSendOfferSDP(r.sdp,t,a),d=$L.parse(c),l=a.map((t=>{const e=d.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("Cannot extract ssrc from mediaDescription.");return JL(e,Db("USE_PUB_RTX"))}));let h;try{h=yield l}catch(s){h=[],n.remoteSDP.receive(t,e,i,h);const o=n.remoteSDP.toString();throw yield jL(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield jL(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield jL(n.stopSending(a,!0)),s}n.remoteSDP.receive(t,e,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield jL(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield jL(n.applySimulcastEncodings(o,t)),yield jL(n.applySendEncodings(o,t)),null==p||p(u),yield jL(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((t,e)=>{const i=a[e];return{localSSRC:l[e],id:i,transceiver:t}}))}catch(t){throw t instanceof V_?t:new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(t.toString()))}finally{s()}}))()}async createDataChannels(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);i&&"open"===i.readyState?$b.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:Db("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)),e.forEach((t=>{t._updateOriginDataChannel(i)}));const{needExchangeSDP:n}=this.remoteSDP.sendDataChannel();if(n){const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e),$b.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else $b.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(t){throw t instanceof V_?t:new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(t.toString()))}}async stopDataChannels(t){try{const e=this.dataStreamChannelMap.get(t);return null==e||e.close(),void this.dataStreamChannelMap.delete(t)}catch(t){throw t instanceof V_?t:new V_(U_.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(t.toString()))}}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const e=this.peerConnection.getTransceivers().filter((e=>-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");e.map((t=>{var e;t.direction="inactive",null===(e=t.stop)||void 0===e||e.call(t)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(t);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(t.toString()))}finally{i&&i()}}async receive(t,e,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,n);if(o){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(n.sdp,s,t);null==i||i(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),$b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else $b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((t=>t.mid===s));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:s,transceiver:r}}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const t=this.remoteSDP.toString(),e=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==e||e(i.sdp||""),await this.peerConnection.setLocalDescription(i),$b.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else $b.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return e.map((t=>{const e=this.peerConnection.getTransceivers().find((e=>e.mid===t));if(!e)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:e.receiver.track,id:t,transceiver:e}}))}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((t=>{t.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((async(t,e)=>{t.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(t){var e=this;return BL((function*(){const i=yield jL(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(mR().supportPCSetConfiguration){const i=e.peerConnection.getConfiguration(),n=t===uC.RELAY?"relay":"all";i.iceTransportPolicy!==n&&($b.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,e.peerConnection.setConfiguration(i))}else if(t===uC.RELAY)return;e.remoteSDP.updateCandidates(t);const n=yield jL(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=YL(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const r=e.remoteSDP.toString(),a=e.logSDPExchange(n.sdp||"","offer","local","restartICE");e.store.descriptionStart(),yield jL(e.peerConnection.setLocalDescription(n)),null==a||a(r),yield jL(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){$b.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),t)}finally{i()}}))()}close(){var t;this.peerConnection.close(),null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,t.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter((e=>e.mid===t));1===i.length&&(this.isVP8Simulcast(e)?T_()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find((t=>t.mid===e));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const e=t[0].transport.iceTransport,{local:i,remote:n}=e.getSelectedCandidatePair();return{local:HP(HP({},fP),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:HP(HP({},fP),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,$b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,$b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Db("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(mE(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.servers)),Db("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Db("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(i.iceTransportPolicy="relay")})))),Db("ENABLE_ENCODED_TRANSFORM")&&mR().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(mk(t.turnServerURL),":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&!Db("FORCE_TURN_TCP")&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}tryBindTransportEvents(t){const e=t.transport;if(e){this.transportEventReceiver=t,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=t=>{var e;null===(e=this.onDTLSTransportError)||void 0===e||e.call(this,"error"in t?t.error:t)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:t,remote:e}=i.getSelectedCandidatePair();$b.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol}),", remote ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol,address:e.address,port:e.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,e){var i;if(e||(e=this.peerConnection.getSenders().find((e=>e.track===t._mediaStreamTrack))),!e)return $b.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return $b.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!mR().supportSetRtpSenderParameters)return $b.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const n={},s={};switch(t._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:e,frameRate:i,scaleResolutionDownBy:n}=t._encoderConfig;e&&(s.maxBitrate=1e3*e),(Ps(o=t._hints).call(o,Dw.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(i&&(s.maxFramerate=fk(i)),n&&n>=1&&(s.scaleResolutionDownBy=n))}if(Db("DSCP_TYPE")&&D_()){var r;const t=Db("DSCP_TYPE");Ps(r=["very-low","low","medium","high"]).call(r,t)&&(s.networkPriority=t)}const a=e.getParameters(),c=null===(i=a.encodings)||void 0===i?void 0:i[0];T_()&&!c&&(n.encodings=[s]),c&&Object.assign(c,s),Object.assign(a,n),$b.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await e.setParameters(a)}async applySendEncodings(t,e){try{if(!mR().supportSetRtpSenderParameters)return;if(t.length!==e.length)return;for(let i=0;i<t.length;i++){const n=t[i],s=e[i];s instanceof SI&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(t){$b.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e,i){const n=$L.parse(t);return e.forEach(((t,e)=>{const s=i[e],o=n.mediaDescriptions.find((t=>t.attributes.mid===s));o&&(QL(o,t),sP(o,t,this.store.codec))})),$L.print(n)}mungReceiveAnswerSDP(t,e,i){const n=$L.parse(t),s=n.mediaDescriptions.find((t=>t.attributes.mid===e));return s&&(i===hC.AUDIO&&"audio"===s.media.mediaType&&cP(s),this.useXR&&dP(n)),$L.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;null===(e=this.onFirstAudioReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;null===(e=this.onFirstVideoReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;null===(e=this.onFirstAudioDecoded)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;null===(e=this.onFirstVideoDecodedTimeout)||void 0===e||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let a=0;a<t.length;a++){var i,n,s,o,r;const c=t[a],d=e[a];if(d instanceof SI&&!Ps(i=d._hints).call(i,Dw.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const t={},e={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};t.encodings=[{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:e.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,t))}}}async applySimulcastEncodings(t,e){if(!T_()&&t.length===e.length)for(let i=0;i<t.length;i++){const n=e[i];if(n instanceof SI&&this.isVP8Simulcast(n)){const e=t[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=e.sender.getParameters();await e.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(t){var e,i,n,s,o;return!!(t instanceof SI&&Db("SIMULCAST")&&"vp8"===this.store.codec&&!Ps(e=t._hints).call(e,Dw.LOW_STREAM)&&null!==(i=t._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=t._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=t._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=t._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,i,n){if(Db("SDP_LOGGING"))return $b.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(e," SDP during P2PConnection.").concat(n,"\n"),t),"offer"===e?t=>{this.logSDPExchange(t,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return null==e?void 0:e[0].ssrcId}setConfiguration(e){if(mR().supportPCSetConfiguration){const i=t.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}};function WP(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function $P(t,e){let i=document.createElement("video"),n=document.createElement("canvas");i.setAttribute("style","display:none"),n.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),n.width=fk(e.width),n.height=fk(e.height);const s=fk(e.framerate||15);document.body.append(i),document.body.append(n);let o=t._mediaStreamTrack;i.srcObject=new MediaStream([o]),i.play();const r=n.getContext("2d");if(!r)throw new Uy(U_.UNEXPECTED_ERROR,"can not get canvas context");const a=mR(),c=n.captureStream(a.supportRequestFrame?0:s).getVideoTracks()[0];c.canvas||(c.canvas=n),n.startCapture=()=>{if(!i)return n.stopCapture&&n.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const t=i.videoWidth,e=i.videoHeight/t,s=n.width*e;Math.abs(s-n.height)>=2&&($b.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(s)),n.height=s)}r.drawImage(i,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,i.srcObject=new MediaStream([o]))},n.stopCapture=uR((()=>n.startCapture&&n.startCapture()),s);const d=c.stop;return c.stop=()=>{d.call(c),i&&(i.remove(),i.srcObject=null,i=null),n&&(n.width=0,n.remove(),n.stopCapture&&n.stopCapture(),n.startCapture=void 0,n.stopCapture=void 0,n=null),$b.debug("clean low stream renderer")},c}function zP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function qP(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?zP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):zP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}My([WP,xy("design:type",Function),xy("design:paramtypes",[Array,Array]),xy("design:returntype",e_)],GP.prototype,"updateRemoteRTPCapabilities",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[Object,Object,Array,Object,String,String]),xy("design:returntype",e_)],GP.prototype,"connect",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[Object,Array]),xy("design:returntype",e_)],GP.prototype,"createDataChannels",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[String,Array,String,Object]),xy("design:returntype",e_)],GP.prototype,"receive",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],GP.prototype,"batchReceive",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],GP.prototype,"stopReceiving",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],GP.prototype,"muteRemote",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],GP.prototype,"unmuteRemote",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],GP.prototype,"muteLocal",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],GP.prototype,"unmuteLocal",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],GP.prototype,"close",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],GP.prototype,"updateEncoderConfig",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],GP.prototype,"updateSendParameters",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[iR,String]),xy("design:returntype",e_)],GP.prototype,"replaceTrack",null),My([WP,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],GP.prototype,"getRemoteSSRC",null);const KP="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",YP="9",JP=2e4,XP=4e4;class ZP{get localCapabilities(){return IE(this._localCapabilities)}get rtpCapabilities(){return IE(this._rtpCapabilities)}get candidates(){return IE(this._candidates)}get iceParameters(){return IE(this._iceParameters)}get dtlsParameters(){return IE(this._dtlsParameters)}constructor(t){nu(this,"sessionDesc",void 0),nu(this,"_localCapabilities",void 0),nu(this,"_rtpCapabilities",void 0),nu(this,"_candidates",void 0),nu(this,"_iceParameters",void 0),nu(this,"_dtlsParameters",void 0),nu(this,"setup",void 0),nu(this,"currentMidIndex",void 0),nu(this,"cname",void 0),nu(this,"firefoxSsrcMidMap",new Map),t=IE(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=t,c=$L.parse(KP);this._rtpCapabilities=s,this._candidates=n,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const t of c.mediaDescriptions){if(t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd,t.attributes.fingerprints=i.fingerprints,t.attributes.candidates=n,t.attributes.setup=o,"application"===t.media.mediaType&&(t.attributes.sctpPort="5000"),"video"===t.media.mediaType&&(t.media.fmts=d.videoCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=d.videoCodecs,t.attributes.extmaps=d.videoExtensions,Db("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=ZL([{ssrcId:XP,rtx:Db("USE_SUB_RTX")?40001:void 0}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}if("audio"===t.media.mediaType&&(t.media.fmts=d.audioCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=d.audioCodecs,t.attributes.extmaps=d.audioExtensions,cP(t),Db("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=ZL([{ssrcId:JP}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(t){const e=$L.parse(KP);this._rtpCapabilities=t;const i=this.rtpCapabilities.send;for(const t of e.mediaDescriptions){if(t.attributes.iceUfrag=this._iceParameters.iceUfrag,t.attributes.icePwd=this._iceParameters.icePwd,t.attributes.fingerprints=this._dtlsParameters.fingerprints,t.attributes.candidates=this._candidates,t.attributes.setup=this.setup,"application"===t.media.mediaType&&(t.attributes.sctpPort="5000"),"video"===t.media.mediaType&&(t.media.fmts=i.videoCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=i.videoCodecs,t.attributes.extmaps=i.videoExtensions,Db("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=ZL([{ssrcId:XP,rtx:Db("USE_SUB_RTX")?40001:void 0}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}if("audio"===t.media.mediaType&&(t.media.fmts=i.audioCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=i.audioCodecs,t.attributes.extmaps=i.audioExtensions,Db("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=ZL([{ssrcId:JP}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}}this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1}preloadRemoteMedia(t){this.rtpCapabilities;const e=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<t;o++){const t=2*o+JP,r=2*o+XP,{ssrcs:a,ssrcGroups:c}=ZL([{ssrcId:t}],this.cname),{ssrcs:d,ssrcGroups:l}=ZL([{ssrcId:r,rtx:Db("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:YP,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:YP,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return $L.print(this.sessionDesc)}send(t,e,i,n){const{ssrcs:s,ssrcGroups:o}=ZL(e,this.cname,Db("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(T_()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const t=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const e=this.findAvailableMediaIndex(t,s);let i;return-1===e||S_()||b_()||R_()||0===e&&Db("USE_SUB_RTX")?(i=this.createOrRecycleSendMedia(t,s,o,"sendonly",n),this.updateBundleMids()):(i=IE(this.sessionDesc.mediaDescriptions[e]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(i,n)),T_()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(t){const e=t.map((t=>{let{kind:e,ssrcMsg:i,mslabel:n}=t;return this.send(e,i,n)})),i=[];let n=!1;return e.forEach((t=>{let{mid:e,needExchangeSDP:s}=t;s&&(n=!0),i.push(e)})),{mids:i,needExchangeSDP:n}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>e.attributes.mid&&-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach((t=>{"0"===t.attributes.mid||T_()||S_()||b_()?t.attributes.ssrcs=[]:(t.attributes.ssrcs=[],t.attributes.direction="inactive",t.media.port="0")})),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>Ps(t).call(t,e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="inactive"}))}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>Ps(t).call(t,e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="recvonly"}))}receive(t,e,i,n){t.forEach(((t,s)=>{this.createOrRecycleRecvMedia(t,[],"recvonly",e,i,n[s])})),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach((t=>{t.media.port="0",t.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(t){t===uC.TCP?this._candidates.forEach((t=>{-1===this._candidates.findIndex((e=>"tcp"===e.transport&&e.connectionAddress===t.connectionAddress&&e.port===t.port))&&this._candidates.push(qP(qP({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})):this._candidates=this._candidates.filter((t=>"tcp"!==t.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(t){t=IE(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===t&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(T_()){if(n){const t=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(t||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!t||t!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(t,e,i,n,s,o){const r=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=lP(r,a,this.localCapabilities.send,r===hC.VIDEO?n:s),d=r===hC.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:r,port:YP,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,t,o);const u=this.findFirstClosedMedia(r);if(u){const t=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[t]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(t,e,i){const n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var e;return Ps(e=Object.keys(xb)).call(e,t)})))],s=new Set(e);if(n.every((t=>s.has(t))))return $b.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter((t=>e.some((e=>{var i;return Ps(i=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(i,e)}))));if(0===o.length)return $b.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(e)),!1;const r=[...new Set(o.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")))];let a;if($b.debug("updateRemoteCodec, from ".concat(n," to ").concat(r)),0===t.length)a=this.sessionDesc.mediaDescriptions.filter((t=>"video"===t.media.mediaType&&"recvonly"===t.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((e=>e.attributes.mid&&Ps(t).call(t,e.attributes.mid)&&"recvonly"===e.attributes.direction)),a.length!==t.length)return $b.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(e)),!1;this._rtpCapabilities.recv.videoCodecs=o;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=lP(hC.VIDEO,d,c,i);return a.forEach((t=>{const e=l.map((t=>t.payloadType.toString(10)));$b.debug("updateRemoteCodec mid: ".concat(t.attributes.mid,", from ").concat(t.attributes.payloads," to ").concat(l)),t.attributes.payloads=l,t.media.fmts=e})),!0}createOrRecycleSendMedia(t,e,i,n,s){const o=this.rtpCapabilities.send,r=t===hC.VIDEO?o.videoCodecs:o.audioCodecs,a=t===hC.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:t,port:YP,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(t);if(l){const t=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[t]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((t=>"0"!==t.media.port)).map((t=>t.attributes.mid))}mungRecvMediaDsec(t,e,i){const n=IE(t);return tP(n),QL(n,e),eP(n,e),iP(n),nP(n,i,this.localCapabilities.send),n}mungSendMediaDesc(t,e){const i=IE(t);return nP(i,e,this.localCapabilities.recv),cP(i),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===t));if(-1!==i){const t=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=t}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find((e=>T_()?"0"===e.media.port&&e.media.mediaType===t:"0"===e.media.port))}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find((e=>{var i;return(null===(i=e.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===t[0].ssrcId}))}getSSRC(t){var e;return null===(e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t)))||void 0===e?void 0:e.attributes.ssrcs}}function QP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function tD(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?QP(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):QP(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class eD extends LC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(t,e,i){super(t,e),nu(this,"store",void 0),nu(this,"peerConnection",void 0),nu(this,"remoteSDP",void 0),nu(this,"initialOffer",void 0),nu(this,"transportEventReceiver",void 0),nu(this,"statsFilter",void 0),nu(this,"useXR",Db("USE_XR")),nu(this,"localCapabilities",void 0),nu(this,"localCandidateCount",0),nu(this,"allCandidatesReceived",!1),nu(this,"remoteCodecs",void 0),nu(this,"dataStreamChannelMap",new Map),nu(this,"establishPromise",void 0),nu(this,"mutex",new zE("NVExtentionsConnection-mutex")),nu(this,"rtcMedia",void 0),this.store=e,this.peerConnection=i,this.statsFilter=LP(this.peerConnection,Db("STATS_UPDATE_INTERVAL"),void 0,T_()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(t){try{const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=YL(t.sdp),i=await oP({filterRTX:!Db("USE_PUB_RTX")&&!Db("USE_SUB_RTX"),filterVideoFec:Db("FILTER_VIDEO_FEC"),filterAudioFec:Db("FILTER_AUDIO_FEC"),filterVideoCodec:Db("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=i,this.initialOffer=t,tD(tD({},e),{},{rtpCapabilities:i,offerSDP:t.sdp})}catch(t){throw new Uy(U_.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new ZP({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:aP(this.localCapabilities),cname:o});const r=this.remoteSDP.toString(),a=$L.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((t=>"audio"===t.media.mediaType));c&&cP(c),this.useXR&&dP(a);const d=$L.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(t.toString()))}}async updateRemoteRTPCapabilities(t,e){let i;this.remoteCodecs=e,this.localCapabilities&&(i=aP(this.localCapabilities));const n=[...new Set(i&&i.send.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var e;return Ps(e=Object.keys(xb)).call(e,t)})))];if(sy.updateRemoteRTPCapabilities(this.store.sessionId,{mids:t,localCodecs:n,remoteCodecs:this.remoteCodecs}),this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(t,e,this.store.codec)){const t=await this.peerConnection.createOffer(),e=this.logSDPExchange(t.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(t);const i=this.remoteSDP.toString();null==e||e(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else $b.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else $b.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(n,", codecs: ").concat(e))}async updateRemoteConnect(t){var e,i,n,s;null===(e=this.remoteSDP)||void 0===e||e.updateRemoteRTPCapabilities(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&(null===(s=this.remoteSDP)||void 0===s||s.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),null===(i=this.remoteSDP)||void 0===i||i.preloadRemoteMedia(2);const o=null===(n=this.remoteSDP)||void 0===n?void 0:n.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r),$b.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(t,e,i){var n=this;return BL((function*(){const s=yield jL(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];t.forEach((t=>{const e=n.peerConnection.addTransceiver(t._mediaStreamTrack,{direction:"sendonly"});o.push(e)})),T_()&&!0===Db("SIMULCAST")&&(yield jL(n.applySimulcastForFirefox(o,t)));const r=yield jL(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(t.length),c=n.mungSendOfferSDP(r.sdp,t,a),d=$L.parse(c),l=a.map((t=>{const e=d.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("Cannot extract ssrc from mediaDescription.");return JL(e,Db("USE_PUB_RTX"))}));let h;try{h=yield l}catch(s){h=[],n.remoteSDP.receive(t,e,i,h);const o=n.remoteSDP.toString();throw yield jL(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield jL(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield jL(n.stopSending(a,!0)),s}n.remoteSDP.receive(t,e,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield jL(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield jL(n.applySimulcastEncodings(o,t)),yield jL(n.applySendEncodings(o,t)),null==p||p(u),yield jL(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((t,e)=>{const i=a[e];return{localSSRC:l[e],id:i,transceiver:t}}))}catch(t){throw t instanceof Uy?t:new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(t.toString()))}finally{s()}}))()}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const e=this.peerConnection.getTransceivers().filter((e=>-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");e.map((t=>{var e;t.direction="inactive",null===(e=t.stop)||void 0===e||e.call(t)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(t);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(t.toString()))}finally{i&&i()}}async createDataChannels(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);return i&&"open"===i.readyState?$b.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:Db("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)),void e.forEach((t=>{t._updateOriginDataChannel(i)}))}catch(t){throw t instanceof Uy?t:new Uy(U_.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(t.toString()))}}async stopDataChannels(t){try{const e=this.dataStreamChannelMap.get(t);return null==e||e.close(),void this.dataStreamChannelMap.delete(t)}catch(t){throw t instanceof Uy?t:new Uy(U_.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(t.toString()))}}async receive(t,e,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,n);if(o){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(n.sdp,s,t);null==i||i(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),$b.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else $b.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((t=>t.mid===s));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:s}}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(t.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const t=this.remoteSDP.toString(),e=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==e||e(i.sdp||""),await this.peerConnection.setLocalDescription(i),$b.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else $b.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return e.map((t=>{const e=this.peerConnection.getTransceivers().find((e=>e.mid===t));if(!e)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:e.receiver.track,id:t}}))}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((t=>{t.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((async(t,e)=>{t.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(t){var e=this;return BL((function*(){const i=yield jL(e.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(mR().supportPCSetConfiguration){const i=e.peerConnection.getConfiguration(),n=t===uC.RELAY?"relay":"all";i.iceTransportPolicy!==n&&($b.debug("restartICE change iceTransportPolicy from [".concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,e.peerConnection.setConfiguration(i))}else if(t===uC.RELAY)return;t!==uC.RELAY&&e.remoteSDP.updateCandidates(t);const n=yield jL(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=YL(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const r=e.remoteSDP.toString(),a=e.logSDPExchange(n.sdp||"","offer","local","restartICE");yield jL(e.peerConnection.setLocalDescription(n)),null==a||a(r),yield jL(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){$b.warning("restart ICE failed, abort operation",t)}finally{i()}}))()}close(){var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new Uy(U_.EXCHANGE_SDP_FAILED,t.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter((e=>e.mid===t));1===i.length&&(this.isVP8Simulcast(e)?T_()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find((t=>t.mid===e));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}getP2PConnectionParams(){var t;if(null===(t=this.peerConnection.currentLocalDescription)||void 0===t||!t.sdp||!this.localCapabilities)throw new Error;return tD(tD({},YL(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,$b.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,$b.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Db("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(mE(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...eD.turnServerConfigToIceServers(t.turnServer.servers)),Db("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...eD.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Db("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(e.iceTransportPolicy="relay")})))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(mk(t.turnServerURL),":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&!Db("FORCE_TURN_TCP")&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}async applySendEncodings(t,e){try{if(!mR().supportSetRtpSenderParameters)return;if(t.length!==e.length)return;for(let l=0;l<t.length;l++){const h=t[l],u=e[l];if(u&&u instanceof SI){var i,n,s;if(this.isVP8Simulcast(u))continue;const t={},e={};switch(u._optimizationMode){case"motion":t.degradationPreference="maintain-framerate";break;case"detail":t.degradationPreference="maintain-resolution";break;default:t.degradationPreference="balanced"}var o,r,a,c;if(null!==(i=u._encoderConfig)&&void 0!==i&&i.bitrateMax&&(e.maxBitrate=1e3*(null===(o=u._encoderConfig)||void 0===o?void 0:o.bitrateMax)),Ps(n=u._hints).call(n,Dw.LOW_STREAM)&&(null!==(r=u._encoderConfig)&&void 0!==r&&r.frameRate&&(e.maxFramerate=fk(u._encoderConfig.frameRate)),null!==(a=u._encoderConfig)&&void 0!==a&&a.scaleResolutionDownBy&&(null===(c=u._encoderConfig)||void 0===c?void 0:c.scaleResolutionDownBy)>1&&(e.scaleResolutionDownBy=u._encoderConfig.scaleResolutionDownBy)),Db("DSCP_TYPE")&&D_()){var d;const t=Db("DSCP_TYPE");Ps(d=["very-low","low","medium","high"]).call(d,t)&&(e.networkPriority=t)}const l=h.sender.getParameters(),p=null===(s=l.encodings)||void 0===s?void 0:s[0];T_()&&!p&&(t.encodings=[e]),p&&Object.assign(p,e),Object.assign(l,t),await h.sender.setParameters(l)}}}catch(t){$b.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(t,e,i){const n=$L.parse(t);return e.forEach(((t,e)=>{const s=i[e],o=n.mediaDescriptions.find((t=>t.attributes.mid===s));o&&(QL(o,t),sP(o,t,this.store.codec))})),$L.print(n)}mungReceiveAnswerSDP(t,e,i){const n=$L.parse(t),s=n.mediaDescriptions.find((t=>t.attributes.mid===e));return s&&i===hC.AUDIO&&"audio"===s.media.mediaType&&cP(s),this.useXR&&dP(n),$L.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;null===(e=this.onFirstAudioReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;null===(e=this.onFirstVideoReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;null===(e=this.onFirstAudioDecoded)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;null===(e=this.onFirstVideoDecodedTimeout)||void 0===e||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let a=0;a<t.length;a++){var i,n,s,o,r;const c=t[a],d=e[a];if(d instanceof SI&&!Ps(i=d._hints).call(i,Dw.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const t={},e={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};t.encodings=[{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:e.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,t))}}}async applySimulcastEncodings(t,e){if(!T_()&&t.length===e.length)for(let i=0;i<t.length;i++){const n=e[i];if(n instanceof SI&&this.isVP8Simulcast(n)){const e=t[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=e.sender.getParameters();await e.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(t){var e,i,n,s,o;return!!(t instanceof SI&&Db("SIMULCAST")&&"vp8"===this.store.codec&&!Ps(e=t._hints).call(e,Dw.LOW_STREAM)&&null!==(i=t._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=t._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=t._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=t._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,i,n){if(Db("SDP_LOGGING"))return $b.upload("exchanging ".concat(i," ").concat(e," SDP during NVExtentionsConnection.").concat(n,"\n"),t),"offer"===e?t=>{this.logSDPExchange(t,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return null==e?void 0:e[0].ssrcId}setConfiguration(t){if(mR().supportPCSetConfiguration){const e=eD.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function iD(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From NVExtentionsConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function nD(t){var e,i,n,s=2;for("undefined"!=typeof Symbol&&(i=GL,n=Symbol.iterator);s--;){if(i&&null!=(e=t[i]))return e.call(t);if(n&&null!=(e=t[n]))return new sD(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function sD(t){function e(t){if(Object(t)!==t)return e_.reject(new TypeError(t+" is not an object."));var e=t.done;return e_.resolve(t.value).then((function(t){return{value:t,done:e}}))}return sD=function(t){this.s=t,this.n=t.next},sD.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var i=this.s.return;return void 0===i?e_.resolve({value:t,done:!0}):e(i.apply(this.s,arguments))},throw:function(t){var i=this.s.return;return void 0===i?e_.reject(t):e(i.apply(this.s,arguments))}},new sD(t)}My([iD,xy("design:type",Function),xy("design:paramtypes",[Object,Object,Array,Object,String,String]),xy("design:returntype",e_)],eD.prototype,"connect",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[Array,Array]),xy("design:returntype",e_)],eD.prototype,"updateRemoteRTPCapabilities",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],eD.prototype,"updateRemoteConnect",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[Object,Array]),xy("design:returntype",e_)],eD.prototype,"createDataChannels",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[String,Array,String,Object]),xy("design:returntype",e_)],eD.prototype,"receive",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],eD.prototype,"batchReceive",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],eD.prototype,"stopReceiving",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],eD.prototype,"muteRemote",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],eD.prototype,"unmuteRemote",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],eD.prototype,"muteLocal",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],eD.prototype,"unmuteLocal",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],eD.prototype,"close",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],eD.prototype,"updateEncoderConfig",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],eD.prototype,"updateSendParameters",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[iR,String]),xy("design:returntype",e_)],eD.prototype,"replaceTrack",null),My([iD,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],eD.prototype,"getRemoteSSRC",null);class oD extends LC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(t,e){super(t,e),nu(this,"store",void 0),nu(this,"peerConnection",void 0),nu(this,"cname",void 0),nu(this,"mutex",new zE("DataChannelConnection-mutex")),nu(this,"dataChannel",void 0),nu(this,"_p2pConnection",void 0),nu(this,"establishPromise",void 0),nu(this,"_nvMedia",void 0),this.store=e,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(oD.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new eD(t,e,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var t;const e=null===(t=this._nvMedia)||void 0===t?void 0:t.getLocalRtpCapabilities();return await this._p2pConnection.establish(e)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(t,e,i,n,s,o){return this.cname=o,await this._p2pConnection.connect(t,e,i,n,s,o),await new e_(((t,e)=>{const n=setTimeout((()=>{this.closeSignal(),e(new Uy(U_.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void t()},this.dataChannel.onerror=t=>{this.closeSignal(),e(t)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,e){return this._p2pConnection.updateRemoteRTPCapabilities(t,e)}send(t,e,i){var n=this;return BL((function*(){const s=yield jL(n.mutex.lock("From DataChannelConnection.send"));try{return yield*HL(nD(n._p2pConnection.send(t,e,i)))}finally{s()}}))()}async stopSending(t,e){return this._p2pConnection.stopSending(t,e)}async createDataChannels(t,e){return this._p2pConnection.createDataChannels(t,e)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,e,i,n){return this._nvMedia?($b.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,e,this.cname)):($b.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,e,i,n))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var e=this;return BL((function*(){return yield*HL(nD(e._p2pConnection.restartICE(t)))}))()}close(){var t;null===(t=this._nvMedia)||void 0===t||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var e;null===(e=this._nvMedia)||void 0===e||e.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,e){return await this._p2pConnection.updateEncoderConfig(t,e)}async updateSendParameters(t,e){return await this._p2pConnection.updateSendParameters(t,e)}setStatsRemoteVideoIsReady(t,e){this._p2pConnection.setStatsRemoteVideoIsReady(t,e)}async replaceTrack(t,e){return await this._p2pConnection.replaceTrack(t,e)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,e,i,n){if(Db("SDP_LOGGING"))return $b.upload("exchanging ".concat(i," ").concat(e," SDP during DataChannelConnection.").concat(n,"\n"),t),"offer"===e?t=>{this.logSDPExchange(t,"answer","local"===i?"remote":"local",n)}:void 0}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(mE(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...oD.turnServerConfigToIceServers(t.turnServer.servers)),Db("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...oD.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Db("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(e.iceTransportPolicy="relay")})))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(mk(t.turnServerURL),":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&!Db("FORCE_TURN_TCP")&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var e;return null===(e=this.onICEConnectionStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var e;return null===(e=this.onConnectionStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var e;return null===(e=this.onDTLSTransportStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var e;return null===(e=this.onDTLSTransportError)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var e;return null===(e=this.onICETransportStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var e;return null===(e=this.onFirstAudioReceived)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var e;return null===(e=this.onFirstVideoReceived)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var e;return null===(e=this.onFirstAudioDecoded)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,e,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,t,e,i)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var e;return null===(e=this.onFirstVideoDecodedTimeout)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,e)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,t,e)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,e)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,t,e)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}}function rD(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From DataChannelConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function aD(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function cD(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?aD(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):aD(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}My([rD,xy("design:type",Function),xy("design:paramtypes",[Object,Object,Array,Object,String,String]),xy("design:returntype",e_)],oD.prototype,"connect",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[Array,Array]),xy("design:returntype",e_)],oD.prototype,"updateRemoteRTPCapabilities",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[Object,Array]),xy("design:returntype",e_)],oD.prototype,"createDataChannels",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[String,Array,String,Object]),xy("design:returntype",e_)],oD.prototype,"receive",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],oD.prototype,"stopReceiving",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],oD.prototype,"muteRemote",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],oD.prototype,"unmuteRemote",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],oD.prototype,"muteLocal",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],oD.prototype,"unmuteLocal",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],oD.prototype,"close",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],oD.prototype,"updateEncoderConfig",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],oD.prototype,"updateSendParameters",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[iR,String]),xy("design:returntype",e_)],oD.prototype,"replaceTrack",null),My([rD,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],oD.prototype,"getRemoteSSRC",null);class dD extends iE{constructor(){super(),nu(this,"uplinkStatsUploadInterval",void 0),nu(this,"uplinkRelatedStatsUploadInterval",void 0),nu(this,"uplinkDenoiserStatsUploadInterval",void 0),nu(this,"transportStatsUploadInterval",void 0),nu(this,"uplinkExtensionStatsUploadInterval",void 0),nu(this,"downlinkExtensionStatsUploadInterval",void 0),nu(this,"extensionUsageStatsUploadInterval",void 0),nu(this,"downlinkStatsUploadInterval",void 0),nu(this,"downlinkRelatedStatsUploadInterval",void 0),nu(this,"lastStats",void 0),nu(this,"uploadUnplinkStarted",!1),nu(this,"uploadDownlinkStarted",!1),nu(this,"uploadTransportStarted",!1),nu(this,"uploadExtensionUsageStarted",!1),nu(this,"requestStats",void 0),nu(this,"requestTransportStats",void 0),nu(this,"requestLocalMedia",void 0),nu(this,"requestRemoteMedia",void 0),nu(this,"requestAllTracks",void 0),nu(this,"requestVideoIsReady",void 0),nu(this,"requestUpload",void 0)}startUploadTransportStats(t){this.uploadTransportStarted||(this.uploadTransportStarted=!0,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=window.setInterval((()=>{var e;const i=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);if(i){const e=_k(i);if(t){var n;const t=null===(n=this.requestStats)||void 0===n?void 0:n.call(this,!0);if(t){const i=_k(t);e.connectionType+=i.connectionType<<3}e.connectionType+=110}else e.connectionType+=100;RE((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,Sy.TRANSPORT_STATS,e)}))}}),1e3))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval);const t=new Map;this.extensionUsageStatsUploadInterval=window.setInterval((async()=>{var e,i,n;const s=Date.now(),o={connectionInterval:Db("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:s};let r=[];const a=(null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this))||[];for(const t of a)!t.muted&&t.enabled&&(r=r.concat(await t.getProcessorUsage()));const c=(null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[];for(const[t,e]of c)e.has(hC.VIDEO)&&t.videoTrack&&(r=r.concat(await t.videoTrack.getProcessorUsage())),e.has(hC.AUDIO)&&t.audioTrack&&(r=r.concat(await t.audioTrack.getProcessorUsage()));if(0===r.length)return;o.details=function(t,e){const i={};for(const{id:r,value:a,level:c,direction:d}of t){var n;const t=null!==(n=e.get(r))&&void 0!==n?n:0,l=2===a?t+Db("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:t;var s,o;e.set(r,l),i[r]?(2===a&&(i[r].value=a),c>i[r].level&&(i[r].level=c),"remote"===d&&(i[r].remoteUidCount+=1),i[r].totalTs=null!==(s=e.get(r))&&void 0!==s?s:0):i[r]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=e.get(r))&&void 0!==o?o:0}}return Object.keys(i).map((t=>{const{level:e,value:n,totalTs:s}=i[t];return{id:t,level:e,value:n,totalTs:s}}))}(r,t);const d=Date.now(),l=d>s?d:s+1;null===(n=this.requestUpload)||void 0===n||n.call(this,Sy.EXTENSION_USAGE_STATS,{usageStats:o,sendTs:l})}),Db("EXTENSION_USAGE_UPLOAD_INTERVAL"))}startUploadUplinkStats(){this.uploadUnplinkStarted||(this.uploadUnplinkStarted=!0,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestStats)||void 0===t?void 0:t.call(this);e&&(this.uploadUplinkStats(e),this.lastStats=e)}),3e3),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkRelatedStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestStats)||void 0===t?void 0:t.call(this);e&&this.uploadRelatedUplinkStats(e,this.lastStats),this.lastStats=e}),1e3),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestAllTracks)||void 0===t?void 0:t.call(this);e&&this.uploadDenoiserStats(e)}),2e3),this.uplinkExtensionStatsUploadInterval&&window.clearInterval(this.uplinkExtensionStatsUploadInterval),this.uplinkExtensionStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestAllTracks)||void 0===t?void 0:t.call(this);e&&this.uploadExtensionStats(e)}),2e3))}uploadUplinkStats(t){var e;((null===(e=this.requestLocalMedia)||void 0===e?void 0:e.call(this))||[]).forEach((e=>{let[i,{track:n,ssrcs:s}]=e;switch(i){case mC.LocalVideoLowTrack:case mC.LocalVideoTrack:{const e=function(t,e,i){var n;const s=e.videoSend.find((e=>e.ssrc===t));if(!s)return null;const o={id:UE(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:s.ssrc.toString()};switch(o.A_vstd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",s.sentFrame&&(o.A_fhs=s.sentFrame.height.toString(),o.A_frs=s.sentFrame.frameRate.toString(),o.A_fws=s.sentFrame.width.toString()),s.adaptionChangeReason){case"none":o.A_ac="0";break;case"cpu":o.A_ac="1";break;case"bandwidth":o.A_ac="2";break;case"other":o.A_ac="3"}return o.A_lvps=Qw[i._player?i._player.videoElementStatus:"uninit"].toString(),o.A_nr=null===(n=s.nacksCount)||void 0===n?void 0:n.toString(),s.avgEncodeMs&&(o.A_aem=s.avgEncodeMs.toFixed(0).toString()),Db("P2P")&&(s.bytes&&(o.bytesSent=s.bytes.toString()),"number"==typeof s.packetsLost&&(o.packetsLost=s.packetsLost.toString()),s.packets&&(o.packetsSent=s.packets.toString())),o}(s[0].ssrcId,t,n),o=i===mC.LocalVideoTrack?function(t,e,i){var n,s,o,r,a,c,d,l;const h=e.videoSend.find((e=>e.ssrc===t));if(!h)return null;const u={id:UE(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:h.ssrc.toString()},p=null!==(n=null!==(s=null===(o=h.inputFrame)||void 0===o?void 0:o.height)&&void 0!==s?s:null==i?void 0:i._videoHeight)&&void 0!==n?n:0,m=null!==(r=null!==(a=null===(c=h.inputFrame)||void 0===c?void 0:c.width)&&void 0!==a?a:null==i?void 0:i._videoWidth)&&void 0!==r?r:0,g=null!==(d=null===(l=h.inputFrame)||void 0===l?void 0:l.frameRate)&&void 0!==d?d:0;return p&&(u.A_fhi=p+""),m&&(u.A_fwi=m+""),g&&(u.A_fri=g+""),u}(s[0].ssrcId,t,n):null;e&&RE((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,Sy.PUBLISH_STATS,{stream_type:i===mC.LocalVideoLowTrack?"low":"high",stats:cD(cD({},e),o)})}));const r=function(t){const e={id:"bweforvideo",timestamp:new Date(t.timestamp).toISOString(),type:"VideoBwe"};return t.bitrate.retransmit&&(e.A_rb=t.bitrate.retransmit.toString()),t.bitrate.targetEncoded&&(e.A_teb=t.bitrate.targetEncoded.toString()),e.A_aeb=t.bitrate.actualEncoded.toString(),e.A_tb=t.bitrate.transmit.toString(),void 0!==t.sendBandwidth&&(e.A_asb=t.sendBandwidth.toString()),e}(t);r&&setTimeout((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,Sy.PUBLISH_STATS,{stream_type:i===mC.LocalVideoLowTrack?"low":"high",stats:r})}),1e3);break}case mC.LocalAudioTrack:{const e=function(t,e,i){const n=e.audioSend.find((e=>e.ssrc===t));if(!n)return null;const s={id:UE(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:n.ssrc.toString()};return s.A_astd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",n.inputLevel?s.A_ail=Math.round(100*n.inputLevel).toString():s.A_ail=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),s.A_apil=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),n.aecReturnLoss&&(s.A_ecrl=Math.round(n.aecReturnLoss).toString()),n.aecReturnLossEnhancement&&(s.A_ecrle=Math.round(n.aecReturnLossEnhancement).toString()),Db("P2P")&&(n.bytes&&(s.bytesSent=n.bytes.toString()),"number"==typeof n.packetsLost&&(s.packetsLost=n.packetsLost.toString()),n.packets&&(s.packetsSent=n.packets.toString())),s}(s[0].ssrcId,t,n);e&&RE((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,Sy.PUBLISH_STATS,{stream_type:"high",stats:e})}));break}}}))}uploadRelatedUplinkStats(t,e){var i;((null===(i=this.requestLocalMedia)||void 0===i?void 0:i.call(this))||[]).filter((t=>{let[e]=t;return e===mC.LocalVideoLowTrack||e===mC.LocalVideoTrack})).forEach((e=>{let[i,{ssrcs:n}]=e;const s=function(t,e){const i=e.videoSend.find((e=>e.ssrc===t));return i?{mediaType:"video",isVideoMute:!1,frameRateInput:i.inputFrame&&i.inputFrame.frameRate.toString(),frameRateSent:i.sentFrame&&i.sentFrame.frameRate.toString(),googRtt:i.rttMs.toString(),qpSumPerFrame:Math.floor(i.qpSumPerFrame).toString()}:null}(n[0].ssrcId,t);s&&RE((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,Sy.PUBLISH_RELATED_STATS,{stream_type:i===mC.LocalVideoLowTrack?"low":"high",stats:s})}))}))}uploadDenoiserStats(t){for(let s=0;s<t.length;s++){const o=t[s];if(o instanceof QR){var e,i,n;const t=null===(e=(i=o._external).getDenoiserStats)||void 0===e?void 0:e.call(i);return void(t&&(null===(n=this.requestUpload)||void 0===n||n.call(this,Sy.DENOISER_STATS,t)))}}}uploadExtensionStats(t){for(let e=0;e<t.length;e++)t[e].getProcessorStats().forEach((t=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,t.type,t.stats)}))}stopUploadUplinkStats(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0)}startUploadDownlinkStats(){if(this.uploadDownlinkStarted)return;let t;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let e=!1;this.downlinkStatsUploadInterval=window.setInterval((()=>{var i;const n=null===(i=this.requestStats)||void 0===i?void 0:i.call(this,!0);n&&(this.uploadDownlinkStats(n,e,t),t=n),e=!e}),3e3),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkRelatedStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestStats)||void 0===t?void 0:t.call(this,!0);e&&(this.uploadRelatedDownlinkStats(e,this.lastStats),this.lastStats=e)}),1e3),this.downlinkExtensionStatsUploadInterval&&window.clearInterval(this.downlinkExtensionStatsUploadInterval),this.downlinkExtensionStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestRemoteMedia)||void 0===t?void 0:t.call(this);e&&this.uploadDownlinkExtensionStats(e)}),2e3)}uploadDownlinkStats(t,e,i){var n;((null===(n=this.requestRemoteMedia)||void 0===n?void 0:n.call(this))||[]).forEach((n=>{let[s,o]=n;if(o.has(hC.VIDEO)&&s.videoTrack){const n=s.videoTrack?function(t,e,i,n,s){const o=e.videoRecv.find((e=>e.ssrc===t));if(!o)return null;const r={id:UE(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:o.ssrc.toString()};var a,c;if(r.bytesReceived=o.bytes.toString(),r.packetsLost=o.packetsLost.toString(),r.packetsReceived=o.packets.toString(),o.framesRateFirefox&&(r.A_frr=o.framesRateFirefox.toString()),o.receivedFrame?(r.A_frr=o.receivedFrame.frameRate.toString(),r.A_fhr=o.receivedFrame.height.toString(),r.A_fwr=o.receivedFrame.width.toString()):(r.A_fhr=null===(a=n._videoHeight)||void 0===a?void 0:a.toString(),r.A_fwr=null===(c=n._videoWidth)||void 0===c?void 0:c.toString()),r.A_frd=o.decodeFrameRate.toString(),o.outputFrame&&(r.A_fro=o.outputFrame.frameRate.toString()),void 0!==o.jitterBufferMs&&(r.A_jbm=Math.floor(o.jitterBufferMs).toString()),void 0!==o.currentDelayMs&&(r.A_cdm=Math.floor(o.currentDelayMs).toString()),r.A_fs=o.firsCount.toString(),r.A_ns=o.nacksCount.toString(),r.A_ps=o.plisCount.toString(),n&&(r.A_vrtd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),n._player&&n._player.freezeTimeCounterList.length>0&&(r.A_vrft=Math.round(n._player.freezeTimeCounterList.splice(0,1)[0]).toString()),s&&n._player&&"visible"===dI.visibility){const t=Math.min(6e3,n._player.renderFreezeAccTime);r.A_vrrft=Math.round(t).toString(),n._player.renderFreezeAccTime=Math.max(0,n._player.renderFreezeAccTime-t)}if(r.A_rvps=Qw[n._player?n._player.videoElementStatus:"uninit"].toString(),i){const e=i.videoRecv.find((e=>e.ssrc===t));if(e&&void 0!==o.totalInterFrameDelay&&void 0!==o.totalSquaredInterFrameDelay&&void 0!==e.totalInterFrameDelay&&void 0!==e.totalSquaredInterFrameDelay){const t=o.totalInterFrameDelay-e.totalInterFrameDelay,i=o.totalSquaredInterFrameDelay-e.totalSquaredInterFrameDelay,n=o.framesDecodeCount-e.framesDecodeCount,s=t/n*1e3,a=Math.round(1e3*Math.sqrt((i-Math.pow(t,2)/n)/n));!isNaN(a)&&s+a>Math.max(3*s,s+150)&&(r.A_ifdsd=a.toString())}}return r}(s._videoSSRC,t,i,s.videoTrack,e):void 0;n&&RE((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,Sy.SUBSCRIBE_STATS,{stream_id:s.uid,stats:n})}))}if(o.has(hC.AUDIO)&&s.audioTrack){const e=s.audioTrack?function(t,e,i,n){const s=e.audioRecv.find((e=>e.ssrc===t));if(!s)return null;const o={id:UE(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:s.ssrc.toString()};if(o.bytesReceived=s.bytes.toString(),o.packetsLost=s.packetsLost.toString(),o.packetsReceived=s.packets.toString(),s.outputLevel?o.A_aol=Math.round(100*s.outputLevel).toString():o.A_aol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),o.A_apol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),n&&(o.A_artd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),o.A_jr=s.jitterMs.toString(),o.A_jbm=Math.floor(s.jitterBufferMs).toString(),o.A_cdm=Math.floor(s.jitterBufferMs).toString(),o.A_raps=Qw[UR.getPlayerState(n.getTrackId())].toString(),i){const e=i.audioRecv.find((e=>e.ssrc===t));if(e){const t=s.concealedSamples-e.concealedSamples;t>0&&(o.A_cs=Math.round(t).toString())}}return o}(s._audioSSRC,t,i,s.audioTrack):void 0;e&&RE((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,Sy.SUBSCRIBE_STATS,{stream_id:s.uid,stats:e})}))}}))}uploadRelatedDownlinkStats(t,e){var i;((null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[]).forEach((i=>{let[n,s]=i;if(s.has(hC.VIDEO)&&n.videoTrack){var o;const i=!0===(n._videoSSRC&&(null===(o=this.requestVideoIsReady)||void 0===o?void 0:o.call(this,n._videoSSRC))||!1),s=function(t,e,i,n,s,o){const r=i.videoRecv.find((e=>e.ssrc===t)),a=s?s.videoRecv.find((e=>e.ssrc===t)):void 0;if(!r)return null;const c=hk.isRemoteVideoFreeze(o,r,a)&&e,d={mediaType:"video",isVideoMute:!1,peerId:n,frameRateReceived:r.receivedFrame&&r.receivedFrame.frameRate.toString(),frameRateDecoded:r.decodedFrame&&r.decodedFrame.frameRate.toString(),isFreeze:c,bytesReceived:r.bytes.toString(),packetsReceived:r.packets.toString(),packetsLost:r.packetsLost.toString(),qpSumPerFrame:Math.floor(r.qpSumPerFrame).toString()};return r.framesRateFirefox&&(d.frameRateDecoded=r.framesRateFirefox.toString(),d.frameRateReceived=r.framesRateFirefox.toString()),d}(n._videoSSRC,i,t,n.uid,e,n.videoTrack);s&&RE((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,Sy.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:s})}))}if(s.has(hC.AUDIO)&&n.audioTrack){const e=function(t,e,i,n){const s=e.audioRecv.find((e=>e.ssrc===t));if(!s)return null;const o=hk.isRemoteAudioFreeze(n);return{mediaType:"audio",isAudioMute:!1,peerId:i,googJitterReceived:s.jitterMs.toString(),isFreeze:o,bytesReceived:s.bytes.toString(),packetsReceived:s.packets.toString(),packetsLost:s.packetsLost.toString(),frameReceived:s.receivedFrames.toString(),frameDropped:s.droppedFrames.toString()}}(n._audioSSRC,t,n.uid,n.audioTrack);e&&RE((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,Sy.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:e})}))}}))}stopUploadDownlinkStats(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0)}stopUploadTransportStats(){this.uploadTransportStarted&&(this.uploadTransportStarted=!1,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=void 0)}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval),this.extensionUsageStatsUploadInterval=void 0)}uploadDownlinkExtensionStats(t){t.forEach((t=>{let[e,i]=t;i.has(hC.VIDEO)&&e.videoTrack&&e.videoTrack.getProcessorStats().forEach((t=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,t.type,t.stats)})),i.has(hC.AUDIO)&&e.audioTrack&&e.audioTrack.getProcessorStats().forEach((t=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,t.type,t.stats)}))}))}}function lD(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function hD(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?lD(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):lD(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function uD(t){var e,i,n,s=2;for("undefined"!=typeof Symbol&&(i=GL,n=Symbol.iterator);s--;){if(i&&null!=(e=t[i]))return e.call(t);if(n&&null!=(e=t[n]))return new pD(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function pD(t){function e(t){if(Object(t)!==t)return e_.reject(new TypeError(t+" is not an object."));var e=t.done;return e_.resolve(t.value).then((function(t){return{value:t,done:e}}))}return pD=function(t){this.s=t,this.n=t.next},pD.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var i=this.s.return;return void 0===i?e_.resolve({value:t,done:!0}):e(i.apply(this.s,arguments))},throw:function(t){var i=this.s.return;return void 0===i?e_.reject(t):e(i.apply(this.s,arguments))}},new pD(t)}class mD extends iE{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(fC.StateChange,e,this._state)}constructor(t,e){super(),nu(this,"store",void 0),nu(this,"statsUploader",void 0),nu(this,"connection",void 0),nu(this,"localTrackMap",new Map),nu(this,"remoteUserMap",new Map),nu(this,"localDataChannels",[]),nu(this,"remoteDataChannelMap",new Map),nu(this,"pendingLocalTracks",[]),nu(this,"pendingRemoteTracks",[]),nu(this,"pendingLocalDataChannels",[]),nu(this,"pendingRemoteDataChannels",[]),nu(this,"statsCollector",void 0),nu(this,"isPlanB",!1),nu(this,"shouldForwardP2PCreation",void 0),nu(this,"iceFailedCount",0),nu(this,"dtlsFailedCount",0),nu(this,"mutex",new zE("P2PChannel-mutex")),nu(this,"_state",gC.Disconnected),nu(this,"_pcStatsUploadType",Db("NEW_ICE_RESTART")?pC.FIRST_CONNECTION:pC.OLD_FIRST_CONNECTION),nu(this,"_isInRestartIce",!1),nu(this,"_isStartRestartIce",!1),nu(this,"_restartStates",["disconnected","failed"]),nu(this,"_restartTimer",void 0),nu(this,"_isFirstConnected",!0),nu(this,"handleMuteLocalTrack",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==gC.Connected)return void i(new V_(U_.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(t);if(0===s.length)return void e();const o=s.find((t=>"videoLowTrack"===t[0]));o&&o[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(s.map((t=>{let[,{id:e}]=t;return e})));const r=this.createMuteMessage(s);await _E(this,fC.RequestMuteLocal,r),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleUnmuteLocalTrack",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==gC.Connected)return void i(new V_(U_.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(t);if(0===s.length)return void e();const o=s.find((t=>"videoLowTrack"===t[0]));if(o){const e=o[1];if(e.track._originMediaStreamTrack.stop(),!Db("DISABLE_DUAL_STREAM_USE_ENCODING")&&mR().supportDualStreamEncoding){const i=t._mediaStreamTrack.clone();e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i}else{const i=$P(t,SE(this,fC.RequestLowStreamParameter));e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i}await new e_(((t,i)=>{this.handleReplaceTrack(e.track,t,i,!0)}))}await this.connection.unmuteLocal(s.map((t=>{let[,{id:e}]=t;return e})));const r=this.createUnmuteMessage(s);await _E(this,fC.RequestUnmuteLocal,r),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleUpdateVideoEncoder",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(mC.LocalVideoTrack);if(!this.connection||!i||i.track!==t||this.state!==gC.Connected)return void e();const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),await this.connection.updateEncoderConfig(s,o),this.emit(fC.UpdateVideoEncoder,o),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleSetOptimizationMode",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const i=this.localTrackMap.get(mC.LocalVideoTrack);if(!this.connection||!i||i.track!==t||this.state!==gC.Connected)return;const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleReplaceTrack",(async(t,e,i,n)=>{let s;$b.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(t.getTrackId(),"]")),"boolean"==typeof n&&n||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var o;const i=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(!this.connection||!i||this.state!==gC.Connected)return void e();if(await(null===(o=this.connection)||void 0===o?void 0:o.replaceTrack(t,i[1].id)),this.isPlanB){const e=i[1];e.id=t._mediaStreamTrack.id,this.localTrackMap.set(i[0],e)}if(i[0]===mC.LocalVideoTrack&&!Db("DISABLE_DUAL_STREAM_USE_ENCODING")&&mR().supportDualStreamEncoding){const e=this.localTrackMap.get(mC.LocalVideoLowTrack);if(e){const i=t._mediaStreamTrack.clone();e.track._originMediaStreamTrack.stop(),e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i,await new e_(((t,i)=>{this.handleReplaceTrack(e.track,t,i,!0)}))}}e()}catch(t){i(t)}finally{var r;null===(r=s)||void 0===r||r()}})),nu(this,"handleGetRTCStats",(t=>{t(this.statsCollector.getRTCStats())})),nu(this,"handleGetLocalVideoStats",(t=>{t(this.statsCollector.getLocalVideoTrackStats())})),nu(this,"handleGetLocalAudioStats",(t=>{t(this.statsCollector.getLocalAudioTrackStats())})),nu(this,"handleGetRemoteVideoStats",(t=>this.statsCollector.getRemoteVideoTrackStats(t.uid)[t.uid])),nu(this,"handleGetRemoteAudioStats",(t=>this.statsCollector.getRemoteAudioTrackStats(t.uid)[t.uid])),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new dD,this.bindStatsUploaderEvents(),this.isPlanB=!mR().supportUnifiedPlan||Db("CHROME_FORCE_PLAN_B")&&D_(),this.shouldForwardP2PCreation=Db("FORWARD_P2P_CREATION")&&mR().supportPCSetConfiguration&&function(){const t=m_();return t===a_.ANDROID||t===a_.IOS||t===a_.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new oD({},this.store):this.isPlanB?new MP({},this.store):new GP({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){var i;this.state=gC.New;const n=this.shouldForwardP2PCreation&&"closed"===(null===(i=this.connection)||void 0===i?void 0:i.peerConnectionState);if(this.shouldForwardP2PCreation&&!n||(n&&this.connection&&($b.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new oD(t,this.store):this.isPlanB?new MP(t,this.store):new GP(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new V_(U_.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=Db("NEW_ICE_RESTART")?pC.FIRST_CONNECTION:pC.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,e,i,n,s,o){if(!this.connection)throw new V_(U_.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof oD?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(t,e,i,n,s,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=gC.Connected)}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter((t=>{var e;let[i]=t;return Ps(e=[mC.LocalVideoLowTrack,mC.LocalVideoTrack]).call(e,i)})).map((t=>{let[,{id:e}]=t;return e}));if(this.connection instanceof GP){if(!Ps(t).call(t,this.store.codec)){const e=["vp8","h264"].find((e=>Ps(t).call(t,e)));e&&(this.store.codec=e,$b.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(e,".")))}this.connection.updateRemoteRTPCapabilities(e,t)}}async preConnect(t,e,i,n,s,o){if(!this.connection)throw new V_(U_.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const r=await this.connection.connect(t,e,i,n,s,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=gC.Connected,r}getEstablishParams(){if(this.connection instanceof oD)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(t){if(!this.connection){if(this.state===gC.Disconnected)throw new V_(U_.UNEXPECTED_ERROR,"PeerConnection already disconnected.");const e=t.filter((t=>-1!==this.pendingLocalDataChannels.findIndex((e=>e.id===t.id))));return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(e))}const e=this.filterTobePublishedDataChannels(t);0!==e.length&&(e.forEach((t=>{const e=Date.now();this.store.publish(t.id.toString(),"datachannel",e)})),await this.connection.createDataChannels(this.store.uid,e),e.forEach((t=>{this.localDataChannels.push(t);const e=Date.now();this.store.publish(t.id+"","datachannel",void 0,e)})))}publish(t,e,i){var n=this;return BL((function*(){const s=yield jL(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==gC.Connected){if(n.state===gC.Disconnected)throw new V_(U_.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(t);const e=t.filter((t=>-1===n.pendingLocalTracks.indexOf(t)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(e))}n.store.pubId=n.store.pubId+1,ck.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(t,e,i);if(0===o.length)return void(yield jL(n.tryToUnmuteAudio(t)));yield*HL(uD(n.doPublish(n.connection,o)))}finally{s()}}))()}doPublish(t,e){var i=this;return BL((function*(){e.forEach((t=>{let{track:e,type:n}=t;const s=Date.now();i.store.publish(e.getTrackId(),n===mC.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(e);const n=yield jL(t.send(e.map((t=>{let{track:e}=t;return e})),i.store.codec,i.store.audioCodec)),s=(yield jL(n.next())).value,o=i.createGatewayPublishMessage(e,s);let r;try{r=yield o}catch(t){throw n.throw(t),(null==t?void 0:t.code)===U_.WS_ABORT&&e.forEach((t=>{let{track:e}=t;-1===i.pendingLocalTracks.indexOf(e)&&i.pendingLocalTracks.push(e)})),i.unbindLocalTrackEvents(e),t}const a=i.mapPubResToRemoteConfig(o,r),c=(yield jL(n.next(a))).value;e.forEach((t=>{let{type:e}=t;i.statsCollector.addLocalStats(e)})),i.assignLocalTracks(e,c),i.statsUploader.startUploadUplinkStats(),e.forEach((t=>{let{track:e,type:n}=t;const s=Date.now();i.store.publish(e.getTrackId(),n===mC.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}async updateVideoStreamParameter(t,e){const i=this.localTrackMap.get(e);if(!i)return;if(!(i.track instanceof SI))return $b.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof GP||this.connection instanceof MP))return $b.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:n}=i,s=function(t,e){const i={};return t.height&&t.width&&(i.scaleResolutionDownBy=bk(t,e)),i.maxFramerate=t.framerate?fk(t.framerate):void 0,i.maxBitrate=t.bitrate?1e3*t.bitrate:void 0,i}(t,n);if(n._encoderConfig||(n._encoderConfig={}),e!==mC.LocalVideoLowTrack||!Db("DISABLE_DUAL_STREAM_USE_ENCODING")&&mR().supportDualStreamEncoding)null!=s.scaleResolutionDownBy&&(n._encoderConfig.scaleResolutionDownBy=s.scaleResolutionDownBy);else{const e=n._originMediaStreamTrack;if(!e.canvas)return $b.warn("[".concat(n.getTrackId(),"] no canvas on track"));!function(t,e){const i=t.canvas;e.width&&(i.width=fk(e.width)),e.height&&(i.height=fk(e.height)),e.framerate&&(i.stopCapture&&i.stopCapture(),i.stopCapture=uR((()=>{!i.startCapture&&i.stopCapture&&i.stopCapture(),i.startCapture&&i.startCapture()}),fk(e.framerate)))}(e,t)}null!=s.maxBitrate&&(n._encoderConfig.bitrateMax=s.maxBitrate/1e3),null!=s.maxFramerate&&(n._encoderConfig.frameRate&&"object"==typeof n._encoderConfig.frameRate?n._encoderConfig.frameRate.max=s.maxFramerate:n._encoderConfig.frameRate={max:s.maxFramerate}),$b.debug("[".concat(n.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(n._encoderConfig))),await this.connection.updateRtpSenderEncodings(n)}publishLowStream(t){var e=this;return BL((function*(){if(!e.connection||e.state!==gC.Connected)return;const i=yield jL(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const s=e.localTrackMap.get(mC.LocalVideoTrack);if(!s)throw new V_(U_.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(mC.LocalVideoLowTrack))throw new V_(U_.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(s.track,t),type:mC.LocalVideoLowTrack}];if(yield*HL(uD(e.doPublish(e.connection,o))),s.track.muted||!s.track.enabled){var n;const t=null===(n=e.localTrackMap.get(mC.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==t&&(yield jL(e.connection.muteLocal([t])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&($b.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await vE(this,fC.RequestRePublish,this.pendingLocalTracks),this.emit(fC.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&($b.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await vE(this,fC.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(t){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:e,kind:i}=this.pendingRemoteTracks[t];(i!==hC.AUDIO||e._audio_added_&&e._audioSSRC)&&(i!==hC.VIDEO||e._video_added_&&e._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(t)await vE(this,fC.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:e}of this.pendingRemoteTracks)await this.subscribe(t,e,e===hC.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach((t=>{let{user:e}=t;this.emit(fC.MediaReconnectEnd,e.uid)})),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==gC.Connected)return void t.forEach((t=>{const e=this.pendingLocalTracks.indexOf(t);-1!==e&&this.pendingLocalTracks.splice(e,1)}));const e=this.filterTobeUnpublishedTracks(t);if(0===e.length)return;const i=e.find((t=>"videoLowTrack"===t[0]));return i&&i[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==gC.Connected)return void t.forEach((t=>{const e=this.pendingLocalDataChannels.indexOf(t);-1!==e&&this.pendingLocalDataChannels.splice(e,1)}));const e=this.filterTobeUnpublishedDataChannels(t);return 0!==e.length?(e.forEach((t=>{const e=this.localDataChannels.indexOf(t);-1!==e&&this.localDataChannels.splice(e,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),e.map((t=>t.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==gC.Connected)return;const t=this.localTrackMap.get(mC.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[mC.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const i=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map((t=>{let[,{id:e}]=t;return e}))),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map((t=>{let[e,{track:i}]=t;return{type:e,track:i}}))),e.forEach((t=>{let[e]=t;this.statsCollector.removeLocalStats(e)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadUplinkStats(),i}async subscribeDataChannel(t,e){if(!this.connection||this.state!==gC.Connected)throw new V_(U_.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=e.filter((e=>{var i;return!(null!==(i=this.remoteDataChannelMap.get(t))&&void 0!==i&&i.get(e.id))}));if(0!==i.length)return await this.connection.createDataChannels(t.uid,i),i.forEach((e=>{var i;this.remoteDataChannelMap.has(t)?null===(i=this.remoteDataChannelMap.get(t))||void 0===i||i.set(e.id,e):this.remoteDataChannelMap.set(t,new Map([[e.id,e]]));const n=this.pendingRemoteDataChannels.findIndex((i=>{let{user:n,id:s}=i;return n.uid===t.uid&&s===e.id}));-1!==n&&this.pendingRemoteDataChannels.splice(n,1)})),i.map((t=>t.id))}async subscribe(t,e,i,n,s){var o;if(!this.connection||this.state!==gC.Connected)throw new V_(U_.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(o=this.remoteUserMap.get(t))&&void 0!==o&&o.has(e))return;let r,a,c;if(s){const i=s.find((t=>{let{stream_type:i}=t;return i===e}));if(!i)throw new V_(U_.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const n=await this.connection.receive(e,i.ssrcs,String(t._uintid),i.attributes);this.connection instanceof GP&&(c=n.transceiver),r=n.track,a=n.id}else{const s=await this.connection.receive(e,[{ssrcId:i,rtx:n}],String(t._uintid),void 0);this.connection instanceof GP&&(c=s.transceiver),r=s.track,a=s.id}e===hC.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(r):(t._audioTrack=new OI(r,t.uid,t._uintid,this.store),$b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(r):(t._videoTrack=new AI(r,t.uid,t._uintid,this.store),$b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack));const d=this.remoteUserMap.get(t);d?d.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadDownlinkStats();const l=this.pendingRemoteTracks.findIndex((i=>{let{user:n,kind:s}=i;return n.uid===t.uid&&e===s}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(fC.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==gC.Connected)throw new V_(U_.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter((t=>{var e;let{user:i,mediaType:n}=t;return!(null!==(e=this.remoteUserMap.get(i))&&void 0!==e&&e.has(n))}));const e=await this.connection.batchReceive(t.map((t=>{let{user:e,mediaType:i,ssrcId:n,rtxSsrcId:s}=t;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(e._uintid)}})));t.forEach(((t,i)=>{let{user:n,mediaType:s}=t;const{track:o,id:r,transceiver:a}=e[i];s===hC.AUDIO?(n._audioTrack?n._audioTrack._updateOriginMediaStreamTrack(o):(n._audioTrack=new OI(o,n.uid,n._uintid,this.store),$b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(n._audioTrack.getTrackId()))),a&&n._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._audioTrack)):(n._videoTrack?n._videoTrack._updateOriginMediaStreamTrack(o):(n._videoTrack=new AI(o,n.uid,n._uintid,this.store),$b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(n._videoTrack.getTrackId()))),a&&n._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._videoTrack));const c=this.remoteUserMap.get(n);c?c.set(s,r):this.remoteUserMap.set(n,new Map([[s,r]])),this.statsCollector.addRemoteStats(n.uid),this.statsUploader.startUploadDownlinkStats();const d=this.pendingRemoteTracks.findIndex((t=>{let{user:e,kind:i}=t;return e.uid===n.uid&&s===i}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(fC.MediaReconnectEnd,n.uid))}))}async unsubscribe(t,e,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==e?n.uid===t.uid&&e===s:n.uid===t.uid}));if(n.forEach((t=>{const e=this.pendingRemoteTracks.indexOf(t);this.pendingRemoteTracks.splice(e,1)})),this.connection&&this.state===gC.Connected||i||n.forEach((e=>{let{kind:i}=e;var n;if(i===hC.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===hC.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}})),!this.connection||this.state!==gC.Connected)return;const s=this.filterTobeUnSubscribedTracks(t,e);if(0===s.length)return;await this.connection.stopReceiving(s.map((t=>{let[,{id:e}]=t;return e})));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),s.forEach((t=>{let[e,{kind:n}]=t;var s,o;if(n===hC.VIDEO&&e._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(e._videoSSRC,!1)),n===hC.VIDEO)this.unbindRemoteTrackEvents(e._videoTrack),i||(null===(o=e._videoTrack)||void 0===o||o._destroy(),e._videoTrack=void 0);else if(n===hC.AUDIO){var r;this.unbindRemoteTrackEvents(e._audioTrack),i||(null===(r=e._audioTrack)||void 0===r||r._destroy(),e._audioTrack=void 0)}})),o}async unsubscribeDataChannel(t,e){if(e.forEach((t=>{const e=this.pendingRemoteDataChannels.findIndex((e=>e.id===t.id));-1!==e&&this.pendingRemoteDataChannels.splice(e,1)})),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(t,e);if(0===i.length)return;e.forEach((t=>{t._close()}));const n=this.remoteDataChannelMap.get(t);return i.forEach((t=>{n&&n.delete(t.id)})),n&&0===n.size&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),i.map((t=>t.id))}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:i,mediaType:n}of t){const t=this.pendingRemoteTracks.filter((t=>{let{user:e,kind:s}=t;return void 0!==n?e.uid===i.uid&&n===s:e.uid===i.uid}));t.forEach((t=>{const e=this.pendingRemoteTracks.indexOf(t);this.pendingRemoteTracks.splice(e,1)})),e=e.concat(t)}if(!this.connection||this.state!==gC.Connected)return void e.forEach((t=>{let{user:e,kind:i}=t;var n;if(i===hC.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===hC.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}}));const i=cS(t).call(t,((t,e)=>{let{user:i,mediaType:n}=e;const s=this.filterTobeUnSubscribedTracks(i,n);return t.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((t=>{let[,{id:e}]=t;return e})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),i.forEach((t=>{let[e,{kind:i}]=t;var n,s;if(i===hC.VIDEO&&e._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(e._videoSSRC,!1)),i===hC.VIDEO)this.unbindRemoteTrackEvents(e._videoTrack),null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0;else if(i===hC.AUDIO){var o;this.unbindRemoteTrackEvents(e._audioTrack),null===(o=e._audioTrack)||void 0===o||o._destroy(),e._audioTrack=void 0}})),n}async muteRemote(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void $b.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void $b.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const n=e===hC.VIDEO?t._videoSSRC:t._audioSSRC;void 0!==n&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);i?i.get(e)||$b.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,".")):$b.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."))}getAllTracks(t){const e=this.localTrackMap.get(mC.LocalAudioTrack);if((null==e?void 0:e.track)instanceof eI){const i=e.track;return Array.from(this.localTrackMap.entries()).filter((t=>{let[e]=t;return e!==mC.LocalAudioTrack})).filter((e=>{let[i]=e;return!(t&&i===mC.LocalVideoLowTrack)})).map((t=>{let[,{track:e}]=t;return e})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((e=>{let[i]=e;return!(t&&i===mC.LocalVideoLowTrack)})).map((t=>{let[,{track:e}]=t;return e}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,i,n,s){if(t){const i=this.localTrackMap.get(mC.LocalAudioTrack),o=n?this.localTrackMap.get(mC.LocalVideoLowTrack):this.localTrackMap.get(mC.LocalVideoTrack);sy.publish(this.store.sessionId,{eventElapse:ck.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:null==i?void 0:i.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(Dw.SCREEN_TRACK)),audio:!!i,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var o;i||(i=[]);const r=i.find((t=>t instanceof ZR)),a=n?null===(o=this.localTrackMap.get(mC.LocalVideoTrack))||void 0===o?void 0:o.track:i.find((t=>t instanceof SI));sy.publish(this.store.sessionId,{eventElapse:ck.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(Dw.SCREEN_TRACK)),audio:!!r,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(t,e,i,n){const s=n===hC.VIDEO?i._videoSSRC:i._audioSSRC;s&&sy.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===hC.VIDEO,audio:n===hC.AUDIO,peerid:i.uid,subscribeRequestid:n===hC.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:ck.measureFromSubscribeStart(this.store.clientId,s)})}reset(){$b.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new zE("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new oD({},this.store):this.isPlanB?new MP({},this.store):new GP({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(mC.LocalAudioTrack);if((null==t?void 0:t.track)instanceof eI){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach((t=>{e.removeAudioTrack(t)}))}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=gC.Disconnected}getStats(){var t;return null===(t=this.connection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return(null===(e=this.connection)||void 0===e?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(mC.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(mC.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof SI||e&&e.track instanceof ZR?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e.uid===t));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map((t=>{let[e]=t;return{uid:e.uid,level:e.audioTrack?100*e.audioTrack._source.getAccurateVolumeLevel():0}}));const e=this.localTrackMap.get(mC.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Zu(t).call(t,((t,e)=>t.level-e.level)),t}async disconnectForReconnect(){this.connection&&($b.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=gC.Reconnecting,Db("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&(null===(i=e._videoTrack._player.getVideoElement())||void 0===i||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new oD({},this.store):this.isPlanB?new MP({},this.store):new GP({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((t=>{var e;let[i,{track:n}]=t;switch(i){case mC.LocalVideoTrack:Ps(e=n._hints).call(e,Dw.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case mC.LocalAudioTrack:n instanceof eI?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case mC.LocalVideoLowTrack:}})),this.emit(fC.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,i]=t;Array.from(hu(i).call(i)).forEach((t=>{this.setPendingRemoteMedia(e,t)})),this.emit(fC.MediaReconnectStart,e.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((t=>{this.pendingLocalDataChannels.push(t)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((t=>{let[e,i]=t;Array.from(hu(i).call(i)).forEach((t=>{this.setPendingRemoteDataChannel(e,t)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),$b.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(const i of this.pendingRemoteDataChannels){const{user:n,id:s}=i;if((t instanceof NL?t.uid:t)===n.uid&&s===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((t instanceof NL?t.uid:t)===n.uid&&e===s)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return BL((function*(){if(!e.connection||e.state!==gC.Connected||e.connection instanceof oD)return;const i=yield jL(e.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield jL(e.connection.restartICE(t));const s=yield jL(n.next());if(s.done)return;const o=s.value,r=yield o;switch(e.reportPCDisconnectedOrFailed(t),t){case uC.TCP:e._pcStatsUploadType=pC.TCP_RESTART;break;case uC.RELAY:e._pcStatsUploadType=pC.RELAY_RESTART;break;default:e._pcStatsUploadType=pC.OLD_RESTART}e._isInRestartIce=!0,n.next(r)}catch(t){var s;null===(s=n)||void 0===s||s.throw(t)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(mC.LocalVideoTrack),i=this.localTrackMap.get(mC.LocalAudioTrack),n=t.videoSend.find((t=>t.ssrc===(null==e?void 0:e.ssrcs[0].ssrcId))),s=t.audioSend.find((t=>t.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const o=EE(this,fC.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==e?void 0:e.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(Dw.SCREEN_TRACK)){const e=u._encoderConfig.bitrateMax,i=t.bitrate.actualEncoded;if(e&&i){const t=(1e3*e-i)/(1e3*e);return ay[t<.15?0:t<.3?1:t<.45?2:t<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=t.audioRecv.find((t=>t.ssrc===s)),a=t.videoRecv.find((t=>t.ssrc===o));if(!r&&!a)return void(e+=1);const c=EE(this,fC.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=t.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new e_(((e,i)=>{this.handleMuteLocalTrack(t,e,i)}))}filterTobePublishedTracks(t,e,i){const n=[],s=mR(),o=this.getAllTracks();t=wE(t=t.filter((t=>-1===o.indexOf(t))));let r=!1,a=!1;for(const o of t){if(o instanceof SI&&(this.localTrackMap.has(mC.LocalVideoTrack)||r?new V_(U_.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:mC.LocalVideoTrack}),r=!0),e)){const t=this.getLowVideoTrack(o,i);n.push({track:t,type:mC.LocalVideoLowTrack})}if(o instanceof ZR){const t=this.localTrackMap.get(mC.LocalAudioTrack);if(t){if(!(t.track instanceof eI))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");t.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const t=n.find((t=>{let{type:e}=t;return e===mC.LocalAudioTrack}));if(!(t.track instanceof eI))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");t.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof eI||o._bypassWebAudio)n.push({track:o,type:mC.LocalAudioTrack});else{const t=new eI;t.addAudioTrack(o),n.push({track:t,type:mC.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=wE(t=t.filter((t=>-1!==i.indexOf(t))));for(const i of t){if(i instanceof ZR){const t=this.localTrackMap.get(mC.LocalAudioTrack);if(!t)continue;t.track instanceof eI?(t.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===t.track.trackList.length&&(e.push([mC.LocalAudioTrack,t]),t.track.close())):e.push([mC.LocalAudioTrack,t])}if(i instanceof SI){const t=this.localTrackMap.get(mC.LocalVideoTrack);if(!t)continue;e.push([mC.LocalVideoTrack,t]);const i=this.localTrackMap.get(mC.LocalVideoLowTrack);i&&e.push([mC.LocalVideoLowTrack,i])}}return e}filterTobePublishedDataChannels(t){return(t=wE(t)).filter((t=>-1===this.localDataChannels.findIndex((e=>e.id===t.id))))}filterTobeUnpublishedDataChannels(t){return(t=(t=wE(t)).filter((t=>-1!==this.localDataChannels.indexOf(t)))).filter((t=>t._originDataChannel))}bindLocalTrackEvents(t){t.forEach((t=>{let{track:e,type:i}=t;switch(i){case mC.LocalVideoTrack:e.addListener(Pw.GET_STATS,this.handleGetLocalVideoStats),e.addListener(Pw.GET_RTC_STATS,this.handleGetRTCStats),e.addListener(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Pw.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),e.addListener(Pw.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),e.addListener(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case mC.LocalAudioTrack:this.bindLocalAudioTrackEvents(e);case mC.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(t,e){t instanceof eI?t.trackList.forEach((t=>{t.addListener(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Pw.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.addListener(Pw.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map((t=>{let[e,{track:i}]=t;return{track:i,type:e}}))),t.forEach((t=>{let{track:e,type:i}=t;switch(i){case mC.LocalVideoTrack:e.off(Pw.GET_STATS,this.handleGetLocalVideoStats),e.off(Pw.GET_RTC_STATS,this.handleGetRTCStats),e.off(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Pw.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),e.off(Pw.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),e.off(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case mC.LocalAudioTrack:this.unbindLocalAudioTrackEvents(e);case mC.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(t){t instanceof eI?t.trackList.forEach((t=>{t.off(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Pw.GET_STATS,this.handleGetLocalAudioStats),t.off(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.off(Pw.GET_STATS,this.handleGetLocalAudioStats),t.off(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof AI&&e.addListener(Pw.GET_STATS,(e=>{e(this.handleGetRemoteVideoStats(t))})),e instanceof OI&&e.addListener(Pw.GET_STATS,(e=>{e(this.handleGetRemoteAudioStats(t))}))}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Pw.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,i]=t;i.has(hC.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(hC.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)}))}createGatewayPublishMessage(t,e){return t.map(((t,i)=>{var n;let s,o,{track:r,type:a}=t;switch(a){case mC.LocalAudioTrack:s=Qy.Audio,o={dtx:r instanceof QR&&r._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case mC.LocalVideoTrack:s=Ps(n=r._hints).call(n,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High,o=hD(hD({},vk(r)),{},{codec:this.store.codec});break;case mC.LocalVideoLowTrack:s=Qy.Low,o=hD(hD({},vk(r)),{},{codec:this.store.codec})}return{stream_type:s,attributes:o,ssrcs:e[i]}}))}createGatewayUnpublishMessage(t){return t.map((t=>{var e;let i,[n,{track:s,ssrcs:o,id:r}]=t;switch(n){case mC.LocalVideoTrack:i=Ps(e=s._hints).call(e,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High;break;case mC.LocalAudioTrack:i=Qy.Audio;break;case mC.LocalVideoLowTrack:i=Qy.Low}return{stream_type:i,ssrcs:o,mid:r}}))}assignLocalTracks(t,e){t.forEach(((t,i)=>{let{track:n,type:s}=t;this.localTrackMap.set(s,{track:n,id:e[i].id,ssrcs:e[i].localSSRC})}))}withdrawLocalTracks(t){t.forEach((t=>{let[e]=t;this.localTrackMap.delete(e)}))}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if($b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(fC.PeerConnectionStateChange,e),"connected"!==e||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===e&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),Db("NEW_ICE_RESTART")){var i;if(Ps(i=this._restartStates).call(i,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const e=e=>{"disconnected"!==t.iceConnectionState&&"checking"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||($b.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(e)),"CONNECTED"===EE(this,fC.QueryClientConnectionState)&&this.emit(fC.RequestRestartICE,e))},i=()=>{"disconnected"!==t.iceConnectionState&&"checking"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),$b.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(fC.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},n=Db("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(Db("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&mR().supportPCSetConfiguration)e(uC.RELAY),this._restartTimer=window.setTimeout(i,n);else if(T_())e(uC.UDP),this._restartTimer=window.setTimeout(i,4e3);else{if(e(uC.TCP),mR().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{e(uC.RELAY),this._restartTimer=window.setTimeout(i,n)}),n));this._restartTimer=window.setTimeout(i,n)}}),800))}}else{if("disconnected"===e&&"disconnected"===t.iceConnectionState)return setTimeout((()=>{"disconnected"===t.iceConnectionState&&Db("ICE_RESTART")&&"CONNECTED"===EE(this,fC.QueryClientConnectionState)&&this.emit(fC.RequestRestartICE)}),800),void setTimeout((()=>{"disconnected"===t.peerConnectionState&&($b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(fC.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===e&&($b.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(fC.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=t=>{"connected"!==t||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),sy.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:rE.TRACER}).onSuccess(),this.emit(fC.IceConnectionStateChange,t)},t.onICETransportStateChange=t=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},t.onDTLSTransportStateChange=t=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},t.onDTLSTransportError=t=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},t.onFirstAudioDecoded=t=>{var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e._audioSSRC===t));var n;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),null===(n=i.audioTrack)||void 0===n||n.emit(Bw.FIRST_FRAME_DECODED),sy.firstRemoteFrame(this.store.sessionId,Jb.FIRST_AUDIO_DECODE,Xb.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=t=>{var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e._audioSSRC===t));i&&sy.firstRemoteFrame(this.store.sessionId,Jb.FIRST_AUDIO_RECEIVED,Xb.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(t,e,i)=>{this.reportVideoFirstFrameDecoded(t,e,i)},t.onFirstVideoReceived=t=>{var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e._videoSSRC===t));i&&sy.firstRemoteFrame(this.store.sessionId,Jb.FIRST_VIDEO_RECEIVED,Xb.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(t,e)=>{const i="relay"===t.candidateType,n="relay"===e.candidateType;"unknown"!==e.candidateType&&i===n||this.emit(fC.ConnectionTypeChange,i),$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(yk(e))," -> ").concat(JSON.stringify(yk(t)),")"))},t.onSelectedRemoteCandidateChanged=(t,e)=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(yk(e))," -> ").concat(JSON.stringify(yk(t)),")"))},t.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(t){const e=[];if(-1===this.getAllTracks().indexOf(t))return e;const i=this.localTrackMap.get(mC.LocalAudioTrack);if(t instanceof ZR&&(null==i?void 0:i.track)instanceof eI)return i.track.isActive||e.push([mC.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n&&(e.push(n),n[0]===mC.LocalVideoTrack)){const t=this.localTrackMap.get(mC.LocalVideoLowTrack);t&&e.push([mC.LocalVideoLowTrack,t])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(mC.LocalAudioTrack);if(t instanceof ZR&&(null==i?void 0:i.track)instanceof eI)return i.track.isActive&&e.push([mC.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n)if(n[0]===mC.LocalVideoTrack){e.push(n);const t=this.localTrackMap.get(mC.LocalVideoLowTrack);t&&e.push([mC.LocalVideoLowTrack,t])}else e.push(n);return e}createMuteMessage(t){return t.map((t=>{var e;let i,[n,{track:s,ssrcs:o,id:r}]=t;switch(n){case mC.LocalAudioTrack:i=Qy.Audio;break;case mC.LocalVideoTrack:i=Ps(e=s._hints).call(e,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High;break;case mC.LocalVideoLowTrack:i=Qy.Low}return{stream_type:i,ssrcs:o,mid:r}}))}createUnmuteMessage(t){return t.map((t=>{var e;let i,[n,{track:s,ssrcs:o,id:r}]=t;switch(n){case mC.LocalAudioTrack:i=Qy.Audio;break;case mC.LocalVideoTrack:i=Ps(e=s._hints).call(e,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High;break;case mC.LocalVideoLowTrack:i=Qy.Low}return{stream_type:i,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(t,e){const i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){const s=n.get(e);if(!s)return i;i.push([t,{kind:e,id:s}])}else Array.from(n.entries()).forEach((e=>{let[n,s]=e;i.push([t,{kind:n,id:s}])}));return i}filterTobeUnSubscribedDataChannels(t,e){const i=[];return e.forEach((e=>{var n;null!==(n=this.remoteDataChannelMap.get(t))&&void 0!==n&&n.has(e.id)&&i.push(e)})),i}createUnsubscribeMessage(t){const e=[];return t.forEach((t=>{let[i,{kind:n,id:s}]=t;switch(n){case hC.VIDEO:return void(i._videoSSRC&&e.push({stream_type:hC.VIDEO,ssrcId:i._videoSSRC}));case hC.AUDIO:return void(i._audioSSRC&&e.push({stream_type:hC.AUDIO,ssrcId:i._audioSSRC}))}})),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach((t=>{let[i,{kind:n}]=t;if(e.has(i)){let t=e.get(i);n===hC.VIDEO?t|=iC.Video:t|=iC.Audio,e.set(i,t)}else n===hC.VIDEO?e.set(i,iC.Video):e.set(i,iC.Audio)})),{users:Array.from(e.entries()).map((t=>{let[e,i]=t;return{stream_id:e.uid,stream_type:i}}))}}withdrawRemoteTracks(t){t.forEach((t=>{let[e,{kind:i}]=t;const n=this.remoteUserMap.get(e);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(e))}))}async updateBitrateLimit(t){const e=this.localTrackMap.get(mC.LocalVideoTrack),i=this.localTrackMap.get(mC.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),i&&t.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(t,e){return t.map(((t,i)=>{var n;let{stream_type:s}=t;return null===(n=e.find((t=>{let{stream_type:e}=t;return s===e})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(t){for(let i=0;i<t.length;i++)if(t[i]instanceof ZR){var e;const n=this.filterTobeUnmutedTracks(t[i]);if(0===n.length)continue;await(null===(e=this.connection)||void 0===e?void 0:e.unmuteLocal(n.map((t=>{let[,{id:e}]=t;return e}))));const s=this.createUnmuteMessage(n);return void await _E(this,fC.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!(null===(e=this.connection)||void 0===e||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(fC.RequestUploadStats,t,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await xE(YE(this.dtlsFailedCount,KE)),this.emit(fC.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await vE(this,fC.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(fC.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(mC.LocalVideoTrack)||this.pendingLocalTracks.some((t=>t instanceof SI))}throwIfTrackTypeNotMatch(t){if(t.filter((t=>t instanceof SI)).length>1)throw new V_(U_.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter((t=>t instanceof ZR)).length>1&&(t.some((t=>t instanceof ZR&&t._bypassWebAudio))||!mR().webAudioMediaStreamDest))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof SI&&this.pendingLocalTracks.some((t=>t instanceof SI)))throw new V_(U_.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ZR&&this.pendingLocalTracks.some((t=>t instanceof ZR))&&(!mR().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some((t=>t instanceof ZR&&t._bypassWebAudio))))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const i=!Db("DISABLE_DUAL_STREAM_USE_ENCODING")&&mR().supportDualStreamEncoding,n=hD(hD({},{width:160,height:120,framerate:15,bitrate:50}),e);let s;s=i?t._mediaStreamTrack.clone():$P(t,n);const o=UE(8,"track-low-"),r=new SI(s,hD(hD({},i&&{scaleResolutionDownBy:bk(n,t)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on(Vw.TRANSCEIVER_UPDATED,(e=>{t._updateRtpTransceiver(e,Mw.LOW_STREAM)})),r._hints.push(Dw.LOW_STREAM),t.addListener(Pw.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof GP){var s,o,r,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:h}=this.connection,{local:u,remote:p}=await this.connection.getSelectedCandidatePair();sy.pcStats(this.store.sessionId,{startTime:c,eventElapse:t-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:h,intSucc:e?1:2,error:n,selectedLocalCandidateProtocol:null!==(s=null==u?void 0:u.protocol)&&void 0!==s?s:"",selectedLocalCandidateType:null!==(o=u.candidateType)&&void 0!==o?o:"",selectedLocalCandidateAddress:"".concat(u.address,":").concat(u.port),selectedRemoteCandidateProtocol:null!==(r=p.protocol)&&void 0!==r?r:"",selectedRemoteCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:i})}}reportVideoFirstFrameDecoded(t,e,i,n){var s;const o=Array.from(hu(s=this.remoteUserMap).call(s)).find((e=>e._videoSSRC===t));if(o){n||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,r=s.subscribe.find((t=>t.userId===o.uid&&"video"===t.type));sy.firstRemoteVideoDecode(this.store.sessionId,Jb.FIRST_VIDEO_DECODE,Xb.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(null==r?void 0:r.subscribeEnd)||0,subscriberStart:(null==r?void 0:r.subscribeStart)||0,videoAddNotify:(null==r?void 0:r.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(t);if(!n)return!1;const s=n.get(e);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(t){$b.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===gC.Connected?($b.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===nC.datachannel?new oD({},this.store):this.isPlanB?new MP({},this.store):new GP({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((t=>{let[e,{track:i}]=t;e===mC.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Mw.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof GP&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===pC.TCP_RESTART&&t===uC.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,pC.DISCONNECTED_OR_FAILED)))}}function gD(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function fD(t){let e=ID();return function(t,e){let i=t.appId;void 0!==i&&(jD(e,10),DD(e,i));let n=t.cid;void 0!==n&&(jD(e,16),jD(e,n));let s=t.cname;void 0!==s&&(jD(e,26),DD(e,s));let o=t.deviceId;void 0!==o&&(jD(e,34),DD(e,o));let r=t.elapse;void 0!==r&&(jD(e,40),HD(e,r));let a=t.fileSize;void 0!==a&&(jD(e,48),HD(e,wD(a)));let c=t.height;void 0!==c&&(jD(e,56),HD(e,wD(c)));let d=t.jpg;void 0!==d&&(jD(e,66),jD(e,d.length),function(t,e){let i=kD(t,e.length);t.bytes.set(e,i)}(e,d));let l=t.networkType;void 0!==l&&(jD(e,72),HD(e,wD(l)));let h=t.osType;void 0!==h&&(jD(e,80),HD(e,wD(h)));let u=t.requestId;void 0!==u&&(jD(e,90),DD(e,u));let p=t.sdkVersion;void 0!==p&&(jD(e,98),DD(e,p));let m=t.sequence;void 0!==m&&(jD(e,104),HD(e,wD(m)));let g=t.sid;void 0!==g&&(jD(e,114),DD(e,g));let f=t.timestamp;void 0!==f&&(jD(e,120),HD(e,f));let v=t.uid;void 0!==v&&(jD(e,128),jD(e,v));let _=t.vid;void 0!==_&&(jD(e,136),jD(e,_));let E=t.width;void 0!==E&&(jD(e,144),HD(e,wD(E)));let S=t.service;void 0!==S&&(jD(e,152),jD(e,S));let T=t.callbackData;void 0!==T&&(jD(e,162),DD(e,T));let b=t.jpgEncryption;void 0!==b&&(jD(e,168),jD(e,b));let y=t.requestType;void 0!==y&&(jD(e,176),jD(e,y));let C=t.scorePorn;void 0!==C&&(jD(e,185),FD(e,C));let w=t.scoreSexy;void 0!==w&&(jD(e,193),FD(e,w));let R=t.scoreNeutral;void 0!==R&&(jD(e,201),FD(e,R));let I=t.scene;void 0!==I&&(jD(e,208),jD(e,I));let A=t.ossFilePrefix;void 0!==A&&(jD(e,218),DD(e,A));let O=t.serviceVendor;if(void 0!==O)for(let t of O){jD(e,226);let i=ID();ED(t,i),jD(e,i.limit),MD(e,i),AD(i)}}(t,e),function(t){let e=t.bytes,i=t.limit;return e.length===i?e:e.subarray(0,i)}(e)}function vD(t){return function(t){let e={};t:for(;!ND(t);){let i=BD(t);switch(i>>>3){case 0:break t;case 1:e.code=BD(t);break;case 2:e.msg=PD(t,BD(t));break;case 3:{let i=SD(t);e.data=_D(t),t.limit=i;break}default:TD(t,7&i)}}return e}({bytes:e=t,offset:0,limit:e.length});var e}function _D(t){let e={};t:for(;!ND(t);){let i=BD(t);switch(i>>>3){case 0:break t;case 1:e.requestId=PD(t,BD(t));break;case 2:e.requestType=BD(t)>>>0;break;case 3:e.scorePorn=VD(t);break;case 4:e.scoreSexy=VD(t);break;case 5:e.scoreNeutral=VD(t);break;case 6:e.requestScene=BD(t)>>>0;break;case 7:e.scene=BD(t)>>>0;break;default:TD(t,7&i)}}return e}function ED(t,e){let i=t.service;void 0!==i&&(jD(e,8),jD(e,i));let n=t.vendor;void 0!==n&&(jD(e,16),jD(e,n));let s=t.token;void 0!==s&&(jD(e,26),DD(e,s));let o=t.callbackUrl;void 0!==o&&(jD(e,34),DD(e,o))}function SD(t){let e=BD(t),i=t.limit;return t.limit=t.offset+e,i}function TD(t,e){switch(e){case 0:for(;128&xD(t););break;case 2:OD(t,BD(t));break;case 5:OD(t,4);break;case 1:OD(t,8);break;default:throw new Error("Unimplemented type: "+e)}}My([gD,xy("design:type",Function),xy("design:paramtypes",[Object,Boolean]),xy("design:returntype",e_)],mD.prototype,"startP2PConnection",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Object,Object,Array,Object,String,String]),xy("design:returntype",e_)],mD.prototype,"connect",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",void 0)],mD.prototype,"updateRemoteRTPCapabilities",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Object,Object,Array,Object,String,String]),xy("design:returntype",e_)],mD.prototype,"preConnect",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],mD.prototype,"publishDataChannel",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],mD.prototype,"unpublish",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],mD.prototype,"unpublishDataChannel",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],mD.prototype,"unpublishLowStream",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,Array]),xy("design:returntype",e_)],mD.prototype,"subscribeDataChannel",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,String,Number,Number,Array]),xy("design:returntype",e_)],mD.prototype,"subscribe",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],mD.prototype,"massSubscribe",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,String,Boolean]),xy("design:returntype",e_)],mD.prototype,"unsubscribe",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,Array]),xy("design:returntype",e_)],mD.prototype,"unsubscribeDataChannel",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],mD.prototype,"massUnsubscribe",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,String]),xy("design:returntype",e_)],mD.prototype,"muteRemote",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,String]),xy("design:returntype",e_)],mD.prototype,"unmuteRemote",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,String]),xy("design:returntype",e_)],mD.prototype,"hasRemoteMediaWithLock",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],mD.prototype,"disconnectForReconnect",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],mD.prototype,"updateBitrateLimit",null),My([gD,xy("design:type",Function),xy("design:paramtypes",[NL,String,Number]),xy("design:returntype",e_)],mD.prototype,"remoteMediaSsrcChanged",null);let bD=new Float32Array(1);new Uint8Array(bD.buffer);let yD=new Float64Array(1),CD=new Uint8Array(yD.buffer);function wD(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let RD=[];function ID(){const t=RD.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function AD(t){RD.push(t)}function OD(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function ND(t){return t.offset>=t.limit}function kD(t,e){let i=t.bytes,n=t.offset,s=t.limit,o=n+e;if(o>i.length){let e=new Uint8Array(2*o);e.set(i),t.bytes=e}return t.offset=o,o>s&&(t.limit=o),n}function LD(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function PD(t,e){let i=LD(t,e),n=String.fromCharCode,s=t.bytes,o="�",r="";for(let t=0;t<e;t++){let a,c,d,l,h=s[t+i];0==(128&h)?r+=n(h):192==(224&h)?t+1>=e?r+=o:(a=s[t+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),t++))):224==(240&h)?t+2>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),t+=2))):240==(248&h)?t+3>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],d=s[t+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),t+=3))):r+=o}return r}function DD(t,e){let i=e.length,n=0;for(let t=0;t<i;t++){let s=e.charCodeAt(t);s>=55296&&s<=56319&&t+1<i&&(s=(s<<10)+e.charCodeAt(++t)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}jD(t,n);let s=kD(t,n),o=t.bytes;for(let t=0;t<i;t++){let n=e.charCodeAt(t);n>=55296&&n<=56319&&t+1<i&&(n=(n<<10)+e.charCodeAt(++t)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function MD(t,e){let i=kD(t,e.limit),n=t.bytes,s=e.bytes;for(let t=0,o=e.limit;t<o;t++)n[t+i]=s[t]}function xD(t){return t.bytes[LD(t,1)]}function UD(t,e){let i=kD(t,1);t.bytes[i]=e}function VD(t){let e=LD(t,8),i=t.bytes;return CD[0]=i[e++],CD[1]=i[e++],CD[2]=i[e++],CD[3]=i[e++],CD[4]=i[e++],CD[5]=i[e++],CD[6]=i[e++],CD[7]=i[e++],yD[0]}function FD(t,e){let i=kD(t,8),n=t.bytes;yD[0]=e,n[i++]=CD[0],n[i++]=CD[1],n[i++]=CD[2],n[i++]=CD[3],n[i++]=CD[4],n[i++]=CD[5],n[i++]=CD[6],n[i++]=CD[7]}function BD(t){let e,i=0,n=0;do{e=xD(t),i<32&&(n|=(127&e)<<i),i+=7}while(128&e);return n}function jD(t,e){for(e>>>=0;e>=128;)UD(t,127&e|128),e>>>=7;UD(t,e)}function HD(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,s=e.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=kD(t,o),a=t.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}function GD(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}const WD=new Map([["moderation",1],["supervise",2]]);class $D extends iE{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(SC.CONNECTION_STATE_CHANGE,e,t)}get inspectType(){return this._inspectType}set inspectType(t){var e;this._inspectMode=cS(e=t.map((t=>WD.get(t)||0))).call(e,((t,e)=>t+e)),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(t){super(),nu(this,"name","AgoraRTCVideoContentInspect"),nu(this,"_connectionState",_C.CONNECTING),nu(this,"_innerConnectionState",void 0),nu(this,"sequence",0),nu(this,"inspectStartTime",void 0),nu(this,"workerManagerConnection",void 0),nu(this,"workerConnection",void 0),nu(this,"workerMessageLengthLimit",void 0),nu(this,"inspectIntervalMinimum",void 0),nu(this,"qualityRatio",void 0),nu(this,"_connectInfo",void 0),nu(this,"_cancelTokenSource",gb.CancelToken.source()),nu(this,"_retryConfig",void 0),nu(this,"wmSequence",0),nu(this,"inspectInterval",void 0),nu(this,"inspectTimer",null),nu(this,"ossFilePrefix",void 0),nu(this,"extraInfo",void 0),nu(this,"_inspectType",void 0),nu(this,"_inspectMode",void 0),nu(this,"_quality",1),nu(this,"qualityTimer",null),nu(this,"_inspectId",void 0),nu(this,"_needWorkUrlOnly",!1),nu(this,"inspectImage",(()=>{if(this.connectionState!==_C.CONNECTED)throw new Uy(U_.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===_C.CONNECTED?this.requestToInspectImage():$b.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=UE(5,"inspect-"),this.workerMessageLengthLimit=Db("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=Db("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=Db("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new JC("worker-manager-"+this._inspectId,KE),this.on(SC.STATE_CHANGE,((t,e)=>{this._innerConnectionState=t,$b.debug("[".concat(this._inspectId,"] Inspect operation :").concat(EC[t]," ").concat(e||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new JC("worker-"+this._inspectId,KE),this.handleWorkerEvents()}async init(t,e){this.emit(SC.STATE_CHANGE,EC.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=e,new e_(((n,s)=>{this.on(SC.CONNECTION_STATE_CHANGE,((t,e)=>{e===_C.CONNECTED&&n()})),this.requestAP(t,i,e).then((t=>{this.connectWorkerManager(t)})).catch((t=>{s(t)}))}))}async requestAP(t,e,i){const n=Db("WEBCS_DOMAIN").map((t=>"https://".concat(t,"/api/v1"))),s=await function(t,e,i,n){let{appId:s,areaCode:o,cname:r,sid:a,token:c,uid:d}=e;rL++;const l="image_moderation_api",h={service_name:l,json_body:JSON.stringify({appId:s,areaCode:o,cname:r,command:"allocateEdge",requestId:rL,seq:rL,sid:a,token:c,ts:Date.now(),uid:d+""})};let u,p,m=t[0];return JE((async()=>{u=Date.now();const t=await Vk(m,{data:h,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-u,0!==t.code){const e=new Uy(U_.UNEXPECTED_RESPONSE,"image inspect ap error, code"+t.code,{retry:!0,responseTime:p});throw $b.error(e.toString()),e}const e=JSON.parse(t.json_body);if(200!==e.code){const t=new Uy(U_.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(e.code,", reason: ").concat(e.reason),{code:e.code,responseTime:p});throw $b.error(t.toString()),t}if(!e.servers||!Array.isArray(e.servers)||0===e.servers.length){const t=new Uy(U_.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:e.code,responseTime:p});throw $b.error(t.toString()),t}const n=Db("VIDEO_INSPECT_WORKER_MANAGER_HOST"),s=Db("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:e.servers.map((t=>{let{address:e,wss:i}=t;if(e&&i)return"wss://".concat(e.replace(/\./g,"-"),".").concat(n,":").concat(s||i)})).filter((t=>!!t)),workerToken:e.workerToken,vid:e.vid,responseTime:p}}),((e,i)=>(sy.apworkerEvent(a,{success:!0,sc:200,serviceName:l,responseDetail:JSON.stringify(e.addressList),firstSuccess:0===i,responseTime:p,serverIp:t[i%t.length]}),!1)),((e,i)=>(sy.apworkerEvent(a,{success:!1,sc:e.data&&e.data.code||200,serviceName:l,responseTime:p,serverIp:t[i%t.length]}),!!(e.code!==U_.OPERATION_ABORTED&&e.code!==U_.UNEXPECTED_RESPONSE||e.data&&e.data.retry)&&(m=t[(i+1)%t.length],!0))),n)}(n,t,e,i);this.emit(SC.STATE_CHANGE,EC.AP_CONNECTED);const{addressList:o}=s;return this.wmSequence++,o}async connectWorkerManager(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=e,this.emit(SC.STATE_CHANGE,EC.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Cy.CONNECTED,(async()=>{this.emit(SC.STATE_CHANGE,EC.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.19.3",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Cy.CLOSED,(()=>{this._innerConnectionState<EC.GET_WORKER_MANAGER_RESPONSE&&$b.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(Cy.FAILED,(()=>{this._innerConnectionState<EC.GET_WORKER_MANAGER_RESPONSE&&$b.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(Cy.RECONNECTING,(()=>{this._innerConnectionState<EC.GET_WORKER_MANAGER_RESPONSE&&$b.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(Cy.ON_MESSAGE,(async t=>{this.emit(SC.STATE_CHANGE,EC.GET_WORKER_MANAGER_RESPONSE);const e=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(t.data);if(200!==i.code)throw $b.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new Uy(U_.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&e))throw $b.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new Uy(U_.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const t=Db("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,n=e.replace(/:\d+\/?$/,":".concat(t));this.emit(SC.STATE_CHANGE,EC.CONNECT_WORKER,n),this._needWorkUrlOnly?this.emit(SC.REQUEST_NEW_WORKER_URL,n):await this.connectWorker(n)}})),this.workerManagerConnection.on(Cy.WILL_RECONNECT,((t,e,i)=>{i(t)})),this.workerManagerConnection.on(Cy.REQUEST_NEW_URLS,((t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)}))}handleWorkerEvents(){this.workerConnection.on(Cy.CONNECTED,(async()=>{this.emit(SC.STATE_CHANGE,EC.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=_C.CONNECTED})),this.workerConnection.on(Cy.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const i=vD(new Uint8Array(t.data));if(Db("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&$b.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),200===i.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(SC.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var e;const t={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},n=cS(e=Object.keys(t)).call(e,((e,i)=>t[e]>t[i]?e:i),"porn"),s=Object.keys(t).find((t=>t===n));this.emit(SC.INSPECT_RESULT,s)}else this.emit(SC.INSPECT_RESULT,void 0,new Uy(U_.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(SC.INSPECT_RESULT,void 0,new Uy(U_.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else $b.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(SC.INSPECT_RESULT,void 0,new Uy(U_.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Cy.CLOSED,(()=>{this.connectionState=_C.CLOSED})),this.workerConnection.on(Cy.FAILED,(()=>{this.connectionState=_C.CLOSED})),this.workerConnection.on(Cy.RECONNECTING,(()=>{this.connectionState=this.connectionState===_C.CONNECTED?_C.RECONNECTING:_C.CONNECTING})),this.workerConnection.on(Cy.WILL_RECONNECT,((t,e,i)=>{"recover"===t&&i(t),i("tryNext")})),this.workerConnection.on(Cy.REQUEST_NEW_URLS,((t,e)=>{this.workerManagerConnection.close(),this.once(SC.REQUEST_NEW_WORKER_URL,(e=>{t([e])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((t=>{this.connectWorkerManager(t,!0)})).catch((t=>{e(t)}))}))}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){this.sequence++;const t=EE(this,SC.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(SC.INSPECT_RESULT,void 0,new Uy(U_.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(t,e);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(SC.INSPECT_RESULT,void 0,new Uy(U_.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,e){let{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a}=e;const c=Date.now(),d=await t.getCurrentFrameImage("image/jpeg",this.quality),l=await vI(d,i,n),h=this.sequence+"-"+s+"-"+a+"-"+c+"-"+UE(12,""),u={appId:i,cid:s,cname:n,deviceId:"",elapse:$D.intToLong(Number(c-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:d.height,width:d.width,jpg:l,networkType:6,osType:7,requestId:h,sdkVersion:"4.19.3",sequence:this.sequence,sid:r,timestamp:$D.intToLong(c),uid:a,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete u.callbackData,void 0===this.ossFilePrefix&&delete u.ossFilePrefix;const p=fD(u);if(p.byteLength<this.workerMessageLengthLimit){if(Db("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const t=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?GD(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):GD(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},u);delete t.jpg,$b.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(t))}return p}{const e=this.quality*this.qualityRatio;return this.quality=e,await this.generateRequestData(t,{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=gb.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=_C.CLOSED,this.emit(SC.STATE_CHANGE,EC.CLOSED)}}function zD(t){let e=function(){const t=JD.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(t,e){let i=t.appId;void 0!==i&&(aM(e,10),nM(e,i));let n=t.cid;void 0!==n&&(aM(e,16),aM(e,n));let s=t.cname;void 0!==s&&(aM(e,26),nM(e,s));let o=t.deviceId;void 0!==o&&(aM(e,34),nM(e,o));let r=t.elapse;void 0!==r&&(aM(e,40),dM(e,r));let a=t.fileSize;void 0!==a&&(aM(e,48),dM(e,YD(a)));let c=t.height;void 0!==c&&(aM(e,56),dM(e,YD(c)));let d=t.jpg;void 0!==d&&(aM(e,66),aM(e,d.length),eM(e,d));let l=t.networkType;void 0!==l&&(aM(e,72),dM(e,YD(l)));let h=t.osType;void 0!==h&&(aM(e,80),dM(e,YD(h)));let u=t.requestId;void 0!==u&&(aM(e,90),nM(e,u));let p=t.sdkVersion;void 0!==p&&(aM(e,98),nM(e,p));let m=t.sequence;void 0!==m&&(aM(e,104),dM(e,YD(m)));let g=t.sid;void 0!==g&&(aM(e,114),nM(e,g));let f=t.timestamp;void 0!==f&&(aM(e,120),dM(e,f));let v=t.uid;void 0!==v&&(aM(e,128),aM(e,v));let _=t.vid;void 0!==_&&(aM(e,136),aM(e,_));let E=t.width;void 0!==E&&(aM(e,144),dM(e,YD(E)));let S=t.service;void 0!==S&&(aM(e,152),aM(e,S));let T=t.callbackData;void 0!==T&&(aM(e,162),aM(e,T.length),eM(e,T));let b=t.ticket;void 0!==b&&(aM(e,170),nM(e,b))}(t,e),function(t){let e=t.bytes,i=t.limit;return e.length===i?e:e.subarray(0,i)}(e)}function qD(t){return function(t){let e={};t:for(;!ZD(t);){let i=rM(t);switch(i>>>3){case 0:break t;case 1:e.code=rM(t);break;case 2:e.msg=iM(t,rM(t));break;case 3:e.requestId=iM(t,rM(t));break;case 4:e.timestamp=cM(t,!1);break;default:KD(t,7&i)}}return e}({bytes:e=t,offset:0,limit:e.length});var e}function KD(t,e){switch(e){case 0:for(;128&sM(t););break;case 2:XD(t,rM(t));break;case 5:XD(t,4);break;case 1:XD(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function YD(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let JD=[];function XD(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function ZD(t){return t.offset>=t.limit}function QD(t,e){let i=t.bytes,n=t.offset,s=t.limit,o=n+e;if(o>i.length){let e=new Uint8Array(2*o);e.set(i),t.bytes=e}return t.offset=o,o>s&&(t.limit=o),n}function tM(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function eM(t,e){let i=QD(t,e.length);t.bytes.set(e,i)}function iM(t,e){let i=tM(t,e),n=String.fromCharCode,s=t.bytes,o="�",r="";for(let t=0;t<e;t++){let a,c,d,l,h=s[t+i];0==(128&h)?r+=n(h):192==(224&h)?t+1>=e?r+=o:(a=s[t+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),t++))):224==(240&h)?t+2>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),t+=2))):240==(248&h)?t+3>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],d=s[t+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),t+=3))):r+=o}return r}function nM(t,e){let i=e.length,n=0;for(let t=0;t<i;t++){let s=e.charCodeAt(t);s>=55296&&s<=56319&&t+1<i&&(s=(s<<10)+e.charCodeAt(++t)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}aM(t,n);let s=QD(t,n),o=t.bytes;for(let t=0;t<i;t++){let n=e.charCodeAt(t);n>=55296&&n<=56319&&t+1<i&&(n=(n<<10)+e.charCodeAt(++t)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function sM(t){return t.bytes[tM(t,1)]}function oM(t,e){let i=QD(t,1);t.bytes[i]=e}function rM(t){let e,i=0,n=0;do{e=sM(t),i<32&&(n|=(127&e)<<i),i+=7}while(128&e);return n}function aM(t,e){for(e>>>=0;e>=128;)oM(t,127&e|128),e>>>=7;oM(t,e)}function cM(t,e){let i,n=0,s=0,o=0;return i=sM(t),n=127&i,128&i&&(i=sM(t),n|=(127&i)<<7,128&i&&(i=sM(t),n|=(127&i)<<14,128&i&&(i=sM(t),n|=(127&i)<<21,128&i&&(i=sM(t),s=127&i,128&i&&(i=sM(t),s|=(127&i)<<7,128&i&&(i=sM(t),s|=(127&i)<<14,128&i&&(i=sM(t),s|=(127&i)<<21,128&i&&(i=sM(t),o=127&i,128&i&&(i=sM(t),o|=(127&i)<<7))))))))),{low:n|s<<28,high:s>>>4|o<<24,unsigned:e}}function dM(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,s=e.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=QD(t,o),a=t.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}const lM={},hM={},uM=4294967296,pM=uM*uM,mM=pM/2,gM=SM(0,!0),fM=SM(0),vM=TM(0,-2147483648,!1),_M=TM(-1,2147483647,!1),EM=TM(-1,-1,!0);function SM(t,e){let i,n,s;return e?(s=0<=(t>>>=0)&&t<256)&&(n=hM[t],n)?n:(i=TM(t,0,!0),s&&(hM[t]=i),i):(s=-128<=(t|=0)&&t<128)&&(n=lM[t],n)?n:(i=TM(t,t<0?-1:0,!1),s&&(lM[t]=i),i)}function TM(t,e,i){return{low:0|t,high:0|e,unsigned:!!i}}function bM(t,e){if(isNaN(t))return e?gM:fM;if(e){if(t<0)return gM;if(t>=pM)return EM}else{if(t<=-mM)return vM;if(t+1>=mM)return _M}return t<0?e?gM:fM:TM(t%uM|0,t/uM|0,e)}function yM(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}class CM extends iE{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(RC.CONNECTION_STATE_CHANGE,t,e)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(t){var e;super(),nu(this,"name","AgoraRTCImageModeration"),nu(this,"_connectionState",wC.CONNECTING),nu(this,"_sequence",0),nu(this,"_moderationStartTime",void 0),nu(this,"_workerConnection",void 0),nu(this,"_workerMessageLengthLimit",void 0),nu(this,"_qualityRatio",void 0),nu(this,"_connectInfo",void 0),nu(this,"_cancelTokenSource",gb.CancelToken.source()),nu(this,"_retryConfig",void 0),nu(this,"_moderationInterval",void 0),nu(this,"_moderationTimer",null),nu(this,"_moderationMode",1),nu(this,"_quality",1),nu(this,"_qualityTimer",null),nu(this,"_ticket",void 0),nu(this,"_moderationIntervalMinimum",void 0),nu(this,"_uploadFailedNum",0),nu(this,"_uploadNum",0),nu(this,"_uploadTimer",null),nu(this,"_moderationId",void 0),nu(this,"inspectImage",(()=>{if(this.connectionState!==wC.CONNECTED)throw new Uy(U_.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===wC.CONNECTED?this.requestToInspectImage():$b.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=UE(5,"image-moderation-"),this._workerMessageLengthLimit=Db("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=Db("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(e=t.interval)&&void 0!==e?e:1e3,this._qualityRatio=Db("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new JC("worker-"+this._moderationId,KE),this.on(RC.STATE_CHANGE,((t,e)=>{$b.debug("[".concat(this._moderationId,"] Moderation operation :").concat(IC[t]," ").concat(e||""))})),this.handleWorkerEvents()}async init(t,e){this.emit(RC.STATE_CHANGE,IC.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=e,new e_(((n,s)=>{this.on(RC.CONNECTION_STATE_CHANGE,((t,e)=>{t===wC.CONNECTED&&n()})),this.requestAP(t,i,e).then((t=>{this.connectWorker(t)})).catch((t=>{s(t)}))}))}updateConfig(t){var e;this._moderationInterval=null!==(e=t.interval)&&void 0!==e?e:1e3,$b.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===wC.CONNECTED&&this.inspectImage()}async requestAP(t,e,i){const n=Db("WEBCS_DOMAIN").map((t=>"https://".concat(t,"/api/v1"))),s=await function(t,e,i,n){let{appId:s,areaCode:o,cname:r,sid:a,token:c,uid:d}=e;rL++;const l="moderation_plugin",h={service_name:l,json_body:JSON.stringify({appId:s,areaCode:o,cname:r,command:"allocateEdge",requestId:rL,seq:rL,sid:a,appToken:c,ts:Date.now(),uid:d+""})};let u,p,m=t[0];return JE((async()=>{u=Date.now();const t=await Vk(m,{data:h,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-u,0!==t.code){const e=new Uy(U_.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+t.code,{retry:!0,responseTime:p});throw $b.error(e.toString()),e}const e=JSON.parse(t.json_body);if(200!==e.code){const t=new Uy(U_.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(e.code,", reason: ").concat(e.reason),{code:e.code,responseTime:p});throw $b.error(t.toString()),t}if(!e.servers||!Array.isArray(e.servers)||0===e.servers.length){const t=new Uy(U_.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:e.code,responseTime:p});throw $b.error(t.toString()),t}if(!e.servers.some((t=>!!t.wss))){const t=new Uy(U_.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:e.code,responseTime:p});throw $b.error(t.toString()),t}const n=Db("IMAGE_MODERATION_WORKER_HOST");return{addressList:e.servers.map((t=>{let{address:e,wss:i}=t;if(e&&i)return"wss://".concat(e.replace(/\./g,"-"),".").concat(n,":").concat(i,"/moderation")})).filter((t=>!!t)),workerToken:e.workerToken,vid:e.vid,ticket:e.appTicket,responseTime:p}}),((e,i)=>(sy.apworkerEvent(a,{success:!0,sc:200,serviceName:l,responseDetail:JSON.stringify(e.addressList),firstSuccess:0===i,responseTime:p,serverIp:t[i%t.length]}),!1)),((e,i)=>(sy.apworkerEvent(a,{success:!1,sc:e.data&&e.data.code||200,serviceName:l,responseTime:p,serverIp:t[i%t.length]}),!!(e.code!==U_.OPERATION_ABORTED&&e.code!==U_.UNEXPECTED_RESPONSE||e.data&&e.data.retry)&&(m=t[(i+1)%t.length],!0))),n)}(n,t,e,i);this.emit(RC.STATE_CHANGE,IC.AP_CONNECTED);const{addressList:o,ticket:r}=s;return this._ticket=r,o}async connectWorker(t){this.emit(RC.STATE_CHANGE,IC.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(Cy.CONNECTED,(async()=>{this.emit(RC.STATE_CHANGE,IC.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=wC.CONNECTED})),this._workerConnection.on(Cy.CLOSED,(()=>{this.connectionState=wC.CLOSED})),this._workerConnection.on(Cy.FAILED,(()=>{this.connectionState=wC.CLOSED})),this._workerConnection.on(Cy.RECONNECTING,(()=>{this.connectionState=this.connectionState===wC.CONNECTED?wC.RECONNECTING:wC.CONNECTING})),this._workerConnection.on(Cy.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const e=qD(new Uint8Array(t.data));Db("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&$b.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(e)),this._uploadNum++,void 0===e.code||0===e.code||(this._uploadFailedNum++,$b.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(e.code,", msg is ").concat(e.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{sy.reportApiInvoke(this._connectInfo.sid||null,{name:oE.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,e.code],tag:rE.TRACER}).onError(new Uy(U_.IMAGE_MODERATION_UPLOAD_FAILED,e.msg)),this._uploadTimer=null}),Db("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else $b.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Cy.WILL_RECONNECT,((t,e,i)=>{"recover"===t&&i(t),i("tryNext")})),this._workerConnection.on(Cy.REQUEST_NEW_URLS,((t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)}))}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=EE(this,RC.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(Db("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&$b.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(t,e);this._workerConnection.sendMessage(i,!0,!0)}else Db("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&$b.debug("Only the track being published can be inspected")}async generateRequestData(t,e){let{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a}=e;const c=Date.now(),d=await t.getCurrentFrameImage("image/jpeg",this.quality),l=await vI(d,i,n),h=this._sequence+"-"+s+"-"+a+"-"+c+"-"+UE(12,""),u={appId:i,cid:s,cname:n,deviceId:"",elapse:CM.intToLong(Number(c-this._moderationStartTime)),fileSize:d.buffer.byteLength,height:d.height,width:d.width,jpg:l,networkType:6,osType:7,requestId:h,sdkVersion:"4.19.3",sequence:this._sequence,sid:r,timestamp:bM(c),uid:a,vid:o,service:this._moderationMode,ticket:this._ticket},p=zD(u);if(p.byteLength<this._workerMessageLengthLimit){if(Db("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const t=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?yM(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):yM(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},u);delete t.jpg,$b.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(t))}return p}{const e=this.quality*this._qualityRatio;return this.quality=e,await this.generateRequestData(t,{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=gb.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=wC.CLOSED,this.emit(RC.STATE_CHANGE,IC.CLOSED)}}function wM(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function RM(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?wM(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wM(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class IM extends kC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,e;return null!==(t=null===(e=this.peerConnection.getReceivers()[0])||void 0===e||null===(e=e.transport)||void 0===e?void 0:e.state)&&void 0!==t?t:null}constructor(t,e,i){super(t,e),nu(this,"direction",void 0),nu(this,"store",void 0),nu(this,"peerConnection",void 0),nu(this,"transportEventReceiver",void 0),nu(this,"statsFilter",void 0),nu(this,"localCandidateCount",0),nu(this,"allCandidatesReceived",!1),nu(this,"mutex",new zE("P2PConnection-mutex")),nu(this,"dataChannel",void 0),nu(this,"onLocalCandidate",void 0),this.store=e,this.peerConnection=new RTCPeerConnection(IM.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.direction=null!=i?i:yy.SEND_ONLY,this.dataChannel=this.peerConnection.createDataChannel("agora-p2p-signal",{ordered:!0}),this.statsFilter=LP(this.peerConnection,Db("STATS_UPDATE_INTERVAL"),void 0,T_()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{if(t){await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const e=await this.peerConnection.createAnswer();if(await this.peerConnection.setLocalDescription(e),!e.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");return e.sdp}{const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");return await this.peerConnection.setLocalDescription(t),t.sdp}}catch(t){throw new V_(U_.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t){try{await this.peerConnection.setRemoteDescription({type:"answer",sdp:t})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}async addRemoteCandidate(t){try{await this.peerConnection.addIceCandidate(t)}catch(t){throw new V_(U_.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(t.toString()))}}async send(t){try{const e=[];t.forEach((t=>{const i=this.peerConnection.addTransceiver(t._mediaStreamTrack,{direction:"sendonly"});e.push(i)})),T_()&&!0===Db("SIMULCAST")&&await this.applySimulcastForFirefox(e,t),await this.applySimulcastEncodings(e,t),await this.applySendEncodings(e,t);const i=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(i),!i.sdp)throw new Error("Cannot get offer.sdp when trying to send PeerConnection.");const n=e.map((t=>{const e=this.getLocalSSRC(t.mid,i.sdp);if(!e)throw new Error("Cannot get ssrc when trying to send PeerConnection.");return{mid:t.mid,localSSRC:[{ssrcId:e}]}}));return{sdp:i.sdp,trackMessage:n}}catch(t){throw t instanceof V_?t:new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(t.toString()))}}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{const e=this.peerConnection.getTransceivers().filter((e=>-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length (".concat(e.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));e.map((t=>{var e;t.direction="inactive",null===(e=t.stop)||void 0===e||e.call(t),this.peerConnection.removeTrack(t.sender)}));const n=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(n),!n.sdp)throw new Error("Cannot get offer.sdp when trying to send PeerConnection.");return n.sdp}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(t.toString()))}finally{i&&i()}}async receive(t,e,i){try{await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");await this.peerConnection.setLocalDescription(n),$b.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."));const s=this.getRemoteMid(i,e);if(void 0===s)throw new Error("Cannot get transceiver mid when trying to receive track.");const o=this.peerConnection.getTransceivers().find((t=>t.mid===s));if(!o||null===o.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,mid:o.mid,sdp:n.sdp}}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async setDescription(t,e){try{if("remote"===t){await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();if(!i.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");return await this.peerConnection.setLocalDescription(i),$b.debug("[".concat(this.store.clientId,"] [P2PConnection] exchanging SDP, type is ").concat(t)),i.sdp}await this.peerConnection.setRemoteDescription({type:"answer",sdp:e})}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection.setDescription failed; ".concat(t.toString()))}}async stopReceiving(t,e){try{const i=this.peerConnection.getTransceivers().filter((e=>-1!==t.indexOf(e.mid)));if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map((t=>{var e;t.direction="inactive",null===(e=t.stop)||void 0===e||e.call(t)})),await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();if(await this.peerConnection.setLocalDescription(n),!n.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");return n.sdp}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async restartICE(){try{const t=await this.peerConnection.createOffer({iceRestart:!0});if(!t.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");return this.store.descriptionStart(),await this.peerConnection.setLocalDescription(t),t.sdp}catch(t){throw new V_(U_.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}close(){var t;this.peerConnection.close(),null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter((e=>e.mid===t));1===i.length&&(this.isVP8Simulcast(e)?T_()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find((t=>t.mid===e));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const e=t[0].transport.iceTransport,{local:i,remote:n}=e.getSelectedCandidatePair();return{local:RM(RM({},fP),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:RM(RM({},fP),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{var e;t.candidate&&(null===(e=this.onLocalCandidate)||void 0===e||e.call(this,t.candidate)),t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,$b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,$b.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Db("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(mE(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...IM.turnServerConfigToIceServers(t.turnServer.servers)),Db("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...IM.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Db("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(e.iceTransportPolicy="relay")})))),Db("ENABLE_ENCODED_TRANSFORM")&&mR().supportWebRTCEncodedTransform&&(e.encodedInsertableStreams=!0),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.tcpport&&(e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(mk(t.turnServerURL),":").concat(t.tcpport,"?transport=tcp")}),e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=udp")}),e.push({username:t.username,credential:t.password,credentialType:"password",urls:"stun:".concat(t.turnServerURL,":").concat(t.tcpport)}))})),e}tryBindTransportEvents(t){const e=t.transport;if(e){this.transportEventReceiver=t,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=t=>{var e;null===(e=this.onDTLSTransportError)||void 0===e||e.call(this,"error"in t?t.error:t)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:t,remote:e}=i.getSelectedCandidatePair();$b.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol}),", remote ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol,address:e.address,port:e.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,e){var i;if(e||(e=this.peerConnection.getSenders().find((e=>e.track===t._mediaStreamTrack))),!e)return $b.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return $b.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!mR().supportSetRtpSenderParameters)return $b.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const n={},s={};switch(t._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:e,frameRate:i,scaleResolutionDownBy:n}=t._encoderConfig;e&&(s.maxBitrate=1e3*e),Ps(o=t._hints).call(o,Dw.LOW_STREAM)&&(i&&(s.maxFramerate=fk(i)),n&&n>=1&&(s.scaleResolutionDownBy=n))}if(Db("DSCP_TYPE")&&D_()){var r;const t=Db("DSCP_TYPE");Ps(r=["very-low","low","medium","high"]).call(r,t)&&(s.networkPriority=t)}const a=e.getParameters(),c=null===(i=a.encodings)||void 0===i?void 0:i[0];T_()&&!c&&(n.encodings=[s]),c&&Object.assign(c,s),Object.assign(a,n),$b.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await e.setParameters(a)}async applySendEncodings(t,e){try{if(!mR().supportSetRtpSenderParameters)return;if(t.length!==e.length)return;for(let i=0;i<t.length;i++){const n=t[i],s=e[i];s instanceof SI&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(t){$b.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e,i){const n=$L.parse(t);return e.forEach(((t,e)=>{const s=i[e],o=n.mediaDescriptions.find((t=>t.attributes.mid===s));o&&(QL(o,t),sP(o,t,this.store.codec))})),$L.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;null===(e=this.onFirstAudioReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;null===(e=this.onFirstVideoReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;null===(e=this.onFirstAudioDecoded)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;null===(e=this.onFirstVideoDecodedTimeout)||void 0===e||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let a=0;a<t.length;a++){var i,n,s,o,r;const c=t[a],d=e[a];if(d instanceof SI&&!Ps(i=d._hints).call(i,Dw.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const t={},e={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};t.encodings=[{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:e.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,t))}}}async applySimulcastEncodings(t,e){if(!T_()&&t.length===e.length)for(let i=0;i<t.length;i++){const n=e[i];if(n instanceof SI&&this.isVP8Simulcast(n)){const e=t[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=e.sender.getParameters();await e.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(t){var e,i,n,s,o;return!!(t instanceof SI&&Db("SIMULCAST")&&"vp8"===this.store.codec&&!Ps(e=t._hints).call(e,Dw.LOW_STREAM)&&null!==(i=t._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=t._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=t._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=t._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,i,n){if(Db("SDP_LOGGING"))return $b.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(e," SDP during P2PConnection.").concat(n,"\n"),t),"offer"===e?t=>{this.logSDPExchange(t,"answer","local"===i?"remote":"local",n)}:void 0}getLocalSSRC(t,e){var i,n;if(e=null!==(i=e)&&void 0!==i?i:null===(n=this.currentLocalDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=$L.parse(e).mediaDescriptions.find((e=>e.attributes.mid===t)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}getRemoteMid(t,e){var i,n,s;if(e=null!==(i=e)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp)return null===(s=$L.parse(e).mediaDescriptions.find((e=>e.attributes.ssrcs.some((e=>e.ssrcId===t)))))||void 0===s?void 0:s.attributes.mid}async getRemoteSSRC(t,e){var i,n;if(e=null!==(i=e)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=$L.parse(e).mediaDescriptions.find((e=>e.attributes.mid===t)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}}function AM(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}var OM;function NM(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function kM(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?NM(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):NM(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}My([AM,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],IM.prototype,"establish",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],IM.prototype,"connect",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[RTCIceCandidate]),xy("design:returntype",e_)],IM.prototype,"addRemoteCandidate",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],IM.prototype,"send",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[String,String,Number]),xy("design:returntype",e_)],IM.prototype,"receive",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[String,String]),xy("design:returntype",e_)],IM.prototype,"setDescription",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[Array,String]),xy("design:returntype",e_)],IM.prototype,"stopReceiving",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],IM.prototype,"restartICE",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],IM.prototype,"close",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],IM.prototype,"updateEncoderConfig",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[String,iR]),xy("design:returntype",e_)],IM.prototype,"updateSendParameters",null),My([AM,xy("design:type",Function),xy("design:paramtypes",[iR,String]),xy("design:returntype",e_)],IM.prototype,"replaceTrack",null),function(t){t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY"}(OM||(OM={}));class LM extends iE{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(fC.StateChange,e,this._state)}constructor(t,e){super(),nu(this,"store",void 0),nu(this,"statsUploader",void 0),nu(this,"sendConnection",void 0),nu(this,"recvConnection",void 0),nu(this,"localTrackMap",new Map),nu(this,"remoteUserMap",new Map),nu(this,"localDataChannels",[]),nu(this,"pendingLocalTracks",[]),nu(this,"pendingRemoteTracks",[]),nu(this,"statsCollector",void 0),nu(this,"dtlsFailedCount",0),nu(this,"sendMutex",new zE("P2PChannel2-send-mutex")),nu(this,"recvMutex",new zE("P2PChannel2-recv-mutex")),nu(this,"_state",gC.Disconnected),nu(this,"_restartStates",["disconnected","failed"]),nu(this,"_restartTimer",void 0),nu(this,"handleMuteLocalTrack",(async(t,e,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==gC.Connected)return void i(new V_(U_.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const r=this.filterTobeMutedTracks(t);if(0===r.length)return void e();const a=r.find((t=>"videoLowTrack"===t[0]));a&&a[1].track._originMediaStreamTrack.stop();let c=!1;var s,o;c="video"===t.trackMediaType?!(null===(s=this.localTrackMap.get(mC.LocalAudioTrack))||void 0===s||!s.track._muted):void 0===(null===(o=this.localTrackMap.get(mC.LocalVideoTrack))||void 0===o?void 0:o.id);const d=r.filter((t=>{let[e,i]=t;return(e!==mC.LocalAudioTrack||c)&&void 0!==i.id})).map((t=>{let[,e]=t;return e}));let l;d.length>0&&(l=await this.sendConnection.stopSending(d.map((t=>t.id))),d.forEach((t=>{t.id=void 0,t.ssrcs=void 0})));const h=this.createMuteMessage(r),u="video"===t.trackMediaType?OC.MUTE_LOCAL_VIDEO:OC.MUTE_LOCAL_AUDIO,p=await vE(this,fC.RequestP2PMuteLocal,{action:u,sdp:l,message:h,isMuteAll:c});p&&await this.sendConnection.setDescription("local",p),(l||"audio"===t.trackMediaType)&&await _E(this,fC.RequestMuteLocal,h),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleUnmuteLocalTrack",(async(t,e,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==gC.Connected)return void i(new V_(U_.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(t);if(0===s.length)return void e();const o=this.createUnmuteMessage(s),r="video"===t.trackMediaType?OC.UNMUTE_LOCAL_VIDEO:OC.UNMUTE_LOCAL_AUDIO;await _E(this,fC.RequestP2PMuteLocal,{action:r,message:o}),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleUpdateVideoEncoder",(async(t,e,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const i=this.localTrackMap.get(mC.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==t||this.state!==gC.Connected)return void e();const{id:s,track:o}=i;s&&(await this.sendConnection.updateSendParameters(s,o),await this.sendConnection.updateEncoderConfig(s,o),this.emit(fC.UpdateVideoEncoder,o)),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleSetOptimizationMode",(async(t,e,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const i=this.localTrackMap.get(mC.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==t||this.state!==gC.Connected)return;const{id:s,track:o}=i;s&&await this.sendConnection.updateSendParameters(s,o),e()}catch(t){i(t)}finally{n()}})),nu(this,"handleReplaceTrack",(async(t,e,i,n)=>{let s;$b.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(t.getTrackId(),"]")),"boolean"==typeof n&&n||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var o;const i=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(!this.sendConnection||!i||void 0===i[1].id||this.state!==gC.Connected)return void e();if(await(null===(o=this.sendConnection)||void 0===o?void 0:o.replaceTrack(t,i[1].id)),i[0]===mC.LocalVideoTrack&&mR().supportDualStreamEncoding){const e=this.localTrackMap.get(mC.LocalVideoLowTrack);if(e){const i=t._mediaStreamTrack.clone();e.track._originMediaStreamTrack.stop(),e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i,await new e_(((t,i)=>{this.handleReplaceTrack(e.track,t,i,!0)}))}}e()}catch(t){i(t)}finally{var r;null===(r=s)||void 0===r||r()}})),nu(this,"handleGetLocalVideoStats",(t=>{t(this.statsCollector.getLocalVideoTrackStats())})),nu(this,"handleGetLocalAudioStats",(t=>{t(this.statsCollector.getLocalAudioTrackStats())})),nu(this,"handleGetRemoteVideoStats",(t=>this.statsCollector.getRemoteVideoTrackStats(t.uid)[t.uid])),nu(this,"handleGetRemoteAudioStats",(t=>this.statsCollector.getRemoteAudioTrackStats(t.uid)[t.uid])),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new dD,this.bindStatsUploaderEvents()}async startP2PConnection(t,e){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t,e,i,n,s,o){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){if(this.state=gC.New,this.sendConnection&&($b.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset P2PConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),this.recvConnection&&($b.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset P2PConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),this.sendConnection=new IM(t,this.store),this.bindConnectionEvents(this.sendConnection),this.recvConnection=new IM(t,this.store,yy.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection),e){this.store.peerConnectionStart(),await this.recvConnection.establish(e);const t=await this.sendConnection.establish(e);return this.statsUploader.startUploadTransportStats(!0),this.statsUploader.startUploadExtensionUsageStats(),this.state=gC.Connected,t}return await this.recvConnection.establish(e),this.sendConnection.establish(e)}async p2pConnect(t){if(!this.sendConnection||!this.recvConnection)throw new V_(U_.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.recvConnection.connect(t),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=gC.Connected}async addRemoteCandidate(t){if(!this.sendConnection||!this.recvConnection)throw new V_(U_.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t),await this.sendConnection.addRemoteCandidate(t)}async publish(t,e,i){if(!this.sendConnection||this.state!==gC.Connected){this.throwIfTrackTypeNotMatch(t);const e=t.filter((t=>-1===this.pendingLocalTracks.indexOf(t)));return void(this.pendingLocalTracks=this.pendingLocalTracks.concat(e))}this.store.pubId=this.store.pubId+1,ck.markPublishStart(this.store.clientId,this.store.pubId);const n=this.filterTobePublishedTracks(t,e,i);if(0===n.length)return void await this.tryToUnmuteAudio(t);n.forEach((t=>{let{track:e,type:i}=t;const n=Date.now();this.store.publish(e.getTrackId(),i===mC.LocalAudioTrack?"audio":"video",n)})),this.bindLocalTrackEvents(n);const s=this.createGatewayPublishMessage(n);return this.assignLocalTracks(n),n.forEach((t=>{let{track:e,type:i}=t;const n=Date.now();this.store.publish(e.getTrackId(),i===mC.LocalAudioTrack?"audio":"video",void 0,n)})),s}async dopublish(t){if(!this.sendConnection||this.state!==gC.Connected)return;const e=this.localTrackMap.get(t);if(e){const{sdp:i,trackMessage:n}=await this.sendConnection.send([e.track]),{mid:s,localSSRC:o}=n[0];e.id=s,e.ssrcs=o,this.statsCollector.addLocalStats(t),this.statsUploader.startUploadUplinkStats();const r=await vE(this,fC.RequestP2PPublish,{kind:t===mC.LocalAudioTrack?hC.AUDIO:hC.VIDEO,sdp:i,ssrcId:o[0].ssrcId});await this.sendConnection.setDescription("local",r);const a=this.createUnmuteMessage([[t,e]]);await _E(this,fC.RequestUnmuteLocal,a)}}async setDescription(t,e){let i,n;"local"===t?(i=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection):(i=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection);try{if(!n||this.state!==gC.Connected)return;return await n.setDescription(t,e)}finally{i()}}publishLowStream(t){return BL((function*(){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&($b.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await vE(this,fC.RequestRePublish,this.pendingLocalTracks),this.emit(fC.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublish(t){if(!this.sendConnection||this.state!==gC.Connected)return void(0===t.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((e=>!Ps(t).call(t,e))));const e=this.filterTobeUnpublishedTracks(t);if(0===e.length)return;this.unbindLocalTrackEvents(e.map((t=>{let[e,{track:i}]=t;return{type:e,track:i}})));const i=e.filter((t=>{let[,{id:e}]=t;return void 0!==e}));if(!this.sendConnection||this.state!==gC.Connected)return void t.forEach((t=>{const e=this.pendingLocalTracks.indexOf(t);-1!==e&&this.pendingLocalTracks.splice(e,1)}));const n=e.find((t=>"videoLowTrack"===t[0]));let s;n&&n[1].track.close();const o=this.createGatewayUnpublishMessage(e);i.length>0&&(s=await this.sendConnection.stopSending(i.map((t=>{let[,{id:e}]=t;return e})))),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map((t=>{let[e,{track:i}]=t;return{type:e,track:i}}))),e.forEach((t=>{let[e]=t;this.statsCollector.removeLocalStats(e)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadUplinkStats();const r=this.createMuteMessage(e);return await e_.all(r.map((async t=>{await _E(this,fC.RequestMuteLocal,[t])}))),{sdp:s,unpubMsg:o}}async unpublishLowStream(){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async doUnpublish(t){if(!this.sendConnection||this.state!==gC.Connected)return;const e=[];if(t!==hC.AUDIO){const t=this.localTrackMap.get(mC.LocalVideoTrack);void 0!==(null==t?void 0:t.id)&&e.push([mC.LocalVideoTrack,t]);const i=this.localTrackMap.get(mC.LocalVideoLowTrack);void 0!==(null==i?void 0:i.id)&&e.push([mC.LocalVideoLowTrack,i]),this.statsCollector.removeLocalStats(mC.LocalVideoTrack),this.statsCollector.removeLocalStats(mC.LocalVideoLowTrack)}if(t!==hC.VIDEO){const t=this.localTrackMap.get(mC.LocalAudioTrack);void 0!==(null==t?void 0:t.id)&&e.push([mC.LocalAudioTrack,t]),this.statsCollector.removeLocalStats(mC.LocalAudioTrack)}if(e.length>0){const i=await this.sendConnection.stopSending(e.map((t=>{let[,e]=t;return e.id})));e.forEach((t=>{let[,e]=t;e.id=void 0,e.ssrcs=void 0}));const n=await vE(this,fC.RequestP2PUnPublish,{sdp:i,kind:t});await this.sendConnection.setDescription("local",n);const s=this.createMuteMessage(e);await e_.all(s.map((async t=>{await _E(this,fC.RequestMuteLocal,[t])})))}}async subscribe(t,e,i,n){var s;if(!this.recvConnection||this.state!==gC.Connected)throw new V_(U_.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(s=this.remoteUserMap.get(t))&&void 0!==s&&s.has(e))return;const{track:o,mid:r,sdp:a}=await this.recvConnection.receive(e,i,n);e===hC.AUDIO?(t._audioSSRC=n,t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new OI(o,t.uid,t._uintid,this.store),$b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new AI(o,t.uid,t._uintid,this.store),$b.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),this.bindRemoteTrackEvents(t,t._videoTrack));const c=this.remoteUserMap.get(t);c?c.set(e,r):this.remoteUserMap.set(t,new Map([[e,r]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadDownlinkStats(),await _E(this,fC.RequestP2PUnmuteRemote,e);const d=this.pendingRemoteTracks.findIndex((i=>{let{user:n,kind:s}=i;return n.uid===t.uid&&e===s}));return-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(fC.MediaReconnectEnd,t.uid)),a}async unsubscribe(t,e,i,n){const s=this.pendingRemoteTracks.filter((e=>{let{user:n,kind:s}=e;return void 0!==i?n.uid===t.uid&&i===s:n.uid===t.uid}));if(s.forEach((t=>{const e=this.pendingRemoteTracks.indexOf(t);this.pendingRemoteTracks.splice(e,1)})),this.recvConnection&&this.state===gC.Connected||n||s.forEach((e=>{let{kind:i}=e;var n;if(i===hC.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===hC.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}})),!this.recvConnection||this.state!==gC.Connected)return;const o=this.filterTobeUnSubscribedTracks(t,i);if(0===o.length)return void(i!==hC.VIDEO&&_E(this,fC.RequestP2PMuteRemote,hC.AUDIO));const r=await this.recvConnection.stopReceiving(o.map((t=>{let[,{id:e}]=t;return e})),e);return this.withdrawRemoteTracks(o),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),o.forEach((t=>{let[e,{kind:i}]=t;var s,o;if(i===hC.VIDEO&&e._videoSSRC&&(null===(s=this.recvConnection)||void 0===s||s.setStatsRemoteVideoIsReady(e._videoSSRC,!1)),i===hC.VIDEO)this.unbindRemoteTrackEvents(e._videoTrack),n||(null===(o=e._videoTrack)||void 0===o||o._destroy(),e._videoTrack=void 0);else if(i===hC.AUDIO){var r;this.unbindRemoteTrackEvents(e._audioTrack),n||(null===(r=e._audioTrack)||void 0===r||r._destroy(),e._audioTrack=void 0)}})),o.filter((t=>{let[,{kind:e}]=t;return e!==hC.AUDIO})).forEach((t=>{let[,{kind:e}]=t;_E(this,fC.RequestP2PMuteRemote,e)})),i!==hC.VIDEO&&_E(this,fC.RequestP2PMuteRemote,hC.AUDIO),r}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new V_(U_.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;const i=this.remoteUserMap.get(t);if(!i)return void $b.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void $b.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const n=e===hC.VIDEO?t._videoSSRC:t._audioSSRC;void 0!==n&&this.recvConnection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;const i=this.remoteUserMap.get(t);i?i.get(e)||$b.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,".")):$b.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."))}getAllTracks(t){const e=this.localTrackMap.get(mC.LocalAudioTrack);if((null==e?void 0:e.track)instanceof eI){const i=e.track;return Array.from(this.localTrackMap.entries()).filter((t=>{let[e]=t;return e!==mC.LocalAudioTrack})).filter((e=>{let[i]=e;return!(t&&i===mC.LocalVideoLowTrack)})).map((t=>{let[,{track:e}]=t;return e})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((e=>{let[i]=e;return!(t&&i===mC.LocalVideoLowTrack)})).map((t=>{let[,{track:e}]=t;return e}))}reportPublishEvent(t,e,i,n,s){if(t){const i=this.localTrackMap.get(mC.LocalAudioTrack),o=n?this.localTrackMap.get(mC.LocalVideoLowTrack):this.localTrackMap.get(mC.LocalVideoTrack);sy.publish(this.store.sessionId,{eventElapse:ck.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:null==i?void 0:i.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(Dw.SCREEN_TRACK)),audio:!!i,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var o;i||(i=[]);const r=i.find((t=>t instanceof ZR)),a=n?null===(o=this.localTrackMap.get(mC.LocalVideoTrack))||void 0===o?void 0:o.track:i.find((t=>t instanceof SI));sy.publish(this.store.sessionId,{eventElapse:ck.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(Dw.SCREEN_TRACK)),audio:!!r,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(t,e,i,n){const s=n===hC.VIDEO?i._videoSSRC:i._audioSSRC;s&&sy.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===hC.VIDEO,audio:n===hC.AUDIO,peerid:i.uid,subscribeRequestid:n===hC.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:ck.measureFromSubscribeStart(this.store.clientId,s)})}reset(){$b.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new zE("P2PChannel2-send-mutex"),this.sendMutex=new zE("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(mC.LocalAudioTrack);if((null==t?void 0:t.track)instanceof eI){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach((t=>{e.removeAudioTrack(t)}))}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.state=gC.Disconnected}getStats(t){var e,i;return t?null===(i=this.recvConnection)||void 0===i?void 0:i.getStats():null===(e=this.sendConnection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return(null===(e=this.recvConnection)||void 0===e?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(mC.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(mC.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof SI||e&&e.track instanceof ZR?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e.uid===t));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map((t=>{let[e]=t;return{uid:e.uid,level:e.audioTrack?100*e.audioTrack._source.getAccurateVolumeLevel():0}}));const e=this.localTrackMap.get(mC.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Zu(t).call(t,((t,e)=>t.level-e.level)),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&($b.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=gC.Reconnecting,Db("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&(null===(i=e._videoTrack._player.getVideoElement())||void 0===i||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((t=>{var e;let[i,{track:n}]=t;switch(i){case mC.LocalVideoTrack:Ps(e=n._hints).call(e,Dw.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case mC.LocalAudioTrack:n instanceof eI?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case mC.LocalVideoLowTrack:}})),this.emit(fC.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,i]=t;Array.from(hu(i).call(i)).forEach((t=>{this.setPendingRemoteMedia(e,t)})),this.emit(fC.MediaReconnectStart,e.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),$b.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((t instanceof NL?t.uid:t)===n.uid&&e===s)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t){let e;e=t.direction===yy.SEND_ONLY?await this.sendMutex.lock("From P2PChannel.restartICE"):await this.recvMutex.lock("From P2PChannel.restartICE");try{const i=await t.restartICE(),n=await vE(this,fC.RequestP2PRestartICE,i);t.setDescription("local",n)}finally{e()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(mC.LocalVideoTrack),i=this.localTrackMap.get(mC.LocalAudioTrack),n=t.videoSend.find((t=>{var i;return t.ssrc===(null==e||null===(i=e.ssrcs)||void 0===i?void 0:i[0].ssrcId)})),s=t.audioSend.find((t=>{var e;return t.ssrc===(null==i||null===(e=i.ssrcs)||void 0===e?void 0:e[0].ssrcId)}));if(!n||!s)return 1;const o=EE(this,fC.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==e?void 0:e.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(Dw.SCREEN_TRACK)){const e=u._encoderConfig.bitrateMax,i=t.bitrate.actualEncoded;if(e&&i){const t=(1e3*e-i)/(1e3*e);return ay[t<.15?0:t<.3?1:t<.45?2:t<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=t.audioRecv.find((t=>t.ssrc===s)),a=t.videoRecv.find((t=>t.ssrc===o));if(!r&&!a)return void(e+=1);const c=EE(this,fC.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=t.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new e_(((e,i)=>{this.handleMuteLocalTrack(t,e,i)}))}filterTobePublishedTracks(t,e,i){const n=[],s=mR(),o=this.getAllTracks();t=wE(t=t.filter((t=>-1===o.indexOf(t))));let r=!1,a=!1;for(const o of t){if(o instanceof SI&&(this.localTrackMap.has(mC.LocalVideoTrack)||r?new V_(U_.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:mC.LocalVideoTrack}),r=!0),e)){const t=this.getLowVideoTrack(o,i);n.push({track:t,type:mC.LocalVideoLowTrack})}if(o instanceof ZR){const t=this.localTrackMap.get(mC.LocalAudioTrack);if(t){if(!(t.track instanceof eI))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");t.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const t=n.find((t=>{let{type:e}=t;return e===mC.LocalAudioTrack}));if(!(t.track instanceof eI))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");t.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof eI||o._bypassWebAudio)n.push({track:o,type:mC.LocalAudioTrack});else{const t=new eI;t.addAudioTrack(o),n.push({track:t,type:mC.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=wE(t=t.filter((t=>-1!==i.indexOf(t))));for(const i of t){if(i instanceof ZR){const t=this.localTrackMap.get(mC.LocalAudioTrack);if(!t)continue;t.track instanceof eI?(t.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===t.track.trackList.length&&(e.push([mC.LocalAudioTrack,t]),t.track.close())):e.push([mC.LocalAudioTrack,t])}if(i instanceof SI){const t=this.localTrackMap.get(mC.LocalVideoTrack);if(!t)continue;e.push([mC.LocalVideoTrack,t]);const i=this.localTrackMap.get(mC.LocalVideoLowTrack);i&&e.push([mC.LocalVideoLowTrack,i])}}return e}bindLocalTrackEvents(t){t.forEach((t=>{let{track:e,type:i}=t;switch(i){case mC.LocalVideoTrack:e.addListener(Pw.GET_STATS,this.handleGetLocalVideoStats),e.addListener(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Pw.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),e.addListener(Pw.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),e.addListener(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case mC.LocalAudioTrack:this.bindLocalAudioTrackEvents(e);case mC.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(t,e){t instanceof eI?t.trackList.forEach((t=>{t.addListener(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Pw.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.addListener(Pw.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map((t=>{let[e,{track:i}]=t;return{track:i,type:e}}))),t.forEach((t=>{let{track:e,type:i}=t;switch(i){case mC.LocalVideoTrack:e.off(Pw.GET_STATS,this.handleGetLocalVideoStats),e.off(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Pw.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),e.off(Pw.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),e.off(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case mC.LocalAudioTrack:this.unbindLocalAudioTrackEvents(e);case mC.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(t){t instanceof eI?t.trackList.forEach((t=>{t.off(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Pw.GET_STATS,this.handleGetLocalAudioStats),t.off(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.off(Pw.GET_STATS,this.handleGetLocalAudioStats),t.off(Pw.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Pw.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Pw.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Pw.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof AI&&e.addListener(Pw.GET_STATS,(e=>{e(this.handleGetRemoteVideoStats(t))})),e instanceof OI&&e.addListener(Pw.GET_STATS,(e=>{e(this.handleGetRemoteAudioStats(t))}))}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Pw.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,i]=t;i.has(hC.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(hC.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)}))}createGatewayPublishMessage(t){return t.map((t=>{var e;let i,n,{track:s,type:o}=t;switch(o){case mC.LocalAudioTrack:i=Qy.Audio,n={dtx:s instanceof QR&&s._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case mC.LocalVideoTrack:i=Ps(e=s._hints).call(e,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High,n=kM(kM({},vk(s)),{},{codec:this.store.codec});break;case mC.LocalVideoLowTrack:i=Qy.Low,n=kM(kM({},vk(s)),{},{codec:this.store.codec})}return{kind:o===mC.LocalAudioTrack?hC.AUDIO:hC.VIDEO,stream_type:i,attributes:n,isMuted:s.muted||!s.enabled}}))}createGatewayUnpublishMessage(t){return t.map((t=>{var e;let i,[n,{track:s,ssrcs:o,id:r}]=t;switch(n){case mC.LocalVideoTrack:i=Ps(e=s._hints).call(e,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High;break;case mC.LocalAudioTrack:i=Qy.Audio;break;case mC.LocalVideoLowTrack:i=Qy.Low}return{stream_type:i,ssrcs:o,mid:r}}))}assignLocalTracks(t){t.forEach((t=>{let{track:e,type:i}=t;this.localTrackMap.set(i,{track:e})}))}withdrawLocalTracks(t){t.forEach((t=>{let[e]=t;this.localTrackMap.delete(e)}))}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var i;if($b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(fC.PeerConnectionStateChange,e),"connected"!==e||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),Ps(i=this._restartStates).call(i,e)||t.direction===yy.SEND_ONLY){if(this._restartTimer)return;const e=()=>{"disconnected"!==t.iceConnectionState&&"checking"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||($b.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE")),"CONNECTED"===EE(this,fC.QueryClientConnectionState)&&this.restartICE(t))};this._restartTimer=window.setTimeout((()=>{e(),this._restartTimer=void 0}),800)}},t.onICEConnectionStateChange=t=>{"connected"!==t||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),sy.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:rE.TRACER}).onSuccess(),this.emit(fC.IceConnectionStateChange,t)},t.onICETransportStateChange=t=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},t.onDTLSTransportStateChange=t=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},t.onDTLSTransportError=t=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},t.onFirstAudioDecoded=t=>{var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e._audioSSRC===t));var n;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),null===(n=i.audioTrack)||void 0===n||n.emit(Bw.FIRST_FRAME_DECODED),sy.firstRemoteFrame(this.store.sessionId,Jb.FIRST_AUDIO_DECODE,Xb.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=t=>{var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e._audioSSRC===t));i&&sy.firstRemoteFrame(this.store.sessionId,Jb.FIRST_AUDIO_RECEIVED,Xb.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(t,e,i)=>{this.reportVideoFirstFrameDecoded(t,e,i)},t.onFirstVideoReceived=t=>{var e;const i=Array.from(hu(e=this.remoteUserMap).call(e)).find((e=>e._videoSSRC===t));i&&sy.firstRemoteFrame(this.store.sessionId,Jb.FIRST_VIDEO_RECEIVED,Xb.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(t,e)=>{const i="relay"===t.candidateType,n="relay"===e.candidateType;"unknown"!==e.candidateType&&i===n||this.emit(fC.ConnectionTypeChange,i),$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(yk(e))," -> ").concat(JSON.stringify(yk(t)),")"))},t.onSelectedRemoteCandidateChanged=(t,e)=>{$b.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(yk(e))," -> ").concat(JSON.stringify(yk(t)),")"))},t.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},t.onLocalCandidate=t=>{this.emit(fC.LocalCandidate,t)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}filterTobeMutedTracks(t){const e=[];if(-1===this.getAllTracks().indexOf(t))return e;const i=this.localTrackMap.get(mC.LocalAudioTrack);if(t instanceof ZR&&(null==i?void 0:i.track)instanceof eI)return i.track.isActive||e.push([mC.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n&&(e.push(n),n[0]===mC.LocalVideoTrack)){const t=this.localTrackMap.get(mC.LocalVideoLowTrack);t&&e.push([mC.LocalVideoLowTrack,t])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(mC.LocalAudioTrack);if(t instanceof ZR&&(null==i?void 0:i.track)instanceof eI)return i.track.isActive&&e.push([mC.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n)if(n[0]===mC.LocalVideoTrack){e.push(n);const t=this.localTrackMap.get(mC.LocalVideoLowTrack);t&&e.push([mC.LocalVideoLowTrack,t])}else e.push(n);return e}createMuteMessage(t){return t.map((t=>{var e;let i,[n,{track:s,ssrcs:o,id:r}]=t;switch(n){case mC.LocalAudioTrack:i=Qy.Audio;break;case mC.LocalVideoTrack:i=Ps(e=s._hints).call(e,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High;break;case mC.LocalVideoLowTrack:i=Qy.Low}return{stream_type:i,ssrcs:o,mid:r}}))}createUnmuteMessage(t){return t.map((t=>{var e;let i,[n,{track:s,ssrcs:o,id:r}]=t;switch(n){case mC.LocalAudioTrack:i=Qy.Audio;break;case mC.LocalVideoTrack:i=Ps(e=s._hints).call(e,Dw.SCREEN_TRACK)?Qy.Screen:Qy.High;break;case mC.LocalVideoLowTrack:i=Qy.Low}return{stream_type:i,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(t,e){const i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){const s=n.get(e);if(!s)return i;i.push([t,{kind:e,id:s}])}else Array.from(n.entries()).forEach((e=>{let[n,s]=e;i.push([t,{kind:n,id:s}])}));return i}createUnsubscribeMessage(t){const e=[];return t.forEach((t=>{let[i,{kind:n,id:s}]=t;switch(n){case hC.VIDEO:return void(i._videoSSRC&&e.push({stream_type:hC.VIDEO,ssrcId:i._videoSSRC}));case hC.AUDIO:return void(i._audioSSRC&&e.push({stream_type:hC.AUDIO,ssrcId:i._audioSSRC}))}})),e}withdrawRemoteTracks(t){t.forEach((t=>{let[e,{kind:i}]=t;const n=this.remoteUserMap.get(e);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(e))}))}async updateBitrateLimit(t){const e=this.localTrackMap.get(mC.LocalVideoTrack),i=this.localTrackMap.get(mC.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),i&&t.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return"connected"!==t&&"connected"!==e}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof ZR){const i=this.filterTobeUnmutedTracks(t[e]);if(0===i.length)continue;const n=this.createUnmuteMessage(i);return void await _E(this,fC.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((t=>{let[,{ssrcs:e}]=t;return!!e})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!(null===(e=this.recvConnection)||void 0===e||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(fC.RequestUploadStats,t,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await xE(YE(this.dtlsFailedCount,KE)),this.emit(fC.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(mC.LocalVideoTrack)||this.pendingLocalTracks.some((t=>t instanceof SI))}throwIfTrackTypeNotMatch(t){if(t.filter((t=>t instanceof SI)).length>1)throw new V_(U_.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter((t=>t instanceof ZR)).length>1&&(t.some((t=>t instanceof ZR&&t._bypassWebAudio))||!mR().webAudioMediaStreamDest))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof SI&&this.pendingLocalTracks.some((t=>t instanceof SI)))throw new V_(U_.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ZR&&this.pendingLocalTracks.some((t=>t instanceof ZR))&&(!mR().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some((t=>t instanceof ZR&&t._bypassWebAudio))))throw new V_(U_.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const i=!Db("DISABLE_DUAL_STREAM_USE_ENCODING")&&mR().supportDualStreamEncoding,n=kM(kM({},{width:160,height:120,framerate:15,bitrate:50}),e);let s;s=i?t._mediaStreamTrack.clone():$P(t,n);const o=UE(8,"track-low-"),r=new SI(s,kM(kM({},i&&{scaleResolutionDownBy:bk(n,t)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on(Vw.TRANSCEIVER_UPDATED,(e=>{t._updateRtpTransceiver(e,Mw.LOW_STREAM)})),r._hints.push(Dw.LOW_STREAM),t.addListener(Pw.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,i,n){var s;const o=Array.from(hu(s=this.remoteUserMap).call(s)).find((e=>e._videoSSRC===t));if(o){n||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,r=s.subscribe.find((t=>t.userId===o.uid&&"video"===t.type));sy.firstRemoteVideoDecode(this.store.sessionId,Jb.FIRST_VIDEO_DECODE,Xb.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:ck.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(null==r?void 0:r.subscribeEnd)||0,subscriberStart:(null==r?void 0:r.subscribeStart)||0,videoAddNotify:(null==r?void 0:r.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(t);if(!n)return!1;const s=n.get(e);if(!s)return!1;const o=await this.recvConnection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(t){$b.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(t)),this.state===gC.Connected?($b.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(t){throw new V_(U_.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new V_(U_.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new V_(U_.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new V_(U_.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new V_(U_.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new V_(U_.NOT_SUPPORTED)}async preConnect(t,e,i,n,s,o){throw new V_(U_.NOT_SUPPORTED)}getEstablishParams(){throw new V_(U_.NOT_SUPPORTED)}async reSubscribe(t){throw new V_(U_.NOT_SUPPORTED)}async updateVideoStreamParameter(t,e){throw new V_(U_.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((t=>{let[e,{track:i}]=t;e===mC.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Mw.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}}function PM(t){return function(e,i,n){const s=e[i];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];switch(t){case OM.SEND_ONLY:{const t=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{t()}}case OM.RECEIVE_ONLY:{const t=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{t()}}default:{const t=await this.sendMutex.lock("From P2PChannel2.".concat(i)),e=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{t(),e()}}}},n}}function DM(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function MM(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?DM(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):DM(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}My([PM(),xy("design:type",Function),xy("design:paramtypes",[Object,String]),xy("design:returntype",e_)],LM.prototype,"startP2P",null),My([PM(),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],LM.prototype,"p2pConnect",null),My([PM(OM.SEND_ONLY),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],LM.prototype,"dopublish",null),My([PM(OM.SEND_ONLY),xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],LM.prototype,"unpublish",null),My([PM(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],LM.prototype,"unpublishLowStream",null),My([PM(OM.SEND_ONLY),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],LM.prototype,"doUnpublish",null),My([PM(OM.RECEIVE_ONLY),xy("design:type",Function),xy("design:paramtypes",[NL,String,String,Number]),xy("design:returntype",e_)],LM.prototype,"subscribe",null),My([PM(OM.RECEIVE_ONLY),xy("design:type",Function),xy("design:paramtypes",[NL,String,String,Boolean]),xy("design:returntype",e_)],LM.prototype,"unsubscribe",null),My([PM(OM.RECEIVE_ONLY),xy("design:type",Function),xy("design:paramtypes",[NL,String]),xy("design:returntype",e_)],LM.prototype,"muteRemote",null),My([PM(OM.RECEIVE_ONLY),xy("design:type",Function),xy("design:paramtypes",[NL,String]),xy("design:returntype",e_)],LM.prototype,"unmuteRemote",null),My([PM(OM.RECEIVE_ONLY),xy("design:type",Function),xy("design:paramtypes",[NL,String]),xy("design:returntype",e_)],LM.prototype,"hasRemoteMediaWithLock",null),My([PM(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],LM.prototype,"disconnectForReconnect",null),My([PM(OM.RECEIVE_ONLY),xy("design:type",Function),xy("design:paramtypes",[NL,String,Number]),xy("design:returntype",e_)],LM.prototype,"remoteMediaSsrcChanged",null);const xM=Date.now(),UM=20,VM=new Map,FM=new Map;async function BM(t){const e=VM.get(t),i=Array.isArray(e)&&e[e.length-1],n=FM.get(t);if(!i)return void(n.isSyncing=!1);const s={uid:i.uid,payload:kE(i.payload)};0===n.firstRecvTs&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);const o=i.sendTs-n.firstSendTs,r=o-(Date.now()-n.firstRecvTs);r>0&&(n.firstRecvTs=Date.now()-o);let a=i.mediaDelay+r;a<=0?(e.pop(),jM(i.context,s),a=0):a=Math.min(a,UM),setTimeout((()=>e.length&&BM(t)),a)}function jM(t,e){t.safeEmit(dE.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}function HM(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return jM(i,{uid:t.uid,payload:kE(t.payload)});const n="".concat(i.id,"-").concat(t.uid),s=VM.get(n)||[],o=s.findIndex((e=>t.sendTs>=e.sendTs)),r=MM(MM({},t),{},{context:i,mediaDelay:e,recvTs:Date.now()});-1===o?s.push(r):s.splice(o,0,r),VM.set(n,s);let a=!1;var c;FM.has(n)?a=!(null===(c=FM.get(n))||void 0===c||!c.isSyncing):FM.set(n,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||BM(n)}const GM=p_().name;function WM(){return!function(t,e,i){const n=p_();if(n.os!==a_.IOS||!n.osVersion)return!1;const s=n.osVersion.split(".");return i?e&&Number(s[0])===t&&Number(s[1])<e||Number(s[0])<t:e?Number(s[0])===t&&Number(s[1])<=e||Number(s[0])<t:Number(s[0])<=t}(16,0,!0)&&!function(t,e,i){const n=p_();if(n.name!==c_.SAFARI||!n.osVersion)return!1;const s=n.version.split(".");return i?e&&Number(s[0])===t&&Number(s[1])<e||Number(s[0])<t:e?Number(s[0])===t&&Number(s[1])<=e||Number(s[0])<t:Number(s[0])<=t}(16,0,!0)}function $M(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function zM(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?$M(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):$M(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}zE.setLogger($b);class qM extends iE{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return(null===(t=this._config)||void 0===t?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let e;if(super(),nu(this,"store",void 0),nu(this,"_uid",void 0),nu(this,"_channelName",void 0),nu(this,"_uintUid",void 0),nu(this,"_users",[]),nu(this,"_config",void 0),nu(this,"_clientId",void 0),nu(this,"_appId",void 0),nu(this,"_sessionId",null),nu(this,"_key",void 0),nu(this,"_joinInfo",void 0),nu(this,"_gateway",void 0),nu(this,"_statsCollector",void 0),nu(this,"_configDistribute",void 0),nu(this,"_leaveMutex",new zE("client-leave")),nu(this,"_publishMutex",new zE("client-publish")),nu(this,"_renewTokenMutex",new zE("client-renewtoken")),nu(this,"_subscribeMutex",new zE("client-subscribe")),nu(this,"_encryptionMode","none"),nu(this,"_encryptionSecret",null),nu(this,"_encryptionSalt",null),nu(this,"_proxyServer",void 0),nu(this,"_turnServer",{servers:[],mode:"auto"}),nu(this,"_cloudProxyServerMode","disabled"),nu(this,"_isDualStreamEnabled",!1),nu(this,"_defaultStreamFallbackType",void 0),nu(this,"_lowStreamParameter",void 0),nu(this,"_streamFallbackTypeCacheMap",new Map),nu(this,"_remoteStreamTypeCacheMap",new Map),nu(this,"_axiosCancelSource",gb.CancelToken.source()),nu(this,"_audioVolumeIndicationInterval",void 0),nu(this,"_networkQualityInterval",void 0),nu(this,"_userOfflineTimeout",void 0),nu(this,"_streamRemovedTimeout",void 0),nu(this,"_injectStreamingClient",void 0),nu(this,"_liveTranscodeStreamingClient",void 0),nu(this,"_liveRawStreamingClient",void 0),nu(this,"_channelMediaRelayClient",void 0),nu(this,"_networkQualitySensitivity","normal"),nu(this,"_p2pChannel",void 0),nu(this,"_useLocalAccessPoint",!1),nu(this,"_setLocalAPVersion",void 0),nu(this,"_joinAndNotLeaveYet",!1),nu(this,"_numberOfJoinCount",0),nu(this,"_remoteDefaultVideoStreamType",void 0),nu(this,"_inspect",void 0),nu(this,"_moderation",void 0),nu(this,"_license",void 0),nu(this,"_pendingPublishedUsers",[]),nu(this,"ntpAlignErrorCount",0),nu(this,"remoteInboundOffset",0),nu(this,"_handleLocalTrackEnable",((t,e,i)=>{this.publish(t,!1).then(e).catch(i)})),nu(this,"_handleLocalTrackDisable",((t,e,i)=>{this.unpublish(t).then(e).catch(i)})),nu(this,"_handleUserOnline",(t=>{if(Db("BLOCK_LOCAL_CLIENT")&&dy(t.uid,this.channelName))return void $b.debug("[".concat(t.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof t.uid&&$b.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const e=this._users.find((e=>e.uid===t.uid));if(e)e._trust_in_room_=!0;else{const e=new NL(t.uid,t.uint_id||t.uid);this._users.push(e),$b.debug("[".concat(this._clientId,"] user online"),t.uid),this.safeEmit(dE.USER_JOINED,e)}})),nu(this,"_handleUserOffline",(t=>{if(Db("BLOCK_LOCAL_CLIENT")&&dy(t.uid,this.channelName))return;const e=this._users.find((e=>e.uid===t.uid));e&&(this._handleRemoveStream(t),this._handleRemoveDataChannels(t),CE(this._users,e),this._remoteStreamTypeCacheMap.delete(e.uid),this._streamFallbackTypeCacheMap.delete(e.uid),$b.debug("[".concat(this._clientId,"] user offline"),t.uid,"reason:",t.reason),this.safeEmit(dE.USER_LEAVED,e,t.reason))})),nu(this,"_handleAddAudioOrVideoStream",((t,e,i,n,s,o,r)=>{if(Db("BLOCK_LOCAL_CLIENT")&&dy(e,this.channelName))return;const a=this._users.find((t=>t.uid===e));if(!a)return void $b.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));$b.debug("[".concat(this._clientId,"] stream added with uid ").concat(e,", type ").concat(t)),this.store.subscribe(a.uid,t,void 0,void 0,void 0,Date.now());const c="audio"===t?a.hasAudio:a.hasVideo;a._uintid||(a._uintid=s||e),"audio"===t?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,"audio"===t?(a._audio_added_=!0,void 0!==i&&(a._audioSSRC=i),void 0!==n&&(a._cname=n),o&&(a._audioOrtc=o)):(a._video_added_=!0,void 0!==i&&(a._videoSSRC=i),void 0!==n&&(a._cname=n),void 0!==r&&(a._rtxSsrcId=r),o&&(a._videoOrtc=o)),("audio"===t?a.hasAudio:a.hasVideo)&&!c&&($b.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(t)),this.safeEmit(dE.USER_PUBLISHED,a,t)),"video"===t?sy.onGatewayStream(this._sessionId,Jb.ON_ADD_VIDEO_STREAM,Xb.ON_ADD_VIDEO_STREAM,{peer:s||e,ssrc:a._videoSSRC}):sy.onGatewayStream(this._sessionId,Jb.ON_ADD_AUDIO_STREAM,Xb.ON_ADD_AUDIO_STREAM,{peer:s||e,ssrc:a._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(a,t,i).then((e=>{if(e&&($b.debug("[".concat(this._clientId,"] resubscribe ").concat(t," for user ").concat(a.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof mD))return this._p2pChannel.unsubscribe(a,t,!0).then((()=>this._subscribe(a,t,!0).catch((t=>{$b.error("[".concat(this._clientId,"] resubscribe error"),t.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(a,t)&&($b.debug("[".concat(this._clientId,"] resubscribe ").concat(t," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,t,!0).catch((t=>{$b.error("[".concat(this._clientId,"] resubscribe error"),t.toString())})))})),nu(this,"_handleRemoveStream",((t,e,i)=>{if(Db("BLOCK_LOCAL_CLIENT")&&dy(t.uid,this.channelName))return;const n=this._users.find((e=>e.uid===t.uid));if(!n)return void $b.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));$b.debug("[".concat(this._clientId,"] stream removed with uid ").concat(t.uid));let s=()=>{};if(n.hasAudio&&n.hasVideo?s=()=>{$b.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished audio track")),this.safeEmit(dE.USER_UNPUBLISHED,n,"audio"),$b.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished video track")),this.safeEmit(dE.USER_UNPUBLISHED,n,"video")}:n.hasVideo?s=()=>{$b.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished video track")),this.safeEmit(dE.USER_UNPUBLISHED,n,"video")}:n.hasAudio&&(s=()=>{$b.info("[".concat(this._clientId,"] remote user ").concat(n.uid," unpublished audio track")),this.safeEmit(dE.USER_UNPUBLISHED,n,"audio")}),n._trust_audio_stream_added_state_=!0,n._trust_video_stream_added_state_=!0,n._audio_added_=!1,n._video_added_=!1,this._p2pChannel instanceof mD)this._p2pChannel.unsubscribe(n).then((t=>{if(t)return this._gateway.unsubscribe(t,n.uid)}));else if(e&&i)if(t.sdp){const{sdp:s}=t;this._p2pChannel.unsubscribe(n,s).then((t=>{t&&e(t)})).catch(i)}else e&&e();n._audioSSRC=void 0,n._videoSSRC=void 0,n._audioOrtc=void 0,n._videoOrtc=void 0,n._rtxSsrcId=void 0,sy.onGatewayStream(this._sessionId,Jb.ON_REMOVE_STREAM,Xb.ON_REMOVE_STREAM,{peer:t.uint_id||t.uid}),s()})),nu(this,"_handleSetStreamLocalEnable",((t,e,i)=>{if(Db("BLOCK_LOCAL_CLIENT")&&dy(e,this.channelName))return;const n=this._users.find((t=>t.uid===e));if(!n)return void $b.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));$b.debug("[".concat(this._clientId,"] local ").concat(t," ").concat(i?"enabled":"disabled"," with uid ").concat(e));const s="audio"===t?n.hasAudio:n.hasVideo;if("audio"===t){n._trust_audio_enabled_state_=!0;const t=n._audio_enabled_;if(n._audio_enabled_=i,n._audio_enabled_===t)return;{const t=n._audio_enabled_?"enable-local-audio":"disable-local-audio";$b.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(dE.USER_INFO_UPDATED,e,t)}}else{n._trust_video_enabled_state_=!0;const t=n._video_enabled_;if(n._video_enabled_=i,n._video_enabled_===t)return;{const t=n._video_enabled_?"enable-local-video":"disable-local-video";$b.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(dE.USER_INFO_UPDATED,e,t)}}const o="audio"===t?n.hasAudio:n.hasVideo;return s!==o?!s&&o?($b.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(t)),void this.safeEmit(dE.USER_PUBLISHED,n,t)):("video"===t&&n._videoTrack&&n._videoTrack._destroy(),"audio"===t&&n._audioTrack,this._p2pChannel.muteRemote(n,t),$b.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(t)),void this.safeEmit(dE.USER_UNPUBLISHED,n,t)):void 0})),nu(this,"_handleMuteStream",((t,e,i,n,s,o)=>{if(Db("BLOCK_LOCAL_CLIENT")&&dy(t,this.channelName))return;$b.debug("[".concat(this._clientId,"] receive mute message"),t,e,i);const r=this._users.find((e=>e.uid===t));if(!r)return void $b.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(t));const a="audio"===e?r.hasAudio:r.hasVideo;if("audio"===e){r._trust_audio_mute_state_=!0;const e=r._audio_muted_;if(r._audio_muted_=i,r._audio_muted_===e)return;{const e=r._audio_muted_?"mute-audio":"unmute-audio";$b.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(dE.USER_INFO_UPDATED,t,e)}}else{r._trust_video_mute_state_=!0;const e=r._video_muted_;if(r._video_muted_=i,r._video_muted_===e)return;{const e=r._video_muted_?"mute-video":"unmute-video";$b.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(dE.USER_INFO_UPDATED,t,e)}}const c="audio"===e?r.hasAudio:r.hasVideo;if(a!==c){if(!a&&c)return this.store.useP2P||("audio"===e?r._audioSSRC:r._videoSSRC)?($b.info("[".concat(this._clientId,"] remote user ").concat(t," published ").concat(e)),void this.safeEmit(dE.USER_PUBLISHED,r,e)):void $b.warning("[".concat(this._clientId,"] remote user ").concat(t," receive ").concat(e," unmute message  before add stream message, ").concat(e," SSRC doesn't exist yet."));"video"===e&&r._videoTrack&&r._videoTrack._destroy(),"audio"===e&&r._audioTrack,s&&o&&this._p2pChannel instanceof LM&&(n?this._p2pChannel.unsubscribe(r,n,e).then((t=>{s(t)})).catch(o):s()),this._p2pChannel.muteRemote(r,e),$b.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished ").concat(e)),this.safeEmit(dE.USER_UNPUBLISHED,r,e)}})),nu(this,"_handleP2PLost",(async t=>{$b.debug("[".concat(this._clientId,"] receive p2p lost"),t),parseInt(t.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():$b.warning("[".concat(this._clientId,"] P2PLost stream not found"),t)})),nu(this,"_handleTokenWillExpire",(()=>{$b.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(dE.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),nu(this,"_handleBeforeUnload",(t=>{"beforeunload"===t.type&&void 0!==t.returnValue&&""!==t.returnValue||(this.leave(),$b.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),nu(this,"_handleUpdateNetworkQuality",(()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(dE.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const t={downlinkNetworkQuality:0,uplinkNetworkQuality:0};t.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),t.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(dE.NETWORK_QUALITY,t)})),nu(this,"_handleP2PAddAudioOrVideoStream",((t,e)=>{const i=this._users.find((t=>t.uid===e));if(!i)return void $b.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));$b.debug("[".concat(this._clientId,"] stream added with uid ").concat(e,", type ").concat(t)),this.store.subscribe(i.uid,t,void 0,void 0,void 0,Date.now());const n="audio"===t?i.hasAudio:i.hasVideo;"audio"===t?i._trust_audio_stream_added_state_=!0:i._trust_video_stream_added_state_=!0,"audio"===t?i._audio_added_=!0:i._video_added_=!0,("audio"===t?i.hasAudio:i.hasVideo)&&!n&&($b.info("[".concat(this._clientId,"] remote user ").concat(i.uid," published ").concat(t)),this.safeEmit(dE.USER_PUBLISHED,i,t)),this._p2pChannel.hasPendingRemoteMedia(i,t)&&($b.debug("[".concat(this._clientId,"] resubscribe ").concat(t," for user ").concat(i.uid," after reconnect.")),this._subscribe(i,t,!0).catch((t=>{$b.error("[".concat(this._clientId,"] resubscribe error"),t.toString())})))})),this._config=t,this._clientId=UE(5,"client-"),this.store=new Ab(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),$b.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Ob," build: ").concat(kb,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{fE(t.clientRoleOptions),e=Object.assign({},t.clientRoleOptions)}catch(t){$b.warning("[".concat(this._clientId,"] ").concat(t.toString()))}this._statsCollector=new hk(this.store),this._statsCollector.onStatsException=(t,e,i)=>{$b.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(t,", msg: ").concat(e,", uid: ").concat(i)),this.safeEmit(dE.EXCEPTION,{code:t,msg:e,uid:i})},this._statsCollector.onUploadPublishDuration=(t,e,i,n)=>{const s=this._users.find((e=>e.uid===t));s&&sy.peerPublishStatus(this._sessionId,{subscribeElapse:n,audioPublishDuration:e,videoPublishDuration:i,peer:s._uintid})},this.store.useDataChannel=mR().supportDataChannel&&Db("SIGNAL_CHANNEL"),this.store.useP2P=Db("P2P"),this._gateway=new Mk(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||KE,httpRetryConfig:t.httpRetryConfig||KE,forceWaitGatewayResponse:void 0===t.forceWaitGatewayResponse||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:e}),this._configDistribute=new EL,this.store.useP2P?(this._p2pChannel=new LM(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new mD(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,i,n,s){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],r=arguments.length>6&&void 0!==arguments[6]&&arguments[6];Pb("JOIN_GATEWAY_USE_443PORT_ONLY",o),Pb("JOIN_GATEWAY_USE_DUAL_DOMAIN",r);const a=this._gateway.signal.websocket;return a instanceof YC&&(a.use443PortOnly=o,a.tryDoubleDomain=r),async function(t,e,i){s_.get(t)||s_.set(t,[]),o_.get(t)||o_.set(t,e),r_.get(t)||r_.set(t,0);const n=s_.get(t),s=o_.get(t);if(!n||!s)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(r_.get(t)===s){const t=n_();n.push(t),await t.promise}r_.set(t,r_.get(t)+1);for(var o=arguments.length,r=new Array(o>3?o-3:0),a=3;a<o;a++)r[a-3]=arguments[a];const c=await i(...r);return r_.set(t,r_.get(t)-1),r_.get(t)===s-1&&n.length>0&&(n[0].resolve(),n.shift()),0===r_.get(t)&&(s_.set(t,[]),o_.set(t,0),r_.set(t,0)),c}("client.join",Db("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,i,n,s)}async join(t,e,i,n,s){const o=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);const r=yb(),a=Cb()?window.isSecureContext:"Browser Not Support";if(!Cb()&&!r||!window.isSecureContext){const t="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";$b.warning(t)}const c=VE();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),$b.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const d=sy.reportApiInvoke(c,{name:oE.JOIN,options:[t,e,i,n],states:{isHttps:r,isSecureContext:a},tag:rE.TRACER});sy.setAppId(t);try{if(!i&&null!==i)throw new Uy(U_.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&G_(i,"token",1,2047),G_(t,"appid",1,2047),Vy(e),n&&Fy(n),s&&G_(s,"optionalInfo",1,2047)}catch(t){throw d.onError(t),t}if($b.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._leaveMutex.isLocked&&($b.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),$b.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const t=new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw d.onError(t),t}this._sessionId||(this._sessionId=c,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const l=zM({clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:"string"!=typeof n?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:s,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(l.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof n&&(l.stringUid=n,this._uintUid?(l.uid=this._uintUid,this._uintUid=void 0):l.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(l.aesmode=this._encryptionMode,l.aespassword=await tE(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(l.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:e,appId:t});const h=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&h===this._sessionId&&sy.joinChannelTimeout(this._sessionId,5)}),5e3);try{var u;let n;const s=l.cloudProxyServer;if(Ps(u=["proxy3","proxy4","proxy5"]).call(u,s)){const t=Db("PROXY_SERVER_TYPE3");Array.isArray(t)?l.proxyServer=t[0]:l.proxyServer=t}if(sy.setProxyServer(l.proxyServer),$b.setProxyServer(l.proxyServer),this.store.requestAPStart(),l.stringUid&&!l.uid){const t=await hL(l.stringUid,l,this._axiosCancelSource.token,this._config.httpRetryConfig||KE,this.store);$b.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(l.stringUid," => ").concat(t)),l.uid=t,n=await lL(l,this._axiosCancelSource.token,this._config.httpRetryConfig||KE,!0,this.store)}else n=await lL(l,this._axiosCancelSource.token,this._config.httpRetryConfig||KE,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(l,this._axiosCancelSource.token),this._configDistribute.on(dC.UPDATE_BITRATE_LIMIT,(t=>{this._p2pChannel.updateBitrateLimit(t)}))}),0),this._key=i||t;const o=n.gatewayInfo;this._joinInfo=zM(zM({},l),{},{cid:o.cid,uid:l.uid?l.uid:o.uid,vid:o.vid,apResponse:o.res,uni_lbs_ip:o.uni_lbs_ip,gatewayAddrs:o.gatewayAddrs});const r=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));d.onSuccess(r),this._appId=t,this._channelName=l.cname,this._uid=r,this.store.uid=r,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(S_()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const a=l.stringUid?"string uid: ".concat(l.stringUid,",uid: ").concat(l.uid):"uid: ".concat(this._uid);return $b.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(a)),setTimeout((()=>{$b.startUpload()}),5e3),this.store.joinEnd(),p=this,Ps(cy).call(cy,p)||cy.push(p),r}catch(t){const e=Array.isArray(t)?t[0]:t;throw e&&e.code===U_.OPERATION_ABORTED?$b.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),e):$b.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),e),e.code!==U_.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),d.onError(e),e}var p}_joinGateway(){if(!this._joinInfo||!this._key)throw new Uy(U_.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!Db("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((t=>t)).catch((t=>{if(t.code===U_.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,cE.FALLBACK),t;if(t.code===U_.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,cE.FALLBACK),t;throw t})).then((t=>{if(t instanceof Uy){if(t.code===U_.INIT_WEBSOCKET_TIMEOUT){if($b.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new Uy(U_.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const t=Db("PROXY_SERVER_TYPE3");if(Array.isArray(t))if(this._joinInfo.apUrl){const e=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=e.slice(e.length-2).join(".");t.forEach((t=>{this._joinInfo&&Ps(t).call(t,i)&&(this._joinInfo.proxyServer=t)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=t[0])}else this._joinInfo.proxyServer=t[0];else this._joinInfo.proxyServer=t;const e=Db("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return e&&e[1]&&"443"!==e[1]&&$b.setProxyServer(this._joinInfo.proxyServer),"443"!==Db("STATS_COLLECTOR_PORT").toString()&&sy.setProxyServer(this._joinInfo.proxyServer),sy.reportApiInvoke(this._sessionId,{name:oE.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:rE.TRACER}).onSuccess(),this.safeEmit(dE.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),Db("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((t=>{"forceturn"in t&&(t.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if($b.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new Uy(U_.INVALID_OPERATION);return sy.reportApiInvoke(this._sessionId,{name:oE.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:rE.TRACER}).onSuccess(),this._joinGateway()}return t})).then((t=>t))}async leave(){$b.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(S_()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(t){const e=cy.indexOf(t);-1!==e&&cy.splice(e,1)}(this);const t=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return $b.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave("CONNECTED"!==this.connectionState),$b.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(t)){if(!(t instanceof iR))return this._publishDataChannel(t);t=[t]}if(0===t.length)throw new Uy(U_.INVALID_PARAMS,"param list is empty");const i=t;if("audience"===this._gateway.role)throw new Uy(U_.INVALID_OPERATION,"audience can not publish stream");for(const t of i){if(!(t instanceof iR))throw new Uy(U_.INVALID_PARAMS,"parameter is not local track");if(!t._enabled&&e)throw new Uy(U_.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(t.getTrackId()))}$b.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(i.map((t=>"".concat(t.getTrackId()," ")))));const n=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&i.forEach((t=>{const e=this._configDistribute.getBitrateLimit();t instanceof SI&&e&&t.setBitrateLimit(e.uplink)}));try{await this._publishHighStream(i),$b.info("[".concat(this._clientId,"] Publish success, id ").concat(i.map((t=>"".concat(t.getTrackId()," ")))))}catch(t){throw $b.error("[".concat(this._clientId,"] publish error"),t.toString()),t}finally{n()}}async _publishDataChannel(t){j_(t.id,"id",0,65535,!0),F_(t.ordered,"ordered"),G_(t.metadata,"metadata",0,512),$b.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const e=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((e=>e.id===t.id)))throw new Uy(U_.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new Uy(U_.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Db("FORCE_TURN")&&!Db("TURN_ENABLE_TCP")&&!Db("TURN_ENABLE_UDP"))throw new Uy(U_.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const i=new ok(t);await this._p2pChannel.publishDataChannel([i]);try{const e={streamId:t.id,ordered:t.ordered,maxRetransmits:Db("DATASTREAM_MAX_RETRANSMITS"),metadata:t.metadata,channelId:i._originDataChannelId};await this._gateway.publishDataChannel(this._uid,e,!0)}catch(t){if(t.code!==U_.DISCONNECT_P2P)throw t}return await i._waitTillOpen(),$b.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(t){throw $b.error("[".concat(this._clientId,"] publish datachannels error"),t.toString()),t}finally{e()}}async unpublish(t){if(!this._joinInfo||void 0===this._uid)throw new Uy(U_.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof iR))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);$b.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map((t=>"".concat(t.getTrackId()," ")))," "));const i=await this._publishMutex.lock();try{if(this._p2pChannel instanceof LM){const t=await this._p2pChannel.unpublish(e);if(t){const e=await this._gateway.sendExtensionMessage(AC.UNPUBLISH,t);e&&await this._p2pChannel.setDescription("local",e)}}else{const t=await this._p2pChannel.unpublish(e);t&&await this._gateway.unpublish(t,this._uid),$b.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map((t=>"".concat(t.getTrackId())))))}}catch(t){throw $b.error("[".concat(this._clientId,"] unpublish error"),t.toString()),t}finally{i&&i()}}async _unpublishDataChannel(t){void 0!==t&&0!==t.length||(t=this._p2pChannel.getAllDataChannels()),$b.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map((t=>"".concat(t.id," ")))," "));const e=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublishDataChannel(t);i&&await this._gateway.unpublishDataChannel(i),$b.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map((t=>"".concat(t.id)))))}catch(t){throw $b.error("[".concat(this._clientId,"] unpublish dataChannel error"),t.toString()),t}finally{e&&e()}}async subscribe(t,e,i){return"datachannel"===e?this._subscribeDataChannel(t,i):this._subscribe(t,e)}async _subscribeDataChannel(t,e){var i;if(j_(e,"channelId",0,65535,!0),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((e=>e===t)))throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new Uy(U_.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&0===t._dataChannels.length)throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new Uy(U_.INVALID_REMOTE_USER,"user is not published");const n=null===(i=t._dataChannels)||void 0===i?void 0:i.find((t=>t.id===e));if(!n)throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new Uy(U_.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();$b.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const i=await this._p2pChannel.subscribeDataChannel(t,[n]);if(i&&Ps(i).call(i,n.id))try{var o;if(!n._originDataChannelId)throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new Uy(U_.REMOTE_USER_IS_NOT_PUBLISHED);const e={id:n.id,datachannelId:n._originDataChannelId,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:null!==(o=n.metadata)&&void 0!==o?o:""};await this._gateway.subscribeDataChannel(t.uid,e,!0)}catch(e){if((null==e?void 0:e.code)!==U_.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[n]),e;await this._p2pChannel.unsubscribeDataChannel(t,[n]),this._p2pChannel.setPendingRemoteDataChannel(t,n.id)}return await n._waitTillOpen(),$b.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),n}finally{s()}}async _p2pSubscribe(t,e,i){if(B_(e,"mediaType",["audio","video"]),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((e=>e===t))){const e=new Uy(U_.INVALID_REMOTE_USER,"user is not in the channel");throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),e}if(!t.hasAudio&&!t.hasVideo){const e=new Uy(U_.INVALID_REMOTE_USER,"user is not published");throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),e}if(!i&&("audio"===e&&!t.hasAudio||"video"===e&&!t.hasVideo)){const i=new Uy(U_.REMOTE_USER_IS_NOT_PUBLISHED);throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),i}const n=await this._subscribeMutex.lock();$b.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));const s="audio"===e?mC.LocalAudioTrack:this._joinInfo.defaultVideoStream===xw.LOW_STREAM?mC.LocalVideoLowTrack:mC.LocalVideoTrack;try{await this._p2pChannel.hasRemoteMediaWithLock(t,e)?await this._p2pChannel.unmuteRemote(t,e):(this.store.subscribe(t.uid,e,Date.now()),this._p2pChannel instanceof LM&&await this._gateway.sendExtensionMessage(AC.SUBSCRIBE,{trackType:s})),$b.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch((t=>{$b.warning("[".concat(this._clientId,"] auto set fallback failed"),t)}));const i="audio"===e?t._audioTrack:t._videoTrack;if(!i)throw new Uy(U_.UNEXPECTED_ERROR,"can not find remote track in user object");return i}catch(e){throw $b.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),e),e}finally{n()}}async _subscribe(t,e,i){if(this._p2pChannel instanceof LM)return this._p2pSubscribe(t,e);if(B_(e,"mediaType",["audio","video"]),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((e=>e===t))){const e=new Uy(U_.INVALID_REMOTE_USER,"user is not in the channel");throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),e}if(!t.hasAudio&&!t.hasVideo){const e=new Uy(U_.INVALID_REMOTE_USER,"user is not published");throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),e}if(!(i||("audio"!==e||t.hasAudio&&void 0!==t._audioSSRC)&&("video"!==e||t.hasVideo&&void 0!==t._videoSSRC))){const i=new Uy(U_.REMOTE_USER_IS_NOT_PUBLISHED);throw $b.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),i}let n="audio"===e?t._audioSSRC:t._videoSSRC,s="audio"===e?t._audioOrtc:t._videoOrtc,o="video"===e?t._rtxSsrcId:void 0,r={stream_type:"audio"===e?hC.AUDIO:hC.VIDEO,ssrcId:n};const a=await this._subscribeMutex.lock();$b.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const a="audio"===e?t._audioSSRC:t._videoSSRC;void 0!==a&&a!==n&&(n=a,s="audio"===e?t._audioOrtc:t._videoOrtc,o="video"===e?t._rtxSsrcId:void 0,r={stream_type:"audio"===e?hC.AUDIO:hC.VIDEO,ssrcId:n}),ck.markSubscribeStart(this.store.clientId,n),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,n,o,s);try{await this._gateway.subscribe(t.uid,r,!0)}catch(i){if((null==i?void 0:i.code)!==U_.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),i;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(i){throw this._p2pChannel.reportSubscribeEvent(!1,null==i?void 0:i.code,t,e),i}$b.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch((t=>{$b.warning("[".concat(this._clientId,"] auto set fallback failed"),t)}));const c="audio"===e?t._audioTrack:t._videoTrack;if(!c)throw new Uy(U_.UNEXPECTED_ERROR,"can not find remote track in user object");return c}catch(e){throw $b.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),e),e}finally{a()}}async massSubscribe(t){if(W_(t,"subscribeList"),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),i=new Map,n=await this._subscribeMutex.lock();$b.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i)})).join("; ")));const s=(t=[...t]).map((t=>{let{user:e,mediaType:i}=t;return{user:e,mediaType:i}})),o=await this._p2pChannel.globalLock();try{var r;for(let e=t.length-1;e>=0;e--){const n=t[e],{user:o,mediaType:r}=n;if(B_(r,"mediaType",["audio","video"]),!o){const t=new Uy(U_.INVALID_PARAMS,"user property does not exist in subscribeList item");throw $b.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),t}if(!this._users.find((t=>t===o))){const i=new Uy(U_.INVALID_REMOTE_USER,"user is not in the channel");$b.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),s[e].error=i,t.splice(e,1);continue}if("audio"===r&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===r&&(!o.hasVideo||void 0===o._videoSSRC)){const i=new Uy(U_.REMOTE_USER_IS_NOT_PUBLISHED);$b.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(r,", remote user is not published")),s[e].error=i,t.splice(e,1);continue}const a=iC.Video|iC.LwoVideo,c=i.get(o);if(c){if("video"===r?c&a:c&iC.Audio){t.splice(e,1),$b.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(r," twice"));continue}i.set(o,c|("video"===r?a:iC.Audio))}else i.set(o,"video"===r?a:iC.Audio)}for(let e=t.length-1;e>=0;e--){const n=t[e],{user:s,mediaType:o}=n,r=iC.Video|iC.LwoVideo;if(this._p2pChannel.hasRemoteMedia(s,o)){await this._p2pChannel.unmuteRemoteNoLock(s,o);const n=i.get(s);i.set(s,"video"===o?n^r:n^iC.Audio),t.splice(e,1)}}this.store.massSubscribe(t.map((t=>({userId:t.user.uid,type:t.mediaType}))),e);const a=cS(r=Array.from(i.entries())).call(r,((t,e)=>{let[i,n]=e;if(0===n)return t;const s={stream_id:i.uid,stream_type:n};return n&iC.Audio&&(s.audio_ssrc=i._audioSSRC),n&iC.Video&&(s.video_ssrc=i._videoSSRC),t.push(s),t}),[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map((t=>{let{user:e,mediaType:i}=t;return{user:e,mediaType:i,ssrcId:i===hC.VIDEO?e._videoSSRC:e._audioSSRC,rtxSsrcId:i===hC.VIDEO?e._rtxSsrcId:void 0}})));const i=new Map;if(a.length>0){const t=await this._gateway.subscribeAll(a,!0);((null==t?void 0:t.users)||[]).forEach((t=>{let{stream_id:e,video_error_code:n,audio_error_code:s,error_code:o}=t;(n||s||o)&&i.set(e,{video_error_code:n,audio_error_code:s,error_code:o})}))}if(Array.from(i.entries()).length>0){const t=Array.from(i.entries()).map((t=>{let e,[i,n]=t;return n.error_code||n.video_error_code&&n.audio_error_code?e=void 0:n.video_error_code?e=hC.VIDEO:n.audio_error_code&&(e=hC.AUDIO),{user:this.remoteUsers.find((t=>t.uid===i)),mediaType:e}}));await this._p2pChannel.massUnsubscribeNoLock(t)}for(const t of s){const e=i.get(t.user.uid);if(e){const i=e.error_code||"audio"===t.mediaType&&e.audio_error_code||"video"===t.mediaType&&e.video_error_code;if(i){const e=xC(i);$b.error("user:".concat(t.user.uid," mediaType:").concat(t.mediaType," has massSubscribe error ").concat(e.desc)),t.error=new Uy(U_.SUBSCRIBE_FAILED,"code ".concat(i,": ").concat(e.desc))}}t.error||("video"===t.mediaType?t.track=t.user.videoTrack:t.track=t.user.audioTrack)}return this.store.massSubscribe(s.filter((t=>!t.error)).map((t=>({userId:t.user.uid,type:t.mediaType}))),void 0,Date.now()),s.forEach((t=>{var i;sy.subscribe(this.store.sessionId,{succ:!!t.error,ec:(null===(i=t.error)||void 0===i?void 0:i.code)||null,video:t.mediaType===hC.VIDEO,audio:t.mediaType===hC.AUDIO,peerid:t.user.uid,subscribeRequestid:t.mediaType===hC.VIDEO?t.user._videoSSRC:t.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e)},!0)})),$b.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i)})).join("; "))),s}catch(e){throw await this._p2pChannel.massUnsubscribeNoLock(t),e}}finally{o(),n()}}async unsubscribe(t,e,i){if(e||this.store.useP2P){if("datachannel"===e)return this._unsubscribeDataChannel(t,i)}else await this._unsubscribeDataChannel(t,i);if(e&&B_(e,"mediaType",["audio","video"]),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((e=>e===t))){const e=new Uy(U_.INVALID_REMOTE_USER,"user is not in the channel");throw $b.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),e}$b.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const n=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof LM)await this._gateway.sendExtensionMessage(AC.UNSUBSCRIBE,{mediaType:e});else{const i=await this._p2pChannel.unsubscribe(t,e);i&&await this._gateway.unsubscribe(i,t.uid),$b.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(e){if(e.code===U_.DISCONNECT_P2P)return void $b.warning("disconnecting p2p, abort unsubscribe request.");throw $b.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),e.toString()),e}finally{n()}}async _unsubscribeDataChannel(t,e){if(e&&j_(e,"id",0,65535,!0),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((e=>e===t))){const e=new Uy(U_.INVALID_REMOTE_USER,"user is not in the channel");throw $b.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),e}let i;if("number"==typeof e){const n=t._dataChannels.find((t=>t.id===e));n&&(i=[n])}else i=t._dataChannels;if(void 0===i){const i=new Uy(U_.REMOTE_USER_IS_NOT_PUBLISHED);throw $b.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),i}$b.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i.map((t=>t.id))));try{const e=await this._p2pChannel.unsubscribeDataChannel(t,i);e&&await this._gateway.unsubscribeDataChannel(e,t.uid),$b.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(e))}catch(e){if(e.code===U_.DISCONNECT_P2P)return void $b.warning("disconnecting p2p, abort unsubscribe request.");throw $b.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),e.toString()),e}}async massUnsubscribe(t){if(W_(t,"unsubscribeList"),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");$b.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i,";")})).join())),t=[...t];const e=new Map;for(let i=t.length-1;i>=0;i--){const{user:n,mediaType:s}=t[i];if(!n){const t=new Uy(U_.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw $b.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),t}if(B_(s,"mediaType",["video","audio",void 0]),!this._users.find((t=>t===n))){$b.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),t.splice(i,1);continue}const o=iC.Video|iC.LwoVideo;if(e.has(n)){const r=e.get(n);let a;switch(s){case"video":a=r&o;break;case"audio":a=r&iC.Audio;break;default:a=r&(iC.Audio|o)}if(a){$b.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(n.uid,",mediaType:").concat(s," twice.")),t.splice(i,1);continue}s?"audio"===s?e.set(n,r|iC.Audio):"video"===s&&e.set(n,r|o):e.set(n,r|iC.Audio|o)}else s?"audio"===s?e.set(n,iC.Audio):"video"===s&&e.set(n,o):e.set(n,iC.Audio|o)}try{const e=await this._p2pChannel.massUnsubscribe(t);e&&await this._gateway.massUnsubscribe(e),$b.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i,";")})).join()))}catch(t){if(t.code===U_.DISCONNECT_P2P)return void $b.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw $b.error("[".concat(this._clientId,"] massUnsubscribe error"),t.toString()),t}}async setLowStreamParameter(t){!function(t){if(!t)throw new V_(U_.INVALID_PARAMS);$_(t.width)||H_(t.width,"streamParameter.width"),$_(t.height)||H_(t.height,"streamParameter.height"),$_(t.framerate)||H_(t.framerate,"streamParameter.framerate"),$_(t.bitrate)||j_(t.bitrate,"streamParameter.bitrate")}(t),(!t.width&&t.height||t.width&&!t.height)&&$b.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),$b.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,mC.LocalVideoLowTrack)}async enableDualStream(){if(!mR().supportDualStream)throw sy.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Uy(U_.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Uy(U_.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw sy.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,sy.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),$b.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(mC.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw sy.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,sy.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),$b.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(t){B_(t,"role",["audience","host"])}(t),e&&fE(e),"rtc"===this.mode)throw $b.warning("[".concat(this._clientId,"]rtc mode can not use setClientRole")),new Uy(U_.INVALID_OPERATION,"rtc mode can not use setClientRole");if(e&&e.level&&"host"===t)throw new Uy(U_.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===t&&this._p2pChannel.hasLocalMedia())throw new Uy(U_.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,e),this._config.role=t,$b.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}getRemoteInboundOffset(){var t;const e=null===(t=this._p2pChannel.getStats())||void 0===t?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const i=e.timestamp-Date.now();return Math.abs(i)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(G_(t,"proxyServer"),!e){if("DISCONNECTED"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Uy(U_.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,sy.setProxyServer(this._proxyServer),$b.setProxyServer(this._proxyServer),$b.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if("DISCONNECTED"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Uy(U_.INVALID_OPERATION,"You have already set the proxy")}if(mE(t))return this._turnServer={servers:t,mode:"original-manual"},void $b.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map((t=>t.urls)).join(","),"."));t.forEach((t=>gE(t))),this._turnServer={servers:t,mode:"manual"},$b.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if("DISCONNECTED"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"you should set license before join channel");if(G_(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new Uy(U_.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,$b.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if("DISCONNECTED"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new Uy(U_.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let i;switch(void 0===t&&(t=3),t){case 1:case 2:throw new Uy(U_.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new Uy(U_.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,$b.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Stop proxy server after leave channel");sy.setProxyServer(),$b.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",$b.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new Uy(U_.INVALID_PARAMS,"accessPoints is required.");W_(t.accessPoints.serverList,"accessPoints.serverList"),G_(t.accessPoints.domain,"accessPoints.domain");const e=(t,e)=>{j_(t,e,0,65535,!0)};let i=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),i=t.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Uy(U_.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");Db("CLOSE_AFB_FOR_LOCAL_AP")&&(Pb("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Pb("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,s=t.accessPoints.domain,o=t.accessPoints.serverList.map((t=>n.test(t)?"".concat(t.replace(/\./g,"-"),".").concat(s):t)),r=o.map((t=>"".concat(t,":").concat(i)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Pb("WEBCS_DOMAIN",r),Pb("WEBCS_DOMAIN_BACKUP_LIST",r),Pb("GATEWAY_DOMAINS",[s]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(W_(t.report.hostname,"report.hostname"),Pb("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Pb("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Pb("EVENT_REPORT_DOMAIN",o[0]),Pb("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),Pb("STATS_COLLECTOR_PORT",a),t.report?Pb("ENABLE_EVENT_REPORT",!0):Pb("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(W_(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),Pb("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(W_(t.cds.hostname,"cds.hostname"),l=t.cds.hostname):l=o;let h=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),h=t.cds.port),Pb("CDS_AP",l.map((t=>"".concat(t,":").concat(h)))),t.cds?Pb("ENABLE_CONFIG_DISTRIBUTE",!0):Pb("ENABLE_CONFIG_DISTRIBUTE",!1),$b.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(W_(t,"serverList"),G_(e,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Uy(U_.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map((t=>i.test(t)?"".concat(t.replace(/\./g,"-"),".").concat(e):t)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Pb("WEBCS_DOMAIN",t),Pb("WEBCS_DOMAIN_BACKUP_LIST",t),Pb("GATEWAY_DOMAINS",[e]),Pb("EVENT_REPORT_DOMAIN",t[0]),Pb("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Pb("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),$b.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(B_(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw $b.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else $b.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){B_(e,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout((()=>{const e=this._users.find((e=>e.uid===t));e&&e.videoTrack&&e.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(t){throw $b.error("[".concat(this._clientId,"] set remote video stream type error"),t.toString()),t}$b.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){B_(e,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(t){throw $b.error("[".concat(this._clientId,"] set stream fallback option"),t.toString()),t}$b.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,i){!function(t){B_(t,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])}(t),G_(e,"secret");const n=["aes-128-gcm2","aes-256-gcm2"];if(Ps(n).call(n,t)){if(!i||!(i instanceof Uint8Array&&32===i.length))throw new Uy(U_.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new Uy(U_.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(e)||$b.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=t,this._encryptionSecret=e,i&&(this._encryptionSalt=LE(i))}async renewToken(t){if(G_(t,"token",1,2047),!this._key||!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const i=await this._renewTokenMutex.lock();try{if(Db("USE_NEW_TOKEN")){$b.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const e=await fL(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||KE);$b.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:e})}else $b.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});$b.debug("[".concat(this._clientId,"] renewToken success"))}catch(t){throw this._key=e,this._joinInfo.token=e,$b.error("[".concat(this._clientId,"] renewToken failed"),t.toString()),t}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?$b.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(dE.VOLUME_INDICATOR,t)}),Db("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if("h264"!==this.codec)throw new Uy(U_.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Uy(U_.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new Uy(U_.LIVE_STREAMING_TASK_CONFLICT);const i=e?wy.TRANSCODE:wy.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(t,i)}setLiveTranscoding(t){return this._createLiveStreamingClient(wy.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((e=>e&&e.hasUrl(t)));if(!e.length)throw new Uy(U_.INVALID_PARAMS,"can not find live streaming url to stop");await e_.all(e.map((e=>e&&e.stopLiveStreamingTask(t))))}async addInjectStreamUrl(t,e){if(!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(wy.INJECT);i.setInjectStreamConfig(e,0),await i.startLiveStreamingTask(t,wy.INJECT)}async removeInjectStreamUrl(){var t;const e=this._createLiveStreamingClient(wy.INJECT),i=Array.from(Dy(t=e.streamingTasks).call(t)).find((t=>t.mode===wy.INJECT));if(!this._joinInfo||!i)throw new Uy(U_.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(t){IL(t);const e=this._createChannelMediaRelayClient();await e.startChannelMediaRelay(t)}async updateChannelMediaRelay(t){IL(t);const e=this._createChannelMediaRelayClient();await e.updateChannelMediaRelay(t)}async stopChannelMediaRelay(){const t=this._createChannelMediaRelayClient();await t.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof t||t instanceof Uint8Array)&&(t={payload:t}),"string"==typeof t.payload){const e=new TextEncoder;t.payload=e.encode(t.payload)}if(new Blob([t.payload]).size>1024)throw new Uy(U_.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(Ey.DATA_STREAM,{payload:LE(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-xM},!e)}sendMetadata(t){if(!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new Uy(U_.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Ey.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:LE(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(Kb),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"can not send custom report, not joined");await sy.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){B_(e.spatialLayer,"spatialLayer",[0,1,2,3]),B_(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(t){throw $b.error("[".concat(this._clientId,"] pick SVC layer failed"),t.toString()),t}}setRTM2Flag(t){if(B_(t,"flag",[0,1]),!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"Can't setRtm2Flag, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"Can't setRtm2Flag in ".concat(this.connectionState," state"));return this._gateway.setRTM2Flag(t)}_reset(){if($b.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=gb.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach((t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach((t=>t._close())),t._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new zE("client-publish"),this._subscribeMutex=new zE("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(t){}if(this._moderation)try{this.setImageModeration(!1)}catch(t){}}_startSession(t,e){const i=t||VE();t?$b.debug("[".concat(this._clientId,"] new Session ").concat(i)):$b.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i)),this._sessionId=i,this.store.sessionId=i,e?sy.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:e.channel,appid:e.appId,mode:this.mode}):this._joinInfo?sy.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._joinInfo.cname,appid:this._joinInfo.appId,mode:this.mode}):this._gateway.joinInfo&&sy.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId,mode:this.mode}),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(t){if(!this._joinInfo||void 0===this._uid)throw new Uy(U_.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Db("FORCE_TURN")&&!Db("TURN_ENABLE_TCP")&&!Db("TURN_ENABLE_UDP"))throw new Uy(U_.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");$b.debug("[".concat(this._clientId,"] publish high stream"));try{if(this._p2pChannel instanceof LM){const i=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(i)try{await this._gateway.sendExtensionMessage(AC.PUBLISH,i)}catch(e){throw this._p2pChannel.unpublish(t),e}}else{const i=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter),n=(await i.next()).value;if(n){var e;let s;try{s=await this._gateway.publish(this._uid,n,!0)}catch(t){if(t.code!==U_.DISCONNECT_P2P)throw i.throw(t),t}await i.next((null===(e=s)||void 0===e?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const e of t)e instanceof SI&&e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig),!e.muted&&e.enabled||await this._p2pChannel.muteLocalTrack(e)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,t),(null==e?void 0:e.code)===U_.WS_ABORT)return;throw e}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new Uy(U_.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Uy(U_.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));$b.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const t=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await t.next()).value;if(i){var e;let n;try{n=await this._gateway.publish(this._uid,i,!0)}catch(e){if(e.code!==U_.DISCONNECT_P2P)throw t.throw(e),e}t.next((null===(e=n)||void 0===e?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,void 0,!0),(null==t?void 0:t.code)===U_.WS_ABORT)return;throw t}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new Uy(U_.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const e=()=>new wL(this._joinInfo,this._config.websocketRetryConfig||KE,this._config.httpRetryConfig||KE),i=t=>{t.onLiveStreamError=(t,e)=>{sy.reportApiInvoke(this._sessionId,{name:oE.ON_LIVE_STREAM_ERROR,options:[t,e],tag:rE.TRACER}).onSuccess(),this.safeEmit(dE.LIVE_STREAMING_ERROR,t,e)},t.onLiveStreamWarning=(t,e)=>{sy.reportApiInvoke(this._sessionId,{name:oE.ON_LIVE_STREAM_WARNING,options:[t,e],tag:rE.TRACER}).onSuccess(),this.safeEmit(dE.LIVE_STREAMING_WARNING,t,e)},t.on(zy.REQUEST_WORKER_MANAGER_LIST,((t,e,i)=>{if(!this._joinInfo)return i(new Uy(U_.INVALID_OPERATION,"can not find join info to get worker manager"));mL(t,this._joinInfo,this._axiosCancelSource.token,KE).then(e).catch(i)}))};switch(t){case wy.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=e(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case wy.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=e(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case wy.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=e(),this._injectStreamingClient.on(zy.REQUEST_WORKER_MANAGER_LIST,((t,e,i)=>{if(!this._joinInfo)return i(new Uy(U_.INVALID_OPERATION,"can not find join info to get worker manager"));mL(t,this._joinInfo,this._axiosCancelSource.token,KE).then(e).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(t,e,i)=>{this.safeEmit(dE.INJECT_STREAM_STATUS,t,e,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new Uy(U_.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:e}=this.getLocalVideoStats(),i={width:t,height:e};this._channelMediaRelayClient=new OL(this._joinInfo,this._clientId,this._config.websocketRetryConfig||KE,this._config.httpRetryConfig||KE,i),this._channelMediaRelayClient.on("state",(t=>{t===Xy.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(dE.CHANNEL_MEDIA_RELAY_STATE,t)})),this._channelMediaRelayClient.on("event",(t=>{this.safeEmit(dE.CHANNEL_MEDIA_RELAY_EVENT,t)})),this._statsCollector.onStatsChanged=(t,e)=>{var i;"resolution"===t&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(e))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:i,deleted:n}=t,s=[];Array.isArray(i)&&i.length>0&&i.forEach((t=>{const{uid:i,stream_id:n,ordered:o,max_retrans_times:r,metadata:a}=t,c=this._users.find((t=>t._uintid===i));if(c){if($b.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(i)),Ps(s).call(s,c)||s.push(c),c._uintid||(c._uintid=i),-1===c._dataChannels.findIndex((e=>e.id===t.stream_id))){const t={id:n,ordered:!!o,maxRetransmits:r,metadata:a},i=new sk(t);c._dataChannels.push(i),$b.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published datachannel")),e||this.safeEmit(dE.USER_PUBLISHED,c,"datachannel",t)}this._p2pChannel.hasPendingRemoteDataChannel(c,t.stream_id)&&($b.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(c.uid," after reconnect.")),this._subscribeDataChannel(c,t.stream_id).catch((t=>{$b.error("[".concat(this._clientId,"] resubscribe datachannel error"),t.toString())})))}else $b.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"))})),e&&(this.safeEmit(dE.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(n)&&n.length>0&&n.forEach((t=>{const{uid:e,stream_id:i}=t,n=this._users.find((t=>t._uintid===e));if(!n)return void $b.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const s=n._dataChannels.find((e=>e.id===t.stream_id));s&&($b.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(e)),this._p2pChannel.unsubscribeDataChannel(n,[s]).then((t=>{if(t)return n._dataChannels=n._dataChannels.filter((t=>t!==s)),this._gateway.unsubscribeDataChannel(t,n.uid)})),$b.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished datachannel ,id:").concat(s.id)),this.safeEmit(dE.USER_UNPUBLISHED,n,"datachannel",s._config))}))}_handleRemoveDataChannels(t){const e=this._users.find((e=>e.uid===t.uid));if(e){if(void 0!==e._dataChannels&&e._dataChannels.length>0){$b.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const i=()=>{$b.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach((t=>{this.safeEmit(dE.USER_UNPUBLISHED,e,"datachannel",t._config)}))};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then((t=>{if(t)return this._gateway.unsubscribeDataChannel(t,e.uid)})),i()}}else $b.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(tC.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(tC.CONNECTION_STATE_CHANGE,((t,e,i)=>{var n;if(i===cE.FALLBACK)return;const s=()=>{this.safeEmit(dE.CONNECTION_STATE_CHANGE,t,e,i)};if(sy.reportApiInvoke(this._sessionId||(null===(n=this._gateway.joinInfo)||void 0===n?void 0:n.sid)||null,{name:oE.CONNECTION_STATE_CHANGE,options:[t,e,i],tag:rE.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:i})),$b.info("[".concat(this._clientId,"] connection state change: ").concat(e," -> ").concat(t)),"DISCONNECTED"===t)return this._reset(),void s();if("RECONNECTING"===t)this._users.forEach((t=>{t._trust_in_room_=!1,t._trust_audio_enabled_state_=!1,t._trust_video_enabled_state_=!1,t._trust_audio_mute_state_=!1,t._trust_video_mute_state_=!1,t._trust_audio_stream_added_state_=!1,t._trust_video_stream_added_state_=!1,t._audioSSRC=void 0,t._videoSSRC=void 0,t._videoOrtc=void 0,t._audioOrtc=void 0,t._cname=void 0,t._rtxSsrcId=void 0})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===t){var o;this._streamFallbackTypeCacheMap.forEach(((t,e)=>{this._gateway.setStreamFallbackOption(e,t).catch((t=>{$b.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),t)}))})),this._remoteStreamTypeCacheMap.forEach(((t,e)=>{this._gateway.setRemoteVideoStreamType(e,t).catch((t=>{$b.warning("[".concat(this._clientId,"] auto set remote stream type failed"),t)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(o=this._joinInfo)||void 0===o?void 0:o.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{$b.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((t=>{$b.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(t))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter((t=>!t._trust_in_room_)).forEach((t=>{$b.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(t.uid)),this._handleUserOffline({uid:t.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((t=>{t._trust_audio_mute_state_||($b.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(t.uid)),this._handleMuteStream(t.uid,hC.AUDIO,!1)),t._trust_video_mute_state_||($b.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(t.uid)),this._handleMuteStream(t.uid,hC.VIDEO,!1)),t._trust_audio_enabled_state_||($b.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(t.uid)),this._handleSetStreamLocalEnable("audio",t.uid,!0)),t._trust_video_enabled_state_||($b.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(t.uid)),this._handleSetStreamLocalEnable("video",t.uid,!0)),t._trust_video_stream_added_state_||($b.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(t.uid)),this._handleResetAddStream(t,"video")),t._trust_audio_stream_added_state_||($b.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(t.uid)),this._handleResetAddStream(t,"audio")),t._video_added_||t._audio_added_||($b.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(t.uid)),this._handleRemoveStream({uid:t.uid,uint_id:t._uintid}))})))}),1e3))}s()})),this._gateway.on(tC.REQUEST_NEW_GATEWAY_LIST,((t,e)=>{if(!this._joinInfo)return e(new Uy(U_.UNEXPECTED_ERROR,"can not recover, no join info"));dL(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||KE,this.store).then((e=>{this._joinInfo&&(this._joinInfo.apResponse=e.gatewayInfo.res,this._joinInfo.gatewayAddrs=e.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=e.gatewayInfo.uni_lbs_ip);const i=[];e.gatewayInfo.gatewayAddrs.forEach((t=>{let{address:e}=t;const[n,s]=e.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:n,port:s}):i.push({host:n,port:s})})),t(i)})).catch(e)})),this._gateway.on(tC.NETWORK_QUALITY,(t=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(dE.NETWORK_QUALITY,t)})),this._gateway.on(tC.STREAM_TYPE_CHANGE,((t,e)=>{this.safeEmit(dE.STREAM_TYPE_CHANGED,t,e),sy.reportApiInvoke(this._sessionId,{name:oE.STREAM_TYPE_CHANGE,options:[t,e],tag:rE.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))})),this._gateway.on(tC.IS_P2P_DISCONNECTED,(t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)})),this._gateway.on(tC.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(tC.REQUEST_P2P_CONNECTION_PARAMS,(async(t,e,i)=>{try{e(await this._p2pChannel.startP2PConnection(t))}catch(t){i(t)}})),this._gateway.on(tC.JOIN_RESPONSE,((t,e)=>{if(this.store.useP2P)return;const{dtlsParameters:i,iceParameters:n,candidates:s,rtpCapabilities:o,setup:r,cname:a}=XL(t.ortc,e);this._p2pChannel.connect(n,i,s,o,r,a)})),this._gateway.on(tC.REQUEST_DC_CONNECTION_PARAMS,(t=>{t(this._p2pChannel.getEstablishParams())})),this._gateway.on(tC.RESET_SIGNAL,(t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents()})),this._gateway.on(tC.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(tC.DATACHANNEL_PRECONNECT,(async(t,e,i,n)=>{var s,o,r,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:null===(s=this._joinInfo)||void 0===s?void 0:s.turnServer},!0);const l=function(t,e){let i;return e&&e.ip&&"number"==typeof e.port?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],$b.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),$b.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],i}(t,e);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(o=this._joinInfo)||void 0===o?void 0:o.apResponse.cid,"_").concat(null===(r=this._joinInfo)||void 0===r?void 0:r.apResponse.cert),icePwd:"".concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cid,"_").concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(d=Db("FINGERPRINT"))&&void 0!==d?d:t.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(i).catch(n)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(Ty.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Ty.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Ty.ON_ADD_AUDIO_STREAM,(t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc))),this._gateway.signal.on(Ty.ON_ADD_VIDEO_STREAM,(t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId))),this._gateway.signal.on(Ty.ON_REMOTE_DATASTREAM_UPDATE,(t=>{this._handleUpdateDataChannel(t)})),this._gateway.signal.on(Ty.ON_REMOTE_FULL_DATASTREAM_INFO,(t=>{this._handleUpdateDataChannel({added:t.datastreams,deleted:[]},!0)})),this._gateway.signal.on(Ty.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Ty.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Ty.MUTE_AUDIO,(t=>this._handleMuteStream(t.uid,hC.AUDIO,!0))),this._gateway.signal.on(Ty.UNMUTE_AUDIO,(t=>this._handleMuteStream(t.uid,hC.AUDIO,!1))),this._gateway.signal.on(Ty.MUTE_VIDEO,(t=>this._handleMuteStream(t.uid,hC.VIDEO,!0))),this._gateway.signal.on(Ty.UNMUTE_VIDEO,(t=>this._handleMuteStream(t.uid,hC.VIDEO,!1))),this._gateway.signal.on(Ty.RECEIVE_METADATA,(t=>{const e=kE(t.metadata);this.safeEmit(dE.RECEIVE_METADATA,t.uid,e)})),this._gateway.signal.on(Ty.ON_DATA_STREAM,(async t=>{if(!t)return;let e=0;if(t.ordered||t.syncWithAudio){const i=this._p2pChannel.getStats(),n=this.remoteUsers.find((e=>e.uid===t.uid)),s=null==i?void 0:i.audioRecv.find((t=>t.ssrc===(null==n?void 0:n._audioSSRC)));e=null==s?void 0:s.jitterBufferMs}null==e&&(e=0),HM(t,e,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(Ty.ON_CRYPT_ERROR,(()=>{NE((()=>{$b.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(dE.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(Ty.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Ty.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{$b.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,cE.TOKEN_EXPIRE),this.safeEmit(dE.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(Ty.ON_STREAM_FALLBACK_UPDATE,(t=>{$b.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(dE.STREAM_FALLBACK,t.stream_id,1===t.stream_type?"fallback":"recover")})),this._gateway.signal.on(Ty.ON_PUBLISH_STREAM,(t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),$b.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))})),this._gateway.signal.on(Ty.ENABLE_LOCAL_VIDEO,(t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)})),this._gateway.signal.on(Ty.DISABLE_LOCAL_VIDEO,(t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)})),this._gateway.signal.on(_y.REQUEST_TIMEOUT,((t,e)=>{if(this._joinInfo)switch(t){case Ey.PUBLISH:{if(!e)return;const t=e.ortc;if(t){var i,n;const s=t.some((t=>{let{stream_type:e}=t;return e===Qy.Audio})),o=t.some((t=>{let{stream_type:e}=t;return e!==Qy.Audio})),r=t.some((t=>{let{stream_type:e}=t;return e===Qy.Screen||e===Qy.ScreenLow}));"offer"===e.state&&sy.publish(this._joinInfo.sid,{eventElapse:ck.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:U_.TIMEOUT,audio:s,video:o,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:r,audioName:s?null===(i=t.find((t=>{let{stream_type:e}=t;return e===Qy.Audio})))||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId.toString():void 0,videoName:o?null===(n=t.find((t=>{let{stream_type:e}=t;return e!==Qy.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0})}break}case Ey.SUBSCRIBE:e&&sy.subscribe(this._joinInfo.sid,{succ:!1,ec:U_.TIMEOUT,audio:e.stream_type===hC.AUDIO,video:e.stream_type===hC.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:ck.measureFromSubscribeStart(this.store.clientId,e.ssrcId)})}})),this._gateway.signal.on(Ty.ON_P2P_OK,(t=>{this.uid,this._uid})),this._gateway.signal.on(Ty.ON_PUBLISHED_USER_LIST,(t=>{if(null==t||!t.users)return;Db("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter((t=>!dy(t.string_id||t.stream_id,this.channelName))));const e=[],i=[];for(const n of t.users){let t=this._users.find((t=>t._uintid===n.stream_id));t?t._trust_in_room_=!0:(t=new NL(n.string_id||n.stream_id,n.stream_id),this._users.push(t),0===this.getListeners(dE.PUBLISHED_USER_LIST).length&&($b.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.safeEmit(dE.USER_JOINED,t)));const s=iC.Audio&n.stream_type,o=(iC.Video|iC.LwoVideo)&n.stream_type,r=0!=(65280&n.stream_type),a=s&&t.hasAudio,c=o&&t.hasVideo;o&&(t._trust_video_stream_added_state_=!0,t._video_added_=!0,t._videoSSRC=n.video_ssrc,t._rtxSsrcId=n.video_rtx),s&&(t._trust_audio_stream_added_state_=!0,t._audio_added_=!0,t._audioSSRC=n.audio_ssrc),s&&!a&&0===this.getListeners(dE.PUBLISHED_USER_LIST).length&&($b.info("[".concat(this._clientId,"] remote user ").concat(t.uid," published audio")),this.safeEmit(dE.USER_PUBLISHED,t,"audio")),o&&!c&&0===this.getListeners(dE.PUBLISHED_USER_LIST).length&&($b.info("[".concat(this._clientId,"] remote user ").concat(t.uid," published video")),this.safeEmit(dE.USER_PUBLISHED,t,"video")),(s&&!a||o&&!c||r)&&e.push(t),o&&this._p2pChannel.hasPendingRemoteMedia(t,"video")&&i.push({user:t,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(t,"audio")&&i.push({user:t,mediaType:"audio"})}i.length>0&&($b.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map((t=>"user: ".concat(t.user.uid,", mediaType: ").concat(t.mediaType))).join("; ")," ")),this.massSubscribe(i).catch((t=>{$b.error("[".concat(this._clientId,"] mass resubscribe error"),t.toString())}))),this.getListeners(dE.PUBLISHED_USER_LIST).length>0?Db("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:($b.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map((t=>t.uid)).join(", "))),this.safeEmit(dE.PUBLISHED_USER_LIST,e)):$b.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map((t=>t.uid)).join(", ")))})),this._gateway.signal.on(Ty.ON_RTP_CAPABILITY_CHANGE,(t=>{const{video_codec:e}=t;this._p2pChannel instanceof mD&&this._p2pChannel.updateRemoteRTPCapabilities(e.map((t=>t.toLowerCase())).filter((t=>{var e;return Ps(e=Object.keys(xb)).call(e,t)})))}))}_handleP2PEvents(){this._gateway.signal.on(Ty.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(AC.PUBLISH,(async(t,e)=>{t.forEach((t=>t.kind===hC.VIDEO?(this._handleP2PAddAudioOrVideoStream("video",e),t.isMuted?this._handleMuteStream(e,hC.VIDEO,!0):this._handleMuteStream(e,hC.VIDEO,!1)):(this._handleP2PAddAudioOrVideoStream("audio",e),t.isMuted?this._handleMuteStream(e,hC.AUDIO,!0):this._handleMuteStream(e,hC.AUDIO,!1))))})),this._gateway.signal.on(_y.P2P_START,(async(t,e)=>{var i;this._p2pChannel instanceof LM&&e(await this._p2pChannel.startP2P({turnServer:null===(i=this._joinInfo)||void 0===i?void 0:i.turnServer},t))})),this._gateway.signal.on(_y.P2P_CONNECTION,(async t=>{this._p2pChannel instanceof LM&&await this._p2pChannel.p2pConnect(t)})),this._gateway.signal.on(_y.P2P_REMOTE_CANDIDATE_UPDATE,(t=>{this._p2pChannel instanceof LM&&this._p2pChannel.addRemoteCandidate(JSON.parse(t))})),this._gateway.signal.on(AC.SUBSCRIBE,(async(t,e,i)=>{if(this._p2pChannel instanceof LM){const{trackType:n}=JSON.parse(t);try{await this._p2pChannel.dopublish(n),e()}catch(t){i(t)}}})),this._gateway.signal.on(AC.UNSUBSCRIBE,(async(t,e,i)=>{if(this._p2pChannel instanceof LM){const{mediaType:n}=JSON.parse(t);try{await this._p2pChannel.doUnpublish(n),e()}catch(t){i(t)}}})),this._gateway.signal.on(AC.EXCHANGE_SDP,(async(t,e,i)=>{if(this._p2pChannel instanceof LM){const{type:n,sdp:s}=JSON.parse(t);try{e(await this._p2pChannel.setDescription(n,s))}catch(t){i(t)}}})),this._gateway.signal.on(AC.UNPUBLISH,(async(t,e,i)=>{if(this._p2pChannel instanceof LM){const{unpubMsg:n,uid:s}=t;if(1===n.length){const o=n[0].stream_type===Qy.Audio?hC.AUDIO:hC.VIDEO;this._handleMuteStream(s,o,!0);const{sdp:r}=t;if(this._p2pChannel instanceof LM&&r){const t=this._users.find((t=>t.uid===s));if(!t)return $b.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(s)),void e();this._p2pChannel.unsubscribe(t,r,o).then((t=>{t&&e(t)})).catch(i)}else e()}else this._handleRemoveStream(t,e,i)}})),this._gateway.signal.on(AC.CONTROL,(async(t,e,i)=>{const{action:n,sdp:s,isMuteAll:o,uid:r}=t;switch(n){case OC.MUTE_LOCAL_VIDEO:this._handleMuteStream(r,hC.VIDEO,!0,s,e,i);break;case OC.MUTE_LOCAL_AUDIO:e(),this._handleMuteStream(r,hC.AUDIO,!0);break;case OC.UNMUTE_LOCAL_VIDEO:e(),this._handleP2PAddAudioOrVideoStream("video",r),this._handleMuteStream(r,hC.VIDEO,!1);break;case OC.UNMUTE_LOCAL_AUDIO:e(),this._handleP2PAddAudioOrVideoStream("audio",r),this._handleMuteStream(r,hC.AUDIO,!1)}o&&this._handleRemoveStream(t,e,i)})),this._gateway.signal.on(AC.DO_SUBSCRIBE,(async(t,e,i)=>{if(this._p2pChannel instanceof LM){const{kind:n,sdp:s,ssrcId:o,uid:r}=t,a=this._users.find((t=>t.uid===r));if(!a)return $b.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)")),void e();try{e(await this._p2pChannel.subscribe(a,n,s,o))}catch(t){i(t)}}})),this._gateway.signal.on(AC.DO_UNSUBSCRIBE,(async(t,e,i)=>{if(this._p2pChannel instanceof LM){const{uid:n,kind:s,sdp:o}=t,r=this._users.find((t=>t.uid===n));if(!r)return $b.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)")),void e();try{e(await this._p2pChannel.unsubscribe(r,o,s))}catch(t){i(t)}}})),this._gateway.signal.on(AC.RESTART_ICE,(async(t,e,i)=>{if(this._p2pChannel instanceof LM)try{e(await this._p2pChannel.setDescription("remote",t))}catch(t){i(t)}})),this._p2pChannel.on(fC.RequestP2PRestartICE,(async(t,e,i)=>{try{e(await this._gateway.sendExtensionMessage(AC.RESTART_ICE,t))}catch(t){i(t)}})),this._p2pChannel.on(fC.LocalCandidate,(t=>{this._gateway.sendExtensionMessage(AC.CANDIDATE,JSON.stringify(t))})),this._p2pChannel.on(fC.RequestP2PMuteLocal,(async(t,e,i)=>{try{e(await this._gateway.sendExtensionMessage(AC.CONTROL,t))}catch(t){i(t)}})),this._p2pChannel.on(fC.RequestP2PPublish,(async(t,e,i)=>{try{e(await this._gateway.sendExtensionMessage(AC.DO_SUBSCRIBE,t))}catch(t){i(t)}})),this._p2pChannel.on(fC.RequestP2PUnPublish,(async(t,e,i)=>{try{e(await this._gateway.sendExtensionMessage(AC.DO_UNSUBSCRIBE,t))}catch(t){i(t)}})),this._p2pChannel.on(fC.RequestP2PUnmuteRemote,(async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(t){t.code===U_.DISCONNECT_P2P?e():i(t)}else e()})),this._p2pChannel.on(fC.RequestP2PMuteRemote,(async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(t){t.code===U_.DISCONNECT_P2P?e():i(t)}else e()})),this._p2pChannel.on(fC.StateChange,((t,e)=>{e===gC.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(fC.RequestMuteLocal,(async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(t){t.code===U_.DISCONNECT_P2P?e():i(t)}else e()})),this._p2pChannel.on(fC.RequestUnmuteLocal,(async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(t){t.code===U_.DISCONNECT_P2P?e():i(t)}else e()})),this._p2pChannel.on(fC.RequestRePublish,((t,e,i)=>{this.publish(t,!1).then(e).catch(i)})),this._p2pChannel.on(fC.RequestRePublishDataChannel,((t,e,i)=>{e_.all(t.map((async t=>{await this._p2pChannel.publishDataChannel([t]);const e={streamId:t.id,ordered:t.ordered,maxRetransmits:t.maxRetransmits,metadata:t.metadata,channelId:t._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,e,!0)}catch(t){if(t.code!==U_.DISCONNECT_P2P)throw t}}))).then(e).catch(i)})),this._p2pChannel.on(fC.RequestReSubscribe,(async(t,e,i)=>{try{for(const{user:e,kind:i}of t)i===hC.VIDEO?await this.subscribe(e,"video"):await this.subscribe(e,"audio");e()}catch(t){i(t)}})),this._p2pChannel.on(fC.RequestUploadStats,((t,e)=>{this._gateway.uploadStats(t,e)})),this._p2pChannel.on(fC.MediaReconnectStart,(t=>{this.safeEmit(dE.MEDIA_RECONNECT_START,t)})),this._p2pChannel.on(fC.MediaReconnectEnd,(t=>{this.safeEmit(dE.MEDIA_RECONNECT_END,t)})),this._p2pChannel.on(fC.NeedSignalRTT,(t=>{t(this._gateway.getSignalRTT())})),this._p2pChannel.on(fC.RequestRestartICE,(async t=>{if(this._p2pChannel instanceof LM)return;const e=await this._p2pChannel.restartICE(t),i=await e.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(t){return void e.throw(t)}const{iceParameters:o}=function(t){const e=t.iceParameters;return{iceParameters:{iceUfrag:e.iceUfrag,icePwd:e.icePwd}}}(s);await e.next({remoteIceParameters:o})})),this._p2pChannel.on(fC.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(fC.RequestReconnectPC,(async()=>{var t;const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(t=this._joinInfo)||void 0===t?void 0:t.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:r,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:h}=XL(s,o);await this._p2pChannel.connect(a,r,c,d,l,h),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(fC.RequestUnpublishForReconnectPC,(async(t,e,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(t,this._uid),e()):i()})),this._p2pChannel.on(fC.P2PLost,(()=>{this.safeEmit(dE.P2P_LOST,this.store.uid)})),this._p2pChannel.on(fC.UpdateVideoEncoder,(t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)})),this._p2pChannel.on(fC.ConnectionTypeChange,(t=>{this.safeEmit(dE.IS_USING_CLOUD_PROXY,t)})),this._p2pChannel.on(fC.RequestLowStreamParameter,(t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(fC.QueryClientConnectionState,(t=>{t(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new Uy(U_.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new Uy(U_.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const e=[...new Set(t.inspectType)];e.forEach((t=>{var e;if(!Ps(e=["supervise","moderation"]).call(e,t))throw new Uy(U_.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(t," is not a valid inspect type."))})),t.inspectType=e}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new Uy(U_.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const e=new $D(t);this._inspect=e,this.handleVideoInspectEvents(this._inspect),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},KE)}catch(t){throw Array.isArray(t)?t[0]:t}}async disableContentInspect(){if(!this._inspect)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(F_(t,"enabled"),t){if(!e)throw new Uy(U_.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(j_(e.interval,"interval",1e3,1/0),"CONNECTED"!==this.connectionState||!this._joinInfo)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(e);const t=new CM(e);this._moderation=t,this.handleImageModerationEvents(this._moderation),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},KE)}catch(t){throw Array.isArray(t)?t[0]:t}}else{if(!this._moderation)throw new Uy(U_.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}}handleImageModerationEvents(t){t.on(RC.CONNECTION_STATE_CHANGE,((e,i)=>{if(this.safeEmit(dE.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,i),e===wC.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new Uy(U_.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}})),t.on(RC.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((t=>"video"===t.trackMediaType))[0])}))}handleVideoInspectEvents(t){t.on(SC.CONNECTION_STATE_CHANGE,((e,i)=>{if(this.safeEmit(dE.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,i),i===_C.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(dE.CONTENT_INSPECT_ERROR,new Uy(U_.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}})),t.on(SC.INSPECT_RESULT,((t,e)=>{var i;if((null==e?void 0:e.code)===U_.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return $b.debug("Stop inspect content because that has left channel"),null==this||null===(i=this._inspect)||void 0===i||i.close(),void(this._inspect=void 0);this.safeEmit(dE.CONTENT_INSPECT_RESULT,t,e)})),t.on(SC.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((t=>"video"===t.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return $b.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){F_(t,"enabled"),Pb("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}}My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],qM.prototype,"leave",null),My([ny({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof iR))return[e];e=[e]}return e.map((t=>t?Object(t).toString():"null"))}}),xy("design:type",Function),xy("design:paramtypes",[Object,Boolean]),xy("design:returntype",e_)],qM.prototype,"publish",null),My([ny({argsMap:(t,e)=>(e||(e=[]),e instanceof ok?[e.getChannelId()]:(Array.isArray(e)||(e=[e]),e.map((t=>t.getTrackId()))))}),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],qM.prototype,"unpublish",null),My([ny({argsMap:(t,e,i,n)=>[e.uid,i,n]}),xy("design:type",Function),xy("design:paramtypes",[NL,String,Number]),xy("design:returntype",e_)],qM.prototype,"subscribe",null),My([ny({argsMap:(t,e)=>e.map((t=>{let{user:e,mediaType:i}=t;return[null==e?void 0:e.uid,i]}))}),xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],qM.prototype,"massSubscribe",null),My([ny({argsMap:(t,e,i,n)=>[e.uid,i,n]}),xy("design:type",Function),xy("design:paramtypes",[NL,String,Number]),xy("design:returntype",e_)],qM.prototype,"unsubscribe",null),My([ny({argsMap:(t,e)=>e.map((t=>{let{user:e,mediaType:i}=t;return{uid:null==e?void 0:e.uid,mediaType:i}}))}),xy("design:type",Function),xy("design:paramtypes",[Array]),xy("design:returntype",e_)],qM.prototype,"massUnsubscribe",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],qM.prototype,"setLowStreamParameter",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],qM.prototype,"enableDualStream",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],qM.prototype,"disableDualStream",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[String,Object]),xy("design:returntype",e_)],qM.prototype,"setClientRole",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[String,Boolean]),xy("design:returntype",void 0)],qM.prototype,"setProxyServer",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object,Boolean]),xy("design:returntype",void 0)],qM.prototype,"setTurnServer",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",void 0)],qM.prototype,"setLicense",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Number]),xy("design:returntype",void 0)],qM.prototype,"startProxyServer",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],qM.prototype,"stopProxyServer",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",void 0)],qM.prototype,"setLocalAccessPointsV2",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Array,String]),xy("design:returntype",void 0)],qM.prototype,"setLocalAccessPoints",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Number]),xy("design:returntype",e_)],qM.prototype,"setRemoteDefaultVideoStreamType",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object,Number]),xy("design:returntype",e_)],qM.prototype,"setRemoteVideoStreamType",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object,Number]),xy("design:returntype",e_)],qM.prototype,"setStreamFallbackOption",null),My([ny({argsMap:(t,e)=>[e]}),xy("design:type",Function),xy("design:paramtypes",[String,String,Uint8Array]),xy("design:returntype",void 0)],qM.prototype,"setEncryptionConfig",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],qM.prototype,"renewToken",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",void 0)],qM.prototype,"enableAudioVolumeIndicator",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[String,Boolean]),xy("design:returntype",e_)],qM.prototype,"startLiveStreaming",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],qM.prototype,"setLiveTranscoding",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[String]),xy("design:returntype",e_)],qM.prototype,"stopLiveStreaming",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[String,Object]),xy("design:returntype",e_)],qM.prototype,"addInjectStreamUrl",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],qM.prototype,"removeInjectStreamUrl",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[RL]),xy("design:returntype",e_)],qM.prototype,"startChannelMediaRelay",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[RL]),xy("design:returntype",e_)],qM.prototype,"updateChannelMediaRelay",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],qM.prototype,"stopChannelMediaRelay",null),My([ny({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],qM.prototype,"sendCustomReportMessage",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object,Object]),xy("design:returntype",e_)],qM.prototype,"pickSVCLayer",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Number]),xy("design:returntype",e_)],qM.prototype,"setRTM2Flag",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Object]),xy("design:returntype",e_)],qM.prototype,"enableContentInspect",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",e_)],qM.prototype,"disableContentInspect",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Boolean,Object]),xy("design:returntype",e_)],qM.prototype,"setImageModeration",null),My([ny({reportResult:!0}),xy("design:type",Function),xy("design:paramtypes",[]),xy("design:returntype",Array)],qM.prototype,"getJoinChannelServiceRecords",null),My([ny(),xy("design:type",Function),xy("design:paramtypes",[Boolean]),xy("design:returntype",e_)],qM.prototype,"setPublishAudioFilterEnabled",null);class KM{constructor(t,e){nu(this,"id",0),nu(this,"element",void 0),nu(this,"peerPair",void 0),nu(this,"context",void 0),nu(this,"audioPlayerElement",void 0),nu(this,"audioTrack",void 0),KM.count+=1,this.id=KM.count,this.element=t,this.context=e}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const e=document.createElement("audio");e.srcObject=new MediaStream([t.track]),e.play(),this.audioPlayerElement=e}}async switchSdp(){if(!this.peerPair)return;const t=async(t,e)=>{const i="offer"===e?await t.createOffer():await t.createAnswer();return await t.setLocalDescription(i),"complete"===t.iceGatheringState?t.localDescription:new e_((e=>{t.onicegatheringstatechange=()=>{"complete"===t.iceGatheringState&&e(t.localDescription)}}))},e=async(t,e)=>await t.setRemoteDescription(e);try{const i=await t(this.peerPair[0],"offer");await e(this.peerPair[1],i);const n=await t(this.peerPair[1],"answer");await e(this.peerPair[0],n)}catch(t){throw new Uy(U_.LOCAL_AEC_ERROR,t.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let e;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),e=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(e)}catch(t){throw new Uy(U_.LOCAL_AEC_ERROR,t.toString()).print()}if(!e)throw new Uy(U_.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=e.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,e=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(e),await this.switchSdp()}close(){$b.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((t=>{t.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}nu(KM,"count",0);const YM=window.AudioContext||window.webkitAudioContext;class JM{constructor(){nu(this,"units",[]),nu(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return $b.debug("the system does not need to process local aec"),-1;this.context||(this.context=new YM);let e=this.units.find((e=>e&&e.getElement()===t));return e||(e=new KM(t,this.context),this.units.push(e)),e.startEchoCancellation(),$b.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return p_().name!==c_.SAFARI}}My([ny({report:sy}),xy("design:type",Function),xy("design:paramtypes",[HTMLAudioElement]),xy("design:returntype",Number)],JM.prototype,"processExternalMediaAEC",null);const XM=new JM;function ZM(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function QM(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ZM(Object(i),!0).forEach((function(e){nu(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ZM(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}const tx=window||document;function ex(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!tx)return;const i=ix._cspEventHandlerPointer;if(i&&e)return void console.error(i,e);const n=t=>{if(!(t&&t.blockedURI&&(ix.onSecurityPolicyViolation||ix.getListeners(yC.SECURITY_POLICY_VIOLATION).length>0)))return;const e=t.blockedURI;Db("CSP_DETECTED_HOSTNAME_LIST").some((t=>Ps(e).call(e,t)))&&(ix.onSecurityPolicyViolation&&"function"==typeof ix.onSecurityPolicyViolation&&ix.onSecurityPolicyViolation(t),ix.getListeners(yC.SECURITY_POLICY_VIOLATION).length>0&&ix.safeEmit(yC.SECURITY_POLICY_VIOLATION,t))};i&&tx.removeEventListener("securitypolicyviolation",i),(e||t&&"function"==typeof t||ix.getListeners(yC.SECURITY_POLICY_VIOLATION).length>0)&&tx.addEventListener("securitypolicyviolation",n),ix._cspEventHandlerPointer=n}Pb("PROCESS_ID","process-".concat(UE(8,""),"-").concat(UE(4,""),"-").concat(UE(4,""),"-").concat(UE(4,""),"-").concat(UE(12,""))),function(){const t=p_();pR.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),pR.getStreamFromExtension=t.name===c_.CHROME&&Number(t.version)>34,pR.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let e=!1;try{t.addTransceiver("audio"),e=!0}catch(t){}return t.close(),e}(),pR.supportMinBitrate=t.name===c_.CHROME||t.name===c_.EDGE,pR.supportSetRtpSenderParameters=function(){const t=p_();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!D_()||!(!S_()&&!f_())||t.name===c_.FIREFOX&&Number(t.version)>=64)}(),t.name===c_.SAFARI&&(Number(t.version)>=14?pR.supportDualStream=!0:pR.supportDualStream=!1),pR.webAudioMediaStreamDest=function(){const t=p_();return!(t.name===c_.SAFARI&&Number(t.version)<12)}(),pR.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,pR.supportWebGL="undefined"!=typeof WebGLRenderingContext,pR.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,D_()||(pR.webAudioWithAEC=!0),pR.supportShareAudio=function(){const t=p_();return(t.os===a_.WIN_10||t.os===a_.WIN_81||t.os===a_.WIN_7||t.os===a_.LINUX||t.os===a_.MAC_OS)&&t.name===c_.CHROME&&Number(t.version)>=74}(),pR.supportDataChannel=!!(y_(76)||function(t){const e=p_();return!(e.name!==c_.FIREFOX||!e.osVersion)&&Number(e.version)>=t}(68)||function(t){const e=p_();return!(e.name!==c_.SAFARI||!e.osVersion)&&Number(e.version)>=t}(14)),pR.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!T_()&&!!t&&t.prototype.setConfiguration instanceof Function}(),pR.supportWebRTCEncodedTransform=function(){const t=p_();return"Chrome"===t.name&&Number(t.version)>=86}(),pR.supportWebRTCInsertableStream=function(){const t=p_();return(t.name===c_.CHROME||t.name===c_.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),RE((()=>{pR.supportDualStreamEncoding=function(){const t=p_();return!!Db("DISABLE_WEBAUDIO")||"Safari"===t.name&&Number(t.version)>=14||!!("Chrome"===t.name&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&Db("CHROME_DUAL_STREAM_USE_ENCODING"))}(),$b.info("browser compatibility",JSON.stringify(pR),JSON.stringify(t))}))}(),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void $b.error("Error loading sdk config",t.message)}if(t)try{const e=JSON.parse(window.atob(t)),i=Date.now();$b.debug("Loading global parameters from cache",e),Object.keys(e).forEach((t=>{if(Object.prototype.hasOwnProperty.call(Lb,t)){const{value:n,expires:s}=e[t];if(s&&s<=i)return;Mb[t]=n,Lb[t]=n}}))}catch(e){$b.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(Mb.AREAS)&&Mb.AREAS.length>0&&qk(Mb.AREAS,!0);const ix=function(t){const e=new iE,i=t,n={getListeners:e.getListeners.bind(e),on:(t,i)=>(function(t,e){t===yC.SECURITY_POLICY_VIOLATION&&ex(e,!0)}(t,i),e.on.bind(e)(t,i)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return QM(QM({},i),n)}({__TRACK_LIST__:kw,VERSION:Ob,BUILD:kb,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:(t,e,i)=>{$b.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Pb(t,e,i)},getParameter:Db,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection;e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});const i=(await e.createOffer()).sdp;if(!i)return t;e.close(),e=null,t=function(t){const e={video:[],audio:[]};return t.match(/ VP8/i)&&e.video.push("VP8"),t.match(/ VP9/i)&&e.video.push("VP9"),t.match(/ AV1/i)&&e.video.push("AV1"),t.match(/ H264/i)&&e.video.push("H264"),t.match(/ H265/i)&&e.video.push("H265"),t.match(/ opus/i)&&e.audio.push("OPUS"),t.match(/ PCMU/i)&&e.audio.push("PCMU"),t.match(/ PCMA/i)&&e.audio.push("PCMA"),t.match(/ G722/i)&&e.audio.push("G722"),e}(i)}catch(t){throw new Uy(U_.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return t},checkSystemRequirements:function(){const t=sy.reportApiInvoke(null,{name:oE.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:rE.TRACER});let e=!1;try{const t=window.RTCPeerConnection,i=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,n=window.WebSocket;e=!!(t&&i&&n)}catch(t){return $b.error("check system requirement failed: ",t),!1}let i=!1;const n=p_();n.name===c_.CHROME&&Number(n.version)>=58&&(!__()||v_())&&(i=!0),n.name===c_.FIREFOX&&Number(n.version)>=56&&(i=!0),n.name===c_.OPERA&&Number(n.version)>=45&&(i=!0),n.name===c_.SAFARI&&Number(n.version)>=11&&(i=!0),(L_()||p_().name===c_.QQ)&&(i=!0),$b.debug("checkSystemRequirements, api:",e,"browser",i);const s=e&&i;return t.onSuccess(s),s},getDevices:function(t){return OR.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return OR.getRecordingDevices(t)},getCameras:function(t){return OR.getCamerasDevices(t)},getElectronScreenSources:SR,getPlaybackDevices:function(t){return OR.getSpeakers(t)},createClient:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const e=sy.reportApiInvoke(null,{name:oE.CREATE_CLIENT,options:[t],tag:rE.TRACER});try{!function(t){B_(t.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),B_(t.mode,"config.mode",["rtc","live"]),void 0!==t.audioCodec&&B_(t.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==t.proxyServer&&G_(t.proxyServer,"config.proxyServer",1,1e4),void 0!==t.turnServer&&gE(t.turnServer),void 0!==t.httpRetryConfig&&pE(t.httpRetryConfig),void 0!==t.websocketRetryConfig&&pE(t.websocketRetryConfig)}(t)}catch(t){throw e.onError(t),t}return WM()||("vp9"===t.codec&&(t.codec="vp8",$b.debug("browser not support vp9, force use vp8")),Pb("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===t.audioCodec&&(t.audioCodec="opus"),e.onSuccess(),new qM(zM(zM({forceWaitGatewayResponse:!0},t),{},{role:"rtc"===t.mode?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CREATE_CAM_VIDEO_TRACK,options:[yI({},t)]}),i=iI(t),n=UE(8,"track-cam-");let s=null;const o="720p_auto"===t.encoderConfig;$b.info("start create camera video track with config",JSON.stringify(t),"trackId",n);try{s=(await wR({video:i},n)).getVideoTracks()[0]||null}catch(t){throw e.onError(t),t}if(!s){const t=new V_(U_.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(t),t.throw($b)}t.optimizationMode&&CI(n,s,t,Rw(t.encoderConfig));const r=new TI(s,t,i,t.scalabiltyMode?Aw(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n);return o&&r.startMonitorStats(),e.onSuccess(r.getTrackId()),$b.info("create camera video success, trackId:",n),r},createCustomVideoTrack:function(t){const e=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),i=new SI(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Aw(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,UE(8,"track-cus-"),[Dw.CUSTOM_TRACK]);return e.onSuccess(i.getTrackId()),$b.info("create custom video track success with config",t,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable";const i=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CREATE_SCREEN_VIDEO_TRACK,options:[yI({},t),e]}),n="720p_auto"===t.encoderConfig;t.encoderConfig?"string"==typeof t.encoderConfig||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const s=function(t){const e={};t.screenSourceType&&(e.mediaSource=t.screenSourceType),t.extensionId&&E_()&&(e.extensionId=t.extensionId);const{displaySurface:i,selfBrowserSurface:n,surfaceSwitching:s,systemAudio:o}=t;(y_(107)||C_(107)||w_(93))&&(i&&(B_(i,"displaySurface",["browser","window","monitor"]),e.displaySurface=i),n?(B_(n,"selfBrowserSurface",["exclude","include"]),e.selfBrowserSurface=n):e.selfBrowserSurface="include",s&&(B_(s,"surfaceSwitching",["exclude","include"]),e.surfaceSwitching=s)),(y_(105)||C_(105)||w_(91))&&o&&(B_(o,"systemAudio",["exclude","include"]),e.systemAudio=o),t.electronScreenSourceId&&(e.sourceId=t.electronScreenSourceId);const r=t.encoderConfig?Iw(t.encoderConfig):null;return e.mandatory={chromeMediaSource:"desktop",maxWidth:r?r.width:void 0,maxHeight:r?r.height:void 0},r&&(r.frameRate&&("number"==typeof r.frameRate?(e.mandatory.maxFrameRate=r.frameRate,e.mandatory.minFrameRate=r.frameRate):(e.mandatory.maxFrameRate=r.frameRate.max||r.frameRate.ideal||r.frameRate.exact||void 0,e.mandatory.minFrameRate=r.frameRate.min||r.frameRate.ideal||r.frameRate.exact||void 0),e.frameRate=r.frameRate),r.width&&(e.width=r.width),r.height&&(e.height=r.height)),e}(t),o=UE(8,"track-scr-v-");let r=null,a=null;const c=mR();if(!c.supportShareAudio&&"enable"===e){const t=new V_(U_.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(t),t.throw($b)}$b.info("start create screen video track with config",t,"withAudio",e,"trackId",o);try{const t=await wR({screen:s,screenAudio:"auto"===e?c.supportShareAudio:"enable"===e},o);r=t.getVideoTracks()[0]||null,a=t.getAudioTracks()[0]||null}catch(t){throw i.onError(t),t}if(!r){const t=new V_(U_.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(t),t.throw($b)}if(!a&&"enable"===e){r&&r.stop();const t=new V_(U_.SHARE_AUDIO_NOT_ALLOWED);return i.onError(t),t.throw($b)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(CI(o,r,t,t.encoderConfig&&Iw(t.encoderConfig)||void 0),t.encoderConfig&&"string"!=typeof t.encoderConfig&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const d=new SI(r,t.encoderConfig?Iw(t.encoderConfig):{},t.scalabiltyMode?Aw(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,o,[Dw.SCREEN_TRACK]);if(n&&d.startMonitorStats(),!a)return i.onSuccess(d.getTrackId()),$b.info("create screen video track success","video:",d.getTrackId()),d;const l=new ZR(a,void 0,UE(8,"track-scr-a-"),!1,!0);return i.onSuccess([d.getTrackId(),l.getTrackId()]),$b.info("create screen video track success","video:",d.getTrackId(),"audio:",l.getTrackId()),[d,l]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CREATE_MIC_AND_CAM_TRACKS,options:[t,e]}),n="720p_auto"===e.encoderConfig,s=iI(e),o=nI(t),r=UE(8,"track-mic-"),a=UE(8,"track-cam-");let c=null,d=null;$b.info("start create camera video track(".concat(a,") and microphone audio track(").concat(r,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{const t=await wR({audio:o,video:s},"".concat(r,"-").concat(a));c=t.getAudioTracks()[0],d=t.getVideoTracks()[0]}catch(t){throw i.onError(t),t}if(!c||!d){const t=new V_(U_.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(t),t.throw($b)}e.optimizationMode&&CI(a,d,e,Rw(e.encoderConfig));const l=new QR(c,t,o,r),h=new TI(d,e,s,e.scalabiltyMode?Aw(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,a);return n&&h.startMonitorStats(),i.onSuccess([l.getTrackId(),h.getTrackId()]),$b.info("create camera video track(".concat(a,") and microphone audio track(").concat(r,") success")),[l,h]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CREATE_MIC_AUDIO_TRACK,options:[t]}),i=nI(t),n=UE(8,"track-mic-");let s=null;$b.info("start create microphone audio track with config",JSON.stringify(t),"trackId",n);try{s=(await wR({audio:i},n)).getAudioTracks()[0]||null}catch(t){throw e.onError(t),t}if(!s){const t=new V_(U_.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(t),t.throw($b)}const o=new QR(s,t,i,n);return e.onSuccess(o.getTrackId()),$b.info("create microphone audio track success, trackId:",n),o},createCustomAudioTrack:function(t){const e=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),i=new ZR(t.mediaStreamTrack,t.encoderConfig?Nw(t.encoderConfig):{},UE(8,"track-cus-"),!1,!0);return $b.info("create custom audio track success with config",t,"trackId",i.getTrackId()),e.onSuccess(i.getTrackId()),i},createBufferSourceAudioTrack:async function(t){var e;const{cacheOnlineFile:i,encoderConfig:n}=t;let{source:s}=t;const o={source:s instanceof AudioBuffer?"AudioBuffer":s instanceof File?null!==(e=File.name)&&void 0!==e?e:"File":s,cacheOnlineFile:i,encoderConfig:n},r=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(Db("DISABLE_WEBAUDIO"))throw new V_(U_.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const a=UE(8,"track-buf-");$b.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",a);const c=s;if(!(s instanceof AudioBuffer))try{s=await rI(s,i)}catch(t){return r.onError(t),t.throw($b)}const d=new sI(s),l=new tI(c,d,n?Nw(n):{},a);return $b.info("create buffer source audio track success, trackId:",a),r.onSuccess(l.getTrackId()),l},setAppType:function(t){if($b.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw $b.debug("Invalid appType"),new Uy(U_.INVALID_PARAMS,"invalid app type",t);Pb("APP_TYPE",Math.floor(t))},setLogLevel:function(t){$b.setLogLevel(t)},enableLogUpload:function(){Db("USE_NEW_LOG")?Pb("UPLOAD_LOG",!0):$b.enableLogUpload()},disableLogUpload:function(){Db("USE_NEW_LOG")?Pb("UPLOAD_LOG",!1):$b.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new RL},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof ZR||t instanceof OI)){const t=new Uy(U_.INVALID_TRACK,"the parameter is not a audio track");return i.onError(t),t.throw()}e&&e<1e3&&(e=1e3);const n=t instanceof ZR?t.getTrackLabel():"remote_track",s=t.getVolumeLevel();let o=s,r=s;const a=Date.now();return new e_((s=>{const c=setInterval((()=>{const d=t.getVolumeLevel();o=d>o?d:o,r=d<r?d:r;const l=o-r>1e-4,h=Date.now()-a;if(l||h>e){clearInterval(c);const e=l,r={duration:h,deviceLabel:n,maxVolumeLevel:o,result:e};$b.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(r))),i.onSuccess(r),s(e)}}),200)}))},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=sy.reportApiInvoke(null,{tag:rE.TRACER,name:oE.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof SI||t instanceof AI)){const t=new Uy(U_.INVALID_TRACK,"the parameter is not a video track");return i.onError(t),t.throw()}e&&e<1e3&&(e=1e3);const n=t instanceof SI?t.getTrackLabel():"remote_track",s=t.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(S_()||f_())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([s]),o.play();const r=document.createElement("canvas");r.width=160,r.height=120;let a=0,c=0;try{const t=Date.now();a=await function(t,e,i,n){let s,o=0,r=null;return new e_(((a,c)=>{function d(){o>n&&s&&(s(),a(o));const e=i.getContext("2d");if(!e){const t=new Uy(U_.UNEXPECTED_ERROR,"can not get canvas 2d context.");return $b.error(t.toString()),void c(t)}e.drawImage(t,0,0,160,120);const d=e.getImageData(0,0,i.width,i.height),l=Math.floor(d.data.length/3);if(r){for(let t=0;t<l;t+=3)if(d.data[t]!==r[t])return o+=1,void(r=d.data);r=d.data}else r=d.data}setTimeout((()=>{s&&(s(),a(o))}),e),s=uR((()=>{d()}),30)}))}(o,e,r,4),c=Date.now()-t}catch(t){throw i.onError(t),t}GM===c_.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;const d=a>4,l={duration:c,changedPicNum:a,deviceLabel:n,result:d};return $b.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),i.onSuccess(l),d},setArea:qk,audioElementPlayCenter:UR,processExternalMediaAEC:function(t){XM.processExternalMediaAEC(t)},registerExtensions:function(t){t.forEach((t=>{const e=t;e.__registered__=!0,e.logger.hookLog=$b.extLog,e.reporter.hookApiInvoke=sy.extApiInvoke,e.parameters&&Object.keys(e.parameters).forEach((t=>{e.parameters[t]=Db(t)}))}))},ChannelMediaRelayError:Zy,ChannelMediaRelayEvent:Jy,ChannelMediaRelayState:Xy,RemoteStreamFallbackType:Uw,RemoteStreamType:xw,ConnectionDisconnectedReason:cE,AudienceLatencyLevelType:aE,AREAS:sC});return Object.defineProperties(ix,{onAudioAutoplayFailed:{get:()=>kR.onAudioAutoplayFailed,set:t=>{kR.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>kR.onAutoplayFailed,set:t=>{kR.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>ix._onSecurityPolicyViolation,set(t){ix._onSecurityPolicyViolation=t,ex(t)}},__CLIENT_LIST__:{get:()=>Db("SHOW_GLOBAL_CLIENT_LIST")?cy:[]}}),OR.on(Xw.CAMERA_DEVICE_CHANGED,(t=>{$b.info("camera device changed",JSON.stringify(t)),ix.onCameraChanged&&ix.onCameraChanged(t),ix.safeEmit(yC.CAMERA_CHANGED,t)})),OR.on(Xw.RECORDING_DEVICE_CHANGED,(t=>{$b.info("microphone device changed",JSON.stringify(t)),ix.onMicrophoneChanged&&ix.onMicrophoneChanged(t),ix.safeEmit(yC.MICROPHONE_CHANGED,t)})),OR.on(Xw.PLAYOUT_DEVICE_CHANGED,(t=>{$b.debug("playout device changed",JSON.stringify(t)),ix.onPlaybackDeviceChanged&&ix.onPlaybackDeviceChanged(t),ix.safeEmit(yC.PLAYBACK_DEVICE_CHANGED,t)})),UR.onAutoplayFailed=()=>{$b.info("detect audio element autoplay failed"),kR.onAudioAutoplayFailed&&kR.onAudioAutoplayFailed()},rR.on("autoplay-failed",(()=>{$b.info("detect webaudio autoplay failed"),kR.onAudioAutoplayFailed&&kR.onAudioAutoplayFailed(),ix.safeEmit(yC.AUTOPLAY_FAILED)})),TE.on(uE.NETWORK_STATE_CHANGE,((t,e)=>{$b.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))})),window&&(window.__ARTC__=ix),ix}()}(Di);var Mi=Pi(Di.exports);const xi="unknown",Ui="ios",Vi="android",Fi="windowsPhone",Bi="vrHeadset";class ji{static get platform(){return this.platform_||(this.platform_=this.getDevicePlatform()),this.platform_}static get isIOS(){return-1!==["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].indexOf(navigator.platform)||-1!==navigator.userAgent.indexOf("Mac")&&"ontouchend"in document}static get isVRHeadset(){return-1!==navigator.userAgent.indexOf("VR")||-1!==navigator.userAgent.indexOf("Quest")||-1!==navigator.userAgent.indexOf("Oculus")}static getDevicePlatform(){const t=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(t)?Fi:/android/i.test(t)?Vi:this.isIOS?Ui:this.isVRHeadset?Bi:xi}}const Hi=1,Gi=2,Wi=3,$i=4,zi=5;class qi{static setLevel(t){this.level_=t}static getLevel(){return x.flags.production?Hi:this.level_}static error(){this.getLevel()>=Hi&&console.error(...arguments)}static warn(){this.getLevel()>=Gi&&console.warn(...arguments)}static info(){this.getLevel()>=Wi&&console.info(...arguments)}static log(){this.getLevel()>=$i&&console.log(...arguments)}}qi.level_=zi;class Ki{static delete(t){this.isSessionStorageSupported()&&window.sessionStorage.removeItem(t)}static exist(t){if(this.isSessionStorageSupported())return void 0!==window.sessionStorage[t]}static get(t){let e=null;if(this.isSessionStorageSupported()&&void 0!==window.sessionStorage[t])try{e=JSON.parse(window.sessionStorage[t])}catch(e){console.log("SessionStorageService.get.error parsing",t,e)}return e}static set(t,e){if(this.isSessionStorageSupported())try{const i=[],n=JSON.stringify(e,(function(t,e){if("object"==typeof e&&null!==e){if(-1!==i.indexOf(e))return;i.push(e)}return e}));window.sessionStorage.setItem(t,n)}catch(i){console.log("SessionStorageService.set.error serializing",t,e,i)}}static isSessionStorageSupported(){if(this.supported)return!0;let t=!1;try{t="sessionStorage"in window&&null!==window.sessionStorage,t?(window.sessionStorage.setItem("test","1"),window.sessionStorage.removeItem("test")):t=!1}catch(e){t=!1}return this.supported=t,t}}class Yi{constructor(t,e,i){void 0===i&&(i=!1),this.user=t,this.mediaType=e,this.isLocal=i,this.clientInfo=null,this.texture=null,this.element=null,this.parentNode=null}get streamId(){return this.user?.uid.toString()}get hasScreen(){return this.user?.hasScreen}get hasVideo(){return this.user?.hasVideo}get hasAudio(){return this.user?.hasAudio}get videoTrack(){return this.user?.videoTrack}get audioTrack(){return this.user?.audioTrack}get video(){return!!this.videoTrack}get audio(){return!!this.audioTrack}get userMuteVideo(){return!!this.videoTrack&&this.videoTrack.muted}get userMuteAudio(){return!!this.audioTrack&&this.audioTrack.muted}getTracks(){const t=[];return this.user.hasVideo&&t.push(this.videoTrack),this.user.hasAudio&&t.push(this.audioTrack),t}async muteVideo(){this.videoTrack&&await this.videoTrack.setMuted(!0)}async unmuteVideo(){this.videoTrack&&await this.videoTrack.setMuted(!1)}async muteAudio(){this.audioTrack&&await this.audioTrack.setMuted(!0)}async unmuteAudio(){this.audioTrack&&await this.audioTrack.setMuted(!1)}getAudioLevel(){return this.audioTrack?this.audioTrack.getVolumeLevel():0}isPlaying(){return this.videoTrack?.isPlaying||this.audioTrack?.isPlaying}play(t,e){for(void 0===e&&(e=null),e=e||this.mediaType;t.childElementCount>0;)t.removeChild(t.firstElementChild);this.parentNode=t,"video"===e?(this.videoTrack.play(t,{fit:"cover",mirror:void 0}),this.element=t.firstElementChild,qi.log("Stream.play.videoTrack",t,this.element)):this.audioTrack&&!this.isLocal&&this.audioTrack.play()}stop(){this.videoTrack&&this.videoTrack.isPlaying&&this.videoTrack.stop(),this.audioTrack&&this.audioTrack.isPlaying&&this.audioTrack.stop()}close(){this.videoTrack&&this.videoTrack.close(),this.audioTrack&&this.audioTrack.close()}update(t){this.user=t.user,this.mediaType=t.mediaType}resume(t){qi.log("Stream.resume",t,this.element),this.element&&t.appendChild(this.element)}published(t,e){this.user=t,this.mediaType=e,this.parentNode&&this.play(this.parentNode,e)}unpublished(t,e){switch(this.user=t,e){case"video":t.videoTrack?.stop();break;case"audio":t.audioTrack?.stop()}}}const Ji="client",Xi="editor";class Zi{static set editorStreams(t){this.editorStreams$.next(t)}static get editorStreams(){return this.editorStreams$.getValue()}static set editorScreens(t){this.editorScreens$.next(t)}static get editorScreens(){return this.editorScreens$.getValue()}static set local(t){this.local$.next(t)}static get local(){return this.local$.getValue()}static set screen(t){this.screen$.next(t)}static get screen(){return this.screen$.getValue()}static set remotes(t){this.remotes$.next(t)}static get remotes(){return this.remotes$.getValue()}static set peers(t){this.peers$.next(t)}static get peers(){return this.peers$.getValue()}static orderedRemotes$(){return i.combineLatest([Zi.remotes$,i.interval(1e3)]).pipe(n.map((t=>{const e=[];return t[0].forEach((t=>{let i=null,n=null,s=null,o=0,r=0,a=0;t.clientInfo&&(o=t.clientInfo.audioLevel=t.getAudioLevel(),r=t.clientInfo.peekAudioLevel=Math.max(t.clientInfo.audioLevel,.2),a=t.clientInfo.order,i=t.clientInfo.role||null,n=t.clientInfo.uid||null,s=t.clientInfo.screenUid||null),e.push({role:i,uid:n,screenUid:s,audioLevel:o,peekAudioLevel:r,order:a,remote:t})})),e.sort(((t,e)=>{const i=t.role===ie.Publisher?2:t.role===ie.Attendee?1:0;return(e.role===ie.Publisher?2:e.role===ie.Attendee?1:0)-i||e.peekAudioLevel-t.peekAudioLevel||(t.order||0)-(e.order||0)})),e.forEach(((t,e)=>{t.remote.clientInfo&&(t.remote.clientInfo.order=e)})),e})),n.distinctUntilChanged(((t,e)=>t.map((t=>`${t.uid}-${t.screenUid}`)).join("|")===e.map((t=>`${t.uid}-${t.screenUid}`)).join("|"))),n.map((t=>t.map((t=>t.remote)))))}static getEditorStreams$(){return i.of(null).pipe(n.switchMap((()=>{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&this.mode===Xi){const t=document.querySelector("body"),e=document.createElement("div"),i=document.createElement("video");e.setAttribute("id","stream-editor"),e.setAttribute("style","position:absolute; top: 5000px; line-height: 0;"),e.appendChild(i),t.appendChild(e),navigator.mediaDevices.getUserMedia({video:{width:800,height:450}}).then((t=>{"srcObject"in i?i.srcObject=t:i.src=window.URL.createObjectURL(t),i.oncanplay=()=>{const t={streamId:"editor",clientInfo:{role:ie.Publisher,uid:"editor"}},e={streamId:"editor",clientInfo:{role:ie.Attendee,uid:"editor"}},i={streamId:"editor",clientInfo:{role:ie.SmartDevice,uid:"editor"}};this.editorStreams$.next([t,e,e,e,e,i])},i.play()})).catch((t=>{console.log("EditorComponent.getUserMedia.error",t.name,t.message)}))}return this.editorStreams$})),n.shareReplay(1))}static getEditorScreens$(){return i.of(null).pipe(n.switchMap((()=>{if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia&&this.mode===Xi){const t=document.querySelector("body"),e=document.createElement("div"),i=document.createElement("video");e.setAttribute("id","stream-editor-screen"),e.setAttribute("style","position:absolute; top: 5000px; line-height: 0;"),e.appendChild(i),t.appendChild(e),navigator.mediaDevices.getDisplayMedia({screen:{width:800,height:450}}).then((t=>{"srcObject"in i?i.srcObject=t:i.src=window.URL.createObjectURL(t),i.oncanplay=()=>{const t={streamId:"editor-screen",clientInfo:{role:ie.Publisher,uid:"editor",screenUid:"editor-screen"}},e={streamId:"editor-screen",clientInfo:{role:ie.Attendee,uid:"editor",screenUid:"editor-screen"}};this.editorScreens$.next([t,e])},i.play()})).catch((t=>{console.log("EditorComponent.getUserMedia.error",t.name,t.message)}))}return this.editorScreens$})),n.shareReplay(1))}static get publisherStreamId(){const t=this.remotes.slice(),e=this.local;e&&t.unshift(e);const i=t.find((t=>t.clientInfo&&t.clientInfo.role===ie.Publisher&&t.clientInfo.uid===t.streamId));return i?i.streamId:null}static getPublisherStreamId$(){const t=this.publisherStreamId;return t?i.of(t):this.streams$.pipe(n.map((()=>this.publisherStreamId)),n.filter((t=>t)))}static get attendeeStreamId(){const t=this.remotes.slice(),e=this.local;e&&t.unshift(e);const i=t.find((t=>t.clientInfo&&t.clientInfo.role===ie.Attendee&&t.clientInfo.uid===t.streamId));return i?i.streamId:null}static getAttendeeStreamId$(){const t=this.attendeeStreamId;return t?i.of(t):this.streams$.pipe(n.map((()=>this.attendeeStreamId)),n.filter((t=>t)))}static getRemoteById(t){const e=Zi.remotes.find((e=>e.streamId===t));if(e)return e}static remoteAdd(t){const e=this.remotes.slice();e.find((e=>e.streamId===t.streamId))||(e.push(t),this.remotes=e)}static remoteRemove(t){const e=this.remotes.slice(),i=e.find((e=>e.streamId===t));return i&&(i.stop(),e.splice(e.indexOf(i),1),this.remotes=e),i}static remoteSetClientInfo(t,e){const i=this.remotes,n=i.find((e=>e.streamId===t));n&&(n.clientInfo=e),this.remotes=i}}Zi.mode=Ji,Zi.editorStreams$=new i.BehaviorSubject(null),Zi.editorScreens$=new i.BehaviorSubject(null),Zi.local$=new i.BehaviorSubject(null),Zi.screen$=new i.BehaviorSubject(null),Zi.remotes$=new i.BehaviorSubject([]),Zi.peers$=new i.BehaviorSubject([]),Zi.streams$=i.combineLatest([Zi.local$,Zi.screen$,Zi.remotes$,Zi.getEditorStreams$(),Zi.getEditorScreens$()]).pipe(n.map((t=>{const e=t[0],i=t[1],n=t[2],s=t[3],o=t[4];let r=n;return e&&(r=r.slice(),r.push(e)),i&&(r=r.slice(),r.push(i)),s&&r.push(...s),o&&r.push(...o),r})),n.shareReplay(1));class Qi extends class{constructor(){this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}once(t,e){const i=n=>{e(n),this.off(t,i)};this.on(t,i)}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}has(t){const e=this.events[t];return e&&e.length}}{constructor(t){if(Qi.AGORA)throw"AgoraService is a singleton";super(),this.previousMuteAudio_=!1,this.channelState={},this.channelSnapshot={},this.onException=this.onException.bind(this),this.onUserJoined=this.onUserJoined.bind(this),this.onUserLeft=this.onUserLeft.bind(this),this.onUserPublished=this.onUserPublished.bind(this),this.onUserUnpublished=this.onUserUnpublished.bind(this),this.onUserInfoUpdated=this.onUserInfoUpdated.bind(this),this.onVolumeIndicator=this.onVolumeIndicator.bind(this),this.onConnectionStateChange=this.onConnectionStateChange.bind(this),this.onTokenPrivilegeWillExpire=this.onTokenPrivilegeWillExpire.bind(this),this.onTokenPrivilegeDidExpire=this.onTokenPrivilegeDidExpire.bind(this),this.onMessage=this.onMessage.bind(this);const e=ee.state;ee.patchState({devices:e.role!==ie.Attendee&&t?t:{videos:[],audios:[]},quality:Se(e),membersCount:0})}get isHostRole(){return ee.state.role===ie.Publisher||ee.state.role===ie.Attendee}get isAudienceRole(){return ee.state.role===ie.Viewer||ee.state.role===ie.SelfService}addStreamDevice(t){this.removeStreamDevice();const e={deviceId:"video-stream",label:"videostream",kind:"videostream",src:t},i={deviceId:"audio-stream",label:"videostream",kind:"videostream",src:t},n=ee.state.devices;n.videos.push(e),n.audios.push(i),ee.patchState({devices:n})}removeStreamDevice(){const t=ee.state.devices;t.videos=t.videos.filter((t=>"videostream"!==t.kind)),t.audios=t.audios.filter((t=>"videostream"!==t.kind)),ee.patchState({devices:t})}devices$(){const t=ee.state.devices,e=this.defaultVideos=this.defaultVideos||t.videos.slice(),n=this.defaultAudios=this.defaultAudios||t.videos.slice();t.videos=e.slice(),t.audios=n.slice();return i.from((async()=>{const e=await Mi.createCameraVideoTrack(),i=await Mi.createMicrophoneAudioTrack(),n=await Qi.getDevices();e.close(),i.close();for(let e=0;e<n.length;e++){const i=n[e];"videoinput"===i.kind&&i.deviceId&&t.videos.push({label:i.label||"camera-"+t.videos.length,deviceId:i.deviceId,kind:i.kind}),"audioinput"===i.kind&&i.deviceId&&t.audios.push({label:i.label||"microphone-"+t.audios.length,deviceId:i.deviceId,kind:i.kind})}if(t.videos.length>0||t.audios.length>0)return t;throw t})())}async connect(t){if(!ee.state.connecting){const e=ee.state.devices;t&&(e.video=t.video,e.audio=t.audio),ee.patchState({status:Ae,connecting:!0,devices:e}),setTimeout((async()=>{await this.createClient();const t=this.getChannelNameLink();await this.join(t)}),250)}return ee.state$}connect$(t){return i.from(this.connect(t)).pipe(n.switchMap((()=>ee.state$)))}membersCount$(t){const e=this.messageClient;return i.interval(3e3).pipe(n.switchMap((()=>i.from(e.getChannelMemberCount([t])))),n.map((e=>e[t])),n.catchError((t=>(qi.error("AgoraService.membersCount$.error",t),i.of(0)))),n.distinctUntilChanged())}observeMemberCount(){this.unobserveMemberCount(),this.isHostRole&&(this.membersCountSubscription=this.membersCount$(ee.state.channelNameLink).subscribe((t=>{ee.patchState({membersCount:t})})))}unobserveMemberCount(){this.membersCountSubscription&&(this.membersCountSubscription.unsubscribe(),this.membersCountSubscription=null,ee.patchState({membersCount:0}))}async createClient(){if(this.client)return this.client;try{Mi.setLogLevel(2);const t=this.client=Mi.createClient({mode:"live",codec:"h264"});t.on("exception",this.onException),t.on("user-joined",this.onUserJoined),t.on("user-left",this.onUserLeft),t.on("user-published",this.onUserPublished),t.on("user-unpublished",this.onUserUnpublished),t.on("user-info-updated",this.onUserInfoUpdated),t.on("onTokenPrivilegeWillExpire",this.onTokenPrivilegeWillExpire),t.on("onTokenPrivilegeDidExpire",this.onTokenPrivilegeDidExpire);(this.messageClient=AgoraRTM.createInstance(x.appKey,{logFilter:AgoraRTM.LOG_FILTER_OFF})).setParameters({logFilter:AgoraRTM.LOG_FILTER_OFF}),qi.log("AgoraService.createClient","client initialized"),await t.setClientRole(this.isAudienceRole?"audience":"host"),x.flags.useProxy&&(t.startProxyServer(3),qi.log("AgoraService.createClient.startProxyServer"))}catch(t){qi.error("AgoraService.createClient.error",t),this.client=null}return this.client}getChannelNameLink(){let t=ee.state.link||"";const e=t.match(/(\d{9})-(\d{4})-(\d{13})/);e&&(t=`${e[1]}-${e[3]}`);return`${ee.state.channelName}-${t}`}async join(t){this.channel=null;const e=Qi.resolveUserId(),i=await Qi.rtmToken$(e).toPromise();try{await this.joinRtmChannel(i.token,t,e);const n=await Qi.rtcToken$(t).toPromise();await this.joinRtcChannel(n.token,t,e)}catch(t){qi.error("AgoraService.join.joinRtmChannel.error",t)}}async joinRtcChannel(t,e,i){try{if(qi.log("AgoraService.joinRtcChannel",t,e,i),await this.client.join(x.appKey,e,t,i),ee.patchState({status:Oe,channelNameLink:e,connected:!0,uid:i}),Qi.storeUserId(i),!this.isAudienceRole){const t=await this.autoDetectDevice();await this.createMediaStream(i,t.video,t.audio)}this.observeMemberCount()}catch(t){if(qi.error("AgoraService.joinRtcChannel.error",t),"DYNAMIC_KEY_EXPIRED"===t){const t=await Qi.rtcToken$(e).toPromise();await this.joinRtcChannel(t.token,e,i)}}}joinRtmChannel(t,e,i){let n;return qi.log("AgoraService.joinRtmChannel",t,e,i),new Promise(((s,o)=>{const r=this.messageClient;r.login({token:t,uid:i}).then((()=>(qi.log("AgoraService.joinRtmChannel.login.success"),n=r.createChannel(e),n.join()))).then((()=>{this.channel=n,n.on("ChannelMessage",this.onMessage),this.emit("channel",n),s(i),qi.log("AgoraService.joinRtmChannel.join.success"),n.getMembers().then((t=>{t=t.filter((t=>t!==i));const e={type:Le,members:t};this.broadcastMessage(e),qi.log("AgoraService.joinRtmChannel.members",e)})),qi.log("AgoraService.joinRtmChannel.success",e)})).catch((t=>{qi.error("AgoraService.joinRtmChannel.error",t),o(t)}))}))}detectDevices(t){Qi.getDevices().then((e=>{const i=[],n=[];for(let t=0;t<e.length;t++){const s=e[t];"videoinput"==s.kind&&i.push({label:s.label||"camera-"+i.length,deviceId:s.deviceId,kind:s.kind}),"audioinput"==s.kind&&n.push({label:s.label||"microphone-"+i.length,deviceId:s.deviceId,kind:s.kind})}t({videos:i,audios:n})})).catch((t=>{qi.error("AgoraService.detectDevices",t)}))}getVideoOptions(t,e){return new Promise(((i,n)=>{if(e)if("videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";var s=new Hls;s.attachMedia(n),s.on(Hls.Events.MEDIA_ATTACHED,(()=>{s.loadSource(e.src),s.on(Hls.Events.MANIFEST_PARSED,((e,s)=>{n.play().then((e=>{const s=n.captureStream();t.videoSource=s.getVideoTracks()[0],i(t)}),(t=>{qi.error("AgoraService.getVideoOptions.error",t)}))}))}))}else if("videoplayer"===e.kind||"videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";const s=n.captureStream();t.videoSource=s.getVideoTracks()[0],i(t)}else t.cameraId=e.deviceId,i(t);else i(t)}))}getAudioOptions(t,e){return new Promise(((i,n)=>{if(e)if("videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";var s=new Hls;s.attachMedia(n),s.on(Hls.Events.MEDIA_ATTACHED,(()=>{s.loadSource(e.src),s.on(Hls.Events.MANIFEST_PARSED,((e,o)=>{s.loadLevel=o.levels.length-1,n.play().then((e=>{const s=n.captureStream();t.audioSource=s.getAudioTracks()[0],i(t)}),(t=>{qi.error("AgoraService.getAudioOptions.error",t)}))}))}))}else if("videoplayer"===e.kind||"videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";const s=n.captureStream();t.audioSource=s.getAudioTracks()[0],i(t)}else t.microphoneId=e.deviceId,i(t);else i(t)}))}async autoDetectDevice(){const t=ee.state;if(t.role===ie.SmartDevice){const t=await Qi.getDevices(),e={videos:[],audios:[],video:null,audio:null};return t.forEach((t=>{"videoinput"===t.kind?e.videos.push(t):"audioinput"===t.kind&&e.audios.push(t)})),e.video=e.videos[0]||null,e.audio=e.audios[0]||null,ee.patchState({devices:e}),e}return t.devices}async createMediaStream(t,e,i){const n={streamID:t,video:Boolean(e),audio:Boolean(i),screen:!1};await this.getVideoOptions(n,e),await this.getAudioOptions(n,i);const s=Object.assign({},ee.state.quality);await this.createLocalStreamWithOptions(n,s)}async createLocalStreamWithOptions(t,e){try{let i,n;qi.log("AgoraService.createLocalStreamWithOptions",t,e),t.video&&(i=await Mi.createCameraVideoTrack({cameraId:t.cameraId,encoderConfig:e.profile})),t.audio&&(n=await Mi.createMicrophoneAudioTrack({microphoneId:t.microphoneId}));const s={uid:t.streamID,videoTrack:i,audioTrack:n,hasVideo:void 0!==i,hasAudio:void 0!==n},o=new Yi(s,t.video?"video":"audio",!0);Zi.local=o,setTimeout((async()=>{await this.publishLocalStream()}),1),qi.log("AgoraService.createLocalStreamWithOptions.success",o)}catch(t){qi.error("AgoraService.createLocalStreamWithOptions.error",t)}}async publishLocalStream(){try{qi.log("AgoraService.publishLocalStream");const t=Zi.local,e=this.client;await e.publish(t.getTracks());const i=await this.setUserState();t.clientInfo=i,Zi.local=t}catch(t){throw qi.error("AgoraService.publishLocalStream.error",t),t}}async unpublishLocalStream(){try{qi.log("AgoraService.unpublishLocalStream");const t=this.client,e=Zi.local;e&&await t.unpublish(e.getTracks()),await this.clearLocalUserAttributes(),Zi.local=null}catch(t){throw qi.error("AgoraService.unpublishLocalStream.error",t),t}}async closeLocalStream(){try{const t=Zi.local;t&&await t.close(),await this.clearLocalUserAttributes(),Zi.local=null,qi.log("AgoraService.closeLocalStream",t)}catch(t){throw qi.error("AgoraService.closeLocalStream.error",t),t}}async leaveChannel(){try{ee.patchState({connecting:!1}),await this.closeLocalStream(),await this.closeScreenStream(),Zi.remotes=[],Zi.peers=[],await this.leaveMessageChannel(),await this.leaveClient(),await this.leaveScreenClient()}catch(t){throw qi.error("AgoraService.leaveChannel.error",t),t}}leaveClient(){return new Promise(((t,e)=>{const i=this.client;i?i.leave((()=>{this.client=null,x.flags.useProxy&&(i.stopProxyServer(),qi.log("AgoraService.leaveClient.stopProxyServer")),t()}),(t=>{qi.error("AgoraService.leaveClient.error",t),e(t)})):t()}))}leaveMessageChannel(){return new Promise(((t,e)=>{this.unobserveMemberCount();const i=this.channel;if(!i)return t();const n=this.messageClient;i.leave().then((()=>{this.channel=null,n.logout().then((()=>{this.messageClient=null,t()}),e)}),e)}))}async toggleCamera(){const t=Zi.local;t&&t.video&&(t.userMuteVideo?(await t.unmuteVideo(),ee.patchState({cameraMuted:!1}),this.broadcastEvent(new Ei({streamId:t.streamId})),this.setUserState()):(await t.muteVideo(),ee.patchState({cameraMuted:!0}),this.broadcastEvent(new _i({streamId:t.streamId})),this.setUserState()))}async toggleAudio(){const t=Zi.local;t&&t.audio&&(t.userMuteAudio?(await t.unmuteAudio(),ee.patchState({audioMuted:!1}),this.broadcastEvent(new Ti({streamId:t.streamId})),this.setUserState()):(await t.muteAudio(),ee.patchState({audioMuted:!0}),this.broadcastEvent(new Si({streamId:t.streamId})),this.setUserState()))}setAudio(t){const e=Zi.local;e&&e.audio&&(t?(this.previousMuteAudio_=e.userMuteAudio,e.userMuteAudio||(e.muteAudio(),ee.patchState({audioMuted:!0}),this.broadcastEvent(new Si({streamId:e.streamId})),this.setUserState())):e.userMuteAudio&&!this.previousMuteAudio_&&(e.unmuteAudio(),ee.patchState({audioMuted:!1}),this.broadcastEvent(new Ti({streamId:e.streamId})),this.setUserState()))}toggleMode(){const t=ee.state.mode===di?li:di;ee.patchState({mode:t}),ki.send({type:Fe,mode:t}),this.setChannelState({mode:t})}toggleNavInfo(){const t=!ee.state.showNavInfo;ee.patchState({showNavInfo:t}),ki.send({type:Be,showNavInfo:t})}requestControl(t){return new Promise(((e,i)=>{this.sendRequestControl(t).then((t=>{ee.patchState({controlling:t,spying:!1}),e(t),this.setChannelState({controlling:t,spying:""})}))}))}requestSpy(t){return new Promise(((e,i)=>{this.sendRequestSpy(t).then((t=>{ee.patchState({spying:t,controlling:!1}),e(t),this.setChannelState({spying:t,controlling:""})}))}))}dismissControl(t){return void 0===t&&(t=!1),new Promise(((e,i)=>{const n=ee.state.controlling;n?this.sendRequestControlDismiss(n).then((()=>{ee.patchState({controlling:!1}),e(n),t||this.setChannelState({controlling:""})})):e(!1)}))}dismissSpy(t){return void 0===t&&(t=!1),new Promise(((e,i)=>{const n=ee.state.spying;n?this.sendRequestSpyDismiss(n).then((()=>{ee.patchState({spying:!1}),e(n),t||this.setChannelState({spying:""})})):e(!1)}))}toggleControl(t){this.dismissSpy(!0).then((()=>{this.dismissControl(!0).then((e=>{e!==t?this.requestControl(t).then((t=>{qi.log("AgoraService.toggleControl",t)})):this.setChannelState({controlling:""})}))}))}toggleSpy(t){this.dismissControl(!0).then((()=>{this.dismissSpy(!0).then((e=>{e!==t?this.requestSpy(t).then((t=>{qi.log("AgoraService.toggleSpy",t)})):this.setChannelState({spying:""})}))}))}sendRequestControl(t){return new Promise(((e,i)=>{this.sendMessage({type:Ke,controllingId:t}).then((()=>{e(t)}))}))}sendRequestSpy(t){return new Promise(((e,i)=>{this.sendMessage({type:Je,spyingId:t}).then((()=>{e(t)}))}))}sendRequestControlDismiss(t){return new Promise(((e,i)=>{this.sendMessage({type:Ye,controllingId:t}).then((()=>{e(t)}))}))}sendRequestSpyDismiss(t){return new Promise(((e,i)=>{this.sendMessage({type:Xe,spyingId:t}).then((()=>{e(t)}))}))}toggleSilence(){const t=!ee.state.silencing;this.sendMessage({type:qe,silencing:t}),ee.patchState({silencing:t})}newMessageId(){return`${ee.state.uid}-${Date.now().toString()}`}navToView(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=!1),ee.state.controlling!==ee.state.uid&&ee.state.spying!==ee.state.uid||this.sendMessage({type:We,viewId:t,keepOrientation:e,useLastOrientation:i})}getSessionStats(){this.client.getSessionStats((t=>{qi.log(`\nAgoraService.getSessionStats\n\tDuration: ${t.Duration}\n\tUserCount: ${t.UserCount}\n\tSendBytes: ${t.SendBytes}\n\tRecvBytes: ${t.RecvBytes}\n\tSendBitrate: ${t.SendBitrate}\n\tRecvBitrate: ${t.RecvBitrate}\n`)}))}getSystemStats(){this.client.getSystemStats((t=>{qi.log(`\nAgoraService.getSystemStats\n\t\t\tBatteryLevel: ${t.BatteryLevel}\n`)}))}sendMessage(t){return new Promise(((e,i)=>{if(ee.state.connected){switch(t.clientId=ee.state.uid,t.type){case xe:case Ue:case Ve:case Fe:case Be:case je:case He:case Ge:case We:case $e:case ze:case Ze:case ti:case ei:case oi:case ri:case ai:case ci:case Qe:if(ee.state.controlling!==ee.state.uid&&ee.state.spying!==ee.state.uid)return}const n=t=>{switch(e(t),t.type){case Ke:this.broadcastMessage(t);break;case Qe:this.setChannelSnapshot(t)}},s=(t,e)=>{qi.log("AgoraService.sendMessage",t);try{const i=JSON.stringify(t);t.messageId&&this.once(`message-${t.messageId}`,(t=>{n(t)})),e.sendMessage({text:i}).then((()=>{t.messageId||n(t)})).catch((t=>{qi.error("AgoraService.sendMessage.error",t)}))}catch(t){qi.error("AgoraService.sendMessage.error",t)}},o=this.channel;if(o)s(t,o);else try{this.once("channel",(e=>{s(t,e)}))}catch(t){qi.error("AgoraService.sendMessage.error",t),i(t)}}else qi.error("AgoraService.sendMessage.error","not connected")}))}getChannelAttributes(){return qi.log("AgoraService.getChannelAttributes"),new Promise(((t,e)=>{const i=this.messageClient;if(i){i.getChannelAttributes(ee.state.channelNameLink).then((e=>{qi.log("AgoraService.getChannelAttributes",e),t(e)})).catch((e=>{qi.error("AgoraService.getChannelAttributes.error",e),t({})}))}else qi.error("AgoraService.getChannelAttributes.noop"),t({})}))}getChannelAttributesByKeys(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return qi.log("AgoraService.getChannelAttributesByKeys",e),new Promise(((t,i)=>{const n=this.messageClient;if(n){n.getChannelAttributes(ee.state.channelNameLink,e).then((e=>{qi.log("AgoraService.getChannelAttributesByKeys",e);const i={};Object.keys(e).forEach((t=>{i[t]=e[t].value})),t(i)})).catch((e=>{qi.error("AgoraService.getChannelAttributesByKeys.error",e),t({})}))}else qi.error("AgoraService.getChannelAttributesByKeys.noop",e),t({})}))}getChannelMessages(){return qi.log("AgoraService.getChannelMessages"),i.from(this.getChannelAttributes()).pipe(n.map((t=>Object.keys(t).filter((t=>0===t.indexOf("message-"))).map((e=>t[e])))),n.map((t=>{t.sort(((t,e)=>t.lastUpdateTs-e.lastUpdateTs));const e=t.map((t=>JSON.parse(t.value)));return qi.log("AgoraService.getChannelMessages",e),e})),n.catchError((t=>(qi.error("AgoraService.getChannelMessages.error",t),i.of([])))))}addOrUpdateChannelAttributes(t){return qi.log("AgoraService.addOrUpdateChannelAttributes",t),new Promise(((e,i)=>{const n=this.messageClient;if(n&&Object.keys(t).length>0){n.addOrUpdateChannelAttributes(ee.state.channelNameLink,t,{enableNotificationToChannelMembers:!1}).then((()=>{qi.log("AgoraService.addOrUpdateChannelAttributes",t)})).catch((t=>{qi.error("AgoraService.addOrUpdateChannelAttributes.error",t)})).finally((()=>{e()}))}else qi.error("AgoraService.addOrUpdateChannelAttributes.noop",t),e()}))}getInitialSession(){this.getChannelSession().then((t=>{ee.patchState(t.state),t.state.controlling&&t.snapshot&&this.broadcastMessage(t.snapshot),window.dispatchEvent(new Event("resize"))}))}getChannelSession(){return qi.log("AgoraService.getChannelSession"),new Promise(((t,e)=>{this.getChannelAttributesByKeys("channelState","channelSnapshot").then((e=>{const i={state:{},snapshot:{}};if(e.channelState){const t=JSON.parse(e.channelState);this.channelState=t,i.state=t}if(e.channelSnapshot){const t=JSON.parse(e.channelSnapshot);this.channelSnapshot=t,i.snapshot=t}qi.log("AgoraService.getChannelSession",i),t(i)})).catch((e=>{qi.error("AgoraService.getChannelSession.error",e),t({})}))}))}getChannelState(){return qi.log("AgoraService.getChannelState"),new Promise(((t,e)=>{this.getChannelAttributesByKeys("channelState").then((e=>{if(e.channelState){const i=JSON.parse(e.channelState);this.channelState=i,qi.log("AgoraService.getChannelState",i),t(i)}else t({})})).catch((e=>{qi.error("AgoraService.getChannelState.error",e),t({})}))}))}setChannelState(t){const e=le(le({},this.channelState||{}),t);return qi.log("AgoraService.setChannelState",t,e),this.addOrUpdateChannelAttributes({channelState:JSON.stringify(e)})}getChannelSnapshot(){return qi.log("AgoraService.getChannelSnapshot"),new Promise(((t,e)=>{this.getChannelAttributesByKeys("channelSnapshot").then((e=>{if(e.channelSnapshot){const i=JSON.parse(e.channelSnapshot);this.channelSnapshot=i,qi.log("AgoraService.getChannelSnapshot",i),t(i)}else t({})})).catch((e=>{qi.error("AgoraService.getChannelSnapshot.error",e),t({})}))}))}setChannelSnapshot(t){const e=le(le({},this.channelSnapshot||{}),t);return qi.log("AgoraService.setChannelSnapshot",t,e),this.addOrUpdateChannelAttributes({channelSnapshot:JSON.stringify(e)})}padStart(t,e,i){void 0===e&&(e=5),void 0===i&&(i="0");const n=String(t);return n.length>=e?n:new Array(e-n.length+1).join(i)+n}addOrUpdateChannelMessages(t){const e={};return t.forEach((t=>{const i=Math.floor(1e4*Math.random()),n=`message-${t.date}-${this.padStart(i)}`;e[n]=JSON.stringify(t)})),this.addOrUpdateChannelAttributes(e)}deleteChannelAttributesByKeys(t){return qi.log("AgoraService.deleteChannelAttributesByKeys",t),new Promise(((e,i)=>{const n=this.messageClient;if(n&&t.length>0){n.deleteChannelAttributesByKeys(ee.state.channelNameLink,t,{enableNotificationToChannelMembers:!1}).then((()=>{qi.log("AgoraService.deleteChannelAttributesByKeys",t),e()})).catch((t=>{qi.error("AgoraService.deleteChannelAttributesByKeys.error",t),i(t)}))}else qi.error("AgoraService.deleteChannelAttributesByKeys.noop",t),i("missing rtm client or keys")}))}setUserState(){const t={role:ee.state.role,name:ee.state.name,uid:ee.state.uid,screenUid:ee.state.screenUid,cameraMuted:ee.state.cameraMuted,audioMuted:ee.state.audioMuted};return qi.log("AgoraService.setUserState",t),this.addOrUpdateLocalUserAttributes({clientInfo:JSON.stringify(t)}).then((()=>t))}getUserState(t){return this.getUserAttributes(t).then((t=>{const e=JSON.parse(t.clientInfo||"");return qi.log("AgoraService.getUserState",e),e}))}addOrUpdateLocalUserAttributes(t){return qi.log("AgoraService.addOrUpdateLocalUserAttributes",t),new Promise(((e,i)=>{const n=this.messageClient;if(n&&Object.keys(t).length>0){n.addOrUpdateLocalUserAttributes(t).then((()=>{qi.log("AgoraService.addOrUpdateLocalUserAttributes",t),e()})).catch((t=>{qi.error("AgoraService.addOrUpdateLocalUserAttributes.error",t),i(t)}))}else qi.error("AgoraService.addOrUpdateLocalUserAttributes.noop",t),i("missing rtm client or attributes")}))}getUserAttributes(t){return qi.log("AgoraService.getUserAttributes",t),new Promise(((e,i)=>{const n=this.messageClient;if(n){n.getUserAttributes(t).then((t=>{qi.log("AgoraService.getUserAttributes",t),e(t)})).catch((t=>{qi.error("AgoraService.getUserAttributes.error",t),i(t)}))}else qi.error("AgoraService.getUserAttributes","missing rtm client"),i("missing rtm client")}))}clearLocalUserAttributes(){return qi.log("AgoraService.clearLocalUserAttributes"),new Promise(((t,e)=>{const i=this.messageClient;if(i){i.clearLocalUserAttributes().then((()=>{qi.log("AgoraService.clearLocalUserAttributes"),t()})).catch((e=>{qi.error("AgoraService.clearLocalUserAttributes.error",e),t()}))}else t()}))}checkBroadcastMessage(t){switch(t.type){case Ye:ee.patchState({controlling:!1}),t.controllingId===ee.state.uid&&this.closeScreenStream();break;case Xe:ee.patchState({spying:!1});break;case Qe:(ee.state.role===ie.Publisher||ee.state.controlling&&ee.state.controlling!==ee.state.uid)&&this.broadcastMessage(t);break;case qe:ee.state.role===ie.Streamer&&this.broadcastMessage(t);break;case xe:case Ue:case Ve:case Fe:case Be:case je:case He:case Ge:case We:case $e:case ze:case Ze:case ti:case ei:case oi:case ri:case ai:case ci:(ee.state.controlling&&ee.state.controlling!==ee.state.uid||ee.state.spying&&ee.state.spying!==ee.state.uid)&&this.broadcastMessage(t);break;default:this.broadcastMessage(t)}}broadcastMessage(t){ki.out(t)}broadcastEvent(t){ki.out({type:ke,event:t})}peerAdd(t){qi.log("AgoraService.peerAdd",t);const e={uid:t},i=Zi.peers;i.push(e),Zi.peers=i,this.broadcastEvent(new gi({peer:e}))}peerRemove(t){qi.log("AgoraService.peerRemove",t);const e=Zi.peers,i=e.find((e=>e.uid===t));i&&(e.splice(e.indexOf(i),1),Zi.peers=e)}onMessage(t,e){if(e!==ee.state.uid){qi.log("AgoraService.onMessage",t.text,e);const i=JSON.parse(t.text);if(i.messageId&&this.has(`message-${i.messageId}`)&&this.emit(`message-${i.messageId}`,i),i.remoteId&&i.remoteId!==ee.state.uid&&i.remoteId!==ee.state.screenUid)return;if(i.type===ri){const t=document.createElement("div");t.classList.add("player__vr"),i.container=t}this.checkBroadcastMessage(i)}else qi.log("AgoraService.onMessage",t.text)}onException(t){qi.error("AgoraService.onException",t)}async onUserJoined(t){qi.log("AgoraService.onUserJoined",t),this.peerAdd(t.uid)}async onUserLeft(t,e){qi.log("AgoraService.onUserLeft",t,e);const i=t.uid.toString();if(i!==ee.state.uid){const t=this.remoteRemove(i);t&&t.clientInfo&&(t.clientInfo.role===ie.Publisher?ee.state.role===ie.SelfService?ee.patchState({hosted:!0,controlling:!1,spying:!1,silencing:!1}):ee.patchState({hosted:!1,controlling:!1,spying:!1,silencing:!1}):(ee.state.controlling===i&&ee.patchState({controlling:!1}),ee.state.spying===i&&ee.patchState({spying:!1})))}this.peerRemove(i)}async onUserPublished(t,e){const i=t.uid.toString();if(qi.log("AgoraService.onUserPublished",i,t,e),i!==ee.state.uid&&i!==ee.state.screenUid){await this.client.subscribe(t,e);let i=Zi.getRemoteById(t.uid);i?i.published(t,e):(i=new Yi(t,e),await this.remoteAdd(i))}else{const t={role:ee.state.role,name:ee.state.name,uid:ee.state.uid,screenUid:ee.state.screenUid},e=Zi.local;e.clientInfo=t,Zi.local=e}}async remoteAdd(t){qi.log("AgoraService.remoteAdd",t),Zi.remoteAdd(t),this.broadcastEvent(new fi({stream:t}));const e=t.streamId;setTimeout((async()=>{const t=e.split("_")[0],i=await this.getUserState(t);if(qi.log("AgoraService.remoteAdd.getUserState",i),Zi.remoteSetClientInfo(e,i),i.cameraMuted&&this.broadcastEvent(new _i({streamId:e})),i.audioMuted&&this.broadcastEvent(new Si({streamId:e})),i.role===ie.Publisher){const t={hosted:!0};ee.patchState(t),this.getInitialSession()}}),100)}async onUserUnpublished(t,e){const i=t.uid.toString();if(i!==ee.state.uid&&i!==ee.state.screenUid){let i=Zi.getRemoteById(t.uid);i&&i.unpublished(t,e)}}remoteRemove(t){const e=Zi.remoteRemove(t);return e&&e.clientInfo&&e.clientInfo.role===ie.Publisher&&e.clientInfo.screenUid!==t&&ee.patchState({hosted:!1}),e}onUserInfoUpdated(t){switch(qi.log("AgoraService.onUserInfoUpdated",t),t.msg){case"mute-audio":this.broadcastEvent(new Si({streamId:t.uid}));break;case"unmute-audio":this.broadcastEvent(new Ti({streamId:t.uid}));break;case"mute-video":this.broadcastEvent(new _i({streamId:t.uid}));break;case"unmute-video":this.broadcastEvent(new Ei({streamId:t.uid}))}this.broadcastEvent(new vi({streamId:t.uid,message:t.msg}))}onVolumeIndicator(t){const e=t.attr.map((t=>({streamId:t.uid,level:t.level})));this.broadcastEvent(new bi({streams:e}))}onConnectionStateChange(t){qi.log("AgoraService.onConnectionStateChange",t)}onTokenPrivilegeWillExpire(t){qi.log("AgoraService.onTokenPrivilegeWillExpire");const e=this.client,i=this.getChannelNameLink();Qi.rtcToken$(i).subscribe((async t=>{t.token&&(await e.renewToken(t.token),qi.log("AgoraService.onTokenPrivilegeWillExpire.renewed"))}))}onTokenPrivilegeDidExpire(t){qi.log("AgoraService.onTokenPrivilegeDidExpire");const e=this.client,i=this.getChannelNameLink();Qi.rtcToken$(i).subscribe((async t=>{t.token&&(await e.renewToken(t.token),qi.log("AgoraService.onTokenPrivilegeDidExpire.renewed"))}))}toggleScreen(){if(this.isAudienceRole)return;Zi.screen?this.closeScreenStream():this.openScreenStream()}async openScreenStream(){let t=this.screenClient;t||(t=await this.createScreenClient()),t&&await this.createScreenStream(ee.state.screenUid)}async createScreenClient(){let t=null;try{t=Mi.createClient({mode:"live",codec:"h264"}),t.on("exception",this.onScreenException),t.on("user-published",this.onScreenPublished),t.on("user-unpublished",this.onScreenUnpublished),await t.setClientRole("host"),x.flags.useProxy&&(t.startProxyServer(3),qi.log("AgoraService.openScreenStream.startProxyServer"));const e=this.getChannelNameLink(),i=await Qi.rtcToken$(e).toPromise();qi.log("AgoraService.toggleScreen.rtcToken$",i),await this.screenJoin(t,i.token,e)}catch(t){qi.error("AgoraService.openScreenStream.error",t)}return this.screenClient=t,t}async screenJoin(t,e,i){try{const n=ee.state.uid+"_"+Qi.getUniqueUserId(),s=await t.join(x.appKey,i,e,n);qi.log("AgoraService.screenJoin",s),ee.patchState({screenUid:s})}catch(e){if(qi.error("AgoraService.screenJoin.error",e),"DYNAMIC_KEY_EXPIRED"===e){const e=await Qi.rtcToken$(i).toPromise();await this.screenJoin(t,e.token,i)}}}async createScreenStream(t){try{const e=Ee.find((t=>t.profile===x.profiles.screen));let i=await Mi.createScreenVideoTrack({displaySurface:"monitor",encoderConfig:e.profile},"disable");const n=new Yi({uid:t,videoTrack:i,hasVideo:void 0!==i},"video",!0);Zi.screen=n,setTimeout((async()=>{await this.publishScreenStream()}),1),qi.log("AgoraService.createLocalStreamWithOptions.success",n)}catch(t){qi.error("AgoraService.createLocalStreamWithOptions.error",t)}}async publishScreenStream(){try{qi.log("AgoraService.publishScreenStream");const t=Zi.screen,e=this.screenClient;await e.publish(t.getTracks());const i=await this.setUserState();t.clientInfo=i,Zi.screen=t}catch(t){throw qi.error("AgoraService.publishScreenStream.error",t),t}}async unpublishScreenStream(){try{qi.log("AgoraService.unpublishScreenStream");const t=this.screenClient,e=Zi.screen;e&&t&&await t.unpublish(e.getTracks()),Zi.screen=null}catch(t){throw qi.error("AgoraService.unpublishScreenStream.error",t),t}}async closeScreenStream(){try{const t=Zi.screen;t&&await t.close(),await this.clearLocalUserAttributes(),Zi.screen=null,qi.log("AgoraService.closeScreenStream",t)}catch(t){throw qi.error("AgoraService.closeScreenStream.error",t),t}}leaveScreenClient(){return new Promise(((t,e)=>{const i=this.screenClient;i?i.leave((()=>{this.screenClient=null,x.flags.useProxy&&(i.stopProxyServer(),qi.log("AgoraService.leaveScreenClient.stopProxyServer")),t()}),(t=>{qi.error("AgoraService.leaveScreenClient.error",t),e(t)})):t()}))}onScreenException(t){qi.error("AgoraService.onScreenException",t)}onScreenPublished(t){qi.log("AgoraService.onScreenPublished",t)}onScreenUnpublished(t){qi.log("AgoraService.onScreenUnpublished",t)}static getSingleton(t){if(!R)return this.AGORA||(this.AGORA=new Qi(t)),this.AGORA}static getUniqueUserId(){return(1e13*(100*(1+Math.floor(8*Math.random()))+10*(1+Math.floor(8*Math.random()))+1*(1+Math.floor(8*Math.random())))+Date.now()).toString()}static resolveUserId(){let t=Ki.get("bHereClientId");return"number"==typeof t?t.toString():"string"==typeof t?t:Qi.getUniqueUserId()}static storeUserId(t){Ki.set("bHereClientId",t)}static fixLegacy(){["moz","webkit"].forEach((t=>{qi.log("AgoraService.fixLegacy",`${t}RTC`),Object.getOwnPropertyNames(window).filter((t=>0===t.indexOf("RTC"))).map((e=>{const i=`${t}${e}`;void 0!==window[e]&&void 0===window[i]&&(window[i]=window[e])}))}))}static rtcToken$(t){return x.flags.useToken?yi.post$("/api/token/rtc",{channelName:t,uid:null}):i.of({token:null})}static rtmToken$(t){return x.flags.useToken?yi.post$("/api/token/rtm",{uid:t}):i.of({token:null})}static checkRtcConnection(){return new Promise(((t,e)=>{try{const i=Mi.createClient({mode:"live",codec:"h264"});x.flags.useProxy&&i.startProxyServer(3),Qi.checkRtcTryJoin(i).then((e=>{t(e)})).catch((t=>{e(t)})).finally((()=>{i.leave((()=>{x.flags.useProxy&&i.stopProxyServer()}),(()=>{}))}))}catch(t){e(t)}}))}static checkRtcTryJoin(t){return new Promise(((e,i)=>{const n="checkRtcConnection";Qi.rtcToken$(n).subscribe((async s=>{try{const i=await t.join(x.appKey,n,s.token,null);e(i)}catch(e){if("DYNAMIC_KEY_EXPIRED"===e)return Qi.checkRtcTryJoin(t);qi.error("AgoraService.checkRtcConnection.error",e),i(e)}}),(t=>i(t)))}))}static checkRtmConnection(t){return new Promise(((e,i)=>{try{let n,s=AgoraRTM.createInstance(x.appKey,{logFilter:AgoraRTM.LOG_FILTER_OFF});s.setParameters({logFilter:AgoraRTM.LOG_FILTER_OFF}),Qi.rtmToken$(t).subscribe((o=>{s.login({token:o.token,uid:t.toString()}).then((()=>{n=s.createChannel("checkRtcConnection"),n.join().then((()=>{e(t),n.leave()})).catch((t=>{i(t)})).finally((()=>{n.leave().then((()=>{n=null,s.logout().then((()=>{s=null})).catch((()=>{}))})).catch((()=>{}))}))})).catch((t=>{qi.error("checkRtmConnection.error",t),i(t)})).finally((()=>{s&&s.logout().then((()=>{s=null})).catch((()=>{}))}))}),(t=>i(t)))}catch(t){i(t)}}))}static async getDevices(){let t=Qi.devices_;if(t)return t;{t=Qi.devices_=[];const e={audio:!0,video:!0};if(ji.platform===Ui&&(e.video={facingMode:"user"}),ji.platform===Bi&&(e.video=!1),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const i=await navigator.mediaDevices.getUserMedia(e),n=await navigator.mediaDevices.enumerateDevices();return i.getTracks().forEach((t=>{t.stop()})),n.forEach((e=>{t.push(e)})),t}throw"Media device not available"}}}class tn{constructor(t,e,i){this.type=Pe,this.clientId_=e,"string"==typeof t?(this.date=Date.now(),this.clientId=e,this.name=i,this.message=t):"object"==typeof t&&(this.date=t.date,this.clientId=t.clientId,this.name=t.name,this.message=t.message);const n=this.name.split(" ");this.shortName=n[0].substr(0,1).toUpperCase()+(n.length>1?n[1]:n[0]).substr(0,1).toUpperCase()}get me(){return this.clientId===this.clientId_}getPayload(){return{date:this.date,clientId:this.clientId,name:this.name,message:this.message}}getCopy(){return new tn({date:this.date,clientId:this.clientId,name:this.name,message:this.message},this.clientId_)}}class en extends t.Component{constructor(){super(...arguments),this.typings_=!1}onInit(){this.rows=1,this.showEmoji=!1,this.demo=-1!==window.location.pathname.indexOf("layout");const t=this.form=new e.FormGroup({message:null});if(this.controls=t.controls,t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.checkTypings(t),this.pushChanges()})),ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.type){case Pe:this.pushMessage(new tn(t,ee.state.uid,ee.state.name));break;case De:this.typingBegin(t);break;case Me:this.typingEnd(t)}})),this.messages=[],this.groupedMessages=[],this.demo){const t=en.getFakeList().map((t=>new tn(t,ee.state.uid,ee.state.name)));this.updateMessages(t.slice(0,5)),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.clientId=t.clientId||ee.state.uid,t.type){case Pe:break;case De:case Me:ki.out(t)}}))}else{const t=this.agora=Qi.getSingleton();t&&t.getChannelMessages().pipe(n.first()).subscribe((t=>{t=t.map((t=>new tn(t,ee.state.uid,ee.state.name))),this.updateMessages(t)}))}}onView(){}onChanges(){}onDestroy(){en.to&&(clearTimeout(en.to),en.to=null)}onSubmit(){const t=this.secureText(this.form.value.message),e=this.createMessage(t);this.sendMessage(e),this.form.get("message").value=null,this.demo}onKeyDown(e){if("Enter"===e.key){e.shiftKey?(this.rows=Math.min(4,this.rows+1),this.pushChanges()):(e.preventDefault(),this.onSubmit(),this.rows=1);const{node:i}=t.getContext(this);i.querySelector("textarea").setAttribute("rows",this.rows)}}onToggleEmoji(){this.showEmoji=!this.showEmoji,this.pushChanges()}onSelectEmoji(t){this.showEmoji=!1,this.form.get("message").value=(this.form.get("message").value||"")+t.char}secureText(t){return(new DOMParser).parseFromString(t,"text/html").body.textContent||""}createMessage(t){return new tn(t,ee.state.uid,ee.state.name)}sendMessage(t){this.pushMessage(t);const e=this.agora;e&&e.addOrUpdateChannelMessages([t.getPayload()]),ki.send(t)}onClose(t){this.close.next()}scrollToBottom(){const{node:e}=t.getContext(this),i=e.querySelector(".group--scrollview");i.scrollTop=i.scrollHeight}pushMessage(t){const e=this.messages?this.messages.slice():[];this.removeTyping({type:De,clientId:t.clientId},this.messages),e.push(t),this.updateMessages(e)}typingBegin(t){const e=this.messages?this.messages.slice():[];e.push(t),this.updateMessages(e)}typingEnd(t){const e=this.messages?this.messages.slice():[];this.removeTyping({type:De,clientId:t.clientId},e),this.updateMessages(e)}removeTyping(t,e,i){void 0===i&&(i=!0);const n=e.reduce(((e,i,n)=>i.type===t.type&&i.clientId===t.clientId?n:e),-1);return-1!==n&&(e.splice(n,1),!0===i&&this.removeTyping(t,e,!0)),n}checkTypings(t){const e=t.message&&t.message.length>0||!1;this.typings_!==e&&(this.typings_=e,e?ki.send({type:De}):ki.send({type:Me}))}updateMessages(t){this.messages=t,this.groupedMessages=[],this.pushChanges();const e=[];t.forEach((t=>{if(t.type===Pe){const i=e.length?e[e.length-1]:null;i&&i.clientId===t.clientId?i.message+=`<p>${t.message}</p>`:e.push(t.getCopy())}else if(t.type===De){const i=e.reduce(((e,i,n)=>i.clientId===t.clientId?i:e),null);i&&(i.typing=!0)}})),this.groupedMessages=e,this.pushChanges(),setTimeout((()=>{this.scrollToBottom()}),1)}isValid(){return this.form.valid&&this.form.value.message&&this.form.value.message.length>0}randomMessage(){en.to&&(clearTimeout(en.to),en.to=null),en.to=setTimeout((()=>{const t=en.createRandomMessage();this.sendMessage(t)}),1e3*(2+6*Math.random()))}}en.meta={selector:"[agora-chat]",outputs:["close"],template:'\n\t\t<div class="group--scrollview" [class]="\'rows--\' + rows">\n\t\t\t<div class="group--virtual" *virtual="let item of groupedMessages" [mode]="4" [width]="350" [gutter]="0" [reverse]="true">\n\t\t\t\t\x3c!-- serve un nodo figlio --\x3e\n\t\t\t\t<div class="listing__item message" [class]="{ me: item.me, typing: item.typing }">\n\t\t\t\t\t<div class="message__avatar" [title]="item.name"><span [innerHTML]="item.shortName"></span></div>\n\t\t\t\t\t<div class="message__content">\n\t\t\t\t\t\t<div [innerHTML]="item.message | message"></div>\n\t\t\t\t\t\t<div class="typing-indicator">\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="group--message" [class]="\'rows--\' + rows">\n\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.message.validators.length, \'addon\': controls.message.valid }">\n\t\t\t\t\t\x3c!-- <input type="text" class="control--text" [formControl]="controls.message" [placeholder]="\'bhere_write_a_message\' | label" /> --\x3e\n\t\t\t\t\t<button type="button" class="control--pre" (click)="onToggleEmoji()">\n\t\t\t\t\t\t<svg class="emoji" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#emoji"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<textarea class="control--text" [formControl]="controls.message" [placeholder]="\'bhere_write_a_message\' | label" rows="1" (keydown)="onKeyDown($event)"></textarea>\n\t\t\t\t\t<button type="submit" class="control--addon">\n\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#send"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</form>\n\t\t</div>\n\t\t<div class="group--close">\n\t\t\t<button type="button" class="btn--close" [title]="\'title_close\' | label" (click)="onClose($event)">\n\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="group--emoji" [class]="\'rows--\' + rows" agora-chat-emoji (emoji)="onSelectEmoji($event)" (close)="onToggleEmoji()" *if="showEmoji">\n\t\t\t<div class="group--virtual" *virtual="let item of items" [mode]="1" [width]="40" [gutter]="10" [reverse]="true">\n\t\t\t\t\x3c!-- serve un nodo figlio --\x3e\n\t\t\t\t<div class="listing__item emoji">\n\t\t\t\t\t<button type="button" class="btn--emoji" (click)="onSelect(item)"><span [innerHTML]="item.char"></span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--close">\n\t\t\t\t<button type="button" class="btn--close" [title]="\'title_close\' | label" (click)="onClose($event)">\n\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t'},en.getFakeList=()=>{let t=[{date:161459223e4,name:"Jhon Appleseed",message:"Function-based web-enabled benchmark",clientId:"7341614597544882"},{date:161459224e4,name:"Jhon Appleseed",message:"Customizable exuding superstructure",clientId:"7341614597544882"},{date:161459225e4,name:"Gilles Pitkins",message:"Synergistic interactive archive",clientId:"cfe9ff5b-f7da-449d-bf5a-3184b5eba6ea"},{date:161459226e4,name:"Jhon Appleseed",message:"Digitized client-server initiative",clientId:"7341614597544882"},{date:161459227e4,name:"Jhon Appleseed",message:"Quality-focused tertiary open system",clientId:"7341614597544882"},{date:161459228e4,name:"Jhon Appleseed",message:"Exclusive uniform middleware",clientId:"7341614597544882"},{date:161459229e4,name:"John Pruckner",message:"Decentralized disintermediate extranet",clientId:"ae51e846-d043-41e9-bb5c-3189181e5b43"},{date:16145923e5,name:"Lamont Georgievski",message:"Enhanced static approach",clientId:"1961cd9e-93aa-4bd0-b96a-89fcbd36b257"},{date:161459231e4,name:"Jhon Appleseed",message:"Ergonomic clear-thinking info-mediaries",clientId:"7341614597544882"},{date:161459232e4,name:"Jeri Pedroni",message:"Grass-roots dynamic encryption",clientId:"13d69bba-3656-449b-8fe3-d7a87062b044"},{date:161459233e4,name:"Frederik Dechelle",message:"Compatible disintermediate policy",clientId:"9151ebe0-efa8-40b4-a341-b8fd489e9c88"},{date:161459234e4,name:"Jhon Appleseed",message:"Inverse user-facing adapter",clientId:"7341614597544882"},{date:161459235e4,name:"Jhon Appleseed",message:"Future-proofed even-keeled application",clientId:"7341614597544882"},{date:161459236e4,name:"Cassie Jonathon",message:"Profit-focused content-based budgetary management",clientId:"5b3dc6f3-2a3d-493d-aac5-66ddfce2d709"},{date:161459237e4,name:"Jhon Appleseed",message:"Managed intermediate monitoring",clientId:"7341614597544882"},{date:161459238e4,name:"Jhon Appleseed",message:"Exclusive client-server encoding",clientId:"7341614597544882"},{date:161459239e4,name:"Jhon Appleseed",message:"Cross-group system-worthy matrices",clientId:"7341614597544882"},{date:16145924e5,name:"Jhon Appleseed",message:"Upgradable encompassing benchmark",clientId:"7341614597544882"},{date:161459241e4,name:"Emelen Beevors",message:"Function-based full-range knowledge base",clientId:"c93aea47-ebd8-4e5e-88fd-52053dd35cd1"},{date:161459242e4,name:"Jhon Appleseed",message:"Synergistic system-worthy capability",clientId:"7341614597544882"}];for(;t.length<100;)t=t.concat(t);return t},en.createRandomMessage=t=>new tn({date:Date.now(),clientId:"9fe0e1b9-6a6b-418b-b916-4bbff3eeb123",name:"Herman frederick",message:"Lorem ipsum dolor"},ee.state.uid,ee.state.name),en.randomMessage=(t,e)=>{en.to&&(clearTimeout(en.to),en.to=null),en.to=setTimeout((()=>{const i=function(){const t=e.filter((t=>"7341614597544882"!==t.id));let i=t[Math.floor(t.length*Math.random())];return i=new tn({date:Date.now(),clientId:"9fe0e1b9-6a6b-418b-b916-4bbff3eeb123",name:i.name,message:i.message},ee.state.uid,ee.state.name),i}();t.sendMessage(i),en.randomMessage(t,e)}),1e3*(2+6*Math.random()))};class nn extends t.Component{}nn.meta={selector:"[agora-check]",inputs:["value"],template:'\n\t\t<svg *if="value == null" class="checkmark idle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">\n\t\t\t<circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>\n\t\t</svg>\n\t\t<svg *if="value === true" class="checkmark success" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">\n\t\t\t<circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>\n\t\t\t<path class="checkmark__icon" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" stroke-linecap="round"/>\n\t\t</svg>\n\t\t<svg *if="value === false" class="checkmark error" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">\n\t\t\t<circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>\n\t\t\t<path class="checkmark__icon" stroke-linecap="round" fill="none" d="M16 16 36 36 M36 16 16 36"/>\n\t\t</svg>\n\t'};class sn{constructor(t){this.data=t}}class on extends sn{}class rn extends sn{}class an{static get hasModal(){return this.hasModal_}static set hasModal(t){if(this.hasModal_!==t){this.hasModal_=t;const e=document.querySelector("body");t?e.classList.add("modal-open"):e.classList.remove("modal-open")}}static open$(t){return this.busy$.next(!0),(t.iframe?i.of(`<div class="iframe-modal" iframe-modal src="${t.iframe}"></div>`):this.getTemplate$(t)).pipe(n.map((e=>({node:this.getNode(e),data:t.data,modal:t}))),n.tap((t=>{this.modal$.next(t),this.hasModal=!0,this.busy$.next(!1)})),n.switchMap((t=>this.events$)),n.tap((t=>this.hasModal=!1)))}static getTemplate$(t){return t.src?i.from(fetch(t.src).then((t=>t.text()))):t.template?i.of(t.template):i.EMPTY}static getNode(t){const e=document.createElement("div");e.innerHTML=t;return e.firstElementChild}static reject(t){this.modal$.next(null),this.events$.next(new rn(t))}static resolve(t){this.modal$.next(null),this.events$.next(new on(t))}}an.modal$=new i.Subject,an.events$=new i.Subject,an.busy$=new i.Subject;class cn{static delete(t){this.isLocalStorageSupported()&&window.localStorage.removeItem(t)}static exist(t){if(this.isLocalStorageSupported())return void 0!==window.localStorage[t]}static get(t){let e=null;if(this.isLocalStorageSupported()&&void 0!==window.localStorage[t])try{e=JSON.parse(window.localStorage[t])}catch(e){console.log("LocalStorageService.get.error parsing",t,e)}return e}static set(t,e){if(this.isLocalStorageSupported())try{const i=[],n=JSON.stringify(e,(function(t,e){if("object"==typeof e&&null!==e){if(-1!==i.indexOf(e))return;i.push(e)}return e}));window.localStorage.setItem(t,n)}catch(i){console.log("LocalStorageService.set.error serializing",t,e,i)}}static isLocalStorageSupported(){if(this.supported)return!0;let t=!1;try{t="localStorage"in window&&null!==window.localStorage,t?(window.localStorage.setItem("test","1"),window.localStorage.removeItem("test")):t=!1}catch(e){t=!1}return this.supported=t,t}}const dn=100;class ln{static checklist$(){return ee.state$.pipe(n.first(),n.map((t=>{const e={shouldCheckAudio:!0,shouldCheckVideo:!0,key:"checklist_audio_video",uid:null,checklist:{browser:null,https:null,video:null,audio:null,rtc:null,rtm:null},errors:{}};return t.role===ie.Viewer&&(e.shouldCheckAudio=!1,e.shouldCheckVideo=!1),ji.platform===Bi&&(e.shouldCheckAudio=!0,e.shouldCheckVideo=!1),e.key=`checklist${e.shouldCheckAudio?"_audio":""}${e.shouldCheckVideo?"_video":""}`,e})),n.switchMap((t=>(!0===cn.get(t.key)&&Object.keys(t.checklist).forEach((e=>{t.checklist[e]=!0})),i.of(t)))))}static isChecked(t){return Object.keys(t.checklist).reduce(((e,i,n)=>{const s=e&&t.checklist[i];switch(i){case"audio":return s||!t.shouldCheckAudio;case"video":return s||!t.shouldCheckVideo;default:return s}}),!0)}static isChecked$(){return this.checklist$().pipe(n.map((t=>this.isChecked(t))))}static checkEvent$(){return this.checklist$().pipe(n.switchMap((t=>{if(!0===Object.keys(t.checklist).reduce(((e,i,n)=>e&&t.checklist[i]),!0))return i.of(t);{cn.set(t.key,!1);const e=new i.Subject,s=i.of(t).pipe(n.delay(1e3),n.switchMap((t=>(e.next(t),this.checkBrowserEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkHttpsEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkAudioEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkVideoEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkRtcEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkRtmEvent$(t)))),n.tap((t=>{cn.set(t.key,!0)})));return i.merge(e,s)}})))}static check$(){return this.checklist$().pipe(n.switchMap((t=>!0===Object.keys(t.checklist).reduce(((e,i,n)=>e&&t.checklist[i]),!0)?i.of(t):(cn.set(t.key,!1),i.of(t).pipe(n.delay(1e3),n.switchMap((t=>this.checkBrowserEvent$(t))),n.switchMap((t=>this.checkHttpsEvent$(t))),n.switchMap((t=>this.checkAudioEvent$(t))),n.switchMap((t=>this.checkVideoEvent$(t))),n.switchMap((t=>this.checkRtcEvent$(t))),n.switchMap((t=>this.checkRtmEvent$(t))),n.tap((t=>{cn.set(t.key,!0)})))))))}static checkBrowser$(){const t=AgoraRTC.checkSystemRequirements();return i.of(t)}static checkBrowserEvent$(t){return this.checkBrowser$().pipe(n.switchMap((e=>(t.checklist.browser=e,e?i.of(t).pipe(n.delay(dn)):(t.errors.browser=ge.transform("bhere_browser_error"),this.checkHttpsEvent$(t).pipe(n.switchMap((t=>i.throwError(t)))))))),n.catchError((e=>(console.log("checkBrowserEvent$.error",e),t.checklist.browser=!1,t.errors.browser=ge.transform("bhere_browser_error"),i.throwError(t)))))}static checkHttps$(){const t="https:"===window.location.protocol;return i.of(t)}static checkHttpsEvent$(t){return this.checkHttps$().pipe(n.switchMap((e=>(t.checklist.https=e,e?i.of(t).pipe(n.delay(dn)):(t.errors.https=ge.transform("bhere_https_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkHttpsEvent$.error",e),t.checklist.https=!1,t.errors.https=ge.transform("bhere_https_error"),i.throwError(t)))))}static checkAudio$(){return i.from(Qi.getDevices()).pipe(n.map((t=>null!=t.find((t=>"audioinput"===t.kind&&t.deviceId)))))}static checkAudioEvent$(t){return t.shouldCheckAudio?this.checkAudio$().pipe(n.switchMap((e=>(t.checklist.audio=e,e?i.of(t).pipe(n.delay(dn)):(t.errors.audio=ge.transform("bhere_audio_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkAudioEvent$.error",e),t.checklist.audio=!1,t.errors.audio=ge.transform("bhere_audio_error"),i.throwError(t))))):i.of(t)}static checkVideo$(){return i.from(Qi.getDevices()).pipe(n.map((t=>null!=t.find((t=>"videoinput"===t.kind&&t.deviceId)))))}static checkVideoEvent$(t){return t.shouldCheckVideo?this.checkVideo$().pipe(n.switchMap((e=>(t.checklist.video=e,e?i.of(t).pipe(n.delay(dn)):(t.errors.video=ge.transform("bhere_video_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkVideoEvent$.error",e),t.checklist.video=!1,t.errors.video=ge.transform("bhere_video_error"),i.throwError(t))))):i.of(t)}static checkRtc$(){return i.from(Qi.checkRtcConnection())}static checkRtcEvent$(t){return this.checkRtc$().pipe(n.switchMap((e=>(t.uid=e,t.checklist.rtc=!1!==e,e?i.of(t).pipe(n.delay(dn)):(t.errors.rtc=ge.transform("bhere_rtc_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkRtcEvent$.error",e),t.checklist.rtc=!1,t.errors.rtc=ge.transform("bhere_rtc_error"),i.throwError(t)))))}static checkRtm$(t){return i.from(Qi.checkRtmConnection(t))}static checkRtmEvent$(t){return this.checkRtm$(t.uid).pipe(n.switchMap((e=>(t.checklist.rtm=!1!==e,e?i.of(t):(t.errors.rtm=ge.transform("bhere_rtm_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkRtmEvent$.error",e),t.checklist.rtm=!1,t.errors.rtm=ge.transform("bhere_rtm_error"),i.throwError(t)))))}}class hn extends t.Component{onClose(){an.resolve()}}hn.meta={selector:"[agora-configure-firewall-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form" [innerHTML]="\'bhere_configure_firewall\' | label"></div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="button" class="btn--accept" (click)="onClose()">\n\t\t\t\t\t<span>Chiudi</span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t'},hn.chunk=()=>'<div class="configure-firewall-modal" agora-configure-firewall-modal></div>';class un extends t.Component{onInit(){this.platform=ji.platform,this.checklist={},this.errors={},this.state={},this.busy=!0,this.shouldCheckAudio=!1,this.shouldCheckVideo=!1,ln.checkEvent$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.shouldCheckAudio=t.shouldCheckAudio,this.shouldCheckVideo=t.shouldCheckVideo,this.checklist=t.checklist,this.errors=t.errors||{};const e=ln.isChecked(t);e?(this.checklist.success=e,this.busy=!1,this.pushChanges(),this.state.role===ie.SmartDevice&&this.onNext()):this.pushChanges()}),(t=>{this.errors=t.errors||{},this.checklist.error=!0,this.busy=!1,this.pushChanges()}))}onNext(){this.checked.next(this.checklist)}openHttps(){window.location.href=window.location.href.replace("http://","https://").replace(":5000",":6443")}showFirewallConfiguration(){an.open$({template:hn.chunk()}).pipe(n.first()).subscribe()}}un.meta={selector:"[agora-checklist]",outputs:["checked"],template:'\n\t<div class="group--info">\n\t\t<div class="group--info__content stagger--childs">\n\t\t\t<div class="title" *if="busy" [innerHTML]="\'bhere_checklist_busy\' | label"></div>\n\t\t\t<div class="title" *if="checklist.success" [innerHTML]="\'bhere_checklist_success\' | label"></div>\n\t\t\t<div class="title" *if="checklist.error" [innerHTML]="\'bhere_checklist_error\' | label"></div>\n\t\t\t<ul class="group--checklist stagger--childs">\n\t\t\t\t<li class="checklist__item check"><span>Browser</span> <span agora-check [value]="checklist.browser"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.browser"><a class="btn--link" href="https://browsehappy.com/" target="_blank" rel="noopener" [innerHTML]="errors.browser"></a></li>\n\t\t\t\t<li class="checklist__item check"><span>Https</span> <span agora-check [value]="checklist.https"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.https"><a class="btn--link" (click)="openHttps()" [innerHTML]="errors.https"></a></li>\n\t\t\t\t<li class="checklist__item check" *if="shouldCheckAudio"><span>Audio</span> <span agora-check [value]="checklist.audio"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.audio"><span [innerHTML]="errors.audio"></span></li>\n\t\t\t\t<li class="checklist__item check" *if="shouldCheckVideo"><span>Video</span> <span agora-check [value]="checklist.video"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.video"><span [innerHTML]="errors.video"></span></li>\n\t\t\t\t<li class="checklist__item check"><span>Realtime Communication</span> <span agora-check [value]="checklist.rtc"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.rtc"><a class="btn--link" (click)="showFirewallConfiguration()" [innerHTML]="errors.rtc"></a></li>\n\t\t\t\t<li class="checklist__item check"><span>Realtime Messaging</span> <span agora-check [value]="checklist.rtm"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.rtm"><a class="btn--link" (click)="showFirewallConfiguration()" [innerHTML]="errors.rtm"></a></li>\n\t\t\t</ul>\n\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !checklist.success, ready: checklist.success }" (click)="onNext()">\n\t\t\t\t<span [innerHTML]="\'bhere_proceed\' | label"></span>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t'};class pn{static get context(){return!this.context_&&"AudioContext"in window&&(this.context_=new AudioContext),this.context_}static get analyser(){if(!this.analyser_)try{this.analyser_=this.context.createAnalyser()}catch(t){console.log("AudioStreamService.analyser",t)}return this.analyser_}static addSource(t){const e=t instanceof MediaStream?t.id:t;return this.sources_[e]||(t instanceof MediaStream?this.sources_[e]=this.context.createMediaStreamSource(t.clone()):this.sources_[e]=this.context.createMediaElementSource(t)),this.sources_[e]}static removeSource(t){const e=t instanceof MediaStream?t.id:t;return this.removeSourceKey(e)}static removeSourceKey(t){let e;return this.sources_[t]&&(e=this.sources_[t],this.analyser&&e.disconnect(this.analyser),e.disconnect(),delete this.sources_[t]),e}static frequency$(t,e){if(void 0===e&&(e=64),e%2==1)throw e;const s=new Uint8Array(e/2);if(this.context){const o=this.analyser;if(o){o.fftSize=e;this.addSource(t).connect(o)}const r=new i.BehaviorSubject(s);return pn.frame$.pipe(n.withLatestFrom(r),n.map((t=>{let[e,i]=t;return o&&o.getByteFrequencyData(i),i})),n.tap((t=>r.next(t))),n.finalize((()=>{this.removeSource(t)})))}return i.of(s)}static volume$(t){const e={volume:0,clipped:!1};if(this.context){const s=this.addSource(t),o=pn.audioMeterCreate();s.connect(o);const r=new i.BehaviorSubject(e);return pn.frame$.pipe(n.withLatestFrom(r),n.map((t=>{let[e,i]=t;return i.clipped=o.checkClipping(),i.volume=o.volume,i})),n.tap((t=>r.next(t))),n.finalize((()=>{this.removeSource(t)})))}return i.of(e)}static audioMeterCreate(t,e,i){void 0===t&&(t=.98),void 0===e&&(e=.95),void 0===i&&(i=750);const n=this.context;if(n){const s=n.createScriptProcessor(512);return s.onaudioprocess=this.audioMeterProcess,s.checkClipping=this.audioMeterClip,s.dispose=this.audioMeterDispose,s.clipping=!1,s.lastClip=0,s.volume=0,s.clipLevel=t,s.averaging=e,s.clipLag=i,s.connect(n.destination),s}}static audioMeterProcess(t){const e=t.inputBuffer.getChannelData(0),i=e.length;let n,s=0;for(let t=0;t<i;t++)n=e[t],Math.abs(n)>=this.clipLevel&&(this.clipping=!0,this.lastClip=window.performance.now()),s+=n*n;const o=Math.sqrt(s/i);this.volume=Math.max(o,this.volume*this.averaging)}static audioMeterClip(){return!!this.clipping&&(this.lastClip+this.clipLag<window.performance.now()&&(this.clipping=!1),this.clipping)}static audioMeterDispose(){this.disconnect(),this.onaudioprocess=null}static step$(t){return i.Observable.create((e=>{requestAnimationFrame((i=>{const n=t?(i-t.startTime)/1e3:0;e.next({startTime:i,deltaTime:n})}))})).pipe(n.map((t=>(t.deltaTime>1/30&&(t.deltaTime=1/30),t))))}static dispose(){Object.keys(this.sources_).forEach((t=>{this.removeSourceKey(t)}));const t=this.analyser;t&&t.disconnect(),this.sources_={}}}pn.sources_={},pn.frame$=i.of(void 0).pipe(n.expand((t=>pn.step$(t))),n.filter((t=>void 0!==t)),n.map((t=>t.deltaTime)),n.share());class mn extends t.Component{get video(){return this.video_}set video(t){this.video_!==t&&(this.video_=t,this.change&&(this.change.next(),this.init(),this.initStream()))}get audio(){return this.audio_}set audio(t){this.audio_!==t&&(this.audio_=t,this.change&&(this.change.next(),this.init(),this.initStream()))}get hasPreview(){return this.platform!==Ui&&this.platform!==Bi}onInit(){this.init()}init(){if(this.initialized_)return;this.initialized_=!0,this.platform=ji.platform;const{node:e}=t.getContext(this);this.onLoadedMetadata=this.onLoadedMetadata.bind(this);(this.preview=e.querySelector("video")).addEventListener("loadedmetadata",this.onLoadedMetadata);const i=e.querySelector(".audio");this.hasPreview&&(this.bars=new Array(32).fill(0).map((t=>{const e=document.createElement("div");return e.classList.add("bar"),i.appendChild(e),e})))}onDestroy(){this.preview.removeEventListener("loadedmetadata",this.onLoadedMetadata),this.hasPreview&&pn.dispose()}initStream(){const e=this.preview;if(!this.preview)return;const{node:i}=t.getContext(this);if(this.video_||this.audio_){if(i.classList.add("ready"),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const t=Se(ee.state),i={video:!!this.video_&&{deviceId:this.video_,width:{ideal:t.resolution.width},height:{ideal:t.resolution.height},frameRate:{ideal:t.frameRate.min,max:t.frameRate.max}},audio:!!this.audio_&&{deviceId:this.audio_}};this.platform===Ui&&(i.video.facingMode="user"),navigator.mediaDevices.getUserMedia(i).then((t=>{this.hasPreview?("srcObject"in e?e.srcObject=t:e.src=window.URL.createObjectURL(t),this.audio_&&this.analyzeData(t),this.loadingStream_=t):this.stream.next(t)})).catch((t=>{console.log("AgoraDevicePreviewComponent.initStream.error",t.name,t.message),this.stream.next(null)}))}}else i.classList.remove("ready"),this.hasPreview&&("srcObject"in e?e.srcObject=null:e.src=null,this.analyzeData(null)),this.stream.next(null)}onLoadedMetadata(e){const{node:i}=t.getContext(this);i.classList.add("loaded"),this.preview.play(),this.stream.next(this.loadingStream_)}analyzeData(t){this.frequencySubscription&&this.frequencySubscription.unsubscribe(),t&&(this.frequencySubscription=pn.frequency$(t,64).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.bars.forEach(((e,i)=>{const n=Math.min(100,5+t[i])/100;e.style.left=3.125*i+"%",e.style.transform=`scale(1,${n})`,e.style.opacity=n}))})))}}mn.meta={selector:"[agora-device-preview]",outputs:["stream","change"],inputs:["video","audio"]};class gn extends t.Component{get hasPreview(){return this.platform!==Ui&&this.platform!==Bi}onInit(){if(this.platform=ji.platform,this.isHttps="https:"===window.location.protocol,this.state={},this.devices={videos:[],audios:[]},this.stream=null,this.form=null,this.isHttps){const t=this.agora=Qi.getSingleton();ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()})),t&&t.devices$().subscribe((t=>{this.devices=t,this.initForm(t),this.pushChanges()}),(t=>{console.log("AgoraDeviceComponent.devices$.error",t)}))}}openHttps(t){window.location.href=window.location.href.replace("http://","https://").replace(":5000",":6443")}initForm(t){const i=this.form=new e.FormGroup({video:new e.FormControl(null,t.videos.length?e.Validators.RequiredValidator():void 0),audio:new e.FormControl(null,t.audios.length?e.Validators.RequiredValidator():void 0)}),s=this.controls=i.controls,o=t.videos.map((t=>({id:t.deviceId,name:t.label})));o.length>0&&o.unshift({id:null,name:"bhere_select_video"}),s.video.options=o;const r=t.audios.map((t=>({id:t.deviceId,name:t.label})));r.length>0&&r.unshift({id:null,name:"bhere_select_audio"}),s.audio.options=r,i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()}))}onStreamDidChange(t){this.stream=null,this.pushChanges()}onStream(t){this.stream=t,this.pushChanges()}isValid(){return this.form.valid&&(this.stream||!this.hasPreview)}onEnter(t){const e=this.form.value,i=this.devices;i.video=i.videos.find((t=>t.deviceId===e.video)),i.audio=i.audios.find((t=>t.deviceId===e.audio)),this.enter.next(i)}}gn.meta={selector:"[agora-device]",outputs:["enter"],template:'\n\t<div class="group--info" *if="!isHttps">\n\t\t<div class="group--info__content stagger--childs">\n\t\t\t<div class="title" [innerHTML]="\'bhere_invalid_protocol\' | label"></div>\n\t\t\t<div class="info" [innerHTML]="\'bhere_reload_in_https\' | label"></div>\n\t\t\t<button type="button" class="btn--connect" (click)="openHttps($event)">\n\t\t\t\t<span [innerHTML]="\'bhere_reload\' | label"></span>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t<div class="group--info" *if="form">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onEnter($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\x3c!-- PREVIEW --\x3e\n\t\t\t<div class="agora-device-preview" agora-device-preview [video]="controls.video.value" [audio]="controls.audio.value" (stream)="onStream($event)" (change)="onStreamDidChange($event)" *if="this.hasPreview">\n\t\t\t\t<video class="video" muted></video>\n\t\t\t\t<div class="audio"></div>\n\t\t\t</div>\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\x3c!-- VIDEO --\x3e\n\t\t\t\t<div control-custom-select [control]="controls.video" label="Video" *if="devices.videos.length"></div>\n\t\t\t\t\x3c!-- AUDIO --\x3e\n\t\t\t\t<div control-custom-select [control]="controls.audio" label="Audio" *if="devices.audios.length"></div>\n\t\t\t\t<div class="info" *if="!isValid()" [innerHTML]="\'bhere_select_video_audio\' | label"></div>\n\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="\'bhere_video_audio_connected\' | label"></div>\n\t\t\t\t<button type="submit" class="btn--connect" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t\t\t\t<span *if="!state.connecting" [innerHTML]="\'bhere_enter\' | label"></span>\n\t\t\t\t\t<span *if="state.connecting" [innerHTML]="\'bhere_connecting\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};const fn={WaitingRoom:{id:1,name:"waiting-room"},Panorama:{id:2,name:"panorama"},PanoramaGrid:{id:3,name:"panorama-grid"},Room3d:{id:4,name:"room-3d"},Model:{id:5,name:"model"},Media:{id:6,name:"media"}},vn={Nav:{id:1,name:"nav"},Plane:{id:2,name:"plane"},CurvedPlane:{id:3,name:"curved-plane"},Model:{id:4,name:"model"},Texture:{id:5,name:"texture"}};class _n{constructor(t){t&&(Object.assign(this,t),this.updateIndices(t.items)),this.items=(this.items||[]).filter((t=>function(t){let e;if(t.type.name===vn.Nav.name)e=null==t.viewId||function(t){return!Nn(t.title)&&!Nn(t.abstract)}(t)||ee.state.navigable;else e=!0;return e}(t))).map((t=>An(t))),this.tiles&&(this.tiles=this.tiles.map((t=>On(t)))),this.originalItems=this.items.slice(),this.lastOrientation={latitude:0,longitude:0},this.path=!0}get payload(){const t={};return Object.keys(this).forEach((e=>{if(-1!==_n.allowedProps.indexOf(e))switch(e){case"items":t[e]=this[e].map((t=>An(t).payload));break;case"tiles":t[e]=this[e].map((t=>On(t).payload));break;default:t[e]=this[e]}})),t}get pathItems(){return this.items.filter((t=>t.path))}get shortType(){return this.type?this.type.split("-").map((t=>t.substring(0,1).toUpperCase())).join(""):"??"}updateIndices(t){if(t){let e=0,i=0,n=0,s=0,o=0;t.forEach(((t,r)=>{if(t.index=r,t.asset)switch(t.asset.file){case"publisherStream":t.asset.index=e++;break;case"nextAttendeeStream":t.asset.index=i++;break;case"smartDeviceStream":t.asset.index=n++;break;case"publisherScreen":t.asset.index=s++;break;case"attendeeScreen":t.asset.index=o++}}))}}}_n.allowedProps=["id","type","name","hidden","likes","asset","items","orientation","zoom","ar","tiles","invertAxes","flipAxes"];class En extends _n{constructor(t){super(t)}}class Sn extends _n{static mapTiles(t,e,i,n){void 0===t&&(t=[]),void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===n&&(n="");const s=e?-1:1;return t.map(((t,e)=>{const o=new THREE.Vector2;return(t="string"==typeof t?{id:e+1,asset:{folder:n,file:t},navs:[]}:t).asset.file.replace(/_x([-|\d]+)_y([-|\d]+)/g,((t,e,n)=>{i?(o.y=parseInt(e),o.x=parseInt(n)*s):(o.x=parseInt(e),o.y=parseInt(n)*s)})),{id:t.id,type:Object.assign({},fn.PanoramaGrid),asset:t.asset,navs:t.navs||[],indices:o}}))}set index(t){this.index_!==t&&(this.index_=t,this.tiles.forEach(((e,i)=>e.selected=i===t)),this.updateCurrentItems(),this.index$.next(t))}get index(){return this.index_}constructor(t){t.tiles=Sn.mapTiles(t.tiles,t.flipAxes,t.invertAxes,t.asset?t.asset.folder:""),super(t),this.index_=0,this.index$=new i.Subject,this.tiles.forEach(((t,e)=>t.selected=0===e)),this.tiles.length&&(this.items=this.originalItems.concat(this.tiles[0].navs),this.asset=this.tiles[0].asset)}updateCurrentItems(){this.items=this.originalItems.concat(this.tiles[this.index_].navs)}getTileIndex(t,e){return this.tiles.reduce(((i,n,s)=>n.indices.x===t&&n.indices.y===e?s:i),-1)}hasTile(t,e){return-1!==this.getTileIndex(t,e)}getTile(t,e){const i=this.getTileIndex(t,e);if(-1!==i)return this.index=i,this.tiles[i]}}class Tn extends _n{constructor(t){super(t)}}class bn extends _n{constructor(t){super(t)}}class yn extends _n{constructor(t){super(t)}}class Cn{constructor(t){t&&Object.assign(this,t),this.path=!0;const e=this.links||(this.link?[this.link]:[]);this.links=e}get firstLink(){return this.links&&this.links.length?this.links[0]:null}get payload(){const t={};return Object.keys(this).forEach((e=>{-1!==Cn.allowedProps.indexOf(e)&&(t[e]=this[e])})),!t.link||t.link.title&&t.link.href||delete t.link,t}get hasPanel(){return this.type.name===vn.Nav.name&&(this.title&&""!==this.title||this.abstract&&""!==this.abstract||this.asset||this.link)}}Cn.allowedProps=["id","type","title","abstract","asset","link","links","viewId","hook","hookExtra","keepOrientation","important","transparent","position","rotation","scale","radius","height","arc"];class wn extends Cn{}class Rn{constructor(t){t&&Object.assign(this,t),this.navs=(this.navs||[]).map((t=>An(t))),this.originalItems=this.navs.slice()}get payload(){const t={};return Object.keys(this).forEach((e=>{if(-1!==Rn.allowedProps.indexOf(e))if("navs"===e)t[e]=this[e].map((t=>An(t).payload));else t[e]=this[e]})),t}}function In(t){switch(t.type.name){case fn.Panorama.name:t=new En(t);break;case fn.PanoramaGrid.name:t=new Sn(t);break;case fn.Room3d.name:t=new Tn(t);break;case fn.Model.name:t=new bn(t);break;case fn.Media.name:t=new yn(t);break;default:t=new _n(t)}return t}function An(t){if(t.type.name===vn.Nav.name)t=new wn(t);else t=new Cn(t);return t}function On(t){return new Rn(t)}function Nn(t){return t&&t.length>0}Rn.allowedProps=["id","asset","navs"];class kn{constructor(t){t&&Object.assign(this,t),this.items=this.items||[],this.originalItems=this.items.slice()}get payload(){const t={};return Object.keys(this).forEach((e=>{-1!==_n.allowedProps.indexOf(e)&&(t[e]=this[e])})),t}}function Ln(t){return t=new kn(t)}kn.allowedProps=["id","name","items"];const Pn={id:null,name:"Principale",items:[]};class Dn{static set paths(t){this.paths$.next(t)}static get paths(){return this.paths$.getValue()}static set path(t){this.path$.next(t)}static get path(){return this.path$.getValue()}static getCurrentPath$(t){return void 0===t&&(t=null),this.pathGet$().pipe(n.switchMap((e=>{this.paths=e;let i=Pn;if(t){const n=e.find((e=>e.id===t));n&&(i=n)}return this.path=i,this.path$})))}static pathGet$(){return x.flags.usePaths?yi.get$("/api/path").pipe(n.map((t=>(t.paths=t.paths.map((t=>Ln(t))),t.paths.unshift(Pn),t.paths)))):i.of([])}static addPath(t){const e=this.paths.slice();e.push(t),this.paths=e,this.path=t}static editPath(t){const e=this.paths.slice(),i=e.reduce(((e,i,n)=>i.id===t.id?n:e),-1);if(i>0){let n=this.path;n.id===t.id&&(n=t),e.splice(i,1,t),this.paths=e,this.path=n}}static deletePath(t){const e=this.paths.slice(),i=e.indexOf(t);if(i>0){e.splice(i,1),this.paths=e;let n=this.path;n.id===t.id&&(n=e[0]),this.path=n}}static pathCreate$(t){return yi.post$("/api/path",t).pipe(n.map((t=>Ln(t))))}static pathUpdate$(t){return yi.put$(`/api/path/${t.id}`,t).pipe(n.map((t=>Ln(t))))}static pathDelete$(t){return yi.delete$(`/api/path/${t.id}`)}}Dn.paths$=new i.BehaviorSubject([Pn]),Dn.path$=new i.BehaviorSubject(Pn);class Mn extends t.Component{get selfServiceTourRoute(){const t=this.form.get("path").value,e=[_e.transform(":lang.selfServiceTour")];return t&&e.push(re.validateParams({pathId:t})),e}onInit(){this.state={},this.paths=[],this.pathId=null,this.form=null,ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()})),x.flags.usePaths?Dn.getCurrentPath$().pipe(n.first(),n.tap(),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.paths=Dn.paths,this.pathId=t.id||"",this.onLoad()})):this.onLoad()}onLoad(){const t=this.form=new e.FormGroup({path:this.pathId,id:new e.FormControl(null,[e.Validators.PatternValidator(se),e.Validators.RequiredValidator()]),idAttendee:null,idStreamer:null,idViewer:null,idSmartDevice:null}),i=this.controls=t.controls,s=this.paths.map((t=>({id:t.id||"",name:t.name})));s.length>0&&s.unshift({id:null,name:"bhere_select_path"}),i.path.options=s,t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pathId!==t.path&&null!==t.id&&(this.pathId=t.path,this.onGenerateMeetingId()),this.pushChanges()}))}onGenerateMeetingId(t){let e=this.pathId?String(this.pathId):null;e=e&&e.length?e:null;const i=new oe({pathId:e}).toRoles();this.form.patch(i)}onInputDidChange(t){"publisher"===this.state.role&&setTimeout((()=>{if(this.form.get("id").valid){const t=this.form.get("id").value,e=new oe(t).toRoles();this.form.patch(e)}else this.form.get("idAttendee").reset(),this.form.get("idStreamer").reset(),this.form.get("idViewer").reset(),this.form.get("idSmartDevice").reset()}),1)}onCopyToClipBoard(t,e){void 0===e&&(e=!1);new re({link:t}).copyToClipBoard(e)}onNext(t){let e=this.controls.id.value;re.replaceWithLink(e),this.link.next(e)}isValid(){return this.form.valid}}Mn.meta={selector:"[agora-link]",outputs:["link"],template:'\n\t<div class="group--info" *if="form">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onNext($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t<div class="stagger--childs" *if="state.role !== \'publisher\'">\n\t\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.id.validators.length, \'addon\': controls.id.valid }">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_insert_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.id" [placeholder]="\'bhere_meeting_id\' | label" />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.id.value)" *if="controls.id.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="stagger--childs" *if="state.role === \'publisher\'">\n\t\t\t\t\t\x3c!-- PATH --\x3e\n\t\t\t\t\t<div control-custom-select [control]="controls.path" [label]="\'bhere_path\' | label" *if="(\'usePaths\' | flag) && paths.length"></div>\n\t\t\t\t\t\x3c!--IDS --\x3e\n\t\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.id.validators.length, \'addon\': controls.id.valid }">\n\t\t\t\t\t\t<label><svg class="lock" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#lock"></use></svg> <span [innerHTML]="\'bhere_insert_meeting_id\' | label"></span></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.id" [placeholder]="\'bhere_meeting_id\' | label" (change)="onInputDidChange($event)" />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.id.value)" *if="controls.id.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'attendee\' | flag) && controls.idAttendee.valid && controls.idAttendee.value !== null">\n\t\t\t\t\t\t<label><svg class="lock" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#lock"></use></svg> <span [innerHTML]="\'bhere_attendee_meeting_id\' | label"></span></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idAttendee" [placeholder]="\'bhere_attendee_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idAttendee.value)" *if="controls.idAttendee.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'streamer\' | flag) && controls.idStreamer.valid && controls.idStreamer.value !== null">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_streamer_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idStreamer" [placeholder]="\'bhere_streamer_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idStreamer.value)" *if="controls.idStreamer.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'viewer\' | flag) && controls.idViewer.valid && controls.idViewer.value !== null">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_viewer_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idViewer" [placeholder]="\'bhere_viewer_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idViewer.value)" *if="controls.idViewer.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'smartDevice\' | flag) && controls.idSmartDevice.valid && controls.idSmartDevice.value !== null">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_smart_device_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idSmartDevice" [placeholder]="\'bhere_smart_device_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idSmartDevice.value, true)" *if="controls.idSmartDevice.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="info" *if="controls.id.errors.required" [innerHTML]="\'bhere_insert_meeting_id\' | label"></div>\n\t\t\t\t<div class="info" *if="controls.id.errors.pattern" [innerHTML]="\'bhere_invalid_meeting_id\' | label"></div>\n\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="\'bhere_take_part_meeting\' | label"></div>\n\t\t\t\t<button type="button" class="btn--generate" *if="state.role == \'publisher\'" (click)="onGenerateMeetingId($event)">\n\t\t\t\t\t<span [innerHTML]="\'bhere_generate_meeting_id\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<span [innerHTML]="\'bhere_take_part\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<a [routerLink]="selfServiceTourRoute" class="btn--secondary" *if="state.role === \'publisher\'">\n\t\t\t\t\t<span [innerHTML]="\'bhere_self_service\' | label"></span>\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};class xn extends t.Component{onInit(){const t=this.form=new e.FormGroup({username:new e.FormControl(null,e.Validators.RequiredValidator()),password:new e.FormControl(null,e.Validators.RequiredValidator()),checkRequest:window.antiforgery||"",checkField:""});this.controls=t.controls,t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),this.error=null}test(){this.form.patch({username:"publisher",password:"publisher",checkRequest:window.antiforgery||"",checkField:""})}reset(){this.form.reset()}onSubmit(){if(this.form.valid){const t=this.form.value;this.form.submitted=!0,this.error=null,this.pushChanges(),Ci.login$(t).pipe(n.first()).subscribe((t=>{ee.state.role===t.type?(this.onNext(t),this.form.reset()):(this.error={friendlyMessage:ge.transform("error_credentials")},this.pushChanges())}),(t=>{console.log("AccessComponent.error",t),this.error=t,this.pushChanges()}))}else this.form.touched=!0}isValid(){return this.form.valid}onNext(t){re.replaceWithUser(t),this.login.next(t)}}xn.meta={selector:"[agora-login]",outputs:["login"],template:'\n\t<div class="group--info">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t<div class="title" [innerHTML]="\'bhere_login\' | label"></div>\n\t\t\t\t<input name="checkField" [formControl]="controls.checkField" value="" type="text" style="display:none !important;" />\n\t\t\t\t<div control-text [control]="controls.username" [label]="\'bhere_username\' | label"></div>\n\t\t\t\t<div control-password [control]="controls.password" [label]="\'bhere_password\' | label"></div>\n\t\t\t\t<div class="group--error" *if="error">\n\t\t\t\t\t<span class="status-code" [innerHTML]="error.statusCode"></span>\n\t\t\t\t\t<span class="status-message" [innerHTML]="error.statusMessage"></span>\n\t\t\t\t\t<span class="friendly-message" [innerHTML]="error.friendlyMessage"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="\'bhere_cta\' | label"></div>\n\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<span [innerHTML]="\'bhere_cta\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};class Un extends t.Component{onInit(){const t=new re;this.state={};const e=this.fields=[];if(x.flags.useExtendedUserInfo){const i=t.firstName,n=t.lastName,s=t.email;e.push({type:"text",name:"firstName",label:"access_first_name",required:!0,value:i,test:"Jhon"},{type:"text",name:"lastName",label:"access_last_name",required:!0,value:n,test:"Appleseed"},{type:"email",name:"email",label:"access_email",required:!0,value:s,test:"jhonappleseed@gmail.com"})}else{const i=t.name;e.push({type:"text",name:"name",label:"bhere_name_and_surname",pattern:/^\w{2,}\s\w{2,}/,required:!0,value:i,test:"Jhon Appleseed"})}e.push({type:"checkbox",name:"privacy",label:"access_privacy_disclaimer",required:!0,test:!0},{type:"hidden",name:"checkField",value:"",test:""},{type:"none",name:"checkRequest",value:x.antiforgery||"",test:x.antiforgery||""});const i=this.form=pe(e);this.controls=i.controls,i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()}))}test(){me(this.fields,this.form)}isValid(){return this.form.valid}onNext(t){let e,i;x.flags.useExtendedUserInfo?(i={firstName:this.controls.firstName.value,lastName:this.controls.lastName.value,email:this.controls.email.value},e=`${i.firstName} ${i.lastName}`):(i={name:this.controls.name.value},e=i.name),re.replaceWithOptions(i),this.name.next(e)}}Un.meta={selector:"[agora-name]",outputs:["name"],template:'\n\t<div class="group--info" *if="form">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onNext($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\x3c!-- controls --\x3e\n\t\t\t\t<div controls [formGroup]="form" [fields]="fields"></div>\n\t\t\t\t\x3c!-- NAME --\x3e\n\t\t\t\t\x3c!--\n\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.name.validators.length }">\n\t\t\t\t\t<label [innerHTML]="\'bhere_fill_fullname\' | label"></label>\n\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.name" [placeholder]="\'bhere_name_and_surname\' | label" />\n\t\t\t\t</div>\n\t\t\t\t<div class="info" *if="!controls.name.valid" [innerHTML]="\'bhere_fill_name_and_surname\' | label"></div>\n\t\t\t\t--\x3e\n\t\t\t\t<div class="info" *if="!isValid()"><span [innerHTML]="\'bhere_fill_name_and_surname\' | label"></span></div>\n\t\t\t\t<div class="info" *if="isValid()"><span [innerHTML]="\'bhere_proceed_as\' | label"></span> <span [innerHTML]="controls.name.value"></span></div>\n\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<span [innerHTML]="\'bhere_proceed\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};class Vn extends t.Component{set videoMuted(e){if(this.videoMuted_!==e){this.videoMuted_=e;const{node:i}=t.getContext(this);e?i.classList.add("video--muted"):i.classList.remove("video--muted")}}set audioMuted(e){if(this.audioMuted_!==e){this.audioMuted_=e;const{node:i}=t.getContext(this);e?i.classList.add("audio--muted"):i.classList.remove("audio--muted")}}get streamId(){return this.streamId_}set streamId(t){this.streamId_=t}get stream(){return this.stream_}set stream(e){try{if(this.stream_!==e){console.log("AgoraStreamComponent set stream",e);const{node:i}=t.getContext(this),n=this.player=i.querySelector(".agora-stream__player");this.stream_=e,e&&(this.videoMuted=e.userMuteVideo,this.audioMuted=e.userMuteAudio);const s=e?e.streamId:null;if(this.streamId=s,s){const t=`stream-${s}`;n.setAttribute("id",t);const i=this;if(e.isPlaying())e.resume(n);else{this.shouldUseResumeGesture=!1;try{e.play(n)}catch(t){qi.error("Stream.videoTrack.play.error",t),t&&"aborted"!==t.status&&(i.shouldUseResumeGesture=!0,i.pushChanges())}}}else n.removeAttribute("id")}}catch(t){qi.error("AgoraStreamComponent.stream.set.error",t)}}set vrContainer(t){this.vrContainer_!==t&&(this.vrContainer_=t,t?(this.stream_.vrContainer=t,this.player.appendChild(t)):this.stream_.vrContainer&&this.stream_.vrContainer.parentNode&&(this.stream_.vrContainer.parentNode.removeChild(this.stream_.vrContainer),this.stream_.vrContainer=null))}get videoNode(){let e=this.videoNode_;if(!e){const i=t.getContext(this).node.querySelector(".agora-stream__player");e=document.createElement("video"),this.onLoadedMetadata=this.onLoadedMetadata.bind(this),e.addEventListener("loadedmetadata",this.onLoadedMetadata),i.appendChild(e),this.videoNode_=e}return e}onInit(){this.videoMuted=!1,this.audioMuted=!1,this.shouldUseResumeGesture=!1,this.state={},ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.type){case ke:{const e=t.event;this.streamId&&e.streamId===this.streamId&&(e instanceof _i&&(this.videoMuted=!0),e instanceof Ei&&(this.videoMuted=!1),e instanceof Si&&(this.audioMuted=!0),e instanceof Ti&&(this.audioMuted=!1));break}case ri:this.streamId===t.clientId&&(this.vrContainer=t.container);break;case oi:this.streamId===t.clientId&&(this.vrContainer=null)}}))}setMediaStream(t){const e=this.videoNode;"srcObject"in e?e.srcObject=t:e.src=t?window.URL.createObjectURL(t):null}onLoadedMetadata(t){this.videoNode.play().then((t=>{}),(t=>{console.log("AgoraStreamComponent.play.error",t)}))}onToggleControl(t){this.toggleControl.next(t)}onToggleSpy(t){this.toggleSpy.next(t)}}Vn.meta={selector:"[agora-stream]",outputs:["toggleControl","toggleSpy"],inputs:["stream"]};class Fn{constructor(t){t&&Object.assign(this,t),this.items=(this.items||[]).map((t=>An(t))),this.originalItems=this.items.slice()}get payload(){const t={};return Object.keys(this).forEach((e=>{if(-1!==_n.allowedProps.indexOf(e))if("items"===e)t[e]=this[e].map((t=>An(t).payload));else t[e]=this[e]})),t}}function Bn(t){return t=new Fn(t)}Fn.allowedProps=["id","name","asset","items"];class jn{static set active(t){this.active$.next(t)}static get active(){return this.active$.getValue()}static navmapGet$(){return yi.get$("/api/navmap").pipe(n.map((t=>(t.navmaps.map((t=>Bn(t))),t.navmaps))))}static navmapCreate$(t){return yi.post$("/api/navmap",t).pipe(n.map((t=>Bn(t))))}static navmapUpdate$(t){return yi.put$(`/api/navmap/${t.id}`,t).pipe(n.map((t=>Bn(t))))}static navmapDelete$(t){return yi.delete$(`/api/navmap/${t.id}`)}static itemCreate$(t,e){return yi.post$(`/api/navmap/${t.id}/item`,e).pipe(n.map((t=>An(t))))}static itemUpdate$(t,e){return e=An(e),yi.put$(`/api/navmap/${t.id}/item/${e.id}`,e.payload).pipe(n.map((t=>An(t))))}static itemDelete$(t,e){return yi.delete$(`/api/navmap/${t.id}/item/${e.id}`)}}jn.active$=new i.BehaviorSubject(!1);class Hn{static push(t){return function(t){(window.dataLayer||[]).push(t),console.log("GtmService.dataLayer",t)}(t)}}const Gn="info",Wn="alert",$n="dialog",zn="centered",qn="bottom-right";class Kn{constructor(t){this.toast=t}}class Yn extends Kn{}class Jn extends Kn{}class Xn{static open$(t){switch(t.id=(new Date).getTime(),t.type=t.type||Gn,t.position=t.position||zn,t.type){case Wn:t.acceptMessage=t.acceptMessage||"Ok";break;case $n:t.acceptMessage=t.acceptMessage||"Accept",t.rejectMessage=t.rejectMessage||"Reject"}return this.toast$.next(t),t.type===Gn&&setTimeout((()=>{this.resolve(t)}),t.duration||4e3),this.events$}static resolve(t){this.toast$.next(null),this.events$.next(new Yn(t))}static reject(t){this.toast$.next(null),this.events$.next(new Jn(t))}}Xn.toast$=new i.Subject,Xn.events$=new i.Subject;class Zn extends t.Component{get modal(){return this.modal_}set modal(e){const{module:i}=t.getContext(this);this.modal_&&this.modal_.node&&(i.remove(this.modal_.node,this),this.modalNode.removeChild(this.modal_.node)),e&&e.node&&(this.modal_=e,this.modalNode.appendChild(e.node),i.compile(e.node)),this.modal_=e,this.pushChanges()}get busy(){return this.busy_}set busy(t){this.busy_!==t&&(this.busy_=t,this.pushChanges())}onInit(){this.busy_=!1;const{node:e}=t.getContext(this);this.modalNode=e.querySelector(".modal-outlet__modal"),an.modal$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.modal=t)),an.busy$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.busy=t))}reject(t){an.reject()}}Zn.meta={selector:"[modal-outlet]",template:'\n\t<div class="modal-outlet__container" [class]="{ active: modal, busy: busy }">\n\t\t<div class="modal-outlet__background" (click)="reject($event)"></div>\n\t\t<div class="modal-outlet__modal"></div>\n\t\t\x3c!-- spinner --\x3e\n\t\t<div class="spinner spinner--contrasted" *if="busy"></div>\n\t</div>\n\t'};class Qn extends t.Component{onInit(){super.onInit();const{parentInstance:e,node:i}=t.getContext(this);if(e instanceof Zn){const t=this.data=e.modal.data;if(t&&t.ar){const e=Qn.getUrl(t);new QRious({element:i.querySelector(".qrcode"),value:e,size:256})}}}onClose(){an.reject()}static getUrl(t){const e=te.buildUrl(_e.transform(":lang.tryInAr"),{viewId:t.id}),i=window.location.origin+e;return console.log("TryInARModalComponent.getUrl",i),i}static openInAR(t){const e=this.getUrl(t);window.open(e,"_blank")}}Qn.meta={selector:"[try-in-ar-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title" [innerHTML]="\'bhere_ar\' | label"></div>\n\t\t\t\t<div class="picture">\n\t\t\t\t\t<canvas class="qrcode"></canvas>\n\t\t\t\t</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onClose()">\n\t\t\t\t\t\t<span [innerHTML]="\'close\' | label"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},Qn.chunk=()=>'<div class="try-in-ar-modal" try-in-ar-modal></div>';const ts=["jpeg","jpg","png","hdr"],es=["mp4","webm"],is=["fbx","gltf","glb","usdz"],ns={Image:{id:1,name:"image"},Video:{id:2,name:"video"},Model:{id:3,name:"model"},PublisherStream:{id:4,name:"publisher-stream",file:"publisherStream"},AttendeeStream:{id:5,name:"next-attendee-stream",file:"nextAttendeeStream"},PublisherScreen:{id:6,name:"publisher-screen",file:"publisherScreen"},AttendeeScreen:{id:7,name:"attendee-screen",file:"attendeeScreen"},SmartDeviceStream:{id:8,name:"smart-device-stream",file:"smartDeviceStream"}},ss={ImageOrVideo:{id:1,name:"Image or Video",ids:[1,2]},Publisher:{id:3,name:"Publisher",ids:[4]},Attendee:{id:4,name:"Attendee",ids:[5]}};const os=[ns.PublisherStream.name,ns.AttendeeStream.name,ns.PublisherScreen.name,ns.AttendeeScreen.name,ns.SmartDeviceStream.name];function rs(t){return t&&-1!==os.indexOf(t.type.name)}function as(t){let e;return t&&t.asset&&(e=Object.keys(ss).find((e=>-1!==ss[e].ids.indexOf(t.asset.type.id)))),ss[e||"ImageOrVideo"]}function cs(t){const e=(i=t,Object.keys(ss).reduce(((t,e)=>{const n=ss[e];return n.id===i?n:t}),null));var i;const n=function(t){return Object.keys(ns).reduce(((e,i)=>{const n=ns[i];return n.id===t?n:e}),null)}(e.ids[0]),s=n.file;return new ls({type:n,folder:"",file:s})}function ds(t){const e=t.split(".").pop().toLowerCase();return-1!==ts.indexOf(e)?ns.Image:-1!==es.indexOf(e)?ns.Video:-1!==is.indexOf(e)?ns.Model:void 0}class ls{constructor(t){t&&Object.assign(this,t)}get payload(){const t={};return Object.keys(this).forEach((e=>{-1!==ls.allowedProps.indexOf(e)&&(t[e]=this[e])})),t}static fromUrl(t){const e=t.split("/"),i=e.pop(),n=e.join("/")+"/",s=ds(i);return new ls({type:s,folder:n,file:i})}static get defaultMediaAsset(){return{id:-1,type:{id:ns.Image,name:"image"},folder:"/textures/grid/",file:"grid.jpg"}}}function hs(t){return t.type.name,t=new ls(t)}ls.allowedProps=["id","type","folder","file","linkedPlayId","chromaKeyColor","autoplay","loop"];const us={id:"waiting-room",type:{id:1,name:"waiting-room"},name:"Waiting Room",likes:0,liked:!1,asset:{type:{id:1,name:"image"},folder:"/textures/waiting-room/",file:"waiting-room.jpg"},items:[],orientation:{latitude:0,longitude:0}};class ps{static get dataViews(){return this.data?this.data.views:[]}static get validViews(){return this.data?this.data.views.filter((t=>t.type.name!==fn.WaitingRoom.name)):[]}static get pathViews(){return this.validViews.filter((t=>t.path))}static get validPathViews(){return(this.editor?this.data.views:this.validViews).filter((t=>t.path))}static set action(t){this.action$_.next(t)}static get action(){return this.action$_.getValue()}static set viewId(t){this.action$_.next({viewId:t,keepOrientation:!1,useLastOrientation:!1})}static get viewId(){const t=this.action$_.getValue();return t?t.viewId:null}static getDataView(t){return this.dataViews.find((e=>e.id===t))||null}static get currentView(){const t=this.viewId;return null!==t?this.getDataView(t):null}static getValidPathId(t){if(!t)return null;return null==this.validPathViews.find((e=>e.id===t))?null:t}static getFirstPathId(){const t=this.editor&&null===this.path.id?this.dataViews:this.pathViews;return t.length?t[0].id:null}static data$(){if(!this.data$_){const t=(x.flags.production?"/api/view":`${x.assets}api/data.json`)+"?lang="+ve.lang;this.data$_=yi.get$(t).pipe(n.map((t=>(t.views=t.views.map((t=>In(t))),this.data=t,t))),n.shareReplay(1))}return this.data$_}static view$(){const t=new re,e=this.getValidPathId(t.viewId),i=this.getValidPathId(t.embedViewId)||e||this.getFirstPathId();return this.action$_.next({viewId:i}),this.action$_.pipe(n.distinctUntilChanged(((t,e)=>t.viewId===e.viewId)),n.map((t=>{let e=this.dataViews.find((e=>e.id===t.viewId));return e&&(e.keepOrientation=t.keepOrientation||!1,e.useLastOrientation=t.useLastOrientation||!1),e||this.getWaitingRoom()})))}static setDataAndPath(t,e){this.data=t,t.views.forEach((t=>{t.path=!e||-1===e.items.indexOf(t.id),t.items.forEach((t=>{let i=!0;e&&(t.type.name===vn.Nav.name&&(i=-1===e.items.indexOf(t.viewId)),t.path=i)}))})),this.path=e}static hostedView$(t,e){this.setDataAndPath(t,e),this.editor=!1;const s=this.getWaitingRoom();return i.combineLatest([this.view$(),this.hosted$()]).pipe(n.map((t=>{const e=t[0];return t[1]?e:s})),n.distinctUntilChanged(((t,e)=>t.id===e.id)),n.tap((t=>{if(t.id!==s.id){re.replaceWithOptions({viewId:t.id});const e=ps.getPrefetchAssets(t);t.prefetchAssets=e}})))}static editorView$(t,e){this.setDataAndPath(t,e),this.editor=!0;const i=this.getWaitingRoom();return this.view$().pipe(n.map((t=>{const n={pathId:null};return t.id!==i.id&&(n.viewId=t.id),e&&null!==e.id&&(n.pathId=e.id),re.replaceWithOptions(n),t})))}static hosted$(){return ee.state$.pipe(n.map((t=>t.hosted)),n.distinctUntilChanged())}static viewById$(t){return this.data$().pipe(n.map((e=>this.dataViews.find((e=>e.id===t)))))}static viewLike$(t){return t.liked?i.of(null):(t.liked=!0,x.flags.production?yi.get$(`/api/view/${t.id}/like`):(t.likes=t.likes||0,t.likes++,i.of(t)))}static setViewLike$(t){return this.viewById$(t.viewId).pipe(n.tap((e=>{e&&(e.likes=t.likes)})))}static getWaitingRoom(){return this.dataViews.find((t=>t.type.name===fn.WaitingRoom.name))||us}static getPrefetchAssets(t){const e=this.validPathViews;return t.items.filter((t=>t.type.name===vn.Nav.name&&null!=t.viewId)).map((t=>e.find((e=>e.id===t.viewId)))).filter((t=>t&&t.asset&&t.asset.type.name===ns.Image.name)).map((t=>x.getPath(t.asset.folder+t.asset.file)))}static addView(t){const e=this.data,i=e.views.slice();i.push(t),e.views=i,this.viewId=t.id}static deleteView(t){const e=this.data,i=e.views.slice(),n=i.reduce(((e,i,n)=>i.id===t.id?n:e),-1);if(n>0){i.splice(n,1),e.views=i;const t=this.dataViews;t.length>0&&(this.viewId=t[0].id)}}}ps.action$_=new i.BehaviorSubject(null);let ms=null;class gs{static get items$(){if(!ms){const t=cn.get("wishlist")||[];ms=new i.BehaviorSubject(t)}return ms}static getItems(){return this.items$.getValue()}static indexOf(t){return this.getItems().reduce(((e,i,n)=>-1===e&&i.viewId===t.viewId&&i.itemId===t.itemId?n:e),-1)}static has(t){return-1!==this.indexOf(t)}static add$(t){const e=this.getItems();return this.has(t)||(e.push(t),cn.set("wishlist",e),this.items$.next(e)),this.items$}static remove$(t){const e=this.getItems(),i=this.indexOf(t);return-1!==i&&(e.splice(i,1),cn.set("wishlist",e),this.items$.next(e)),this.items$}static toggle$(t){const e=this.getItems(),i=this.indexOf(t);return-1!==i?(e.splice(i,1),cn.set("wishlist",e),this.items$.next(e)):(e.push(t),cn.set("wishlist",e),this.items$.next(e)),this.items$}}class fs{constructor(t){this.loader=t}}class vs extends fs{}class _s extends fs{}class Es extends fs{}class Ss extends fs{}class Ts extends fs{}class bs{static getLoader(){return bs.loader||(bs.loader=new THREE.TextureLoader)}static getPath(t){return x.getPath(t.asset.folder+t.asset.file)}static loadTexture(t,e){const i=bs.getPath(t);return bs.getLoader().load(i,e)}static isVideo(t){return t.asset&&t.asset.file&&(-1!==t.asset.file.indexOf(".mp4")||-1!==t.asset.file.indexOf(".webm"))}static isStream(t){return rs(t.asset)}static isMutedStream(t){let e=!1;switch(t.asset.type.name){case ns.PublisherStream.name:e=ee.state.role===ie.Publisher;break;case ns.AttendeeStream.name:e=ee.state.role===ie.Attendee;break;case ns.PublisherScreen.name:case ns.AttendeeScreen.name:e=!0;break;case ns.SmartDeviceStream.name:e=ee.state.role===ie.SmartDevice}return e}static isPublisherStream(t){return t.asset&&t.asset.type.name===ns.PublisherStream.name}static isAttendeeStream(t){return t.asset&&t.asset.type.name===ns.AttendeeStream.name}static isSmartDeviceStream(t){return t.asset&&t.asset.type.name===ns.SmartDeviceStream.name}static isPublisherScreen(t){return t.asset&&t.asset.type.name===ns.PublisherScreen.name}static isAttendeeScreen(t){return t.asset&&t.asset.type.name===ns.AttendeeScreen.name}get isVideo(){return bs.isVideo(this.item)}get isStream(){return bs.isStream(this.item)}get isMutedStream(){return bs.isMutedStream(this.item)}get isPublisherStream(){return bs.isPublisherStream(this.item)}get isAttendeeStream(){return bs.isAttendeeStream(this.item)}get isSmartDeviceStream(){return bs.isSmartDeviceStream(this.item)}get isPublisherScreen(){return bs.isPublisherScreen(this.item)}get isAttendeeScreen(){return bs.isAttendeeScreen(this.item)}get isPlayableVideo(){return this.isVideo}get isAutoplayVideo(){return this.isStream}get muted(){return this.muted_}set muted(t){this.muted_=t,this.video&&this.isVideo&&(this.video.muted=!0===t)}constructor(t){this.item=t,this.toggle=this.toggle.bind(this),this.muted_=!1,this.subscription=ee.state$.subscribe((t=>this.muted=t.volumeMuted))}load(t){const e=this.item;let i;if(this.isStream&&e.streamId){const n=e.streamId,s=document.querySelector(`#stream-${n} video`);if(!s)return;const o=()=>{this.disposed||(s.removeEventListener("canplay",o),i=this.texture=new THREE.VideoTexture(s),i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter,i.mapping=THREE.UVMapping,i.needsUpdate=!0,"function"==typeof t&&t(i,this))},r=this.isMutedStream;s.crossOrigin="anonymous",s.volume=r?0:1,s.muted=r,s.readyState>=s.HAVE_FUTURE_DATA?o():s.addEventListener("canplay",o)}else if(this.isVideo){const n=e.asset&&e.asset.autoplay||!1,s=e.asset&&e.asset.loop||!1,o=this.video=document.createElement("video");o.crossOrigin="anonymous",o.preload="metadata",o.volume=.8,o.muted=n,o.playsInline=!0,o.loop=s;const r=()=>{this.disposed||(o.oncanplay=null,i=new THREE.VideoTexture(o),i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter,i.mapping=THREE.UVMapping,i.needsUpdate=!0,"function"==typeof t&&t(i,this),n?this.play(e.silent):o.pause())},a=()=>{this.disposed||bs.events$.next(new Ss(this))},c=()=>{this.disposed||s||bs.events$.next(new _s(this))},d=t=>{console.log("MediaLoader.load.error",t),o.error instanceof MediaError&&setTimeout((()=>{ge.transform("media_error"),file,Xn.open$({message:`impossible to reproduce the video source. ${file}`,type:Wn,position:qn})}),500)};o.oncanplay=r,o.ontimeupdate=a,o.onended=c,o.onerror=d,o.src=bs.getPath(e),o.load()}else e.asset?bs.loadTexture(e,(e=>{this.disposed||(e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.mapping=THREE.UVMapping,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,"function"==typeof t&&t(e,this))})):t(null,this);return this}get progress(){return this.video?this.video.currentTime/this.video.duration:0}set progress(t){if(this.video){const e=this.video.duration*t;this.video.seekable.length>t&&this.video.currentTime!==e&&(this.video.currentTime=e,bs.events$.next(new Ts(this)))}}play(t){const e=this.video;e&&(e.muted=this.muted_,e.play().then((()=>{t||bs.events$.next(new vs(this))}),(e=>{console.log("MediaLoader.play.error",this.item.asset.file,e),setTimeout((()=>{Xn.open$({message:"interact with the page to reproduce audio.",type:Wn,position:qn})}),500),this.tryMuted(t)})))}tryMuted(t){const e=this.video;e&&(this.muted=!0,e.play().then((()=>{t||bs.events$.next(new vs(this))}),(t=>{console.log("MediaLoader.tryMuted.error",this.item.asset.file,t)})))}pause(t){this.video&&this.isVideo&&(this.video.muted=!0,this.video.pause(),t||bs.events$.next(new _s(this)))}toggle(){if(this.video&&this.isVideo)return this.video.paused?(this.video.muted=this.muted_,this.play(),!0):(this.pause(),!1)}dispose(){this.subscription.unsubscribe(),this.pause(!0),this.isVideo&&this.video&&(this.video.ontimeupdate=null,this.video.onended=null,bs.events$.next(new Es(this))),this.disposed=!0,delete this.video}}bs.events$=new i.ReplaySubject(1);class ys{static get defaultGeometry(){return ys.defaultGeometry_||(ys.defaultGeometry_=new THREE.BoxBufferGeometry(1,1,1))}static get planeGeometry(){return ys.planeGeometry_||(ys.planeGeometry_=new THREE.PlaneBufferGeometry(1,1,2,2))}static get sphereGeometry(){return ys.sphereGeometry_||(ys.sphereGeometry_=new THREE.SphereBufferGeometry(3,12,12))}static get panoramaGeometry(){return ys.panoramaGeometry_||(ys.panoramaGeometry_=new THREE.SphereBufferGeometry(101,36,36))}}new THREE.Vector3;class Cs{static get origin(){const t=this.host;if(t){const e=this.origin_;e.set(0,0,0);(t.renderer.xr.isPresenting?t.renderer.xr.getCamera(t.camera):t.camera).localToWorld(e)}return this.origin_}static getDistanceToCamera(t,e,i,n,s){void 0===s&&(s=.88);const o=2*Math.atan(Math.PI*e/360),r=n.y*t.zoom/o,a=n.x*t.zoom/o/i;return s*Math.max(r,a)}}Cs.origin_=new THREE.Vector3;class ws{}ws.items=[],ws.hittest=function(t,e,i){void 0===e&&(e=!1);let n=!1;this.down!==e&&(this.down=e,this.lock=!1,n=!0);const s=this.items.filter((t=>t.parent&&!t.freezed)),o=t.intersectObjects(s);let r,a;const c={};o.forEach(((t,e)=>{const i=t.object;r=i.uuid,0===e&&(this.lastIntersectedObject!==i||n?(this.lastIntersectedObject=i,a=i):i.intersection&&(Math.abs(i.intersection.point.x-t.point.x)>.01||Math.abs(i.intersection.point.y-t.point.y)>.01)&&(i.intersection=t,i.emit("move",i))),c[r]=t})),0===o.length&&(this.lastIntersectedObject=null);return s.forEach((t=>{t.intersection=c[t.uuid],t.over=t===this.lastIntersectedObject||t.intersection&&!t.depthTest&&(!this.lastIntersectedObject||this.lastIntersectedObject.depthTest),t.down=e&&t.over&&!this.lock,t.down&&(this.lock=!0)})),a}.bind(ws),ws.dispose=function(t){if(t){const e=this.items.indexOf(t);-1!==e&&this.items.splice(e,1)}}.bind(ws);class Rs extends s.Mesh{get freezed(){return this.freezed_}set freezed(t){this.freezed_=t,this.children.filter((t=>t.__lookupGetter__("freezed"))).forEach((e=>e.freezed=t))}constructor(t,e){super(t=t||ys.defaultGeometry,e=e||new THREE.MeshBasicMaterial({color:16711935})),this.freezed=!1}freeze(){this.freezed=!0}unfreeze(){this.freezed=!1}}class Is extends Rs{constructor(t,e){super(t=t||ys.defaultGeometry,e=e||new THREE.MeshBasicMaterial({color:16711935})),this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}}class As extends Is{constructor(t,e){super(t,e),this.depthTest=!0,this.over_=!1,this.down_=!1,ws.items.push(this)}get isInteractiveMesh(){return!0}get over(){return this.over_}set over(t){this.over_!=t&&(this.over_=t,t?this.emit("over",this):this.emit("out",this))}get down(){return this.down_}set down(t){t=t&&this.over,this.down_!=t&&(this.down_=t,t?this.emit("down",this):this.emit("up",this))}}class Os extends s.DataTextureLoader{constructor(t){super(t),this.type=s.HalfFloatType}parse(t){const e=function(t,e){switch(t){case 1:console.error("THREE.RGBELoader Read Error: "+(e||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(e||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(e||""));break;default:console.error("THREE.RGBELoader: Error: "+(e||""))}return-1},i=function(t,e,i){e=e||1024;let n=t.pos,s=-1,o=0,r="",a=String.fromCharCode.apply(null,new Uint16Array(t.subarray(n,n+128)));for(;0>(s=a.indexOf("\n"))&&o<e&&n<t.byteLength;)r+=a,o+=a.length,n+=128,a+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(n,n+128)));return-1<s&&(!1!==i&&(t.pos+=o+s+1),r+a.slice(0,s))},n=function(t,e,i,n){const s=t[e+3],o=Math.pow(2,s-128)/255;i[n+0]=t[e+0]*o,i[n+1]=t[e+1]*o,i[n+2]=t[e+2]*o,i[n+3]=1},o=function(t,e,i,n){const o=t[e+3],r=Math.pow(2,o-128)/255;i[n+0]=s.DataUtils.toHalfFloat(Math.min(t[e+0]*r,65504)),i[n+1]=s.DataUtils.toHalfFloat(Math.min(t[e+1]*r,65504)),i[n+2]=s.DataUtils.toHalfFloat(Math.min(t[e+2]*r,65504)),i[n+3]=s.DataUtils.toHalfFloat(1)},r=new Uint8Array(t);r.pos=0;const a=function(t){const n=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,o=/^\s*FORMAT=(\S+)\s*$/,r=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,a={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let c,d;if(t.pos>=t.byteLength||!(c=i(t)))return e(1,"no header found");if(!(d=c.match(/^#\?(\S+)/)))return e(3,"bad initial token");for(a.valid|=1,a.programtype=d[1],a.string+=c+"\n";c=i(t),!1!==c;)if(a.string+=c+"\n","#"!==c.charAt(0)){if((d=c.match(n))&&(a.gamma=parseFloat(d[1])),(d=c.match(s))&&(a.exposure=parseFloat(d[1])),(d=c.match(o))&&(a.valid|=2,a.format=d[1]),(d=c.match(r))&&(a.valid|=4,a.height=parseInt(d[1],10),a.width=parseInt(d[2],10)),2&a.valid&&4&a.valid)break}else a.comments+=c+"\n";return 2&a.valid?4&a.valid?a:e(3,"missing image size specifier"):e(3,"missing format specifier")}(r);if(-1!==a){const t=a.width,i=a.height,c=function(t,i,n){const s=i;if(s<8||s>32767||2!==t[0]||2!==t[1]||128&t[2])return new Uint8Array(t);if(s!==(t[2]<<8|t[3]))return e(3,"wrong scanline width");const o=new Uint8Array(4*i*n);if(!o.length)return e(4,"unable to allocate buffer space");let r=0,a=0;const c=4*s,d=new Uint8Array(4),l=new Uint8Array(c);let h=n;for(;h>0&&a<t.byteLength;){if(a+4>t.byteLength)return e(1);if(d[0]=t[a++],d[1]=t[a++],d[2]=t[a++],d[3]=t[a++],2!=d[0]||2!=d[1]||(d[2]<<8|d[3])!=s)return e(3,"bad rgbe scanline format");let i,n=0;for(;n<c&&a<t.byteLength;){i=t[a++];const s=i>128;if(s&&(i-=128),0===i||n+i>c)return e(3,"bad scanline data");if(s){const e=t[a++];for(let t=0;t<i;t++)l[n++]=e}else l.set(t.subarray(a,a+i),n),n+=i,a+=i}const u=s;for(let t=0;t<u;t++){let e=0;o[r]=l[t+e],e+=s,o[r+1]=l[t+e],e+=s,o[r+2]=l[t+e],e+=s,o[r+3]=l[t+e],r+=4}h--}return o}(r.subarray(r.pos),t,i);if(-1!==c){let e,r,d,l;switch(this.type){case s.FloatType:l=c.length/4;const t=new Float32Array(4*l);for(let e=0;e<l;e++)n(c,4*e,t,4*e);e=t,d=s.FloatType;break;case s.HalfFloatType:l=c.length/4;const i=new Uint16Array(4*l);for(let t=0;t<l;t++)o(c,4*t,i,4*t);e=i,d=s.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:t,height:i,data:e,header:a.string,gamma:a.gamma,exposure:a.exposure,format:r,type:d}}}return null}setDataType(t){return this.type=t,this}load(t,e,i,n){return super.load(t,(function(t,i){switch(t.type){case s.FloatType:case s.HalfFloatType:t.encoding=s.LinearEncoding,t.minFilter=s.LinearFilter,t.magFilter=s.LinearFilter,t.generateMipmaps=!1,t.flipY=!0}e&&e(t,i)}),i,n)}}class Ns{static keydown$(){return this.keydown$_||(this.keydown$_=i.fromEvent(window,"keydown").pipe(n.shareReplay(1))),this.keydown$_}static keyup$(){return this.keyup$_||(this.keyup$_=i.fromEvent(window,"keyup").pipe(n.shareReplay(1))),this.keyup$_}static keys$(){return this.keys$_||(this.keys$_=i.merge(this.keydown$(),this.keyup$()).pipe(n.map((t=>{const e=this.keys;return"keydown"===t.type?e[t.key]=!0:delete e[t.key],this.keys})),n.startWith(this.keys),n.shareReplay(1))),this.keys$_}static key$(){if(!this.key$_){const t=/\w/;this.key$_=this.keydown$().pipe(n.filter((e=>e.key&&e.key.match(t))),n.map((t=>t.key)),n.shareReplay(1))}return this.key$_}static typing$(){if(!this.typing$_){let t,e="";this.typing$_=this.key$().pipe(n.map((i=>(t&&clearTimeout(t),e+=i,t=setTimeout((()=>{e=""}),1500),e))),n.shareReplay(1))}return this.typing$_}}Ns.keys={};let ks=0;class Ls{static switchLoaders(){const t=Object.keys(this.items).map((t=>this.items[t])),e=t.length?i.combineLatest(t):i.of(t);this.progress$.next(e)}static getRef(){const t=++ks;return this.items[t]=new i.BehaviorSubject({loaded:0,total:1}),this.switchLoaders(),t}static setProgress(t,e,i){void 0===i&&(i=1);const n=this.items[t];n&&n.next({loaded:e,total:i}),e>=i&&setTimeout((()=>{delete this.items[t],this.switchLoaders()}),300),this.switchLoaders()}}Ls.progress={value:0,loaded:0,total:0,count:0,title:""},Ls.items={},Ls.progress$=new i.ReplaySubject(1).pipe(n.switchAll(),n.map((()=>{const t=Object.keys(Ls.items).map((t=>Ls.items[t])),e=t.reduce(((t,e,i,n)=>{const s=e.getValue(),o=s.loaded||0,r=s.total||1,a=o/r;return t.value+=a,t.loaded+=o,t.total+=r,t}),{value:0,loaded:0,total:0});return e.count=t.length,t.length&&(e.value/=e.count),e.title=`${Math.round(100*e.value)}%`,Ls.progress=e,e})));let Ps=0;const Ds="complete";class Ms{static worker(){return this.worker_||(this.worker_=new Worker(x.workers.prefetch)),this.worker_}static events$(t){if(!("Worker"in window))return i.of({type:Ds,data:t});const e=this.worker();e.postMessage({id:Ps});const s=++Ps;return e.postMessage({id:s,assets:t}),i.fromEvent(e,"message").pipe(n.map((t=>t.data)),n.filter((e=>e.assets===t)),n.tap((t=>{})),n.takeWhile((t=>t.type!==Ds),!0),n.finalize((()=>{e.postMessage({id:s})})))}static load$(t){return this.events$(t).pipe(n.filter((t=>t.type===Ds)),n.map((t=>t.data)))}static prefetch(t){x.flags.usePrefetch&&this.load$(t).pipe(n.first()).subscribe((t=>{}))}static cancel(){if(!("Worker"in window))return null;const t=this.worker();return t.postMessage({id:Ps}),t}}class xs{constructor(t){this.x=0,this.y=0,this.top=0,this.right=0,this.bottom=0,this.left=0,this.width=0,this.height=0,this.set(t)}static contains(t,e,i){return t.top<=i&&i<=t.bottom&&t.left<=e&&e<=t.right}static intersectRect(t,e){return!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)}static fromNode(t){if(!t)return;const e=t.rect_||(t.rect_=new xs);if(!t.getClientRects().length)return e;const i=t.getBoundingClientRect();return e.x=i.left,e.y=i.top,e.top=i.top,e.left=i.left,e.width=i.width,e.height=i.height,e.right=e.left+e.width,e.bottom=e.top+e.height,e.setCenter(),e}set(t){t&&(Object.assign(this,t),this.right=this.left+this.width,this.bottom=this.top+this.height),this.setCenter()}setSize(t,e){this.width=t,this.height=e,this.right=this.left+this.width,this.bottom=this.top+this.height,this.setCenter()}setCenter(){const t=this.center||(this.center={});t.top=this.top+this.height/2,t.left=this.left+this.width/2,t.x=t.left,t.y=t.top}contains(t,e){return xs.contains(this,t,e)}intersect(t){return xs.intersectRect(this,t)}intersection(t){const e=this.intersection_||(this.intersection_={left:0,top:0,width:0,height:0,x:0,y:0,pow:{x:-1,y:-1},offset:function(t){t=t||0;return(this.top-this.rect.height/2+t)/-this.height},scroll:function(t){t=t||0;return(this.top-this.rect.height/2+t)/-this.height}});e.left=this.left,e.top=this.top,e.width=this.width,e.height=this.height,e.x=this.left+this.width/2,e.y=this.top+this.height/2,e.rect=t;const i=e.offset(0);return e.pow.y=i,e}}const Us=[16763904,65484,52479,13434624,13369599,16777215];class Vs{static get headGeometry(){return this.headGeometry_||(this.headGeometry_=new THREE.SphereBufferGeometry(.2,36,24)),this.headGeometry_}constructor(t){const e=this.clientId=t.clientId,i=this.container=t.container,n=this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1,premultipliedAlpha:!0});n.setClearColor(0,1),n.setPixelRatio(window.devicePixelRatio),n.setSize(320,240),n.toneMapping=THREE.ACESFilmicToneMapping,n.toneMappingExposure=.8,n.outputEncoding=THREE.sRGBEncoding,i.appendChild(n.domElement);const s=this.camera=new THREE.PerspectiveCamera(70,320/240,.01,1e3);s.position.set(0,0,-.5),s.target=new THREE.Vector3,s.lookAt(s.target);const o=this.scene=new THREE.Scene,r=this.light=new THREE.PointLight(16777215,1,100);r.position.set(0,2,-2),o.add(r);const a=this.head=this.addHead();o.add(a),this.remote=Zi.getRemoteById(e)}addHead(){const t=Vs.headGeometry,e=this.canvas=document.createElement("canvas");e.width=1024,e.height=512,this.ctx=this.canvas.getContext("2d");const i=this.map=new THREE.CanvasTexture(e);i.offset.x=-.25;const n=Us[this.clientId%Us.length],s=new THREE.MeshStandardMaterial({map:i,color:n});return this.chalk(0),new THREE.Mesh(t,s)}render(){if(this.tick_?++this.tick_:this.tick_=1,this.remote){const t=12*this.remote.getAudioLevel();this.chalk(t)}const t=this.renderer,e=this.scene,i=this.camera;t.render(e,i)}update(t){const e=t.camera;this.head.quaternion.set(e[3],e[4],e[5],e[6])}dispose(){this.subscription&&this.subscription.unsubscribe()}chalk(t){t=(t+.5*Math.PI)%(2*Math.PI);const e=30*Math.sin(t),i=10*Math.cos(t),n=256,s=this.ctx;s.fillStyle="#888888",s.fillRect(0,0,1024,512),s.fillStyle="white",s.beginPath(),s.arc(472,206,7,0,2*Math.PI),s.arc(552,206,7,0,2*Math.PI),s.closePath(),s.fill(),s.beginPath(),s.moveTo(472-i,286),s.bezierCurveTo(472-i,316,552+i,316,552+i,286),s.bezierCurveTo(552+i,n+e,472-i,n+e,472-i,286),s.closePath(),s.fill(),this.map.needsUpdate=!0}}class Fs{static get defaultTexture(){return Fs.defaultTexture_||(Fs.defaultTexture_=(new THREE.TextureLoader).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyNpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDA2IDc5LjE2NDc1MywgMjAyMS8wMi8xNS0xMTo1MjoxMyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIyLjMgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjcyODFGQkE0QUMxODExRUJBQkRBQTEyMzUzMjUxRjg2IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjcyODFGQkE1QUMxODExRUJBQkRBQTEyMzUzMjUxRjg2Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzI4MUZCQTJBQzE4MTFFQkFCREFBMTIzNTMyNTFGODYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NzI4MUZCQTNBQzE4MTFFQkFCREFBMTIzNTMyNTFGODYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz55AlN+AAAAZUlEQVR42uzQAQEAAAQDMPTvfD3YIqyT1GdTzwkQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAgAtWgAEAVbYDfaostxgAAAAASUVORK5CYII="))}static get gridTexture(){return Fs.gridTexture_||(Fs.gridTexture_=(new THREE.TextureLoader).load(x.getPath(x.textures.grid)))}}class Bs extends As{static getLoader(){return Bs.loader||(Bs.loader=new THREE.TextureLoader)}static getTextureOff(){return Bs.textureOff||(Bs.textureOff=Bs.getLoader().load(x.getPath("textures/ui/play-off.png")))}static getTextureOn(){return Bs.textureOn||(Bs.textureOn=Bs.getLoader().load(x.getPath("textures/ui/play-on.png")))}static getMaterial(){return new THREE.MeshBasicMaterial({map:Bs.getTextureOff(),color:16777215,opacity:1,transparent:!0})}get playing(){return this.playing_}set playing(t){if(this.playing_!==t){this.playing_=t;this.material.map=t?Bs.getTextureOn():Bs.getTextureOff(),this.onOut()}}constructor(t){const e=ys.planeGeometry,i=Bs.getMaterial();super(e,i),this.playing_=!1,this.material=i,this.host=t,this.colorOff=new THREE.Color(i.color.getHex()),this.colorOn=new THREE.Color("#888888"),this.addEventListener()}update(t){const e=this.scale,i=t.scale.x/t.scale.y;e.set(.3/i,.3,1)}disposeMaterial(){this.material&&(this.material.map&&!1!==this.material.map.disposable&&this.material.map.dispose(),this.material.dispose())}dispose(){this.removeEventListener(),this.disposeMaterial()}onOver(){const t=this.material.color,e=this.colorOn,i=this.material;gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut}),gsap.to(i,{opacity:1,duration:.2,ease:Power2.easeInOut})}onOut(){const t=this.material.color,e=this.colorOff,i=this.material;gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut}),gsap.to(i,{opacity:this.playing?0:1,duration:.2,ease:Power2.easeInOut})}addEventListener(){this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this),this.on("over",this.onOver),this.on("out",this.onOut)}removeEventListener(){this.off("over",this.onOver),this.off("out",this.onOut)}}class js extends As{static getLoader(){return js.loader||(js.loader=new THREE.TextureLoader)}static getTextureOff(){return js.textureOff||(js.textureOff=js.getLoader().load(x.getPath("textures/ui/zoom-off.png")))}static getTextureOn(){return js.textureOn||(js.textureOn=js.getLoader().load(x.getPath("textures/ui/zoom-on.png")))}static getMaterial(){return new THREE.MeshBasicMaterial({map:js.getTextureOff(),color:16777215,opacity:1,transparent:!0})}get zoomed(){return this.zoomed_}set zoomed(t){if(this.zoomed_!==t){this.zoomed_=t;this.material.map=t?js.getTextureOn():js.getTextureOff()}}constructor(t){const e=ys.planeGeometry,i=js.getMaterial();super(e,i),this.zoomed_=!1,this.material=i,this.host=t,this.colorOff=new THREE.Color(i.color.getHex()),this.colorOn=new THREE.Color("#888888"),this.object=new THREE.Object3D,this.addEventListener()}disposeMaterial(){this.material&&(this.material.map&&!1!==this.material.map.disposable&&this.material.map.dispose(),this.material.dispose())}dispose(){this.removeEventListener(),this.disposeMaterial()}onOver(){const t=this.material.color,e=this.colorOn;this.material,gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut})}onOut(){const t=this.material.color,e=this.colorOff;this.material,gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut})}onToggle(){this.emit("zoomed",!this.zoomed)}addEventListener(){this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this),this.onToggle=this.onToggle.bind(this),this.on("over",this.onOver),this.on("out",this.onOut),this.on("down",this.onToggle)}removeEventListener(){this.off("over",this.onOver),this.off("out",this.onOut),this.off("down",this.onToggle)}}const Hs="\nvarying vec2 vUvShader;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\tvUvShader = uv;\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",Gs="\n#define USE_MAP\n#define threshold 0.55\n#define padding 0.05\nvarying vec2 vUvShader;\n\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\n// uniform sampler2D map;\nuniform sampler2D playMap;\nuniform vec2 mapResolution;\nuniform vec2 playMapResolution;\nuniform float mapTween;\nuniform float playMapTween;\nuniform vec3 playMapColor;\nuniform vec3 chromaKeyColor;\nuniform bool isVideo;\n\nvoid main() {\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\n\t// main\n\tvec4 mapRgba = texture2D(map, vUvShader);\n\tvec4 chromaKey = vec4(chromaKeyColor, 1.0);\n    vec3 chromaKeyDiff = mapRgba.rgb - chromaKey.rgb;\n    float chromaKeyValue = smoothstep(threshold - padding, threshold + padding, dot(chromaKeyDiff, chromaKeyDiff));\n\t/*\n\tif (isVideo) {\n\t\tvec4 playMapRgba = texture2D(playMap, vUvShader);\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2) + (playMapRgba.rgb * mapTween * playMapRgba.a), opacity * chromaKeyValue);\n\t} else {\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity * chromaKeyValue);\n\t}\n\t*/\n\t// diffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity * chromaKeyValue);\n\tdiffuseColor = vec4(mapRgba.rgb, opacity * chromaKeyValue);\n\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t// accumulation (baked indirect lighting only)\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t// modulation\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\n\t#include <envmap_fragment>\n\n\tgl_FragColor = vec4(outgoingLight, diffuseColor.a);\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n";class Ws extends As{static getMaterial(t){return new THREE.ShaderMaterial({depthTest:!0,depthWrite:!0,transparent:!0,toneMapped:!1,vertexShader:Hs,fragmentShader:t?Gs:"\n#define USE_MAP\n\nvarying vec2 vUvShader;\n\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\n// uniform sampler2D map;\nuniform sampler2D playMap;\nuniform vec2 mapResolution;\nuniform vec2 playMapResolution;\nuniform float mapTween;\nuniform float playMapTween;\nuniform vec3 playMapColor;\nuniform bool isVideo;\n\nvoid main() {\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4(vec3(1.0), opacity);\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\n\t// main\n\tvec4 mapRgba = texture2D(map, vUvShader);\n\tif (isVideo) {\n\t\tvec4 playMapRgba = texture2D(playMap, vUvShader);\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2) + (playMapRgba.rgb * mapTween * playMapRgba.a), opacity);\n\t} else {\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity);\n\t}\n\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\n\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\n\n\t// accumulation (baked indirect lighting only)\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",uniforms:{map:{type:"t",value:Fs.defaultTexture},mapResolution:{value:new THREE.Vector2},mapTween:{value:1},color:{value:new THREE.Color("#FFFFFF")},playMap:{type:"t",value:Fs.defaultTexture},playMapResolution:{value:new THREE.Vector2},playMapTween:{value:0},playMapColor:{value:new THREE.Color("#000000")},opacity:{value:0},isVideo:{value:!1}},extensions:{fragDepth:!0}})}static getChromaKeyMaterial(t){void 0===t&&(t=[0,1,0]);const e=new THREE.ShaderMaterial({depthTest:!0,depthWrite:!0,transparent:!0,toneMapped:!1,vertexShader:Hs,fragmentShader:Gs,uniforms:{map:{type:"t",value:null},mapResolution:{value:new THREE.Vector2},mapTween:{value:1},color:{value:new THREE.Color("#FFFFFF")},chromaKeyColor:{value:new THREE.Color(t[0],t[1],t[2])},playMap:{type:"t",value:Fs.defaultTexture},playMapResolution:{value:new THREE.Vector2},playMapTween:{value:0},playMapColor:{value:new THREE.Color("#000000")},opacity:{value:0},isVideo:{value:!1}},extensions:{fragDepth:!0}});return e.map=!0,e}static isPublisherStream(t){return t.clientInfo&&t.clientInfo.role===ie.Publisher&&t.clientInfo.uid===t.streamId}static isAttendeeStream(t){return t.clientInfo&&t.clientInfo.role===ie.Attendee&&t.clientInfo.uid===t.streamId}static isSmartDeviceStream(t){return t.clientInfo&&t.clientInfo.role===ie.SmartDevice&&t.clientInfo.uid===t.streamId}static isPublisherScreen(t){return t.clientInfo&&t.clientInfo.role===ie.Publisher&&t.clientInfo.screenUid===t.streamId}static isAttendeeScreen(t){return t.clientInfo&&t.clientInfo.role===ie.Attendee&&t.clientInfo.screenUid===t.streamId}static getTypeMatcher(t){let e;switch(t.name){case ns.PublisherStream.name:e=this.isPublisherStream;break;case ns.AttendeeStream.name:e=this.isAttendeeStream;break;case ns.SmartDeviceStream.name:e=this.isSmartDeviceStream;break;case ns.PublisherScreen.name:e=this.isPublisherScreen;break;case ns.AttendeeScreen.name:e=this.isAttendeeScreen;break;default:e=t=>!1}return e}static getStreamId$(t){if(!t.asset)return i.of(null);const e=t.asset.type,s=t.asset.file;return rs(t.asset)?Zi.streams$.pipe(n.map((i=>{let n,s=0;const o=this.getTypeMatcher(e);return i.forEach((e=>{o(e)&&(s===t.asset.index&&(n=e),s++)})),n?n.streamId:null}))):i.of(s)}static getMaterialByItem(t){let e;return e=t.asset&&t.asset.chromaKeyColor?Ws.getChromaKeyMaterial(t.asset.chromaKeyColor):(t.asset,new THREE.MeshBasicMaterial({color:16777215,toneMapped:!1})),e}static getUniformsByItem(t){let e=null;return t.asset&&(e={mapTween:1,playMapTween:0,opacity:0}),e}get editing(){return this.editing_}set editing(t){this.editing_!==t&&(this.editing_=t,this.zoomed="media"===this.view.type.name||!t&&this.zoomed)}constructor(t,e,i,n){super(i,Ws.getMaterialByItem(t)),this.zoomed_=!1,this.item=t,this.view=e,this.items=e.items,this.host=n,this.uniforms=Ws.getUniformsByItem(t),this.object=new THREE.Object3D,this.tempPosition=new THREE.Vector3,this.tempRotation=new THREE.Vector3,t.silent=this.isAutoplayLoop,this.mediaLoader=new bs(t),this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this),this.onToggle=this.onToggle.bind(this),this.onZoomed=this.onZoomed.bind(this),this.addPlayBtn(),this.addZoomBtn(),this.userData.render=(t,e)=>{this.render(this,t,e)}}load(t){if(this.playBtn&&this.remove(this.playBtn),this.zoomBtn&&this.remove(this.zoomBtn),!this.item.asset)return this.onAppear(),void("function"==typeof t&&t(this));const e=this.material;this.mediaLoader.load((i=>{const n=this.mediaLoader;n&&(i&&(e.map=i,e.uniforms&&(e.uniforms.map.value=i,e.uniforms.mapResolution.value=new THREE.Vector2(i.image.width||i.image.videoWidth,i.image.height||i.image.videoHeight),n.isPlayableVideo&&this.makePlayMap(i,(t=>{t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,e.uniforms.playMap.value=t,e.uniforms.playMapResolution.value=new THREE.Vector2(t.image.width,t.image.height),e.needsUpdate=!0})))),e.needsUpdate=!0,this.onAppear(),n.isPlayableVideo&&this.playBtn&&(e.uniforms&&(e.uniforms.isVideo.value=!0),this.on("over",this.onOver),this.on("out",this.onOut),this.on("down",this.onToggle),this.add(this.playBtn)),this.zoomBtn&&this.add(this.zoomBtn),"function"==typeof t&&t(this))}))}makePlayMap(t,e){const i=t.image.width||t.image.videoWidth,n=t.image.height||t.image.videoHeight,s=i/n,o=document.createElement("canvas");o.width=i,o.height=n;const r=o.getContext("2d");r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high";const a=new Image;a.onload=function(){const t=a.width/a.height;let c,d;s>t?(c=.32*n,d=c/t):(d=.32*i,c=d*t),r.drawImage(a,i/2-c/2,n/2-d/2,c,d);const l=new THREE.CanvasTexture(o);"function"==typeof e&&e(l)},a.crossOrigin="anonymous",a.src=x.getPath("textures/ui/play.png")}events$(){const t=this.item,e=this.items;return t.asset&&t.asset.linkedPlayId&&this.freeze(),bs.events$.pipe(n.filter((e=>e.loader.item&&e.loader.item.id===t.id)),n.map((i=>{if(i instanceof vs?(this.playing=!0,this.isAutoplayLoop||(this.playBtn&&(this.playBtn.playing=!0),this.emit("playing",!0)),this.onOut()):i instanceof _s?(this.playing=!1,this.playBtn&&(this.playBtn.playing=!1),this.emit("playing",!1),this.onOut()):i instanceof Ts&&this.emit("currentTime",i.loader.video.currentTime),t.asset&&t.asset.linkedPlayId){e.find((e=>e.asset&&-1!==i.src.indexOf(e.asset.file)&&i.id===t.asset.linkedPlayId))&&(i instanceof vs?this.play():i instanceof _s&&this.pause())}return i})))}onAppear(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,opacity:1,ease:Power2.easeInOut,onUpdate:()=>{e.uniforms.opacity.value=t.opacity}}),this.zoomed="media"===this.view.type.name||!this.editing&&this.zoomed}onDisappear(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,opacity:0,ease:Power2.easeInOut,onUpdate:()=>{e.uniforms.opacity.value=t.opacity}})}onOver(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,mapTween:this.playing?0:1,playMapTween:1,opacity:1,ease:Power2.easeInOut,overwrite:!0,onUpdate:()=>{e.uniforms.mapTween.value=t.mapTween,e.uniforms.playMapTween.value=t.playMapTween,e.uniforms.opacity.value=t.opacity}}),this.playBtn&&this.playBtn.onOver()}onOut(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,mapTween:this.playing?0:1,playMapTween:0,opacity:1,ease:Power2.easeInOut,overwrite:!0,onUpdate:()=>{e.uniforms.mapTween.value=t.mapTween,e.uniforms.playMapTween.value=t.playMapTween,e.uniforms.opacity.value=t.opacity}}),this.playBtn&&this.playBtn.onOut()}onToggle(){this.playing=this.mediaLoader.toggle(),this.playBtn&&(this.playBtn.playing=this.playing),this.emit("playing",this.playing),this.onOut()}play(){this.mediaLoader.play()}pause(){this.mediaLoader.pause()}setPlayingState(t){this.playing!==t&&(this.playing=t,t?this.mediaLoader.play():this.mediaLoader.pause(),this.onOut(),this.playBtn&&(this.playBtn.playing=t))}setZoomedState(t){this.zoomed=t}setCurrentTime(t){this.mediaLoader.video&&(this.mediaLoader.video.currentTime=t)}disposeMaterial(){this.material&&(this.material.map&&!1!==this.material.map.disposable&&this.material.map.dispose(),this.material.dispose())}disposeMediaLoader(){const t=this.mediaLoader;t&&(t.isPlayableVideo&&(this.off("over",this.onOver),this.off("out",this.onOut),this.off("down",this.onToggle)),t.dispose(),this.mediaLoader=null)}dispose(){this.removePlayBtn(),this.removeZoomBtn(),this.disposeMediaLoader()}get isAutoplayLoop(){return"media"!==this.view.type.name&&this.item.asset&&this.item.asset.autoplay&&this.item.asset.loop}addPlayBtn(){if(this.removePlayBtn(),!this.isAutoplayLoop){const t=this.playBtn=new Bs(this.host);t.on("over",this.onOver),t.on("out",this.onOut),t.on("down",this.onToggle),t.position.z=.01}}removePlayBtn(){this.playBtn&&(this.remove(this.playBtn),this.playBtn.off("over",this.onOver),this.playBtn.off("out",this.onOut),this.playBtn.off("down",this.onToggle),this.playBtn.dispose(),delete this.playBtn)}onZoomed(t){this.zoomed=t,this.emit("zoomed",t)}addZoomBtn(){if(this.removeZoomBtn(),!("media"===this.view.type.name||this.item.asset&&this.item.asset.chromaKeyColor)){(this.zoomBtn=new js(this.host)).on("zoomed",this.onZoomed)}}removeZoomBtn(){this.zoomBtn&&(this.remove(this.zoomBtn),this.zoomBtn.off("zoomed",this.onZoomed),this.zoomBtn.dispose(),this.zoomBtn=null,delete this.zoomBtn)}updateByItem(t){this.disposeMaterial(),this.disposeMediaLoader(),this.material=Ws.getMaterialByItem(t),this.uniforms=Ws.getUniformsByItem(t),this.addPlayBtn(),this.addZoomBtn(),t.silent=this.isAutoplayLoop,this.mediaLoader=new bs(t)}updateFromItem(t){t.position&&this.position.fromArray(t.position),t.rotation&&this.rotation.fromArray(t.rotation),t.scale&&this.scale.fromArray(t.scale),this.playBtn&&this.playBtn.update(this),this.updateZoom()}updateZoom(){if(this.originalPosition=this.position.clone(),this.originalScale=this.scale.clone(),this.originalQuaternion=this.quaternion.clone(),this.object.position.copy(this.originalPosition),this.object.scale.copy(this.originalScale),this.object.quaternion.copy(this.originalQuaternion),this.zoomBtn){const t=this.zoomBtn.scale,e=this.zoomBtn.position,i=this.scale.x/this.scale.y,n=.1;t.set(n/i,n,1),e.x=.5-n/i/2,e.y=n/2-.5,e.z=.01}}render(t,e){if(!this.editing){const t=this.object;this.zoomed&&!this.host.renderer.xr.isPresenting&&this.updateObjectMatrix(),this.position.copy(t.position),this.scale.copy(t.scale),this.quaternion.copy(t.quaternion)}}updateObjectMatrix(){const t=this.object,e=this.host;if(this.zoomed){const i=this.originalScale;let n,s=e.camera,o=s.fov,r=s.aspect;const a=this.tempPosition,c=this.tempRotation;n=.01;const d=e.renderer.xr;if(d.isPresenting){s=d.getCamera(s);const t=s.projectionMatrix.elements,e=t[0],i=t[5];r=i/e;o=57.29577951308232*(2*Math.atan(1/i)),n=1}t.scale.copy(i).multiplyScalar(n);const l=Cs.getDistanceToCamera(s,o,r,t.scale);s.getWorldDirection(c),c.multiplyScalar(l),a.set(0,0,0),s.localToWorld(a),a.add(c),t.position.copy(a),t.lookAt(Cs.origin),d.isPresenting&&(t.position.y-=t.scale.y/2)}}get zoomed(){return this.zoomed_}set zoomed(t){this.zoomed_!==t&&(this.zoomed_=t,t?(this.renderOrder=x.renderOrder.panel+5,this.material.depthTest=!0):(this.renderOrder=0,this.material.depthTest=!0,this.object.position.copy(this.originalPosition),this.object.scale.copy(this.originalScale),this.object.quaternion.copy(this.originalQuaternion)),this.material.needsUpdate=!0,this.updateObjectMatrix(),this.zoomBtn&&(this.zoomBtn.zoomed=t))}}class $s{constructor(){this.x=0,this.y=0}}class zs{constructor(t){t&&Object.assign(this,t)}}class qs extends zs{constructor(t){super(t),this.distance=new $s,this.strength=new $s,this.speed=new $s}}class Ks extends zs{constructor(t){super(t),this.distance=new $s,this.strength=new $s,this.speed=new $s}}class Ys extends zs{constructor(t){super(t)}}let Js;class Xs{static getPosition(t,e){return t instanceof MouseEvent?e?(e.x=t.clientX,e.y=t.clientY):e={x:t.clientX,y:t.clientY}:window.TouchEvent&&t instanceof TouchEvent&&t.touches.length>0&&(e?(e.x=t.touches[0].pageX,e.y=t.touches[0].pageY):e={x:t.touches[0].pageX,y:t.touches[0].pageY}),e}static down$(t,e){let s;return i.merge(i.fromEvent(t,"mousedown").pipe(n.filter((t=>0===t.button))),i.fromEvent(t,"touchstart")).pipe(n.map((i=>{if(s=s||new qs,s.node=t,s.target=i.target,s.originalEvent=i,s.down=this.getPosition(i,s.down),s.down)return s.distance=new $s,s.strength=new $s,s.speed=new $s,e.next(s),s})),n.filter((t=>void 0!==t)))}static move$(t,e,s,o){let r;return i.fromEvent(document,o.originalEvent instanceof MouseEvent?"mousemove":"touchmove").pipe(n.startWith(o),n.map((i=>{r=r||new Ks,r.node=t,r.target=i.target,r.originalEvent=i,r.position=this.getPosition(i,r.position);if(void 0!==o.down&&void 0!==r.position)return r.distance.x=r.position.x-o.down.x,r.distance.y=r.position.y-o.down.y,r.strength.x=r.distance.x/window.innerWidth*2,r.strength.y=r.distance.y/window.innerHeight*2,r.speed.x=o.speed.x+.1*(r.strength.x-o.strength.x),r.speed.y=o.speed.y+.1*(r.strength.y-o.strength.y),o.distance.x=r.distance.x,o.distance.y=r.distance.y,o.speed.x=r.speed.x,o.speed.y=r.speed.y,o.strength.x=r.strength.x,o.strength.y=r.strength.y,e.next(r),r})))}static dismissEvent(t,e,i,n){return Js=Js||new Ys,e.next(Js),i.next(),n&&Math.abs(n.distance.x)>10&&(t.preventDefault(),t.stopImmediatePropagation()),Js}static up$(t,e,s,o){return i.fromEvent(document,o.originalEvent instanceof MouseEvent?"mouseup":"touchend").pipe(n.map((t=>this.dismissEvent(t,e,s,o))))}static observe$(t){t=t||document;const e=new i.ReplaySubject(1),s=new i.Subject;return this.down$(t,e).pipe(n.switchMap((o=>(Xs.downEvent=o,i.merge(this.move$(t,e,s,o),this.up$(t,e,s,o)).pipe(n.takeUntil(s))))),n.switchMap((()=>e.pipe(n.filter((e=>e instanceof Ys||e.node===t))))))}}Xs.events$=new i.ReplaySubject(1),Xs.dismiss$=new i.Subject;const Zs="panorama",Qs="model";class to{}class eo extends to{}const io=new eo,no=new class extends to{},so=new class extends to{};class oo{get dolly(){return this.dolly_}set dolly(t){const e=THREE.Math.clamp(t,1,75);this.dolly_!==e&&(this.dolly_=e,this.markAsDirty())}getDollyValue(){return 1-(this.dolly_-1)/74-.5}get zoom(){return this.zoom_}set zoom(t){const e=THREE.Math.clamp(t,1,75);this.zoom_!==e&&(this.zoom_=e,this.markAsDirty())}getZoomValue(){return 2-(this.zoom_-1)/74}get mode(){return this.mode_}set mode(t){this.mode_!==t&&(this.mode_=t,oo.mode=t,this.markAsDirty())}get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get isMediaView(){const t=ps.currentView;return t&&t.type.name===fn.Media.name}get locked(){return this.controlled||this.spying||this.isMediaView}constructor(t){this.mode_=oo.mode=Zs,this.dolly_=70,this.zoom_=70,this.longitude=0,this.latitude=0,this.direction=1,this.radius=101,this.position=new THREE.Vector3,this.inertia=new THREE.Vector2,this.rotation=new THREE.Euler(0,0,0,"XYZ"),this.target=new THREE.Vector3,this.updatePosition=new THREE.Vector3,this.updateTarget=new THREE.Vector3,this.camera=t,this.setLongitudeLatitude(0,0),this.events$=new i.ReplaySubject(1)}setOrientation(t){t&&(this.setLongitudeLatitude(t.longitude,t.latitude),this.markAsDirty())}getOrientation(){return{latitude:this.latitude,longitude:this.longitude}}setLongitudeLatitude(t,e){e=Math.max(-80,Math.min(80,e)),this.longitude=(t<0?360+t:t)%360,this.latitude=e;const i=THREE.Math.degToRad(90-e),n=THREE.Math.degToRad(t);this.phi=i,this.theta=n}observe$(t){let e,s;return i.combineLatest([Ns.keys$(),Xs.observe$(t)]).pipe(n.filter((t=>!this.locked)),n.map((t=>{const i=t[0],n=t[1];if(n instanceof qs)e=this.latitude,s=this.longitude;else if(n instanceof Ks)if(i.Shift)this.events$.next(no);else if(i.Control)this.events$.next(so);else{const t=this.mode_===Qs?-1:1;this.setLongitudeLatitude(s-.1*n.distance.x*t,e+.1*n.distance.y)}return n})),n.filter((t=>t instanceof Ks)),n.startWith({latitude:this.latitude,longitude:this.longitude}),n.tap((t=>this.markAsDirty())),n.switchMap((t=>this.events$)))}walk(t,e){let i;if(this.mode_===Qs)i=3;else i=this.radius;const n=new THREE.Vector2(t.x,t.y).normalize().multiplyScalar(i),s=Math.atan2(n.y,n.x);let o=THREE.MathUtils.radToDeg(s);o=(o<0?360+o:o)%360;const r=this.latitude,a=this.longitude;let c=o-a;c=Math.abs(c)>180?c-c/Math.abs(c)*360:c;let d=0-r;d=Math.abs(d)>90?d-d/Math.abs(d)*90:d;const l={tween:0};gsap.to(l,{duration:.7,tween:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{this.setLongitudeLatitude(a+c*l.tween,r+d*l.tween),this.position.set(t.x*l.tween,0,t.y*l.tween),this.markAsDirty()},onComplete:()=>{"function"==typeof e&&e(o,0)}})}walkComplete(t,e){this.setLongitudeLatitude(t,e),this.position.set(0,0,0),this.markAsDirty()}lookAt(t){if(t){let e=t.position.clone();let i;if(e=this.camera.parent.worldToLocal(e),this.mode_===Qs)i=3;else i=this.radius;const n=new THREE.Vector3(e.x,e.z,e.y).normalize().multiplyScalar(i),s=Math.atan2(n.y,n.x),o=Math.acos(n.z/i);let r=THREE.MathUtils.radToDeg(s);r=(r<0?360+r:r)%360;let a=90-THREE.MathUtils.radToDeg(o);a=Math.max(-80,Math.min(80,a)),this.setLongitudeLatitude(r,a),this.markAsDirty()}}setVRCamera(t){if(t){const e=this.radius,i=new THREE.Vector3(0,0,-e),n=new THREE.Quaternion(t[3],t[4],t[5],t[6]);i.applyQuaternion(n);const s=new THREE.Vector3(i.x,i.z,i.y).normalize().multiplyScalar(e),o=Math.atan2(s.y,s.x),r=Math.acos(s.z/e);let a=THREE.MathUtils.radToDeg(o);a=(a<0?360+a:a)%360;let c=90-THREE.MathUtils.radToDeg(r);c=Math.max(-80,Math.min(80,c)),this.setLongitudeLatitude(a,c),this.markAsDirty()}}render(){ee.state.hosted||(this.longitude+=.025,this.isDirty=!0),this.isDirty&&(this.isDirty=!1,this.update())}markAsDirty(){this.isDirty=!0}update(){let t,e=this.updatePosition,i=this.updateTarget;const n=this.getZoomValue();this.getDollyValue();const s=THREE.MathUtils.degToRad(90-this.latitude),o=THREE.MathUtils.degToRad(this.longitude),r=this.camera,a=r.parent;if(this.mode_===Qs)t=3,e.copy(this.position),i.x=this.position.x+t*Math.sin(s)*Math.cos(o),i.y=this.position.y+t*Math.cos(s),i.z=this.position.z+t*Math.sin(s)*Math.sin(o),i=a.worldToLocal(i),r.target.copy(e),r.position.copy(i);else t=this.radius,i.x=this.position.x+t*Math.sin(s)*Math.cos(o),i.y=this.position.y+t*Math.cos(s),i.z=this.position.z+t*Math.sin(s)*Math.sin(o),e.copy(this.position),i=a.worldToLocal(i),r.target.copy(i),r.position.copy(e);r.zoom=n,r.lookAt(r.target),r.updateProjectionMatrix();const c=ps.currentView;c&&(c.lastOrientation.longitude=this.longitude,c.lastOrientation.latitude=this.latitude),this.events$.next(io)}}oo.orbitMoveEvent=io;let ro=0;const ao="progress",co="complete";class lo{static worker(){return this.worker_||(this.worker_=new Worker(x.workers.image)),this.worker_}static events$(t,e){if(!("Worker"in window)||this.isBlob(t)||this.isCors(t))return i.of({type:co,data:t});const s=++ro,o=this.worker();return o.postMessage({src:t,id:s,size:e}),i.fromEvent(o,"message").pipe(n.map((t=>t.data)),n.filter((e=>e.src===t)),n.auditTime(100),n.map((t=>{if(t.type===co&&t.data instanceof Blob){const e=URL.createObjectURL(t.data);t.data=e}return t})),n.takeWhile((t=>t.type!==co),!0),n.finalize((()=>{o.postMessage({id:s})})))}static load$(t,e){return this.events$(t,e).pipe(n.filter((t=>t.type===co)),n.map((t=>t.data)))}static isCors(t){return!1}static isBlob(t){return 0===t.indexOf("blob:")}}class ho{static get video(){return this.video_}static set video(t){if(this.video_&&(this.video_.muted=!0,this.video_.pause(),this.video_.parentNode&&this.video_.parentNode.removeChild(this.video_),this.video_=null),t){const t=this.video_=document.createElement("video");t.loop=!0,t.playsInline=!0,t.crossOrigin="anonymous"}}static get muted(){return this.muted_}static set muted(t){this.muted_=t,this.video&&(this.video.muted=!0===t)}static set cubeRenderTarget(t){this.cubeRenderTarget_&&(this.cubeRenderTarget_.texture.dispose(),this.cubeRenderTarget_.dispose()),this.cubeRenderTarget_=t}static set texture(t){this.texture_&&this.texture_.dispose(),this.texture_=t}static load(t,e,i){if(bs.events$.next(new Es(this)),this.video=null,t)return t.type.name===ns.PublisherStream.name?this.loadPublisherStreamBackground(e,i):t.type.name===ns.AttendeeStream.name?this.loadAttendeeStreamBackground(e,i):-1!==t.file.indexOf(".mp4")||-1!==t.file.indexOf(".webm")?this.loadVideoBackground(x.getPath(t.folder),t.file,e,i):-1!==t.file.indexOf(".m3u8")?this.loadHlslVideoBackground(t.file,e,i):-1!==t.file.indexOf(".hdr")?this.loadRgbeBackground(x.getPath(t.folder),t.file,e,i):this.loadBackgroundImageService(x.getPath(t.folder),t.file,e,i)}static loadBackgroundImageService(t,e,s,o){const r=Ls.getRef(),a=new Image;lo.events$(t+e).pipe(n.tap((t=>{t.type===ao&&Ls.setProgress(r,t.data.loaded,t.data.total)})),n.filter((t=>t.type===co)),n.switchMap((t=>{const e=i.fromEvent(a,"load");return a.crossOrigin="anonymous",a.src=t.data,e})),n.takeWhile((t=>t.type!==co),!0)).subscribe((t=>{const e=new THREE.Texture(a);e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.mapping=THREE.UVMapping,e.toneMapped=!1,e.needsUpdate=!0,"function"==typeof o&&(o(e),URL.revokeObjectURL(t.data)),Ls.setProgress(r,1)}))}static loadBackground(t,e,i,n){const s=Ls.getRef(),o=new THREE.TextureLoader;return o.setPath(t).load(e,(t=>{t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof n&&n(t),Ls.setProgress(s,1)}),(t=>{Ls.setProgress(s,t.loaded,t.total)})),o}static loadRgbeBackground(t,e,i,n){const s=Ls.getRef(),o=new Os;return o.setDataType(THREE.UnsignedByteType).setPath(t).load(e,(t=>{"function"==typeof n&&n(t,!0),Ls.setProgress(s,1)}),(t=>{Ls.setProgress(s,t.loaded,t.total)})),o}static loadHlslVideoBackground(t,e,i){const n=Ls.getRef(),s=document.createElement("video");if(s.oncanplay=()=>{(()=>{s.oncanplay=null;const t=new THREE.VideoTexture(s);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof i&&i(t),Ls.setProgress(n,1)})()},Hls.isSupported()){var o=new Hls;o.attachMedia(s),o.on(Hls.Events.MEDIA_ATTACHED,(()=>{o.loadSource(t),o.on(Hls.Events.MANIFEST_PARSED,((t,e)=>{s.play()}))}))}}static get progress(){const t=this.video;return t?t.currentTime/t.duration:0}static set progress(t){const e=this.video;if(e){const i=e.duration*t;e.seekable.length>t&&e.currentTime!==i&&(e.currentTime=i,bs.events$.next(new Ts(this)))}}static play(t){const e=this.video;e&&(e.muted=this.muted_,e.play().then((()=>{t||bs.events$.next(new vs(this))}),(i=>{console.log("PanoramaLoader.play.error",e.src,e.error,i),setTimeout((()=>{Xn.open$({message:"interact with the page to reproduce audio.",type:Wn,position:qn})}),500),ho.tryMuted(t)})))}static tryMuted(t){const e=this.video;e&&(this.muted=!0,e.play().then((()=>{t||bs.events$.next(new vs(this))}),(t=>{console.log("PanoramaLoader.tryMuted.error",e.src,e.error,t)})))}static pause(t){const e=this.video;e&&(e.muted=!0,e.pause(),t||bs.events$.next(new _s(this)))}static loadVideoBackground(t,e,i,n){const s=Ls.getRef();this.video=!0;const o=this.video;o.oncanplay=()=>{o.oncanplay=null;const t=new THREE.VideoTexture(o);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof n&&n(t),Ls.setProgress(s,1),this.play()},o.ontimeupdate=()=>{bs.events$.next(new Ss(this))},o.onended=()=>{},o.onerror=t=>{console.log("loadVideoBackground.error",o.error),o.error instanceof MediaError&&(setTimeout((()=>{ge.transform("media_error"),Xn.open$({message:`impossible to reproduce the video source. ${e}`,type:Wn,position:qn})}),500),Ls.setProgress(s,1))},o.crossOrigin="anonymous",o.src=t+e,o.load()}static loadPublisherStreamBackground(t,e){const i=t=>{const i=document.querySelector(`#stream-${t} video`);if(!i)return;const n=()=>{const t=this.texture=new THREE.VideoTexture(i);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};i.crossOrigin="anonymous",i.readyState>=i.HAVE_FUTURE_DATA?n():i.oncanplay=()=>{n()}};Zi.getPublisherStreamId$().pipe(n.first()).subscribe((t=>i(t)))}static loadAttendeeStreamBackground(t,e){const i=t=>{const i=document.querySelector(`#stream-${t} video`);if(!i)return;const n=()=>{const t=this.texture=new THREE.VideoTexture(i);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};i.crossOrigin="anonymous",i.readyState>=i.HAVE_FUTURE_DATA?n():i.oncanplay=()=>{n()}};Zi.getAttendeeStreamId$().pipe(n.first()).subscribe((t=>i(t)))}static loadStreamBackground(t,e,i){const s=t=>{const i=document.querySelector(`#stream-${t} video`);if(!i)return;const n=()=>{const t=this.texture=new THREE.VideoTexture(i);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};i.crossOrigin="anonymous",i.readyState>=i.HAVE_FUTURE_DATA?n():i.oncanplay=()=>{n()}};ho.getStreamId$(i).pipe(n.takeUntil(bs.events$.pipe(n.filter((t=>t instanceof Es))))).subscribe((t=>{s(t)}))}static getStreamId$(t){const e=t.type;return Zi.streams$.pipe(n.map((i=>{let n,s=0;const o=Ws.getTypeMatcher(e);return i.forEach((e=>{o(e)&&(s===t.index&&(n=e),s++)})),n?n.streamId:null})))}}class uo{constructor(t){this.muted_=!1,this.subscription=ee.state$.subscribe((t=>ho.muted=t.volumeMuted)),this.tween=0,this.create(t)}create(t){this.renderer=t,this.onCubeMapDispose=this.onCubeMapDispose.bind(this);const e=new THREE.BoxGeometry(202,202,202),i=this.getBlackMaterial(),n=new As(e,i);n.userData={render:(t,e,i,s,o)=>{n.matrixWorld.copyPosition(o.matrixWorld);const r=this.cubeMap,a=this.texture;r&&a&&a.isVideoTexture&&this.updateCubeMapEquirectangularTexture(r,i,a)}},n.name="[panorama]",this.mesh=n}getBlackMaterial(){return new THREE.MeshBasicMaterial({name:"PanoramaStandardMaterial",color:0,side:THREE.BackSide,depthTest:!1,depthWrite:!1,fog:!1})}getShaderMaterial(t){const e=new THREE.ShaderMaterial({name:"PanoramaCubeMaterial",uniforms:this.cloneUniforms(THREE.ShaderLib.cube.uniforms),vertexShader:THREE.ShaderLib.cube.vertexShader,fragmentShader:THREE.ShaderLib.cube.fragmentShader,side:THREE.BackSide,depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1});t.mapping=THREE.EquirectangularReflectionMapping;const i=this.toCubeMap(t,this.renderer);return e.map=i,e.uniforms.envMap.value=i,e.uniforms.flipEnvMap.value=i.isCubeTexture&&i._needsFlipEnvMap?-1:1,e.needsUpdate=!0,this.mesh.geometry.deleteAttribute("normal"),this.mesh.geometry.deleteAttribute("uv"),Object.defineProperty(e,"envMap",{get:function(){return this.uniforms.envMap.value},configurable:!0}),e}makeEnvMap(t){let e=this.mesh.material;if(e.uniforms){t.mapping=THREE.EquirectangularReflectionMapping;const i=this.toCubeMap(t,this.renderer);e.map=i,e.uniforms.envMap.value=i,e.uniforms.flipEnvMap.value=i.isCubeTexture&&i._needsFlipEnvMap?-1:1,e.needsUpdate=!0}else e.dispose(),e=this.getShaderMaterial(t),this.mesh.material=e}toCubeMap(t,e){this.cubeMap&&this.cubeMap.dispose();const i=t.image,n=i.height||i.videoHeight,s=new THREE.WebGLCubeRenderTarget(n/2,{generateMipmaps:!0,type:THREE.HalfFloatType,encoding:THREE.LinearEncoding,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,mapping:THREE.CubeUVReflectionMapping,format:THREE.RGBAFormat});return s.addEventListener("dispose",this.onCubeMapDispose),this.setCubeMapEquirectangularTexture(s,t),this.updateCubeMapEquirectangularTexture(s,e,t),this.cubeMap=s,this.texture=t,this.mapTextureMapping(s.texture,t.mapping)}setCubeMapEquirectangularTexture(t,e){t.texture.type=e.type,t.texture.format=THREE.RGBAFormat,t.texture.encoding=THREE.sRGBEncoding,t.texture.generateMipmaps=e.generateMipmaps,t.texture.minFilter=e.minFilter,t.texture.magFilter=e.magFilter,t.texture.needsUpdate=!0;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\t\t\t\t\tvarying vec3 vWorldDirection;\n\t\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\t\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\t\t\t\t\t}\n\t\t\t\t\tvoid main() {\n\t\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\t\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t\t#include <project_vertex>\n\t\t\t\t\t}\n\t\t\t\t",fragmentShader:"\n\t\t\t\t\tuniform sampler2D tEquirect;\n\t\t\t\t\tvarying vec3 vWorldDirection;\n\t\t\t\t\t#include <common>\n\t\t\t\t\tvoid main() {\n\t\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\t\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\t\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t\t\t\t\t}\n\t\t\t\t"},n=new THREE.BoxGeometry(5,5,5),s=new THREE.ShaderMaterial({name:"CubemapFromEquirect",uniforms:this.cloneUniforms(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:THREE.BackSide,blending:THREE.NoBlending});s.uniforms.tEquirect.value=e;const o=new THREE.Mesh(n,s),r=new THREE.CubeCamera(1,10,t);return t.camera=r,t.mesh=o,t}updateCubeMapEquirectangularTexture(t,e,i){const n=i.minFilter;i.minFilter===THREE.LinearMipmapLinearFilter&&(i.minFilter=THREE.LinearFilter),t.camera.update(e,t.mesh),i.minFilter=n}cloneUniforms(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const s=t[i][n];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?e[i][n]=s.clone():Array.isArray(s)?e[i][n]=s.slice():e[i][n]=s}}return e}mapTextureMapping(t,e){return e===THREE.EquirectangularReflectionMapping?t.mapping=THREE.CubeReflectionMapping:e===THREE.EquirectangularRefractionMapping&&(t.mapping=THREE.CubeRefractionMapping),t}onCubeMapDispose(){const t=this.cubeMap;t&&(t.removeEventListener("dispose",this.onCubeMapDispose),t.texture.dispose(),t.mesh.geometry.dispose(),t.mesh.material.dispose(),void 0!==t&&(this.cubeMap=null))}change(t,e,i,n){const s=t instanceof Sn?t.tiles[t.index_]:t,o=this.mesh.material;this.load(s,e,(e=>{"function"==typeof n&&n(t),o.uniforms&&o.uniforms.uTween&&(o.uniforms.uTween.value=1,o.needsUpdate=!0),"function"==typeof i&&i(e)}))}crossfade(t,e,i){const n=this.mesh.material;this.load(t,e,(t=>{n.uniforms&&n.uniforms.uTween&&(n.uniforms.uTween.value=1,n.needsUpdate=!0),"function"==typeof i&&i(t)}))}getLocalizedAsset(t){if(t&&t.locale){const e=t.locale[ve.lang];e&&(t=e)}return t}load(t,e,i){const n=t.type.name===fn.Media.name?ls.defaultMediaAsset:t.asset;if(!n)return;if(n.type.name===ns.Model.name)return void("function"==typeof i&&i(null));const s=this.getLocalizedAsset(n);this.currentAsset=s.folder+s.file,ho.load(s,e,((t,e)=>{if(s.folder+s.file!==this.currentAsset)return void t.dispose();const n=this.makeEnvMap(t);"function"==typeof i&&i(n)}))}dispose(){this.subscription.unsubscribe(),this.cubeMap&&this.cubeMap.dispose()}}const po=4/3,mo=[16777215,16763904,65484,52479,13434624,13369599];class go{static get geometry(){return new THREE.PlaneBufferGeometry(.12,.09,2,2)}setRemote(t,e,i){this.remote=t;let n,s,o,r,a,c,d;i<4?(n=1,s=0,o=e,r=.12*n,a=r/po,c=0,d=a/2-i*a/2,this.plane.position.set(c,d+a*e,.005)):(n=.5,s=e%2,o=Math.floor(e/2),r=.12*n,a=r/po,c=-r/2,d=a/2-Math.ceil(i/2)*a/2,this.plane.position.set(c+s*r,d+o*a,.005)),this.plane.scale.set(n,n,n),"number"==typeof t?this.plane.material.color.set(mo[e%mo.length]):t.texture?(this.plane.material.map=t.texture,this.plane.material.needsUpdate=!0):this.addStreamTexture(t.streamId,(e=>{t.texture=e,this.plane.material.map=e,this.plane.material.needsUpdate=!0}))}addStreamTexture(t,e){const i=`#stream-${t}`,n=document.querySelector(`${i} video`);if(!n)return;const s=()=>{const t=new THREE.VideoTexture(n);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};n.crossOrigin="anonymous",n.readyState>=n.HAVE_FUTURE_DATA?s():n.oncanplay=()=>{s()}}constructor(){const t=go.geometry,e=new THREE.MeshBasicMaterial({color:16777215});this.plane=new THREE.Mesh(t,e)}}class fo{set remotes(t){t.forEach(((e,i)=>{let n=this.streams[i];n||(n=new go),n.setRemote(e,i,t.length),this.phone.add(n.plane),this.streams[i]=n}));for(let e=t.length;e<this.streams.length;e++)this.phone.remove(this.streams[e].plane);this.streams.length=t.length}constructor(){const t=this.mesh=new THREE.Group,e=this.phone=this.create();t.add(e),this.streams=[],Zi.remotes$.subscribe((t=>{this.remotes=t}))}create(){const t=new THREE.BoxBufferGeometry(.12,.27,.005,2,2,1),e=new THREE.MeshStandardMaterial({color:0,transparent:!0,opacity:.6}),i=new THREE.Mesh(t,e);return i.rotation.set(-Math.PI/4,0,0),i}}class vo{constructor(t){void 0===t&&(t="#ffffff"),this.position=new THREE.Vector3;const e=ys.planeGeometry,i=(new THREE.TextureLoader).load(x.getPath("textures/ui/nav-point.png")),n=new THREE.MeshBasicMaterial({color:new THREE.Color(t),depthTest:!1,depthWrite:!1,map:i,transparent:!0,opacity:.9}),s=this.mesh=new THREE.Mesh(e,n);s.renderOrder=x.renderOrder.pointer,s.position.set(-1e5,-1e5,-1e5)}update(t){if(ws.lastIntersectedObject){const e=this.position;e.copy(ws.lastIntersectedObject.intersection.point),e.multiplyScalar(.99);const i=this.mesh;i.position.set(e.x,e.y,e.z),e.sub(t.position);const n=e.length()/80;i.scale.set(n,n,n),i.lookAt(Cs.origin)}}setPosition(t,e,i,n){const s=this.position;s.set(t,e,i).multiplyScalar(80);const o=this.mesh;o.position.copy(s),s.sub(n.position);const r=s.length()/80;o.scale.set(r,r,r),o.lookAt(Cs.origin)}}class _o{constructor(){this.gravity=new THREE.Vector3(0,-9.8,0),this.controllerPosition=new THREE.Vector3,this.controllerDirection=new THREE.Vector3,this.currentPosition=new THREE.Vector3,this.targetPosition=new THREE.Vector3;const t=new THREE.BufferGeometry,e=this.vertices=new Float32Array(33);e.fill(0);const i=new Float32Array(33);i.fill(.5),t.setAttribute("position",new THREE.BufferAttribute(e,3)),t.setAttribute("color",new THREE.BufferAttribute(i,3));const n=new THREE.LineBasicMaterial({vertexColors:!0,blending:THREE.AdditiveBlending});this.line=new THREE.Line(t,n);const s=(new THREE.TextureLoader).load(x.getPath("textures/ui/nav-point.png"));(this.target=new THREE.Mesh(new THREE.PlaneBufferGeometry(.3,.3,1,1),new THREE.MeshBasicMaterial({map:s,blending:THREE.AdditiveBlending,color:5592405,transparent:!0}))).rotation.x=-Math.PI/2}addToController(t,e){this.currentController=t,t.add(this.line),e.add(this.target)}removeFromController(t,e,i,n,s){const o=this.currentController;if(o===t){const t=this.gravity,r=this.currentPosition,a=this.controllerPosition,c=this.controllerDirection;i.xr.getCamera(n).getWorldPosition(r),r.y=0,o.getWorldPosition(a),o.getWorldDirection(c),c.multiplyScalar(6);const d=(-c.y+Math.sqrt(c.y**2-2*a.y*t.y))/t.y,l=this.getPositionT(this.targetPosition,d,a,c,t);l.addScaledVector(r,-1),s.position.add(l),this.currentController=null,o.remove(this.line),e.remove(this.target)}}update(){const t=this.currentController;if(t){const e=this.gravity,i=this.controllerPosition,n=this.controllerDirection,s=this.targetPosition;t.getWorldPosition(i),t.getWorldDirection(n),n.multiplyScalar(6);const o=(-n.y+Math.sqrt(n.y**2-2*i.y*e.y))/e.y,r=s.set(0,0,0);for(let s=1;s<=10;s++)this.getPositionT(r,s*o/10,i,n,e),t.worldToLocal(r),r.toArray(this.vertices,3*s);this.line.geometry.attributes.position.needsUpdate=!0,this.getPositionT(this.target.position,.98*o,i,n,e)}}getPositionT(t,e,i,n,s){return t.copy(i),t.addScaledVector(n,e),t.addScaledVector(s,.5*e**2),t}}const Eo="waiting",So="enabled",To="ended",bo="started",yo="disabled",Co="needs-https",wo="unavailable";class Ro{static getService(){return this.service_||(this.service_=new Ro),this.service_}get status(){return this.status$.getValue()}get state(){return this.state$.getValue()}constructor(){if(Ro.service_)throw"VRService is a singleton class!";const t=this.state_={camera:{position:new THREE.Vector3,quaternion:new THREE.Quaternion,scale:new THREE.Vector3,array:new Array(10).fill(0)}};this.onSessionStarted=this.onSessionStarted.bind(this),this.onSessionEnded=this.onSessionEnded.bind(this),this.status$=new i.BehaviorSubject(Eo),this.session$=new i.Subject,this.state$=new i.BehaviorSubject(t),this.currentSession=null,"xr"in navigator?navigator.xr.isSessionSupported("immersive-vr").then((t=>{t?this.status$.next(So):this.status$.next(yo)})):!1===window.isSecureContext?this.status$.next(Co):this.status$.next(wo)}onSessionStarted(t){t.addEventListener("end",this.onSessionEnded),this.currentSession=t,this.session$.next(t),this.status$.next(bo)}onSessionEnded(){this.currentSession.removeEventListener("end",this.onSessionEnded),this.currentSession=null,this.session$.next(null),this.status$.next(To)}toggleVR(t){if(null===this.currentSession){const t={optionalFeatures:["local-floor","bounded-floor"]};navigator.xr.requestSession("immersive-vr",t).then(this.onSessionStarted)}else this.currentSession.end()}isDisabled(){switch(this.status$.getValue()){case Eo:case yo:case Co:case wo:return!0;default:return!1}}getLabel(){let t;switch(this.status$.getValue()){case Eo:t="Waiting VR";break;case So:case To:t="Enter VR";break;case bo:t="Exit VR";break;case yo:t="VR Disabled";break;case Co:t="VR Needs Https";break;case wo:t="VR Unavailable"}return t}updateState(t){if(this.status===bo){t.renderer,t.scene;const e=t.camera,i=this.state_;e.matrixWorld.decompose(i.camera.position,i.camera.quaternion,i.camera.scale),i.camera.array[0]=i.camera.position.x,i.camera.array[1]=i.camera.position.y,i.camera.array[2]=i.camera.position.z,i.camera.array[3]=i.camera.quaternion.x,i.camera.array[4]=i.camera.quaternion.y,i.camera.array[5]=i.camera.quaternion.z,i.camera.array[6]=i.camera.quaternion.w,i.camera.array[7]=i.camera.scale.x,i.camera.array[8]=i.camera.scale.y,i.camera.array[9]=i.camera.scale.z,this.state$.next(i)}}}class Io extends class{constructor(){this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}}{constructor(t){super(),this.gamepad=t,this.buttons={},this.axes={}}update(){this.updateButtons(),this.updateAxes()}updateButtons(){this.gamepad.buttons.forEach(((t,e)=>{const i=t.pressed,n=this.buttons[e]||(this.buttons[e]=new Ao(e,this));n.pressed!==i&&(n.pressed=i,i?this.emit("press",n):void 0!==status&&this.emit("release",n))}))}updateAxes(){const t=this.gamepad.axes;for(let e=0;e<t.length;e+=2){const i=Math.floor(e/2),n=this.axes[i]||(this.axes[i]=new Oo(i,this)),s=t[e],o=t[e+1];if(n.x!==s||n.y!==o){if(n.x=s,n.y=o,Math.abs(s)>Math.abs(o)){const t=s<-.85,e=s>.85;n.left!==t&&(n.left=t,this.emit(t?"left":"none",n)),n.right!==e&&(n.right=e,this.emit(e?"right":"none",n))}else{const t=o<-.85,e=o>.85;n.up!==t&&(n.up=t,this.emit(t?"up":"none",n)),n.down!==e&&(n.down=e,this.emit(e?"down":"none",n))}this.emit("axis",n)}}}feedback(t,e){void 0===t&&(t=.1),void 0===e&&(e=50);const i=this.gamepad.hapticActuators;return i&&i.length?i[0].pulse(t,e):Promise.reject()}}class Ao{constructor(t,e){this.index=t,this.gamepad=e,this.pressed=!1}}class Oo extends THREE.Vector2{constructor(t,e){super(),this.index=t,this.gamepad=e,this.left=this.right=this.up=this.down=!1}}class No extends s.Loader{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new Mo(t)})),this.register((function(t){return new jo(t)})),this.register((function(t){return new Ho(t)})),this.register((function(t){return new xo(t)})),this.register((function(t){return new Uo(t)})),this.register((function(t){return new Vo(t)})),this.register((function(t){return new Fo(t)})),this.register((function(t){return new Bo(t)})),this.register((function(t){return new Po(t)})),this.register((function(t){return new Go(t)}))}load(t,e,i,n){const o=this;let r;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:s.LoaderUtils.extractUrlBase(t),this.manager.itemStart(t);const a=function(e){n?n(e):console.error(e),o.manager.itemError(t),o.manager.itemEnd(t)},c=new s.FileLoader(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(t,(function(i){try{o.parse(i,r,(function(i){e(i),o.manager.itemEnd(t)}),a)}catch(t){a(t)}}),i,a)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this}unregister(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,i,n){let o;const r={},a={};if("string"==typeof t)o=t;else{if(s.LoaderUtils.decodeText(new Uint8Array(t,0,4))===Wo){try{r[Lo.KHR_BINARY_GLTF]=new qo(t)}catch(t){return void(n&&n(t))}o=r[Lo.KHR_BINARY_GLTF].content}else o=s.LoaderUtils.decodeText(new Uint8Array(t))}const c=JSON.parse(o);if(void 0===c.asset||c.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const d=new wr(c,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});d.fileLoader.setRequestHeader(this.requestHeader);for(let t=0;t<this.pluginCallbacks.length;t++){const e=this.pluginCallbacks[t](d);a[e.name]=e,r[e.name]=!0}if(c.extensionsUsed)for(let t=0;t<c.extensionsUsed.length;++t){const e=c.extensionsUsed[t],i=c.extensionsRequired||[];switch(e){case Lo.KHR_MATERIALS_UNLIT:r[e]=new Do;break;case Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:r[e]=new Xo;break;case Lo.KHR_DRACO_MESH_COMPRESSION:r[e]=new Ko(c,this.dracoLoader);break;case Lo.KHR_TEXTURE_TRANSFORM:r[e]=new Yo;break;case Lo.KHR_MESH_QUANTIZATION:r[e]=new Zo;break;default:i.indexOf(e)>=0&&void 0===a[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}d.setExtensions(r),d.setPlugins(a),d.parse(i,n)}parseAsync(t,e){const i=this;return new Promise((function(n,s){i.parse(t,e,n,s)}))}}function ko(){let t={};return{get:function(e){return t[e]},add:function(e,i){t[e]=i},remove:function(e){delete t[e]},removeAll:function(){t={}}}}const Lo={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class Po{constructor(t){this.parser=t,this.name=Lo.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&t._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(t){const e=this.parser,i="light:"+t;let n=e.cache.get(i);if(n)return n;const o=e.json,r=((o.extensions&&o.extensions[this.name]||{}).lights||[])[t];let a;const c=new s.Color(16777215);void 0!==r.color&&c.fromArray(r.color);const d=void 0!==r.range?r.range:0;switch(r.type){case"directional":a=new s.DirectionalLight(c),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new s.PointLight(c),a.distance=d;break;case"spot":a=new s.SpotLight(c),a.distance=d,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,a.angle=r.spot.outerConeAngle,a.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return a.position.set(0,0,0),a.decay=2,void 0!==r.intensity&&(a.intensity=r.intensity),a.name=e.createUniqueName(r.name||"light_"+t),n=Promise.resolve(a),e.cache.add(i,n),n}createNodeAttachment(t){const e=this,i=this.parser,n=i.json.nodes[t],s=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then((function(t){return i._getNodeRef(e.cache,s,t)}))}}class Do{constructor(){this.name=Lo.KHR_MATERIALS_UNLIT}getMaterialType(){return s.MeshBasicMaterial}extendParams(t,e,i){const n=[];t.color=new s.Color(1,1,1),t.opacity=1;const o=e.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const e=o.baseColorFactor;t.color.fromArray(e),t.opacity=e[3]}void 0!==o.baseColorTexture&&n.push(i.assignTexture(t,"map",o.baseColorTexture))}return Promise.all(n)}}class Mo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(e.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&o.push(i.assignTexture(e,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(e.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&o.push(i.assignTexture(e,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(o.push(i.assignTexture(e,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const t=r.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new s.Vector2(t,t)}return Promise.all(o)}}class xo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_SHEEN}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[];e.sheenColor=new s.Color(0,0,0),e.sheenRoughness=0,e.sheen=1;const r=n.extensions[this.name];return void 0!==r.sheenColorFactor&&e.sheenColor.fromArray(r.sheenColorFactor),void 0!==r.sheenRoughnessFactor&&(e.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&o.push(i.assignTexture(e,"sheenColorMap",r.sheenColorTexture)),void 0!==r.sheenRoughnessTexture&&o.push(i.assignTexture(e,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(o)}}class Uo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(e.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&s.push(i.assignTexture(e,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class Vo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_VOLUME}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];e.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&o.push(i.assignTexture(e,"thicknessMap",r.thicknessTexture)),e.attenuationDistance=r.attenuationDistance||0;const a=r.attenuationColor||[1,1,1];return e.attenuationColor=new s.Color(a[0],a[1],a[2]),Promise.all(o)}}class Fo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_IOR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return e.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class Bo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_SPECULAR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];e.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&o.push(i.assignTexture(e,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return e.specularColor=new s.Color(a[0],a[1],a[2]),void 0!==r.specularColorTexture&&o.push(i.assignTexture(e,"specularColorMap",r.specularColorTexture).then((function(t){t.encoding=s.sRGBEncoding}))),Promise.all(o)}}class jo{constructor(t){this.parser=t,this.name=Lo.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,i=e.json,n=i.textures[t];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=e.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,s.source,o)}}class Ho{constructor(t){this.parser=t,this.name=Lo.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,i=this.parser,n=i.json,s=n.textures[t];if(!s.extensions||!s.extensions[e])return null;const o=s.extensions[e],r=n.images[o.source];let a=i.textureLoader;if(r.uri){const t=i.options.manager.getHandler(r.uri);null!==t&&(a=t)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(t,r,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class Go{constructor(t){this.name=Lo.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,i=e.bufferViews[t];if(i.extensions&&i.extensions[this.name]){const t=i.extensions[this.name],n=this.parser.getDependency("buffer",t.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([n,s.ready]).then((function(e){const i=t.byteOffset||0,n=t.byteLength||0,o=t.count,r=t.byteStride,a=new ArrayBuffer(o*r),c=new Uint8Array(e[0],i,n);return s.decodeGltfBuffer(new Uint8Array(a),o,r,c,t.mode,t.filter),a}))}return null}}const Wo="glTF",$o=1313821514,zo=5130562;class qo{constructor(t){this.name=Lo.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,12);if(this.header={magic:s.LoaderUtils.decodeText(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==Wo)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,n=new DataView(t,12);let o=0;for(;o<i;){const e=n.getUint32(o,!0);o+=4;const i=n.getUint32(o,!0);if(o+=4,i===$o){const i=new Uint8Array(t,12+o,e);this.content=s.LoaderUtils.decodeText(i)}else if(i===zo){const i=12+o;this.body=t.slice(i,i+e)}o+=e}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ko{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Lo.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const i=this.json,n=this.dracoLoader,s=t.extensions[this.name].bufferView,o=t.extensions[this.name].attributes,r={},a={},c={};for(const t in o){const e=pr[t]||t.toLowerCase();r[e]=o[t]}for(const e in t.attributes){const n=pr[e]||e.toLowerCase();if(void 0!==o[e]){const s=i.accessors[t.attributes[e]],o=dr[s.componentType];c[n]=o,a[n]=!0===s.normalized}}return e.getDependency("bufferView",s).then((function(t){return new Promise((function(e){n.decodeDracoFile(t,(function(t){for(const e in t.attributes){const i=t.attributes[e],n=a[e];void 0!==n&&(i.normalized=n)}e(t)}),r,c)}))}))}}class Yo{constructor(){this.name=Lo.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return void 0!==e.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===e.offset&&void 0===e.rotation&&void 0===e.scale||(t=t.clone(),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),t.needsUpdate=!0),t}}class Jo extends s.MeshStandardMaterial{constructor(t){super(),this.isGLTFSpecularGlossinessMaterial=!0;const e=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new s.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(t){for(const e in a)t.uniforms[e]=a[e];t.fragmentShader=t.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",e).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",o).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(t){a.specular.value=t}},specularMap:{get:function(){return a.specularMap.value},set:function(t){a.specularMap.value=t,t?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(t){a.glossiness.value=t}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(t){a.glossinessMap.value=t,t?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(t)}copy(t){return super.copy(t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class Xo{constructor(){this.name=Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Jo}extendParams(t,e,i){const n=e.extensions[this.name];t.color=new s.Color(1,1,1),t.opacity=1;const o=[];if(Array.isArray(n.diffuseFactor)){const e=n.diffuseFactor;t.color.fromArray(e),t.opacity=e[3]}if(void 0!==n.diffuseTexture&&o.push(i.assignTexture(t,"map",n.diffuseTexture)),t.emissive=new s.Color(0,0,0),t.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,t.specular=new s.Color(1,1,1),Array.isArray(n.specularFactor)&&t.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){const e=n.specularGlossinessTexture;o.push(i.assignTexture(t,"glossinessMap",e)),o.push(i.assignTexture(t,"specularMap",e))}return Promise.all(o)}createMaterial(t){const e=new Jo(t);return e.fog=!0,e.color=t.color,e.map=void 0===t.map?null:t.map,e.lightMap=null,e.lightMapIntensity=1,e.aoMap=void 0===t.aoMap?null:t.aoMap,e.aoMapIntensity=1,e.emissive=t.emissive,e.emissiveIntensity=1,e.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,e.bumpMap=void 0===t.bumpMap?null:t.bumpMap,e.bumpScale=1,e.normalMap=void 0===t.normalMap?null:t.normalMap,e.normalMapType=s.TangentSpaceNormalMap,t.normalScale&&(e.normalScale=t.normalScale),e.displacementMap=null,e.displacementScale=1,e.displacementBias=0,e.specularMap=void 0===t.specularMap?null:t.specularMap,e.specular=t.specular,e.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,e.glossiness=t.glossiness,e.alphaMap=null,e.envMap=void 0===t.envMap?null:t.envMap,e.envMapIntensity=1,e.refractionRatio=.98,e}}class Zo{constructor(){this.name=Lo.KHR_MESH_QUANTIZATION}}class Qo extends s.Interpolant{constructor(t,e,i,n){super(t,e,i,n)}copySampleValue_(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=t*n*3+n;for(let t=0;t!==n;t++)e[t]=i[s+t];return e}}Qo.prototype.beforeStart_=Qo.prototype.copySampleValue_,Qo.prototype.afterEnd_=Qo.prototype.copySampleValue_,Qo.prototype.interpolate_=function(t,e,i,n){const s=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=2*r,c=3*r,d=n-e,l=(i-e)/d,h=l*l,u=h*l,p=t*c,m=p-c,g=-2*u+3*h,f=u-h,v=1-g,_=f-h+l;for(let t=0;t!==r;t++){const e=o[m+t+r],i=o[m+t+a]*d,n=o[p+t+r],c=o[p+t]*d;s[t]=v*e+_*i+g*n+f*c}return s};const tr=new s.Quaternion;class er extends Qo{interpolate_(t,e,i,n){const s=super.interpolate_(t,e,i,n);return tr.fromArray(s).normalize().toArray(s),s}}const ir=0,nr=1,sr=2,or=3,rr=4,ar=5,cr=6,dr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},lr={9728:s.NearestFilter,9729:s.LinearFilter,9984:s.NearestMipmapNearestFilter,9985:s.LinearMipmapNearestFilter,9986:s.NearestMipmapLinearFilter,9987:s.LinearMipmapLinearFilter},hr={33071:s.ClampToEdgeWrapping,33648:s.MirroredRepeatWrapping,10497:s.RepeatWrapping},ur={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},pr={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},mr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},gr={CUBICSPLINE:void 0,LINEAR:s.InterpolateLinear,STEP:s.InterpolateDiscrete},fr="OPAQUE",vr="MASK",_r="BLEND";function Er(t,e,i){for(const n in i.extensions)void 0===t[n]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=i.extensions[n])}function Sr(t,e){void 0!==e.extras&&("object"==typeof e.extras?Object.assign(t.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Tr(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(let i=0,n=e.weights.length;i<n;i++)t.morphTargetInfluences[i]=e.weights[i];if(e.extras&&Array.isArray(e.extras.targetNames)){const i=e.extras.targetNames;if(t.morphTargetInfluences.length===i.length){t.morphTargetDictionary={};for(let e=0,n=i.length;e<n;e++)t.morphTargetDictionary[i[e]]=e}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function br(t){const e=t.extensions&&t.extensions[Lo.KHR_DRACO_MESH_COMPRESSION];let i;return i=e?"draco:"+e.bufferView+":"+e.indices+":"+yr(e.attributes):t.indices+":"+yr(t.attributes)+":"+t.mode,i}function yr(t){let e="";const i=Object.keys(t).sort();for(let n=0,s=i.length;n<s;n++)e+=i[n]+":"+t[i[n]]+";";return e}function Cr(t){switch(t){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class wr{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new ko,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox|^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.textureLoader=new s.ImageBitmapLoader(this.options.manager):this.textureLoader=new s.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new s.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all(this._invokeAll((function(t){return t.beforeRoot&&t.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(e){const o={scene:e[0][n.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:n.asset,parser:i,userData:{}};Er(s,o,n),Sr(o,n),Promise.all(i._invokeAll((function(t){return t.afterRoot&&t.afterRoot(o)}))).then((function(){t(o)}))})).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i].joints;for(let e=0,i=n.length;e<i;e++)t[n[e]].isBone=!0}for(let e=0,n=t.length;e<n;e++){const n=t[e];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(i[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,i){if(t.refs[e]<=1)return i;const n=i.clone(),s=(t,e)=>{const i=this.associations.get(t);null!=i&&this.associations.set(e,i);for(const[i,n]of t.children.entries())s(n,e.children[i])};return s(i,n),n.name+="_instance_"+t.uses[e]++,n}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let i=0;i<e.length;i++){const n=t(e[i]);if(n)return n}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const i=[];for(let n=0;n<e.length;n++){const s=t(e[n]);s&&i.push(s)}return i}getDependency(t,e){const i=t+":"+e;let n=this.cache.get(i);if(!n){switch(t){case"scene":n=this.loadScene(e);break;case"node":n=this.loadNode(e);break;case"mesh":n=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":n=this.loadAccessor(e);break;case"bufferView":n=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":n=this.loadBuffer(e);break;case"material":n=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":n=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":n=this.loadSkin(e);break;case"animation":n=this.loadAnimation(e);break;case"camera":n=this.loadCamera(e);break;default:throw new Error("Unknown type: "+t)}this.cache.add(i,n)}return n}getDependencies(t){let e=this.cache.get(t);if(!e){const i=this,n=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(n.map((function(e,n){return i.getDependency(t,n)}))),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],i=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[Lo.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(t,o){i.load(s.LoaderUtils.resolveURL(e.uri,n.path),t,void 0,(function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){const i=e.byteLength||0,n=e.byteOffset||0;return t.slice(n,n+i)}))}loadAccessor(t){const e=this,i=this.json,n=this.json.accessors[t];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);const o=[];return void 0!==n.bufferView?o.push(this.getDependency("bufferView",n.bufferView)):o.push(null),void 0!==n.sparse&&(o.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(o).then((function(t){const o=t[0],r=ur[n.type],a=dr[n.componentType],c=a.BYTES_PER_ELEMENT,d=c*r,l=n.byteOffset||0,h=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,u=!0===n.normalized;let p,m;if(h&&h!==d){const t=Math.floor(l/h),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+t+":"+n.count;let d=e.cache.get(i);d||(p=new a(o,t*h,n.count*h/c),d=new s.InterleavedBuffer(p,h/c),e.cache.add(i,d)),m=new s.InterleavedBufferAttribute(d,r,l%h/c,u)}else p=null===o?new a(n.count*r):new a(o,l,n.count*r),m=new s.BufferAttribute(p,r,u);if(void 0!==n.sparse){const e=ur.SCALAR,i=dr[n.sparse.indices.componentType],c=n.sparse.indices.byteOffset||0,d=n.sparse.values.byteOffset||0,l=new i(t[1],c,n.sparse.count*e),h=new a(t[2],d,n.sparse.count*r);null!==o&&(m=new s.BufferAttribute(m.array.slice(),m.itemSize,m.normalized));for(let t=0,e=l.length;t<e;t++){const e=l[t];if(m.setX(e,h[t*r]),r>=2&&m.setY(e,h[t*r+1]),r>=3&&m.setZ(e,h[t*r+2]),r>=4&&m.setW(e,h[t*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(t){const e=this.json,i=this.options,n=e.textures[t].source,s=e.images[n];let o=this.textureLoader;if(s.uri){const t=i.manager.getHandler(s.uri);null!==t&&(o=t)}return this.loadTextureImage(t,n,o)}loadTextureImage(t,e,i){const n=this,o=this.json,r=o.textures[t],a=o.images[e],c=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[c])return this.textureCache[c];const d=this.loadImageSource(e,i).then((function(e){e.flipY=!1,r.name&&(e.name=r.name);const i=(o.samplers||{})[r.sampler]||{};return e.magFilter=lr[i.magFilter]||s.LinearFilter,e.minFilter=lr[i.minFilter]||s.LinearMipmapLinearFilter,e.wrapS=hr[i.wrapS]||s.RepeatWrapping,e.wrapT=hr[i.wrapT]||s.RepeatWrapping,n.associations.set(e,{textures:t}),e})).catch((function(){return null}));return this.textureCache[c]=d,d}loadImageSource(t,e){const i=this,n=this.json,o=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then((function(t){return t.clone()})).catch((function(t){throw t}));const r=n.images[t],a=self.URL||self.webkitURL;let c=r.uri||"",d=!1;if(void 0!==r.bufferView)c=i.getDependency("bufferView",r.bufferView).then((function(t){d=!0;const e=new Blob([t],{type:r.mimeType});return c=a.createObjectURL(e),c}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const l=Promise.resolve(c).then((function(t){return new Promise((function(i,n){let r=i;!0===e.isImageBitmapLoader&&(r=function(t){const e=new s.Texture(t);e.needsUpdate=!0,i(e)}),e.load(s.LoaderUtils.resolveURL(t,o.path),r,void 0,n)}))})).then((function(t){var e;return!0===d&&a.revokeObjectURL(c),t.userData.mimeType=r.mimeType||((e=r.uri).search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"),t})).catch((function(t){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),t}));return this.sourceCache[t]=l,l}assignTexture(t,e,i){const n=this;return this.getDependency("texture",i.index).then((function(s){if(void 0===i.texCoord||0==i.texCoord||"aoMap"===e&&1==i.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+i.texCoord+" for texture "+e+" not yet supported."),n.extensions[Lo.KHR_TEXTURE_TRANSFORM]){const t=void 0!==i.extensions?i.extensions[Lo.KHR_TEXTURE_TRANSFORM]:void 0;if(t){const e=n.associations.get(s);s=n.extensions[Lo.KHR_TEXTURE_TRANSFORM].extendTexture(s,t),n.associations.set(s,e)}}return t[e]=s,s}))}assignFinalMaterial(t){const e=t.geometry;let i=t.material;const n=void 0===e.attributes.tangent,o=void 0!==e.attributes.color,r=void 0===e.attributes.normal;if(t.isPoints){const t="PointsMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new s.PointsMaterial,s.Material.prototype.copy.call(e,i),e.color.copy(i.color),e.map=i.map,e.sizeAttenuation=!1,this.cache.add(t,e)),i=e}else if(t.isLine){const t="LineBasicMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new s.LineBasicMaterial,s.Material.prototype.copy.call(e,i),e.color.copy(i.color),this.cache.add(t,e)),i=e}if(n||o||r){let t="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(t+="specular-glossiness:"),n&&(t+="derivative-tangents:"),o&&(t+="vertex-colors:"),r&&(t+="flat-shading:");let e=this.cache.get(t);e||(e=i.clone(),o&&(e.vertexColors=!0),r&&(e.flatShading=!0),n&&(e.normalScale&&(e.normalScale.y*=-1),e.clearcoatNormalScale&&(e.clearcoatNormalScale.y*=-1)),this.cache.add(t,e),this.associations.set(e,this.associations.get(i))),i=e}i.aoMap&&void 0===e.attributes.uv2&&void 0!==e.attributes.uv&&e.setAttribute("uv2",e.attributes.uv),t.material=i}getMaterialType(){return s.MeshStandardMaterial}loadMaterial(t){const e=this,i=this.json,n=this.extensions,o=i.materials[t];let r;const a={},c=o.extensions||{},d=[];if(c[Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const t=n[Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];r=t.getMaterialType(),d.push(t.extendParams(a,o,e))}else if(c[Lo.KHR_MATERIALS_UNLIT]){const t=n[Lo.KHR_MATERIALS_UNLIT];r=t.getMaterialType(),d.push(t.extendParams(a,o,e))}else{const i=o.pbrMetallicRoughness||{};if(a.color=new s.Color(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;a.color.fromArray(t),a.opacity=t[3]}void 0!==i.baseColorTexture&&d.push(e.assignTexture(a,"map",i.baseColorTexture)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(d.push(e.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),d.push(e.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),r=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),d.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,a)}))))}!0===o.doubleSided&&(a.side=s.DoubleSide);const l=o.alphaMode||fr;if(l===_r?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===vr&&(a.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&r!==s.MeshBasicMaterial&&(d.push(e.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new s.Vector2(1,1),void 0!==o.normalTexture.scale)){const t=o.normalTexture.scale;a.normalScale.set(t,t)}return void 0!==o.occlusionTexture&&r!==s.MeshBasicMaterial&&(d.push(e.assignTexture(a,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(a.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&r!==s.MeshBasicMaterial&&(a.emissive=(new s.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&r!==s.MeshBasicMaterial&&d.push(e.assignTexture(a,"emissiveMap",o.emissiveTexture)),Promise.all(d).then((function(){let i;return i=r===Jo?n[Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new r(a),o.name&&(i.name=o.name),i.map&&(i.map.encoding=s.sRGBEncoding),i.emissiveMap&&(i.emissiveMap.encoding=s.sRGBEncoding),i.sheenColorMap&&(i.sheenColorMap.encoding=s.sRGBEncoding),i.specularColorMap&&(i.specularColorMap.encoding=s.sRGBEncoding),i.specularMap&&(i.specularMap.encoding=s.sRGBEncoding),Sr(i,o),e.associations.set(i,{materials:t}),o.extensions&&Er(n,i,o),i}))}createUniqueName(t){const e=s.PropertyBinding.sanitizeNodeName(t||"");let i=e;for(let t=1;this.nodeNamesUsed[i];++t)i=e+"_"+t;return this.nodeNamesUsed[i]=!0,i}loadGeometries(t){const e=this,i=this.extensions,n=this.primitiveCache;function o(t){return i[Lo.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then((function(i){return Ir(i,t,e)}))}const r=[];for(let i=0,a=t.length;i<a;i++){const a=t[i],c=br(a),d=n[c];if(d)r.push(d.promise);else{let t;t=a.extensions&&a.extensions[Lo.KHR_DRACO_MESH_COMPRESSION]?o(a):Ir(new s.BufferGeometry,a,e),n[c]={primitive:a,promise:t},r.push(t)}}return Promise.all(r)}loadMesh(t){const e=this,i=this.json,n=this.extensions,o=i.meshes[t],r=o.primitives,a=[];for(let t=0,e=r.length;t<e;t++){const e=void 0===r[t].material?(void 0===(c=this.cache).DefaultMaterial&&(c.DefaultMaterial=new s.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:s.FrontSide})),c.DefaultMaterial):this.getDependency("material",r[t].material);a.push(e)}var c;return a.push(e.loadGeometries(r)),Promise.all(a).then((function(i){const a=i.slice(0,i.length-1),c=i[i.length-1],d=[];for(let i=0,l=c.length;i<l;i++){const l=c[i],h=r[i];let u;const p=a[i];if(h.mode===rr||h.mode===ar||h.mode===cr||void 0===h.mode)u=!0===o.isSkinnedMesh?new s.SkinnedMesh(l,p):new s.Mesh(l,p),!0!==u.isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),h.mode===ar?u.geometry=Ar(u.geometry,s.TriangleStripDrawMode):h.mode===cr&&(u.geometry=Ar(u.geometry,s.TriangleFanDrawMode));else if(h.mode===nr)u=new s.LineSegments(l,p);else if(h.mode===or)u=new s.Line(l,p);else if(h.mode===sr)u=new s.LineLoop(l,p);else{if(h.mode!==ir)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new s.Points(l,p)}Object.keys(u.geometry.morphAttributes).length>0&&Tr(u,o),u.name=e.createUniqueName(o.name||"mesh_"+t),Sr(u,o),h.extensions&&Er(n,u,h),e.assignFinalMaterial(u),d.push(u)}for(let i=0,n=d.length;i<n;i++)e.associations.set(d[i],{meshes:t,primitives:i});if(1===d.length)return d[0];const l=new s.Group;e.associations.set(l,{meshes:t});for(let t=0,e=d.length;t<e;t++)l.add(d[t]);return l}))}loadCamera(t){let e;const i=this.json.cameras[t],n=i[i.type];if(n)return"perspective"===i.type?e=new s.PerspectiveCamera(s.MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(e=new s.OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(e.name=this.createUniqueName(i.name)),Sr(e,i),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(t){const e=this.json.skins[t],i={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",e.inverseBindMatrices).then((function(t){return i.inverseBindMatrices=t,i}))}loadAnimation(t){const e=this.json.animations[t],i=[],n=[],o=[],r=[],a=[];for(let t=0,s=e.channels.length;t<s;t++){const s=e.channels[t],c=e.samplers[s.sampler],d=s.target,l=void 0!==d.node?d.node:d.id,h=void 0!==e.parameters?e.parameters[c.input]:c.input,u=void 0!==e.parameters?e.parameters[c.output]:c.output;i.push(this.getDependency("node",l)),n.push(this.getDependency("accessor",h)),o.push(this.getDependency("accessor",u)),r.push(c),a.push(d)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(o),Promise.all(r),Promise.all(a)]).then((function(i){const n=i[0],o=i[1],r=i[2],a=i[3],c=i[4],d=[];for(let t=0,e=n.length;t<e;t++){const e=n[t],i=o[t],l=r[t],h=a[t],u=c[t];if(void 0===e)continue;let p;switch(e.updateMatrix(),e.matrixAutoUpdate=!0,mr[u.path]){case mr.weights:p=s.NumberKeyframeTrack;break;case mr.rotation:p=s.QuaternionKeyframeTrack;break;default:p=s.VectorKeyframeTrack}const m=e.name?e.name:e.uuid,g=void 0!==h.interpolation?gr[h.interpolation]:s.InterpolateLinear,f=[];mr[u.path]===mr.weights?e.traverse((function(t){t.morphTargetInfluences&&f.push(t.name?t.name:t.uuid)})):f.push(m);let v=l.array;if(l.normalized){const t=Cr(v.constructor),e=new Float32Array(v.length);for(let i=0,n=v.length;i<n;i++)e[i]=v[i]*t;v=e}for(let t=0,e=f.length;t<e;t++){const e=new p(f[t]+"."+mr[u.path],i.array,v,g);"CUBICSPLINE"===h.interpolation&&(e.createInterpolant=function(t){return new(this instanceof s.QuaternionKeyframeTrack?er:Qo)(this.times,this.values,this.getValueSize()/3,t)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),d.push(e)}}const l=e.name?e.name:"animation_"+t;return new s.AnimationClip(l,void 0,d)}))}createNodeMesh(t){const e=this.json,i=this,n=e.nodes[t];return void 0===n.mesh?null:i.getDependency("mesh",n.mesh).then((function(t){const e=i._getNodeRef(i.meshCache,n.mesh,t);return void 0!==n.weights&&e.traverse((function(t){if(t.isMesh)for(let e=0,i=n.weights.length;e<i;e++)t.morphTargetInfluences[e]=n.weights[e]})),e}))}loadNode(t){const e=this.json,i=this.extensions,n=this,o=e.nodes[t],r=o.name?n.createUniqueName(o.name):"";return function(){const e=[],i=n._invokeOne((function(e){return e.createNodeMesh&&e.createNodeMesh(t)}));return i&&e.push(i),void 0!==o.camera&&e.push(n.getDependency("camera",o.camera).then((function(t){return n._getNodeRef(n.cameraCache,o.camera,t)}))),n._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){e.push(t)})),Promise.all(e)}().then((function(e){let a;if(a=!0===o.isBone?new s.Bone:e.length>1?new s.Group:1===e.length?e[0]:new s.Object3D,a!==e[0])for(let t=0,i=e.length;t<i;t++)a.add(e[t]);if(o.name&&(a.userData.name=o.name,a.name=r),Sr(a,o),o.extensions&&Er(i,a,o),void 0!==o.matrix){const t=new s.Matrix4;t.fromArray(o.matrix),a.applyMatrix4(t)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);return n.associations.has(a)||n.associations.set(a,{}),n.associations.get(a).nodes=t,a}))}loadScene(t){const e=this.json,i=this.extensions,n=this.json.scenes[t],o=this,r=new s.Group;n.name&&(r.name=o.createUniqueName(n.name)),Sr(r,n),n.extensions&&Er(i,r,n);const a=n.nodes||[],c=[];for(let t=0,i=a.length;t<i;t++)c.push(Rr(a[t],r,e,o));return Promise.all(c).then((function(){return o.associations=(t=>{const e=new Map;for(const[t,i]of o.associations)(t instanceof s.Material||t instanceof s.Texture)&&e.set(t,i);return t.traverse((t=>{const i=o.associations.get(t);null!=i&&e.set(t,i)})),e})(r),r}))}}function Rr(t,e,i,n){const o=i.nodes[t];return n.getDependency("node",t).then((function(t){if(void 0===o.skin)return t;let e;return n.getDependency("skin",o.skin).then((function(t){e=t;const i=[];for(let t=0,s=e.joints.length;t<s;t++)i.push(n.getDependency("node",e.joints[t]));return Promise.all(i)})).then((function(i){return t.traverse((function(t){if(!t.isMesh)return;const n=[],o=[];for(let t=0,r=i.length;t<r;t++){const r=i[t];if(r){n.push(r);const i=new s.Matrix4;void 0!==e.inverseBindMatrices&&i.fromArray(e.inverseBindMatrices.array,16*t),o.push(i)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[t])}t.bind(new s.Skeleton(n,o),t.matrixWorld)})),t}))})).then((function(t){e.add(t);const s=[];if(o.children){const e=o.children;for(let o=0,r=e.length;o<r;o++){const r=e[o];s.push(Rr(r,t,i,n))}}return Promise.all(s)}))}function Ir(t,e,i){const n=e.attributes,o=[];function r(e,n){return i.getDependency("accessor",e).then((function(e){t.setAttribute(n,e)}))}for(const e in n){const i=pr[e]||e.toLowerCase();i in t.attributes||o.push(r(n[e],i))}if(void 0!==e.indices&&!t.index){const n=i.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));o.push(n)}return Sr(t,e),function(t,e,i){const n=e.attributes,o=new s.Box3;if(void 0===n.POSITION)return;{const t=i.json.accessors[n.POSITION],e=t.min,r=t.max;if(void 0===e||void 0===r)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new s.Vector3(e[0],e[1],e[2]),new s.Vector3(r[0],r[1],r[2])),t.normalized){const e=Cr(dr[t.componentType]);o.min.multiplyScalar(e),o.max.multiplyScalar(e)}}const r=e.targets;if(void 0!==r){const t=new s.Vector3,e=new s.Vector3;for(let n=0,s=r.length;n<s;n++){const s=r[n];if(void 0!==s.POSITION){const n=i.json.accessors[s.POSITION],o=n.min,r=n.max;if(void 0!==o&&void 0!==r){if(e.setX(Math.max(Math.abs(o[0]),Math.abs(r[0]))),e.setY(Math.max(Math.abs(o[1]),Math.abs(r[1]))),e.setZ(Math.max(Math.abs(o[2]),Math.abs(r[2]))),n.normalized){const t=Cr(dr[n.componentType]);e.multiplyScalar(t)}t.max(e)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(t)}t.boundingBox=o;const a=new s.Sphere;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,t.boundingSphere=a}(t,e,i),Promise.all(o).then((function(){return void 0!==e.targets?function(t,e,i){let n=!1,s=!1,o=!1;for(let t=0,i=e.length;t<i;t++){const i=e[t];if(void 0!==i.POSITION&&(n=!0),void 0!==i.NORMAL&&(s=!0),void 0!==i.COLOR_0&&(o=!0),n&&s&&o)break}if(!n&&!s&&!o)return Promise.resolve(t);const r=[],a=[],c=[];for(let d=0,l=e.length;d<l;d++){const l=e[d];if(n){const e=void 0!==l.POSITION?i.getDependency("accessor",l.POSITION):t.attributes.position;r.push(e)}if(s){const e=void 0!==l.NORMAL?i.getDependency("accessor",l.NORMAL):t.attributes.normal;a.push(e)}if(o){const e=void 0!==l.COLOR_0?i.getDependency("accessor",l.COLOR_0):t.attributes.color;c.push(e)}}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(c)]).then((function(e){const i=e[0],r=e[1],a=e[2];return n&&(t.morphAttributes.position=i),s&&(t.morphAttributes.normal=r),o&&(t.morphAttributes.color=a),t.morphTargetsRelative=!0,t}))}(t,e.targets,i):t}))}function Ar(t,e){let i=t.getIndex();if(null===i){const e=[],n=t.getAttribute("position");if(void 0===n)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(let t=0;t<n.count;t++)e.push(t);t.setIndex(e),i=t.getIndex()}const n=i.count-2,o=[];if(e===s.TriangleFanDrawMode)for(let t=1;t<=n;t++)o.push(i.getX(0)),o.push(i.getX(t)),o.push(i.getX(t+1));else for(let t=0;t<n;t++)t%2==0?(o.push(i.getX(t)),o.push(i.getX(t+1)),o.push(i.getX(t+2))):(o.push(i.getX(t+2)),o.push(i.getX(t+1)),o.push(i.getX(t)));o.length/3!==n&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=t.clone();return r.setIndex(o),r}const Or={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})},Nr={xAxis:0,yAxis:0,button:0,state:Or.ComponentState.DEFAULT};async function kr(t){const e=await fetch(t);if(e.ok)return e.json();throw new Error(e.statusText)}async function Lr(t,e,i,n){if(void 0===i&&(i=null),void 0===n&&(n=!0),!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const s=await async function(t){if(!t)throw new Error("No basePath supplied");return await kr(`${t}/profilesList.json`)}(e);let o;if(t.profiles.some((t=>{const i=s[t];return i&&(o={profileId:t,profilePath:`${e}/${i.path}`,deprecated:!!i.deprecated}),!!o})),!o){if(!i)throw new Error("No matching profile name found");const t=s[i];if(!t)throw new Error(`No matching profile name found and default profile "${i}" missing.`);o={profileId:i,profilePath:`${e}/${t.path}`,deprecated:!!t.deprecated}}const r=await kr(o.profilePath);let a;if(n){let e;if(e="any"===t.handedness?r.layouts[Object.keys(r.layouts)[0]]:r.layouts[t.handedness],!e)throw new Error(`No matching handedness, ${t.handedness}, in profile ${o.profileId}`);e.assetPath&&(a=o.profilePath.replace("profile.json",e.assetPath))}return{profile:r,assetPath:a}}class Pr{constructor(t){this.componentProperty=t.componentProperty,this.states=t.states,this.valueNodeName=t.valueNodeName,this.valueNodeProperty=t.valueNodeProperty,this.valueNodeProperty===Or.VisualResponseProperty.TRANSFORM&&(this.minNodeName=t.minNodeName,this.maxNodeName=t.maxNodeName),this.value=0,this.updateFromComponent(Nr)}updateFromComponent(t){let{xAxis:e,yAxis:i,button:n,state:s}=t;const{normalizedXAxis:o,normalizedYAxis:r}=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);let i=t,n=e;if(Math.sqrt(t*t+e*e)>1){const s=Math.atan2(e,t);i=Math.cos(s),n=Math.sin(s)}return{normalizedXAxis:.5*i+.5,normalizedYAxis:.5*n+.5}}(e,i);switch(this.componentProperty){case Or.ComponentProperty.X_AXIS:this.value=this.states.includes(s)?o:.5;break;case Or.ComponentProperty.Y_AXIS:this.value=this.states.includes(s)?r:.5;break;case Or.ComponentProperty.BUTTON:this.value=this.states.includes(s)?n:0;break;case Or.ComponentProperty.STATE:this.valueNodeProperty===Or.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(s):this.value=this.states.includes(s)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class Dr{constructor(t,e){if(!(t&&e&&e.visualResponses&&e.gamepadIndices&&0!==Object.keys(e.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=t,this.type=e.type,this.rootNodeName=e.rootNodeName,this.touchPointNodeName=e.touchPointNodeName,this.visualResponses={},Object.keys(e.visualResponses).forEach((t=>{const i=new Pr(e.visualResponses[t]);this.visualResponses[t]=i})),this.gamepadIndices=Object.assign({},e.gamepadIndices),this.values={state:Or.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return le({id:this.id},this.values)}updateFromGamepad(t){if(this.values.state=Or.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&t.buttons.length>this.gamepadIndices.button){const e=t.buttons[this.gamepadIndices.button];this.values.button=e.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,e.pressed||1===this.values.button?this.values.state=Or.ComponentState.PRESSED:(e.touched||this.values.button>Or.ButtonTouchThreshold)&&(this.values.state=Or.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&t.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=t.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===Or.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>Or.AxisTouchThreshold&&(this.values.state=Or.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&t.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=t.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===Or.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>Or.AxisTouchThreshold&&(this.values.state=Or.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((t=>{t.updateFromComponent(this.values)}))}}class Mr{constructor(t,e,i){if(!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No profile supplied");this.xrInputSource=t,this.assetUrl=i,this.id=e.profileId,this.layoutDescription=e.layouts[t.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((t=>{const e=this.layoutDescription.components[t];this.components[t]=new Dr(t,e)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const t=[];return Object.values(this.components).forEach((e=>{t.push(e.data)})),t}updateFromGamepad(){Object.values(this.components).forEach((t=>{t.updateFromGamepad(this.xrInputSource.gamepad)}))}}class xr extends THREE.Object3D{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(t){return this.envMap==t||(this.envMap=t,this.traverse((t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}))),this}updateMatrixWorld(t){super.updateMatrixWorld(t),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((t=>{Object.values(t.visualResponses).forEach((t=>{const{valueNode:e,minNode:i,maxNode:n,value:s,valueNodeProperty:o}=t;e&&(o===Or.VisualResponseProperty.VISIBILITY?e.visible=s:o===Or.VisualResponseProperty.TRANSFORM&&(e.quaternion.slerpQuaternions(i.quaternion,n.quaternion,s),e.position.lerpVectors(i.position,n.position,s)))}))})))}}function Ur(t,e){!function(t,e){Object.values(t.components).forEach((t=>{const{type:i,touchPointNodeName:n,visualResponses:s}=t;if(i===Or.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(n),t.touchPointNode){const e=new THREE.SphereGeometry(.001),i=new THREE.MeshBasicMaterial({color:255}),n=new THREE.Mesh(e,i);t.touchPointNode.add(n)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(s).forEach((t=>{const{valueNodeName:i,minNodeName:n,maxNodeName:s,valueNodeProperty:o}=t;if(o===Or.VisualResponseProperty.TRANSFORM){if(t.minNode=e.getObjectByName(n),t.maxNode=e.getObjectByName(s),!t.minNode)return void console.warn(`Could not find ${n} in the model`);if(!t.maxNode)return void console.warn(`Could not find ${s} in the model`)}t.valueNode=e.getObjectByName(i),t.valueNode||console.warn(`Could not find ${i} in the model`)}))}))}(t.motionController,e),t.envMap&&e.traverse((e=>{e.isMesh&&(e.material.envMap=t.envMap,e.material.needsUpdate=!0)})),t.add(e)}class Vr{constructor(t){void 0===t&&(t=null),this.gltfLoader=t,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new No)}createControllerModel(t){const e=new xr;let i=null;return t.addEventListener("connected",(t=>{const n=t.data;"tracked-pointer"===n.targetRayMode&&n.gamepad&&Lr(n,this.path,"generic-trigger").then((t=>{let{profile:s,assetPath:o}=t;e.motionController=new Mr(n,s,o);const r=this._assetCache[e.motionController.assetUrl];if(r)i=r.scene.clone(),Ur(e,i);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(e.motionController.assetUrl,(t=>{this._assetCache[e.motionController.assetUrl]=t,i=t.scene.clone(),Ur(e,i)}),null,(()=>{throw new Error(`Asset ${e.motionController.assetUrl} missing or malformed.`)}))}})).catch((t=>{console.warn(t)}))})),t.addEventListener("disconnected",(()=>{e.motionController=null,e.remove(i),i=null})),e}}const Fr=new THREE.Vector3,Br=new THREE.Vector3(0,-1,0),jr={type:xe,orientation:{latitude:0,longitude:0},zoom:1,cameraGroup:{position:[0,0,0],rotation:[0,0,0]},pointer:[0,0,0]};class Hr extends t.Component{get error(){return this.error_}set error(t){this.error_!==t&&(this.error_=t,this.pushChanges())}get view(){return this.view_}set view(t){this.view_!==t&&(this.view_=t,this.setView())}get debugging(){return R}get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get locked(){return this.controlled||this.spying}get lockedOrXR(){return this.locked||this.renderer.xr.isPresenting}get showMenu(){return ee.state.hosted&&ee.state.navigable&&("embed"!==ee.state.mode||x.flags.menuEmbed)}get showPointer(){return null!=this.pointer.mesh.parent}set showPointer(t){this.showPointer!==t&&(t?this.scene.add(this.pointer.mesh):this.scene.remove(this.pointer.mesh))}set menu(t){this.menu_!==t&&(this.menu_=t,this.scene.traverse((e=>{(e instanceof Ws||e instanceof Bs)&&(e.freezed=null!=t)})))}get menu(){return this.menu_}onInit(){Cs.host=this,this.defaultTexture=Fs.gridTexture,this.index=0,this.error_=null,this.loading=null,this.waiting=null,this.avatars={},this.createScene(),this.addListeners(),this.animate(),Ns.keys$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.keys=t})),ve.lang$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.setView()}))}onDestroy(){this.removeListeners();this.renderer.setAnimationLoop((()=>{}))}createScene(){const{node:e}=t.getContext(this);this.size={left:0,top:0,width:0,height:0,aspect:0},this.mouse=new THREE.Vector2,this.controllerMatrix_=new THREE.Matrix4,this.controllerWorldPosition_=new THREE.Vector3,this.controllerWorldDirection_=new THREE.Vector3;const i=this.container=e;this.info=e.querySelector(".world__info"),this.worldRect=xs.fromNode(i),this.cameraRect=new xs;const s=this.cameraGroup=new THREE.Group,o=this.camera=new THREE.PerspectiveCamera(70,i.offsetWidth/i.offsetHeight,.01,1e3);o.target=new THREE.Vector3,s.add(o),this.orbitService=new oo(o);const r=this.renderer=new THREE.WebGLRenderer({antialias:x.flags.antialias||!1,alpha:x.flags.alpha||!1,premultipliedAlpha:x.flags.premultipliedAlpha||!1,logarithmicDepthBuffer:!0,powerPreference:"high-performance"});r.setClearColor(0,1),r.setPixelRatio(window.devicePixelRatio),r.setSize(i.offsetWidth,i.offsetHeight),r.xr.enabled=!0,r.outputEncoding=THREE.LinearEncoding,r.toneMapping=THREE.ACESFilmicToneMapping,r.toneMappingExposure=x.toneMappingExposure||1,i.childElementCount>0?i.insertBefore(r.domElement,i.children[0]):i.appendChild(r.domElement);(this.raycaster=new THREE.Raycaster).setFromCamera(this.mouse,o);const a=this.scene=new THREE.Scene;a.add(s),x.flags.useTextureEnvironment&&this.addEnvironment();const c=this.objects=new THREE.Group;c.name="[objects]",a.add(c);const d=this.panorama=new uo(r);this.panoramaIntersectObjects=[d.mesh],this.intersectObjects=this.panoramaIntersectObjects,c.add(d.mesh),this.indicator=new vo,this.pointer=new vo("#ff4332");const l=new THREE.PointLight(16777215,.8);l.position.set(-50,0,0),c.add(l);const h=new THREE.PointLight(16777215,.3);h.position.set(50,0,0),c.add(h);const u=new THREE.PointLight(16777215,.5);u.position.set(0,50,0),c.add(u);const p=new THREE.PointLight(16777215,.1);p.position.set(0,-50,0),c.add(p);const m=this.ambient=new THREE.AmbientLight(16777215,.25);c.add(m),this.addControllers(),this.resize(),Ls.progress$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{const e=0===t.count,i=this.view_;i.items&&i.items.forEach((t=>{t.visible=e}))}))}toggleLights(t){this.ambient&&(this.ambient.visible=t),this.direct&&(this.direct.visible=t)}addEnvironment(){const t=x.textures.envMap.split("/"),e=t.pop(),i=t.join("/")+"/",n=-1!==e.indexOf(".hdr");let s;n?(s=new Os,s.setDataType(THREE.HalfFloatType)):s=new THREE.TextureLoader,s.setPath(x.getPath(i)).load(e,(t=>{n&&t?(t.mapping=THREE.EquirectangularReflectionMapping,this.scene.background=t,this.scene.environment=t):this.setBackground(t)}))}addOffCanvasScene(t){const e=new Vs(t);this.avatars[t.clientId]=e}removeOffCanvasScene(t){this.avatars[t.clientId],delete this.avatars[t.clientId]}updateOffCanvasScene(t){const e=this.avatars[t.clientId];e&&e.update(t)}setBackground(t){let e=t||this.defaultTexture;e.mapping=THREE.EquirectangularReflectionMapping,e.encoding=THREE.sRGBEncoding,this.scene.environment=e}setView(){if(!this.renderer)return;if(!this.panorama)return;const e=this.view_;if(e){null!=ee.state.zoomedId&&ee.patchState({zoomedId:null}),this.views&&this.views.forEach((t=>delete t.onUpdateAsset));const i=this.requestInfoResult;i&&e instanceof Sn&&void 0!==i.gridIndex&&(e.index_=i.gridIndex),e.ready=!1,this.cameraGroup.position.set(0,0,0),this.cameraGroup.rotation.set(0,0,0),e.type.name===fn.Room3d.name?(this.renderer.setClearColor(0,1),this.objects.remove(this.panorama.mesh),this.toggleLights(!1)):(this.renderer.setClearColor(0,1),this.objects.add(this.panorama.mesh),this.toggleLights(!0)),this.pushChanges(),Ms.cancel(),this.panorama.change(e,this.renderer,(i=>{x.flags.useTextureEnvironment||this.setBackground(i),e.ready=!0,e.onUpdateAsset=()=>{this.onViewAssetDidChange()};t.getContext(this)&&this.pushChanges()}),(t=>{this.setViewOrientation(t),Ms.prefetch(t.prefetchAssets)}))}}onViewAssetDidChange(){this.panorama&&this.panorama.crossfade(this.view,this.renderer,(t=>{x.flags.useTextureEnvironment||this.setBackground(t)}))}setViewOrientation(t){const e=this.requestInfoResult;if(this.requestInfoResult=null,this.orbitService&&(this.orbitService.mode=t.type.name,!this.renderer.xr.isPresenting)){let i;e?(i=e.orientation,this.orbitService.setOrientation(i),this.orbitService.zoom=e.zoom,this.camera.updateProjectionMatrix()):t.keepOrientation||(i=t.useLastOrientation?t.lastOrientation:t.orientation,this.orbitService.setOrientation(i),this.orbitService.zoom=t.zoom,this.camera.updateProjectionMatrix())}}addControllers(){const t=this.controllerGroup=new THREE.Group;this.teleport=new _o,this.controllers=[],this.controllerModelFactory=new Vr,this.addController(0),this.addController(1),this.cameraGroup.add(t)}addController(t){const e=ee.state.live,i=this.renderer,n=this.controllerGroup,s=i.xr.getController(t),o=this.controllerModelFactory,r=this.teleport,a=this.scene,c=this.camera,d=this.cameraGroup;s.name=`[controller${t+1}]`,n.add(s);const l=t=>{this.controller=t},h=t=>{switch(t.index){case 0:case 1:break;case 4:ki.send({type:Ve})}},u=t=>{this.onModelUp()},p=t=>{this.cameraGroup.rotation.y+=Math.PI/180*45},m=t=>{this.cameraGroup.rotation.y-=Math.PI/180*45},g=t=>{this.onModelDistance(t.y)};s.userData.update=()=>{},s.addEventListener("selectstart",(t=>{s.userData.isSelecting=!0,l(s)})),s.addEventListener("selectend",(t=>{s.userData.isSelecting=!1})),s.addEventListener("connected",(r=>{if(s.add(this.buildController(r.data)),e&&"left"===r.data.handedness){const t=this.phone=new fo;s.add(t.mesh)}if(!e||"right"===r.data.handedness){const e=i.xr.getControllerGrip(t);e.name=`[controller-grip${t+1}]`;const r=o.createControllerModel(e);s.userData.model=r,e.add(r),n.add(e)}const a=new Io(r.data.gamepad);a.on("press",h),a.on("release",u),a.on("left",p),a.on("right",m),a.on("axis",g),s.userData.gamepad=a,s.userData.update=()=>{a.update()}})),s.addEventListener("disconnected",(e=>{for(;s.children.length;)s.remove(s.children[0]);const o=i.xr.getControllerGrip(t);for(;o.children.length;)o.remove(o.children[0]);n.remove(o),s.userData.update=()=>{};const l=s.userData.gamepad;l&&(l.off("press",h),l.off("release",u),l.off("left",p),l.off("right",m),l.off("axis",g),delete s.userData.gamepad),r.removeFromController(s,a,i,c,d)})),s.addEventListener("squeezestart",(t=>{this.view&&this.view.type.name===fn.Room3d.name&&(r.addToController(s,a),this.indicator.mesh.visible=!1,s.children[0].visible=!1)})),s.addEventListener("squeezeend",(t=>{r.removeFromController(s,a,i,c,d),this.indicator.mesh.visible=!0,s.children[0].visible=!0}));this.controllers.push(s)}buildController(t){let e,i;switch(t.targetRayMode){case"tracked-pointer":return e=new THREE.BufferGeometry,e.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,-1],3)),e.setAttribute("color",new THREE.Float32BufferAttribute([.5,.5,.5,0,0,0],3)),i=new THREE.LineBasicMaterial({vertexColors:!0,blending:THREE.AdditiveBlending}),new THREE.Line(e,i);case"gaze":return e=new THREE.RingBufferGeometry(.02,.04,32).translate(0,0,-1),i=new THREE.MeshBasicMaterial({opacity:.5,transparent:!0}),new THREE.Mesh(e,i)}}updateRaycasterXR(t,e){if(t)return this.controllerMatrix_.identity().extractRotation(t.matrixWorld),e.ray.origin.setFromMatrixPosition(t.matrixWorld),e.ray.direction.set(0,0,-1).applyMatrix4(this.controllerMatrix_),e}repos(t,e){const i=this.worldRect;t.scale.set(.8,.8,.8);const n=(e.x+e.width/2-i.width/2)/i.width*2*this.camera.aspect,s=(e.y+e.height/2-i.height/2)/i.height*2*this.camera.aspect;t.position.set(n,-s,0)}render(t){try{const t=this.renderer,e=this.scene,i=this.camera,n=this.avatars,s=t.xr.isPresenting;if(!s&&ee.state.mode===li)return;s?(gsap.ticker.tick(),this.controllers.forEach((t=>t.userData.update())),this.teleport.update()):this.navWithKeys(),this.orbitService.render();const o=performance.now(),r=this.tick_?++this.tick_:this.tick_=1;e.traverse((n=>{const s=n.userData.render;"function"==typeof s&&s(o,r,t,e,i)})),Object.keys(n).forEach((t=>{n[t].render()})),this.vrService.updateState(this),this.raycasterXRHitTest(),t.render(e,i)}catch(t){this.error=t}}navWithKeys(){if(this.view&&this.view.type.name===fn.Room3d.name&&this.view.mesh&&!this.locked&&!an.hasModal){this.intersectObjects=this.view.intersectObjects;const t=this.velocity||(this.velocity=new THREE.Vector3),e=this.direction||(this.direction=new THREE.Vector3),i=this.camera,n=.1;if(this.keys.w||this.keys.ArrowUp)i.getWorldDirection(e),e.multiplyScalar(n),t.copy(e);else if(this.keys.s||this.keys.ArrowDown)i.getWorldDirection(e),e.multiplyScalar(-n),t.copy(e);else if(this.keys.d||this.keys.ArrowRight){i.getWorldDirection(e),e.multiplyScalar(n);const s=this.axisY||(this.direction=new THREE.Vector3(0,1,0)),o=-Math.PI/2;e.applyAxisAngle(s,o),t.copy(e)}else if(this.keys.a||this.keys.ArrowLeft){i.getWorldDirection(e),e.multiplyScalar(-n);const s=this.axisY||(this.direction=new THREE.Vector3(0,1,0)),o=-Math.PI/2;e.applyAxisAngle(s,o),t.copy(e)}if(t.manhattanLength()>1e-5){e.copy(this.cameraGroup.position),e.add(t),e.y=0;const i=this.raycaster;i.set(e,Br);i.intersectObjects(this.view.navIntersectObjects).length&&(this.cameraGroup.position.add(t),this.cameraGroup.position.y=0,this.orbitService.markAsDirty()),t.lerp(Fr,.1)}else t.set(0,0,0)}else this.intersectObjects=this.panoramaIntersectObjects}animate(){this.renderer.setAnimationLoop(this.render)}resize(){try{const t=this.container,e=this.renderer,i=this.camera,n=this.size,s=t.getBoundingClientRect();n.left=Math.floor(s.left),n.top=Math.floor(s.top),n.width=Math.ceil(s.width),n.height=Math.ceil(s.height),n.aspect=n.width/n.height;if(this.worldRect.setSize(n.width,n.height),!e.xr.isPresenting&&(e.setSize(n.width,n.height),i)){i.aspect=n.width/n.height;const t=i.fov*Math.PI/180,e=Math.abs(i.position.z*Math.tan(t/2)*2),s=this.cameraRect;s.width=e*i.aspect,s.height=e,i.updateProjectionMatrix()}}catch(t){this.error=t}}updateRaycasterMouse(t){const e=this.size.width/2,i=this.size.height/2;this.mouse.x=(t.clientX-this.size.left-e)/e,this.mouse.y=-(t.clientY-this.size.top-i)/i;const n=this.raycaster;return n.setFromCamera(this.mouse,this.camera),n}raycasterXRHitTest(){if(this.renderer.xr.isPresenting&&!this.locked){const t=this.updateRaycasterXR(this.controller,this.raycaster);t&&(ws.hittest(t,this.controller.userData.isSelecting),this.indicator.update(this.renderer.xr.getCamera(this.camera)))}}raycasterDesktopHitTest(t){const e=this.updateRaycasterMouse(t);if(!this.lockedOrXR)if(this.dragItem){if("function"==typeof this.dragItem.onDragMove){const t=e.intersectObjects(this.intersectObjects);if(t.length){const e=t[0],i=this.intersectionPoint||(this.intersectionPoint=new THREE.Vector3),n=this.intersectionNormal||(this.intersectionNormal=new THREE.Vector3),s=i.copy(e.point),o=n.copy(e.face.normal);this.dragItem.onDragMove(s,o,this.intersectObjects===this.panoramaIntersectObjects)}}}else this.resizeItem||(ws.hittest(e),this.controlEvent$.next(jr))}onMouseDown(t){try{if(this.locked)return;if(0!==t.button)return;const e=this.updateRaycasterMouse(t),i=ws.hittest(e,!0);if(this.editor||R){if(!this.keys.Shift&&!this.keys.Control){this.select.next({item:null});const t=e.intersectObjects(this.intersectObjects);if(t.length){const e=t[0],i=this.intersectionPoint||(this.intersectionPoint=new THREE.Vector3),n=this.intersectionNormal||(this.intersectionNormal=new THREE.Vector3),s=i.copy(e.point),o=n.copy(e.face.normal);this.viewHit.next({position:s,normal:o,spherical:this.intersectObjects===this.panoramaIntersectObjects})}}}else if(this.isTouchDevice()&&i&&"[panorama]"===i.name){const t=this.view.items.find((t=>t.showPanel));t&&(t.showPanel=!1,this.pushChanges())}}catch(t){this.error=t}}onMouseMove(t){try{this.raycasterDesktopHitTest(t)}catch(t){this.error=t}}onMouseUp(t){try{if(this.lockedOrXR)return;this.dragItem&&"function"==typeof this.dragItem.onDragEnd&&(this.dragItem.onDragEnd(),this.dragEnd.next(this.dragItem)),this.dragItem=null,this.resizeItem&&"function"==typeof this.resizeItem.onResizeEnd&&(this.resizeItem.onResizeEnd(),this.resizeEnd.next(this.resizeItem)),this.resizeItem=null;const e=this.updateRaycasterMouse(t);ws.hittest(e,!1);this.checkSelectedItem()}catch(t){this.error=t}}onMouseWheel(t){try{if(this.lockedOrXR)return;const e=t.deltaY*(void 0!==t.wheelDeltaY?1:37),i=this.orbitService;gsap.to(i,{duration:.5,zoom:i.zoom+.1*e,ease:Power4.easeOut,overwrite:!0})}catch(t){this.error=t}}onOrientationDidChange(){this.controlEvent$.next(jr)}checkSelectedItem(){if(this.view){const t=this.view.items.find((t=>t.selected));t&&t.mesh&&"model"!==this.view.type.name&&this.orbitService.lookAt(t.mesh)}}onVRStarted(){this.objects.position.y=1.3,this.scene.add(this.indicator.mesh),ki.send({type:ri})}onVREnded(){this.objects.position.y=0,this.cameraGroup.rotation.y=0,this.cameraGroup.position.y=0,this.scene.remove(this.indicator.mesh),this.orbitService.markAsDirty(),ki.send({type:oi})}onVRStateDidChange(t){ki.send({type:ai,camera:t.camera.array})}onMenuNav(t){this.menu=void 0,this.navTo.next({viewId:t.id})}onMenuToggle(t){this.locked||(this.menu=t,this.view.items.forEach((t=>t.showPanel=!1)),this.pushChanges())}onNavOver(t){this.menu||(this.view.items.forEach((t=>t.showPanel=!1)),t.item.to&&clearTimeout(t.item.to),t.item.showPanel=t.shouldShowPanel(),this.pushChanges(),ki.send({type:ti,itemId:t.item.showPanel?t.item.id:null}))}onNavOut(t){this.isTouchDevice()||(t.item.to=setTimeout((()=>{t.item.showPanel=!1,this.pushChanges()}),6e3),this.pushChanges())}onNavDown(t){this.isTouchDevice()||(t.item.showPanel=!1),this.locked||(this.editor&&this.keys.Shift?(this.dragItem=t,this.select.next(t)):this.editor&&this.keys.Control?(this.resizeItem=t,this.select.next(t)):this.navTo.next(t.item))}onNavLink(t){this.locked||this.editor||(x.flags.useIframe?(ki.send({type:je,itemId:t.item.id,linkIndex:t.linkIndex}),this.navLink.next(t)):window.open(t.link.href,"_blank"))}isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}onModelDown(t){if(this.editor)return this.onObjectDown(t);const e=this.controller;if(e&&this.renderer.xr.isPresenting){const i=this.tempTarget=t.mesh;this.tempParent=i.parent;const n=new THREE.Vector3;i.localToWorld(n),e.worldToLocal(n),e.add(i),i.position.copy(n)}}onModelDistance(t){const e=this.controller,i=this.tempTarget;if(e&&i&&this.renderer.xr.isPresenting){let e=new THREE.Vector3;e=e.copy(i.position);const n=Math.max(1,Math.min(8,e.distanceTo(Fr)+.02*t));e.normalize(),e=e.multiplyScalar(n),i.position.copy(e)}}onModelUp(){const t=this.tempTarget,e=this.tempParent;if(t&&e){const i=new THREE.Vector3;t.localToWorld(i),e.worldToLocal(i),e.add(t),t.position.copy(i),this.tempTarget=null,this.tempParent=null}}onObjectDown(t){this.lockedOrXR||(this.editor&&this.keys.Shift?(this.dragItem=t,this.select.next(t)):this.editor&&this.keys.Control&&(this.resizeItem=t,this.select.next(t)))}onPanelDown(t){this.locked||(x.flags.useIframe?(ki.send({type:je,itemId:t.item.id,linkIndex:t.linkIndex}),this.navLink.next(t)):window.open(t.link.href,"_blank"))}onPlayMedia(t){this.editor||ki.send({type:$e,itemId:t.itemId,playing:t.playing})}onZoomMedia(t){t.zoomed&&this.view.items.forEach((e=>{e.mesh instanceof Ws&&e.id!==t.itemId&&e.mesh.setZoomedState(!1)})),this.view.items.forEach((t=>t.showPanel=!1)),ee.patchState({zoomedId:t.zoomed?t.itemId:null}),ki.send({type:ci,itemId:t.itemId,zoomed:t.zoomed})}onCurrentTimeMedia(t){this.editor||ki.send({type:Ue,itemId:t.itemId,currentTime:t.currentTime})}onPlayModel(t){this.editor||ki.send({type:ze,itemId:t.itemId,actionIndex:t.actionIndex})}onGridMove(t){this.view.items=[],this.pushChanges(),this.orbitService.walk(t.position,((e,i)=>{const n=this.view.getTile(t.indices.x,t.indices.y);n&&this.panorama.crossfade(n,this.renderer,(t=>{x.flags.useTextureEnvironment||this.setBackground(t),this.orbitService.walkComplete(e,i),this.view.updateCurrentItems(),this.pushChanges()}))}))}onGridNav(t){this.locked||(ki.send({type:Ge,viewId:this.view.id,gridIndex:t}),this.pushChanges())}setSnapshot(t){ps.viewId!==t.viewId?(ps.viewId=t.viewId,this.requestInfoResult=t):(this.renderer.xr.isPresenting||(this.orbitService.setOrientation(t.orientation),this.orbitService.zoom=t.zoom,this.cameraGroup.position.set(t.cameraGroup.position[0],t.cameraGroup.position[1],t.cameraGroup.position[2]),this.cameraGroup.rotation.set(t.cameraGroup.rotation[0],t.cameraGroup.rotation[1],t.cameraGroup.rotation[2])),this.view instanceof Sn&&t.gridIndex&&(this.view.index=t.gridIndex),this.view&&this.view.ready||(this.requestInfoResult=t))}getSnapshot(){const t=le(le({},jr),{},{viewId:this.view.id,type:Qe});return this.view instanceof Sn&&(t.gridIndex=this.view.index),t}sendSetSnapshot(){const t=this.getSnapshot();ki.send(t)}control$(){return this.controlEvent$.pipe(n.filter((()=>this.controlling||this.spyed||this.editor)),n.auditTime(Math.floor(1e3/15)),n.map((t=>{t.orientation.latitude=this.orbitService.latitude,t.orientation.longitude=this.orbitService.longitude,t.zoom=this.orbitService.zoom,t.cameraGroup={position:this.cameraGroup.position.toArray(),rotation:this.cameraGroup.rotation.toArray()};const e=this.raycaster.intersectObjects(this.intersectObjects),i=e.length?e[0].point.normalize():null;return i&&(t.pointer[0]=i.x,t.pointer[1]=i.y,t.pointer[2]=i.z),ki.send(t),t})),n.auditTime(4e3),n.tap((t=>{const e=this.getSnapshot();ki.send(e)})))}addListeners(){this.controlEvent$=new i.ReplaySubject(1),this.control$().pipe(n.takeUntil(this.unsubscribe$)).subscribe();const t=this.vrService=Ro.getService();t.session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.renderer.xr.setSession(t),t?this.onVRStarted():this.onVREnded()})),t.state$.pipe(n.takeUntil(this.unsubscribe$),n.auditTime(Math.floor(1e3/15))).subscribe((t=>{this.onVRStateDidChange(t)}));this.orbitService.observe$(this.container).pipe(n.shareReplay(1)).pipe(n.filter((t=>t instanceof eo)),n.auditTime(Math.floor(1e3/15))).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.onOrientationDidChange()})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(qi.log("WorldComponent.addListeners","MessageService.out$",t),t.type){case Ke:qi.log("WorldComponent.MessageType.RequestControl",t.controllingId),ee.patchState({controlling:t.controllingId,spying:!1}),t.controllingId===ee.state.uid&&this.sendSetSnapshot();break;case Je:qi.log("WorldComponent.MessageType.RequestSpy",t.spyingId),ee.patchState({spying:t.spyingId,controlling:!1}),t.spyingId===ee.state.uid&&this.sendSetSnapshot();break;case Qe:this.setSnapshot(t);break;case ti:this.menu&&this.menu.removeMenu(),this.view.items.forEach((e=>e.showPanel=e.id===t.itemId)),this.pushChanges();break;case je:{const e=this.view.items.find((e=>e.id===t.itemId));if(e){const i=e.links[t.linkIndex];this.navLink.next({item:e,link:i,linkIndex:t.linkIndex})}break}case He:this.view.items.find((e=>e.id===t.itemId))&&an.resolve();break;case $e:{const e=this.view.items.find((e=>e.id===t.itemId));e&&e.mesh instanceof Ws&&e.mesh.setPlayingState(t.playing);break}case ci:this.view.items.forEach((e=>{e.mesh instanceof Ws&&(e.id===t.itemId?e.mesh.setZoomedState(t.zoomed):e.mesh.setZoomedState(!1))})),ee.patchState({zoomedId:t.zoomed?t.itemId:null});break;case Ue:{const e=this.view.items.find((e=>e.id===t.itemId));e&&e.mesh instanceof Ws&&e.mesh.setCurrentTime(t.currentTime);break}case ze:{const e=this.view.items.find((e=>e.id===t.itemId));e&&e.onMessage(t);break}case Ge:this.view.id===t.viewId&&(this.view.index=t.gridIndex);break;case ri:this.addOffCanvasScene(t);break;case oi:this.removeOffCanvasScene(t);break;case ai:this.updateOffCanvasScene(t),ee.state.spying!==t.clientId&&ee.state.controlling!==t.clientId||this.orbitService.setVRCamera(t.camera);break;case xe:this.renderer.xr.isPresenting||(this.orbitService.setOrientation(t.orientation),this.orbitService.zoom=t.zoom,this.cameraGroup.position.set(t.cameraGroup.position[0],t.cameraGroup.position[1],t.cameraGroup.position[2]),this.cameraGroup.rotation.set(t.cameraGroup.rotation[0],t.cameraGroup.rotation[1],t.cameraGroup.rotation[2])),this.pointer.setPosition(t.pointer[0],t.pointer[1],t.pointer[2],this.camera)}})),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{if(t.type===Ze)this.checkSelectedItem()})),ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.showPointer=this.locked})),this.resize=this.resize.bind(this),this.render=this.render.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseWheel=this.onMouseWheel.bind(this),window.addEventListener("resize",this.resize,!1),this.container.addEventListener("wheel",this.onMouseWheel,!1),this.container.addEventListener("mousedown",this.onMouseDown,!1),this.container.addEventListener("mouseup",this.onMouseUp,!1),document.addEventListener("mousemove",this.onMouseMove,!1)}removeListeners(){window.removeEventListener("resize",this.resize,!1),window.removeEventListener("resize",this.resize,!1),document.removeEventListener("mousemove",this.onMouseMove,!1),document.removeEventListener("wheel",this.onMouseWheel,!1),this.container.removeEventListener("mousedown",this.onMouseDown,!1),this.container.removeEventListener("mouseup",this.onMouseUp,!1)}}Hr.meta={selector:"[world]",inputs:["view","views","editor"],outputs:["navTo","navLink","viewHit","dragEnd","resizeEnd","select"],template:'\n\t<div class="world__view" *if="view">\n\t\t<div class="grid" model-grid *if="view.type.name === \'panorama-grid\'" [view]="view" (move)="onGridMove($event)" (nav)="onGridNav($event)"></div>\n\t\t<div *if="view.ready">\n\t\t\t<div model-room [view]="view" *if="view.type.name === \'room-3d\'"></div>\n\t\t\t<div class="world__item" *for="let item of view.pathItems; let index = index;">\n\t\t\t\t<div model-nav [item]="item" [view]="view" (over)="onNavOver($event)" (out)="onNavOut($event)" (down)="onNavDown($event)" (link)="onNavLink($event)" *if="item.type.name == \'nav\'"></div>\n\t\t\t\t<div model-plane [item]="item" [view]="view" (play)="onPlayMedia($event)" (zoom)="onZoomMedia($event)" (down)="onObjectDown($event)" (currentTime)="onCurrentTimeMedia($event)" *if="item.type.name == \'plane\'"></div>\n\t\t\t\t<div model-curved-plane [item]="item" [view]="view" (play)="onPlayMedia($event)" (zoom)="onZoomMedia($event)" (down)="onObjectDown($event)" (currentTime)="onCurrentTimeMedia($event)" *if="item.type.name == \'curved-plane\'"></div>\n\t\t\t\t<div class="model-viewer__item" model-model [item]="item" [view]="view" (down)="onModelDown($event)" (play)="onPlayModel($event)" *if="item.type.name == \'model\'"></div>\n\t\t\t\t<div class="panel" [class]="{ \'panel--lg\': item.asset != null }" model-panel [item]="item" (down)="onPanelDown($event)" *if="item.showPanel"></div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="progress-indicator" model-progress [view]="view">\n\t\t<div class="inner"></div>\n\t</div>\n\t<div model-menu [views]="views" (nav)="onMenuNav($event)" (toggle)="onMenuToggle($event)" *if="showMenu"></div>\n\t<div model-debug *if="debugging"></div>\n\t<div class="world__info" *if="error" [innerHTML]="error"></div>\n\t'};class Gr extends t.Component{set renderOrder(t){this.group.renderOrder=t}onInit(){if(!this.host)throw"ModelComponent host is undefined";this.scale=new THREE.Vector3(1,1,1),this.position=new THREE.Vector3;const t=this.group=new THREE.Group;t.name=this.getName(),t.userData.render=(t,e)=>{this.render(this,t,e)},this.getContainer().add(t),this.onCreate(((t,e)=>this.onMount(t,e)),((t,e)=>this.onDismount(t,e)))}onDestroy(){const t=this.group;this.getContainer().remove(t),delete t.userData.render,this.disposeObject(t),this.group=null}getContainer(){return this.host.objects}getName(t){return`${this.constructor.meta.selector}-${this.rxcompId}${t?`-${t}`:""}`}onCreate(t,e){const i=new THREE.MeshStandardMaterial({color:new THREE.Color("#ffcc00"),roughness:.4,metalness:.01,flatShading:!0,transparent:!0,opacity:.9}),n=new THREE.Mesh(ys.defaultGeometry,i);return"function"==typeof t&&t(n),n}onMount(t,e){this.mesh&&this.onDismount(this.mesh),t.name=this.getName("mesh"),this.mesh=t,e&&(e.mesh=t,Object.defineProperty(e,"visible",{get:()=>t.visible,set:t=>{this.setVisible(t)},configurable:!0}),e.onUpdate=()=>{this.onUpdate(e,t)},e.onUpdateAsset=()=>{this.onUpdateAsset(e,t)},e.onMessage=t=>{this.onMessage(t)}),this.group&&this.group.add(t)}onDismount(t,e){this.group.remove(t),"function"==typeof t.dispose&&t.dispose(),this.disposeObject(t),this.mesh=null,e&&(delete e.mesh,delete e.onUpdate,delete e.onUpdateAsset,delete e.onMessage)}disposeObject(t){t.traverse((t=>{(t.isInteractiveMesh||t.isInteractiveSprite)&&ws.dispose(t),t.isMesh?(t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose(),t.geometry.dispose()):t.isSprite&&(t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose())}))}calculateScaleAndPosition(){const{node:e}=t.getContext(this);this.host.repos(this,e.getBoundingClientRect())}render(t,e){}setVisible(t){this.mesh&&(this.mesh.visible=t)}getScroll(t){return this.intersection.scroll(t)}getTween(t){let e=Math.min(0,this.intersection.offset(t))+1;return e=Math.max(0,e),e-=1,e}onUpdate(t,e){}onUpdateAsset(t,e){}onMessage(t){}}Gr.meta={selector:"[model]",hosts:{host:Hr},inputs:["item"]};class Wr extends Gr{get editing(){return this.editing_}set editing(t){this.editing_!==t&&(this.editing_=t,this.setHelper(t))}onInit(){super.onInit(),this.RADIUS=100}onDestroy(){this.editing=!1,super.onDestroy()}setHelper(t){t?(this.helper||(this.helper=new THREE.BoxHelper(this.mesh,65280)),this.host.scene.add(this.helper)):this.helper&&this.host.scene.remove(this.helper)}updateHelper(){this.helper&&this.helper.setFromObject(this.mesh)}}Wr.meta={selector:"[model-editable]",hosts:{host:Hr},inputs:["item"]};const $r="none",zr="move",qr="info",Kr="point",Yr="title",Jr="transparent",Xr="wishlist";class Zr extends Wr{constructor(){super(...arguments),this.hidden_=!1,this.isMobile_=void 0}static getLoader(){return Zr.loader||(Zr.loader=new THREE.TextureLoader)}static getTexturePoint(){return Zr.texturePoint||(Zr.texturePoint=Zr.getLoader().load(x.getPath("textures/ui/nav-point.png")))}static getTexturePointImportant(){return Zr.texturePointImportant||(Zr.texturePointImportant=Zr.getLoader().load(x.getPath("textures/ui/nav-point-important.png")))}static getTextureMove(){return Zr.textureMove||(Zr.textureMove=Zr.getLoader().load(x.getPath("textures/ui/nav-more.png")))}static getTextureMoveImportant(){return Zr.textureMoveImportant||(Zr.textureMoveImportant=Zr.getLoader().load(x.getPath("textures/ui/nav-more-important.png")))}static getTextureInfo(){return Zr.textureInfo||(Zr.textureInfo=Zr.getLoader().load(x.getPath("textures/ui/nav-info.png")))}static getTextureInfoImportant(){return Zr.textureInfoImportant||(Zr.textureInfoImportant=Zr.getLoader().load(x.getPath("textures/ui/nav-info-important.png")))}static getTextureWishlist(){return Zr.textureWishlist||(Zr.textureWishlist=Zr.getLoader().load(x.getPath("textures/ui/nav-wishlist-off.png")))}static getTextureWishlistAdded(){return Zr.textureWishlistAdded||(Zr.textureWishlistAdded=Zr.getLoader().load(x.getPath("textures/ui/nav-wishlist-on.png")))}static getTexture(t,e){let i;switch(t){case zr:i=e.important?this.getTextureMoveImportant():this.getTextureMove();break;case qr:i=e.important?this.getTextureInfoImportant():this.getTextureInfo();break;case Kr:case Yr:i=e.important?this.getTexturePointImportant():this.getTexturePoint();break;case Xr:i=e.added?this.getTextureWishlistAdded():this.getTextureWishlist()}return i.disposable=!1,i.encoding=THREE.sRGBEncoding,i}static getTitleTexture(t,e){let i;if(e===Yr){const e=t.title,n=document.createElement("canvas");n.width=512,n.height=32;const s=n.getContext("2d");s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.font=`24px ${x.fontFamily}`;let o=s.measureText(e).width+8;o=Math.pow(2,Math.ceil(Math.log(o)/Math.log(2)));const r=o/2,a=16;n.width=o,s.font=`24px ${x.fontFamily}`,s.textAlign="center",s.textBaseline="middle",s.strokeStyle="rgba(0, 0, 0, 0.5)",s.lineWidth=6,s.lineJoin="round",s.miterLimit=2,s.strokeText(e,r,a),s.fillStyle="white",s.fillText(e,r,a),i=new THREE.CanvasTexture(n)}return i}static getNavMode(t,e){let i=$r;return t.hook&&"ToggleWishlist"===t.hook?i=Xr:t.transparent?i=Jr:t.viewId!==e.id?(i=zr,this.isValidText(t.title)&&(i=Yr),(this.isValidText(t.abstract)||t.asset&&t.asset.id||t.link&&t.link.href)&&(i=Kr)):(this.isValidText(t.title)||this.isValidText(t.abstract)||t.asset&&t.asset.id||t.link&&t.link.href)&&(i=qr),i}static hasNavInfo(t){return null!=t.items.find((e=>this.getNavMode(e,t)===qr))}static isValidText(t){return t&&t.length>0}get hidden(){return this.hidden_}set hidden(t){this.hidden_!==t&&(this.hidden_=t,this.updateVisibility(!t))}get isHidden(){return null!=ee.state.zoomedId||x.flags.hideNavInfo&&!this.host.editor&&!ee.state.showNavInfo&&!(this.host.renderer.xr.isPresenting||ee.state.role===ie.SelfService||ee.state.role===ie.Embed)&&this.mode===qr}get isAnimated(){let t=!1;const e=this.mode,i=this.item.important;switch(e){case qr:t=i?x.flags.navInfoImportantAnimated:x.flags.navInfoAnimated;break;case zr:t=i?x.flags.navMoveImportantAnimated:x.flags.navMoveAnimated;break;case Kr:t=i?x.flags.navPointImportantAnimated:x.flags.navPointAnimated;break;case Yr:t=i?x.flags.navTitleImportantAnimated:x.flags.navTitleAnimated;break;case Jr:t=i?x.flags.navTransparentImportantAnimated:x.flags.navTransparentAnimated}return t}get iconMinScale(){return.03*(x.navs.iconMinScale||1)*(this.isMobile?1.6:1)}get iconMaxScale(){return.03*(x.navs.iconMaxScale||1.5)*(this.isMobile?1.6:1)}get isMobile(){return this.isMobile_}set isMobile(t){this.isMobile_!==t&&(this.isMobile_=t,this.setScale())}render(t,e){this.isMobile=this.host.worldRect.width<768}setScale(t){void 0===t&&(t=0);const e=this.icon;if(e){const i=this.iconMinScale+t*(this.iconMaxScale-this.iconMinScale);e.scale.set(i,i,i)}}shouldShowPanel(){return!this.editing&&this.mode!==zr&&this.mode!==Yr&&this.mode!==Xr&&(this.mode!==Jr||Zr.isValidText(this.item.title))}updateVisibility(t){this.mesh&&(this.mesh.visible=t),this.sphere&&(this.sphere.freezed=!t),!t&&this.item&&(this.item.showPanel=!1)}setVisible(t){this.mesh&&(this.mesh.visible=t&&!this.hidden_)}onInit(){super.onInit()}onChanges(){const t=this.view,e=this.item;(this.mode=Zr.getNavMode(e,this.view))===Xr&&(e.added=gs.has({viewId:t.id,itemId:e.id}),this.onCreateSprites(this.mesh,1)),this.editing=e.selected,this.hidden=this.isHidden}onCreate(t,e){const i=this.view,n=this.item,s=this.mode=Zr.getNavMode(n,this.view);if(s===$r)return;s===Xr&&(n.added=gs.has({viewId:i.id,itemId:n.id}));const o=this.isAnimated,r=new THREE.Group;if(s===Jr){const t=this.host.editor?.1:0,e=.2,i=.3;r.position.fromArray(n.position),r.rotation.fromArray(n.rotation),r.scale.fromArray(n.scale);const s=ys.planeGeometry,a=this.plane=new As(s,new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,opacity:t,color:new THREE.Color(x.colors.menuOverBackground),toneMapped:!1}));if(a.name=`[nav] ${n.id}`,a.depthTest=!1,r.add(a),o){const t={pow:0};gsap.to(t,{pow:1,duration:.6,delay:.5+.1*n.index,ease:Power2.easeOut,repeat:-1,yoyo:!0,onUpdate:()=>{a.material.opacity=t.pow*i}})}a.on("over",(()=>{o||(a.material.opacity=e),this.over.next(this)})),a.on("out",(()=>{o||(a.material.opacity=t),this.out.next(this)})),a.on("down",(()=>{o||(a.material.opacity=i),this.down.next(this);const t=this.item.firstLink;!this.host.editor&&!this.shouldShowPanel()&&t&&t.href&&(this.shouldNavToLink=t.href),console.log("ModelNavComponent.down")})),a.on("up",(()=>{if(o||(a.material.opacity=t),null!=this.shouldNavToLink){this.shouldNavToLink=null;const t=this.item,e=t.firstLink;this.link.next({item:t,link:e})}}))}else{const t=new THREE.Vector3(n.position[0],n.position[1],n.position[2]),e=new THREE.Vector3(n.position[0],n.position[1],n.position[2]).normalize();t.distanceToSquared(e)<1e-4&&t.multiplyScalar(Zr.RADIUS),r.position.copy(t),this.onCreateSprites(r);const i=ys.sphereGeometry,s=this.sphere=new As(i,new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,opacity:0,color:65535,toneMapped:!1}));s.name=`[nav] ${n.id}`,s.depthTest=!1,r.add(s);const a={pow:0};gsap.to(a,{pow:1,duration:.7,delay:.5+.1*n.index,ease:Power2.easeInOut,overwrite:!0,onUpdate:()=>{this.materials.forEach((t=>{t.opacity=a.pow}))},onComplete:()=>{if(o){const t=this.icon;a.pow=0,gsap.to(a,{pow:1,duration:.6,delay:.5+.1*n.index,ease:Power2.easeOut,repeat:-1,yoyo:!0,onUpdate:()=>{this.setScale(a.pow),t.material.opacity=a.pow}})}}}),s.on("over",(()=>{if(this.over.next(this),!o){const t=this.icon,e={scale:t.scale.x};gsap.to(e,{duration:.35,scale:this.iconMaxScale,delay:0,ease:Power2.easeOut,overwrite:!0,onUpdate:()=>{t.scale.set(e.scale,e.scale,e.scale)}})}})),s.on("out",(()=>{if(this.out.next(this),!o){const t=this.icon,e={scale:t.scale.x};gsap.to(e,{duration:.35,scale:this.iconMinScale,delay:0,ease:Power2.easeOut,overwrite:!0,onUpdate:()=>{t.scale.set(e.scale,e.scale,e.scale)}})}})),s.on("down",(()=>{this.down.next(this)}))}"function"==typeof t&&t(r,n)}onCreateSprites(t,e){void 0===e&&(e=0),this.onRemoveSprite(this.icon),this.onRemoveSprite(this.title);const i=this.item,n=this.mode=Zr.getNavMode(i,this.view);if(n!==$r)if(n===Jr)this.materials=[];else{const s=Zr.getTexture(n,i),o=new THREE.SpriteMaterial({map:s,depthTest:!1,depthWrite:!1,transparent:!0,sizeAttenuation:!1,opacity:e,toneMapped:!1}),r=[o],a=this.icon=new THREE.Sprite(o);let c;a.renderOrder=x.renderOrder.nav,this.setScale(),t.add(a);const d=Zr.getTitleTexture(i,n);if(d){c=new THREE.SpriteMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:d,sizeAttenuation:!1,opacity:e,toneMapped:!1});const i=d.image,n=this.title=new THREE.Sprite(c),s=this.iconMinScale;n.scale.set(s*i.width/i.height,s,s),n.position.set(0,-3.5,0),t.add(n),r.push(c)}this.materials=r}}onRemoveSprite(t){t&&(t.parent&&t.parent.remove(t),t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose())}onDestroy(){ws.dispose(this.sphere),super.onDestroy()}onUpdate(t,e){this.item=t,this.onCreateSprites(e,1),this.mode===Jr?(t.position&&e.position.fromArray(t.position),t.rotation&&e.rotation.fromArray(t.rotation),t.scale&&e.scale.fromArray(t.scale)):(e.position.fromArray(t.position),e.rotation.set(0,0,0),e.scale.set(1,1,1)),this.updateHelper()}onDragMove(t,e,i){const n=this.item,s=this.mesh;this.editing=!0,n.showPanel=!1,this.mode===Jr?i?(t.normalize().multiplyScalar(Zr.RADIUS),s.position.set(t.x,t.y,t.z),s.lookAt(Cs.origin)):(s.position.set(0,0,0),s.lookAt(e),s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))):i?(t.normalize().multiplyScalar(Zr.RADIUS),s.position.set(t.x,t.y,t.z)):(s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))),this.updateHelper()}onDragEnd(){const t=this.item,e=this.mesh;this.mode===Jr?(t.position=e.position.toArray(),t.rotation=e.rotation.toArray(),t.scale=e.scale.toArray()):t.position=e.position.toArray(),this.editing=!1}}Zr.RADIUS=100,Zr.meta={selector:"[model-nav]",hosts:{host:Hr},outputs:["over","out","down","link"],inputs:["item","view"]};class Qr extends t.Component{get meetingUrl(){return this.meetingUrl_||(this.meetingUrl_=new re),this.meetingUrl_}get isVirtualTourUser(){return-1!==[ie.Publisher,ie.Attendee,ie.Streamer,ie.Viewer].indexOf(ee.state.role)}get isEmbed(){return this.route&&"embed"===this.route.params.mode}get isSelfServiceTour(){return this.route&&"selfServiceTour"===this.route.params.mode}get isNavigable(){return null==this.meetingUrl.embedViewId}get isBackButtonVisible(){return this.view&&(this.view.type.name===fn.Media.name||this.view.type.name===fn.Model.name)}get isSelfServiceProposition(){return ee.state.role===ie.SelfService&&x.flags.selfServiceProposition}get isSelfServiceSupport(){return ee.state.role===ie.Publisher&&x.flags.selfServiceProposition&&this.meetingUrl.support}get showNavInfoToggler(){return x.flags.hideNavInfo&&this.state.mode!==li&&this.view&&Zr.hasNavInfo(this.view)}get uiClass(){const t={};return t[this.state.role]=!0,t.chat=this.state.chat,t.remotes=this.state.mode===li,t.remoteScreen=null!=this.remoteScreen&&!this.hasScreenViewItem,t.locked=this.locked,t}get remoteClass(){return`group--remote--${Math.min(9,this.remotes.length)}`}get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get locked(){return this.controlled||this.spying}get remoteScreen(){return this.remoteScreen_}set remoteScreen(t){this.remoteScreen_!==t&&(this.remoteScreen_=t,setTimeout((()=>{window.dispatchEvent(new Event("resize"))}),1))}get pathViews(){return ps.pathViews}onInit(){const{node:e}=t.getContext(this);e.classList.remove("hidden"),this.platform=ji.platform,this.route=this.host?this.host.route:null,this.state={},this.hosted=null,this.view=null,this.previousView=null,this.form=null,this.local=null,this.screen=null,this.remoteScreen_=null,this.navmaps=[],this.navmap=null,this.hasScreenViewItem=!1,this.remotes=[];(this.vrService=Ro.getService()).status$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.pushChanges())),this.resolveUser()}getName(t){return ee.state.name||re.getName(t)}getLinkRole(){let t=null;if(this.isSelfServiceTour)return t=ie.SelfService,t;const e=((new re).link||"").match(/\d{9}-(\d{4})-\d{13}/);if(e){const i=parseInt(e[1]);t=Object.keys(ie).reduce(((t,e,n)=>n===i?ie[e]:t),null)}return t}resolveUser(){this.isEmbed?Ci.temporaryUser$(ie.Embed).pipe(n.first()).subscribe((t=>{this.initWithUser(t)})):this.isSelfServiceTour?Ci.overrideUser$(ie.SelfService).pipe(n.first()).subscribe((t=>{this.initWithUser(t)})):Ci.me$().pipe(n.first()).subscribe((t=>{this.initWithUser(t)}))}userGuard(t){const e=this.getLinkRole();!t||e&&t.type!==e?this.initWithUser({type:e}):this.initWithUser(t)}userGuardRedirect(t){const e=this.getLinkRole();!t||e&&e!==t.type?e===ie.Publisher||e===ie.Attendee?te.setRouterLink(_e.transform(":lang.access")):this.initWithUser({type:e}):this.initWithUser(t)}setNextStatus(){let t=Te;const e=ee.state;return e.role===ie.SmartDevice&&(e.name=e.name||"Smart Device"),t=e.checklist?e.link?e.user.id||e.role!==ie.Publisher&&e.role!==ie.Attendee?e.name?e.role!==ie.Viewer&&e.role!==ie.SmartDevice?Re:Ie:we:Ce:ye:be,ee.patchState({status:t}),t}getPathId(){const t=new re;let e=t.pathId;if(e)return parseInt(e);const i=t.link;if(i){e=new oe(i).pathId}return e}initWithUser(t){const e=(new re).link,i=this.getPathId(),s=this.getLinkRole()||(t?t.type:null);if(s===ie.SelfService){if(!t||t.type!==ie.SelfService&&t.type!==ie.Publisher)return void te.setRouterLink(_e.transform(":lang.access"));t=Object.assign({},t,{type:ie.SelfService})}else s!==(t=t||{type:s}).type&&(t={type:s});const o=Ci.getMode(s),r=this.getMeetingName(t),a=s===ie.Publisher,c=s!==ie.SelfService&&s!==ie.Embed&&!R,d=this.isNavigable,l={user:t,role:s,mode:o,name:r,checklist:null,pathId:i,link:e,channelName:x.channelName,uid:null,status:Te,connecting:!1,connected:!1,controlling:!1,spying:!1,silencing:!1,hosted:a,live:c,navigable:d,cameraMuted:!1,audioMuted:!1,showNavInfo:!0};ee.state=l,ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.hosted=t.hosted,this.pushChanges(),this.locked?document.body.classList.add("locked"):document.body.classList.remove("locked")})),this.initAgora()}getMeetingName(t){const e=new re;let i=null;return i=x.flags.useExtendedUserInfo?e.firstName&&e.lastName?`${e.firstName} ${e.lastName}`:null:e.name?e.name:null,!i&&t.firstName&&t.lastName&&(i=`${t.firstName} ${t.lastName}`),i}viewObserver$(){return ps.data$().pipe(n.switchMap((t=>Dn.getCurrentPath$(ee.state.pathId).pipe(n.switchMap((e=>ps.hostedView$(t,e)))))),n.map((t=>{this.agora&&this.agora.navToView(t.id,t.keepOrientation,t.useLastOrientation),this.previousView=this.view,this.view=t,this.setNavmap(t),this.hasScreenViewItem=null!=t.items.find((t=>bs.isPublisherScreen(t)||bs.isAttendeeScreen(t))),this.pushChanges();const e=this.state;return Hn.push({action:"b-here-view",viewId:t.id,userType:e.role}),t})))}load(t){this.loadNavmaps(),this.viewObserver$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((e=>{"function"==typeof t&&(t(),t=null)}))}loadNavmaps(){x.flags.navmaps&&jn.navmapGet$().pipe(n.first()).subscribe((t=>{this.navmaps=t}))}setNavmap(t){const e=(this.navmaps||[]).find((e=>null!=(e.items||[]).find((e=>e.viewId===t.id))))||null;this.navmap=e}toggleNavmap(){ee.patchState({showNavmap:!ee.state.showNavmap})}onNavmapItem(t){ee.patchState({showNavmap:!1}),this.onNavTo(t)}loadAndConnect(t){this.load((()=>{this.connect(t)}))}initAgora(){this.state.role===ie.SelfService||this.state.role===ie.Embed||R?(this.load((()=>{ee.patchState({status:Oe,hosted:!0})})),this.checkSelfServiceProposition(),this.checkSelfServiceAudio()):ln.isChecked$().pipe(n.first()).subscribe((t=>{ee.patchState({checklist:t}),this.agora=Qi.getSingleton(),this.getLinkRole(),this.setNextStatus()})),Zi.local$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.local=t,this.pushChanges()})),Zi.screen$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.screen===this.remoteScreen&&(this.remoteScreen=null),this.screen=t,this.remoteScreen=t||this.remoteScreen,this.pushChanges()})),Zi.orderedRemotes$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.remotes=[],this.remoteScreen=this.screen,t.forEach((t=>{t.clientInfo&&t.clientInfo.screenUid===t.streamId?this.remoteScreen=t:this.remotes.push(t)})),this.pushChanges()})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.type){case Le:if(this.isSelfServiceSupport){t.members.length>0?(Xn.open$({message:ge.transform("bhere_support_request_sent"),type:Wn,position:qn}),ki.send({type:ii})):Xn.open$({message:ge.transform("bhere_support_request_leaved"),type:Wn,position:qn})}break;case ii:this.isSelfServiceProposition&&this.openSupportRequestDialog(t.clientInfo);break;case ni:Xn.open$({message:ge.transform("bhere_support_request_accepted"),type:Wn,position:qn});break;case si:Xn.open$({message:ge.transform("bhere_support_request_rejected"),type:Wn,position:qn});break;case qe:ee.patchState({silencing:t.silencing}),this.setAudio(t.silencing);break;case We:this.onRemoteNavTo(t);break;case Fe:ee.patchState({mode:t.mode}),window.dispatchEvent(new Event("resize"));break;case Be:this.hidePanels(),ee.patchState({showNavInfo:t.showNavInfo});break;case Ne:ps.setViewLike$(t).pipe(n.first()).subscribe((t=>this.showLove(t)));break;case Pe:ee.state.chat||ee.patchState({chatDirty:!0})}})),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.agora&&this.agora.sendMessage(t)})),this.fullscreen$().pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.agora&&ee.state.status===Ie&&this.loadAndConnect()}onChecked(t){ee.patchState({checklist:!0}),this.setNextStatus()}onLink(t){const e=new oe(t).pathId,i=this.getLinkRole(),n=Ci.getMode(i),s=ee.state.user;i!==ie.Publisher&&i!==ie.Attendee||s.id&&s.type===i?ee.state.name?i===ie.Viewer||i===ie.SmartDevice?(ee.patchState({link:t,pathId:e,role:i,mode:n}),this.loadAndConnect()):ee.patchState({link:t,pathId:e,role:i,mode:n,status:Re}):ee.patchState({link:t,pathId:e,role:i,mode:n,status:we}):ee.patchState({link:t,pathId:e,role:i,mode:n,status:Ce})}onLogin(t){const e=this.getName(t);e?ee.patchState({user:t,name:e,status:Re}):ee.patchState({user:t,status:we})}onName(t){ee.state.role===ie.Viewer||ee.state.role===ie.SmartDevice?(ee.patchState({name:t}),this.loadAndConnect()):ee.patchState({name:t,status:Re})}onEnter(t){this.loadAndConnect(t)}connect(t){this.agora.connect$(t).pipe(n.takeUntil(this.unsubscribe$)).subscribe();const e=this.state;if(e.role===ie.SelfService)Hn.push({action:"b-here-tour",userType:e.role});else if(e.role===ie.Embed)Hn.push({action:"b-here-embed",userType:e.role});else{const t=new re,i=e.link.replace(/-\d+-/,"-"),s={meetingId:e.link,sharedMeetingId:i,userType:e.role};x.flags.useExtendedUserInfo?(s.firstName=t.firstName,s.lastName=t.lastName,s.email=t.email):s.fullName=e.name,Ci.log$(s).pipe(n.first()).subscribe(),Hn.push({action:"b-here-meeting",meetingId:e.link,sharedMeetingId:i,userType:e.role})}}disconnect(){this.agora?this.agora.leaveChannel().then((()=>{window.location.reload()}),console.log):this.patchState({connecting:!1,connected:!1})}onNavTo(t){const e=t.viewId,i=this.pathViews.find((t=>t.id===e));i&&(ps.action={viewId:e,keepOrientation:t.keepOrientation,useLastOrientation:t.useLastOrientation},this.onHandleHook(i,t))}onNavLink(t){an.open$({iframe:t.link.href}).pipe(n.first()).subscribe((e=>{ki.send({type:He,itemId:t.item.id})}))}onRemoteNavTo(t){const e=t.viewId,i=t.gridIndex;if(e&&ps.viewId!==e){const n=this.pathViews.find((t=>t.id===e));n&&(ps.action={viewId:e,keepOrientation:t.keepOrientation,useLastOrientation:t.useLastOrientation},null!=i&&n instanceof Sn&&(n.index=i))}}onHandleHook(t,e){switch(e.hook){case"ToggleWishlist":{const i={viewId:t.id,itemId:e.id};gs.toggle$(i).pipe(n.switchMap((t=>(i.added=gs.has(i),Ii.send$(e.hook,i,e.extra)))),n.first()).subscribe((t=>{qi.log("AgoraComponent.onHandleHook",t),e.added=i.added,this.pushChanges()}));break}}}patchState(t){this.state=Object.assign({},this.state,t),this.pushChanges()}toggleCamera(){this.agora?this.agora.toggleCamera():this.patchState({cameraMuted:!this.state.cameraMuted})}toggleAudio(){this.agora?this.agora.toggleAudio():this.patchState({audioMuted:!this.state.audioMuted})}setAudio(t){this.agora?this.agora.setAudio(t):this.patchState({audioMuted:t})}toggleScreen(){this.agora?this.agora.toggleScreen():this.patchState({screen:!this.state.screen}),window.dispatchEvent(new Event("resize"))}toggleVolume(){const t=!this.state.volumeMuted;ee.patchState({volumeMuted:t});const e=this.selfServiceAudio;e&&(e.volume=t?0:.5)}toggleMode(){if(this.agora&&ee.state.role===ie.Publisher)this.agora.toggleMode();else{const t=this.state.mode===di?li:di;ee.patchState({mode:t})}window.dispatchEvent(new Event("resize"))}toggleFullScreen(){const{node:e}=t.getContext(this);!this.state.fullScreen?e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}fullscreen$(){return i.fromEvent(document,"fullscreenchange").pipe(n.tap((t=>{const e=null!=document.fullscreenElement;ee.patchState({fullScreen:e})})))}toggleChat(){ee.patchState({chat:!ee.state.chat,chatDirty:!1}),window.dispatchEvent(new Event("resize"))}onChatClose(){ee.patchState({chat:!1}),window.dispatchEvent(new Event("resize"))}toggleNavInfo(){this.hidePanels(),this.agora?this.agora.toggleNavInfo():this.patchState({showNavInfo:!this.state.showNavInfo})}onBack(){this.previousView&&this.view&&this.previousView.id!==this.view.id&&(ps.action={viewId:this.previousView.id,useLastOrientation:!0})}hidePanels(){this.view.items.forEach((t=>t.showPanel=!1))}onToggleControl(t){if(this.agora)this.agora.toggleControl(t);else{const e=this.state.controlling===t?null:t;this.patchState({controlling:e,spying:!1})}}onToggleSilence(){this.agora?this.agora.toggleSilence():this.patchState({silencing:!this.state.silencing})}onToggleSpy(t){if(this.agora)this.agora.toggleSpy(t);else{const e=this.state.spying===t?null:t;this.patchState({spying:e,controlling:!1})}}addLike(){ps.viewLike$(this.view).pipe(n.first()).subscribe((t=>{t&&(this.view.liked=!0,this.showLove(t),ki.send({type:Ne,viewId:this.view.id,likes:this.view.likes}))}))}showLove(t){if(t&&this.view.id===t.id){const e=this.view.showLove;this.view.likes=t.likes,this.view.showLove=!0,this.pushChanges(),e||setTimeout((()=>{this.view.showLove=!1,this.pushChanges()}),3100)}}tryInAr(){this.platform===Ui||this.platform===Vi?Qn.openInAR(this.view):an.open$({template:Qn.chunk(),data:this.view}).pipe(n.first()).subscribe((t=>{}))}checkSelfServiceProposition(){this.isSelfServiceProposition&&ln.check$().pipe(n.first()).subscribe((t=>{const e=new oe({pathId:ee.state.pathId}).toRoles(),s=new re({link:e.id,support:!0}),o=window.location.origin+s.toGuidedTourUrl();qi.log("AgoraComponent.checkSelfServiceProposition",o),Ci.selfServiceSupportRequest$(ee.state.user,e.id,o).pipe(n.first(),n.catchError((t=>(console.log("UserService.selfServiceSupportRequest$.error",t),i.EMPTY)))).subscribe((t=>{const i=this.getName(ee.state.user);ee.patchState({checklist:!0,link:e.idSelfService,name:i}),this.agora=Qi.getSingleton(),this.connect()}))}),(t=>{qi.error("AgoraComponent.checkSelfServiceProposition.error",t)}))}checkSelfServiceAudio(){if(ee.state.role===ie.SelfService&&x.selfServiceAudio){const e=document.createElement("audio");e.setAttribute("playsinline","true"),e.setAttribute("autoplay","true"),e.setAttribute("loop","true"),e.volume=.5,e.src=x.getPath(x.selfServiceAudio);const{node:i}=t.getContext(this);i.parentNode.appendChild(e),this.selfServiceAudio=e,bs.events$.pipe(n.tap((t=>{t instanceof vs?e.pause():(t instanceof _s||t instanceof Es)&&e.play()})),n.takeUntil(this.unsubscribe$)).subscribe()}}openSupportRequestDialog(t){Xn.open$({message:ge.transform("bhere_support_request_dialog"),acceptMessage:ge.transform("bhere_support_request_dialog_accept"),rejectMessage:ge.transform("bhere_support_request_dialog_reject"),type:$n,position:qn}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{if(t instanceof Yn){ki.send({type:ni});const t=ee.state.name,e=new oe(ee.state.link);e.role=ie.Streamer;const i={link:e.toString()};if(x.flags.useExtendedUserInfo){const t=ee.state.user;i.firstName=t.firstName,i.lastName=t.lastName,i.email=t.email}else i.name=t;const n=new re(i).toGuidedTourUrl();setTimeout((()=>{window.location.href=n}),1e3)}else ki.send({type:si})}))}}Qr.meta={selector:"[agora-component]",hosts:{host:ae},template:`\n\t<div class="page page--agora">\n\t\t${f}\n\t\t\x3c!-- Status Checklist --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'checklist'" [agora-checklist] (checked)="onChecked($event)"></div>\n\t\t\x3c!-- Status Link --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'link'" [agora-link] (link)="onLink($event)"></div>\n\t\t\x3c!-- Status Login --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'login'" [agora-login] (login)="onLogin($event)"></div>\n\t\t\x3c!-- Status Name --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'name' || (state.status == 'disconnected' && state.role === 'viewer')" [agora-name] (name)="onName($event)"></div>\n\t\t\x3c!-- Status Device --\x3e\n\t\t<div class="ui ui--info" *if="state.status == 'device' || (state.status == 'disconnected' && state.role !== 'viewer')" [agora-device] (enter)="onEnter($event)"></div>\n\t\t${T}\n\t\t\n\x3c!-- Smart Device --\x3e\n<div class="ui remotes" [class]="uiClass" *if="state.status == 'connected' && state.role == 'smart-device'">\n\t<div class="ui__body"></div>\n\t\x3c!-- remote sidebar --\x3e\n\t<div class="group--remote" [class]="'group--remote--' + remotes.length" *if="state.live">\n\t\t<div class="agora-stream" (toggleSpy)="onToggleSpy($event)" agora-stream [stream]="remote" type="remote" *for="let remote of remotes">\n\t\t\t<div class="agora-stream__player"></div>\n\t\t\t<div class="agora-stream__info">\n\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t\x3c!-- remote screen --\x3e\n\t<div class="group--remote-screen" *if="remoteScreen && !hasScreenViewItem">\n\t\t<div class="agora-stream" agora-stream [stream]="remoteScreen" type="remote">\n\t\t\t<div class="agora-stream__player"></div>\n\t\t\t<div class="agora-stream__info">\n\t\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="group--header">\n\t\t\n\x3c!-- local streams --\x3e\n<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t<div class="agora-stream" agora-stream [stream]="local" type="local" *if="local">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info">\n\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t</div>\n\t</div>\n</div>\n\n\t</div>\n\t<div class="group--footer">\n\t\t\n\x3c!-- controls --\x3e\n<div class="group--controls" *if="state.live">\n\t<div class="group--actions">\n\t\t<button type="button" class="btn--call" [title]="'title_disconnect' | label" (click)="disconnect()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--cam" [title]="'title_mute_camera' | label" [class]="{ muted: state.cameraMuted, disabled: !local }" (click)="toggleCamera()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--mic" [title]="'title_mute_mic' | label" [class]="{ muted: state.audioMuted, disabled: !local || silenced }" (click)="toggleAudio()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic"></use></svg>\n\t\t</button>\n\t</div>\n</div>\n\n\t</div>\n\t\n\x3c!-- members --\x3e\n<div class="group--members">\n\t<div class="members" *if="state.role === 'publisher'">\n\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t</div>\n\t<div class="credits">\n\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t</div>\n</div>\n\n</div>\n\n\t\t${b}\n\t\t${y}\n\t\t<header>\n\t\t\t${v}\n\t\t\t${S}\n\t\t</header>\n\t\t<footer *if="state.status != 'connected'">\n\t\t\t<span class="group--colophon">\n\t\t\t\t${_}\n\t\t\t\t${E}\n\t\t\t</span>\n\t\t\t<a [routerLink]="':lang.editor' | route" class="btn--absolute" *if="('editor' | flag) && !('deployed' | flag) && state.role == 'publisher' && (state.status == 'checklist' || state.status == 'link')">\n\t\t\t\t<span [innerHTML]="'bhere_editor' | label"></span> <svg class="edit" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#edit"></use></svg>\n\t\t\t</a>\n\t\t</footer>\n\t</div>\n\t`};class ta{static assetCreate$(t){return yi.post$("/api/asset",t).pipe(n.map((t=>hs(t))))}static assetUpdate$(t){return yi.put$(`/api/asset/${t.id}`,t).pipe(n.map((t=>hs(t))))}static assetDelete$(t){return t&&t.id?yi.delete$(`/api/asset/${t.id}`).pipe(n.map((()=>null))):i.of(null)}static localizedAssetCreate$(t,e){return yi.post$(`/api/${t}/asset`,e).pipe(n.map((t=>hs(t))))}static localizedAssetUpdate$(t,e){return yi.put$(`/api/${t}/asset/${e.id}`,e).pipe(n.map((t=>hs(t))))}static upload$(t){const e=new FormData;t.forEach((t=>e.append("file",t,t.name)));const s=new XMLHttpRequest,o=i.merge(i.fromEvent(s.upload,"loadstart"),i.fromEvent(s.upload,"progress"),i.fromEvent(s.upload,"load"),i.fromEvent(s,"readystatechange")).pipe(n.map((t=>"readystatechange"===t.type&&4===s.readyState?JSON.parse(s.responseText):null)),n.filter((t=>null!==t)));return s.open("POST","/api/upload/",!0),s.send(e),o}static createOrUpdateAsset$(t,e){const i=t[0],n=ls.fromUrl(i.url);return e.value&&e.value.id?(n.id=e.value.id,ta.assetUpdate$(n)):ta.assetCreate$(n)}static createOrUpdateLocalizedAsset$(t,e,i){const n=t[0],s=ls.fromUrl(n.url);return e.value&&e.value.id?(s.id=e.value.id,ta.localizedAssetUpdate$(i,s)):ta.localizedAssetCreate$(i,s)}static assetDidChange(t,e){let i=null,n=null,s=null,o=null;return t&&(i=t.id,n=t.file),e&&(s=e.id,o=e.file),i!==s||n!==o}}class ea{static data$(){return this.data$_||(this.data$_=yi.get$("/api/view").pipe(n.map((t=>(t.views=t.views.map((t=>In(t))),t))),n.shareReplay(1))),this.data$_}static viewIdOptions$(){return this.data$().pipe(n.map((t=>{const e=t.views.filter((t=>t.type.name!==fn.WaitingRoom.name)).map((t=>({id:t.id,name:t.name})));return e.unshift({id:null,name:"select"}),e})))}static viewCreate$(t){return yi.post$("/api/view",t).pipe(n.map((t=>In(t))))}static viewUpdate$(t){return yi.put$(`/api/view/${t.id}`,t.payload).pipe(n.map((t=>In(t))))}static viewDelete$(t){return yi.delete$(`/api/view/${t.id}`)}static getTile(t){let e;return t.type.name===fn.PanoramaGrid.name&&(e=t.tiles[t.index]),e}static inferItemCreate$(t,e){const i=this.getTile(t);return i?this.tileItemCreate$(t,i,e):this.itemCreate$(t,e)}static inferItemUpdate$(t,e){const i=this.getTile(t);return i?this.tileItemUpdate$(t,i,e):this.itemUpdate$(t,e)}static inferItemDelete$(t,e){const i=this.getTile(t);return i?this.tileItemDelete$(t,i,e):this.itemDelete$(t,e)}static inferItemUpdateResult$(t,e){const i=this.getTile(t);let n;n=i?i.navs.find((t=>t.id===e.id)):t.items.find((t=>t.id===e.id)),n&&Object.assign(n,e)}static inferItemDeleteResult$(t,e){const i=this.getTile(t);let n;if(n=i?i.navs:t.items,n){const s=n.indexOf(e);-1!==s&&n.splice(s,1),i&&t.updateCurrentItems()}}static itemCreate$(t,e){return yi.post$(`/api/view/${t.id}/item`,e).pipe(n.map((t=>An(t))))}static itemUpdate$(t,e){return yi.put$(`/api/view/${t.id}/item/${e.id}`,e.payload).pipe(n.map((t=>An(t))))}static itemDelete$(t,e){return yi.delete$(`/api/view/${t.id}/item/${e.id}`)}static tileItemCreate$(t,e,i){return yi.post$(`/api/view/${t.id}/tile/${e.id}/item`,i).pipe(n.map((t=>An(t))))}static tileItemUpdate$(t,e,i){return yi.put$(`/api/view/${t.id}/tile/${e.id}/item/${i.id}`,i.payload).pipe(n.map((t=>An(t))))}static tileItemDelete$(t,e,i){return yi.delete$(`/api/view/${t.id}/tile/${e.id}/item/${i.id}`)}}class ia extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Zn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(20),t.position.copy(i),t.lookAt(Cs.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object,i=this.form=new e.FormGroup({type:vn.CurvedPlane,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl(t.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([1,1,1],e.RequiredValidator()),radius:new e.FormControl(35,e.RequiredValidator()),height:new e.FormControl(20,e.RequiredValidator()),arc:new e.FormControl(90,e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){const t=Object.assign({},this.form.value);ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>console.log("CurvedPlaneModalComponent.onSubmit.error",t)))}else this.form.touched=!0}onClose(){an.reject()}}ia.meta={selector:"[curved-plane-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Curved Plane.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t\x3c!-- <div control-text [control]="controls.title" label="Title"></div> --\x3e\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t\x3c!--\n\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-number [control]="controls.radius" label="Radius" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-number [control]="controls.height" label="Height" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-number [control]="controls.arc" label="Arc" [precision]="0" [disabled]="true"></div>\n\t\t\t\t\t\t--\x3e\n\t\t\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ia.chunk=()=>'<div class="curved-plane-modal" curved-plane-modal></div>';class na extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Zn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(4),t.position.copy(i),t.lookAt(Cs.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object,i=this.form=new e.FormGroup({type:vn.Model,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl([0,0,0],e.RequiredValidator()),scale:new e.FormControl([1,1,1],e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){const t=Object.assign({},this.form.value);ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>console.log("ItemModelModalComponent.onSubmit.error",t)))}else this.form.touched=!0}onClose(){an.reject()}}na.meta={selector:"[item-model-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Model Item.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},na.chunk=()=>'<div class="item-model-modal" item-model-modal></div>';class sa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:fn.Media,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.switchMap((e=>{const i={type:vn.Plane,position:[20,0,0],rotation:[0,-Math.PI/2,0],scale:[12,6.75,1],asset:t.asset};return ea.itemCreate$(e,i).pipe(n.map((t=>(e.items=[t],e))))})),n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("MediaModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}sa.meta={selector:"[media-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Media.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},sa.chunk=()=>'<div class="media-modal" media-modal></div>';class oa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:fn.Model,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator()),model:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.switchMap((e=>{const i={type:vn.Model,asset:t.model};return ea.itemCreate$(e,i).pipe(n.map((t=>(e.items=[t],e))))})),n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("ModelModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}oa.meta={selector:"[model-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Model View.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t\t\t<div control-model [control]="controls.model" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},oa.chunk=()=>'<div class="model-modal" model-modal></div>';class ra extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Zn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get position(){let t=null;const e=this.data;return e&&(t=e.hit.position),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(Zr.RADIUS),t.position.copy(i),t.lookAt(Cs.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object;this.error=null,this.useHooks=Ii.enabled;const i=this.form=new e.FormGroup({type:vn.Nav,title:null,abstract:null,viewId:null,hook:null,hookExtra:null,keepOrientation:!1,important:!1,transparent:!1,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl(t.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([20,5,1],e.RequiredValidator()),asset:null,link:new e.FormGroup({title:new e.FormControl(null),href:new e.FormControl(null),target:"_blank"})});if(this.controls=i.controls,Ii.enabled){const t=x.webhook.methods.nav.map((t=>({id:t,name:t})));t.unshift({id:null,name:"select"}),this.controls.hook.options=t}i.changes$.subscribe((t=>{this.pushChanges()})),ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{this.controls.viewId.options=t,this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=Object.assign({},this.form.value);t.viewId=t.viewId?parseInt(t.viewId):this.view.id,!t.link||t.link.title&&t.link.href||(t.link=null),ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("NavModalComponent.onSubmit.error",t),this.error=t,this.form.submitted=!1}))}else this.form.touched=!0}onViewIdDidChange(t){if(null!=t&&x.flags.navAutoUpdateTitle){const e=this.controls.viewId.options,i=e.find((e=>e.id===t));if(null!=i){const t=i.name,n=this.form.value.title;n&&!e.find((t=>t.name===n))||this.form.patch({title:t})}}}onClose(){an.reject()}}ra.meta={selector:"[nav-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Nav.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.title" label="Title"></div>\n\t\t\t\t\t\t<div control-textarea [control]="controls.abstract" label="Abstract"></div>\n\t\t\t\t\t\t<div control-custom-select [control]="controls.viewId" label="NavToView" (change)="onViewIdDidChange($event)"></div>\n\t\t\t\t\t\t<div control-checkbox [control]="controls.keepOrientation" label="Keep Orientation"></div>\n\t\t\t\t\t\t<div control-checkbox [control]="controls.important" label="Important"></div>\n\t\t\t\t\t\t<div control-checkbox [control]="controls.transparent" label="Transparent"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="3" [disabled]="true"></div>\n\t\t\t\t\t\t<div *if="controls.transparent.value == true">\n\t\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/png, image/jpeg"></div>\n\t\t\t\t\t\t<div control-text [control]="controls.link.controls.title" label="Link Title"></div>\n\t\t\t\t\t\t<div control-text [control]="controls.link.controls.href" label="Link Url"></div>\n\t\t\t\t\t\t<div control-custom-select [control]="controls.hook" label="Hook" *if="useHooks"></div>\n\t\t\t\t\t\t<div control-text [control]="controls.hookExtra" label="Hook Extra" *if="useHooks"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ra.chunk=()=>'<div class="nav-modal" nav-modal></div>';class aa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:fn.PanoramaGrid,name:new e.FormControl(null,e.RequiredValidator()),assets:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value.assets,e=Sn.mapTiles(t.map((t=>({asset:t,navs:[]}))),!1,!0);e.sort(((t,e)=>1e4*t.indices.x+t.indices.y-(1e4*e.indices.x+e.indices.y)));const i=e[0].asset,s={type:this.form.value.type,name:this.form.value.name,asset:i,tiles:e,invertAxes:!0,flipAxes:!1,orientation:{latitude:0,longitude:0},zoom:75};ea.viewCreate$(s).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PanoramaGridModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}else this.form.touched=!0}onClose(){an.reject()}}aa.meta={selector:"[panorama-grid-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Panorama Grid.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-assets [control]="controls.assets" label="Image" accept="image/jpeg"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},aa.chunk=()=>'<div class="panorama-grid-modal" panorama-grid-modal></div>';class ca extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:fn.Panorama,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PanoramaModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}ca.meta={selector:"[panorama-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Panorama.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t\x3c!--\n\t\t\t\t\t<div class="group--form group--form--fixed">\n\t\t\t\t\t\t<code [innerHTML]="form.value | json"></code>\n\t\t\t\t\t\t<button type="button" class="btn--test" (click)="test()"><span>test</span></button>\n\t\t\t\t\t</div>\n\t\t\t\t\t--\x3e\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ca.chunk=()=>'<div class="panorama-modal" panorama-modal></div>';class da extends t.Component{onInit(){const{parentInstance:i}=t.getContext(this);i instanceof Zn&&(this.data=i.modal.data),this.error=null;const n=this.form=new e.FormGroup({name:new e.FormControl(null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t={name:this.form.value.name,items:this.data?this.data.item.items:[]};return Dn.pathCreate$(t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PathAddModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}da.meta={selector:"[path-add-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Add Path.</div>\n\t\t\t\t<div class="description">Aggiungi un percorso</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},da.chunk=()=>'<div class="panorama-modal" path-add-modal></div>';class la extends t.Component{onInit(){this.item=null,this.views=null;const{parentInstance:i}=t.getContext(this);if(i instanceof Zn){const t=i.modal.data;t&&(this.item=t.item?t.item:null,this.views=this.parseViews(t.views,this.item))}this.error=null;const n=this.form=new e.FormGroup({name:new e.FormControl(this.item?this.item.name:null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((t=>{this.pushChanges()}))}parseViews(t,e){return t&&e?t.map((t=>({id:t.id,name:t.name,type:t.type,active:-1===e.items.indexOf(t.id)}))):[]}onToggleView(t){t.active=!t.active,this.pushChanges()}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={id:this.item.id,name:t.name,items:this.views.filter((t=>!t.active)).map((t=>t.id))};return Dn.pathUpdate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PathEditModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onSelectAll(){this.views.forEach((t=>t.active=!0)),this.pushChanges()}onSelectNone(){this.views.forEach((t=>t.active=!1)),this.pushChanges()}onClose(){an.reject()}}la.meta={selector:"[path-edit-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Edit Path <span *if="item">&ldquo;<span [innerHTML]="item.title || item.name"></span>&rdquo;</span>.</div>\n\t\t\t\t<div class="description">Modifica il percorso</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ul class="nav--flag" *if="views">\n\t\t\t\t\t\t<li class="nav__item" *for="let view of views">\n\t\t\t\t\t\t\t<button type="button" class="btn--flag" [class]="{ active: view.active }" [title]="view.name" (click)="onToggleView(view)">\n\t\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t\t<svg-icon [name]="view.type.name"></svg-icon>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<span class="name" [innerHTML]="view.name"></span>\n\t\t\t\t\t\t\t\t<span class="flag">\n\t\t\t\t\t\t\t\t\t<svg class="check" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#check"></use></svg>\n\t\t\t\t\t\t\t\t\t<svg class="close" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<div class="group--options">\n\t\t\t\t\t\t\t<button type="button" class="btn--link" (click)="onSelectAll()">\n\t\t\t\t\t\t\t\t<span>Select all</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="btn--link" (click)="onSelectNone()">\n\t\t\t\t\t\t\t\t<span>Select none</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Save</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},la.chunk=()=>'<div class="path-edit-modal" path-edit-modal></div>';class ha extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Zn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(20),t.position.copy(i),t.lookAt(Cs.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object,i=this.form=new e.FormGroup({type:vn.Plane,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl(t.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([12,6.75,1],e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){const t=Object.assign({},this.form.value);ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>console.log("PlaneModalComponent.onSubmit.error",t)))}else this.form.touched=!0}onClose(){an.reject()}}ha.meta={selector:"[plane-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Plane.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t\x3c!-- <div control-text [control]="controls.title" label="Title"></div> --\x3e\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ha.chunk=()=>'<div class="plane-modal" plane-modal></div>';class ua extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Zn&&(e=i.modal.data),e}get item(){let t=null;const e=this.data;return e&&(t=e.item),t}onRemove(){an.resolve()}onCancel(){an.reject()}onClose(){an.reject()}}ua.meta={selector:"[remove-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Remove <span *if="item">&ldquo;<span [innerHTML]="item.title || item.name"></span>&rdquo;</span>.</div>\n\t\t\t\t<div class="abstract">are you sure?</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t\t<span>Remove</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onCancel($event)">\n\t\t\t\t\t\t<span>Cancel</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},ua.chunk=()=>'<div class="remove-modal" remove-modal></div>';class pa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:fn.Room3d,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("Room3DModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}pa.meta={selector:"[room-3d-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Room 3D View.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t\x3c!--\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t\t\t<div control-model [control]="controls.model" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t\t--\x3e\n\t\t\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},pa.chunk=()=>'<div class="room-3d-modal" room-3d-modal></div>';const ma={menu:[{id:"menu",title:"editor_menu",active:!0},{id:"navmaps",title:"editor_navmaps",active:!0}],current:null,active:!1};class ga extends t.Component{get dataViews(){return ps.dataViews}get pathViews(){return ps.pathViews}onInit(){const{node:e}=t.getContext(this);e.classList.remove("hidden"),this.settings=this.getSettings(),this.aside=!1,this.state={},this.view=null,this.paths=null,this.path=null,this.form=null,this.local=null,this.remotes=[],this.viewHit=new i.Subject;(this.vrService=Ro.getService()).status$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.pushChanges())),this.resolveUser()}resolveUser(){Ci.me$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t&&t.type===ie.Publisher?(this.user=t,this.initState()):te.setRouterLink(_e.transform(":lang.access"))}))}initState(){const t=this.user,e={user:t,role:t.type,name:t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:null,mode:di,link:null,channelName:x.channelName,uid:null,status:Oe,connecting:!1,connected:!0,controlling:!1,spying:!1,silencing:!1,hosted:!0,live:!1,navigable:!0,cameraMuted:!1,audioMuted:!1,showNavInfo:!0};ee.state=e,ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.hosted=t.hosted,this.pushChanges()})),this.viewObserver$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{})),Zi.mode=Xi}viewObserver$(){return ea.data$().pipe(n.switchMap((t=>{const e=(new re).pathId;return Dn.getCurrentPath$(e).pipe(n.switchMap((e=>(this.paths=Dn.paths,this.path=e,ps.editorView$(t,e)))))})),n.tap((t=>{this.view=null,this.pushChanges()})),n.delay(1),n.tap((t=>{this.view=t,this.pushChanges()})))}onAddPath(){an.open$({template:da.chunk()}).pipe(n.first()).subscribe((t=>{t instanceof on&&Dn.addPath(t.data)}))}onEditPath(t){an.open$({template:la.chunk(),data:{item:t,views:ps.validViews}}).pipe(n.first()).subscribe((t=>{t instanceof on&&Dn.editPath(t.data)}))}onDuplicatePath(t){an.open$({template:da.chunk(),data:{item:t}}).pipe(n.first()).subscribe((t=>{t instanceof on&&Dn.addPath(t.data)}))}onDeletePath(t){an.open$({template:ua.chunk(),data:{item:t}}).pipe(n.first()).subscribe((e=>{e instanceof on&&Dn.pathDelete$(t).pipe(n.first()).subscribe((e=>{Dn.deletePath(t)}))}))}onSelectPath(t){Dn.path=t}isPathSelected(t){return Dn.path.id===t.id}onNavTo(t){const e=t.viewId;ps.pathViews.find((t=>t.id===e))&&(ps.action={viewId:e,keepOrientation:t.keepOrientation,useLastOrientation:t.useLastOrientation})}onNavLink(t){an.open$({iframe:t.link.href}).pipe(n.first()).subscribe((e=>{ki.send({type:He,itemId:t.item.id})}))}patchState(t){this.state=Object.assign({},this.state,t),this.pushChanges()}tryInAr(){an.open$({template:Qn.chunk(),data:this.view}).pipe(n.first()).subscribe((t=>{}))}onToggleAside(){this.aside=!this.aside,this.pushChanges(),window.dispatchEvent(new Event("resize"))}getSettings(){const t=Object.assign({},ma);return t.menu=t.menu.filter((t=>x.flags[t.id])),t.current=t.menu.length?t.menu[0].id:null,t}onToggleSettings(){const t=this.settings;t.active=!t.active,this.pushChanges()}onSelectSetting(t){this.settings.current=t.id,this.pushChanges()}onViewHit(t){this.viewHit.next(t)}onViewHitted(t){this.viewHitSubscription&&(this.viewHitSubscription.unsubscribe(),this.viewHitSubscription=null),"function"==typeof t&&(this.viewHitSubscription=this.viewHit.pipe(n.first()).subscribe((e=>t(e))))}onDragEnd(t){ea.inferItemUpdate$(this.view,t.item).pipe(n.first()).subscribe((t=>{this.pushChanges()}),(e=>console.log("EditorComponent.onDragEnd.inferItemUpdate$.error",e,this.view,t.item,t.item.payload)))}onResizeEnd(t){}onWorldSelect(t){if(this.view){let e;this.view.items.forEach((t=>t.showPanel=!1)),this.view.items.forEach((i=>{i.selected=i===t.item,e=i.selected?i:e})),this.view.selected=!e,this.pushChanges(),e&&(this.aside=!0,this.pushChanges(),window.dispatchEvent(new Event("resize")))}}onOpenModal(t,e){let i=null;switch(t.type){case"view":switch(t.value){case fn.Panorama.name:i=ca.chunk();break;case fn.PanoramaGrid.name:i=aa.chunk();break;case fn.Model.name:i=oa.chunk();break;case fn.Room3d.name:i=pa.chunk();break;case fn.Media.name:i=sa.chunk()}break;case"viewItem":switch(t.value){case vn.Nav.name:i=ra.chunk();break;case vn.Plane.name:i=ha.chunk();break;case vn.CurvedPlane.name:i=ia.chunk();break;case vn.Model.name:i=na.chunk()}}i&&an.open$({template:i,data:e}).pipe(n.first()).subscribe((e=>{if(e instanceof on)switch(t.type){case"view":switch(t.value){case fn.Panorama.name:case fn.PanoramaGrid.name:case fn.Model.name:case fn.Room3d.name:case fn.Media.name:ps.addView(e.data)}break;case"viewItem":switch(t.value){case vn.Nav.name:case vn.Plane.name:case vn.CurvedPlane.name:case vn.Model.name:{const t=e.data,i=ea.getTile(this.view);if(i){const e=i.navs||[];e.push(t),i.navs=e,this.view.updateCurrentItems()}else{t.path=!0;const e=this.view.items||[];e.push(t),this.view.items=e}this.pushChanges();break}}}this.pushChanges()}))}onAsideSelect(t){if(t.value)switch(t.value){case vn.Nav.name:case vn.Plane.name:case vn.CurvedPlane.name:this.onViewHitted((e=>{this.onOpenModal(t,{view:this.view,hit:e})})),Xn.open$({message:"Click a point on the view"});break;case vn.Model.name:if("viewItem"===t.type){if(this.view.type.name===fn.Model.name)return;this.onViewHitted((e=>{this.onOpenModal(t,{view:this.view,hit:e})})),Xn.open$({message:"Click a point on the view"})}else this.onOpenModal(t,{view:this.view});break;default:this.onOpenModal(t,{view:this.view})}else if(t.view&&(t.item||null===t.item))t.view.selected=!1,t.view.items.forEach((e=>e.selected=e===t.item)),ki.send({type:Ze}),this.pushChanges();else if(t.view&&(t.tile||null===t.tile))t.view.selected=!1,t.view.tiles.forEach((e=>e.selected=e===t.tile)),ki.send({type:Ze}),this.pushChanges();else if(t.view||null===t.view){this.view.selected=this.view===t.view,this.view.items.forEach((t=>t.selected=!1));const e=ea.getTile(this.view);e&&this.view.tiles.forEach((t=>t.selected=t===e)),ki.send({type:Ze}),this.pushChanges()}}onAsideUpdate(t){if(t.item&&t.view)this.pushChanges();else if(t.tile&&t.view);else if(t.view)if(ps.viewId!==t.view.id)ps.viewId=t.view.id;else{const e=ta.assetDidChange(this.view.asset,t.view.asset);Object.assign(this.view,t.view),e&&"function"==typeof this.view.onUpdateAsset&&this.view.onUpdateAsset(),this.pushChanges()}}onAsideDelete(t){t.item&&t.view?ea.inferItemDelete$(t.view,t.item).pipe(n.first()).subscribe((e=>{ea.inferItemDeleteResult$(t.view,t.item),this.pushChanges()}),(t=>console.log("EditorComponent.onAsideDelete.inferItemDelete$.error",t))):t.view&&ea.viewDelete$(t.view).pipe(n.first()).subscribe((e=>{ps.deleteView(t.view)}),(t=>console.log("EditorComponent.onAsideDelete.viewDelete$.error",t)))}}ga.meta={selector:"[editor-component]",hosts:{host:ae},template:'\n\t<div class="page page--editor">\n\t\t<div class="ui" [class]="{ open: aside }" *if="dataViews.length">\n\t\t\t<div class="ui__navbar">\n\t\t\t\t<div class="btn--settings" [class]="{ active: settings.active }" (click)="onToggleSettings($event)" *if="settings.menu.length > 0">\n\t\t\t\t\t<svg class="settings" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#settings-full"></use></svg>\n\t\t\t\t</div>\n\t\t\t\t<div class="headline" *if="view">\n\t\t\t\t\t<div class="headline__id" [innerHTML]="view.id"></div>\n\t\t\t\t\t<div class="headline__icon">\n\t\t\t\t\t\t<svg-icon [name]="view.type.name"></svg-icon>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="headline__name" [innerHTML]="view.name"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="group--path" *if="(\'usePaths\' | flag) && path">\n\t\t\t\t\t<div class="group--path__select">\n\t\t\t\t\t\t<div class="group--form--select" [dropdown]="\'path\'">\n\t\t\t\t\t\t\t<label>Percorso</label>\n\t\t\t\t\t\t\t<span class="control--custom-select" [innerHTML]="path.name"></span>\n\t\t\t\t\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="dropdown dropdown-item" [dropdown-item]="\'path\'">\n\t\t\t\t\t\t\t<div class="category">Percorso</div>\n\t\t\t\t\t\t\t<ul class="nav--dropdown">\n\t\t\t\t\t\t\t\t<li [class]="{ active: isPathSelected(item) }" *for="let item of paths">\n\t\t\t\t\t\t\t\t\t<span [innerHTML]="item.name" (click)="onSelectPath(item)"></span>\n\t\t\t\t\t\t\t\t\t<div class="check">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#check"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="btn--flags" (click)="onEditPath(item)" title="Edit" *if="item.id">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#flags"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="btn--duplicate" (click)="onDuplicatePath(item)" title="Duplicate" *if="item.id">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#duplicate"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="btn--trash" (click)="onDeletePath(item)" title="Delete" *if="item.id">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#trash"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t<div class="btn--mode" (click)="onAddPath()">Aggiungi un percorso</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="btn--edit" [class]="{ active: aside }" (click)="onToggleAside($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#edit"></use></svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world" world [view]="view" [views]="pathViews" [editor]="true" (navTo)="onNavTo($event)" (viewHit)="onViewHit($event)" (dragEnd)="onDragEnd($event)" (select)="onWorldSelect($event)"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- footer --\x3e\n\t\t\t<div class="group--footer">\n\t\t\t\t<div class="group--ar-vr">\n\t\t\t\t\t<button type="button" class="btn--ar" [href]="view?.ar" (click)="tryInAr()" *if="view?.ar">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#ar"></use></svg> <span>Try in AR</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--vr" [class]="{ disabled: vrService.isDisabled() }" (click)="vrService.toggleVR()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#vr"></use></svg> <span [innerHTML]="vrService.getLabel()"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui__settings" *if="settings.active">\n\t\t\t\t\x3c!-- settings navs --\x3e\n\t\t\t\t<div class="group--nav">\n\t\t\t\t\t<ul class="nav--menu">\n\t\t\t\t\t\t<li class="nav__item" *for="let item of settings.menu" [class]="{ active: settings.current === item.id }" (click)="onSelectSetting(item)"><span class="title" [innerHTML]="item.title | label"></span></li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- menu --\x3e\n\t\t\t\t<div class="group--content" menu-builder [views]="dataViews" *if="settings.current === \'menu\'"></div>\n\t\t\t\t\x3c!-- navmaps --\x3e\n\t\t\t\t<div class="group--content" navmap-builder [views]="dataViews" *if="settings.current === \'navmaps\'"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="aside" [class]="{ active: aside }" aside [view]="view" (select)="onAsideSelect($event)" (update)="onAsideUpdate($event)" (delete)="onAsideDelete($event)" *if="view && aside"></div>\n\t</div>\n\t'};class fa{static currentLanguagePage$(t){return ve.lang$.pipe(n.switchMap((e=>this.page$(e,t))))}static page$(t,e){const i=x.flags.production?`/api/${t}/pages/${e}/`:`./api/${t}/pages/${e}.json`;return yi.get$(i)}}class va extends t.Component{onInit(){this.route=this.host?this.host.route:null,this.state={status:"generic"},this.page=null,fa.currentLanguagePage$(this.route.params.mode).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.page=t,this.pushChanges()}))}}va.meta={selector:"[generic-component]",hosts:{host:ae},template:`\n\t\t<div class="page page--generic">\n\t\t\t\x3c!-- generic --\x3e\n\t\t\t<div class="ui ui--generic" *if="page">\n\t\t\t\t<div class="group--generic">\n\t\t\t\t\t<div class="group--generic__content stagger--childs">\n\t\t\t\t\t\t<h1 class="title" [innerHTML]="page.title"></h1>\n\t\t\t\t\t\t<div class="description" [innerHTML]="page.description"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<header>\n\t\t\t\t${v}\n\t\t\t\t${S}\n\t\t\t</header>\n\t\t\t<footer>\n\t\t\t\t<span class="group--colophon" *if="state.status != 'connected'">\n\t\t\t\t\t${_}\n\t\t\t\t\t${E}\n\t\t\t\t</span>\n\t\t\t</footer>\n\t\t</div>\n\t`};class _a extends t.Component{get meetingUrl(){return this.meetingUrl_||(this.meetingUrl_=new re),this.meetingUrl_}get isVirtualTourUser(){return-1!==[ie.Publisher,ie.Attendee,ie.Streamer,ie.Viewer].indexOf(this.state.role)}get isEmbed(){return this.route&&"embed"===this.route.params.mode}get isSelfServiceTour(){return this.route&&"selfServiceTour"===this.route.params.mode}get isNavigable(){return null==this.meetingUrl.embedViewId}get isBackButtonVisible(){return this.view&&(this.view.type.name===fn.Media.name||this.view.type.name===fn.Model.name)}get showNavInfoToggler(){return x.flags.hideNavInfo&&this.state.mode!==li}get uiClass(){const t={};return t[this.state.role]=!0,t.chat=this.state.chat,t.remotes=this.state.mode===li,t.remoteScreen=null!=this.remoteScreen&&!this.hasScreenViewItem,t.media=!t.remotes&&this.media,t.locked=this.locked,t}get remoteClass(){return`group--remote--${Math.min(9,this.remotes.length)}`}get controlled(){return this.state.controlling&&this.state.controlling!==this.state.uid}get controlling(){return this.state.controlling&&this.state.controlling===this.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return this.state.spying&&this.state.spying===this.state.uid}get spying(){return this.state.spying&&this.state.spying!==this.state.uid}get locked(){return this.controlled||this.spying}get remoteScreen(){return this.remoteScreen_}set remoteScreen(t){this.remoteScreen_!==t&&(this.remoteScreen_=t,window.dispatchEvent(new Event("resize")))}onInit(){const t=this.meetingUrl.embedViewId;this.state={status:fe.get("status")||Oe,role:fe.get("role")||ie.Publisher,membersCount:3,controlling:!1,spying:!1,silencing:!1,hosted:!0,chat:!1,chatDirty:!0,name:"Jhon Appleseed",uid:"7341614597544882",showNavInfo:!0},this.state.live=this.state.role!==ie.SelfService&&this.state.role!==ie.Embed&&!R,this.state.navigable=null==t,this.state.mode=Ci.getMode(this.state.role),this.view={likes:41,type:{id:2,name:"panorama"}},this.local={},this.screen=null,this.remoteScreen_=null,this.media=null,this.hasScreenViewItem=!1,this.media=!0,this.remotes=new Array(8).fill(0).map(((t,e)=>({id:e+1}))),this.languageService=ve,this.showLanguages=!1,ee.patchState(this.state),this.fullscreen$().pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.vrService=Ro.getService(),console.log("LayoutComponent",this),setTimeout((()=>{const t=$n;switch(t){case Gn:Xn.open$({message:ge.transform("bhere_support_request_sent")}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof Yn&&console.log("ToastResolveEvent",t)}));break;case Wn:Xn.open$({message:ge.transform("bhere_support_request_sent"),type:t,position:qn}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof Yn?console.log("ToastResolveEvent",t):t instanceof Jn&&console.log("ToastRejectEvent",t)}));break;case $n:Xn.open$({message:ge.transform("bhere_support_request_dialog"),acceptMessage:ge.transform("bhere_support_request_dialog_accept"),rejectMessage:ge.transform("bhere_support_request_dialog_reject"),type:t,position:qn}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof Yn?console.log("ToastResolveEvent",t):t instanceof Jn&&console.log("ToastRejectEvent",t)}))}}),3e3)}setLanguage(t){this.languageService.setLanguage$(t).pipe(n.first()).subscribe((t=>{this.showLanguages=!1,this.pushChanges()}))}toggleLanguages(){this.showLanguages=!this.showLanguages,this.pushChanges()}patchState(t){this.state=Object.assign({},this.state,t),this.screen=this.state.screen||null,this.remoteScreen=this.screen,this.pushChanges()}toggleCamera(){this.patchState({cameraMuted:!this.state.cameraMuted})}toggleAudio(){this.patchState({audioMuted:!this.state.audioMuted})}toggleScreen(){this.patchState({screen:!this.state.screen}),window.dispatchEvent(new Event("resize"))}toggleVolume(){this.patchState({volumeMuted:!this.state.volumeMuted})}toggleMode(){const t=this.state.mode===di?li:di;this.patchState({mode:t})}toggleFullScreen(){const{node:e}=t.getContext(this);!this.state.fullScreen?e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}fullscreen$(){return i.fromEvent(document,"fullscreenchange").pipe(n.tap((t=>{const e=null!=document.fullscreenElement;this.patchState({fullScreen:e})})))}toggleChat(){this.patchState({chat:!this.state.chat,chatDirty:!1}),window.dispatchEvent(new Event("resize"))}toggleNavInfo(){this.patchState({showNavInfo:!this.state.showNavInfo})}onBack(){console.log("LayoutComponent.onBack")}onChatClose(){this.patchState({chat:!1}),window.dispatchEvent(new Event("resize"))}onToggleControl(t){const e=this.state.controlling===t?null:t;this.patchState({controlling:e,spying:!1})}onToggleSilence(){this.patchState({silencing:!this.state.silencing})}onToggleSpy(t){const e=this.state.spying===t?null:t;this.patchState({spying:e,controlling:!1})}addLike(){this.view.liked=!0,this.showLove(this.view)}showLove(t){if(t&&this.view.id===t.id){const e=this.view.showLove;this.view.likes=t.likes,this.view.showLove=!0,this.pushChanges(),e||setTimeout((()=>{this.view.showLove=!1,this.pushChanges()}),3100)}}disconnect(){}}_a.meta={selector:"[layout-component]",hosts:{host:ae},template:`\n\t<div class="page page--agora">\n\t\t${f}\n\t\t\x3c!-- Status Checklist --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'checklist'" [agora-checklist] (checked)="onChecked($event)"></div>\n\t\t\x3c!-- Status Link --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'link'" [agora-link] (link)="onLink($event)"></div>\n\t\t\x3c!-- Status Login --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'login'" [agora-login] (login)="onLogin($event)"></div>\n\t\t\x3c!-- Status Name --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'name' || (state.status == 'disconnected' && state.role === 'viewer')" [agora-name] (name)="onName($event)"></div>\n\t\t\x3c!-- Status Device --\x3e\n\t\t<div class="ui ui--info" *if="state.status == 'device' || (state.status == 'disconnected' && state.role !== 'viewer')" [agora-device] (enter)="onEnter($event)"></div>\n\t\t\x3c!-- Virtual Tour --\x3e\n\t\t<div class="ui virtual-tour" [class]="uiClass" *if="state.status == 'connected' && isVirtualTourUser">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- remote sidebar --\x3e\n\t\t\t<div class="group--remote" [class]="remoteClass" *if="state.live">\n\t\t\t\t<div class="agora-stream" *for="let remote of remotes">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info" [class]="{ spyed: state.spying == remote.streamId, controlling: state.controlling == remote.streamId }">\n\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t\t<button type="button" class="btn--control" [title]="'title_control' | label" (click)="onToggleControl(remote.streamId)" *if="state.role === 'publisher'">\n\t\t\t\t\t\t\t<svg class="control" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button type="button" class="btn--spy" [title]="'title_spy' | label" (click)="onToggleSpy(remote.streamId)" *if="state.role === 'publisher'">\n\t\t\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#spy"></use></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="group--members" *if="state.mode == 'virtual-tour'">\n\t\t\t\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="credits">\n\t\t\t\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- remote screen --\x3e\n\t\t\t<div class="group--remote-screen" *if="remoteScreen">\n\t\t\t\t<div class="agora-stream">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--header">\n\t\t\t\t\x3c!-- service --\x3e\n\t\t\t\t<div class="group--service">\n\t\t\t\t\t<button type="button" class="btn--back" [title]="'title_back' | label" (click)="onBack($event)" *if="isBackButtonVisible">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--view-mode" [title]="'title_view_mode' | label" (click)="toggleMode($event)" *if="state.mode != 'embed'">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == 'virtual-tour'"><use xlink:href="#live-meeting"></use></svg>\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == 'live-meeting'"><use xlink:href="#virtual-tour"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--volume" [title]="'title_volume' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--fullscreen" [title]="'title_fullscreen' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--navmap" [title]="'title_navmap' | label" [class]="{ active: state.showNavmap }" (click)="toggleNavmap($event)" *if="navmap && state.mode != 'live-meeting'">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navmap"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- local streams --\x3e\n\t\t\t\t<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t\t\t\t\t<button type="button" class="btn--silence" [title]="'title_silence' | label" [class]="{ active: state.silencing }" (click)="onToggleSilence()" *if="state.role === 'publisher'">\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--control" [title]="'title_control' | label" [class]="{ active: state.controlling == state.uid }" (click)="onToggleControl(state.uid)" *if="state.role == 'publisher'">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<div class="agora-stream" *if="!local"></div>\n\t\t\t\t\t<div class="agora-stream" *if="local">\n\t\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="agora-stream agora-stream--screen" *if="screen">\n\t\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--footer">\n\t\t\t\t${d}\n\t\t\t\t${l}\n\t\t\t\t${h}\n\t\t\t\t${u}\n\t\t\t</div>\n\t\t\t\x3c!-- members --\x3e\n\t\t\t<div class="group--members" *if="state.mode == 'live-meeting'">\n\t\t\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="credits">\n\t\t\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t${p}\n\t\t\t${m}\n\t\t\t${g}\n\t\t</div>\n\t\t\x3c!-- Smart Device --\x3e\n\t\t<div class="ui remotes" [class]="uiClass" *if="state.status == 'connected' && state.role == 'smart-device'">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t</div>\n\t\t\t\x3c!-- remote sidebar --\x3e\n\t\t\t<div class="group--remote" [class]="remoteClass" *if="state.live">\n\t\t\t\t<div class="agora-stream" *for="let remote of remotes">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t\t<button type="button" class="btn--spy" [title]="'title_spy' | label" *if="state.role === 'publisher'" (click)="onToggleSpy(remote.streamId)">\n\t\t\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#spy"></use></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- remote screen --\x3e\n\t\t\t<div class="group--remote-screen" *if="remoteScreen">\n\t\t\t\t<div class="agora-stream">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- local streams --\x3e\n\t\t\t<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t\t\t\t<div class="agora-stream" *if="local">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- controls --\x3e\n\t\t\t<div class="group--controls" *if="state.live">\n\t\t\t\t<div class="group--actions">\n\t\t\t\t\t<button type="button" class="btn--call" [title]="'title_disconnect' | label" (click)="disconnect()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--cam" [title]="'title_mute_camera' | label" [class]="{ muted: state.cameraMuted, disabled: !local }" (click)="toggleCamera()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--mic" [title]="'title_mute_mic' | label" [class]="{ muted: state.audioMuted, disabled: !local || silenced }" (click)="toggleAudio()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--screen" [title]="'title_share_screen' | label" [class]="{ active: screen }" (click)="toggleScreen()" *if="('screenShare' | flag) && (state.role == 'publisher' || state.role == 'attendee' || controlling)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#screen"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--chat" [title]="'title_chat' | label" [class]="{ active: state.chatDirty }" (click)="toggleChat()" *if="('chat' | flag)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#chat"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--navinfo" [title]="'title_navinfo' | label" [class]="{ active: state.showNavInfo }" (click)="toggleNavInfo()" *if="showNavInfoToggler">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navinfo"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- members --\x3e\n\t\t\t<div class="group--members">\n\t\t\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="credits">\n\t\t\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t\x3c!-- Self Service Tour --\x3e\n\t\t<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'self-service-tour'">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- service --\x3e\n\t\t\t<div class="group--service">\n\t\t\t\t<button type="button" class="btn--volume" [title]="'title_volume' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--fullscreen" [title]="'title_fullscreen' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t${h}\n\t\t\t${u}\n\t\t</div>\n\t\t\x3c!-- Embed --\x3e\n\t\t<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'embed'">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- service --\x3e\n\t\t\t<div class="group--service">\n\t\t\t\t<button type="button" class="btn--volume" [title]="'title_volume' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--fullscreen" [title]="'title_fullscreen' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t${h}\n\t\t\t${u}\n\t\t</div>\n\t\t<a class="btn--logo" [routerLink]="':lang.access' | route" *if="state.status != 'connected'">\n\t\t\t<img [src]="'logo' | env" *if="'logo' | env" />\n\t\t\t<svg viewBox="0 0 270 98" *if="!('logo' | env)"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener" *if="state.status != 'connected'">\n\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t\t<div class="group--language" language *if="state.status != 'connected'"></div>\n\t</div>\n\t`};class Ea extends t.Component{get viewId(){const t=this.route?this.route.params.viewId:void 0;return t?parseInt(t):null}onInit(){this.platform=ji.platform,this.route=this.host?this.host.route:null,this.missingAr=!1,this.missingUsdz=!1,this.missingGltf=!1;const e=this.viewId;e&&ps.viewById$(e).pipe(n.first()).subscribe((e=>{if(!e.ar)return this.missingAr=!0,void this.pushChanges();if(this.platform===Ui){const t=this.getUsdzSrc(e);t?window.location.href=t:(this.missingUsdz=!0,this.pushChanges())}else if(null!==this.getGltfSrc(e)){const i=this.getModelViewerNode(e),{node:n}=t.getContext(this);n.appendChild(i),this.addARScripts()}else this.missingGltf=!0,this.pushChanges()}))}addARScripts(){let t=document.createElement("script");t.setAttribute("type","module"),t.setAttribute("src","https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"),document.head.appendChild(t),t=document.createElement("script"),t.setAttribute("nomodule",""),t.setAttribute("src","https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"),document.head.appendChild(t)}getUsdzSrc(t){return t.ar&&t.ar.usdz?x.getPath(t.ar.usdz.folder+t.ar.usdz.file):null}getGltfSrc(t){return t.ar&&t.ar.gltf?x.getPath(t.ar.gltf.folder+t.ar.gltf.file):null}getViewId(){const t=new re;let e=null;return t.viewId&&(e=parseInt(t.viewId)),e}getModelViewerNode(t){const e=x.getPath(x.textures.envMap),i=x.getPath(t.asset.folder+t.asset.file),n=this.getUsdzSrc(t),s=this.getGltfSrc(t),o=`\n\t\t\t<model-viewer alt="${t.name}" environment-image="${e}" skybox-image="${i}" ios-src="${n}" src="${s}" ar ar-modes="webxr scene-viewer quick-look" ar-scale="auto" camera-controls></model-viewer>\n\t\t`,r=document.createElement("div");r.innerHTML=o;return r.firstElementChild}}Ea.meta={selector:"[try-in-ar]",hosts:{host:ae},template:'\n\t\t<div class="page page--try-in-ar">\n\t\t\t\x3c!--\n\t\t\t<div *if="platform != \'ios\'">\n\t\t\t\t<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"><\/script>\n\t\t\t\t<script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"><\/script>\n\t\t\t</div>\n\t\t\t--\x3e\n\t\t\t<div class="ui" *if="!viewId">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Not found.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui" *if="missingAr">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Missing AR in view.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui" *if="missingUsdz">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Missing .usdz in ar.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui" *if="missingGltf">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Missing .gltf in ar.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},console.log("environment.defaultLanguage",x.defaultLanguage);class Sa extends t.Component{onInit(){const e=[{name:"index",path:"/",forwardTo:x.defaultLanguage||"it"},{name:"it",path:"/it",defaultParams:{lang:"it",mode:"access"},factory:Ai},{name:"it.access",path:"/accesso",defaultParams:{lang:"it",mode:"access"},factory:Ai},{name:"it.accessCode",path:"/codice-di-accesso?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"it",mode:"accessCode"},factory:ce},{name:"it.guidedTour",path:"/tour-guidato?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"it",mode:"guidedTour"},factory:Qr},{name:"it.selfServiceTour",path:"/tour-self-service?:p&:viewId&:pathId",defaultParams:{lang:"it",mode:"selfServiceTour"},factory:Qr},{name:"it.embed",path:"/embed",defaultParams:{lang:"it",mode:"embed"},factory:Qr},{name:"it.tryInAr",path:"/prova-in-ar?:p&:viewId",defaultParams:{lang:"it",mode:"tryInAr"},factory:Ea},{name:"it.editor",path:"/editor?:p&:viewId",defaultParams:{lang:"it",mode:"editor"},factory:ga},{name:"it.layout",path:"/layout",defaultParams:{lang:"it",mode:"layout"},factory:_a},{name:"it.privacy",path:"/informativa-sulla-privacy",defaultParams:{lang:"it",mode:"privacy_policy"},factory:va},{name:"it.terms",path:"/termini-di-utilizzo",defaultParams:{lang:"it",mode:"terms"},factory:va},{name:"en",path:"/en",defaultParams:{lang:"en",mode:"access"},factory:Ai},{name:"en.access",path:"/access",defaultParams:{lang:"en",mode:"access"},factory:Ai},{name:"en.accessCode",path:"/accesso-code?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"en",mode:"accessCode"},factory:ce},{name:"en.guidedTour",path:"/guided-tour?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"en",mode:"guidedTour"},factory:Qr},{name:"en.selfServiceTour",path:"/self-service-tour?:p&:viewId&:pathId",defaultParams:{lang:"en",mode:"selfServiceTour"},factory:Qr},{name:"en.embed",path:"/embed",defaultParams:{lang:"en",mode:"embed"},factory:Qr},{name:"en.tryInAr",path:"/try-in-ar?:p&:viewId",defaultParams:{lang:"en",mode:"tryInAr"},factory:Ea},{name:"en.editor",path:"/editor?:p&:viewId",defaultParams:{lang:"en",mode:"editor"},factory:ga},{name:"en.layout",path:"/layout",defaultParams:{lang:"en",mode:"layout"},factory:_a},{name:"en.privacy",path:"/privacy-policy",defaultParams:{lang:"en",mode:"privacy_policy"},factory:va},{name:"en.terms",path:"/terms-of-service",defaultParams:{lang:"en",mode:"terms"},factory:va}];te.useBrowser(e),x.flags.editorAssetScreen&&(ss.PublisherScreen={id:5,name:"PublisherScreen",ids:[6]},ss.AttendeeScreen={id:6,name:"AttendeeScreen",ids:[7]}),ss.SmartDevice={id:7,name:"Smart Device",ids:[8]},te.event$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{const i=t.route;i&&"embed"===i.params.mode&&(x.flags.like=!1),ve.setRoute(i,e)})),ve.lang$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()}));const{node:i}=t.getContext(this);i.classList.remove("hidden")}}Sa.meta={selector:"[b-here-component]",template:'\n\t\t\x3c!-- svg --\x3e\n\t\t\n\t\t<svg width="0" height="0" class="hidden" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true">\n\t\t\t<symbol id="arrow-down" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 7.33l2.829-2.83 9.175 9.339 9.167-9.339 2.829 2.83-11.996 12.17z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="arrow-next" viewBox="0 0 24 24">\n\t\t\t\t<path d="M7.33 24l-2.83-2.829 9.339-9.175-9.339-9.167 2.83-2.829 12.17 11.996z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="arrow-prev" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16.67 0l2.83 2.829-9.339 9.175 9.339 9.167-2.83 2.829-12.17-11.996z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="call" viewBox="0 0 24 24">\n\t\t\t\t<path d="M20 22.621l-3.521-6.795c-.008.004-1.974.97-2.064 1.011-2.24 1.086-6.799-7.82-4.609-8.994l2.083-1.026-3.493-6.817-2.106 1.039c-7.202 3.755 4.233 25.982 11.6 22.615.121-.055 2.102-1.029 2.11-1.033z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="heart" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 4.435c-1.989-5.399-12-4.597-12 3.568 0 4.068 3.06 9.481 12 14.997 8.94-5.516 12-10.929 12-14.997 0-8.118-10-8.999-12-3.568z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="heart-outline" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 9.229c.234-1.12 1.547-6.229 5.382-6.229 2.22 0 4.618 1.551 4.618 5.003 0 3.907-3.627 8.47-10 12.629-6.373-4.159-10-8.722-10-12.629 0-3.484 2.369-5.005 4.577-5.005 3.923 0 5.145 5.126 5.423 6.231zm-12-1.226c0 4.068 3.06 9.481 12 14.997 8.94-5.516 12-10.929 12-14.997 0-7.962-9.648-9.028-12-3.737-2.338-5.262-12-4.27-12 3.737z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="cam" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16 18c0 1.104-.896 2-2 2h-12c-1.105 0-2-.896-2-2v-12c0-1.104.895-2 2-2h12c1.104 0 2 .896 2 2v12zm8-14l-6 6.223v3.554l6 6.223v-16z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="cam-muted" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0.7,19.5L15.5,4.7C15.1,4.3,14.6,4,14,4H2C0.9,4,0,4.9,0,6v12C0,18.6,0.3,19.1,0.7,19.5z"></path>\n\t\t\t\t<path d="M18 13.8L24 20 24 4 18 10.2z"></path>\n\t\t\t\t<path d="M7.8,20H14c1.1,0,2-0.9,2-2v-6.2L7.8,20z"></path>\n\t\t\t\t<path d="M-3.4 11.2H27.400000000000002V12.7H-3.4z" transform="rotate(-45.001 12 12)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="mic" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16 11c0 2.209-1.791 4-4 4s-4-1.791-4-4v-7c0-2.209 1.791-4 4-4s4 1.791 4 4v7zm4-2v2c0 4.418-3.582 8-8 8s-8-3.582-8-8v-2h2v2c0 3.309 2.691 6 6 6s6-2.691 6-6v-2h2zm-7 13v-2h-2v2h-4v2h10v-2h-4z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="mic-muted" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16,11.4L12.4,15C14.3,14.8,15.8,13.3,16,11.4z"></path>\n\t\t\t\t<path d="M16,4.6V4c0-2.2-1.8-4-4-4S8,1.8,8,4v7c0,0.5,0.1,0.9,0.3,1.4L16,4.6z"></path>\n\t\t\t\t<path d="M13 20L11 20 11 22 7 22 7 24 17 24 17 22 13 22z"></path>\n\t\t\t\t<path d="M18,11c0,3.3-2.7,6-6,6c-0.5,0-1-0.1-1.4-0.2L9,18.4c0.9,0.4,2,0.6,3,0.6c4.4,0,8-3.6,8-8V9h-2V11z"></path>\n\t\t\t\t<path d="M6.7,13.9C6.3,13,6,12,6,11V9H4v2c0,1.6,0.5,3.1,1.3,4.3L6.7,13.9z"></path>\n\t\t\t\t<path d="M-3.4 11.2H27.400000000000002V12.7H-3.4z" transform="rotate(-45.001 12 12)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="gamepad" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17.622 3c-1.913 0-2.558 1.382-5.623 1.382-3.009 0-3.746-1.382-5.623-1.382-5.209 0-6.376 10.375-6.376 14.348 0 2.145.817 3.652 2.469 3.652 3.458 0 2.926-5 6.915-5h5.23c3.989 0 3.457 5 6.915 5 1.652 0 2.471-1.506 2.471-3.651 0-3.973-1.169-14.349-6.378-14.349zm-10.622 10c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3zm10-6c.552 0 1 .447 1 1 0 .553-.448 1-1 1s-1-.447-1-1c0-.553.448-1 1-1zm-2 4c-.552 0-1-.447-1-1 0-.553.448-1 1-1s1 .447 1 1c0 .553-.448 1-1 1zm2 2c-.552 0-1-.447-1-1 0-.553.448-1 1-1s1 .447 1 1c0 .553-.448 1-1 1zm2-2c-.552 0-1-.447-1-1 0-.553.448-1 1-1s1 .447 1 1c0 .553-.448 1-1 1zm-10.25-1c0 .965-.785 1.75-1.75 1.75s-1.75-.785-1.75-1.75.785-1.75 1.75-1.75 1.75.785 1.75 1.75z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="ar" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 0l-11 6v12.131l11 5.869 11-5.869v-12.066l-11-6.065zm7.91 6.646l-7.905 4.218-7.872-4.294 7.862-4.289 7.915 4.365zm-16.91 1.584l8 4.363v8.607l-8-4.268v-8.702zm10 12.97v-8.6l8-4.269v8.6l-8 4.269zm6.678-5.315c.007.332-.256.605-.588.612-.332.007-.604-.256-.611-.588-.006-.331.256-.605.588-.612.331-.007.605.256.611.588zm-2.71-1.677c-.332.006-.595.28-.588.611.006.332.279.595.611.588s.594-.28.588-.612c-.007-.331-.279-.594-.611-.587zm-2.132-1.095c-.332.007-.595.281-.588.612.006.332.279.594.611.588.332-.007.594-.28.588-.612-.007-.331-.279-.594-.611-.588zm-9.902 2.183c.332.007.594.281.588.612-.007.332-.279.595-.611.588-.332-.006-.595-.28-.588-.612.005-.331.279-.594.611-.588zm1.487-.5c-.006.332.256.605.588.612s.605-.257.611-.588c.007-.332-.256-.605-.588-.611-.332-.008-.604.255-.611.587zm2.132-1.094c-.006.332.256.605.588.612.332.006.605-.256.611-.588.007-.332-.256-.605-.588-.612-.332-.007-.604.256-.611.588zm3.447-5.749c-.331 0-.6.269-.6.6s.269.6.6.6.6-.269.6-.6-.269-.6-.6-.6zm0-2.225c-.331 0-.6.269-.6.6s.269.6.6.6.6-.269.6-.6-.269-.6-.6-.6zm0-2.031c-.331 0-.6.269-.6.6s.269.6.6.6.6-.269.6-.6-.269-.6-.6-.6z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="close" viewBox="0 0 24 24">\n\t\t\t\t<path d="M23 20.168l-8.185-8.187 8.185-8.174-2.832-2.807-8.182 8.179-8.176-8.179-2.81 2.81 8.186 8.196-8.186 8.184 2.81 2.81 8.203-8.192 8.18 8.192z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="vr" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22.3,4.3H1.7C0.8,4.3,0,5.1,0,6v12c0,0.9,0.8,1.7,1.7,1.7h5.6c0.7,0,1.4-0.5,1.6-1.2l1.4-4.2c0.5-1.6,2.7-1.6,3.3,0 l1.4,4.2c0.2,0.7,0.9,1.2,1.6,1.2h5.6c0.9,0,1.7-0.8,1.7-1.7V6C24,5.1,23.2,4.3,22.3,4.3z M6,14.6c-1.4,0-2.6-1.2-2.6-2.6 S4.6,9.4,6,9.4s2.6,1.2,2.6,2.6S7.4,14.6,6,14.6z M18,14.6c-1.4,0-2.6-1.2-2.6-2.6s1.2-2.6,2.6-2.6s2.6,1.2,2.6,2.6 S19.4,14.6,18,14.6z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="vr-02" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22.5,8.6c-0.3,0-0.6,0.1-0.8,0.3c-0.3-1.9-1.9-3.4-3.9-3.4H6.2c-2,0-3.6,1.5-3.9,3.4C2,8.7,1.7,8.6,1.4,8.6 C0.6,8.6,0,9.3,0,10.1v3.9c0,0.8,0.6,1.4,1.4,1.4c0.3,0,0.6-0.1,0.8-0.3c0.3,1.9,1.9,3.4,3.9,3.4h11.6c2,0,3.6-1.5,3.9-3.4 c0.2,0.2,0.5,0.3,0.8,0.3c0.8,0,1.4-0.6,1.4-1.4v-3.9C24,9.3,23.3,8.6,22.5,8.6z M20.7,14.6c0,1.6-1.3,2.8-2.8,2.8H6.2 c-1.6,0-2.8-1.3-2.8-2.8V9.4c0-1.6,1.3-2.8,2.8-2.8h11.6c1.6,0,2.8,1.3,2.8,2.8V14.6z"></path><circle cx="5.7" cy="8.7" r=".8"></circle><circle cx="18.3" cy="8.6" r=".8"></circle><circle cx="5.7" cy="15.4" r=".8"></circle><circle cx="18.3" cy="15.3" r=".8"></circle>\n\t\t\t</symbol>\n\t\t\t<symbol id="the-spy" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17,14c-1.8,0-3.3,1.3-3.7,3h-2.5c-0.5-2.1-2.5-3.4-4.6-2.9c-2.1,0.5-3.4,2.5-2.9,4.6s2.5,3.4,4.6,2.9 c1.4-0.3,2.6-1.5,2.9-2.9h2.5c0.5,2.1,2.5,3.4,4.6,2.9s3.4-2.5,2.9-4.6C20.4,15.3,18.8,14,17,14z"></path>\n\t\t\t\t<path d="M23.2,11.5h-2.6V6c0-0.7-0.5-1.4-1.2-1.6l-5.5-1.8c-1.2-0.4-2.6-0.4-3.8,0L4.6,4.4C3.9,4.6,3.4,5.3,3.4,6v5.4H0.8 c-0.5,0-0.8,0.4-0.8,0.8s0.4,0.8,0.8,0.8h22.3c0.5,0,0.8-0.4,0.8-0.8S23.6,11.5,23.2,11.5z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="spy-eye" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12,19.6c-4.6,0-8.9-3.5-11.7-6.8c-0.4-0.5-0.4-1.2,0-1.6C3.1,7.9,7.4,4.4,12,4.4s8.9,3.5,11.7,6.8 c0.4,0.5,0.4,1.2,0,1.6C20.9,16.1,16.6,19.6,12,19.6z M12,7.5c2.5,0,4.4,1.9,4.4,4.4s-1.9,4.4-4.4,4.4s-4.4-1.9-4.4-4.4 S9.5,7.5,12,7.5z" clip-rule="evenodd"></path>\n\t\t\t\t<path d="M12,9.3c1.4,0,2.6,1.2,2.6,2.6s-1.2,2.6-2.6,2.6s-2.6-1.2-2.6-2.6S10.6,9.3,12,9.3z" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="copy" viewBox="0 0 24 24">\n\t\t\t\t<path d="M7 16h10v1h-10v-1zm0-1h10v-1h-10v1zm15-13v22h-20v-22h3c1.229 0 2.18-1.084 3-2h8c.82.916 1.771 2 3 2h3zm-11 1c0 .552.448 1 1 1s1-.448 1-1-.448-1-1-1-1 .448-1 1zm9 1h-4l-2 2h-3.898l-2.102-2h-4v18h16v-18zm-13 9h10v-1h-10v1zm0-2h10v-1h-10v1z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="menu" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 18c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3zm0-9c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3zm0-9c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="menu-light" viewBox="0 0 24 24">\n\t\t\t\t<path d="M14 19h-14v-1h14v1zm9.247-8.609l-3.247 4.049-3.263-4.062-.737.622 4 5 4-5-.753-.609zm-9.247 2.609h-14v-1h14v1zm0-6h-14v-1h14v1z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="settings" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 14.187v-4.374c-2.148-.766-2.726-.802-3.027-1.529-.303-.729.083-1.169 1.059-3.223l-3.093-3.093c-2.026.963-2.488 1.364-3.224 1.059-.727-.302-.768-.889-1.527-3.027h-4.375c-.764 2.144-.8 2.725-1.529 3.027-.752.313-1.203-.1-3.223-1.059l-3.093 3.093c.977 2.055 1.362 2.493 1.059 3.224-.302.727-.881.764-3.027 1.528v4.375c2.139.76 2.725.8 3.027 1.528.304.734-.081 1.167-1.059 3.223l3.093 3.093c1.999-.95 2.47-1.373 3.223-1.059.728.302.764.88 1.529 3.027h4.374c.758-2.131.799-2.723 1.537-3.031.745-.308 1.186.099 3.215 1.062l3.093-3.093c-.975-2.05-1.362-2.492-1.059-3.223.3-.726.88-.763 3.027-1.528zm-4.875.764c-.577 1.394-.068 2.458.488 3.578l-1.084 1.084c-1.093-.543-2.161-1.076-3.573-.49-1.396.581-1.79 1.693-2.188 2.877h-1.534c-.398-1.185-.791-2.297-2.183-2.875-1.419-.588-2.507-.045-3.579.488l-1.083-1.084c.557-1.118 1.066-2.18.487-3.58-.579-1.391-1.691-1.784-2.876-2.182v-1.533c1.185-.398 2.297-.791 2.875-2.184.578-1.394.068-2.459-.488-3.579l1.084-1.084c1.082.538 2.162 1.077 3.58.488 1.392-.577 1.785-1.69 2.183-2.875h1.534c.398 1.185.792 2.297 2.184 2.875 1.419.588 2.506.045 3.579-.488l1.084 1.084c-.556 1.121-1.065 2.187-.488 3.58.577 1.391 1.689 1.784 2.875 2.183v1.534c-1.188.398-2.302.791-2.877 2.183zm-7.125-5.951c1.654 0 3 1.346 3 3s-1.346 3-3 3-3-1.346-3-3 1.346-3 3-3zm0-2c-2.762 0-5 2.238-5 5s2.238 5 5 5 5-2.238 5-5-2.238-5-5-5z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="settings-full" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 13.616v-3.232l-2.869-1.02c-.198-.687-.472-1.342-.811-1.955l1.308-2.751-2.285-2.285-2.751 1.307c-.613-.339-1.269-.613-1.955-.811l-1.021-2.869h-3.232l-1.021 2.869c-.686.198-1.342.471-1.955.811l-2.751-1.308-2.285 2.285 1.308 2.752c-.339.613-.614 1.268-.811 1.955l-2.869 1.02v3.232l2.869 1.02c.197.687.472 1.342.811 1.955l-1.308 2.751 2.285 2.286 2.751-1.308c.613.339 1.269.613 1.955.811l1.021 2.869h3.232l1.021-2.869c.687-.198 1.342-.472 1.955-.811l2.751 1.308 2.285-2.286-1.308-2.751c.339-.613.613-1.268.811-1.955l2.869-1.02zm-12 2.384c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="emoji" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12,2c5.5,0,10,4.5,10,10s-4.5,10-10,10S2,17.5,2,12S6.5,2,12,2z M12,0C5.4,0,0,5.4,0,12s5.4,12,12,12s12-5.4,12-12 S18.6,0,12,0z M18,14H6c0.3,1.5,2.8,4,6,4C15.1,18,17.7,15.5,18,14z M8.5,8C7.7,8,7,8.7,7,9.5S7.7,11,8.5,11S10,10.3,10,9.5 S9.3,8,8.5,8z M15.5,8C14.7,8,14,8.7,14,9.5s0.7,1.5,1.5,1.5c0.8,0,1.5-0.7,1.5-1.5S16.3,8,15.5,8z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="pencil" viewBox="0 0 24 24">\n\t\t\t\t<path d="M19.769 9.923l-12.642 12.639-7.127 1.438 1.438-7.128 12.641-12.64 5.69 5.691zm1.414-1.414l2.817-2.82-5.691-5.689-2.816 2.817 5.69 5.692z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="erase" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5.662 23l-5.369-5.365c-.195-.195-.293-.45-.293-.707 0-.256.098-.512.293-.707l14.929-14.928c.195-.194.451-.293.707-.293.255 0 .512.099.707.293l7.071 7.073c.196.195.293.451.293.708 0 .256-.097.511-.293.707l-11.216 11.219h5.514v2h-12.343zm3.657-2l-5.486-5.486-1.419 1.414 4.076 4.072h2.829zm.456-11.429l-4.528 4.528 5.658 5.659 4.527-4.53-5.657-5.657z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="move" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 10c1.104 0 2 .896 2 2s-.896 2-2 2-2-.896-2-2 .896-2 2-2zm-3.857 3c-.084-.321-.143-.652-.143-1s.059-.679.143-1h-2.143v-4l-6 5 6 5v-4h2.143zm7.714-2c.084.321.143.652.143 1s-.059.679-.143 1h2.143v4l6-5-6-5v4h-2.143zm-2.857 4.857c-.321.084-.652.143-1 .143s-.679-.059-1-.143v2.143h-4l5 6 5-6h-4v-2.143zm-2-7.714c.321-.084.652-.143 1-.143s.679.059 1 .143v-2.143h4l-5-6-5 6h4v2.143z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="caret-down" viewBox="0 0 8 5">\n\t\t\t\t<path d="M0 0h8L4 5 0 0z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="caret-right" viewBox="0 0 8 12">\n\t\t\t\t<path d="M0 12V0l8 6-8 6z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="websolute" viewBox="0 0 20 20">\n\t\t\t\t<path d="M20 10c0 5.5-4.5 10-10 10S0 15.5 0 10 4.5 0 10 0s10 4.5 10 10m-10 2.3c.5.5 1.3.8 2.1.8s1.5-.3 2.1-.8c.5-.5.8-1.2.8-2V7.5h-1.7v2.8c0 .3-.1.6-.4.8-.1.1-.3.2-.4.3-.2.1-.3.1-.5.1s-.3 0-.5-.1c-.1-.1-.3-.2-.4-.3-.2-.2-.4-.5-.4-.8V7.6H9.2v2.8c0 .3-.1.6-.4.9-.2.2-.5.4-.8.4-.3 0-.7-.1-.9-.3-.2-.2-.4-.5-.3-.8V7.5H5v2.8c0 .7.3 1.5.8 2 .6.5 1.3.8 2.1.8.8.1 1.6-.2 2.1-.8z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="search" viewBox="0 0 21 23">\n\t\t\t\t<path d="M20.6 20.3l-4.9-5.2c1.2-1.7 1.8-3.7 1.8-5.7 0-5.2-3.9-9.4-8.7-9.4S0 4.2 0 9.4s3.7 7.8 6.3 8.4c1.8.4 3.9.6 7.1-.7l5.1 5.4c.5.6 1.4.6 2 .1l.1-.1c.5-.6.5-1.6 0-2.2zM15 9.4c-.2 3.5-3.2 6.1-6.7 5.8S2.2 12 2.5 8.5c.2-3.3 3-5.8 6.3-5.8 3.5.1 6.3 3.1 6.2 6.7z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="result-indicator" viewBox="0 0 24 24">\n\t\t\t\t<path d="M11 21.883l-6.235-7.527-.765.644 7.521 9 7.479-9-.764-.645-6.236 7.529v-21.884h-1v21.883z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="bullet" viewBox="0 0 18 18">\n\t\t\t\t<path d="M9 2c3.9 0 7 3.1 7 7s-3.1 7-7 7-7-3.1-7-7 3.1-7 7-7m0-2C4 0 0 4 0 9s4 9 9 9 9-4 9-9-4-9-9-9z" opacity=".15" fill="#17265a"></path>\n\t\t\t\t<circle cx="9" cy="9" r="4" fill="#17265a"></circle>\n\t\t\t</symbol>\n\t\t\t<symbol id="play" viewBox="0 0 16 20">\n\t\t\t\t<path d="M0,0v19.8l15.4-11L0,0z" fill-rule="evenodd" clip-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="play-progress" viewBox="0 0 196 196">\n\t\t\t\t<path d="M195.5,98c0,53.8-43.7,97.5-97.5,97.5S0.5,151.8,0.5,98S44.2,0.5,98,0.5S195.5,44.2,195.5,98z" stroke-width="2px" stroke-linecap="square" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="pause" viewBox="0 0 16 20">\n\t\t\t\t<path d="M0 0.9H4V18.9H0z"></path>\n\t\t\t\t<path d="M11.4 0.9H15.4V18.9H11.4z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="wishlist-add" viewBox="0 0 25 20">\n\t\t\t\t<path d="M12.5,20.8c-0.3,0-0.5-0.1-0.8-0.3c-0.3-0.2-0.6-0.4-0.9-0.6c-0.7-0.5-1.4-0.9-2.1-1.5 c-1.1-0.8-2.1-1.6-3.1-2.4C4.2,15,3,13.8,1.9,12.4c-0.9-1.1-1.4-2.3-1.7-3.7C0.1,8.5,0.1,8.2,0,7.9l0-0.2l0.1-1.4 c0-0.1,0.1-0.3,0.1-0.4c0.1-0.3,0.1-0.7,0.3-1c0.6-1.7,1.8-3.2,3.4-4c1.5-0.8,3.3-1.1,5-0.8c1.4,0.2,2.6,0.8,3.7,1.7 c2.9-2.4,7.2-2.4,10,0.1c1.1,0.9,1.9,2.2,2.2,3.5c0.1,0.3,0.1,0.6,0.2,0.8L25,6.7l-0.1,1.4c-0.2,1.2-0.6,2.4-1.2,3.4 c-0.5,0.8-1.1,1.6-1.8,2.3c-0.8,0.9-1.7,1.7-2.6,2.5c-0.7,0.6-1.6,1.3-2.6,2c-0.8,0.5-1.5,1.1-2.3,1.6c-0.4,0.3-0.8,0.5-1.2,0.8 C13.1,20.8,12.8,20.8,12.5,20.8z M2.1,7.6c0,0.2,0.1,0.4,0.1,0.6c0.2,1.1,0.7,2,1.4,2.9c1,1.2,2.1,2.3,3.3,3.3c1,0.8,2,1.6,3,2.4 c0.7,0.5,1.4,0.9,2.1,1.4l0.5,0.3c0.2-0.2,0.5-0.3,0.7-0.5c0.8-0.5,1.5-1,2.3-1.6c0.9-0.7,1.8-1.4,2.5-1.9c0.9-0.7,1.7-1.5,2.4-2.3 c0.6-0.6,1.1-1.2,1.5-1.9c0.5-0.8,0.8-1.7,0.9-2.6c0-0.1,0-0.1,0-0.2l0-0.9c0-0.2-0.1-0.4-0.1-0.6c-0.3-1-0.8-1.9-1.6-2.5 c-2.1-1.8-5.2-1.8-7.3,0c-0.1,0.1-0.3,0.2-0.4,0.4l-0.9,1.2l-1-1.3c-0.8-0.8-1.9-1.4-3-1.6C7.2,2,5.9,2.2,4.9,2.8 c-1.1,0.6-2,1.6-2.4,2.8C2.4,5.9,2.3,6.1,2.3,6.4c0,0.1-0.1,0.3-0.1,0.4l0,0L2.1,7.6L2.1,7.6z" clip-rule="evenodd" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="wishlist-added" viewBox="0 0 25 20">\n\t\t\t\t<path d="M12.5,20.8c-0.3,0-0.5-0.1-0.8-0.3c-0.3-0.2-0.6-0.4-0.9-0.6c-0.7-0.5-1.4-0.9-2.1-1.5 c-1.1-0.8-2.1-1.6-3.1-2.4c-1.4-1-2.6-2.2-3.7-3.6C1,11.3,0.5,10.1,0.2,8.7C0.1,8.5,0.1,8.2,0,7.9V7.7l0.1-1.4 c0-0.1,0.1-0.3,0.1-0.4c0.1-0.3,0.1-0.7,0.3-1c0.6-1.7,1.8-3.2,3.4-4c1.5-0.8,3.3-1.1,5-0.8c1.4,0.2,2.6,0.8,3.7,1.7 c2.9-2.4,7.2-2.4,10,0.1c1.1,0.9,1.9,2.2,2.2,3.5C24.9,5.7,24.9,6,25,6.2v0.5l-0.1,1.4c-0.2,1.2-0.6,2.4-1.2,3.4 c-0.5,0.8-1.1,1.6-1.8,2.3c-0.8,0.9-1.7,1.7-2.6,2.5c-0.7,0.6-1.6,1.3-2.6,2c-0.8,0.5-1.5,1.1-2.3,1.6c-0.4,0.3-0.8,0.5-1.2,0.8 C13.1,20.8,12.8,20.8,12.5,20.8z" clip-rule="evenodd" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="wishlist" viewBox="0 0 16 14">\n\t\t\t\t<path d="M8,14c-0.2,0-0.3-0.1-0.5-0.2l-0.6-0.4c-0.5-0.3-0.9-0.6-1.4-1c-0.7-0.5-1.4-1.1-2-1.6 c-0.9-0.7-1.6-1.6-2.3-2.5C0.7,7.6,0.3,6.8,0.1,5.9c0-0.2-0.1-0.4-0.1-0.5l0-0.1l0-1c0-0.1,0-0.2,0.1-0.3c0.1-0.2,0.1-0.4,0.2-0.7 c0.4-1.1,1.2-2.1,2.2-2.7c1.8-1,4-0.8,5.5,0.6c1.8-1.6,4.6-1.6,6.4,0.1c0.7,0.6,1.2,1.5,1.4,2.4C15.9,3.8,15.9,4,16,4.2l0,0.3l0,0.9 c-0.1,0.8-0.4,1.6-0.8,2.3c-0.3,0.5-0.7,1-1.1,1.5c-0.5,0.6-1.1,1.1-1.7,1.7c-0.4,0.4-1,0.9-1.7,1.3c-0.5,0.4-1,0.7-1.5,1.1 c-0.2,0.2-0.5,0.3-0.7,0.5C8.4,13.9,8.2,14,8,14z M1.4,5.1c0,0.1,0.1,0.3,0.1,0.4c0.1,0.7,0.4,1.4,0.9,1.9C2.9,8.3,3.6,9,4.4,9.7 c0.6,0.5,1.3,1.1,1.9,1.6c0.4,0.3,0.9,0.6,1.3,0.9c0.1,0.1,0.2,0.2,0.3,0.2c0.2-0.1,0.3-0.2,0.5-0.3c0.5-0.3,1-0.7,1.5-1 c0.6-0.4,1.2-0.9,1.6-1.3c0.5-0.5,1.1-1,1.5-1.5c0.4-0.4,0.7-0.8,1-1.3c0.3-0.5,0.5-1.1,0.6-1.7c0,0,0-0.1,0-0.1l0-0.6 c0-0.1,0-0.3-0.1-0.4c-0.2-0.7-0.5-1.2-1-1.7c-1.3-1.2-3.4-1.2-4.7,0C8.7,2.4,8.6,2.5,8.5,2.6L8,3.4L7.3,2.5 C6.3,1.4,4.5,1.1,3.1,1.9C2.4,2.3,1.8,3,1.6,3.8C1.5,3.9,1.5,4.1,1.4,4.3L1.4,4.6l0,0L1.4,5.1L1.4,5.1z" clip-rule="evenodd" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="expand" viewBox="0 0 29 30">\n\t\t\t\t<path d="M26 16.3V5.9L2.2 29.7.1 27.6 24 3.3H13v-3h16v16h-3z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="download" viewBox="0 0 9 13">\n\t\t\t\t<path d="M8.5 7.9c-.3-.4-.8-.4-1.2-.1l-.1.1-2 2V1.2c0-.2-.1-.4-.2-.6-.2-.3-.7-.3-1 0-.2.2-.3.4-.3.6v8.6l-2-2c-.2-.1-.4-.2-.7-.2-.2 0-.4.1-.6.3-.1.2-.1.4-.1.6 0 .2.1.4.2.5l3.4 3.4c.2.2.4.2.6.2.2 0 .4-.1.6-.2L8.4 9c.2-.1.2-.3.3-.6 0-.1-.1-.4-.2-.5z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="upload" viewBox="0 0 24 24">\n\t\t\t\t<path d="M10 9H4l8-9 8 9h-6v11h-4V9zm11 11v2H3v-2H1v4h22v-4h-2z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="user" viewBox="0 0 24 24">\n\t\t\t\t<path d="M20.822 18.096c-3.439-.794-6.64-1.49-5.09-4.418C20.452 4.766 16.983 0 12 0 6.918 0 3.536 4.949 8.268 13.678c1.597 2.945-1.725 3.641-5.09 4.418C.105 18.806-.01 20.332 0 23l.004 1h23.99l.004-.969c.012-2.688-.092-4.222-3.176-4.935z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="back" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2.117 12l7.527 6.235L9 19l-9-7.521L9 4l.645.764L2.116 11H24v1H2.117z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="add" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 10h-10v-10h-4v10h-10v4h10v10h4v-10h10z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="remove" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 10h24v4h-24z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="link" viewBox="0 0 24 24">\n\t\t\t\t<path d="M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="up" viewBox="0 0 24 24">\n\t\t\t\t<path d="M7 11h-6l11-11 11 11h-6v13h-10z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="down" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17,13h6L12,24L1,13h6V0h10V13z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="waiting-room" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2,6c0-2.2,1.8-4,4-4h12c2.2,0,4,1.8,4,4v12c0,2.2-1.8,4-4,4H6c-2.2,0-4-1.8-4-4V6z" opacity=".2"></path>\n\t\t\t\t<path d="M17.8,10.7c0.7,0,1.3,0.6,1.3,1.3s-0.6,1.3-1.3,1.3H6.2c-0.7,0-1.3-0.6-1.3-1.3s0.6-1.3,1.3-1.3H17.8z M19.7,12 c0-1.1-0.9-1.9-1.9-1.9H6.2c-1.1,0-1.9,0.9-1.9,1.9s0.9,1.9,1.9,1.9h11.6C18.9,13.9,19.7,13.1,19.7,12z M13.9,11.4H6.2 c-0.4,0-0.6,0.3-0.6,0.6s0.3,0.6,0.6,0.6h7.7c0.4,0,0.6-0.3,0.6-0.6S14.3,11.4,13.9,11.4z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="panorama" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 9 15 C 9 14.448 9.448 14 10 14 L 14 14 C 14.552 14 15 14.448 15 15 L 15 16 C 15 16.552 14.552 17 14 17 L 10 17 C 9.448 17 9 16.552 9 16 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t\t<path d="M 7 8 C 7 7.448 7.448 7 8 7 L 16 7 C 16.552 7 17 7.448 17 8 L 17 12 C 17 12.552 16.552 13 16 13 L 8 13 C 7.448 13 7 12.552 7 12 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="panorama-grid" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 10.333 7.333 C 10.886 7.333 11.333 7.781 11.333 8.333 L 11.333 10.333 C 11.333 10.886 10.886 11.333 10.333 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t\t<path d="M 12.333 8.333 C 12.333 7.781 12.781 7.333 13.333 7.333 L 15.333 7.333 C 15.886 7.333 16.333 7.781 16.333 8.333 L 16.333 10.333 C 16.333 10.886 15.886 11.333 15.333 11.333 L 13.333 11.333 C 12.781 11.333 12.333 10.886 12.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t\t<path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 10.333 12.667 C 10.886 12.667 11.333 13.114 11.333 13.667 L 11.333 15.667 C 11.333 16.219 10.886 16.667 10.333 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t\t<path d="M 12.333 13.667 C 12.333 13.114 12.781 12.667 13.333 12.667 L 15.333 12.667 C 15.886 12.667 16.333 13.114 16.333 13.667 L 16.333 15.667 C 16.333 16.219 15.886 16.667 15.333 16.667 L 13.333 16.667 C 12.781 16.667 12.333 16.219 12.333 15.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="room-3d" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 6.6 9.056 C 6.6 8.533 6.905 8.059 7.381 7.842 L 8.995 7.108 C 9.436 6.907 9.938 7.23 9.938 7.715 L 9.938 16.272 C 9.938 16.757 9.436 17.08 8.995 16.879 L 7.381 16.145 C 6.905 15.928 6.6 15.454 6.6 14.931 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 10.754 7.453 C 10.754 6.795 11.378 6.316 12.014 6.487 L 16.32 7.647 C 17.193 7.882 17.8 8.674 17.8 9.578 L 17.8 14.105 C 17.8 15.009 17.193 15.801 16.32 16.036 L 12.014 17.196 C 11.378 17.367 10.754 16.889 10.754 16.231 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="model" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M 11.298 7.283 C 11.602 6.729 12.398 6.729 12.702 7.283 L 14.009 9.673 C 14.082 9.807 14.193 9.918 14.327 9.991 L 16.717 11.298 C 17.271 11.602 17.271 12.398 16.717 12.702 L 14.327 14.009 C 14.193 14.082 14.082 14.193 14.009 14.327 L 12.702 16.717 C 12.398 17.271 11.602 17.271 11.298 16.717 L 9.991 14.327 C 9.918 14.193 9.807 14.082 9.673 14.009 L 7.283 12.702 C 6.729 12.398 6.729 11.602 7.283 11.298 L 9.673 9.991 C 9.807 9.918 9.918 9.807 9.991 9.673 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="media" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2,6c0-2.2,1.8-4,4-4h12c2.2,0,4,1.8,4,4v12c0,2.2-1.8,4-4,4H6c-2.2,0-4-1.8-4-4V6z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M12,19c-2.2,0-4.3-1-5.6-2.7L7,15.9c1.2,1.5,3,2.4,5,2.4c1.9,0,3.8-0.9,5-2.4l0.6,0.4C16.3,18,14.2,19,12,19z M5.5,14.7C5.2,13.8,5,12.8,5,12c0-3.5,2.7-6.5,6.2-7v0.6C8,6.1,5.7,8.8,5.7,12c0,0.8,0.1,1.5,0.4,2.4L5.5,14.7z M18,14.4 c0.3-0.8,0.4-1.6,0.4-2.4c0-3.2-2.3-5.9-5.5-6.4c0-0.2,0-0.5,0-0.6c3.5,0.4,6.2,3.4,6.2,7c0,0.8-0.2,1.8-0.5,2.7L18,14.4z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M10.2,15V8.9l5.5,3.1L10.2,15z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="nav" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 6.5 8.667 C 6.5 8.114 6.948 7.667 7.5 7.667 L 16.5 7.667 C 17.052 7.667 17.5 8.114 17.5 8.667 L 17.5 14.495 C 17.5 15.046 17.053 15.494 16.502 15.495 L 14.189 15.499 C 13.959 15.5 13.736 15.58 13.558 15.725 L 12.211 16.827 C 12.088 16.928 11.912 16.928 11.789 16.827 L 10.442 15.725 C 10.264 15.58 10.041 15.5 9.811 15.499 L 7.498 15.495 C 6.947 15.494 6.5 15.046 6.5 14.495 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="plane" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(4.667 11.5) rotate(-90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(17.333 11.5) rotate(90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 8 9 C 8 8.448 8.448 8 9 8 L 15 8 C 15.552 8 16 8.448 16 9 L 16 15 C 16 15.552 15.552 16 15 16 L 9 16 C 8.448 16 8 15.552 8 15 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="curved-plane" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(4.667 11.5) rotate(-90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(17.333 11.5) rotate(90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 8 9 C 8 8.448 8.448 8 9 8 L 15 8 C 15.552 8 16 8.448 16 9 L 16 15 C 16 15.552 15.552 16 15 16 L 9 16 C 8.448 16 8 15.552 8 15 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="texture" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 7.333 8.95 C 7.333 8.274 7.839 7.705 8.511 7.626 L 14.805 6.886 C 15.796 6.769 16.667 7.543 16.667 8.541 L 16.667 15.49 C 16.667 16.477 15.814 17.247 14.833 17.148 L 8.533 16.513 C 7.852 16.444 7.333 15.871 7.333 15.187 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="gltf" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M 11.298 7.283 C 11.602 6.729 12.398 6.729 12.702 7.283 L 14.009 9.673 C 14.082 9.807 14.193 9.918 14.327 9.991 L 16.717 11.298 C 17.271 11.602 17.271 12.398 16.717 12.702 L 14.327 14.009 C 14.193 14.082 14.082 14.193 14.009 14.327 L 12.702 16.717 C 12.398 17.271 11.602 17.271 11.298 16.717 L 9.991 14.327 C 9.918 14.193 9.807 14.082 9.673 14.009 L 7.283 12.702 C 6.729 12.398 6.729 11.602 7.283 11.298 L 9.673 9.991 C 9.807 9.918 9.918 9.807 9.991 9.673 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="tile" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 15.667 13 C 17.139 13 18.333 14.194 18.333 15.667 C 18.333 17.139 17.139 18.333 15.667 18.333 C 14.194 18.333 13 17.139 13 15.667 C 13 14.194 14.194 13 15.667 13 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="image" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5 8.5c0-.828.672-1.5 1.5-1.5s1.5.672 1.5 1.5c0 .829-.672 1.5-1.5 1.5s-1.5-.671-1.5-1.5zm9 .5l-2.519 4-2.481-1.96-4 5.96h14l-5-8zm8-4v14h-20v-14h20zm2-2h-24v18h24v-18z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="video" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2.184 7.874l-2.184-.918 2.967-2.956.933 2.164-1.716 1.71zm21.816 2.126l-3 2v4l3 2v-8zm-7-2h-7.018l.79.787c.356.355.629.769.831 1.213h4.897c.276 0 .5.224.5.5v7c0 .276-.224.5-.5.5h-11c-.276 0-.5-.224-.5-.5v-2.909l-.018-.014-1.982-1.975v5.398c0 1.104.896 2 2 2h12c1.104 0 2-.896 2-2v-8c0-1.104-.896-2-2-2zm-14.65 1.13l2.967-2.956 4.044 4.029c.819.816.819 2.14 0 2.956-.819.816-2.147.815-2.967 0l-4.044-4.029z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="stream" viewBox="0 0 24 24">\n\t\t\t\t<path d="M6.613 18.581m9.387-9.581c0 2.209-1.791 4-4 4s-4-1.791-4-4 1.791-4 4-4 4 1.791 4 4zm-2 0c0-1.103-.896-2-2-2s-2 .897-2 2 .896 2 2 2 2-.897 2-2zm-9 0c0 3.86 3.141 7 7 7s7-3.14 7-7-3.141-7-7-7-7 3.14-7 7zm16 0c0 4.97-4.029 9-9 9s-9-4.03-9-9 4.029-9 9-9 9 4.03 9 9zm-.404 12.501c1.007 1.142-.014 2.679-1.448 2.481-1.795-.245-3.236-1.702-7.147-1.702-3.91 0-5.352 1.458-7.146 1.702-1.436.198-2.456-1.34-1.449-2.481l2.898-3.289c.559.388 1.156.725 1.79.994l-2.025 2.298c1.295-.524 3.065-1.225 5.933-1.225s4.638.7 5.933 1.224l-2.025-2.298c.634-.27 1.231-.606 1.79-.994l2.896 3.29z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="spinner" viewBox="0 0 24 24">\n\t\t\t\t<path d="M8.175 7.377l-3.042-5.27 1.732-1 3.045 5.273c-.635.238-1.222.573-1.735.997zm-.799.8l-5.27-3.042-1 1.732 5.274 3.045c.237-.635.572-1.223.996-1.735zm-1.376 3.823c0-.341.035-.673.09-.999h-6.09v1.999h6.09c-.055-.326-.09-.659-.09-1zm11.351-2.705l5.208-3.007-.333-.577-5.206 3.007c.121.185.23.379.331.577zm-5.351-3.295c.341 0 .673.035.999.09v-6.09h-1.999v6.09c.326-.055.659-.09 1-.09zm3.14.894l3.004-5.204-.288-.166-3 5.197.284.173zm1.685 8.662l5.234 3.022.666-1.154-5.229-3.019c-.181.41-.408.794-.671 1.151zm-10.444-1.467l-5.274 3.046 1 1.732 5.27-3.042c-.424-.513-.759-1.1-.996-1.736zm11.594-2.589l.025.5-.025.5h6.025v-1h-6.025zm-3.727 6.061l3.03 5.249 1.442-.833-3.031-5.25c-.437.34-.92.623-1.441.834zm-2.248.439c-.341 0-.674-.035-1-.09v6.09h1.999v-6.09c-.326.055-.658.09-.999.09zm-3.824-1.376l-3.042 5.27 1.732 1 3.045-5.274c-.635-.237-1.222-.572-1.735-.996z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="update" viewBox="0 0 24 24">\n\t\t\t\t<path d="M23 12c0 1.042-.154 2.045-.425 3h-2.101c.335-.94.526-1.947.526-3 0-4.962-4.037-9-9-9-1.706 0-3.296.484-4.655 1.314l1.858 2.686h-6.994l2.152-7 1.849 2.673c1.684-1.049 3.659-1.673 5.79-1.673 6.074 0 11 4.925 11 11zm-6.354 7.692c-1.357.826-2.944 1.308-4.646 1.308-4.962 0-9-4.038-9-9 0-1.053.191-2.06.525-3h-2.1c-.271.955-.425 1.958-.425 3 0 6.075 4.925 11 11 11 2.127 0 4.099-.621 5.78-1.667l1.853 2.667 2.152-6.989h-6.994l1.855 2.681z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="edit" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 1h24v2h-24v-2zm11 7h13v-2h-13v2zm0 5h13v-2h-13v2zm0 5h13v-2h-13v2zm-11 5h24v-2h-24v2zm8-17l-8 6 8 6v-12z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="lock" viewBox="0 0 24 24">\n\t\t\t\t<path d="M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4h-3v14h18v-14h-3zm-10 0v-4c0-2.206 1.794-4 4-4s4 1.794 4 4v4h-8z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="volume-off" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5 17h-5v-10h5v10zm2-10v10l9 5v-20l-9 5zm15.324 4.993l1.646-1.659-1.324-1.324-1.651 1.67-1.665-1.648-1.316 1.318 1.67 1.657-1.65 1.669 1.318 1.317 1.658-1.672 1.666 1.653 1.324-1.325-1.676-1.656z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="volume-on" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5 17h-5v-10h5v10zm2-10v10l9 5v-20l-9 5zm11.008 2.093c.742.743 1.2 1.77 1.198 2.903-.002 1.133-.462 2.158-1.205 2.9l1.219 1.223c1.057-1.053 1.712-2.511 1.715-4.121.002-1.611-.648-3.068-1.702-4.125l-1.225 1.22zm2.142-2.135c1.288 1.292 2.082 3.073 2.079 5.041s-.804 3.75-2.096 5.039l1.25 1.254c1.612-1.608 2.613-3.834 2.616-6.291.005-2.457-.986-4.681-2.595-6.293l-1.254 1.25z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="fullscreen-off" viewBox="0 0 24 24">\n\t\t\t\t<path d="M15 2h2v5h7v2h-9v-7zm9 13v2h-7v5h-2v-7h9zm-15 7h-2v-5h-7v-2h9v7zm-9-13v-2h7v-5h2v7h-9z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="fullscreen-on" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 9h-2v-7h-7v-2h9v9zm-9 15v-2h7v-7h2v9h-9zm-15-9h2v7h7v2h-9v-9zm9-15v2h-7v7h-2v-9h9z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="navmap" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 22.586l-2.823-2.823c.526-.792.836-1.74.836-2.763 0-2.762-2.238-5-5-5s-5 2.238-5 5 2.238 5 5 5c1.016 0 1.957-.307 2.746-.827l2.827 2.827 1.414-1.414zm-9.987-5.586c0-1.654 1.346-3 3-3s3 1.346 3 3-1.346 3-3 3-3-1.346-3-3zm-4 0l.002-.034-3.015 2.175v-13.068l4-2.886v10.247c.508-.854 1.189-1.591 2-2.161v-8.086l4 2.886v3.927h.013c.336 0 .664.032.987.078v-4.007l4-2.479v8.504c1.188 1.208 1.936 2.844 2 4.653v-16.749l-6.455 4-5.545-4-5.545 4-6.455-4v18l6.455 4 3.91-2.82c-.226-.687-.352-1.419-.352-2.18zm-4.013 2.365l-4-2.479v-13.294l4 2.479v13.294z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="screen" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 0v19h24v-19h-24zm22 14h-20v-12h20v12zm-6.599 7l2.599 3h-12l2.599-3h6.802z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="chat" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22 3v13h-11.643l-4.357 3.105v-3.105h-4v-13h20zm2-2h-24v16.981h4v5.019l7-5.019h13v-16.981z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="send" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22 12l-20 12 5-12-5-12z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="users" viewBox="0 0 24 24">\n\t\t\t\t<path d="M10.644 17.08c2.866-.662 4.539-1.241 3.246-3.682-3.932-7.427-1.042-11.398 3.111-11.398 4.235 0 7.054 4.124 3.11 11.398-1.332 2.455.437 3.034 3.242 3.682 2.483.574 2.647 1.787 2.647 3.889v1.031h-18c0-2.745-.22-4.258 2.644-4.92zm-12.644 4.92h7.809c-.035-8.177 3.436-5.313 3.436-11.127 0-2.511-1.639-3.873-3.748-3.873-3.115 0-5.282 2.979-2.333 8.549.969 1.83-1.031 2.265-3.181 2.761-1.862.43-1.983 1.34-1.983 2.917v.773z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="virtual-tour" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17 17h-10v-10h10v10zm7 3l-5-3v-10l5-3v16zm-24-16l5 3v10l-5 3v-16z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="live-meeting" viewBox="0 0 24 24">\n\t\t\t\t<path d="M18 18h6v6h-6v-6zm-9 6h6v-6h-6v6zm-9 0h6v-6h-6v6zm0-8h24v-16h-24v16z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="control" viewBox="0 0 24 24">\n\t\t\t\t<circle cx="7" cy="10" r="1"></circle>\n\t\t\t\t<path d="M17,3H7c-3.9,0-7,3.1-7,7v6c0,2.8,2.2,5,5,5c2.4,0,4.4-1.7,4.9-4h4.2c0.5,2.7,3.2,4.5,5.9,3.9c2.3-0.5,4-2.5,4-4.9v-6 C24,6.1,20.9,3,17,3z M17,7c0.6,0,1,0.4,1,1s-0.4,1-1,1s-1-0.4-1-1S16.4,7,17,7z M7,13c-1.7,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3 S8.7,13,7,13z M15,11c-0.6,0-1-0.4-1-1s0.4-1,1-1s1,0.4,1,1S15.6,11,15,11z M17,13c-0.6,0-1-0.4-1-1c0-0.6,0.4-1,1-1s1,0.4,1,1 C18,12.5,17.6,13,17,13z M19,11c-0.6,0-1-0.4-1-1s0.4-1,1-1s1,0.4,1,1S19.6,11,19,11z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="spy" viewBox="0 0 24 24">\n\t\t\t\t<path fill-rule="evenodd" d="M0.2,11.4c5.2-8.6,18.3-8.5,23.6,0c0.2,0.3,0.2,0.8,0,1.2c-5.3,8.4-18.4,8.6-23.6,0 C-0.1,12.2-0.1,11.7,0.2,11.4z M12,7.8c2.3,0,4.2,1.9,4.2,4.3s-1.9,4.2-4.2,4.2S7.8,14.3,7.8,12S9.7,7.8,12,7.8z" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="joystick" viewBox="0 0 24 24">\n\t\t\t\t<path d="M10.7,10.5V16H9.3C8.6,16,8,16.6,8,17.3h8c0-0.7-0.6-1.3-1.3-1.3h-1.3v-5.5c2.8-0.7,4.5-3.6,3.8-6.5 c-0.7-2.8-3.6-4.5-6.5-3.8S6.1,3.9,6.9,6.7C7.3,8.6,8.8,10,10.7,10.5z"></path>\n\t\t\t\t<path d="M1.4,18.6h21.2c0.7,0,1.3,0.6,1.3,1.3v2.7c0,0.7-0.6,1.3-1.3,1.3H1.4c-0.7,0-1.3-0.6-1.3-1.3V20 C0.1,19.2,0.7,18.6,1.4,18.6z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="navinfo" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12,2c5.5,0,10,4.5,10,10s-4.5,10-10,10S2,17.5,2,12S6.5,2,12,2z M12,0C5.4,0,0,5.4,0,12s5.4,12,12,12s12-5.4,12-12 S18.6,0,12,0z"/>\n\t\t\t\t<path d="M13,18h-2v-8h2V18z M12,5.8c0.7,0,1.2,0.6,1.2,1.2S12.7,8.2,12,8.2S10.8,7.7,10.8,7S11.3,5.8,12,5.8z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="check" viewBox="0 0 24 24">\n\t\t\t\t<path d="M9,21l-9-8.6l2.8-2.9l6.2,5.9L21.2,3L24,5.8L9,21z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="duplicate" viewBox="0 0 24 24">\n\t\t\t\t<path d="M18,6V0H0v18h6v6h18V6H18z M6,16H2V2h14v4H6V16z M22,22H8V8h14V22z M19,14h-3v-3h-2v3h-3v2h3v3h2v-3h3V14z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="trash" viewBox="0 0 24 24">\n\t\t\t\t<path fill-rule="evenodd" d="M19,24H5c-1.1,0-2-0.9-2-2V5H2V3h6V1.5C8,0.7,8.7,0,9.5,0h5C15.3,0,16,0.7,16,1.5V3h6v2h-1v17 C21,23.1,20.1,24,19,24z M19,5H5v16.5C5,21.8,5.2,22,5.5,22h13c0.3,0,0.5-0.2,0.5-0.5V5z M10,9c0-0.6-0.4-1-1-1S8,8.4,8,9v9 c0,0.6,0.4,1,1,1s1-0.4,1-1V9z M16,9c0-0.6-0.4-1-1-1s-1,0.4-1,1v9c0,0.6,0.4,1,1,1s1-0.4,1-1V9z M14,2h-4v1h4V2z" clip-rule="evenodd"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="flags" viewBox="0 0 24 24">\n\t\t\t\t<path d="M19,18c0,1.1-0.9,2-2,2s-2-0.9-2-2s0.9-2,2-2S19,16.9,19,18z M5,15c-1.7,0-3,1.3-3,3s1.3,3,3,3h14c1.7,0,3-1.3,3-3 s-1.3-3-3-3H5z M24,18c0,2.8-2.2,5-5,5H5c-2.8,0-5-2.2-5-5s2.2-5,5-5h14C21.8,13,24,15.2,24,18z M7,4C5.9,4,5,4.9,5,6s0.9,2,2,2 s2-0.9,2-2S8.1,4,7,4z M5,3C3.3,3,2,4.3,2,6s1.3,3,3,3h14c1.7,0,3-1.3,3-3s-1.3-3-3-3H5z M24,6c0,2.8-2.2,5-5,5H5c-2.8,0-5-2.2-5-5 s2.2-5,5-5h14C21.8,1,24,3.2,24,6z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="b-here" viewBox="0 0 270 98">\n\t\t\t\t<path d="M61.5,87.9c0-2.7,0.9-5,2.8-6.9c1.9-1.9,4.2-2.8,7-2.8c1.4,0,2.7,0.2,3.9,0.8c1.2,0.5,2.2,1.2,3.2,2 c0.9,0.9,1.6,1.9,2.1,3.1s0.8,2.5,0.8,3.8s-0.2,2.6-0.8,3.8c-0.5,1.2-1.2,2.2-2.1,3.1s-1.9,1.6-3.2,2.1c-1.2,0.5-2.5,0.8-3.9,0.8 s-2.7-0.2-3.9-0.8c-1.2-0.5-2.2-1.2-3.1-2.1s-1.6-1.9-2.1-3.1S61.5,89.2,61.5,87.9z"></path>\n\t\t\t\t<path d="M16,70.2H0.7v-70H16V29c0.6-1.1,1.4-2.1,2.4-3.1s2.2-1.9,3.5-2.6s2.8-1.3,4.2-1.8c1.5-0.4,3-0.6,4.6-0.6 c3.5,0,6.7,0.6,9.6,1.9s5.4,3.1,7.4,5.3c2.1,2.2,3.7,4.9,4.8,8s1.7,6.4,1.7,10.1c0,3.6-0.6,6.9-1.7,10c-1.1,3.1-2.7,5.8-4.8,8 c-2.1,2.2-4.5,4-7.4,5.3s-6.1,2-9.6,2c-1.6,0-3.1-0.2-4.6-0.7c-1.5-0.4-2.9-1-4.2-1.7c-1.3-0.7-2.5-1.5-3.5-2.5s-1.8-2-2.4-3.1 C16,63.5,16,70.2,16,70.2z M27.6,58.5c1.7,0,3.2-0.3,4.6-1c1.4-0.7,2.6-1.5,3.6-2.7c1-1.1,1.8-2.4,2.4-3.9c0.6-1.5,0.8-3.1,0.8-4.8 s-0.3-3.2-0.8-4.7c-0.6-1.5-1.4-2.8-2.4-3.9c-1-1.1-2.2-2-3.6-2.7c-1.4-0.7-2.9-1-4.6-1s-3.3,0.3-4.8,1c-1.4,0.7-2.7,1.6-3.7,2.7 c-1,1.1-1.8,2.4-2.3,3.9c-0.6,1.5-0.8,3-0.8,4.7s0.3,3.2,0.8,4.8s1.3,2.8,2.3,3.9c1,1.1,2.2,2,3.7,2.7 C24.3,58.2,25.9,58.5,27.6,58.5z"></path>\n\t\t\t\t<path d="M64.1,0.2h14.8V29c1.3-2.5,3.3-4.5,6-6s5.9-2.2,9.6-2.2c3.1,0,5.8,0.5,7.9,1.4c2.1,1,3.9,2.3,5.2,4.1 c1.5,1.9,2.6,4,3.1,6.5s0.8,5.4,0.8,8.9v28.5H96.7V45.5c0-3.5-0.6-6.3-1.8-8.5c-1.2-2.2-3.5-3.2-6.7-3.2c-3.1,0-5.5,1.1-7,3.3 s-2.3,5.2-2.3,8.9v24.2H64.1V0.2z"></path>\n\t\t\t\t<path d="M135.9,49.8c0.1,1.5,0.3,2.9,0.7,4.2s1,2.4,1.8,3.4s1.9,1.7,3.2,2.3s3,0.8,5,0.8c2.7,0,4.7-0.5,6-1.6 c1.4-1.1,2.3-2.4,2.9-3.9h15c-0.3,2.3-1.1,4.4-2.4,6.4c-1.2,2-2.9,3.8-4.9,5.2c-2,1.5-4.4,2.7-7.2,3.5c-2.8,0.9-5.9,1.3-9.3,1.3 c-4.2,0-7.9-0.6-11.2-1.8c-3.2-1.2-6-3-8.2-5.2c-2.2-2.3-3.9-5-5-8c-1.1-3.1-1.7-6.5-1.7-10.2c0-3.5,0.5-6.8,1.6-9.9s2.7-5.8,4.9-8 c2.2-2.3,4.8-4.1,8-5.5c3.2-1.3,6.8-2,11-2c3.8,0,7.2,0.6,10.2,1.8c3,1.2,5.6,2.8,7.8,4.8s3.8,4.3,5,7s1.8,5.5,1.8,8.4 c0,1,0,2.1,0,3.2c0,1.1-0.2,2.4-0.5,3.9h-34.5V49.8z M146.2,31c-3,0-5.5,0.9-7.4,2.6c-1.9,1.7-2.9,4.2-2.9,7.5h20.2 c0-3.1-0.9-5.6-2.8-7.4C151.5,31.9,149.1,31,146.2,31z"></path>\n\t\t\t\t<path d="M216.1,36c-1.1-0.3-2-0.5-2.7-0.6c-0.7-0.1-1.6-0.1-2.7-0.1c-4.2,0-7.6,1.2-10.1,3.7s-3.8,6.6-3.8,12.5v18.8h-15.3V22h15.3 v7.8c1.1-2.3,3-4.3,5.7-6c2.6-1.7,5.6-2.6,9-2.6c1.8,0,3.3,0.3,4.6,0.8V36z"></path>\n\t\t\t\t<path d="M234.3,49.8c0.1,1.5,0.3,2.9,0.7,4.2s1,2.4,1.8,3.4s1.9,1.7,3.2,2.3s3,0.8,5,0.8c2.7,0,4.7-0.5,6-1.6 c1.4-1.1,2.3-2.4,2.9-3.9h15c-0.3,2.3-1.1,4.4-2.4,6.4c-1.2,2-2.9,3.8-4.9,5.2c-2,1.5-4.4,2.7-7.2,3.5c-2.8,0.9-5.9,1.3-9.3,1.3 c-4.2,0-7.9-0.6-11.2-1.8c-3.2-1.2-6-3-8.2-5.2c-2.2-2.3-3.9-5-5-8c-1.1-3.1-1.7-6.5-1.7-10.2c0-3.5,0.5-6.8,1.6-9.9s2.7-5.8,4.9-8 c2.2-2.3,4.8-4.1,8-5.5c3.2-1.3,6.8-2,11-2c3.8,0,7.2,0.6,10.2,1.8c3,1.2,5.6,2.8,7.8,4.8c2.2,2,3.8,4.3,5,7s1.8,5.5,1.8,8.4 c0,1,0,2.1,0,3.2c0,1.1-0.2,2.4-0.5,3.9h-34.5V49.8z M244.6,31c-3,0-5.5,0.9-7.4,2.6c-1.9,1.7-2.9,4.2-2.9,7.5h20.2 c0-3.1-0.9-5.6-2.8-7.4C249.9,31.9,247.5,31,244.6,31z"></path>\n\t\t\t</symbol>\n\t\t</svg>\n\t\n\t\t\x3c!-- header --\x3e\n\t\t<router-outlet></router-outlet>\n\t\t\x3c!-- footer --\x3e\n\t\t<div class="toast-outlet" toast-outlet></div>\n\t\t<div class="modal-outlet" modal-outlet></div>\n\t'};const Ta=["bmp","gif","ico","jpeg","jpg","png","svg","tif","tiff","webp","hdr"],ba=["mp4","avi","mpeg","ogv","ts","webm","3gp","3g2"],ya=["fbx","gltf","glb","obj","usdz"],Ca=["publisherStream","nextAttendeeStream","publisherScreen","attendeeScreen"];class wa extends t.Pipe{static transform(t,e){if(void 0===e&&(e=null),null!=e&&(t=t.type.name===e?t:null),t){if("string"==typeof t)return x.getPath(t);switch(t.type.name){case ns.Image.name:case ns.Video.name:case ns.Model.name:t=t.folder+t.file,t=x.getPath(t);break;case ns.PublisherStream.name:case ns.AttendeeStream.name:case ns.PublisherScreen.name:case ns.AttendeeScreen.name:case ns.SmartDeviceStream.name:t=x.getPath(t.file);break;default:i=t.file,new RegExp(`/.(${Ta.join("|")})$/i`).test(i)||function(t){return new RegExp(`/.(${ba.join("|")})$/i`).test(t)}(t.file)?(t=t.folder+t.file,t=x.getPath(t)):!function(t){return new RegExp(`/.(${ya.join("|")})$/i`).test(t)}(t.file)?function(t){return-1!==Ca.indexOf(t)}(t.file)&&(t=t.file):(t=t.folder+t.file,t=x.getPath(t))}}else t=null;var i;return t}}wa.meta={name:"asset"};class Ra extends t.Component{onInit(){super.onInit();const{parentInstance:e}=t.getContext(this);e instanceof Zn&&(this.data=e.modal.data)}onAccept(t){an.resolve()}onReject(t){an.reject()}onClose(){an.reject()}}Ra.meta={selector:"[control-request-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">L\'utente ha richiesto il controllo della navigazione. Accetti?</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--cancel" (click)="onReject()">\n\t\t\t\t\t\t<span>Rifiuta</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onAccept()">\n\t\t\t\t\t\t<span>Accetta</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},Ra.chunk=()=>'<div class="control-request-modal" control-request-modal></div>';class Ia extends t.Directive{onInit(){const{module:e,node:s,parentInstance:o,selector:r}=t.getContext(this),a="drop",c=i.fromEvent(s,a).pipe(n.shareReplay(1)),d=s.getAttribute("(drop)");if(d){const t=e.makeFunction(d,["$event"]);c.pipe(n.takeUntil(this.unsubscribe$)).subscribe((i=>{e.resolve(t,o,i)})),i.fromEvent(s,"dragover").pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>t.preventDefault()))}else o.drop$=c}}Ia.meta={selector:"[(drop)]"};let Aa=1e6;class Oa extends t.Directive{get id(){return this.dropdown||this.id_||(this.id_=Oa.nextId())}onInit(){const{node:e}=t.getContext(this),i=e.getAttribute("dropdown-trigger");this.trigger=i?e.querySelector(i):e,this.opened=null,this.onClick=this.onClick.bind(this),this.onDocumentClick=this.onDocumentClick.bind(this),this.openDropdown=this.openDropdown.bind(this),this.closeDropdown=this.closeDropdown.bind(this),this.addListeners(),Oa.dropdown$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.id===t?e.classList.add("dropped"):e.classList.remove("dropped")}))}onClick(e){const{node:i}=t.getContext(this);if(null===this.opened)this.openDropdown();else{i.querySelector("[dropdown-item]")||this.closeDropdown()}}onDocumentClick(e){const{node:i}=t.getContext(this);i===e.target||i.contains(e.target)||this.closeDropdown()}openDropdown(){null===this.opened&&(this.opened=!0,this.addDocumentListeners(),Oa.dropdown$.next(this.id),this.dropped.next(this.id))}closeDropdown(){null!==this.opened&&(this.removeDocumentListeners(),this.opened=null,Oa.dropdown$.getValue()===this.id&&(Oa.dropdown$.next(null),this.dropped.next(null)))}addListeners(){this.trigger.addEventListener("click",this.onClick)}addDocumentListeners(){document.addEventListener("click",this.onDocumentClick)}removeListeners(){this.trigger.removeEventListener("click",this.onClick)}removeDocumentListeners(){document.removeEventListener("click",this.onDocumentClick)}onDestroy(){this.removeListeners(),this.removeDocumentListeners()}static nextId(){return Aa++}}Oa.meta={selector:"[dropdown]",inputs:["dropdown","dropdown-trigger"],outputs:["dropped"]},Oa.dropdown$=new i.BehaviorSubject(null);class Na extends t.Directive{get id(){return this["dropdown-item"]}onInit(){const{node:e}=t.getContext(this);e.classList.add("dropdown-item"),Oa.dropdown$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.id===t?e.classList.add("dropped"):e.classList.remove("dropped")}))}}Na.meta={selector:"[dropdown-item], [[dropdown-item]]",inputs:["dropdown-item"]};class ka extends t.Component{onInit(){this.toast=null,this.lastToast=null,Xn.toast$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t&&(this.lastToast=t),this.toast=t,this.pushChanges()}))}getClass(){const t={};return this.toast&&(t.active=!0),this.lastToast&&(t[this.lastToast.type]=!0,t[this.lastToast.position]=!0),t}onClose(){Xn.reject(this.toast)}onAccept(){Xn.resolve(this.toast)}onReject(){Xn.reject(this.toast)}}ka.meta={selector:"[toast-outlet]",template:'\n\t<div class="toast-outlet__container" [class]="getClass()">\n\t\t<div class="toast-outlet__toast" *if="lastToast">\n\t\t\t<span class="toast-outlet__message" [innerHTML]="lastToast.message"></span>\n\t\t\t<div class="group--cta" *if="lastToast.type != \'info\'">\n\t\t\t\t<button type="button" class="btn--accept" (click)="onAccept()">\n\t\t\t\t\t<span [innerHTML]="lastToast.acceptMessage"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--cancel" (click)="onReject()" *if="lastToast.type == \'dialog\'">\n\t\t\t\t\t<span [innerHTML]="lastToast.rejectMessage"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t<button type="button" class="btn--close" (click)="onClose()" *if="lastToast.type != \'info\'">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t'};class La extends t.Component{onInit(){this.mode=1,this.viewTypes=Object.keys(fn).map((t=>{const e=fn[t];return{type:e,name:ge.getKeys("editor",e.name),disabled:-1!==x.editor.disabledViewTypes.indexOf(e.name)}})),this.viewItemTypes=Object.keys(vn).map((t=>{const e=vn[t];return{type:e,name:ge.getKeys("editor",e.name),disabled:-1!==x.editor.disabledViewItemTypes.indexOf(e.name)}})),this.setSupportedViewTypes(),this.setSupportedViewItemTypes()}onChanges(){this.setSupportedViewTypes(),this.setSupportedViewItemTypes()}setSupportedViewTypes(){this.supportedViewTypes=this.viewTypes.filter((t=>this.supportedViewType(t.type.name))).sort(((t,e)=>t.disabled===e.disabled?0:t.disabled?1:-1))}setSupportedViewItemTypes(){this.view?this.supportedViewItemTypes=this.viewItemTypes.filter((t=>this.supportedViewItemType(this.view.type.name,t.type.name))).sort(((t,e)=>t.disabled===e.disabled?0:t.disabled?1:-1)):this.supportedViewItemTypes=[]}setMode(t){this.mode!==t&&(this.mode=t,this.pushChanges())}supportedViewType(t){return-1!==[fn.Panorama.name,fn.PanoramaGrid.name,fn.Room3d.name,fn.Model.name,fn.Media.name].indexOf(t)}supportedViewItemType(t,e){let i;switch(t){case fn.WaitingRoom.name:i=!1;break;case fn.Panorama.name:case fn.PanoramaGrid.name:i=-1!==[vn.Nav.name,vn.Model.name,vn.Plane.name,vn.CurvedPlane.name].indexOf(e);break;case fn.Room3d.name:i=-1!==[vn.Nav.name,vn.Model.name,vn.Plane.name,vn.Texture.name].indexOf(e);break;case fn.Model.name:i=-1!==[vn.Nav.name,vn.Model.name,vn.Plane.name,vn.CurvedPlane.name].indexOf(e);break;case fn.Media.name:i=-1!==[].indexOf(e)}return i}onSelect(t){this.select.next(t)}onUpdate(t){this.update.next(t)}onDelete(t){this.delete.next(t)}}La.meta={selector:"[aside]",outputs:["select","update","delete"],inputs:["view"],template:'\n\t<div class="headline">\n\t\t<ul class="nav--tab">\n\t\t\t<li [class]="{ active: mode === 1 }" (click)="setMode(1)" [innerHTML]="\'editor_properties\' | label"></li>\n\t\t\t<li [class]="{ active: mode === 2 }" (click)="setMode(2)" [innerHTML]="\'editor_views\' | label"></li>\n\t\t\t<li [class]="{ active: mode === 3 }" (click)="setMode(3)" [innerHTML]="\'editor_view_items\' | label"></li>\n\t\t</ul>\n\t\t\x3c!--\n\t\t<div class="btn--mode" [class]="{ active: mode === 1 }" (click)="setMode(1)" [innerHTML]="\'editor_properties\' | label"></div>\n\t\t<div class="btn--mode" [class]="{ active: mode === 2 }" (click)="setMode(2)" [innerHTML]="\'editor_views\' | label"></div>\n\t\t<div class="btn--mode" [class]="{ active: mode === 3 }" (click)="setMode(3)" [innerHTML]="\'editor_view_items\' | label"></div>\n\t\t--\x3e\n\t</div>\n\t<div class="scrollable">\n\t\t<ul class="nav--editor" *if="mode === 1">\n\t\t\t<li>\n\t\t\t\t<div class="title" [innerHTML]="\'editor_properties\' | label"></div>\n\t\t\t\t<update-view [view]="view" (select)="onSelect($event)" (update)="onUpdate($event)" (delete)="onDelete($event)"></update-view>\n\t\t\t</li>\n\t\t\t<li *if="view.type.name != \'panorama-grid\'">\n\t\t\t\t<div class="title" [innerHTML]="\'editor_items\' | label"></div>\n\t\t\t\t<update-view-item [view]="view" [item]="item" (select)="onSelect($event)" (update)="onUpdate($event)" (delete)="onDelete($event)" *for="let item of view.pathItems"></update-view-item>\n\t\t\t\t<div class="abstract" *if="view.pathItems.length == 0" [innerHTML]="\'editor_no_items\' | label"></div>\n\t\t\t\t<div class="btn--mode" (click)="setMode(3)" [innerHTML]="\'editor_add_item\' | label"></div>\n\t\t\t</li>\n\t\t\t<li *if="view.type.name == \'panorama-grid\'">\n\t\t\t\t<div class="title" [innerHTML]="\'editor_tiles\' | label"></div>\n\t\t\t\t<div *for="let tile of view.tiles">\n\t\t\t\t\t<div *if="tile.selected">\n\t\t\t\t\t\t<update-view-tile [view]="view" [tile]="tile" (update)="onUpdate($event)" (delete)="onDelete($event)"></update-view-tile>\n\t\t\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<update-view-item [view]="view" [item]="item" (select)="onSelect($event)" (update)="onUpdate($event)" (delete)="onDelete($event)" *for="let item of tile.navs"></update-view-item>\n\t\t\t\t\t\t\t\t<div class="abstract" *if="tile.navs.length == 0" [innerHTML]="\'editor_no_navs\' | label"></div>\n\t\t\t\t\t\t\t\t<div class="btn--mode" (click)="onSelect({ type:\'viewItem\', value: \'nav\', tile: tile })" [innerHTML]="\'editor_add_nav\' | label"></div>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\x3c!--\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<div class="btn" (click)="onSelect({ type:\'viewItem\', value: \'nav\', tile: tile })">\n\t\t\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t\t\t<svg-icon name="nav"></svg-icon>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="title" [innerHTML]="\'editor_add_nav\' | label"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t--\x3e\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="abstract" *if="view.tiles.length == 0" [innerHTML]="\'editor_no_tiles\' | label"></div>\n\t\t\t\t\x3c!-- <div class="btn--mode" (click)="setMode(3)">Add Tile</div> --\x3e\n\t\t\t</li>\n\t\t\t\x3c!--\n\t\t\t<li *if="false">\n\t\t\t\t<div class="title">Icons</div>\n\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'animated-tabs\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 2 8.4 L 12 8.4 L 12 2 L 6 2 C 3.791 2 2 3.791 2 6 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 8.4 L 22 8.4 L 22 6 C 22 3.791 20.209 2 18 2 L 12 2 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Animated Tabs</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'card-list\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 6.8 13.6 C 6.8 13.158 7.158 12.8 7.6 12.8 L 16.8 12.8 C 17.242 12.8 17.6 13.158 17.6 13.6 L 17.6 16.8 C 17.6 17.242 17.242 17.6 16.8 17.6 L 7.6 17.6 C 7.158 17.6 6.8 17.242 6.8 16.8 Z" fill="var(--svg-icon-tint)"></path><path d="M 6.8 7.2 C 6.8 6.758 7.158 6.4 7.6 6.4 L 16.8 6.4 C 17.242 6.4 17.6 6.758 17.6 7.2 L 17.6 10.4 C 17.6 10.842 17.242 11.2 16.8 11.2 L 7.6 11.2 C 7.158 11.2 6.8 10.842 6.8 10.4 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Card List</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'container-transitions\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 15.667 13 C 17.139 13 18.333 14.194 18.333 15.667 C 18.333 17.139 17.139 18.333 15.667 18.333 C 14.194 18.333 13 17.139 13 15.667 C 13 14.194 14.194 13 15.667 13 Z" fill="var(--svg-icon-tint)"></path></svg></svg></div>\n\t\t\t\t\t\t\t<div class="title">Container Transitions</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'dynamic-grid\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><g transform="translate(6.6 6.6)"><path d="M 6.048 0.8 C 6.048 0.358 6.406 0 6.848 0 L 10 0 C 10.442 0 10.8 0.358 10.8 0.8 L 10.8 3.952 C 10.8 4.394 10.442 4.752 10 4.752 L 6.848 4.752 C 6.406 4.752 6.048 4.394 6.048 3.952 Z" fill="var(--svg-icon-tint)" opacity="0.5"></path><path d="M 6.048 6.848 C 6.048 6.406 6.406 6.048 6.848 6.048 L 10 6.048 C 10.442 6.048 10.8 6.406 10.8 6.848 L 10.8 10 C 10.8 10.442 10.442 10.8 10 10.8 L 6.848 10.8 C 6.406 10.8 6.048 10.442 6.048 10 Z" fill="var(--svg-icon-tint)"></path><path d="M 0 0.8 C 0 0.358 0.358 0 0.8 0 L 3.952 0 C 4.394 0 4.752 0.358 4.752 0.8 L 4.752 3.952 C 4.752 4.394 4.394 4.752 3.952 4.752 L 0.8 4.752 C 0.358 4.752 0 4.394 0 3.952 Z" fill="var(--svg-icon-tint)"></path><path d="M 0 6.848 C 0 6.406 0.358 6.048 0.8 6.048 L 3.952 6.048 C 4.394 6.048 4.752 6.406 4.752 6.848 L 4.752 10 C 4.752 10.442 4.394 10.8 3.952 10.8 L 0.8 10.8 C 0.358 10.8 0 10.442 0 10 Z" fill="var(--svg-icon-tint)" opacity="0.5"></path></g></svg></div>\n\t\t\t\t\t\t\t<div class="title">Dynamic Grid</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'expand-on-tap\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 0 0 L 7.833 0" transform="translate(8.583 11.583) rotate(270 3.917 0.5)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 14.667 9.333 L 12 6.667 L 9.333 9.333" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 14.667 14.667 L 12 17.333 L 9.333 14.667" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"></path> </svg></div>\n\t\t\t\t\t\t\t<div class="title">Expand on Tap</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'image-gallery-2\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 10.333 7.333 C 10.886 7.333 11.333 7.781 11.333 8.333 L 11.333 10.333 C 11.333 10.886 10.886 11.333 10.333 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12.333 8.333 C 12.333 7.781 12.781 7.333 13.333 7.333 L 15.333 7.333 C 15.886 7.333 16.333 7.781 16.333 8.333 L 16.333 10.333 C 16.333 10.886 15.886 11.333 15.333 11.333 L 13.333 11.333 C 12.781 11.333 12.333 10.886 12.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.333 12.667 C 15.886 12.667 16.333 13.114 16.333 13.667 L 16.333 15.667 C 16.333 16.219 15.886 16.667 15.333 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Image Gallery 2</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'stories-ui\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 6.8 4.8 C 7.905 4.8 8.8 5.695 8.8 6.8 C 8.8 7.905 7.905 8.8 6.8 8.8 C 5.695 8.8 4.8 7.905 4.8 6.8 C 4.8 5.695 5.695 4.8 6.8 4.8 Z" fill="var(--svg-icon-tint)"></path><path d="M 12 4.8 C 13.105 4.8 14 5.695 14 6.8 C 14 7.905 13.105 8.8 12 8.8 C 10.895 8.8 10 7.905 10 6.8 C 10 5.695 10.895 4.8 12 4.8 Z" fill="var(--svg-icon-tint)"></path><path d="M 17.2 4.8 C 18.305 4.8 19.2 5.695 19.2 6.8 C 19.2 7.905 18.305 8.8 17.2 8.8 C 16.095 8.8 15.2 7.905 15.2 6.8 C 15.2 5.695 16.095 4.8 17.2 4.8 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Stories UI</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'todo-list\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8 12.333 L 10.5 14.833 L 16 9.333" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">To-Do List</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'toggle-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 17.333 15.333 C 18.438 15.333 19.333 16.229 19.333 17.333 C 19.333 18.438 18.438 19.333 17.333 19.333 C 16.229 19.333 15.333 18.438 15.333 17.333 C 15.333 16.229 16.229 15.333 17.333 15.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 17.333 10 C 18.438 10 19.333 10.895 19.333 12 C 19.333 13.105 18.438 14 17.333 14 C 16.229 14 15.333 13.105 15.333 12 C 15.333 10.895 16.229 10 17.333 10 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 17.333 4.667 C 18.438 4.667 19.333 5.562 19.333 6.667 C 19.333 7.771 18.438 8.667 17.333 8.667 C 16.229 8.667 15.333 7.771 15.333 6.667 C 15.333 5.562 16.229 4.667 17.333 4.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Toggle Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'bottom-sheet\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 10.333 C 22 10.886 21.552 11.333 21 11.333 L 3 11.333 C 2.448 11.333 2 10.886 2 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 2 13.333 C 2 12.781 2.448 12.333 3 12.333 L 21 12.333 C 21.552 12.333 22 12.781 22 13.333 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Bottom Sheet</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'draggable-sheet\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 2 14 C 2 12.895 2.895 12 4 12 L 20 12 C 21.105 12 22 12.895 22 14 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z M 10.667 15.333 L 13.333 15.333 C 13.702 15.333 14 15.035 14 14.667 C 14 14.298 13.702 14 13.333 14 L 10.667 14 C 10.298 14 10 14.298 10 14.667 C 10 15.035 10.298 15.333 10.667 15.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Draggable Sheet</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'modal-box\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 9.333 C 7.333 8.229 8.229 7.333 9.333 7.333 L 14.667 7.333 C 15.771 7.333 16.667 8.229 16.667 9.333 L 16.667 14.667 C 16.667 15.771 15.771 16.667 14.667 16.667 L 9.333 16.667 C 8.229 16.667 7.333 15.771 7.333 14.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Modal Box</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'side-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 11 2 C 11.552 2 12 2.448 12 3 L 12 21 C 12 21.552 11.552 22 11 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Side Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'input-form\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 11.667 7.333 C 11.667 7.333 11.667 7.333 11.667 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 9 C 16.667 9.552 16.219 10 15.667 10 L 13.333 10 L 13.333 15.667 C 13.333 16.219 12.886 16.667 12.333 16.667 L 11.667 16.667 C 11.114 16.667 10.667 16.219 10.667 15.667 L 10.667 10 L 8.333 10 C 7.781 10 7.333 9.552 7.333 9 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Input Form</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'loading-indicator\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 16.4 10.4 C 17.284 10.4 18 11.116 18 12 C 18 12.884 17.284 13.6 16.4 13.6 C 15.516 13.6 14.8 12.884 14.8 12 C 14.8 11.116 15.516 10.4 16.4 10.4 Z" fill="var(--svg-icon-tint)"></path><path d="M 12 10.4 C 12.884 10.4 13.6 11.116 13.6 12 C 13.6 12.884 12.884 13.6 12 13.6 C 11.116 13.6 10.4 12.884 10.4 12 C 10.4 11.116 11.116 10.4 12 10.4 Z" fill="var(--svg-icon-tint)"></path><path d="M 7.6 10.4 C 8.484 10.4 9.2 11.116 9.2 12 C 9.2 12.884 8.484 13.6 7.6 13.6 C 6.716 13.6 6 12.884 6 12 C 6 11.116 6.716 10.4 7.6 10.4 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Loading Indicator</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'radio-button-form\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 9.833 8.167 L 14.167 8.167 C 16.284 8.167 18 9.883 18 12 C 18 14.117 16.284 15.833 14.167 15.833 L 9.833 15.833 C 7.716 15.833 6 14.117 6 12 C 6 9.883 7.716 8.167 9.833 8.167 Z M 11.333 12 C 11.333 13.473 12.527 14.667 14 14.667 C 15.473 14.667 16.667 13.473 16.667 12 C 16.667 10.527 15.473 9.333 14 9.333 C 12.527 9.333 11.333 10.527 11.333 12 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Radio Button Form</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'checkbox-form\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8.651 6.931 C 7.911 6.738 7.238 7.411 7.431 8.151 L 9.363 15.558 C 9.592 16.435 10.775 16.58 11.208 15.784 L 13 12.5 L 16.284 10.708 C 17.08 10.275 16.935 9.092 16.058 8.863 Z" fill="var(--svg-icon-tint)"></path><path d="M 16 15.5 L 11 10.5" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Checkbox Form</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'splash-screen\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.757 13.414 C 6.976 12.633 6.976 11.367 7.757 10.586 L 10.586 7.757 C 11.367 6.976 12.633 6.976 13.414 7.757 L 16.243 10.586 C 17.024 11.367 17.024 12.633 16.243 13.414 L 13.414 16.243 C 12.633 17.024 11.367 17.024 10.586 16.243 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Splash Screen</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'timeout-transition\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1 5.8 C 1 3.149 3.149 1 5.8 1 L 18.2 1 C 20.851 1 23 3.149 23 5.8 L 23 18.2 C 23 20.851 20.851 23 18.2 23 L 5.8 23 C 3.149 23 1 20.851 1 18.2 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 12 6.72 C 14.916 6.72 17.28 9.084 17.28 12 C 17.28 14.916 14.916 17.28 12 17.28 C 9.084 17.28 6.72 14.916 6.72 12 C 6.72 9.084 9.084 6.72 12 6.72 Z M 11.34 12 C 11.34 12.365 11.635 12.66 12 12.66 L 14.2 12.66 C 14.565 12.66 14.86 12.365 14.86 12 C 14.86 11.635 14.565 11.34 14.2 11.34 L 12.66 11.34 L 12.66 9.8 C 12.66 9.435 12.365 9.14 12 9.14 C 11.635 9.14 11.34 9.435 11.34 9.8 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Timeout Transition</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'accordion-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 16 10.667 L 12 14.667 L 8 10.667" fill="transparent" stroke-width="2" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Accordion Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'drop-on-scroll\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 0 0 L 8 0" transform="translate(8.5 11.5) rotate(270 4 0.5)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 15.333 11.333 L 12 8 L 8.667 11.333" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Drop on Scroll</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'nested-scroll\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 7 C 21.82 7.552 21.372 8 20.82 8 L 2.82 8 C 2.267 8 1.82 7.552 1.82 7 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 1.82 17 C 1.82 16.448 2.267 16 2.82 16 L 20.82 16 C 21.372 16 21.82 16.448 21.82 17 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 8.82 10 C 8.82 9.448 9.267 9 9.82 9 L 20.82 9 C 21.372 9 21.82 9.448 21.82 10 L 21.82 14 C 21.82 14.552 21.372 15 20.82 15 L 9.82 15 C 9.267 15 8.82 14.552 8.82 14 Z" fill="var(--svg-icon-tint)"></path><path d="M 1.82 10 C 1.82 9.448 2.267 9 2.82 9 L 6.82 9 C 7.372 9 7.82 9.448 7.82 10 L 7.82 14 C 7.82 14.552 7.372 15 6.82 15 L 2.82 15 C 2.267 15 1.82 14.552 1.82 14 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Nested Scroll</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'star-rating\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 11.399 6.884 C 11.645 6.386 12.355 6.386 12.601 6.884 L 13.705 9.122 C 13.803 9.32 13.992 9.457 14.21 9.489 L 16.68 9.848 C 17.229 9.928 17.449 10.603 17.051 10.99 L 15.264 12.733 C 15.106 12.887 15.034 13.108 15.071 13.326 L 15.493 15.786 C 15.587 16.333 15.013 16.75 14.521 16.492 L 12.312 15.331 C 12.117 15.228 11.883 15.228 11.688 15.331 L 9.479 16.492 C 8.987 16.75 8.413 16.333 8.507 15.786 L 8.929 13.326 C 8.966 13.108 8.894 12.887 8.736 12.733 L 6.949 10.99 C 6.551 10.603 6.771 9.928 7.32 9.848 L 9.79 9.489 C 10.008 9.457 10.197 9.32 10.295 9.122 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Star Rating</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'swipe-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 17.33 C 2 16.595 2.595 16 3.33 16 L 21 16 C 21.552 16 22 16.448 22 17 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 2 10 C 2 9.448 2.448 9 3 9 L 14 9 C 14.552 9 15 9.448 15 10 L 15 14 C 15 14.552 14.552 15 14 15 L 3 15 C 2.448 15 2 14.552 2 14 Z M 19 9 C 20.657 9 22 10.343 22 12 C 22 13.657 20.657 15 19 15 C 17.343 15 16 13.657 16 12 C 16 10.343 17.343 9 19 9 Z" fill="var(--svg-icon-tint)"></path><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 7 C 22 7.552 21.552 8 21 8 L 3 8 C 2.448 8 2 7.552 2 7 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Swipe Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'switch-sheet\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 15.667 13.333 C 17.139 13.333 18.333 14.527 18.333 16 C 18.333 17.473 17.139 18.667 15.667 18.667 C 14.194 18.667 13 17.473 13 16 C 13 14.527 14.194 13.333 15.667 13.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 8.333 13.333 C 9.806 13.333 11 14.527 11 16 C 11 17.473 9.806 18.667 8.333 18.667 C 6.861 18.667 5.667 17.473 5.667 16 C 5.667 14.527 6.861 13.333 8.333 13.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Switch Sheet</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'tab-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 10 15.333 L 14 15.333 L 14 18.667 L 10 18.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 5.333 16.333 C 5.333 15.781 5.781 15.333 6.333 15.333 L 9.333 15.333 L 9.333 18.667 L 6.333 18.667 C 5.781 18.667 5.333 18.219 5.333 17.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 18.667 16.333 C 18.667 15.781 18.219 15.333 17.667 15.333 L 14.667 15.333 L 14.667 18.667 L 17.667 18.667 C 18.219 18.667 18.667 18.219 18.667 17.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Tab Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'wheel-picker\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 3.667 6 C 3.667 3.791 5.458 2 7.667 2 L 16.333 2 C 18.542 2 20.333 3.791 20.333 6 L 20.333 7 C 20.333 7.552 19.886 8 19.333 8 L 4.667 8 C 4.114 8 3.667 7.552 3.667 7 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 2 11 C 2 9.895 2.895 9 4 9 L 20 9 C 21.105 9 22 9.895 22 11 L 22 13 C 22 14.105 21.105 15 20 15 L 4 15 C 2.895 15 2 14.105 2 13 Z" fill="var(--svg-icon-tint)"></path><path d="M 3.667 17 C 3.667 16.448 4.114 16 4.667 16 L 19.333 16 C 19.886 16 20.333 16.448 20.333 17 L 20.333 18 C 20.333 20.209 18.542 22 16.333 22 L 7.667 22 C 5.458 22 3.667 20.209 3.667 18 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Wheel Picker</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'cover-flow\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 11.333 17.962 C 11.333 18.385 11.068 18.762 10.67 18.904 L 4.673 21.045 C 3.37 21.511 2 20.545 2 19.162 L 2 4.838 C 2 3.455 3.37 2.489 4.673 2.955 L 10.67 5.096 C 11.068 5.238 11.333 5.615 11.333 6.038 Z" fill="var(--svg-icon-tint)"></path><path d="M 22 4.838 C 22 3.455 20.63 2.489 19.327 2.955 L 13.33 5.096 C 12.932 5.238 12.667 5.615 12.667 6.038 L 12.667 17.962 C 12.667 18.385 12.932 18.762 13.33 18.904 L 19.327 21.045 C 20.63 21.511 22 20.545 22 19.162 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Cover Flow</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'cube-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6.743 C 2 5.898 2.531 5.144 3.327 4.859 L 9.997 2.477 C 10.648 2.245 11.333 2.727 11.333 3.419 L 11.333 20.581 C 11.333 21.273 10.648 21.755 9.997 21.523 L 3.327 19.141 C 2.531 18.856 2 18.102 2 17.257 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12.667 3.419 C 12.667 2.727 13.352 2.245 14.003 2.477 L 20.673 4.859 C 21.469 5.144 22 5.898 22 6.743 L 22 17.257 C 22 18.102 21.469 18.856 20.673 19.141 L 14.003 21.523 C 13.352 21.755 12.667 21.273 12.667 20.581 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Cube Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'flip-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 11.333 4.667 C 11.333 4.114 10.886 3.667 10.333 3.667 L 4 3.667 C 2.895 3.667 2 4.562 2 5.667 L 2 18.333 C 2 19.438 2.895 20.333 4 20.333 L 10.333 20.333 C 10.886 20.333 11.333 19.886 11.333 19.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 20 4.167 C 20 3.891 20.224 3.667 20.5 3.667 L 20.5 3.667 C 21.328 3.667 22 4.338 22 5.167 L 22 18.833 C 22 19.662 21.328 20.333 20.5 20.333 L 20.5 20.333 C 20.224 20.333 20 20.109 20 19.833 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 18.667 4.631 C 18.667 3.309 17.406 2.35 16.131 2.704 L 13.399 3.463 C 12.966 3.583 12.667 3.978 12.667 4.427 L 12.667 19.573 C 12.667 20.022 12.966 20.417 13.399 20.537 L 16.131 21.296 C 17.406 21.65 18.667 20.691 18.667 19.369 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Flip Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'parallax-scroll\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 6.667 C 12 5.562 12.895 4.667 14 4.667 L 17.333 4.667 C 18.438 4.667 19.333 5.562 19.333 6.667 L 19.333 10 C 19.333 11.105 18.438 12 17.333 12 L 14 12 C 12.895 12 12 11.105 12 10 Z" fill="var(--svg-icon-tint)"></path><path d="M 4.667 14 C 4.667 12.895 5.562 12 6.667 12 L 10 12 C 11.105 12 12 12.895 12 14 L 12 17.333 C 12 18.438 11.105 19.333 10 19.333 L 6.667 19.333 C 5.562 19.333 4.667 18.438 4.667 17.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Parallax Scroll</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'pile-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 6.5 4 C 6.224 4 6 3.776 6 3.5 L 6 3.5 C 6 2.672 6.672 2 7.5 2 L 16.5 2 C 17.328 2 18 2.672 18 3.5 L 18 3.5 C 18 3.776 17.776 4 17.5 4 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 4.5 7 C 4.224 7 4 6.776 4 6.5 L 4 6.5 C 4 5.672 4.672 5 5.5 5 L 18.5 5 C 19.328 5 20 5.672 20 6.5 L 20 6.5 C 20 6.776 19.776 7 19.5 7 Z" fill="var(--svg-icon-tint)" opacity="0.7"></path><path d="M 0 2.67 C 0 1.195 1.195 0 2.67 0 L 11.33 0 C 12.805 0 14 1.195 14 2.67 L 14 17.33 C 14 18.805 12.805 20 11.33 20 L 2.67 20 C 1.195 20 0 18.805 0 17.33 Z" transform="translate(5 5) rotate(-90 7 10)" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Pile Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'shuffle\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 15.174 10.452 L 16.708 9.06 L 15.174 7.667" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 15.174 16.333 L 16.708 14.94 L 15.174 13.548" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 16.145 9.06 C 16.145 9.06 13.982 8.542 12.617 9.679 C 11.252 10.815 11.829 12.213 10.776 13.548 C 9.724 14.882 7.708 14.94 7.708 14.94" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 16.145 14.823 C 16.145 14.823 13.982 15.34 12.617 14.204 C 11.252 13.068 11.829 11.669 10.776 10.335 C 9.724 9.001 7.708 8.942 7.708 8.942" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Shuffle</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'svg-animation\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8 12.333 L 10.5 14.833 L 16 9.333" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">SVG Animation</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'google-sheets\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7 8.667 C 7 8.206 7.373 7.833 7.833 7.833 L 7.833 7.833 C 8.294 7.833 8.667 8.206 8.667 8.667 L 8.667 8.667 C 8.667 9.127 8.294 9.5 7.833 9.5 L 7.833 9.5 C 7.373 9.5 7 9.127 7 8.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 7 12 C 7 11.54 7.373 11.167 7.833 11.167 L 7.833 11.167 C 8.294 11.167 8.667 11.54 8.667 12 L 8.667 12 C 8.667 12.46 8.294 12.833 7.833 12.833 L 7.833 12.833 C 7.373 12.833 7 12.46 7 12 Z" fill="var(--svg-icon-tint)"></path><path d="M 7 15.333 C 7 14.873 7.373 14.5 7.833 14.5 L 7.833 14.5 C 8.294 14.5 8.667 14.873 8.667 15.333 L 8.667 15.333 C 8.667 15.794 8.294 16.167 7.833 16.167 L 7.833 16.167 C 7.373 16.167 7 15.794 7 15.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 9.778 8.667 C 9.778 8.206 10.151 7.833 10.611 7.833 L 16.167 7.833 C 16.627 7.833 17 8.206 17 8.667 L 17 8.667 C 17 9.127 16.627 9.5 16.167 9.5 L 10.611 9.5 C 10.151 9.5 9.778 9.127 9.778 8.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 9.778 12 C 9.778 11.54 10.151 11.167 10.611 11.167 L 16.167 11.167 C 16.627 11.167 17 11.54 17 12 L 17 12 C 17 12.46 16.627 12.833 16.167 12.833 L 10.611 12.833 C 10.151 12.833 9.778 12.46 9.778 12 Z" fill="var(--svg-icon-tint)"></path><path d="M 9.778 15.333 C 9.778 14.873 10.151 14.5 10.611 14.5 L 16.167 14.5 C 16.627 14.5 17 14.873 17 15.333 L 17 15.333 C 17 15.794 16.627 16.167 16.167 16.167 L 10.611 16.167 C 10.151 16.167 9.778 15.794 9.778 15.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Google Sheets</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'map\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 11.82 6.504 C 14.029 6.504 15.82 8.282 15.82 10.476 C 15.82 10.698 15.801 10.915 15.766 11.127 C 15.359 14.488 13.033 16.581 12.155 17.261 C 12.051 17.341 11.976 17.437 11.82 17.437 C 11.663 17.437 11.586 17.34 11.481 17.258 C 10.6 16.576 8.28 14.483 7.873 11.127 C 7.838 10.915 7.82 10.698 7.82 10.476 C 7.82 8.282 9.61 6.504 11.82 6.504 Z M 9.486 10.644 C 9.486 11.933 10.531 12.977 11.82 12.977 C 13.108 12.977 14.153 11.933 14.153 10.644 C 14.153 9.355 13.108 8.311 11.82 8.311 C 10.531 8.311 9.486 9.355 9.486 10.644 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Map</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'signature-pad\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8.82 13.068 C 8.56 12.807 8.56 12.385 8.82 12.125 L 13.733 7.212 C 13.993 6.952 14.415 6.952 14.676 7.212 L 16.788 9.324 C 17.048 9.585 17.048 10.007 16.788 10.267 L 11.875 15.18 C 11.615 15.44 11.193 15.44 10.932 15.18 Z" fill="var(--svg-icon-tint)"></path><path d="M 3.096 0.303 C 3.318 0.17 3.6 0.33 3.6 0.589 L 3.6 3.732 C 3.6 3.991 3.318 4.151 3.096 4.018 L 0.953 2.732 C 0.521 2.473 0.521 1.848 0.953 1.589 Z" transform="translate(6.24 13.8) rotate(-45 1.8 2.16)" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Signature Pad</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'sound-effects\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 14.225 10.793 C 14.471 11.102 14.623 11.529 14.623 12 C 14.623 12.471 14.471 12.898 14.225 13.207" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 16.224 9.185 C 16.96 9.911 17.417 10.905 17.417 12 C 17.417 13.095 16.96 14.09 16.224 14.816" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 6.083 10.656 C 6.083 10.288 6.382 9.989 6.75 9.989 L 7.674 9.989 L 11.021 7.835 C 11.464 7.549 12.048 7.868 12.048 8.396 L 12.048 15.604 C 12.048 16.132 11.464 16.451 11.021 16.165 L 7.674 14.011 L 6.75 14.011 C 6.382 14.011 6.083 13.712 6.083 13.344 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Sound Effects</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'card-swipe\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 3.423 7.423 C 3.423 5.214 5.214 3.423 7.423 3.423 L 16.756 3.423 C 18.965 3.423 20.756 5.214 20.756 7.423 L 20.756 16.756 C 20.756 18.965 18.965 20.756 16.756 20.756 L 7.423 20.756 C 5.214 20.756 3.423 18.965 3.423 16.756 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 9.172 3.377 C 10.734 1.815 13.266 1.815 14.828 3.377 L 20.721 9.269 C 22.283 10.831 22.283 13.364 20.721 14.926 L 14.828 20.819 C 13.266 22.381 10.734 22.381 9.172 20.819 L 3.279 14.926 C 1.717 13.364 1.717 10.831 3.279 9.269 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Card Swipe</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'custom-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6.2 C 2 5.673 2.31 5.195 2.792 4.981 L 7.063 3.083 C 7.503 2.887 8 3.21 8 3.693 L 8 20.307 C 8 20.79 7.503 21.113 7.063 20.917 L 2.792 19.019 C 2.31 18.805 2 18.327 2 17.8 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 9.333 3.297 C 9.333 2.642 9.954 2.163 10.588 2.33 L 20.509 4.941 C 21.388 5.172 22 5.967 22 6.875 L 22 17.125 C 22 18.033 21.388 18.828 20.509 19.059 L 10.588 21.67 C 9.954 21.837 9.333 21.358 9.333 20.703 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Custom Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'drag-handle\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.333 2.667 L 2.667 0 L 0 2.667" transform="translate(5.667 10.667) rotate(-90 2.667 1.333)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 5.333 0 L 2.667 2.667 L 0 0" transform="translate(13 10.667) rotate(-90 2.667 1.333)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Drag Handle</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'dynamic-header\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 8 L 2 8 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Dynamic Header</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'image-panning\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 14 C 12 12.895 12.895 12 14 12 L 20 12 C 21.105 12 22 12.895 22 14 L 22 18 C 22 20.209 20.209 22 18 22 L 14 22 C 12.895 22 12 21.105 12 20 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Image Panning</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'input-data\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 10.333 C 16.667 10.886 16.219 11.333 15.667 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.667 12.667 C 16.219 12.667 16.667 13.114 16.667 13.667 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Input Data</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'input-validation\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 10.333 C 16.667 10.886 16.219 11.333 15.667 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.667 12.667 C 16.219 12.667 16.667 13.114 16.667 13.667 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Input Validation</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'like-animation\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.28 0 C 7.017 0 7.747 2.366 6.357 3.755 C 4.968 5.144 3.543 5.905 3.543 5.905 C 3.543 5.905 2.118 5.144 0.728 3.755 C -0.661 2.365 0.069 -0 1.806 0 C 3.543 0 3.543 1.701 3.543 1.701 C 3.543 1.701 3.543 0 5.28 0 Z" transform="translate(11.213 11.787) rotate(15 3.543 2.953)" fill="var(--svg-icon-tint)"></path><path d="M 5.28 0 C 7.017 -0 7.747 2.365 6.357 3.755 C 4.968 5.144 3.543 5.905 3.543 5.905 C 3.543 5.905 2.118 5.144 0.728 3.755 C -0.661 2.366 0.069 0 1.806 0 C 3.543 0 3.543 1.701 3.543 1.701 C 3.543 1.701 3.543 0 5.28 0 Z" transform="translate(5.701 6.669) rotate(-15 3.543 2.953)" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Like Animation</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'like-counter\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 14.778 7.333 C 17.556 7.333 18.724 11.072 16.502 13.268 C 14.279 15.464 12 16.667 12 16.667 C 12 16.667 9.721 15.464 7.498 13.268 C 5.276 11.072 6.444 7.333 9.222 7.333 C 12 7.333 12 10.022 12 10.022 C 12 10.022 12 7.333 14.778 7.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Like Counter</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'lock-screen\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 11 C 7.333 10.448 7.781 10 8.333 10 L 15.667 10 C 16.219 10 16.667 10.448 16.667 11 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 12 7.333 C 13.289 7.333 14.333 8.378 14.333 9.667 C 14.333 10.955 13.289 12 12 12 C 10.711 12 9.667 10.955 9.667 9.667 C 9.667 8.378 10.711 7.333 12 7.333 Z" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Lock Screen</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'long-press-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 16.667 10.667 C 17.771 10.667 18.667 11.562 18.667 12.667 C 18.667 13.771 17.771 14.667 16.667 14.667 C 15.562 14.667 14.667 13.771 14.667 12.667 C 14.667 11.562 15.562 10.667 16.667 10.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12 8 C 13.105 8 14 8.895 14 10 C 14 11.105 13.105 12 12 12 C 10.895 12 10 11.105 10 10 C 10 8.895 10.895 8 12 8 Z" fill="var(--svg-icon-tint)"></path><path d="M 7.333 10.667 C 8.438 10.667 9.333 11.562 9.333 12.667 C 9.333 13.771 8.438 14.667 7.333 14.667 C 6.229 14.667 5.333 13.771 5.333 12.667 C 5.333 11.562 6.229 10.667 7.333 10.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Long Press Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'perspective-3d\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 6.913 22 C 5.987 22 5.182 21.364 4.967 20.463 L 2.586 10.463 C 2.287 9.206 3.24 8 4.532 8 L 19.468 8 C 20.76 8 21.713 9.206 21.414 10.463 L 19.033 20.463 C 18.818 21.364 18.013 22 17.087 22 Z" fill="var(--svg-icon-tint)"></path><path d="M 3.833 7 C 3.557 7 3.333 6.776 3.333 6.5 L 3.333 6.5 C 3.333 5.672 4.005 5 4.833 5 L 19.167 5 C 19.995 5 20.667 5.672 20.667 6.5 L 20.667 6.5 C 20.667 6.776 20.443 7 20.167 7 Z" fill="var(--svg-icon-tint)" opacity="0.7"></path><path d="M 5.167 4 C 4.891 4 4.667 3.776 4.667 3.5 L 4.667 3.5 C 4.667 2.672 5.338 2 6.167 2 L 17.833 2 C 18.662 2 19.333 2.672 19.333 3.5 L 19.333 3.5 C 19.333 3.776 19.109 4 18.833 4 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Perspective 3D</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'progress-bar\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.153 17 C 5.153 16.08 5.899 15.333 6.82 15.333 L 16.82 15.333 C 17.74 15.333 18.486 16.08 18.486 17 L 18.486 17 C 18.486 17.92 17.74 18.667 16.82 18.667 L 6.82 18.667 C 5.899 18.667 5.153 17.92 5.153 17 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 5.153 17 C 5.153 16.08 5.899 15.333 6.82 15.333 L 11.486 15.333 C 12.407 15.333 13.153 16.08 13.153 17 L 13.153 17 C 13.153 17.92 12.407 18.667 11.486 18.667 L 6.82 18.667 C 5.899 18.667 5.153 17.92 5.153 17 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Progress Bar</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'scroll-progress\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 10.333 C 7.333 9.781 7.781 9.333 8.333 9.333 L 15.667 9.333 C 16.219 9.333 16.667 9.781 16.667 10.333 L 16.667 11.667 C 16.667 12.219 16.219 12.667 15.667 12.667 L 8.333 12.667 C 7.781 12.667 7.333 12.219 7.333 11.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 14.667 C 7.333 14.114 7.781 13.667 8.333 13.667 L 15.667 13.667 C 16.219 13.667 16.667 14.114 16.667 14.667 L 16.667 16 C 16.667 16.552 16.219 17 15.667 17 L 8.333 17 C 7.781 17 7.333 16.552 7.333 16 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 7.667 C 7.333 7.298 7.632 7 8 7 L 16 7 C 16.368 7 16.667 7.298 16.667 7.667 L 16.667 7.667 C 16.667 8.035 16.368 8.333 16 8.333 L 8 8.333 C 7.632 8.333 7.333 8.035 7.333 7.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 7.667 C 7.333 7.298 7.632 7 8 7 L 12.667 7 C 13.035 7 13.333 7.298 13.333 7.667 L 13.333 7.667 C 13.333 8.035 13.035 8.333 12.667 8.333 L 8 8.333 C 7.632 8.333 7.333 8.035 7.333 7.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Scroll Progress</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'show-password\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 10.6 12 C 10.6 11.227 11.227 10.6 12 10.6 L 12 10.6 C 12.773 10.6 13.4 11.227 13.4 12 L 13.4 12 C 13.4 12.773 12.773 13.4 12 13.4 L 12 13.4 C 11.227 13.4 10.6 12.773 10.6 12 Z" fill="var(--svg-icon-tint)"></path><path d="M 12.166 7.833 C 14.892 7.833 17.161 9.42 17.811 12 C 17.161 14.58 14.892 16.167 12.166 16.167 C 9.44 16.167 7.127 14.58 6.478 12 C 7.127 9.42 9.44 7.833 12.166 7.833 Z M 9.333 12 C 9.333 13.473 10.527 14.667 12 14.667 C 13.473 14.667 14.667 13.473 14.667 12 C 14.667 10.527 13.473 9.333 12 9.333 C 10.527 9.333 9.333 10.527 9.333 12 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Show Password</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'slider\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.667 12 L 18.333 12" stroke="var(--svg-icon-tint)" fill="transparent" opacity="0.4" stroke-width="2.67" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 12 8.333 C 14.025 8.333 15.667 9.975 15.667 12 C 15.667 14.025 14.025 15.667 12 15.667 C 9.975 15.667 8.333 14.025 8.333 12 C 8.333 9.975 9.975 8.333 12 8.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Slider</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'stories-drag\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.333 6.667 C 5.333 5.93 5.93 5.333 6.667 5.333 L 10 5.333 C 10.736 5.333 11.333 5.93 11.333 6.667 L 11.333 6.667 C 11.333 7.403 10.736 8 10 8 L 6.667 8 C 5.93 8 5.333 7.403 5.333 6.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12.667 6.667 C 12.667 5.93 13.264 5.333 14 5.333 L 17.333 5.333 C 18.07 5.333 18.667 5.93 18.667 6.667 L 18.667 6.667 C 18.667 7.403 18.07 8 17.333 8 L 14 8 C 13.264 8 12.667 7.403 12.667 6.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Stories: Drag</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'stories-tap\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.333 6.667 C 5.333 5.93 5.93 5.333 6.667 5.333 L 10 5.333 C 10.736 5.333 11.333 5.93 11.333 6.667 L 11.333 6.667 C 11.333 7.403 10.736 8 10 8 L 6.667 8 C 5.93 8 5.333 7.403 5.333 6.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 12.667 6.667 C 12.667 5.93 13.264 5.333 14 5.333 L 17.333 5.333 C 18.07 5.333 18.667 5.93 18.667 6.667 L 18.667 6.667 C 18.667 7.403 18.07 8 17.333 8 L 14 8 C 13.264 8 12.667 7.403 12.667 6.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Stories: Tap</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'toast-prompt\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18.333 C 22 20.542 20.209 22.333 18 22.333 L 6 22.333 C 3.791 22.333 2 20.542 2 18.333 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 6.333 C 15.13 6.333 17.667 8.87 17.667 12 C 17.667 15.13 15.13 17.667 12 17.667 C 8.87 17.667 6.333 15.13 6.333 12 C 6.333 8.87 8.87 6.333 12 6.333 Z" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)"></path><path d="M 12 13 C 12.552 13 13 13.448 13 14 C 13 14.552 12.552 15 12 15 C 11.448 15 11 14.552 11 14 C 11 13.448 11.448 13 12 13 Z" fill="var(--svg-icon-tint)"></path><path d="M 11.06 9.998 C 11.027 9.457 11.458 9 12 9 L 12 9 C 12.542 9 12.973 9.457 12.94 9.998 L 12.848 11.535 C 12.821 11.983 12.449 12.333 12 12.333 L 12 12.333 C 11.551 12.333 11.179 11.983 11.152 11.535 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Toast Prompt</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</li>\n\t\t\t--\x3e\n\t\t</ul>\n\t\t<ul class="nav--editor" *if="mode === 2">\n\t\t\t<li>\n\t\t\t\t<div class="title" [innerHTML]="\'editor_views\' | label"></div>\n\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t<li *for="let item of supportedViewTypes">\n\t\t\t\t\t\t<div class="btn" [class]="{ disabled: item.disabled }" (click)="onSelect({ type:\'view\', value: item.type.name })">\n\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t<svg-icon [name]="item.type.name"></svg-icon>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="item.name"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</li>\n\t\t</ul>\n\t\t<ul class="nav--editor" *if="mode === 3">\n\t\t\t<li>\n\t\t\t\t<div class="title" [innerHTML]="\'editor_view_items\' | label"></div>\n\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t<li *for="let item of supportedViewItemTypes">\n\t\t\t\t\t\t<div class="btn" [class]="{ disabled: item.disabled }" (click)="onSelect({ type:\'viewItem\', value: item.type.name })" [title]="item.id">\n\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t<svg-icon [name]="item.type.name"></svg-icon>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="item.name"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t\t<div class="abstract" *if="supportedViewItemTypes.length == 0" [innerHTML]="\'editor_type_no_items\' | label"></div>\n\t\t\t</li>\n\t\t</ul>\n\t</div>\n\t'};let Pa=0;class Da{static set active(t){this.active$.next(t)}static get active(){return this.active$.getValue()}static menu$(){return this.getMenu$().pipe(n.switchMap((t=>(this.menu$_.next(t),this.menu$_))))}static getMenu$(){return yi.get$("/api/menu").pipe(n.map((t=>(t.menu.sort(((t,e)=>t.order-e.order)),t.menu))))}static updateMenu$(t){return yi.put$("/api/menu",t)}static createMenuItem$(t,e){void 0===t&&(t=null),void 0===e&&(e=0);const i={parentId:t,viewId:null,order:10*e,name:"Folder "+ ++Pa};return yi.post$("/api/menu",i)}static updateMenuItem$(t){return yi.put$(`/api/menu/${t.id}`,t)}static deleteMenuItem$(t){return yi.delete$(`/api/menu/${t.id}`)}static getModelMenu$(t,e){return void 0===e&&(e=!1),this.menu$().pipe(n.map((i=>{if(i&&i.length)return i=i.filter((e=>null==e.viewId||0==e.viewId||null!=t.find((t=>t.id===e.viewId)))),this.mapMenuItems(i);{const i={};t.forEach((t=>{if(t.type.name!==fn.WaitingRoom.name&&(!t.hidden||e)){let e=i[t.type.name];e||(e=i[t.type.name]=[]),e.push(t)}}));const n=Object.keys(i).map((i=>{let n="Button";switch(i){case fn.WaitingRoom.name:n="Waiting Room";break;case fn.Panorama.name:n="Experience";break;case fn.PanoramaGrid.name:n="Virtual Tour";break;case fn.Room3d.name:n="Stanze 3D";break;case fn.Model.name:n="Modelli 3D";break;case fn.Media.name:n="Media"}return{name:n,type:{name:"menu-group"},items:t.filter((t=>t.type.name===i&&(!t.hidden||e)))}}));return n}})))}static mapMenuItem(t,e){return t.viewId?{id:t.viewId,name:t.name,type:{name:"panorama"}}:{name:t.name,type:{name:"menu-group"},items:this.mapMenuItems(e,t.id)}}static mapMenuItems(t,e){return void 0===e&&(e=null),t.filter((t=>(t.parentId||null)===e)).map((e=>this.mapMenuItem(e,t))).filter((t=>null!=t.id||t.items.length>0))}}Da.active$=new i.BehaviorSubject(!1),Da.menu$_=new i.BehaviorSubject([]);class Ma{static drop$(e){if(t.isPlatformBrowser&&e){const t=document.querySelector("body");return i.merge(i.fromEvent(t,"drop"),i.fromEvent(t,"dragover")).pipe(n.map((t=>{t.preventDefault(),t.target===e&&(e.files=t.dataTransfer.files)})))}return i.EMPTY}static change$(e){return t.isPlatformBrowser&&e?i.fromEvent(e,"change").pipe(n.filter((t=>e.files&&e.files.length)),n.map((t=>Array.from(e.files)))):i.EMPTY}static asset$(t,e){return void 0===e&&(e=[]),this.change$(t).pipe(n.switchMap((t=>{e.length=t.length,e.fill(null);const s=t.map(((t,i)=>this.read$(t,i,e).pipe(n.map((()=>t)),n.switchMap((t=>ta.upload$([t]))),n.switchMap((t=>{const e=t[0],i=ls.fromUrl(e.url);return ta.assetCreate$(i)})))));return i.combineLatest(s)})))}static read$(t,e,s){void 0===s&&(s=[]);const o=new FileReader,r=i.fromEvent(o,"load").pipe(n.switchMap((t=>{const e=t.target.result;return this.resize$(e)})),n.tap((t=>{s[e]=t})));return o.readAsDataURL(t),r}static resize$(t){return i.from(this.resize_(t))}static resize_(t){return new Promise(((e,i)=>{const n=document.createElement("img");n.onload=function(){const t=document.createElement("canvas"),i=t.getContext("2d");let s=n.width,o=n.height;s>o?s>320&&(o*=320/s,s=320):o>240&&(s*=240/o,o=240),t.width=s,t.height=o,i.drawImage(n,0,0,s,o);const r=t.toDataURL("image/jpeg",.9);e(r)},n.onerror=function(){i(t)},n.src=t}))}}class xa extends t.Component{onChanges(){const{node:e}=t.getContext(this),i=this.control.flags;Object.keys(i).forEach((t=>{i[t]?e.classList.add(t):e.classList.remove(t)}))}}xa.meta={selector:"[control]",inputs:["control"]};class Ua extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||"image/png, image/jpeg";const{node:e}=t.getContext(this),s=e.querySelector("input");s.setAttribute("accept",this.accept),Ma.drop$(s).pipe(n.takeUntil(this.unsubscribe$)).subscribe(),Ma.change$(s).pipe(n.switchMap((t=>{const e=t.map(((t,e)=>ta.upload$([t]).pipe(n.switchMap((t=>ta.createOrUpdateAsset$(t,this.control))))));return i.combineLatest(e)})),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.control.value=t[0]}))}}Ua.meta={selector:"[control-asset]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--picture">\n\t\t\t\t<div class="group--picture__info">\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t</div>\n\t\t\t\t<img [lazy]="control.value | asset" [size]="{ width: 320, height: 240 }" *if="control.value && control.value.type.name === \'image\'" />\n\t\t\t\t<video [src]="control.value | asset" *if="control.value && control.value.type.name === \'video\'"></video>\n\t\t\t\t<input type="file">\n\t\t\t</div>\n\t\t\t<div class="file-name" *if="control.value" [innerHTML]="control.value.file"></div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Va extends Ua{static itemToFormGroup(t){return new e.FormGroup({id:t.id,parentId:t.parentId,viewId:t.viewId,name:t.name,items:new e.FormArray})}onInit(){this.dropdownId=Oa.nextId(),this.controls=this.control.controls,ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{this.controls.viewId.options=t}))}onAddItem(){Da.createMenuItem$(this.controls.id.value,this.controls.items.length).pipe(n.first()).subscribe((t=>{this.controls.items.push(Va.itemToFormGroup(t))}))}onRemoveItem(){this.remove.next(this.control)}onRemoveControl(t){Da.deleteMenuItem$(t.value).pipe(n.first()).subscribe((()=>{this.controls.items.remove(t)}))}onLinkItem(){this.link.next(this.control)}onLinkControl(t){this.link.next(t)}onItemUp(){this.up.next(this.control)}onItemDown(){this.down.next(this.control)}onUpControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n>0?n--:n=i-1,e.insert(t,n)}onDownControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n<i-1?n++:n=0,e.insert(t,n)}setView(t){const e=Object.assign({},this.control.value);e.viewId=t.id,t.id&&(e.name=t.name),Da.updateMenuItem$(e).pipe(n.first()).subscribe((()=>{this.controls.viewId.value=t.id,t.id&&(this.controls.name.value=t.name,this.controls.items.controls=[],this.controls.items.switchSubjects_())}))}onTextDidChange(t){Da.updateMenuItem$(this.control.value).pipe(n.first()).subscribe()}hasOption(t){return this.controls.viewId.value===t.id}onDropped(t){}}Va.meta={selector:"[control-menu]",outputs:["remove","link","up","down"],inputs:["control"],template:'\n\t\t<div class="group--form">\n\t\t\t<button type="button" class="control-menu__link" [class]="{ active: control.controls.viewId.value }" (click)="onLinkItem($event)" [dropdown]="dropdownId" (dropped)="onDropped($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#link"></use></svg>\n\t\t\t\t<div class="dropdown" [dropdown-item]="dropdownId">\n\t\t\t\t\t<div class="category">View</div>\n\t\t\t\t\t<ul class="nav--dropdown">\n\t\t\t\t\t\t<li (click)="setView(item)" [class]="{ empty: item.id == null }" *for="let item of control.controls.viewId.options">\n\t\t\t\t\t\t\t<span [class]="{ active: hasOption(item) }" [innerHTML]="item.name"></span>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</button>\n\t\t\t<input type="text" class="control--text" [formControl]="control.controls.name" placeholder="Name" (change)="onTextDidChange($event)" />\n\t\t\t\x3c!--\n\t\t\t<button type="button" class="control-menu__add" (click)="onAddItem($event)">\n\t\t\t\t<span [innerHTML]="control.controls.viewId.value"></span>\n\t\t\t</button>\n\t\t\t--\x3e\n\t\t\t\x3c!--\n\t\t\t<select class="control--select" [formControl]="control.controls.viewId">\n\t\t\t\t<option [value]="item.id" *for="let item of control.controls.viewId.options" [innerHTML]="item.name"></option>\n\t\t\t</select>\n\t\t\t--\x3e\n\t\t\t<button type="button" class="control-menu__up" (click)="onItemUp($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#up"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__down" (click)="onItemDown($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#down"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__add" (click)="onAddItem($event)" *if="!control.controls.viewId.value">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#add"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__remove" (click)="onRemoveItem($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#remove"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="group--items">\n\t\t\t<div control-menu *for="let sub of control.controls.items.controls" [control]="sub" (remove)="onRemoveControl($event)" (link)="onLinkControl($event)" (up)="onUpControl($event)" (down)="onDownControl($event)"></div>\n\t\t</div>\n\t'};class Fa extends t.Component{onInit(){this.changes=0,this.form=null,Da.getMenu$().pipe(n.first()).subscribe((t=>this.initForm(t)))}initForm(t){void 0===t&&(t=[]);const i=this.menuToControls(t),s=this.form=new e.FormGroup({items:i});this.controls=s.controls,s.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.changes++,this.pushChanges()}))}onLinkControl(t){}onUpControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n>0?n--:n=i-1,e.insert(t,n)}onDownControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n<i-1?n++:n=0,e.insert(t,n)}onAddItem(){Da.createMenuItem$(null,this.controls.items.length).pipe(n.first()).subscribe((t=>{this.controls.items.push(Va.itemToFormGroup(t))}))}onRemoveControl(t){Da.deleteMenuItem$(t.value).pipe(n.first()).subscribe((()=>{this.controls.items.remove(t)}))}isValid(){return this.form.valid}onSubmit(t){if(this.form.valid){const t=this.form.value,e=this.controlsToMenu(t);Da.updateMenu$(e)}else this.form.touched=!0}menuToControls(t,i){void 0===i&&(i=null);return new e.FormArray(t.filter((t=>(t.parentId||null)===i)).map((i=>{const n=this.menuToControls(t,i.id);return new e.FormGroup({id:i.id,parentId:i.parentId,viewId:i.viewId,name:i.name,items:n})})))}controlsToMenu(t){const e=[],i=t=>{t&&t.forEach(((t,n)=>{const s=Object.assign({},t);s.order=10*n,delete s.items,e.push(s),i(t.items)}))};return i(t.items),e}}Fa.meta={selector:"[menu-builder]",inputs:["views"],template:'\n\t<div class="group--head">\n\t\t<div class="title" [innerHTML]="\'editor_menu\' | label"></div>\n\t</div>\n\t<div class="group--main">\n\t\t<div class="nav--tree" *if="form">\n\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t<div class="abstract" *if="controls.items.controls.length == 0" [innerHTML]="\'editor_add_item\' | label"></div>\n\t\t\t\t<div *for="let control of controls.items.controls">\n\t\t\t\t\t<div control-menu [control]="control" (remove)="onRemoveControl($event)" (link)="onLinkControl($event)" (up)="onUpControl($event)" (down)="onDownControl($event)"></div>\n\t\t\t\t</div>\n\t\t\t</form>\n\t\t</div>\n\t</div>\n\t<div class="group--foot">\n\t\t<button type="button" class="btn--mode" (click)="onAddItem($event)" [innerHTML]="\'editor_add\' | label"></button>\n\t\t<button type="button" class="btn--mode" (click)="isValid() && onSubmit()" *if="changes > 1" [innerHTML]="\'editor_save\' | label"></button>\n\t</div>\n\t'};class Ba extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Zn&&(e=i.modal.data),e}get navmap(){let t=null;const e=this.data;return e&&(t=e.navmap),t}get position(){let t=[0,0,0];const e=this.data;return e&&(t=[e.hit.x,e.hit.y,0]),t}onInit(){const t=this.position;this.error=null;const i=this.form=new e.FormGroup({type:vn.Nav,title:null,abstract:null,viewId:new e.FormControl(null,e.RequiredValidator()),keepOrientation:!1,important:!1,transparent:!1,position:new e.FormControl(t,e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()})),ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{this.controls.viewId.options=t,this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=Object.assign({},this.form.value);t.viewId=parseInt(t.viewId),jn.itemCreate$(this.navmap,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("NavmapItemModalComponent.onSubmit.error",t),this.error=t,this.form.submitted=!1}))}else this.form.touched=!0}onClose(){an.reject()}}Ba.meta={selector:"[navmap-item-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Map Nav.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.title" label="Title"></div>\n\t\t\t\t\t\t<div control-textarea [control]="controls.abstract" label="Abstract"></div>\n\t\t\t\t\t\t<div control-custom-select [control]="controls.viewId" label="NavToView"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="3" [disabled]="true"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},Ba.chunk=()=>'<div class="nav-modal" navmap-item-modal></div>';class ja extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={name:t.name,asset:t.asset};return jn.navmapCreate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("NavmapModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}ja.meta={selector:"[navmap-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Map.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/png"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="description">Formato immagine .png con trasparenza (2048x1024 o 1024x512)</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ja.chunk=()=>'<div class="panorama-modal" navmap-modal></div>';class Ha extends t.Component{onInit(){this.navmap=null,this.navmaps=[],jn.navmapGet$().pipe(n.first()).subscribe((t=>{this.navmaps=t,this.pushChanges()}))}onBack(t){this.navmap=null,this.pushChanges()}onAdd(){an.open$({template:ja.chunk()}).pipe(n.first()).subscribe((t=>{t instanceof on&&(this.navmaps.push(t.data),this.navmap=t.data,this.pushChanges())}))}onSet(t){this.navmap=this.navmaps.find((e=>e.id===t.id)),this.pushChanges()}onAddItem(t,e){an.open$({template:Ba.chunk(),data:{navmap:t,hit:e}}).pipe(n.first()).subscribe((e=>{if(e instanceof on){const i=t.items||[];i.push(e.data),Object.assign(t,{items:i}),this.pushChanges()}}))}onDelete(t){const e=this.navmaps.indexOf(t);-1!==e&&this.navmaps.splice(e,1),this.navmap=null,this.pushChanges()}}Ha.meta={selector:"[navmap-builder]",inputs:["views"],template:'\n\t<div class="group--head">\n\t\t<div class="title" [innerHTML]="\'editor_navmaps\' | label"></div>\n\t</div>\n\t<div class="group--main">\n\t\t\x3c!-- listing navmaps --\x3e\n\t\t<div class="listing--navmaps" *if="!navmap">\n\t\t\t<div class="abstract" *if="navmaps.length == 0" [innerHTML]="\'editor_add_item\' | label"></div>\n\t\t\t<div class="listing__item" *for="let item of navmaps">\n\t\t\t\t<div class="card--navmap" (click)="onSet(item)">\n\t\t\t\t\t<div class="card__picture">\n\t\t\t\t\t\t<img [src]="item.asset | asset" *if="item.asset" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="card__content">\n\t\t\t\t\t\t<div class="card__name" [innerHTML]="item.name"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t\x3c!-- navmap edit --\x3e\n\t\t<div class="navmap" navmap-edit [navmap]="navmap" (delete)="onDelete($event)" *if="navmap">\n\t\t\t<form class="form" [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t<div class="title"><span [innerHTML]="navmap.name"></span> <span [innerHTML]="navmap.id"></span></div>\n\t\t\t\t<div class="form-controls">\n\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\x3c!--\n\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/png"></div>\n\t\t\t\t\t--\x3e\n\t\t\t\t</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t<span [innerHTML]="\'editor_save\' | label"></span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t\t<span [innerHTML]="\'editor_remove\' | label"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="navmap-control" [class]="mode">\n\t\t\t\t\t<div class="navmap-control__image">\n\t\t\t\t\t\t<img draggable="false" [src]="navmap.asset | asset" *if="navmap.asset" />\n\t\t\t\t\t\t<div class="navmap__item" [style]="{ left: item.position[0] * 100 + \'%\', top: item.position[1] * 100 + \'%\' }" (mousedown)="onMoveItem($event, item)" (click)="onRemoveItem(item)" *for="let item of navmap.items">\n\t\t\t\t\t\t\t<img draggable="false" [src]="\'textures/ui/nav-point.png\' | asset" />\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="item.title" *if="item.title"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ul class="navmap-control__toolbar">\n\t\t\t\t\t\t<li class="nav__item"><span [class]="{ active: mode === \'insert\' }" (click)="onToggleMode(\'insert\')"><svg class="pencil" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#pencil"></use></svg></span></li>\n\t\t\t\t\t\t<li class="nav__item"><span [class]="{ active: mode === \'move\' }" (click)="onToggleMode(\'move\')"><svg class="move" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#move"></use></svg></span></li>\n\t\t\t\t\t\t<li class="nav__item"><span [class]="{ active: mode === \'remove\' }" (click)="onToggleMode(\'remove\')"><svg class="erase" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#erase"></use></svg></span></li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</form>\n\t\t</div>\n\t</div>\n\t<div class="group--foot">\n\t\t<button type="button" class="btn--mode" (click)="onAdd($event)" [innerHTML]="\'editor_add\' | label" *if="!navmap"></button>\n\t\t<button type="button" class="btn--mode" (click)="onBack($event)" [innerHTML]="\'editor_back\' | label" *if="navmap"></button>\n\t</div>\n\t'};const Ga="idle",Wa="insert",$a="remove",za="move";class qa{constructor(t,e){const i=t.getBoundingClientRect();this.x=(e.clientX-i.x)/i.width,this.y=(e.clientY-i.y)/i.height}}class Ka extends qa{}class Ya extends qa{}class Ja extends qa{}class Xa extends t.Component{onInit(){this.mode=Ga,this.error=null;const t=this.navmap,i=this.form=new e.FormGroup({name:new e.FormControl(t.name,e.RequiredValidator()),asset:new e.FormControl(t.asset,e.RequiredValidator())});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()})),this.insert$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((e=>{const i=e;an.open$({template:Ba.chunk(),data:{navmap:t,hit:i}}).pipe(n.first()).subscribe((e=>{if(e instanceof on){const i=t.items||[];i.push(e.data),Object.assign(t,{items:i}),this.pushChanges()}}))}))}insert$(){const{node:e}=t.getContext(this),s=e.querySelector(".navmap-control__image");return i.fromEvent(s,"pointerdown").pipe(n.filter((t=>this.mode===Wa)),n.map((t=>new Ka(s,t))))}onToggleMode(t){this.mode=this.mode===t?Ga:t,this.pushChanges()}onMoveItem(e,s){const o=this.navmap;switch(this.mode){case za:{const{node:r}=t.getContext(this),a=r.querySelector(".navmap-control__image"),c=s.position.slice(),d=new Ka(a,e),l=i.fromEvent(a,"mousemove").pipe(n.map((t=>new Ya(a,t))),n.tap((t=>{const e=t.x-d.x,i=t.y-d.y;s.position=[Math.max(0,Math.min(1,c[0]+e)),Math.max(0,Math.min(1,c[1]+i)),0],this.pushChanges()}))),h=i.fromEvent(a,"mouseup").pipe(n.map((t=>new Ja(a,t))),n.tap((t=>{const e=t.x-d.x,i=t.y-d.y;s.position=[Math.max(0,Math.min(1,c[0]+e)),Math.max(0,Math.min(1,c[1]+i)),0],jn.itemUpdate$(o,s).pipe(n.first()).subscribe((t=>{Object.assign(s,t),this.pushChanges()}))})));l.pipe(n.takeUntil(h)).subscribe();break}}}onRemoveItem(t){const e=this.navmap;if(this.mode===$a)jn.itemDelete$(e,t).pipe(n.first()).subscribe((i=>{const n=e.items||[],s=n.indexOf(t);-1!==s&&n.splice(s,1),Object.assign(e,{items:n}),this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e=Object.assign({items:[]},this.navmap,{name:t.name});jn.navmapUpdate$(e).pipe(n.first()).subscribe((t=>{Object.assign(this.navmap,t),this.pushChanges()}),(t=>{this.error=t,this.form.reset()}))}else this.form.touched=!0}onRemove(){const t=this.navmap;an.open$({template:ua.chunk(),data:{item:t}}).pipe(n.first()).subscribe((e=>{e instanceof on&&jn.navmapDelete$(t).pipe(n.first()).subscribe((e=>{this.delete.next(t)}))}))}}Xa.meta={selector:"[navmap-edit]",outputs:["delete"],inputs:["navmap"]};class Za extends t.Component{onInit(){this.busy=!1,this.active=!1,this.useHooks=Ii.enabled;const t=this.form=new e.FormGroup;this.controls=t.controls;const i=this.item;this.originalItem=Object.assign({},i),i.hasChromaKeyColor=!(!i.asset||!i.asset.chromaKeyColor),i.autoplay=i.asset&&i.asset.type.name===ns.Video.name?i.asset.autoplay:void 0,i.loop=i.asset&&i.asset.type.name===ns.Video.name?i.asset.loop:void 0,i.assetType=as(i).id,this.doUpdateForm(),t.changes$.subscribe((t=>{this.doUpdateItem(t),this.pushChanges()}))}getFlagsDidChange(t,e){return["hasChromaKeyColor","autoplay","loop"].reduce(((i,n)=>{const s=e[n]||!1,o=t[n]||!1;return i||s!==o}),!1)}getAssetDidChange(t,e){return ta.assetDidChange(t.asset,e.asset)}doUpdateItem(t){const e=this.item,s=this.getAssetDidChange(e,t),o=this.getFlagsDidChange(e,t);if(Object.assign(e,t),e.asset&&(e.asset.chromaKeyColor=e.hasChromaKeyColor?[0,1,0]:null,e.asset.autoplay=e.autoplay,e.asset.loop=e.loop),s||o){(e.asset?ta.assetUpdate$(e.asset):i.of(null)).pipe(n.switchMap((()=>ea.inferItemUpdate$(this.view,e))),n.first()).subscribe(),this.view.updateIndices(this.view.items),"function"==typeof e.onUpdateAsset&&e.onUpdateAsset()}"function"==typeof e.onUpdate&&e.onUpdate()}doUpdateForm(){const t=this.item,i=this.form;if(this.type&&this.type.name===t.type.name)Object.keys(this.controls).forEach((i=>{switch(i){case"link":break;case"links":{const n=t.links.map((t=>({title:t.title||null,href:t.href||null,target:"_blank"}))),s=this.controls[i];for(;s.controls.length>n.length;)s.remove(s.controls[s.controls.length-1]);for(;s.controls.length<n.length;)s.push(new e.FormGroup({title:new e.FormControl(null),href:new e.FormControl(null),target:"_blank"}));s.patch(n);break}case"hasChromaKeyColor":this.controls[i].value=!(!t.asset||!t.asset.chromaKeyColor);break;case"autoplay":this.controls[i].value=!(!t.asset||!t.asset.autoplay);break;case"loop":this.controls[i].value=!(!t.asset||!t.asset.loop);break;case"assetType":this.controls[i].value=as(t).id;break;default:this.controls[i].value=null!=t[i]?t[i]:null}}));else{let s;switch(this.type=t.type,Object.keys(this.controls).forEach((t=>{i.removeKey(t)})),t.type.name){case vn.Nav.name:s=this.useHooks?["id","type","title?","abstract?","viewId?","hook?","hookExtra?","keepOrientation?","important?","transparent?","position","rotation","scale","asset?","link?","links?"]:["id","type","title?","abstract?","viewId?","keepOrientation?","important?","transparent?","position","rotation","scale","asset?","link?","links?"];break;case vn.Plane.name:s=["id","type","position","rotation","scale","assetType?","asset?","hasChromaKeyColor?","autoplay?","loop?"];break;case vn.CurvedPlane.name:s=["id","type","position","rotation","scale","radius","height","arc","assetType?","asset?","hasChromaKeyColor?","autoplay?","loop?"];break;case vn.Texture.name:s=["id","type","assetType?","asset?","hasChromaKeyColor?","autoplay?","loop?"];break;case vn.Model.name:s=this.view.type.name===fn.Model?["id","type","asset?"]:["id","type","position","rotation","asset?"];break;default:s=["id","type"]}s.forEach((s=>{const o=-1!==s.indexOf("?");s=s.replace("?","");const r=null!=t[s]?t[s]:null;let a;switch(s){case"viewId":a=new e.FormControl(r,o?void 0:e.RequiredValidator()),ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{a.options=t,a.value=a.value||null,this.pushChanges()}));break;case"hook":if(a=new e.FormControl(r,o?void 0:e.RequiredValidator()),Ii.enabled){const t=x.webhook.methods.nav.map((t=>({id:t,name:t})));t.unshift({id:null,name:"select"}),a.options=t}a.value=a.value||null,this.pushChanges();break;case"assetType":a=new e.FormControl(r,o?void 0:e.RequiredValidator()),a.options=Object.keys(ss).map((t=>ss[t]));break;case"link":break;case"links":{const i=t.links;a=new e.FormArray(i.map((t=>new e.FormGroup({title:new e.FormControl(t.title),href:new e.FormControl(t.href),target:"_blank"}))));break}default:a=new e.FormControl(r,o?void 0:e.RequiredValidator())}i.add(a,s)})),this.controls=i.controls}}onAssetTypeDidChange(t){const e=this.item,s=as(e).id;if(t!==s){e.assetType=t;let s=i.of(null);t!==ss.ImageOrVideo.id&&(s=s.pipe(n.switchMap((()=>{const e=cs(t);return ta.assetCreate$(e)})))),s.pipe(n.first()).subscribe((t=>{this.controls.asset.value=t}))}}onChanges(t){this.doUpdateForm()}onSubmit(){if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();const t=this.form.value,e=Object.assign({},t);this.item.type.name===vn.Nav.name&&(e.viewId=e.viewId||this.view.id);const i=this.view,s=new Cn(e);ea.inferItemUpdate$(i,s).pipe(n.first()).subscribe((t=>{ea.inferItemUpdateResult$(i,s),this.update.next({view:i,item:s}),this.setTimeout((()=>{this.busy=!1,this.pushChanges()}))}),(t=>console.log("UpdateViewItemComponent.onSubmit.inferItemUpdate$.error",t)))}else this.form.touched=!0}onRemove(t){an.open$({template:ua.chunk(),data:{item:this.item}}).pipe(n.first()).subscribe((t=>{t instanceof on&&this.delete.next({view:this.view,item:this.item})}))}onSelect(t){this.select.next({view:this.view,item:this.item.selected?null:this.item})}getTitle(t){return ge.getKeys("editor",t.type.name)}onAddLink(t){this.controls.links.push(new e.FormGroup({title:new e.FormControl(null),href:new e.FormControl(null),target:"_blank"}))}onRemoveLink(t){this.controls.links.remove(t)}clearTimeout(){this.to&&clearTimeout(this.to)}setTimeout(t,e){void 0===e&&(e=300),this.clearTimeout(),"function"==typeof t&&(this.to=setTimeout(t,e))}onDestroy(){this.clearTimeout()}}Za.meta={selector:"update-view-item",outputs:["select","update","delete"],inputs:["view","item"],template:'\n\t\t<div class="group--headline" [class]="{ active: item.selected }" (click)="onSelect($event)">\n\t\t\t\x3c!-- <div class="id" [innerHTML]="item.id"></div> --\x3e\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon [name]="item.type.name"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title" [innerHTML]="getTitle(item)"></div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="item.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t\x3c!-- <div control-text [control]="controls.type" label="Type" [disabled]="true"></div> --\x3e\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'nav\'">\n\t\t\t\t<div control-text [control]="controls.title" label="Title"></div>\n\t\t\t\t<div control-textarea [control]="controls.abstract" label="Abstract"></div>\n\t\t\t\t<div control-custom-select [control]="controls.viewId" label="NavToView"></div>\n\t\t\t\t<div control-checkbox [control]="controls.keepOrientation" label="Keep Orientation"></div>\n\t\t\t\t<div control-checkbox [control]="controls.important" label="Important"></div>\n\t\t\t\t<div control-checkbox [control]="controls.transparent" label="Transparent"></div>\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="3"></div>\n\t\t\t\t<div *if="controls.transparent.value == true">\n\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2"></div>\n\t\t\t\t</div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image" accept="image/jpeg, image/png"></div>\n\n\t\t\t\t<div class="group--link" *for="let link of controls.links.controls">\n\t\t\t\t\t<div class="group--controls">\n\t\t\t\t\t\t<div control-text [control]="link.controls.title" label="Link Title"></div>\n\t\t\t\t\t\t<div control-text [control]="link.controls.href" label="Link Url"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button type="button" class="btn--remove" (click)="onRemoveLink(link)"><svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#remove"></use></svg></button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--update" (click)="onAddLink($event)">\n\t\t\t\t\t\t<span>Add Link</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div *if="useHooks">\n\t\t\t\t\t<div control-custom-select [control]="controls.hook" label="Hook"></div>\n\t\t\t\t\t<div control-text [control]="controls.hookExtra" label="Hook Extra"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'plane\' && view.type.name != \'media\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2"></div>\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Localized Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'plane\' && view.type.name == \'media\'">\n\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Localized Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'curved-plane\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t\x3c!-- <div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div> --\x3e\n\t\t\t\t<div control-number [control]="controls.radius" label="Radius" [precision]="2"></div>\n\t\t\t\t<div control-number [control]="controls.height" label="Height" [precision]="2"></div>\n\t\t\t\t<div control-number [control]="controls.arc" label="Arc" [precision]="0"></div>\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'texture\'">\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'model\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" *if="view.type.name !== \'model\'"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" *if="view.type.name !== \'model\'"></div>\n\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t'};class Qa extends t.Component{onInit(){this.busy=!1,this.active=!1;const t=this.form=new e.FormGroup({id:new e.FormControl(this.tile.id,e.RequiredValidator()),asset:new e.FormControl(this.tile.asset,e.RequiredValidator()),navs:new e.FormControl(this.tile.navs,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{const e=this.tile;Object.assign(e,t),"function"==typeof e.onUpdate&&e.onUpdate(),this.pushChanges()}))}onSubmit(){if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();const t=Object.assign({},this.form.value),e=this.view,i=t;this.update.next({view:e,tile:i}),this.setTimeout((()=>{this.busy=!1,this.pushChanges()}))}else this.form.touched=!0}onRemove(t){an.open$({template:ua.chunk(),data:{tile:this.tile}}).pipe(n.first()).subscribe((t=>{t instanceof on&&this.delete.next({view:this.view,tile:this.tile})}))}onSelect(t){this.select.next({view:this.view,tile:this.tile.selected?null:this.tile})}clearTimeout(){this.to&&clearTimeout(this.to)}setTimeout(t,e){void 0===e&&(e=300),this.clearTimeout(),"function"==typeof t&&(this.to=setTimeout(t,e))}onDestroy(){this.clearTimeout()}}Qa.meta={selector:"update-view-tile",outputs:["select","update","delete"],inputs:["view","tile"],template:'\n\t\t<div class="group--headline" [class]="{ active: tile.selected }" (click)="onSelect($event)">\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon name="tile"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title">Tile {{tile.id}}</div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="tile.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg, image/png"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t\x3c!--\n\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t--\x3e\n\t\t\t</div>\n\t\t</form>\n\t'};class tc extends t.Component{onInit(){this.busy=!1;const t=this.form=new e.FormGroup;this.controls=t.controls,this.doUpdateForm(),t.changes$.subscribe((t=>{this.doUpdateView(t),this.pushChanges()})),this.orbit$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(this.view.type.name){case fn.WaitingRoom.name:case fn.Panorama.name:case fn.PanoramaGrid.name:case fn.Room3d.name:case fn.Model.name:case fn.Media.name:this.form.patch({latitude:t.orientation.latitude,longitude:t.orientation.longitude,zoom:t.zoom})}}))}orbit$(){let t,e,i=null;return ki.in$.pipe(n.filter((t=>t.type===xe)),n.auditTime(Math.floor(1e3/15)),n.distinctUntilChanged(((n,s)=>{const o=t!==s.orientation.latitude||e!==s.orientation.longitude||i!==s.zoom;return t=s.orientation.latitude,e=s.orientation.longitude,i=s.zoom,!o})))}getAssetDidChange(t){const e=this.view;if(e.type.name===fn.PanoramaGrid.name)return!1;const i=ta.assetDidChange(e.asset,t.asset),n=ta.assetDidChange(e.ar?e.ar.usdz:null,t.usdz),s=ta.assetDidChange(e.ar?e.ar.gltf:null,t.gltf);return!!(i||n||s)}doUpdateView(t){this.getAssetDidChange(t)&&this.onSubmit()}doUpdateForm(){const t=this.view;if(!this.type||this.type.name!==t.type.name){this.type=t.type;const i=this.form;let n;switch(Object.keys(this.controls).forEach((t=>{i.removeKey(t)})),t.type.name){case fn.WaitingRoom.name:n=["id","type","name","latitude","longitude","zoom","asset"];break;case fn.Panorama.name:n=["id","type","name","hidden?","latitude","longitude","zoom","asset"];break;case fn.PanoramaGrid.name:n=["id","type","name","hidden?","latitude","longitude","zoom"];break;case fn.Room3d.name:case fn.Model.name:n=["id","type","name","hidden?","latitude","longitude","zoom","asset"];break;case fn.Media.name:n=["id","type","name","hidden?","asset"];break;default:n=["id","type","name"]}t.type.name!==fn.WaitingRoom.name&&x.flags.ar&&(n.push("usdz?"),n.push("gltf?")),n.forEach((n=>{const s=-1!==n.indexOf("?");switch(n=n.replace("?","")){case"latitude":case"longitude":{const s=t.orientation||{latitude:0,longitude:0};i.add(new e.FormControl(s[n],e.RequiredValidator()),n);break}case"usdz":case"gltf":i.add(new e.FormControl(t.ar&&t.ar[n]||null,s?void 0:e.RequiredValidator()),n);break;default:i.add(new e.FormControl(null!=t[n]?t[n]:null,s?void 0:e.RequiredValidator()),n)}})),this.controls=i.controls}}onChanges(t){this.doUpdateForm()}onSubmit(){if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();const t=Object.assign({},this.form.value);null!=t.latitude&&(t.orientation={latitude:t.latitude,longitude:t.longitude},delete t.latitude,delete t.longitude);const e=t.usdz||null,i=t.gltf||null;delete t.usdz,delete t.gltf,t.ar=e||i?{usdz:e,gltf:i}:null;const s=new _n(Object.assign({},this.view,t));ea.viewUpdate$(s).pipe(n.first()).subscribe((t=>{this.update.next({view:s}),this.setTimeout((()=>{this.busy=!1,this.pushChanges()}))}),(t=>console.log("UpdateViewComponent.onSubmit.viewUpdate$.error",t)))}else this.form.touched=!0}onRemove(t){an.open$({template:ua.chunk(),data:{item:this.item}}).pipe(n.first()).subscribe((t=>{t instanceof on&&this.delete.next({view:this.view})}))}onSelect(t){this.select.next({view:this.view.selected?null:this.view})}getTitle(t){return ge.getKeys("editor",t.type.name)}clearTimeout(){this.to&&clearTimeout(this.to)}setTimeout(t,e){void 0===e&&(e=300),this.clearTimeout(),"function"==typeof t&&(this.to=setTimeout(t,e))}onDestroy(){this.clearTimeout()}}tc.meta={selector:"update-view",outputs:["select","update","delete"],inputs:["view"],template:'\n\t\t<div class="group--headline" [class]="{ active: view.selected }" (click)="onSelect($event)">\n\t\t\t\x3c!-- <div class="id" [innerHTML]="view.id"></div> --\x3e\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon [name]="view.type.name"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title" [innerHTML]="getTitle(view)"></div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="view.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t\x3c!-- <div control-text [control]="controls.type" label="Type" [disabled]="true"></div> --\x3e\n\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'waiting-room\'">\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'panorama\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'panorama-grid\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'room-3d\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'model\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name != \'waiting-room\' && (\'ar\' | flag)">\n\t\t\t\t<div control-model [control]="controls.usdz" label="AR IOS (.usdz)" accept=".usdz"></div>\n\t\t\t\t<div control-model [control]="controls.gltf" label="AR Android (.glb)" accept=".glb"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--remove" *if="view.type.name != \'waiting-room\'" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t'};const ec=[La,ia,ga,na,Ha,Xa,ja,Ba,sa,Fa,oa,ra,ca,aa,da,la,ha,ua,pa,ka,Za,Qa,tc],ic=[];class nc extends t.Module{}nc.meta={imports:[],declarations:[...ec,...ic],exports:[...ec,...ic]};class sc extends t.Component{onClose(){an.reject()}}sc.meta={selector:"[iframe-modal]",inputs:["src"],template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="modal__content">\n\t\t\t<iframe [src]="src"></iframe>\n\t\t</div>\n\t'},sc.chunk=t=>`<div class="iframe-modal" iframe-modal src="${t}"></div>`;class oc extends t.Pipe{static transform(t){let e=x;const i=t.split(".");let n=i.shift();for(;i.length>0&&e[n];)e=e[n],n=i.shift();return e[n]||null}}oc.meta={name:"env"};class rc extends t.Pipe{static transform(t){return x.flags[t]||!1}}rc.meta={name:"flag"};class ac{constructor(t){this.file=t,this.name=t.name,this.type=ds(t.name),this.progress=0,this.size=t.size,this.uploading=!1,this.paused=!1,this.success=!1,this.complete=!1,this.error=null,this.preview=null}}class cc{constructor(t){t&&Object.assign(this,t)}}class dc extends cc{}class lc extends cc{}class hc extends cc{}class uc{constructor(){this.concurrent$=new i.BehaviorSubject(0),this.items$=new i.BehaviorSubject([]),this.events$=new i.ReplaySubject(1)}upload$(){const t=this.items$.getValue().filter((t=>!t.uploading));return i.combineLatest(t.map((t=>this.uploadItem$(t))))}uploadItem$(t){t.uploading=!0,this.events$.next(new dc({item:t}));const e=[t.file];return i.of(e).pipe(n.delayWhen((()=>this.concurrent$.pipe(n.filter((t=>t<4))))),n.tap((()=>this.concurrent$.next(this.concurrent$.getValue()+1))),n.first(),n.switchMap((t=>ta.upload$(t))),n.switchMap((e=>{const i=e[0];t.uploading=!1,t.complete=!0;const s=ls.fromUrl(i.url);return this.events$.next(new lc({item:t,asset:s})),ta.assetCreate$(s).pipe(n.tap((e=>{this.remove(t),this.events$.next(new hc({item:t,asset:e})),this.concurrent$.next(this.concurrent$.getValue()-1)})))})))}addItems(t){if(t&&t.length){const e=this.items$.getValue(),i=Array.from(t).map((t=>new ac(t)));e.push(...i),this.items$.next(e)}}remove(t){const e=this.items$.getValue(),i=e.indexOf(t);-1!==i&&e.splice(i,1),this.items$.next(e)}removeAll(){this.items$.next([])}drop$(e,s){if(t.isPlatformBrowser&&e){s=s||e;const t=document.querySelector("body");return i.merge(i.fromEvent(t,"drop"),i.fromEvent(t,"dragover")).pipe(n.map((t=>(t.preventDefault(),t.target===s&&this.addItems(t.dataTransfer.files),this.items$))))}return i.EMPTY}change$(e){return t.isPlatformBrowser&&e?i.fromEvent(e,"change").pipe(n.switchMap((t=>(e.files.length&&(this.addItems(e.files),e.value=""),this.items$)))):i.EMPTY}files$(t){return i.combineLatest(Array.from(t).map(((t,e)=>this.file$(t,e))))}file$(t,e){return this.read$(t,e).pipe(n.switchMap((()=>this.uploadFile$(t))))}read$(t,e){const s=new FileReader,o=i.fromEvent(s,"load").pipe(n.tap((t=>{const i=t.target.result;this.resize(i,(t=>{this.previews[e]=t,this.pushChanges()}))})));return s.readAsDataURL(t),o}uploadFile$(t){return ta.upload$([t]).pipe(n.switchMap((t=>{const e=t[0],i=ls.fromUrl(e.url);return ta.assetCreate$(i)})))}resize(t,e){if("function"==typeof e){const i=document.createElement("img");i.onload=function(){const t=document.createElement("canvas"),n=t.getContext("2d");let s=i.width,o=i.height;s>o?s>320&&(o*=320/s,s=320):o>240&&(s*=240/o,o=240),t.width=s,t.height=o,n.drawImage(i,0,0,s,o);const r=t.toDataURL("image/jpeg",.9);e(r)},i.src=t}}supported(){return(e=document.createElement("input")).type="file","files"in e&&!!((t=new XMLHttpRequest)&&"upload"in t&&"onprogress"in t.upload)&&!!window.FormData;var t,e}}class pc extends xa{get items(){return this.items_}set items(t){this.items_=t,this.uploadCount=t.reduce(((t,e)=>t+(e.uploading||e.completed?0:1)),0)}onInit(){this.label=this.label||"label",this.accept=this.accept||"image/png, image/jpeg",this.multiple=!1!==this.multiple,this.items=[],this.assets=this.control.value||[],this.hasFiles=!1;const{node:e}=t.getContext(this),i=e.querySelector("input");i.setAttribute("accept",this.accept);const s=e.querySelector(".upload-drop"),o=this.service=new uc;o.drop$(i,s).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.items=t,this.pushChanges()})),o.change$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.items=t,this.pushChanges()})),o.events$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof hc&&(this.assets.push(t.asset),this.control.value=this.assets),this.items=this.items_,this.pushChanges()}))}onUpload(){this.service.upload$().pipe(n.first()).subscribe()}onCancel(){this.service.removeAll()}onItemPause(t){}onItemResume(t){}onItemCancel(t){}onItemRemove(t){this.service.remove(t)}}pc.meta={selector:"[control-assets]",inputs:["control","label","multiple"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="listing--assets">\n\t\t\t\t<div class="listing__item" *for="let item of assets">\n\t\t\t\t\t<div class="upload-item">\n\t\t\t\t\t\t<div class="picture">\n\t\t\t\t\t\t\t<img [lazy]="item | asset" [size]="{ width: 320, height: 240 }" *if="item.type.name === \'image\'" />\n\t\t\t\t\t\t\t<video [src]="item | asset" *if="item.type.name === \'video\'"></video>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="name" [innerHTML]="item.file"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="listing__item" *for="let item of items">\n\t\t\t\t\t<div upload-item [item]="item" (pause)="onItemPause($event)" (resume)="onItemResume($event)" (cancel)="onItemCancel($event)" (remove)="onItemRemove($event)"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<div class="btn--browse">\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t\t<input type="file" accept="image/jpeg" multiple />\n\t\t\t\t</div>\n\t\t\t\t<div class="btn--upload" (click)="onUpload()" *if="uploadCount > 0" [innerHTML]="\'upload\' | label"></div>\n\t\t\t\t<div class="btn--cancel" (click)="onCancel()" *if="uploadCount > 0" [innerHTML]="\'cancel\' | label"></div>\n\t\t\t</div>\n\t\t\t<div class="upload-drop">\n    \t\t\t<span [innerHTML]="\'drag_and_drop_images\' | label"></span>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class mc extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Zn&&(e=i.modal.data),e}onInit(){console.log(this.data),this.page=null,fa.currentLanguagePage$(this.data.mode).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.page=t,this.pushChanges()}))}onClose(){an.reject()}}mc.meta={selector:"[generic-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container" *if="page">\n\t\t\t<h1 class="title" [innerHTML]="page.title"></h1>\n\t\t\t<div class="description" [innerHTML]="page.description"></div>\n\t\t</div>\n\t\t<div class="modal__footer">\n\t\t\t<button type="button" class="btn--accept" (click)="onClose()">\n\t\t\t\t<span [innerHTML]="\'title_close\' | label"></span>\n\t\t\t</button>\n\t\t</div>\n\t'},mc.chunk=()=>'<div class="generic-modal" generic-modal></div>';class gc extends xa{onInit(){this.label=this.label||"label",this.linksSubject=new i.ReplaySubject,this.links$().pipe(n.takeUntil(this.unsubscribe$)).subscribe()}onChanges(){const{node:e}=t.getContext(this),n=Array.prototype.slice.call(e.querySelectorAll("a"));this.linksSubject.next(n.length?i.fromEvent(n,"click"):i.EMPTY)}links$(){return this.linksSubject.pipe(n.switchAll(),n.tap((t=>{if(x.flags.gdprRoutes){const e=mc.chunk();an.open$({template:e,data:{mode:"privacy_policy"}}).pipe(n.first()).subscribe(),t.preventDefault()}})))}}gc.meta={selector:"[control-checkbox]",inputs:["control","label"],template:'\n\t\t<div class="group--form--checkbox" [class]="{ required: control.validators.length }">\n\t\t\t<label>\n\t\t\t\t<input type="checkbox" class="control--checkbox" [formControl]="control" [value]="true" />\n\t\t\t\t<span [innerHTML]="label | html"></span>\n\t\t\t</label>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class fc extends xa{onInit(){this.label=this.label||"label",this.dropped=!1,this.dropdownId=Oa.nextId(),Ns.typing$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.scrollToWord(t)}))}scrollToWord(e){const i=this.control.options||[];let n=-1;for(let t=0;t<i.length;t++){if(0===i[t].name.toLowerCase().indexOf(e.toLowerCase())){n=t;break}}if(-1!==n){const{node:e}=t.getContext(this),i=e.querySelector(".dropdown"),s=e.querySelector(".nav--dropdown").children[n];s&&i.scrollTo(0,s.offsetTop)}}setOption(t){let e;if(this.isMultiple){e=this.control.value||[];const i=e.indexOf(t.id);-1!==i?e.splice(i,1):e.push(t.id),e=e.length?e.slice():null}else e=t.id;this.control.value=e,this.change.next(e)}hasOption(t){if(this.isMultiple){return-1!==(this.control.value||[]).indexOf(t.id)}return this.control.value===t.id}getLabel(){let t=this.control.value;const e=this.control.options||[];if(this.isMultiple)return t=t||[],t.length?t.map((t=>{const i=e.find((e=>e.id===t||e.name===t));return i?i.name:""})).join(", "):"select";{const i=e.find((e=>e.id===t||e.name===t));return i?i.name:"select"}}onDropped(t){this.dropped&&null===t&&(this.control.touched=!0),this.dropped=t===this.dropdownId}get isMultiple(){return this.multiple&&!1!==this.multiple&&"false"!==this.multiple}}fc.meta={selector:"[control-custom-select]",outputs:["change"],inputs:["control","label","multiple"],template:'\n\t\t<div class="group--form--select" [class]="{ required: control.validators.length, multiple: isMultiple }" [dropdown]="dropdownId" (dropped)="onDropped($event)">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<span class="control--custom-select" [innerHTML]="getLabel() | label"></span>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t\t<div class="dropdown" [dropdown-item]="dropdownId">\n\t\t\t<div class="category" [innerHTML]="label"></div>\n\t\t\t<ul class="nav--dropdown" [class]="{ multiple: isMultiple }">\n\t\t\t\t<li (click)="setOption(item)" [class]="{ empty: item.id == null }" *for="let item of control.options">\n\t\t\t\t\t<span [class]="{ active: hasOption(item) }" [innerHTML]="item.name | label"></span>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</div>\n\t'};class vc extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1;const{node:e}=t.getContext(this),s=this.input=e.querySelector("input");i.merge(i.fromEvent(s,"input")).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidChange(t))),i.fromEvent(s,"blur").pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidBlur(t)))}onInputDidChange(t){}onInputDidBlur(t){this.control.touched=!0,this.value=this.input.value}}vc.meta={selector:"[control-link]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<input type="text" class="control--text" [formControl]="control" [placeholder]="label" [disabled]="disabled" />\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class _c extends xa{get localizedValue(){let t=this.control.value;if(t&&t.locale){const e=t.locale[this.currentLanguage];e&&(t=e)}return t}onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||"image/png, image/jpeg",this.languages=x.languages,this.currentLanguage=ve.lang;const{node:e}=t.getContext(this),s=e.querySelector("input");s.setAttribute("accept",this.accept),Ma.drop$(s).pipe(n.takeUntil(this.unsubscribe$)).subscribe(),Ma.change$(s).pipe(n.switchMap((t=>{const e=t.map(((t,e)=>ta.upload$([t]).pipe(n.switchMap((t=>(this.languages.length>1?ta.createOrUpdateLocalizedAsset$:ta.createOrUpdateAsset$)(t,this.control,this.currentLanguage))))));return i.combineLatest(e)})),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.control.value=t[0]}))}setLanguage(t){ve.setLanguage$(t).pipe(n.first()).subscribe((e=>{this.currentLanguage=t,this.pushChanges()}))}}_c.meta={selector:"[control-localized-asset]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--picture">\n\t\t\t\t<div class="group--picture__info">\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t</div>\n\t\t\t\t<img [lazy]="localizedValue | asset" [size]="{ width: 320, height: 240 }" *if="localizedValue && localizedValue.type.name === \'image\'" />\n\t\t\t\t<video [src]="localizedValue | asset" *if="localizedValue && localizedValue.type.name === \'video\'"></video>\n\t\t\t\t<input type="file">\n\t\t\t</div>\n\t\t\t<div class="file-name" *if="localizedValue" [innerHTML]="localizedValue.file"></div>\n\t\t\t<ul class="nav--languages" *if="languages.length > 1">\n\t\t\t\t<li class="nav__item" [class]="{ active: lang == currentLanguage }" (click)="setLanguage(lang)" [innerHTML]="lang" *for="let lang of languages"></li>\n\t\t\t</ul>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Ec extends Ua{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||".glb";const{node:e}=t.getContext(this),s=this.input=e.querySelector("input");s.setAttribute("accept",this.accept),Ma.change$(s).pipe(n.switchMap((t=>{const e=t.map(((t,e)=>ta.upload$([t]).pipe(n.switchMap((t=>ta.createOrUpdateAsset$(t,this.control))))));return i.combineLatest(e)})),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.control.value=t[0]}))}onRemove(t){ta.assetDelete$(this.control.value).pipe(n.first()).subscribe((()=>{this.control.value=null,this.input.value=null,this.control.touched=!0}))}read$(t,e){return i.of(t)}}Ec.meta={selector:"[control-model]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--model">\n\t\t\t\t<div class="file-name" *if="!control.value" [innerHTML]="\'select_file\' | label"></div>\n\t\t\t\t<div class="file-name" *if="control.value" [innerHTML]="control.value.file"></div>\n\t\t\t\t<div class="btn--upload"><input type="file"><span [innerHTML]="\'browse\' | label"></span></div>\n\t\t\t\t<div class="btn--remove" *if="control.value" (click)="onRemove($event)"><span [innerHTML]="\'remove\' | label"></span></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Sc extends xa{onInit(){this.label=this.label||"label",this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1}updateValue(t){this.control.value=t}}Sc.meta={selector:"[control-number]",inputs:["control","label","precision","increment","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="control--content control--number">\n\t\t\t\t<input-value label="" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value" (update)="updateValue($event)"></input-value>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Tc extends xa{onInit(){this.label=this.label||"label"}}Tc.meta={selector:"[control-password]",inputs:["control","label"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<input type="password" class="control--text" [formControl]="control" [placeholder]="label" />\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class bc extends xa{onInit(){this.label=this.label||"label"}}bc.meta={selector:"[control-select]",inputs:["control","label"],template:'\n\t\t<div class="group--form--select" [class]="{ required: control.validators.length }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<select class="control--select" [formControl]="control" required>\n\t\t\t\t<option [value]="null" [innerHTML]="\'select\' | label"></option>\n\t\t\t\t<option [value]="item.id" *for="let item of control.options" [innerHTML]="item.name"></option>\n\t\t\t</select>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class yc extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1}}yc.meta={selector:"[control-text]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t<input type="text" class="control--text" [formControl]="control" [placeholder]="label" [disabled]="disabled" />\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Cc extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1}}Cc.meta={selector:"[control-textarea]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form--textarea" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<textarea class="control--text" [formControl]="control" [placeholder]="label" [innerHTML]="label" rows="4" [disabled]="disabled"></textarea>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class wc extends xa{onInit(){this.label=this.label||"label",this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1}updateValue(t,e){const i=this.control.value;i[t]=e,this.control.value=i.slice()}}wc.meta={selector:"[control-vector]",inputs:["control","label","precision","increment","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="control--content control--vector">\n\t\t\t\t<input-value label="x" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[0]" (update)="updateValue(0, $event)"></input-value>\n\t\t\t\t<input-value label="y" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[1]" (update)="updateValue(1, $event)"></input-value>\n\t\t\t\t<input-value label="z" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[2]" (update)="updateValue(2, $event)"></input-value>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Rc extends t.Directive{onChanges(){const{node:e}=t.getContext(this);!0===this.disabled?(e.disabled=this.disabled,e.setAttribute("disabled",this.disabled)):(delete e.disabled,e.removeAttribute("disabled"))}}Rc.meta={selector:"input[disabled],textarea[disabled]",inputs:["disabled"]};class Ic extends xa{getLabel(t,e){return ge.transform(`error_${t}`)}}Ic.meta={selector:"errors-component",inputs:["control"],template:'\n\t<div class="inner" [style]="{ display: control.invalid && control.touched ? \'block\' : \'none\' }">\n\t\t<div class="error" *for="let [key, value] of control.errors">\n\t\t\t<span [innerHTML]="getLabel(key, value)"></span>\n\t\t\t\x3c!-- <span class="key" [innerHTML]="key"></span> <span class="value" [innerHTML]="value | json"></span> --\x3e\n\t\t</div>\n\t</div>\n\t'};class Ac extends t.Component{onInit(){this.label=this.label||"label",this.value=this.value||0,this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1,this.increment$(".btn--more",1).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.value+=t,this.update.next(this.value),this.pushChanges()})),this.increment$(".btn--less",-1).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.value+=t,this.update.next(this.value),this.pushChanges()}));const{node:e}=t.getContext(this),s=this.input=e.querySelector("input");i.merge(i.fromEvent(s,"input")).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidChange(t))),i.merge(i.fromEvent(s,"blur"),i.fromEvent(s,"keydown").pipe(n.filter((t=>"Enter"===t.key||13===t.keyCode)))).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidBlur(t)))}onInputDidChange(t){t.target.value=t.target.value.replace(/[^\d|\.|-]/g,"")}onInputDidBlur(t){const e=parseFloat(this.input.value);this.value!==e&&(isNaN(e)?this.input.value=this.getValue():(this.value=e,this.update.next(this.value)))}increment$(e,s){const{node:o}=t.getContext(this),r=o.querySelector(e);let a,c;return i.race(i.fromEvent(r,"mousedown"),i.fromEvent(r,"touchstart")).pipe(n.tap((()=>{c=this.increment,a=16})),n.switchMap((t=>i.interval(30).pipe(n.filter((t=>t%a==0)),n.map((()=>{const t=c*s;return a=Math.max(1,Math.floor(.85*a)),t})),n.takeUntil(i.race(i.fromEvent(r,"mouseup"),i.fromEvent(r,"touchend")))))))}getValue(){return this.value.toFixed(this.precision)}setValue(t){this.value+=this.increment*t,this.update.next(this.value),this.pushChanges()}}Ac.meta={selector:"input-value",outputs:["update"],inputs:["value","label","precision","increment","disabled"],template:'\n\t\t<div class="group--control" [class]="{ disabled: disabled }">\n\t\t\t<input type="text" class="control--text" [placeholder]="label" [value]="getValue()" [disabled]="disabled" />\n\t\t\t<div class="control--trigger">\n\t\t\t\t<div class="btn--more" (click)="setValue(1)">+</div>\n\t\t\t\t<div class="btn--less" (click)="setValue(-1)">-</div>\n\t\t\t</div>\n\t\t</div>\n\t'};class Oc extends t.Component{onInit(){this.env=L}onTest(t){this.test.next(t)}onReset(t){this.reset.next(t)}}Oc.meta={selector:"test-component",inputs:["form"],outputs:["test","reset"],template:'\n\t<div class="group--form--results" *if="env.DEVELOPMENT">\n\t\t<code [innerHTML]="form.value | json"></code>\n\t\t<button type="button" class="btn--mode" (click)="onReset($event)"><span>reset</span></button>\n\t\t<button type="button" class="btn--mode" (click)="onTest($event)"><span>test</span></button>\n\t</div>\n\t'};class Nc extends t.Directive{onChanges(e){const{node:i}=t.getContext(this);i.value=this.value,i.setAttribute("value",this.value)}}Nc.meta={selector:"[value]",inputs:["value"]};class kc extends t.Pipe{static transform(t){if(t){t=t.replace(/&#(\d+);/g,(function(t,e){return String.fromCharCode(parseInt(e))}));const e=['"',"&","'","<",">"," ","¡","¢","£","¤","¥","¦","§","¨","©","ª","«","¬","­","®","¯","°","±","²","³","´","µ","¶","·","¸","¹","º","»","¼","½","¾","¿","À","Á","Â","Ã","Ä","Å","Æ","Ç","È","É","Ê","Ë","Ì","Í","Î","Ï","Ð","Ñ","Ò","Ó","Ô","Õ","Ö","×","Ø","Ù","Ú","Û","Ü","Ý","Þ","ß","à","á","ã","ä","å","æ","ç","è","é","ê","ë","ì","í","î","ï","ð","ñ","ò","ó","ô","õ","ö","÷","ø","ù","ú","û","ü","ý","þ","ÿ","&","•","°","∞","‰","⋅","±","†","—","¬","µ","⊥","∥","€","£","¥","¢","©","®","™","α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","τ","υ","φ","χ","ψ","ω","Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω"],i=new RegExp(`(&${["quot","amp","apos","lt","gt","nbsp","iexcl","cent","pound","curren","yen","brvbar","sect","uml","copy","ordf","laquo","not","shy","reg","macr","deg","plusmn","sup2","sup3","acute","micro","para","middot","cedil","sup1","ordm","raquo","frac14","frac12","frac34","iquest","Agrave","Aacute","Acirc","Atilde","Auml","Aring","AElig","Ccedil","Egrave","Eacute","Ecirc","Euml","Igrave","Iacute","Icirc","Iuml","ETH","Ntilde","Ograve","Oacute","Ocirc","Otilde","Ouml","times","Oslash","Ugrave","Uacute","Ucirc","Uuml","Yacute","THORN","szlig","agrave","aacute","atilde","auml","aring","aelig","ccedil","egrave","eacute","ecirc","euml","igrave","iacute","icirc","iuml","eth","ntilde","ograve","oacute","ocirc","otilde","ouml","divide","oslash","ugrave","uacute","ucirc","uuml","yacute","thorn","yuml","amp","bull","deg","infin","permil","sdot","plusmn","dagger","mdash","not","micro","perp","par","euro","pound","yen","cent","copy","reg","trade","alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","omicron","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega","Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"].join(";)|(&")};)`,"g");return t=t.replace(i,(function(){for(let t=1;t<arguments.length;t++)if(arguments[t])return e[t-1]})),t}}}kc.meta={name:"html"};class Lc extends t.Directive{onChanges(){const{node:e}=t.getContext(this);e.setAttribute("id",this.id)}}Lc.meta={selector:"[id]",inputs:["id"]};class Pc extends t.Component{onInit(){this.showLanguages=!1,this.languageService=ve}setLanguage(t){this.languageService.setLanguage$(t).pipe(n.first()).subscribe((t=>{this.showLanguages=!1,this.pushChanges(),this.set.next()}))}toggleLanguages(){this.showLanguages=!this.showLanguages,this.pushChanges()}}Pc.meta={selector:"[language]",outputs:["set"],template:'\n\t\t<button type="button" class="btn--language" (click)="toggleLanguages()" *if="languageService.hasLanguages"><span [innerHTML]="languageService.activeLanguage.title"></span> <svg viewBox="0 0 8 5"><use xlink:href="#caret-down"></use></svg></button>\n\t\t<ul class="nav--language" *if="showLanguages">\n\t\t\t<li (click)="setLanguage(language)" *for="let language of languageService.languages"><span [innerHTML]="language.title"></span></li>\n\t\t</ul>\n\t'};class Dc{static get cache(){return this.cache_||(this.cache_={}),this.cache_}static get(t){return this.cache[t]}static set(t,e){this.cache[t]=e;const i=Object.keys(this.cache);i.length>100&&this.remove(i[0])}static remove(t){delete this.cache[t]}}class Mc extends t.Directive{onInit(){const{node:e}=t.getContext(this);e.classList.add("lazy"),this.input$=(new i.Subject).pipe(n.distinctUntilChanged(),n.switchMap((t=>{const n=Dc.get(t);return n?i.of(n):(e.classList.remove("lazyed"),this.lazy$(t))})),n.takeUntil(this.unsubscribe$)),this.input$.subscribe((t=>{Dc.set(this.lazy,t),e.setAttribute("src",t),e.classList.add("lazyed")}))}onChanges(){this.input$.next(this.lazy)}lazy$(e){const{node:s}=t.getContext(this);return class{static observer(){return this.observer_||(this.readySubject_=new i.BehaviorSubject(!1),this.observerSubject_=new i.Subject,this.observer_=new IntersectionObserver((t=>{this.observerSubject_.next(t)}))),this.observer_}static intersection$(t){if("IntersectionObserver"in window){const e=this.observer();return e.observe(t),this.observerSubject_.pipe(n.map((e=>e.find((e=>e.target===t)))),n.filter((t=>void 0!==t&&t.isIntersecting)),n.first(),n.finalize((()=>e.unobserve(t))))}return i.of({target:t})}}.intersection$(s).pipe(n.switchMap((()=>lo.load$(e,this.size))),n.first())}}Mc.meta={selector:"[lazy],[[lazy]]",inputs:["lazy","size"]};class xc extends t.Pipe{static transform(t){let e=xc.urlify(t);return e=xc.breakLines(e),e}static urlify(t){return t.replace(/(?:(?:https?|ftp):\/\/|\b(?:[a-z\d]+\.))(?:(?:[^\s()<>]+|\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))?\))+(?:\((?:[^\s()<>]+|(?:\(?:[^\s()<>]+\)))?\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))?/gim,(t=>`<a href="${t}" target="_blank">${t}</a>`))}static breakLines(t){return t.replace(/\n/gm,(t=>"<br>"))}}xc.meta={name:"message"};class Uc extends t.Component{onInit(){const{parentInstance:e}=t.getContext(this);e instanceof Zn&&(this.data=e.modal.data)}onClose(){an.reject()}}Uc.meta={selector:"[modal]"};class Vc extends t.Directive{constructor(){super(...arguments),this.path=void 0,this.segments=void 0,this.routerLink_=void 0}get routerLink(){return this.routerLink_}set routerLink(t){this.routerLink_=Array.isArray(t)?t:[t]}onInit(){this.routerLink$().pipe(n.takeUntil(this.unsubscribe$)).subscribe()}onChanges(){const{node:e}=t.getContext(this),i=this.routerLink;if(i.length){const t=te.buildUrl(...i);e.setAttribute("href",t)}else e.setAttribute("href","")}routerLink$(){const{node:e}=t.getContext(this);return i.fromEvent(e,"click").pipe(n.map((t=>(te.setRouterLink(...this.routerLink),t.preventDefault(),!1))))}getSegments(t){const e=[];return t.forEach((t=>{if("string"==typeof t){const e=/([^:]+)|\:([^\/]+)/g,i=t.matchAll(e);for(let t of i){const e=t[1],i=t[2];if(e);else if(i){({})[i]=null}}}else e.push(new RouteSegment("",{}))})),e}}Vc.meta={selector:"[routerLink]",inputs:["routerLink"]};class Fc extends t.Component{onInit(){super.onInit();const{parentInstance:e}=t.getContext(this);e instanceof Zn&&(this.data=e.modal.data)}onAccept(t){an.resolve()}onReject(t){an.reject()}onClose(){an.reject()}}Fc.meta={selector:"[support-request-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Un operatore è disponibile per un tour guidato.<br>Desideri Accettare?</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onAccept()">\n\t\t\t\t\t\t<span>Accetta</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--cancel" (click)="onReject()">\n\t\t\t\t\t\t<span>Rifiuta</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},Fc.chunk=()=>'<div class="support-request-modal" support-request-modal></div>';class Bc extends t.Structure{onInit(){this.update()}onChanges(){this.update()}update(){if(this.name_!==this.name){this.name_=this.name;const{node:e}=t.getContext(this);if(e.parentNode){const t="http://www.w3.org/2000/svg",i=document.createElementNS(t,"svg"),n=this.width||24,s=this.height||24;i.setAttribute("class",`icon--${this.name}`),i.setAttributeNS(null,"viewBox",`0 0 ${n} ${s}`),i.innerHTML=`<use xlink:href="#${this.name}"></use>`,i.rxcompId=e.rxcompId,i.classList.add(...e.classList),e.parentNode.replaceChild(i,e)}}}}Bc.meta={selector:"svg-icon",inputs:["name","width","height"]};class jc extends t.Directive{set title(e){if(this.title_!==e){this.title_=e;const{node:i}=t.getContext(this);e?i.setAttribute("title",e):i.removeAttribute("title")}}get title(){return this.title_}}jc.meta={selector:"[[title]]",inputs:["title"]};class Hc extends t.Component{onInit(){null===this.item.preview&&this.read$(this.item.file).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.item.preview=t,this.pushChanges()}))}read$(t){const e=new FileReader,s=i.fromEvent(e,"load").pipe(n.switchMap((t=>{const e=t.target.result;return this.item.type.name===ns.Image.name?this.resize$(e):i.of(e)})));return e.readAsDataURL(t),s}resize$(t){return new Promise(((e,i)=>{const n=document.createElement("img");n.onload=function(){const t=document.createElement("canvas"),i=t.getContext("2d");let s=n.width,o=n.height;s>o?s>320&&(o*=320/s,s=320):o>240&&(s*=240/o,o=240),t.width=s,t.height=o,i.drawImage(n,0,0,s,o);const r=t.toDataURL("image/jpeg",.9);e(r)},n.onerror=function(t){i(t)},n.src=t}))}onPause(){this.pause.next(this.item)}onResume(){this.resume.next(this.item)}onCancel(){this.cancel.next(this.item)}onRemove(){this.remove.next(this.item)}}Hc.meta={selector:"[upload-item]",outputs:["pause","resume","cancel","remove"],inputs:["item"],template:'\n\t<div class="upload-item" [class]="{ \'error\': item.error, \'success\': item.success }">\n\t\t<div class="picture">\n\t\t\t<img [lazy]="item.preview" [size]="{ width: 320, height: 240 }" *if="item.preview && item.type.name === \'image\'" />\n\t\t\t<video [src]="item.preview" *if="item.preview && item.type.name === \'video\'"></video>\n\t\t\t<svg class="spinner" width="24" height="24" viewBox="0 0 24 24" [class]="{ uploading: item.uploading }" *if="item.uploading"><use xlink:href="#spinner"></use></svg>\n\t\t</div>\n\t\t<div class="name">{{item.name}}</div>\n\t\t\x3c!--\n\t\t<div class="group--info">\n\t\t\t<div>progress: {{item.progress}}</div>\n\t\t\t<div>size: {{item.size}} bytes</div>\n\t\t\t<div>current speed: {{item.currentSpeed}} bytes/s</div>\n\t\t\t<div>average speed: {{item.averageSpeed}} bytes/s</div>\n\t\t\t<div>time ramining: {{item.timeRemaining}}s</div>\n\t\t\t<div>paused: {{item.paused}}</div>\n\t\t\t<div>success: {{item.success}}</div>\n\t\t\t<div>complete: {{item.complete}}</div>\n\t\t\t<div>error: {{item.error}}</div>\n\t\t</div>\n\t\t--\x3e\n\t\t\x3c!--\n\t\t<div class="group--cta" *if="!item.complete && item.uploading">\n\t\t\t<div class="btn--pause" (click)="onPause()">pause</div>\n\t\t\t<div class="btn--resume" (click)="onResume()">resume</div>\n\t\t\t<div class="btn--cancel" (click)="onCancel()">cancel</div>\n\t\t</div>\n\t\t--\x3e\n\t\t<div class="group--cta">\n\t\t\t<div class="btn--remove" (click)="onRemove()" *if="!item.complete">remove</div>\n\t\t</div>\n\t</div>\n\t'};class Gc extends t.Directive{set hls(t){this.hls_!==t&&(this.hls_=t,this.play(t))}get hls(){return this.hls_}play(e){const{node:i}=t.getContext(this);if(Hls.isSupported()){var n=new Hls;n.attachMedia(i),n.on(Hls.Events.MEDIA_ATTACHED,(()=>{n.loadSource(e),n.on(Hls.Events.MANIFEST_PARSED,((t,e)=>{i.play()}))}))}}}Gc.meta={selector:"[[hls]]",inputs:["hls"]};class Wc extends t.Context{constructor(t,e,i,n,s,o,r){super(r),this[t]=e,this[i]=n,this.index=s,this.count=o}get first(){return 0===this.index}get last(){return this.index===this.count-1}get even(){return this.index%2==0}get odd(){return!this.even}}const $c=1,zc=2,qc=3;class Kc extends t.Structure{onInit(){const{module:e,node:s}=t.getContext(this),o=s.firstElementChild,r=s.getAttribute("*virtual");s.removeAttribute("*virtual"),s.removeChild(o);const a=this.tokens=this.getExpressionTokens(r);this.virtualFunction=e.makeFunction(a.iterable),this.container=s,this.template=o,this.mode=this.mode||1,this.width=this.width||250,this.gutter=void 0!==this.gutter?this.gutter:20,this.reverse=!0===this.reverse,this.options={width:this.width,gutter:this.gutter,reverse:this.reverse,containerWidth:0,containerHeight:0,top:0,cols:[0]},this.cachedRects={},this.cachedInstances=[],this.cacheNodes=[],this.items$=new i.BehaviorSubject([]),this.update$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{}))}onChanges(e){const i=t.getContext(this),n=i.module.resolve(this.virtualFunction,i.parentInstance,this)||[];this.mode=this.mode||1,this.width=this.width||250,this.gutter=void 0!==this.gutter?this.gutter:20,this.options.width=this.width,this.updateView(!0),this.items$.next(n)}update$(){return this.updateView(!0),i.merge(this.scroll$(),this.resize$(),this.items$.pipe(n.distinctUntilChanged())).pipe(n.map((t=>this.updateForward())))}updateForward(){const t=this.options,e=this.items$.getValue(),i=e.length;this.container.position="relative";let n=0;const s=this.getWidth(),o=this.getGutter(s),r=[];for(let a=0,c=e.length;a<c;a++){const c=e[a];let d,l,h,u,p,m=this.cachedRects[a];if(m?(d=m.col,l=m.height,u=m.left):(d=this.getCol(),l=this.getHeight(s,c)),h=t.cols[d],this.intersect(h+t.top,h+l+t.top,0,t.containerHeight)){m||(u=this.getLeft(d,s,o));const e=this.cachedNode(a,a,c,i);e.style.position="absolute",e.style.top=h+"px",e.style.left=u+"px",e.style.width=s+"px",l!==e.offsetHeight&&(l=e.offsetHeight),p=h+l+t.gutter,n=Math.max(n,p),t.cols[d]=p,m?(m.height=l,m.bottom=p):this.cachedRects[a]={col:d,width:s,height:l,left:u,top:h,bottom:p},r.push(c)}else this.removeNode(a),p=h+l+t.gutter,t.cols[d]=p,n=Math.max(n,p)}let a=e.length;for(;a<this.cacheNodes.length;)this.removeNode(a),a++;this.cacheNodes.length=e.length;const c=this.container.parentNode;if(this.reverse&&n<c.offsetHeight-1){const t=c.offsetHeight-1-n;e.forEach(((e,n)=>{if(-1!==r.indexOf(e)){const s=this.cachedRects[n];this.cachedNode(n,n,e,i).style.top=s.top+t+"px"}})),this.container.style.height=c.offsetHeight-1+"px"}else this.container.style.height=`${n}px`;return r}getCols(){const t=this.options,e=Math.floor((t.containerWidth+t.gutter)/(t.width+t.gutter))||1;return new Array(e).fill(0)}getCol(){const t=this.options;let e;switch(this.mode){case zc:case qc:case $c:e=t.cols.reduce(((t,e,i,n)=>e<n[t]?i:t),0);break;default:e=0}return e}getWidth(){const t=this.options;let e;switch(this.mode){case zc:case qc:e=t.width;break;case $c:e=(t.containerWidth-(t.cols.length-1)*t.gutter)/t.cols.length;break;default:e=t.containerWidth}return e}getHeight(t,e){const i=this.options;let n;switch(this.mode){case zc:case qc:case $c:n=i.width;break;default:n=80}return n}getGutter(t){const e=this.options;let i;switch(this.mode){case zc:case qc:i=e.gutter;break;case $c:i=(e.containerWidth-e.cols.length*t)/(e.cols.length-1);break;default:i=0}return i}getLeft(t,e,i){const n=this.options;let s;switch(this.mode){case zc:case $c:s=t*(e+i);break;case qc:s=(n.containerWidth-n.cols.length*(e+i)+i)/2+t*(e+i);break;default:s=0}return s}cachedNode(t,e,i,n){return this.cacheNodes[t]?this.updateNode(t,e,i):this.createNode(t,e,i,n)}createNode(e,i,n,s){const o=this.template.cloneNode(!0);delete o.rxcompId,this.container.appendChild(o),this.cacheNodes[e]=o;const r=t.getContext(this),a=r.module,c=this.tokens,d=[c.key,i,c.value,n,i,s,r.parentInstance],l=a.makeInstance(o,Wc,r.selector,r.parentInstance,d),h=t.getContext(l);return a.compile(o,h.instance),this.cachedInstances[e]=l,o}updateNode(t,e,i){const n=this.cachedInstances[t],s=this.tokens;return n[s.key]!==e&&(n[s.key]=e,n[s.value]=i,n.pushChanges()),this.cacheNodes[t]}removeNode(e){this.cachedInstances[e]=void 0;const i=this.cacheNodes[e];if(i){const e=t.getContext(this).module;i.parentNode.removeChild(i),e.remove(i)}return this.cacheNodes[e]=void 0,i}intersect(t,e,i,n){return i<e&&n>t}resize$(){return i.fromEvent(window,"resize").pipe(n.startWith((t=>null)),n.auditTime(100),n.tap((()=>this.updateView(!0))))}scroll$(){const{node:e}=t.getContext(this);return e.parentNode&&"auto"===getComputedStyle(e.parentNode).overflowY?i.fromEvent(e.parentNode,"scroll").pipe(n.tap((()=>{this.updateView()}))):i.fromEvent(window,"scroll").pipe(n.tap((()=>this.updateView())))}updateView(t){const e=this.container.getBoundingClientRect(),i=this.options;i.top=e.top,i.containerWidth=e.width,i.containerHeight=this.container.parentNode.offsetHeight,i.cols=this.getCols(),t&&(this.cachedRects={})}getExpressionTokens(t){if(null===t)throw new Error("invalid virtual");if(-1===t.trim().indexOf("let ")||-1===t.trim().indexOf(" of "))throw new Error("invalid virtual");const e=t.split(";").map((t=>t.trim())).filter((t=>""!==t)),i=e[0].split(" of ").map((t=>t.trim()));let n=i[0].replace(/\s*let\s*/,"");const s=i[1];let o="index";const r=n.match(/\[(.+)\s*,\s*(.+)\]/);if(r&&(o=r[1],n=r[2]),e.length>1){const t=e[1].split(/\s*let\s*|\s*=\s*index/).map((t=>t.trim()));3===t.length&&(o=t[1])}return{key:o,value:n,iterable:s}}}Kc.meta={selector:"[*virtual]",inputs:["mode","width","gutter","reverse"]};class Yc extends t.Component{onInit(){this.playing=!1,this.progress=0,this.media$().pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.drag$().pipe(n.takeUntil(this.unsubscribe$)).subscribe()}media$(){const{node:e}=t.getContext(this),i=document.querySelector(".page");return bs.events$.pipe(n.filter((t=>t instanceof vs||t.loader===this.media)),n.tap((t=>{t instanceof vs?(this.media=t.loader,this.progress=0,this.playing=!0,e.classList.add("active"),i.classList.add("media-player-active"),this.pushChanges()):this.media===t.loader&&(t instanceof _s?(this.playing=!1,this.pushChanges()):t instanceof Ss?this.dragging||(this.progress=this.media.progress,this.pushChanges()):t instanceof Es&&(this.media=null,e.classList.remove("active"),i.classList.remove("media-player-active"),this.pushChanges()))})))}drag$(){const{node:e}=t.getContext(this),i=e.querySelector(".track");let s;return Xs.observe$(i).pipe(n.filter((t=>this.media)),n.tap((t=>{if(t instanceof qs){const e=i.getBoundingClientRect();s=Math.max(0,Math.min(1,(t.down.x-e.left)/e.width)),this.dragging=!0}else if(t instanceof Ks){const e=i.getBoundingClientRect(),n=Math.max(0,Math.min(1,s+t.distance.x/e.width));this.progress=n,this.pushChanges()}else t instanceof Ys&&(this.media.progress=this.progress,this.dragging=!1)})))}onPlay(){this.media.play()}onPause(){this.media.pause()}onTrack(t){const e=t.currentTarget.getBoundingClientRect(),i=(t.screenX-e.left)/e.width;this.media.progress=i}}Yc.meta={selector:"[media-player]"};const Jc=100.99;class Xc extends Gr{get title(){return this.title_}set title(t){if(this.title_!==t){const e=null!=this.title_;this.title_=t,e?this.updateBanner():this.createBanner()}}onChanges(){this.title=this.item.title}createBanner(){this.getCanvasTexture().then((t=>{const e=t.texture;e.wrapS=e.wrapY=THREE.RepeatWrapping,e.repeat.x=24,e.encoding=THREE.sRGBEncoding;const i=24*t.width/t.height,n=Math.PI/180*360,s=Jc*n/i,o=new THREE.CylinderBufferGeometry(Jc,Jc,s,80,2,!0,0,n);o.scale(-1,1,1);const r=new THREE.MeshBasicMaterial({map:e,transparent:!0,opacity:0,toneMapped:!1}),a=this.mesh;(this.banners=new Array(1).fill(0).map((t=>new THREE.Mesh(o,r)))).forEach(((t,e)=>{t.rotation.y=Math.PI/2*e}));const c={value:0};gsap.to(c,{duration:.5,value:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{r.opacity=c.value,r.needsUpdate=!0}}),a.userData={render:()=>{a.rotation.y+=Math.PI/180*.02,r.needsUpdate=!0}}}))}updateBanner(){this.getCanvasTexture().then((t=>{}))}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}getCanvasTexture(){return new Promise(((t,e)=>{let i=512,n=128;const s=Math.floor(102.4),o=Math.floor(9.6);let r;r=this.canvas?this.canvas:this.canvas=document.createElement("canvas"),r.width=i,r.height=n;const a=this.item.title,c=r.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.font=`${s}px ${x.fontFamily}`;let d;i=c.measureText(a).width+8,i=Math.max(512,Math.pow(2,Math.ceil(Math.log(i)/Math.log(2)))),r.width=i,c.clearRect(0,0,i,n),c.fillStyle="#0000005A",c.fillRect(0,0,i,n),c.font=`${s}px ${x.fontFamily}`,c.textAlign="center",c.textBaseline="middle",c.strokeStyle="rgba(0, 0, 0, 0.5)",c.lineWidth=o,c.lineJoin="round",c.miterLimit=2,c.strokeText(a,i/2,64),c.fillStyle="white",c.fillText(a,i/2,64,i),this.texture?(d=this.texture,d.needsUpdate=!0):d=this.texture=new THREE.CanvasTexture(r),t({texture:d,width:i,height:n})}))}}Xc.meta={selector:"[model-banner]",hosts:{host:Hr},inputs:["item"]};class Zc extends Wr{onInit(){super.onInit()}onChanges(){const t=this.item.selected;this.editing=t,this.mesh&&(this.mesh.editing=t)}onCreate(t,e){const i=this.item,s=this.view;s.items;const o=this.getCurvedPanelGeometry(i);let r,a;this.onMeshDown=this.onMeshDown.bind(this),this.onMeshPlaying=this.onMeshPlaying.bind(this),this.onMeshZoomed=this.onMeshZoomed.bind(this),this.onMeshCurrentTime=this.onMeshCurrentTime.bind(this),Ws.getStreamId$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe((c=>{this.streamId!==c&&(this.streamId=c,a&&(a.unsubscribe(),a=null),c||!i.asset?(i.streamId=c,r=this.disposableMesh=new Ws(i,s,o,this.host),r.updateFromItem(i),r.name="curved-plane",r.load((()=>{this.disposableMesh=null,"function"==typeof t&&t(r,i),a=r.events$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((()=>{}))})),this.addMeshListeners(r)):this.mesh&&e(this.mesh,i))}))}addMeshListeners(t){t.on("down",this.onMeshDown),t.on("playing",this.onMeshPlaying),t.on("zoomed",this.onMeshZoomed),t.on("currentTime",this.onMeshCurrentTime)}removeMeshListeners(t){t.off("down",this.onMeshDown),t.off("playing",this.onMeshPlaying),t.off("zoomed",this.onMeshZoomed),t.off("currentTime",this.onMeshCurrentTime)}onMeshDown(){this.down.next(this)}onMeshPlaying(t){this.play.next({itemId:this.item.id,playing:t})}onMeshZoomed(t){this.zoom.next({itemId:this.item.id,zoomed:t})}onMeshCurrentTime(t){this.currentTime.next({itemId:this.item.id,currentTime:t})}onDestroy(){super.onDestroy(),this.disposableMesh&&(this.removeMeshListeners(this.disposableMesh),this.disposableMesh.dispose()),this.mesh&&(this.removeMeshListeners(this.mesh),this.mesh.dispose())}onUpdate(t,e){if(t.radius!==this.radius_||t.height!==this.height_||t.arc!==this.arc_){e.geometry.dispose();const i=this.getCurvedPanelGeometry(t);e.geometry=i}e.updateFromItem(t),this.updateHelper()}onUpdateAsset(t,e){e.updateByItem(t),Ws.getStreamId$(t).pipe(n.filter((t=>null!==t)),n.take(1)).subscribe((i=>{t.streamId=i,e.load((()=>{}))}))}onDragMove(t,e,i){const n=this.item,s=this.mesh;n.showPanel=!1,this.editing=!0,s.position.set(t.x,t.y,t.z),i?(t.normalize().multiplyScalar(20),s.lookAt(Cs.origin)):(s.position.set(0,0,0),s.lookAt(e),s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))),this.updateHelper()}onDragEnd(){const t=this.item,e=this.mesh;t.position=e.position.toArray(),t.rotation=e.rotation.toArray(),t.scale=e.scale.toArray(),e.updateFromItem(t),this.editing=!1}getCurvedPanelGeometry(t){this.radius_=t.radius,this.height_=t.height,this.arc_=t.arc;const e=Math.PI/180*t.arc,i=new THREE.CylinderBufferGeometry(t.radius,t.radius,t.height,36,2,!0,0,e);return i.rotateY(-Math.PI-e/2),i.scale(-1,1,1),i}}Zc.textures={},Zc.meta={selector:"[model-curved-plane]",hosts:{host:Hr},outputs:["down","play","zoom","currentTime"],inputs:["item","view"]};class Qc{static getService(){return this.service_||(this.service_=new Qc),this.service_}get message(){return this.message$.getValue()}constructor(){if(Qc.service_)throw"DebugService is a singleton class!";this.message$=new i.BehaviorSubject(null)}setMessage(t){this.message!==t&&this.message$.next(t)}}class td extends Gr{static getLoader(){return td.loader||(td.loader=new THREE.FontLoader)}static getFontLoader(t){return td.fontLoader||(td.fontLoader=td.getLoader().load(x.getPath("fonts/helvetiker/helvetiker_regular.typeface.json"),t))}get message(){return this.message_}set message(t){t=t&&""!==t?t:null,this.message_!==t&&(this.message_=t,this.setText(t))}onInit(){super.onInit();(this.vrService=Ro.getService()).session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t?this.text&&this.textGroup.add(this.text):this.text&&this.text.parent.remove(this.text)}));(this.debugService=Qc.getService()).message$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.message=t))}createText(){const t=document.createElement("canvas");t.width=td.W,t.height=td.H;const e=new THREE.CanvasTexture(t);e.encoding=THREE.sRGBEncoding,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.mapping=THREE.UVMapping,e.needsUpdate=!0;const i=new THREE.PlaneBufferGeometry(4,1,2,2),n=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,map:e,color:16777215,transparent:!0,opacity:1,toneMapped:!1}),s=new THREE.Mesh(i,n);return s.renderOrder=x.renderOrder.debug,s.position.y=0,s}loadFont(){this.fontLoader=td.getFontLoader((t=>{this.font=t,this.message_&&this.setText(this.message_)}))}onCreate(t,e){const i=this.textGroup=new THREE.Group;this.material=new THREE.MeshBasicMaterial({depthTest:!1,color:16777215,transparent:!0,opacity:1,side:THREE.DoubleSide}),this.text=this.createText(),"function"==typeof t&&t(i)}render(t,e){const i=this.group;let n=this.host.camera;const s=this.position;this.host.renderer.xr.isPresenting&&(n=this.host.renderer.xr.getCamera(n)),n.getWorldDirection(s),s.multiplyScalar(3),i.position.copy(s),i.lookAt(Cs.origin)}setText(t){const e=this.text;if(e)if(this.host.renderer.xr.isPresenting&&null!=t){const i=e.material.map.image.getContext("2d");i.clearRect(0,0,td.W,td.H),i.font=`30px ${x.fontFamily}`,i.textBaseline="middle",i.textAlign="center",i.fillStyle="#FFFFFF",i.strokeStyle="#000000",i.lineWidth=5,i.fillText(t,td.W/2,td.H/2,td.W-20),e.material.map.needsUpdate=!0,this.textGroup.add(e)}else e.parent&&e.parent.remove(e)}}td.W=1024,td.H=256,td.meta={selector:"[model-debug]",hosts:{host:Hr}};class ed extends Gr{static getLoader(){return ed.loader||(ed.loader=new THREE.TextureLoader)}static getTexture(){return ed.texture||(ed.texture=ed.getLoader().load(x.getPath("textures/ui/floor-nav.png")))}static getOverTexture(){return ed.textureOver||(ed.textureOver=ed.getLoader().load(x.getPath("textures/ui/floor-nav-over.png")))}set coords(t){if(!t&&this.coords_!==t||!this.coords_||t.x!==this.coords_.x||t.y!==this.coords_.y){const e=this.tileMap;if(this.coords_){const t=e[`${this.coords_.x}_${this.coords_.y}`],i=t.uniforms;gsap.to(i,{tween:0,duration:.4,delay:0,ease:Power2.easeInOut,onUpdate:()=>{t.material.uniforms.tween.value=i.tween,t.material.needsUpdate=!0}})}if(t){const i=this.currentTile=e[`${t.x}_${t.y}`],n=i.uniforms;gsap.to(n,{tween:1,duration:.4,delay:0,ease:Power2.easeInOut,onUpdate:()=>{i.material.uniforms.tween.value=n.tween,i.material.needsUpdate=!0}})}this.coords_=t}}set coords__(t){if(!t&&this.coords_!==t||!this.coords_||t.x!==this.coords_.x||t.y!==this.coords_.y){const e=this.tileMap;if(this.coords_){const t=e[`${this.coords_.x}_${this.coords_.y}`],i={tween:1};gsap.to(i,{duration:.4,tween:0,delay:0,ease:Power2.easeInOut,onUpdate:()=>{t.material.opacity=i.tween}})}if(t){const i=this.currentTile=e[`${t.x}_${t.y}`],n={tween:0};gsap.to(n,{duration:.4,tween:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{i.material.opacity=n.tween}})}this.coords_=t}}getCoords(t){const e=ed.RADIUS/10,i=Math.ceil((t.x+e/2)/e)-1,n=Math.ceil((t.z+e/2)/e)-1,s=Math.floor(ed.COLS/2),o=Math.floor(ed.ROWS/2),r=Math.min(s,Math.abs(i))*(i?Math.abs(i)/i:1),a=Math.min(o,Math.abs(n))*(n?Math.abs(n)/n:1);if(this.view.hasTile(this.indices.x+r,this.indices.y+a))return new THREE.Vector2(r,a)}onInit(){super.onInit(),this.indices=new THREE.Vector2,this.view.index$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.moveToIndex(t)}))}addTiles(t){const e=ed.RADIUS/10,i=.9*e,n=new THREE.PlaneBufferGeometry(i,i,2,2);n.rotateX(-Math.PI/2);const s=ed.getTexture();s.disposable=!1,s.encoding=THREE.sRGBEncoding;const o=ed.getOverTexture();o.disposable=!1,o.encoding=THREE.sRGBEncoding;const r=this.tileMap={};this.tiles=new Array(ed.COLS*ed.ROWS).fill(0).map(((i,a)=>{const c=new THREE.ShaderMaterial({depthTest:!1,depthWrite:!1,transparent:!0,toneMapped:!1,vertexShader:"\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"\nvarying vec2 vUv;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform float opacity;\nuniform float tween;\n\nvoid main() {\n\tvec4 colorA = texture2D(textureA, vUv);\n\tvec4 colorB = texture2D(textureB, vUv);\n\tvec4 color = mix(colorA, colorB, tween);\n\tcolor.a = clamp(color.a * opacity, 0.0, 1.0);\n\tcolor.rgb /= color.a;\n\tgl_FragColor = color;\n}\n",uniforms:{textureA:{type:"t",value:s},textureB:{type:"t",value:o},tween:{value:0},opacity:{value:0}},extensions:{fragDepth:!0}}),d=new THREE.Mesh(n,c),l=Math.floor(ed.COLS/2),h=Math.floor(ed.ROWS/2),u=Math.floor(a/ed.COLS),p=-l+a%ed.COLS,m=-h+u;return d.position.set(p*e,.15*-ed.RADIUS,m*e),d.name=this.getName(`tile_${p}_${m}`),d.uniforms={tween:0,opacity:0,ci:p,ri:m},r[`${p}_${m}`]=d,t.add(d),d})),this.showTiles()}showTiles(){this.tiles.forEach(((t,e)=>{const i=this.indices?this.indices.x:0,n=this.indices?this.indices.y:0,s=this.view.hasTile(i+t.uniforms.ci,n+t.uniforms.ri),o=t.uniforms;gsap.to(o,{opacity:s?1:0,duration:.4,ease:Power2.easeInOut,onUpdate:()=>{t.material.uniforms.opacity.value=o.opacity,t.material.needsUpdate=!0}})}))}addHitArea(t){this.onGroundOver=this.onGroundOver.bind(this),this.onGroundMove=this.onGroundMove.bind(this),this.onGroundDown=this.onGroundDown.bind(this),this.onGroundOut=this.onGroundOut.bind(this),ed.RADIUS;const e=new THREE.PlaneBufferGeometry(ed.RADIUS,ed.RADIUS,8,8);e.rotateX(-Math.PI/2);const i=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,toneMapped:!1,opacity:0}),n=this.ground=new As(e,i);n.name=this.getName("ground"),n.position.set(0,.15*-ed.RADIUS,0),n.on("over",this.onGroundOver),n.on("move",this.onGroundMove),n.on("out",this.onGroundOut),n.on("down",this.onGroundDown),t.add(n)}onGroundOver(){const t=this.ground,e=this.getCoords(t.intersection.point);this.coords=e}onGroundMove(){const t=this.ground,e=this.getCoords(t.intersection.point);this.coords=e}onGroundDown(){const t=this.ground,e=this.getCoords(t.intersection.point);if(this.coords=e,e){const t=this.view.getTileIndex(this.indices.x+e.x,this.indices.y+e.y);this.view.index=t,this.nav.next(t)}}onGroundOut(){this.coords=null}moveToIndex(t){this.coords=null;const e=this.view.tiles[t],i=new THREE.Vector2(e.indices.x-this.indices.x,e.indices.y-this.indices.y);this.indices.x=e.indices.x,this.indices.y=e.indices.y,this.showTiles();const n=ed.RADIUS/10;this.move.next({indices:this.indices,coords:i,position:i.clone().multiplyScalar(n)})}onCreate(t,e){const i=new THREE.Group;this.addTiles(i),this.addHitArea(i),"function"==typeof t&&t(i)}onDestroy(){super.onDestroy();const t=this.ground;t.off("over",this.onGroundOver),t.off("move",this.onGroundMove),t.off("down",this.onGroundDown),t.off("out",this.onGroundOut)}}ed.RADIUS=101,ed.COLS=11,ed.ROWS=11,ed.meta={selector:"[model-grid]",hosts:{host:Hr},outputs:["move","nav"],inputs:["view"]};class id extends As{static getGrid(t){const e=Math.ceil(t/id.ROWS);return[Math.ceil(t/e),e]}static getX(t,e){const i=Math.ceil(e/id.ROWS),n=t%i,s=1/id.W*(id.W+id.G);return s/2-i*s/2+n*s}static getY(t,e){const i=Math.ceil(e/id.ROWS),n=Math.ceil(e/i),s=Math.floor(t/i),o=1/id.W*(id.H+id.G);return n*o/2-o/2+s*-o}static get geometry(){if(this.geometry_)return this.geometry_;const t=new THREE.PlaneBufferGeometry(1,1/id.W*id.H,2,2);return this.geometry_=t,t}static get material(){return new THREE.ShaderMaterial({depthTest:!1,transparent:!0,toneMapped:!1,vertexShader:sd.VERTEX_SHADER,fragmentShader:sd.FRAGMENT_SHADER,uniforms:{textureA:{type:"t",value:null},textureB:{type:"t",value:null},resolutionA:{value:new THREE.Vector2},resolutionB:{value:new THREE.Vector2},tween:{value:0},opacity:{value:0}},extensions:{fragDepth:!0}})}constructor(t,e,i){const n=id.geometry,s=id.material;super(n,s),this.renderOrder=x.renderOrder.menu,this.name=t.name,this.item=t,this.index=e,this.total=i,this.tween=0,this.opacity=0;const o=this.textureA=this.getTextureA(t.name);s.uniforms.textureA.value=o,s.uniforms.resolutionA.value=new THREE.Vector2(o.width,o.height);const r=this.textureB=this.getTextureB(t.name);s.uniforms.textureB.value=r,s.uniforms.resolutionA.value=new THREE.Vector2(r.width,r.height),s.uniforms.tween.value=this.tween,s.uniforms.opacity.value=this.opacity,s.needsUpdate=!0,this.position.set(id.getX(e,i),id.getY(e,i),0),this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this)}getTextureA(t){const e=id.W,i=id.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuForeground,this.writeText(s,t,e,i);const o=new THREE.CanvasTexture(n);return o.minFilter=THREE.LinearFilter,o.magFilter=THREE.LinearFilter,o.mapping=THREE.UVMapping,o.needsUpdate=!0,o}getTextureB(t){const e=id.W,i=id.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuOverBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuOverForeground,this.writeText(s,t,e,i);const o=new THREE.CanvasTexture(n);return o.magFilter=THREE.LinearFilter,o.needsUpdate=!0,o}writeText(t,e,i,n){this.setFont(t);const s=id.FONT_SIZE*id.LINE_HEIGHT,o=this.getLines(t,e,i),r=o.length;this.setFont(t,r-1),o.forEach(((e,o)=>{t.fillText(e,10,.5*(n-r*s)+(.5+o)*s,i-20)}))}setFont(t,e){void 0===e&&(e=0),t.textBaseline="middle",t.font=`${id.FONT_SIZE-2*e}px ${x.fontFamily}`}getLines(t,e,i){const n=e.split(" "),s=[];let o=n[0];for(let e=1;e<n.length;e++){const r=n[e];t.measureText(o+" "+r).width<i?o+=" "+r:(s.push(o),o=r)}return s.push(o),s}onOver(){gsap.to(this,{duration:.4,tween:1,ease:Power2.easeOut,onUpdate:()=>{this.position.z=.1*this.tween,this.material.uniforms.tween.value=this.tween,this.material.needsUpdate=!0}})}onOut(){gsap.to(this,{duration:.4,tween:0,ease:Power2.easeOut,onUpdate:()=>{this.position.z=.1*this.tween,this.material.uniforms.tween.value=this.tween,this.material.needsUpdate=!0}})}dispose(){ws.dispose(this),this.textureA.dispose(),this.textureB.dispose(),this.material.dispose(),this.geometry.dispose()}}id.FONT_SIZE=19,id.LINE_HEIGHT=.9,id.W=256,id.H=64,id.G=2,id.ROWS=6;class nd extends id{constructor(t,e,i){super(t,e,i)}getTextureA(t){const e=id.W,i=id.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuBackBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuBackForeground,s.font=`${id.FONT_SIZE}px ${x.fontFamily}`,s.fillText(t,10,50,e-20);const o=new THREE.CanvasTexture(n);return o.minFilter=THREE.LinearFilter,o.magFilter=THREE.LinearFilter,o.mapping=THREE.UVMapping,o.needsUpdate=!0,o}getTextureB(t){const e=id.W,i=id.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuBackOverBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuBackOverForeground,s.font=`${id.FONT_SIZE}px ${x.fontFamily}`,s.fillText(t,10,50,e-20);const o=new THREE.CanvasTexture(n);return o.magFilter=THREE.LinearFilter,o.needsUpdate=!0,o}}class sd extends Gr{get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get locked(){return this.controlled||this.spying}get loading(){return this.loading_}set loading(e){if(this.loading_!==e){this.loading_=e;const{node:i}=t.getContext(this);i.querySelector(".btn--menu").classList.toggle("loading",e)}}onInit(){super.onInit(),this.onDown=this.onDown.bind(this),this.onToggle=this.onToggle.bind(this);const{node:e}=t.getContext(this);this.progressIndicator=e.querySelector(".progress circle"),Ls.progress$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.loading=t.count>0;let e=144.51;t.count&&(e=144.51*(1-t.value)),gsap.set(this.progressIndicator,{strokeDashoffset:e})})),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{if(t.type===Ve)this.onToggle()}))}onDestroy(){this.buttons&&this.buttons.forEach((t=>ws.dispose(t))),super.onDestroy()}getContainer(){return this.host.cameraGroup}onCreate(t,e){const i=this.menuGroup=new THREE.Group;"function"==typeof t&&t(i)}render(t,e){const i=this.group;this.host.cameraGroup;let n=this.host.camera;const s=this.position;if(this.host.renderer.xr.isPresenting)n=this.host.renderer.xr.getCamera(n),n.getWorldDirection(s),s.y+=.5,s.multiplyScalar(3),this.host.cameraGroup.worldToLocal(s),s.y+=this.host.cameraGroup.position.y,i.position.copy(s),i.scale.set(1,1,1),i.lookAt(Cs.origin);else{n.getWorldDirection(s),oo.mode===Qs?s.multiplyScalar(.01):s.multiplyScalar(3),i.position.copy(s);const t=1/n.zoom;i.scale.set(t,t,t),i.lookAt(Cs.origin)}}items$(t){return void 0===t&&(t=null),t?i.of(t.items):this.rootItems?i.of(this.rootItems):Da.getModelMenu$(this.views,this.host.editor).pipe(n.first(),n.tap((t=>{this.host.editor||(this.rootItems=t)})))}addMenu(t){void 0===t&&(t=null),this.removeMenu(),t&&"menu-group"!==t.type.name?this.nav.next(t):(Da.active=!0,this.items$(t).pipe(n.first()).subscribe((e=>{if(e){e=e.slice();const i={type:{name:"back"},name:t?"Back":"Close",backItem:t};e.push(i);const n=this.buttons=e.map(((e,i,n)=>(e.backItem=t,"back"===e.type.name?new nd(e,i,n.length):new id(e,i,n.length))));n.forEach((t=>{t.depthTest=!1,t.on("over",t.onOver),t.on("out",t.onOut),t.on("down",this.onDown),this.menuGroup.add(t)})),gsap.to(n,{duration:.3,opacity:.8,ease:Power2.easeOut,stagger:{grid:id.getGrid(n.length),from:0,amount:.02*n.length},onUpdate:()=>{n.forEach((t=>{t.material.uniforms.opacity.value=t.opacity*(t.item.hidden?.5:1)}))}})}})))}removeMenu(){Da.active=!1,this.removeButtons(),this.removeToggler()}removeButtons(){const t=this.buttons;t&&t.forEach((t=>{this.menuGroup.remove(t),t.off("over",t.onOver),t.off("out",t.onOut),t.off("down",this.onDown),t.dispose()})),this.buttons=null}addToggler(){this.removeMenu();const t=this.toggler=new id({type:{name:"menu"},name:"Menu"},0,1);t.opacity=.8,t.material.uniforms.opacity.value=t.opacity,t.material.needsUpdate=!0,t.on("over",t.onOver),t.on("out",t.onOut),t.on("down",this.onToggle),this.menuGroup.add(t)}removeToggler(){const t=this.toggler;t&&(this.menuGroup.remove(t),t.off("over",t.onOver),t.off("out",t.onOut),t.off("down",this.onToggle),t.dispose()),this.toggler=null}onDown(t){t.item&&"back"===t.item.type.name?(this.removeMenu(),t.item.backItem?this.addMenu(t.item.backItem.backItem):this.toggle.next()):this.addMenu(t.item)}onToggle(t){t&&(t.preventDefault(),t.stopImmediatePropagation()),this.locked||(Da.active?(this.removeMenu(),this.toggle.next()):(this.addMenu(),this.toggle.next(this)))}}sd.VERTEX_SHADER="\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",sd.FRAGMENT_SHADER="\nvarying vec2 vUv;\nuniform float opacity;\nuniform float tween;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform vec2 resolutionA;\nuniform vec2 resolutionB;\n\nvoid main() {\n\tvec4 colorA = texture2D(textureA, vUv);\n\tvec4 colorB = texture2D(textureB, vUv);\n\tvec4 color = vec4(mix(colorA.rgb, colorB.rgb, tween), opacity);\n\tgl_FragColor = color;\n}\n",sd.meta={selector:"[model-menu]",hosts:{host:Hr},outputs:["nav","toggle"],inputs:["views"],template:'\n\t<div class="btn--menu" (mousedown)="onToggle($event)">\n\t\t<svg class="menu-light" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#menu-light"></use></svg>\n\t\t<div class="btn--menu__spinner"></div>\n\t\t<svg class="bullets" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#menu"></use></svg>\n\t\t<svg class="progress" width="50" height="50" viewBox="0 0 50 50">\n\t\t\t<circle id="circle" r="23" cx="25" cy="25" fill="transparent"></circle>\n\t\t</svg>\n\t</div>\n\t'};const od=new WeakMap;class rd extends s.Loader{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,e,i,n){const o=new s.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,(t=>{const i={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(t,i).then(e).catch(n)}),i,n)}decodeDracoFile(t,e,i,n){const s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(t,s).then(e)}decodeGeometry(t,e){for(const t in e.attributeTypes){const i=e.attributeTypes[t];void 0!==i.BYTES_PER_ELEMENT&&(e.attributeTypes[t]=i.name)}const i=JSON.stringify(e);if(od.has(t)){const e=od.get(t);if(e.key===i)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const s=this.workerNextTaskID++,o=t.byteLength,r=this._getWorker(s,o).then((i=>(n=i,new Promise(((i,o)=>{n._callbacks[s]={resolve:i,reject:o},n.postMessage({type:"decode",id:s,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return r.catch((()=>!0)).then((()=>{n&&s&&this._releaseTask(n,s)})),od.set(t,{key:i,promise:r}),r}_createGeometry(t){const e=new s.BufferGeometry;t.index&&e.setIndex(new s.BufferAttribute(t.index.array,1));for(let i=0;i<t.attributes.length;i++){const n=t.attributes[i],o=n.name,r=n.array,a=n.itemSize;e.setAttribute(o,new s.BufferAttribute(r,a))}return e}_loadLibrary(t,e){const i=new s.FileLoader(this.manager);return i.setPath(this.decoderPath),i.setResponseType(e),i.setWithCredentials(this.withCredentials),new Promise(((e,n)=>{i.load(t,e,void 0,n)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then((e=>{const i=e[0];t||(this.decoderConfig.wasmBinary=e[1]);const n=ad.toString(),s=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const i=e.data;switch(i.type){case"decode":t._callbacks[i.id].resolve(i);break;case"error":t._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[t]=e,i._taskLoad+=e,i}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this}}function ad(){let t,e;function i(t,e,i,n,s,o){const r=o.num_components(),a=i.num_points()*r,c=a*s.BYTES_PER_ELEMENT,d=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,s),l=t._malloc(c);e.GetAttributeDataArrayForAllPoints(i,o,d,c,l);const h=new s(t.HEAPF32.buffer,l,a).slice();return t._free(l),{name:n,array:h,itemSize:r}}onmessage=function(n){const s=n.data;switch(s.type){case"init":t=s.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const n=s.buffer,o=s.taskConfig;e.then((t=>{const e=t.draco,r=new e.Decoder,a=new e.DecoderBuffer;a.Init(new Int8Array(n),n.byteLength);try{const t=function(t,e,n,s){const o=s.attributeIDs,r=s.attributeTypes;let a,c;const d=e.GetEncodedGeometryType(n);if(d===t.TRIANGULAR_MESH)a=new t.Mesh,c=e.DecodeBufferToMesh(n,a);else{if(d!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new t.PointCloud,c=e.DecodeBufferToPointCloud(n,a)}if(!c.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+c.error_msg());const l={index:null,attributes:[]};for(const n in o){const c=self[r[n]];let d,h;if(s.useUniqueIDs)h=o[n],d=e.GetAttributeByUniqueId(a,h);else{if(h=e.GetAttributeId(a,t[o[n]]),-1===h)continue;d=e.GetAttribute(a,h)}l.attributes.push(i(t,e,a,n,c,d))}d===t.TRIANGULAR_MESH&&(l.index=function(t,e,i){const n=3*i.num_faces(),s=4*n,o=t._malloc(s);e.GetTrianglesUInt32Array(i,s,o);const r=new Uint32Array(t.HEAPF32.buffer,o,n).slice();return t._free(o),{array:r,itemSize:1}}(t,e,a));return t.destroy(a),l}(e,r,a,o),n=t.attributes.map((t=>t.array.buffer));t.index&&n.push(t.index.array.buffer),self.postMessage({type:"decode",id:s.id,geometry:t},n)}catch(t){console.error(t),self.postMessage({type:"error",id:s.id,error:t.message})}finally{e.destroy(a),e.destroy(r)}}))}}}class cd extends Wr{get freezed(){return this.freezed_}set freezed(t){if(this.freezed_!==t){this.freezed_=t;const e=this.mesh;e&&e.traverse((e=>{e.isInteractiveMesh&&(e.freezed=t)}))}}onInit(){super.onInit(),this.isPresenting=!1,Da.active$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.freezed=t))}onChanges(){this.editing=this.item.selected}onCreate(t,e){this.loadGlb(x.getPath(this.item.asset.folder),this.item.asset.file,((i,n)=>{this.onGlbLoaded(i,n,t,e)}))}loadGlb(t,e,i){this.host.renderer;const n=Ls.getRef(),s=(new No).setPath(t),o=`${x.dist}js/draco/`,r=new rd;r.setDecoderPath(o),s.setDRACOLoader(r),s.load(e,(t=>{"function"==typeof i&&i(t.scene,t.animations),Ls.setProgress(n,1)}),(t=>{Ls.setProgress(n,t.loaded,t.total)}))}onGlbLoaded(t,e,i,n){this.parseAnimations(t,e);const s=(new THREE.Box3).setFromObject(t),o=s.max.clone().sub(s.min),r=1.7/Math.max(o.x,o.y,o.z);let a;t.scale.set(r,r,r);const c=this.view,d=this.item;if(c.type.name===fn.Model.name){a=new THREE.Group,a.add(t),s.setFromObject(a);const e=s.getCenter(new THREE.Vector3);a.position.set(t.position.x-e.x,t.position.y-e.y,t.position.z-e.z+(this.host.renderer.xr.isPresenting?-2:0));const i=a.position.y,n={tween:1},o=()=>{a.position.y=i+3*n.tween,a.rotation.y=0+Math.PI*n.tween};o(),this.makeInteractive(t),gsap.to(n,{duration:1.5,tween:0,delay:.1,ease:Power2.easeInOut,onUpdate:o,onComplete:()=>{this.updateHelper()}})}else{s.setFromObject(t);const e=s.getCenter(new THREE.Vector3);t.position.set(-e.x,-e.y,-e.z),a=new THREE.Group,a.add(t),d.position&&a.position.fromArray(d.position),d.rotation&&a.rotation.fromArray(d.rotation),d.scale&&a.scale.fromArray(d.scale),this.makeInteractive(t),this.updateHelper()}"function"==typeof i&&(i(a,this.item),this.freezed=Da.active)}parseAnimations(t,e){this.actionIndex=-1;const i=this.actions=[];if(e&&e.length){this.clock=new THREE.Clock;const n=this.mixer=new THREE.AnimationMixer(t);n.timeScale=1,e.forEach((t=>{const e=n.clipAction(t);e.enabled=!0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1),e.setLoop(THREE.LoopRepeat),i.push(e)}))}}onClipToggle(){let t;const e=this.actions;1===e.length?(t=-1===this.actionIndex?0:-1,this.setSingleAction(t)):e.length>1&&(t=this.actionIndex+1,t===e.length&&(t=-1),this.setMultiAction(t)),this.play.next({itemId:this.item.id,actionIndex:t})}setSingleAction(t){if(this.actionIndex!==t){this.actionIndex=t;const e=this.actions[0];0===t?e.paused||0===e.timeScale?e.paused=!1:e.play():-1===t&&e.halt(.3)}}setMultiAction(t){if(this.actionIndex!==t){const e=this.actions,i=this.actionIndex>-1?e[this.actionIndex]:null;if(this.actionIndex=t,i&&i.halt(.3),t>-1){const i=e[t];i.paused&&(i.paused=!1),0===i.timeScale&&(i.timeScale=1),i.play()}}}onMessage(t){switch(t.type){case ze:{const e=this.actions;1===e.length?this.setSingleAction(t.actionIndex):e.length>1&&this.setMultiAction(t.actionIndex);break}}}render(t,e){const i=this.view;this.item;const n=this.mesh,s=this.host.renderer.xr.isPresenting;this.group,n&&(i.type.name===fn.Model.name?(this.isPresenting!==s&&(this.isPresenting=s,s?(n.position.x=0,n.position.y=0,n.position.z=-2,n.rotation.y=0):(n.position.x=0,n.position.y=0,n.position.z=0,n.rotation.y=0)),s&&(n.rotation.y-=Math.PI/180/60*5)):s&&(n.rotation.y-=Math.PI/180/60*5));const o=this.mixer,r=this.clock;if(o){const t=r.getDelta();o.update(t)}}onUpdate(t,e){this.view.type.name!==fn.Model.name&&(t.position&&e.position.fromArray(t.position),t.rotation&&e.rotation.fromArray(t.rotation),t.scale&&e.scale.fromArray(t.scale)),this.updateHelper()}onUpdateAsset(t,e){this.loadGlb(x.getPath(t.asset.folder),t.asset.file,((t,e)=>{this.onGlbLoaded(t,e,((t,e)=>this.onMount(t,e)),((t,e)=>this.onDismount(t,e)))}))}onDragMove(t,e,i){i&&t.normalize().multiplyScalar(4),this.editing=!0;this.view.type.name!==fn.Model.name&&this.mesh.position.set(t.x,t.y,t.z),this.updateHelper()}onDragEnd(){this.view.type.name!==fn.Model.name&&(this.item.position=this.mesh.position.toArray(),this.item.rotation=this.mesh.rotation.toArray(),this.item.scale=this.mesh.scale.toArray()),this.editing=!1}static getInteractiveDescriptors(){let t=cd.interactiveDescriptors;if(!t){const e=Object.getOwnPropertyDescriptors(Rs.prototype),i=Object.getOwnPropertyDescriptors(Is.prototype),n=Object.getOwnPropertyDescriptors(As.prototype);t=Object.assign({},e,i,n),cd.interactiveDescriptors=t}return t}makeInteractive(t){const e=cd.getInteractiveDescriptors();t.traverse((t=>{t.isMesh&&(Object.keys(e).forEach((i=>{"constructor"!==i&&Object.defineProperty(t,i,e[i])})),t.freezed=!1,t.events={},t.depthTest=!0,t.over_=!1,t.down_=!1,ws.items.push(t),t.on("down",(()=>{this.onClipToggle(),this.down.next(this)})))}))}}cd.meta={selector:"[model-model]",hosts:{host:Hr},outputs:["down","play"],inputs:["item","view"]};class dd extends THREE.Sprite{get freezed(){return this.freezed_}set freezed(t){this.freezed_=t,this.children.filter((t=>t.__lookupGetter__("freezed"))).forEach((e=>e.freezed=t))}constructor(t){super(t=t||new THREE.SpriteMaterial({color:16711935})),this.freezed=!1}freeze(){this.freezed=!0}unfreeze(){this.freezed=!1}}class ld extends dd{constructor(t){super(t=t||new THREE.SpriteMaterial({color:16711935})),this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}}class hd extends ld{constructor(t){super(t),this.depthTest=!0,this.over_=!1,this.down_=!1,ws.items.push(this)}get isInteractiveSprite(){return!0}get over(){return this.over_}set over(t){this.over_!=t&&(this.over_=t,t?this.emit("over",this):this.emit("out",this))}get down(){return this.down_}set down(t){t=t&&this.over,this.down_!=t&&(this.down_=t,t?this.emit("down",this):this.emit("up",this))}}class ud extends Gr{constructor(){super(...arguments),this.isMobile_=void 0}get isMobile(){return this.isMobile_}set isMobile(t){this.isMobile_!==t&&(this.isMobile_=t,this.setScale())}render(t,e){this.isMobile=this.host.worldRect.width<768}setScale(t){void 0===t&&(t=0);const e=this.textureWidth,i=this.textureHeight,n=this.item,s=this.panel;if(s){const o=.2*(n.asset?1.5:1)*(this.isMobile?1.6:1),r=e/i,a=ud.PANEL_RADIUS*o,c=ud.PANEL_RADIUS*o/r,d=.25*a,l=n.mesh.position.normalize().multiplyScalar(ud.PANEL_RADIUS);s.position.set(l.x,l.y+(c+2*d)-d*(1-t),l.z),s.scale.set(.02*a,.02*c,1)}}onInit(){super.onInit(),this.textureWidth=0,this.textureHeight=0}onView(){if(this.viewed)return;this.viewed=!0;const{node:e}=t.getContext(this);this.getCanvasTexture(e).then((t=>{if(this.textureWidth=t.width,this.textureHeight=t.height,this.mesh&&this.item){const i=new THREE.SpriteMaterial({depthTest:!1,transparent:!0,opacity:0,map:t.map,sizeAttenuation:!1,toneMapped:!1}),n=this.item,s=this.panel=new hd(i);s.renderOrder=x.renderOrder.panel,this.setScale(1),s.on("down",(t=>{const i={x:parseInt(t.intersection.uv.x*e.offsetWidth),y:parseInt((1-t.intersection.uv.y)*e.offsetHeight)},s=Array.prototype.slice.call(e.querySelectorAll(".panel__link")),o=s.find((t=>i.x>=t.offsetLeft&&i.y>=t.offsetTop&&i.x<=t.offsetLeft+t.offsetWidth&&i.y<=t.offsetTop+t.offsetHeight));if(o){const t=s.indexOf(o),r=n.links[t];this.down.next({item:n,link:r,linkIndex:t});const a=e.getBoundingClientRect(),c={button:0,buttons:0,clientX:i.x+a.left,clientY:i.y+a.top,movementX:0,movementY:0,relatedTarget:o,screenX:i.x,screenY:i.y},d=new MouseEvent("mouseup",c);o.dispatchEvent(d),setTimeout((()=>{Xs.dismissEvent(d,Xs.events$,Xs.dismiss$,Xs.downEvent)}),1)}})),this.mesh.add(s);const o={value:0};gsap.to(o,{duration:.5,value:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{this.setScale(1-o.value),s.lookAt(Cs.origin),s.material.opacity=o.value,s.material.needsUpdate=!0}})}}),(t=>{console.log("ModelPanelComponent.getCanvasTexture.error",t)}))}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}onDestroy(){super.onDestroy()}imagesLoaded(){const{node:e}=t.getContext(this);if(e){const t=Array.prototype.slice.call(e.querySelectorAll("img")).map((t=>new Promise((function(e,i){const n=t.src&&-1===t.src.indexOf(location.origin);if(t.complete)return setTimeout((()=>{e(n)}),10);function s(){r(),setTimeout((()=>{e(n)}),10)}function o(){r(),e(!1)}function r(){t.removeEventListener("load",s),t.removeEventListener("error",o)}t.addEventListener("load",s),t.addEventListener("error",o)}))));return t.length?Promise.all(t):Promise.resolve()}}getCanvasTexture(e){return new Promise(((i,n)=>{setTimeout((()=>{this.item.panelTexture?i(this.item.panelTexture):this.imagesLoaded().then((s=>{const o=t.getContext(this);if(o&&o.node){e=o.node;const t=s&&null!=s.find((t=>!0===t));a.default(e,{backgroundColor:"#ffffff00",scale:1,useCORS:t}).then((t=>{const e=new THREE.CanvasTexture(t);this.item.panelTexture={map:e,width:t.width,height:t.height},i(this.item.panelTexture)}),(t=>{n(t)}))}}))}),1)}))}}ud.PANEL_RADIUS=99,ud.meta={selector:"[model-panel]",hosts:{host:Hr},outputs:["over","out","down"],inputs:["item"],template:'\n\t\t<div class="panel__title"><span [innerHTML]="item.title"></span></div>\n\t\t<div class="panel__abstract"><span [innerHTML]="item.abstract"></span></div>\n\t\t<img class="panel__picture" [src]="item.asset | asset" *if="item.asset">\n\t\t<a class="panel__link" [href]="link.href" target="_blank" rel="noopener" *for="let link of item.links">\n\t\t\t<span [innerHTML]="link.title"></span>\n\t\t</a>\n\t'};class pd extends Gr{onInit(){super.onInit()}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}}pd.meta={selector:"[model-picture]",hosts:{host:Hr},inputs:["item"]};class md extends Wr{onInit(){super.onInit()}onChanges(){const t=this.item.selected;this.editing=t,this.mesh&&(this.mesh.editing=t)}onCreate(t,e){const i=this.item,s=this.view;s.items;const o=ys.planeGeometry;let r,a;this.onMeshDown=this.onMeshDown.bind(this),this.onMeshPlaying=this.onMeshPlaying.bind(this),this.onMeshZoomed=this.onMeshZoomed.bind(this),this.onMeshCurrentTime=this.onMeshCurrentTime.bind(this),Ws.getStreamId$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe((c=>{this.streamId!==c&&(this.streamId=c,a&&(a.unsubscribe(),a=null),c||!i.asset?(i.streamId=c,r=this.disposableMesh=new Ws(i,s,o,this.host),r.updateFromItem(i),r.name="plane",r.load((()=>{this.disposableMesh=null,"function"==typeof t&&t(r,i),a=r.events$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((()=>{}))})),this.addMeshListeners(r)):this.mesh&&e(this.mesh,i))}))}addMeshListeners(t){t.on("down",this.onMeshDown),t.on("playing",this.onMeshPlaying),t.on("zoomed",this.onMeshZoomed),t.on("currentTime",this.onMeshCurrentTime)}removeMeshListeners(t){t.off("down",this.onMeshDown),t.off("playing",this.onMeshPlaying),t.off("zoomed",this.onMeshZoomed),t.off("currentTime",this.onMeshCurrentTime)}onMeshDown(){this.down.next(this)}onMeshPlaying(t){this.play.next({itemId:this.item.id,playing:t})}onMeshZoomed(t){this.zoom.next({itemId:this.item.id,zoomed:t})}onMeshCurrentTime(t){this.currentTime.next({itemId:this.item.id,currentTime:t})}onDestroy(){super.onDestroy(),this.disposableMesh&&(this.removeMeshListeners(this.disposableMesh),this.disposableMesh.dispose()),this.mesh&&(this.removeMeshListeners(this.mesh),this.mesh.dispose())}onUpdate(t,e){e.updateFromItem(t),this.updateHelper()}onUpdateAsset(t,e){e.updateByItem(t),Ws.getStreamId$(t).pipe(n.filter((t=>null!==t)),n.take(1)).subscribe((i=>{t.streamId=i,e.load((()=>{}))}))}onDragMove(t,e,i){const n=this.item,s=this.mesh;n.showPanel=!1,this.editing=!0,i?(t.normalize().multiplyScalar(20),s.position.set(t.x,t.y,t.z),s.lookAt(Cs.origin)):(s.position.set(0,0,0),s.lookAt(e),s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))),this.updateHelper()}onDragEnd(){const t=this.item,e=this.mesh;t.position=e.position.toArray(),t.rotation=e.rotation.toArray(),t.scale=e.scale.toArray(),e.updateFromItem(t),this.editing=!1}}md.textures={},md.meta={selector:"[model-plane]",hosts:{host:Hr},outputs:["down","play","zoom","currentTime"],inputs:["item","view"]};const gd=100.99;class fd extends Gr{get title(){return this.title_}set title(t){this.title_!==t&&(this.title_=t,t===ge.transform("waiting_host")||""!==t&&this.visible_?(this.updateProgress(),this.show()):this.hide())}get visible(){return this.visible_}set visible(t){this.visible_!==t&&(this.visible_=t,t&&""!==this.title_?(this.updateProgress(),this.show()):this.hide())}onInit(){this.title_="",this.visible_=this.host.renderer.xr.isPresenting,super.onInit();(this.vrService=Ro.getService()).session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.visible=null!=t))}onCreate(e,i){const{node:s}=t.getContext(this),o=s.querySelector(".inner");this.getCanvasTexture().then((t=>{const i=this.createMesh(t);"function"==typeof e&&e(i),Ls.progress$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t.count>0?s.classList.add("active"):s.classList.remove("active"),o.style.width=100*t.value+"%",t.count?this.title=0===t.value?ge.transform("loading"):t.title:this.title=this.getTitle()}))}))}getTitle(){return this.view&&this.view.type.name===fn.WaitingRoom.name?ge.transform("waiting_host"):""}show(){this.mesh.add(this.banner),this.material.opacity=1,this.material.needsUpdate=!0}hide(){this.mesh.remove(this.banner),this.material.opacity=0,this.material.needsUpdate=!0}createMesh(t){const e=new THREE.Group,i=Math.PI/180*360,n=gd*i,s=n/360*2.4,o=n/(t.width*s/t.height),r=new THREE.CylinderBufferGeometry(gd,gd,s,80,2,!0,0,i);r.scale(-1,1,1);const a=t.texture;a.wrapS=a.wrapY=THREE.RepeatWrapping,a.repeat.x=o,a.encoding=THREE.sRGBEncoding;const c=this.material=new THREE.MeshBasicMaterial({map:a,transparent:!0,opacity:0,toneMapped:!1});return this.banner=new THREE.Mesh(r,c),e.userData={render:()=>{e.rotation.y+=Math.PI/180*.02}},e}updateProgress(){this.getCanvasTexture().then((t=>{const e=Math.PI/180*360,i=gd*e,n=i/360*2.4,s=i/(t.width*n/t.height);this.texture.repeat.x=s}))}getCanvasTexture(){return new Promise(((t,e)=>{let i=512,n=64;const s=Math.floor(48),o=Math.floor(3.2);let r;r=this.canvas?this.canvas:this.canvas=document.createElement("canvas"),r.width=i,r.height=n;const a=this.title_,c=r.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.font=`300 ${s}px ${x.fontFamily}`;let d;i=c.measureText(a).width+8,i=Math.max(512,Math.pow(2,Math.ceil(Math.log(i)/Math.log(2)))),r.width=i,c.clearRect(0,0,i,n),c.fillStyle="#0000005A",c.fillRect(0,0,i,n),c.font=`300 ${s}px ${x.fontFamily}`,c.textAlign="center",c.textBaseline="middle",c.strokeStyle="rgba(0, 0, 0, 0.35)",c.lineWidth=o,c.lineJoin="round",c.miterLimit=2,c.strokeText(a,i/2,32),c.fillStyle="white",c.fillText(a,i/2,32,i),this.texture?(d=this.texture,d.needsUpdate=!0):d=this.texture=new THREE.CanvasTexture(r),t({texture:d,width:i,height:n})}))}}fd.meta={selector:"[model-progress]",hosts:{host:Hr},inputs:["view"]};class vd extends Gr{static get transparentMaterial(){return this.transparentMaterial_||(this.transparentMaterial_=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:0})),this.transparentMaterial_}get freezed(){return this.freezed_}set freezed(t){if(this.freezed_!==t){this.freezed_=t;const e=this.mesh;e&&e.traverse((e=>{e.isInteractiveMesh&&(e.freezed=t)}))}}onInit(){super.onInit(),this.isPresenting=!1,Da.active$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.freezed=t))}onChanges(){this.editing=this.view.selected}onCreate(t,e){this.loadGlb(x.getPath(this.view.asset.folder),this.view.asset.file,((i,n)=>{this.onGlbLoaded(i,n,t,e)}))}loadGlb(t,e,i){this.host.renderer;const n=Ls.getRef(),s=(new No).setPath(t),o=`${x.dist}js/draco/`,r=new rd;r.setDecoderPath(o),s.setDRACOLoader(r),s.load(e,(t=>{"function"==typeof i&&i(t.scene,t.animations),Ls.setProgress(n,1)}),(t=>{Ls.setProgress(n,t.loaded,t.total)}))}onGlbLoaded(t,e,i,n){const s=this.view;t.position.set(0,-1.76,0);const o=[];let r;t.traverse((t=>{t.isMesh&&o.push(t),"nav"===t.name&&(s.navIntersectObjects=[t],this.makeTransparent(t))})),s.intersectObjects=o,r=new THREE.Group,r.add(t),"function"==typeof i&&i(r,this.view)}makeTransparent(t){t.isMesh&&(t.material=vd.transparentMaterial),t.traverse((t=>{t.isMesh&&(t.material=vd.transparentMaterial)}))}onUpdateAsset(t,e){this.loadGlb(x.getPath(t.asset.folder),t.asset.file,((t,e)=>{this.onGlbLoaded(t,e,((t,e)=>this.onMount(t,e)),((t,e)=>this.onDismount(t,e)))}))}}vd.meta={selector:"[model-room]",hosts:{host:Hr},inputs:["view"]};class _d extends Gr{onInit(){super.onInit()}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}}_d.meta={selector:"[model-text]",hosts:{host:Hr},inputs:["item"]};class Ed extends t.Module{}Ed.meta={imports:[t.CoreModule,e.FormModule,nc],declarations:[ce,Ai,en,Ni,nn,un,Qr,hn,gn,mn,Mn,xn,Un,Vn,wa,Ua,pc,gc,fc,vc,_c,Va,Ec,Sc,Tc,Ra,ue,bc,Cc,yc,wc,Rc,Ia,Oa,Na,oc,Ic,rc,va,mc,Gc,kc,sc,Lc,Ac,ge,Pc,_a,Mc,Yc,xc,Uc,Zn,Xc,Gr,Zc,td,ed,sd,cd,Zr,ud,pd,md,fd,vd,_d,_e,Fc,Bc,Oc,jc,Ea,Qn,Hc,Nc,Kc,Hr,ae,Vc],bootstrap:Sa},console.log("beta-bhere-development","1.0.33-canary.0"),t.Browser.bootstrap(Ed)}));
//# sourceMappingURL=main.min.js.map