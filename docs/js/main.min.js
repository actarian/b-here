/**
 * @license beta-bhere-development v1.0.30-canary.0
 * (c) 2023 Luca Zampetti <lzampetti@gmail.com>
 * License: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("rxcomp"),require("rxcomp-form"),require("rxjs"),require("rxjs/operators"),require("three"),require("html2canvas")):"function"==typeof define&&define.amd?define(["rxcomp","rxcomp-form","rxjs","rxjs/operators","three","html2canvas"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).rxcomp,t.rxcomp.form,t.rxjs,t.rxjs.operators,t.THREE,t.html2canvas)}(this,(function(t,e,i,n,s,o){"use strict";function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var a=r(o);const c='\n\x3c!-- service --\x3e\n<div class="group--service">\n\t<button type="button" class="btn--back" [title]="\'title_back\' | label" (click)="onBack($event)" *if="isBackButtonVisible">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t</button>\n\t<button type="button" class="btn--view-mode" [title]="\'title_view_mode\' | label" (click)="toggleMode($event)" *if="state.mode != \'embed\'">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == \'virtual-tour\'"><use xlink:href="#live-meeting"></use></svg>\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == \'live-meeting\'"><use xlink:href="#virtual-tour"></use></svg>\n\t</button>\n\t<button type="button" class="btn--volume" [title]="\'title_volume\' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t</button>\n\t<button type="button" class="btn--fullscreen" [title]="\'title_fullscreen\' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t</button>\n\t<button type="button" class="btn--navmap" [title]="\'title_navmap\' | label" [class]="{ active: state.showNavmap }" (click)="toggleNavmap($event)" *if="navmap && state.mode != \'live-meeting\'">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navmap"></use></svg>\n\t</button>\n</div>\n',l='\n\x3c!-- controls --\x3e\n<div class="group--controls" *if="state.live">\n\t<div class="group--actions">\n\t\t<button type="button" class="btn--call" [title]="\'title_disconnect\' | label" (click)="disconnect()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--cam" [title]="\'title_mute_camera\' | label" [class]="{ muted: state.cameraMuted, disabled: !local }" (click)="toggleCamera()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--mic" [title]="\'title_mute_mic\' | label" [class]="{ muted: state.audioMuted, disabled: !local || silenced }" (click)="toggleAudio()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--screen" [title]="\'title_share_screen\' | label" [class]="{ active: screen }" (click)="toggleScreen()" *if="(\'screenShare\' | flag) && (state.role == \'publisher\' || state.role == \'attendee\' || controlling)">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#screen"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--chat" [title]="\'title_chat\' | label" [class]="{ active: state.chatDirty }" (click)="toggleChat()" *if="(\'chat\' | flag)">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#chat"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--navinfo" [title]="\'title_navinfo\' | label" [class]="{ active: state.showNavInfo }" (click)="toggleNavInfo()" *if="showNavInfoToggler">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navinfo"></use></svg>\n\t\t</button>\n\t</div>\n</div>\n',d='\n\x3c!-- media --\x3e\n<div class="group--media" media-player>\n\t<button type="button" class="btn--play" [title]="\'title_play\' | label" (click)="onPlay()" *if="!playing">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#play"></use></svg>\n\t</button>\n\t<button type="button" class="btn--pause" [title]="\'title_pause\' | label" (click)="onPause()" *if="playing">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#pause"></use></svg>\n\t</button>\n\t<div class="track" (click)="onTrack($event)">\n\t\t<div class="track__progress" [style]="{ transform: \'scale(\' + this.progress + \', 1)\'}"></div>\n\t</div>\n</div>\n',h='\n\x3c!-- ar-vr --\x3e\n<div class="group--ar-vr">\n\t<button type="button" class="btn--ar" [title]="\'title_ar\' | label" [href]="view?.ar" (click)="tryInAr()" *if="view?.ar">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#ar"></use></svg> <span>Try in AR</span>\n\t</button>\n\t<button type="button" class="btn--vr" [title]="\'title_vr\' | label" [class]="{ disabled: vrService.isDisabled() }" (click)="vrService.toggleVR()">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#vr"></use></svg> <span [innerHTML]="vrService.getLabel()"></span>\n\t</button>\n</div>\n',u='\n\x3c!-- like --\x3e\n<div class="group--heart" *if="view && (\'like\' | flag)">\n\t<svg class="love" [class]="{ active: view.showLove }" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#heart"></use></svg>\n\t<button type="button" class="btn--heart" [class]="{ active: view.showLove }" (click)="addLike($event)">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#heart"></use></svg>\n\t\t<span class="badge" [innerHTML]="view.likes" *if="view.likes"></span>\n\t</button>\n</div>\n<div class="group--spacer" *if="!view || !(\'like\' | flag)"></div>\n',p='\n\x3c!-- chat --\x3e\n<div class="group--chat" *if="state.chat" agora-chat (close)="onChatClose()"></div>\n',m='\n\x3c!-- lock --\x3e\n<div class="ui__lock" [class]="{ spying: spying }" *if="locked || controlling"></div>\n',v='\n\x3c!-- navmap --\x3e\n<div class="group--navmap" *if="navmap && state.showNavmap && state.mode != \'live-meeting\'">\n\t<img draggable="false" [src]="navmap.asset | asset" *if="navmap.asset" />\n\t<div class="navmap__item" [style]="{ left: item.position[0] * 100 + \'%\', top: item.position[1] * 100 + \'%\' }" (click)="onNavmapItem(item)" *for="let item of navmap.items">\n\t\t<img draggable="false" [src]="\'textures/ui/nav-point.png\' | asset" />\n\t\t<div class="title" [innerHTML]="item.title" *if="item.title"></div>\n\t</div>\n</div>\n',g="\n\x3c!-- background --\x3e\n<div class=\"background\" [class]=\"{ 'background--image': ('background.image' | env), 'background--video': ('background.video' | env) }\" *if=\"state.status != 'connected'\">\n\t<img [src]=\"'background.image' | env | asset\" *if=\"'background.image' | env\" />\n\t<video [src]=\"'background.video' | env | asset\" *if=\"'background.video' | env\" oncanplay=\"this.muted = true; this.classList.add('ready');\" playsinline autoplay muted loop></video>\n</div>\n",f='\n\x3c!-- logo --\x3e\n<a class="btn--logo" [routerLink]="\':lang.access\' | route" *if="state.status != \'connected\'">\n\t<img [src]="\'logo\' | env" *if="\'logo\' | env" />\n\t<svg viewBox="0 0 270 98" *if="!(\'logo\' | env)"><use xlink:href="#b-here"></use></svg>\n</a>\n',E='\n\x3c!-- credits --\x3e\n<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener" *if="state.status != \'connected\'">\n\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n</a>\n',_='\n\x3c!-- copyright --\x3e\n<span *if="\'gdprRoutes\' | flag"> <span [innerHTML]="\'copyright\' | label"></span> <span *if="\'privacy_policy\' | label">-</span> <a [routerLink]="\':lang.privacy\' | route" class="btn--colophon" [innerHTML]="\'privacy_policy\' | label"></a> <span *if="\'terms_of_service\' | label">-</span> <a [routerLink]="\':lang.terms\' | route" class="btn--colophon" [innerHTML]="\'terms_of_service\' | label"></a></span>\n',S='\n\x3c!-- language --\x3e\n<div class="group--language" language *if="state.status != \'connected\'"></div>\n',b=`\n\x3c!-- Virtual Tour --\x3e\n<div class="ui virtual-tour" [class]="uiClass" *if="state.status == 'connected' && isVirtualTourUser">\n\t\x3c!-- world --\x3e\n\t<div class="ui__body">\n\t\t<div class="world" world [view]="view" [views]="pathViews" (navTo)="onNavTo($event)" (navLink)="onNavLink($event)"></div>\n\t</div>\n\t\n\x3c!-- remote sidebar --\x3e\n<div class="group--remote" [class]="remoteClass" *if="state.live">\n\t<div class="agora-stream" (toggleControl)="onToggleControl($event)" (toggleSpy)="onToggleSpy($event)" agora-stream [stream]="remote" type="remote" *for="let remote of remotes">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info" [class]="{ spyed: state.spying == streamId, controlling: state.controlling == streamId }">\n\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t\t<button type="button" class="btn--control" [title]="'title_control' | label" (click)="onToggleControl(streamId)" *if="state.role === 'publisher'">\n\t\t\t\t<svg class="control" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="btn--spy" [title]="'title_spy' | label" (click)="onToggleSpy(streamId)" *if="state.role === 'publisher'">\n\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#spy"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t<div class="group--members" *if="state.mode == 'virtual-tour'">\n\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t</div>\n\t\t<div class="credits">\n\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t</a>\n\t\t</div>\n\t</div>\n</div>\n\x3c!-- remote screen --\x3e\n<div class="group--remote-screen" *if="remoteScreen">\n\t<div class="agora-stream" agora-stream [stream]="remoteScreen" type="remote">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info">\n\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t</div>\n\t</div>\n</div>\n\n\t<div class="group--header">\n\t\t${c}\n\t\t\n\x3c!-- local streams --\x3e\n<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t<button type="button" class="btn--silence" [title]="'title_silence' | label" [class]="{ active: state.silencing }" (click)="onToggleSilence()" *if="state.role === 'publisher'">\n\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t</button>\n\t<button type="button" class="btn--control" [title]="'title_control' | label" [class]="{ active: state.controlling == state.uid }" (click)="onToggleControl(state.uid)" *if="state.role == 'publisher'">\n\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t</button>\n\t<div class="agora-stream" *if="!local"></div>\n\t<div class="agora-stream" agora-stream [stream]="local" type="local" *if="local">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info">\n\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t</div>\n\t</div>\n\t<div class="agora-stream agora-stream--screen" agora-stream [stream]="screen" type="local" *if="screen && hasScreenViewItem">\n\t\t<div class="agora-stream__player"></div>\n\t</div>\n</div>\n\n\t</div>\n\t<div class="group--footer">\n\t\t${l}\n\t\t${d}\n\t\t${h}\n\t\t${u}\n\t</div>\n\t\n\x3c!-- members --\x3e\n<div class="group--members" *if="state.mode == 'live-meeting'">\n\t<div class="members" *if="state.role === 'publisher'">\n\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t</div>\n\t<div class="credits">\n\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t</div>\n</div>\n\n\t${p}\n\t${m}\n\t${v}\n</div>\n`,T=`\n\x3c!-- Self Service Tour --\x3e\n<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'self-service-tour'">\n\t\x3c!-- world --\x3e\n\t<div class="ui__body">\n\t\t<div class="world" world [view]="view" [views]="pathViews" (navTo)="onNavTo($event)" (navLink)="onNavLink($event)"></div>\n\t</div>\n\t<div class="group--header">\n\t\t${c}\n\t</div>\n\t<div class="group--footer">\n\t\t<div class="group--spacer"></div>\n\t\t${d}\n\t\t${h}\n\t\t${u}\n\t</div>\n\t${v}\n</div>\n`,y=`\n\x3c!-- Embed --\x3e\n<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'embed'">\n\t\x3c!-- world --\x3e\n\t<div class="ui__body">\n\t\t<div class="world" world [view]="view" [views]="pathViews" (navTo)="onNavTo($event)" (navLink)="onNavLink($event)"></div>\n\t</div>\n\t<div class="group--header">\n\t\t${c}\n\t</div>\n\t<div class="group--footer">\n\t\t<div class="group--spacer"></div>\n\t\t${d}\n\t\t${h}\n\t\t${u}\n\t</div>\n</div>\n`;class w{static merge(t,e){return null===e?e:t?(e&&"object"==typeof e&&Object.keys(e).forEach((i=>{const n=e[i];"object"!=typeof n||Array.isArray(n)?t[i]=n:t[i]=this.merge(t[i],n)})),t):e&&"object"==typeof e?Object.assign({},e):e}}const C="undefined"!=typeof module&&module.exports,R=null!=(C?{get:()=>{}}:new URLSearchParams(window.location.search)).get("debug");!C&&document.querySelector("base").getAttribute("href");const I=!C&&(window&&-1!==window.location.host.indexOf("herokuapp")),A=!C&&(window&&-1!==window.location.host.indexOf("vercel.app")),O=I||A,N=!C&&(O||window&&("41789"===window.location.port||"5000"===window.location.port||"6443"===window.location.port||"actarian.github.io"===window.location.host)),k=!C&&(window&&-1!==["localhost","127.0.0.1","0.0.0.0"].indexOf(window.location.host.split(":")[0])),L={STATIC:N,DEVELOPMENT:k,PRODUCTION:!k};const P={channelName:"BHere",flags:{heroku:I,vercel:A,deployed:O},navs:{iconMinScale:1,iconMaxScale:1.4},url:{},languages:["it","en"],defaultLanguage:"it",labels:{},data:{},fields:[]},D=window.STATIC?{appKey:"8b0cae93d47a44e48e97e7fd0404be4e",channelName:"BHere",flags:{production:!1,useProxy:!0,useToken:!1,usePrefetch:!0,useExtendedUserInfo:!0,useEncryptedUrl:!0,gdprRoutes:!0,selfService:!0,guidedTourRequest:!0,guidedTourAccess:!0,ssoLogin:!1,ssoRegister:!1,editor:!0,editorAssetScreen:!0,menu:!0,menuEmbed:!0,navmaps:!0,screenShare:!0,chat:!0,ar:!0,like:!0,hideNavInfo:!0,useIframe:!0,attendee:!0,streamer:!0,viewer:!0,smartDevice:!0,selfServiceProposition:!1,navInfoAnimated:!1,navInfoImportantAnimated:!1,navMoveAnimated:!0,navMoveImportantAnimated:!0,navPointAnimated:!1,navPointImportantAnimated:!1,navTitleAnimated:!1,navTitleImportantAnimated:!1,navTransparentAnimated:!0,navTransparentImportantAnimated:!0,useTextureEnvironment:!0,usePaths:!0,antialias:!0,alpha:!1,premultipliedAlpha:!1},sso:{issuer:"bhere-sso",origin:"http://localhost:3010",loginUrl:"http://localhost:3010/sso/login?redirectUrl={redirectUrl}",logoutUrl:"http://localhost:3010/sso/logout?redirectUrl={redirectUrl}",registerUrl:"http://localhost:3010/sso/register?redirectUrl={redirectUrl}",verifyTokenUrl:"http://localhost:3010/sso/verifytoken?verifyToken={verifytoken}"},navs:{iconMinScale:1,iconMaxScale:1.4},profiles:{streamer:"480p_2",attendee:"1080p_2",publisher:"1080p_2",screen:"1080p_2"},logo:null,selfServiceAudio:null,colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room"],disabledViewItemTypes:["texture"]},assets:"/docs/",dist:"/dist/",workers:{image:"./js/workers/image.service.worker.js",prefetch:"./js/workers/prefetch.service.worker.js"},textures:{envMap:"textures/envMap/studio_small_03_2k.hdr",grid:"textures/grid/grid.jpg"},toneMappingExposure:1,githubDocs:"https://raw.githubusercontent.com/actarian/b-here/beta-bhere-sso/docs/",template:{email:{supportRequest:"/email/support-request.html"}}}:{appKey:"8b0cae93d47a44e48e97e7fd0404be4e",channelName:"BHere",flags:{production:!0,useProxy:!1,useToken:!1,usePrefetch:!0,useExtendedUserInfo:!1,useEncryptedUrl:!1,gdprRoutes:!1,selfService:!0,guidedTourRequest:!0,guidedTourAccess:!0,ssoLogin:!1,ssoRegister:!1,editor:!1,editorAssetScreen:!1,menu:!0,menuEmbed:!1,navmaps:!1,screenShare:!1,chat:!1,ar:!0,like:!0,hideNavInfo:!0,useIframe:!0,attendee:!0,streamer:!0,viewer:!0,smartDevice:!0,selfServiceProposition:!1,navInfoAnimated:!1,navInfoImportantAnimated:!1,navMoveAnimated:!1,navMoveImportantAnimated:!1,navPointAnimated:!1,navPointImportantAnimated:!1,navTitleAnimated:!1,navTitleImportantAnimated:!1,navTransparentAnimated:!1,navTransparentImportantAnimated:!1,useTextureEnvironment:!0,usePaths:!1,antialias:!0,alpha:!1,premultipliedAlpha:!1},navs:{iconMinScale:1,iconMaxScale:1.4},profiles:{streamer:"480p_2",attendee:"1080p_2",publisher:"1080p_2",screen:"720p_2"},logo:null,selfServiceAudio:null,colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d","media"],disabledViewItemTypes:["texture"]},assets:"/Modules/B-Here/Client/docs/",dist:"/Modules/B-Here/Client/dist/",workers:{image:"/Modules/B-Here/Client/docs/js/workers/image.service.worker.js",prefetch:"/Modules/B-Here/Client/docs/js/workers/prefetch.service.worker.js"},textures:{envMap:"textures/envMap/studio_small_03_2k.hdr",grid:"textures/grid/grid.jpg"},toneMappingExposure:1,githubDocs:"https://raw.githubusercontent.com/actarian/b-here/beta-bhere-sso/docs/",template:{email:{supportRequest:"/template/modules/b-here/email/support-request.cshtml"}}};let M=Object.assign({port:5e3,fontFamily:"Work Sans, sans-serif",colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d","media"],disabledViewItemTypes:["texture"]},renderOrder:{panorama:0,room:10,plane:20,tile:30,model:40,banner:50,nav:60,panel:70,menu:80,debug:90,pointer:100}},P,D);M=w.merge(M,window.bhere);const x=new class{get STATIC(){return L.STATIC}set STATIC(t){L.STATIC=!0===t||"true"===t,console.log("Environment.STATIC.set",L.STATIC)}get href(){return O?this.githubDocs:this.assets}getAbsoluteUrl(t,e){let i=`${window.location.origin}${t}`;return Object.keys(e).forEach((t=>{i=i.replace(`$${t}`,e[t])})),i}getPath(t){return this.isLocal(t)?this.href+t:t}isLocal(t){return-1===t.indexOf("://")}merge(t){t&&w.merge(this,t)}constructor(t){t&&Object.assign(this,t)}}(M);console.log("environment",x);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var U=function(){return U=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},U.apply(this,arguments)},V=function(){return V=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},V.apply(this,arguments)},B=function(t){return void 0===t&&(t={}),{arrayFormat:t.arrayFormat||"none",booleanFormat:t.booleanFormat||"none",nullFormat:t.nullFormat||"default"}},j=function(t){return encodeURIComponent(t)},F=function(t){return decodeURIComponent(t)},H=function(t,e,i){return null===e?function(t,e){return"hidden"===e.nullFormat?"":"string"===e.nullFormat?t+"=null":t}(t,i):"boolean"==typeof e?function(t,e,i){return"empty-true"===i.booleanFormat&&e?t:t+"="+("unicode"===i.booleanFormat?e?"✓":"✗":e.toString())}(t,e,i):Array.isArray(e)?function(t,e,i){var n=function(t){return"index"===t.arrayFormat?function(t,e){return t+"["+e+"]"}:"brackets"===t.arrayFormat?function(t){return t+"[]"}:function(t){return t}}(i);return e.map((function(e,i){return n(t,i)+"="+j(e)})).join("&")}(t,e,i):t+"="+j(e)},G=function(t){var e=t.indexOf("?");return-1===e?t:t.slice(e+1)},$=function(t){var e=t.indexOf("["),i=-1!==e;return{hasBrackets:i,name:i?t.slice(0,e):t}},W=function(t,e){var i=B(e);return G(t).split("&").reduce((function(t,e){var n=e.split("="),s=n[0],o=n[1],r=$(s),a=r.hasBrackets,c=r.name,l=t[c],d=function(t,e){if(void 0===t)return"empty-true"===e.booleanFormat||null;if("string"===e.booleanFormat){if("true"===t)return!0;if("false"===t)return!1}if("unicode"===e.booleanFormat){if("✓"===F(t))return!0;if("✗"===F(t))return!1}return"string"===e.nullFormat&&"null"===t?null:F(t)}(o,i);return t[c]=void 0===l?a?[d]:d:(Array.isArray(l)?l:[l]).concat(d),t}),{})},z=function(t,e){var i=B(e);return Object.keys(t).filter((function(e){return void 0!==t[e]})).map((function(e){return H(e,t[e],i)})).filter(Boolean).join("&")},K=/[^!$'()*+,;|:]/g,q=function(t){return t.replace(K,(function(t){return encodeURIComponent(t)}))},Y={default:q,uri:encodeURI,uriComponent:encodeURIComponent,none:function(t){return t},legacy:encodeURI},J={default:decodeURIComponent,uri:decodeURI,uriComponent:decodeURIComponent,none:function(t){return t},legacy:decodeURIComponent},X=function(t,e,i){var n=Y[e]||q;return i?String(t).split("/").map(n).join("/"):n(String(t))},Q=function(t){return"("+(t?t.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~%':|=+\\*@$]+")+")"},Z=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(t){return new RegExp(Q(t[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^?]*)/},{name:"url-parameter-matrix",pattern:/^;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(t){return new RegExp(";"+t[1]+"="+Q(t[2]))}},{name:"query-parameter",pattern:/^(?:\?|&)(?::)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function(t){return new RegExp("\\"+t[0])}},{name:"sub-delimiter",pattern:/^(!|&|-|_|\.|;)/,regex:function(t){return new RegExp(t[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+)/,regex:function(t){return new RegExp(t[0])}}],tt=function t(e,i){if(void 0===i&&(i=[]),!Z.some((function(n){var s=e.match(n.pattern);return!!s&&(i.push({type:n.name,match:s[0],val:s.slice(1,2),otherVal:s.slice(2),regex:n.regex instanceof Function?n.regex(s):n.regex}),s[0].length<e.length&&(i=t(e.substr(s[0].length),i)),!0)})))throw new Error("Could not parse path '"+e+"'");return i},et=function(t){return null!=t},it={urlParamsEncoding:"default"},nt=function(){function t(t,e){if(!t)throw new Error("Missing path in Path constructor");this.path=t,this.options=V(V({},it),e),this.tokens=tt(t),this.hasUrlParams=this.tokens.filter((function(t){return/^url-parameter/.test(t.type)})).length>0,this.hasSpatParam=this.tokens.filter((function(t){return/splat$/.test(t.type)})).length>0,this.hasMatrixParams=this.tokens.filter((function(t){return/matrix$/.test(t.type)})).length>0,this.hasQueryParams=this.tokens.filter((function(t){return/^query-parameter/.test(t.type)})).length>0,this.spatParams=this.getParams("url-parameter-splat"),this.urlParams=this.getParams(/^url-parameter/),this.queryParams=this.getParams("query-parameter"),this.params=this.urlParams.concat(this.queryParams),this.source=this.tokens.filter((function(t){return void 0!==t.regex})).map((function(t){return t.regex.source})).join("")}return t.createPath=function(e,i){return new t(e,i)},t.prototype.isQueryParam=function(t){return-1!==this.queryParams.indexOf(t)},t.prototype.isSpatParam=function(t){return-1!==this.spatParams.indexOf(t)},t.prototype.test=function(t,e){var i=this,n=V(V({caseSensitive:!1,strictTrailingSlash:!1},this.options),e),s=function(t,e){return e||"\\/"===t?t:t.replace(/\\\/$/,"")+"(?:\\/)?"}(this.source,n.strictTrailingSlash),o=this.urlTest(t,s+(this.hasQueryParams?"(\\?.*$|$)":"$"),n.caseSensitive,n.urlParamsEncoding);if(!o||!this.hasQueryParams)return o;var r=W(t,n.queryParams);return 0===Object.keys(r).filter((function(t){return!i.isQueryParam(t)})).length?(Object.keys(r).forEach((function(t){return o[t]=r[t]})),o):null},t.prototype.partialTest=function(t,e){var i=this,n=V(V({caseSensitive:!1,delimited:!0},this.options),e),s=function(t,e){return e?/(\/)$/.test(t)?t:t+"(\\/|\\?|\\.|;|$)":t}(this.source,n.delimited),o=this.urlTest(t,s,n.caseSensitive,n.urlParamsEncoding);if(!o)return o;if(!this.hasQueryParams)return o;var r=W(t,n.queryParams);return Object.keys(r).filter((function(t){return i.isQueryParam(t)})).forEach((function(t){return function(t,e,i){void 0===i&&(i="");var n=t[e];return t[e]=void 0===n?i:Array.isArray(n)?n.concat(i):[n,i],t}(o,t,r[t])})),o},t.prototype.build=function(t,e){var i=this;void 0===t&&(t={});var n=V(V({ignoreConstraints:!1,ignoreSearch:!1,queryParams:{}},this.options),e),s=Object.keys(t).filter((function(t){return!i.isQueryParam(t)})).reduce((function(e,s){if(!et(t[s]))return e;var o=t[s],r=i.isSpatParam(s);return"boolean"==typeof o?e[s]=o:Array.isArray(o)?e[s]=o.map((function(t){return X(t,n.urlParamsEncoding,r)})):e[s]=X(o,n.urlParamsEncoding,r),e}),{});if(this.urlParams.some((function(e){return!et(t[e])}))){var o=this.urlParams.filter((function(e){return!et(t[e])}));throw new Error("Cannot build path: '"+this.path+"' requires missing parameters { "+o.join(", ")+" }")}if(!n.ignoreConstraints&&!this.tokens.filter((function(t){return/^url-parameter/.test(t.type)&&!/-splat$/.test(t.type)})).every((function(t){return new RegExp("^"+Q(t.otherVal[0])+"$").test(s[t.val])})))throw new Error("Some parameters of '"+this.path+"' are of invalid format");var r=this.tokens.filter((function(t){return!1===/^query-parameter/.test(t.type)})).map((function(t){return"url-parameter-matrix"===t.type?";"+t.val+"="+s[t.val[0]]:/^url-parameter/.test(t.type)?s[t.val[0]]:t.match})).join("");if(n.ignoreSearch)return r;var a=this.queryParams.filter((function(e){return-1!==Object.keys(t).indexOf(e)})).reduce((function(e,i){return e[i]=t[i],e}),{}),c=z(a,n.queryParams);return c?r+"?"+c:r},t.prototype.getParams=function(t){var e=t instanceof RegExp?function(e){return t.test(e.type)}:function(e){return e.type===t};return this.tokens.filter(e).map((function(t){return t.val[0]}))},t.prototype.urlTest=function(t,e,i,n){var s=this,o=new RegExp("^"+e,i?"":"i"),r=t.match(o);return r?this.urlParams.length?r.slice(1,this.urlParams.length+1).reduce((function(t,e,i){return t[s.urlParams[i]]=(J[n]||decodeURIComponent)(e),t}),{}):{}:null},t}(),st=function(t){var e="";return t.reduce((function(t,i){var n,s,o,r,a=null!=(s=null===(n=i.parser)||void 0===n?void 0:n.urlParams.reduce((function(t,e){return t[e]="url",t}),{}))?s:{},c=null!=(r=null===(o=i.parser)||void 0===o?void 0:o.queryParams.reduce((function(t,e){return t[e]="query",t}),a))?r:{};return void 0!==i.name&&(t[e=e?e+"."+i.name:i.name]=c),t}),{})},ot=function t(e,i,n,s,o){void 0===s&&(s={});for(var r=s.queryParamsMode,a=void 0===r?"default":r,c=s.strictTrailingSlash,l=void 0!==c&&c,d=s.strongMatching,h=void 0===d||d,u=s.caseSensitive,p=void 0!==u&&u,m=1===e.length&&""===e[0].name,v=function(e){var r,c=null,d=void 0,u=i;if("/"===o&&"/"===e.path&&(u="/"+i),e.children.length||(c=e.parser.test(u,{caseSensitive:p,strictTrailingSlash:l,queryParams:s.queryParams,urlParamsEncoding:s.urlParamsEncoding})),c||(c=e.parser.partialTest(u,{delimited:h,caseSensitive:p,queryParams:s.queryParams,urlParamsEncoding:s.urlParamsEncoding})),c){var v=e.parser.build(c,{ignoreSearch:!0,urlParamsEncoding:s.urlParamsEncoding});l||e.children.length||(v=v.replace(/\/$/,"")),d=0===u.toLowerCase().indexOf(v.toLowerCase())?u.slice(v.length):u,l||e.children.length||(d=d.replace(/^\/\?/,"?"));var g=function(t,e,i){var n=B(i);if(""===G(t))return{querystring:"",removedParams:{}};var s=t.split("&").reduce((function(t,i){var n=t[0],s=t[1],o=i.split("=")[0],r=$(o).name;return-1===e.indexOf(r)?[n.concat(i),s]:[n,s.concat(i)]}),[[],[]]),o=s[0],r=s[1];return{querystring:o.join("&"),removedParams:W(r.join("&"),n)}}((r=u.replace(v,""),r.split("?")[1]||""),e.parser.queryParams,s.queryParams).querystring;if(d=function(t){return t.split("?")[0]}(d)+(g?"?"+g:""),l||m||"/"!==d||/\/$/.test(v)||(d=""),n.segments.push(e),Object.keys(c).forEach((function(t){return n.params[t]=c[t]})),!m&&!d.length)return{value:n};if(!m&&"strict"!==a&&0===d.indexOf("?")){var f=W(d.slice(1),s.queryParams);return Object.keys(f).forEach((function(t){return n.params[t]=f[t]})),{value:n}}var E=e.getNonAbsoluteChildren();return E.length?{value:t(E,d,n,s,v)}:{value:null}}},g=0,f=e;g<f.length;g++){var E=v(f[g]);if("object"==typeof E)return E.value}return null};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var rt=function(t){return function(e,i){var n,s,o,r,a,c,l=e.path.replace(/<.*?>/g,"").split("?")[0].replace(/(.+)\/$/,"$1"),d=i.path.replace(/<.*?>/g,"").split("?")[0].replace(/(.+)\/$/,"$1");if("/"===l)return 1;if("/"===d)return-1;if(null===(n=e.parser)||void 0===n?void 0:n.hasSpatParam)return 1;if(null===(s=i.parser)||void 0===s?void 0:s.hasSpatParam)return-1;var h=(l.match(/\//g)||[]).length,u=(d.match(/\//g)||[]).length;if(h<u)return 1;if(h>u)return-1;var p=null!=(r=null===(o=e.parser)||void 0===o?void 0:o.urlParams.length)?r:0,m=null!=(c=null===(a=i.parser)||void 0===a?void 0:a.urlParams.length)?c:0;if(p<m)return-1;if(p>m)return 1;var v=(l.split("/").slice(-1)[0]||"").length,g=(d.split("/").slice(-1)[0]||"").length;return v<g?1:v>g?-1:t.indexOf(e)-t.indexOf(i)}},at=function(){function t(t,e,i,n){return void 0===t&&(t=""),void 0===e&&(e=""),void 0===i&&(i=[]),void 0===n&&(n={}),this.name=t,this.absolute=/^~/.test(e),this.path=this.absolute?e.slice(1):e,this.parser=this.path?new nt(this.path):null,this.children=[],this.parent=n.parent,this.checkParents(),this.add(i,n.onAdd,!n.finalSort&&!1!==n.sort),n.finalSort&&this.sortDescendants(),this}return t.prototype.getParentSegments=function(t){return void 0===t&&(t=[]),this.parent&&this.parent.parser?this.parent.getParentSegments(t.concat(this.parent)):t.reverse()},t.prototype.setParent=function(t){this.parent=t,this.checkParents()},t.prototype.setPath=function(t){void 0===t&&(t=""),this.path=t,this.parser=t?new nt(t):null},t.prototype.add=function(e,i,n){var s=this;if(void 0===n&&(n=!0),null==e)return this;if(e instanceof Array)return e.forEach((function(t){return s.add(t,i,n)})),this;if(!(e instanceof t||e instanceof Object))throw new Error("RouteNode.add() expects routes to be an Object or an instance of RouteNode.");if(e instanceof t)e.setParent(this),this.addRouteNode(e,n);else{if(!e.name||!e.path)throw new Error("RouteNode.add() expects routes to have a name and a path defined.");var o=new t(e.name,e.path,e.children,{finalSort:!1,onAdd:i,parent:this,sort:n}),r=o.getParentSegments([o]).map((function(t){return t.name})).join(".");i&&i(U(U({},e),{name:r})),this.addRouteNode(o,n)}return this},t.prototype.addNode=function(e,i){return this.add(new t(e,i)),this},t.prototype.getPath=function(t){var e,i=this.getSegmentsByName(t);return i?(e=i)?e.map((function(t){return t.path})).join(""):null:null},t.prototype.getNonAbsoluteChildren=function(){return this.children.filter((function(t){return!t.absolute}))},t.prototype.sortChildren=function(){var t,e;this.children.length&&(t=this.children,e=t.slice(0),t.sort(rt(e)))},t.prototype.sortDescendants=function(){this.sortChildren(),this.children.forEach((function(t){return t.sortDescendants()}))},t.prototype.buildPath=function(t,e,i){void 0===e&&(e={}),void 0===i&&(i={});var n=this.getSegmentsByName(t);if(!n)throw new Error("[route-node][buildPath] '{routeName}' is not defined");return function(t,e,i){void 0===e&&(e={}),void 0===i&&(i={});for(var n=i.queryParamsMode,s=void 0===n?"default":n,o=i.trailingSlashMode,r=void 0===o?"default":o,a=[],c=[],l=0,d=t;l<d.length;l++){var h=d[l].parser;h&&(a.push.apply(a,h.queryParams),c.push.apply(c,h.urlParams),c.push.apply(c,h.spatParams))}if("loose"===s){var u=Object.keys(e).reduce((function(t,e){return-1===a.indexOf(e)&&-1===c.indexOf(e)?t.concat(e):t}),[]);a.push.apply(a,u)}var p=a.reduce((function(t,i){return-1!==Object.keys(e).indexOf(i)&&(t[i]=e[i]),t}),{}),m=z(p,i.queryParams),v=t.reduce((function(t,n){var s,o,r=null!=(o=null===(s=n.parser)||void 0===s?void 0:s.build(e,{ignoreSearch:!0,queryParams:i.queryParams,urlParamsEncoding:i.urlParamsEncoding}))?o:"";return n.absolute?r:t+r}),"").replace(/\/\/{1,}/g,"/"),g=v;return"always"===r?g=/\/$/.test(v)?v:v+"/":"never"===r&&"/"!==v&&(g=/\/$/.test(v)?v.slice(0,-1):v),g+(m?"?"+m:"")}(n,e,i)},t.prototype.buildState=function(t,e){void 0===e&&(e={});var i=this.getSegmentsByName(t);return i&&i.length?{name:t,params:e,meta:st(i)}:null},t.prototype.matchPath=function(t,e){void 0===e&&(e={}),""!==t||e.strictTrailingSlash||(t="/");var i=this.getSegmentsMatchingPath(t,e);if(!i)return null;var n=i.segments;if(n[0].absolute){var s=n[0].getParentSegments();n.reverse(),n.push.apply(n,s),n.reverse()}var o=n[n.length-1].findSlashChild();return o&&n.push(o),function(t){return t&&t.segments&&t.segments.length?{name:t.segments.map((function(t){return t.name})).filter((function(t){return t})).join("."),params:t.params,meta:st(t.segments)}:null}(i)},t.prototype.addRouteNode=function(t,e){void 0===e&&(e=!0);var i=t.name.split(".");if(1===i.length){if(-1!==this.children.map((function(t){return t.name})).indexOf(t.name))throw new Error('Alias "'+t.name+'" is already defined in route node');if(-1!==this.children.map((function(t){return t.path})).indexOf(t.path))throw new Error('Path "'+t.path+'" is already defined in route node');this.children.push(t),e&&this.sortChildren()}else{var n=this.getSegmentsByName(i.slice(0,-1).join("."));if(!n)throw new Error("Could not add route named '"+t.name+"', parent is missing.");t.name=i[i.length-1],n[n.length-1].add(t)}return this},t.prototype.checkParents=function(){if(this.absolute&&this.hasParentsParams())throw new Error("[RouteNode] A RouteNode with an abolute path cannot have parents with route parameters")},t.prototype.hasParentsParams=function(){if(this.parent&&this.parent.parser){var t=this.parent.parser;return t.hasUrlParams||t.hasSpatParam||t.hasMatrixParams||t.hasQueryParams||this.parent.hasParentsParams()}return!1},t.prototype.findAbsoluteChildren=function(){return this.children.reduce((function(t,e){return t.concat(e.absolute?e:[]).concat(e.findAbsoluteChildren())}),[])},t.prototype.findSlashChild=function(){return this.getNonAbsoluteChildren().filter((function(t){return t.parser&&/^\/(\?|$)/.test(t.parser.path)}))[0]},t.prototype.getSegmentsByName=function(t){var e=[],i=this.parser?[this]:this.children,n=(this.parser?[""]:[]).concat(t.split(".")).every((function(t){var n=function(t,e){var i=e.filter((function(e){return e.name===t}));return i.length?i[0]:void 0}(t,i);return!!n&&(i=n.children,e.push(n),!0)}));return n?e:null},t.prototype.getSegmentsMatchingPath=function(t,e){var i=(this.parser?[this]:this.children).reduce((function(t,e){return t.concat(e,e.findAbsoluteChildren())}),[]),n=ot(i,t,{segments:[],params:{}},e);return n&&1===n.segments.length&&""===n.segments[0].name?null:n},t}();var ct=function(t){var e,i=t.Symbol;return"function"==typeof i?i.observable?e=i.observable:(e=i("observable"),i.observable=e):e="@@observable",e}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),lt=function(t){return t.split(".").reduce((function(t,e){return t.concat(t.length?t[t.length-1]+"."+e:e)}),[])},dt=function(t){return t&&t.meta&&t.meta.params},ht=function(t,e){return dt(e)&&null!=e.meta.params[t]?Object.keys(e.meta.params[t]).reduce((function(t,i){return t[i]=e.params[i],t}),{}):{}};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var ut=function(){return ut=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},ut.apply(this,arguments)},pt={trailingSlashMode:"default",queryParamsMode:"default",strictTrailingSlash:!1,autoCleanUp:!0,allowNotFound:!1,strongMatching:!0,rewritePathOnMatch:!0,caseSensitive:!1,urlParamsEncoding:"default"};var mt="NOT_STARTED",vt="NO_START_PATH_OR_STATE",gt="ALREADY_STARTED",ft="ROUTE_NOT_FOUND",Et="SAME_STATES",_t="CANNOT_DEACTIVATE",St="CANNOT_ACTIVATE",bt="TRANSITION_ERR",Tt="CANCELLED",yt="@@router5/UNKNOWN_ROUTE",wt="$start",Ct="$stop",Rt="$$start",It="$$cancel",At="$$success",Ot="$$error";function Nt(t){var e=0,i=null;return t.getState=function(){return i},t.setState=function(t){i=t},t.makeState=function(i,n,s,o,r){return{name:i,params:ut(ut({},t.config.defaultParams[i]),n),path:s,meta:o?ut(ut({},o),{id:void 0===r?++e:r}):void 0}},t.makeNotFoundState=function(e,i){return t.makeState(yt,{path:e},e,{options:i})},t.areStatesEqual=function(e,i,n){if(void 0===n&&(n=!0),e.name!==i.name)return!1;var s=function(e){return t.rootNode.getSegmentsByName(e).map((function(t){return t.parser.urlParams})).reduce((function(t,e){return t.concat(e)}),[])},o=n?s(e.name):Object.keys(e.params),r=n?s(i.name):Object.keys(i.params);return o.length===r.length&&o.every((function(t){return e.params[t]===i.params[t]}))},t.areStatesDescendants=function(t,e){return!!new RegExp("^"+t.name+"\\.(.*)$").test(e.name)&&Object.keys(t.params).every((function(i){return t.params[i]===e.params[i]}))},t.forwardState=function(e,i){var n=t.config.forwardMap[e]||e;return{name:n,params:ut(ut(ut({},t.config.defaultParams[e]),t.config.defaultParams[n]),i)}},t.buildState=function(e,i){var n=t.forwardState(e,i),s=n.name,o=n.params;return t.rootNode.buildState(s,o)},t}var kt={onStart:wt,onStop:Ct,onTransitionSuccess:At,onTransitionStart:Rt,onTransitionError:Ot,onTransitionCancel:It};function Lt(t){var e=[];function i(e){var i=t.executeFactory(e),n=Object.keys(kt).map((function(e){if(i[e])return t.addEventListener(kt[e],i[e])})).filter(Boolean);return function(){n.forEach((function(t){return t()})),i.teardown&&i.teardown()}}return t.getPlugins=function(){return e},t.usePlugin=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var s=t.map((function(t){return e.push(t),i(t)}));return function(){e=e.filter((function(e){return-1===t.indexOf(e)})),s.forEach((function(t){return t()}))}},t}function Pt(t){var e=[],i=[];return t.useMiddleware=function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];var o=n.map((function(n){var s=t.executeFactory(n);return e.push(n),i.push(s),function(){e=e.filter((function(t){return t!==n})),i=i.filter((function(t){return t!==s}))}}));return function(){return o.forEach((function(t){return t()}))}},t.clearMiddleware=function(){return e=[],i=[],t},t.getMiddlewareFactories=function(){return e},t.getMiddlewareFunctions=function(){return i},t}function Dt(t){var e={};function i(e){var i="object"==typeof e,n=i?e.next.bind(e):e,s=t.addEventListener(At,(function(t,e){n({route:t,previousRoute:e})}));return i?{unsubscribe:s}:s}function n(){var t;return(t={subscribe:function(t){if("object"!=typeof t||null===t)throw new TypeError("Expected the observer to be an object.");return i(t)}})[ct]=function(){return this},t}return t.invokeEventListeners=function(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];(e[t]||[]).forEach((function(t){return t.apply(void 0,i)}))},t.removeEventListener=function(t,i){e[t]=e[t].filter((function(t){return t!==i}))},t.addEventListener=function(i,n){return e[i]=(e[i]||[]).concat(n),function(){return t.removeEventListener(i,n)}},t.subscribe=i,t[ct]=n,t["@@observable"]=n,t}function Mt(t,e,i){var n=e.isCancelled,s=e.toState,o=e.fromState,r=e.errorKey,a=void 0===r?void 0:r,c=Array.isArray(t)?t:Object.keys(t),l=function(t){return"object"==typeof t&&void 0!==t.name&&void 0!==t.params&&void 0!==t.path},d=function(t,e,i,s){var r=function(t,e){t?s(t):e&&e!==i&&l(e)?(function(t,e){return e.name!==t.name||e.params!==t.params||e.path!==t.path}(e,i)&&console.error("[router5][transition] Warning: state values (name, params, path) were changed during transition process."),s(null,function(t,e){return ut(ut(ut({},e),t),{meta:ut(ut({},e.meta),t.meta)})}(e,i))):s(null,i)},a=t.call(null,i,o,r);n()?r(null):"boolean"==typeof a?r(a?null:e):l(a)?r(null,a):a&&"function"==typeof a.then&&a.then((function(t){t instanceof Error?r({error:t},null):r(null,t)}),(function(t){t instanceof Error?(console.error(t.stack||t),r(ut(ut({},e),{promiseError:t}),null)):r("object"==typeof t?ut(ut({},e),t):e,null)}))},h=function(e,s){var o;if(n())i();else if(e)i(e);else if(c.length){var r="string"==typeof c[0],l=a&&r?((o={})[a]=c[0],o):{},u=r?t[c[0]]:c[0];c=c.slice(1),d(u,l,s,h)}else i(null,s)};h(null,s)}function xt(t,e,i,n,s){var o=!1,r=!1,a=t.getOptions(),c=t.getLifecycleFunctions(),l=c[0],d=c[1],h=t.getMiddlewareFunctions(),u=function(){return o},p=function(t,e){return ut(ut({},t),e instanceof Object?e:{error:e})},m=e.name===yt,v={isCancelled:u,toState:e,fromState:i},g=function(t,e){var i,n=t.meta&&t.meta&&t.meta.options||{},s=e?lt(e.name):[],o=lt(t.name),r=Math.min(s.length,o.length);i=!e||n.reload?0:dt(e)||dt(t)?function(){var i,n=function(){var n=s[i],r=o[i];if(n!==r)return{value:i};var a=ht(n,t),c=ht(r,e);return Object.keys(a).length!==Object.keys(c).length?{value:i}:0===Object.keys(a).length?"continue":Object.keys(a).some((function(t){return c[t]!==a[t]}))?{value:i}:void 0};for(i=0;i<r;i+=1){var a=n();if("object"==typeof a)return a.value}return i}():0;var a=s.slice(i).reverse(),c=o.slice(i);return{intersection:e&&i>0?s[i-1]:"",toDeactivate:a,toActivate:c}}(e,i),f=g.toDeactivate,E=g.toActivate,_=!i||n.forceDeactivate?[]:function(t,e,i){var n=f.filter((function(t){return l[t]})).reduce((function(t,e){var i;return ut(ut({},t),((i={})[e]=l[e],i))}),{});Mt(n,ut(ut({},v),{errorKey:"segment"}),(function(t){return i(t?p({code:_t},t):null)}))},S=m?[]:function(t,e,i){var n=E.filter((function(t){return d[t]})).reduce((function(t,e){var i;return ut(ut({},t),((i={})[e]=d[e],i))}),{});Mt(n,ut(ut({},v),{errorKey:"segment"}),(function(t){return i(t?p({code:St},t):null)}))},b=h.length?function(t,e,i){return Mt(h,ut({},v),(function(e,n){return i(e?p({code:bt},e):null,n||t)}))}:[];return Mt([].concat(_).concat(S).concat(b),v,(function(i,n){if(r=!0,!u()){if(!i&&a.autoCleanUp){var o=lt(e.name);Object.keys(l).forEach((function(e){-1===o.indexOf(e)&&t.clearCanDeactivate(e)}))}s(i,n||e)}})),function(){o||r||(o=!0,s({code:Tt},null))}}var Ut=function(){};function Vt(t){var e;function i(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var s=e[0],o=e[e.length-1],r="function"==typeof o?o:Ut,a="object"==typeof e[1]?e[1]:{},c="object"==typeof e[2]?e[2]:{};if(t.isStarted()){var l=t.buildState(s,a);if(!l)return r(d={code:ft}),void t.invokeEventListeners(Ot,null,t.getState(),d);var d,h=t.makeState(l.name,l.params,t.buildPath(l.name,l.params),{params:l.meta,options:c}),u=!!t.getState()&&t.areStatesEqual(t.getState(),h,!1);if(u&&!c.reload&&!c.force)return r(d={code:Et}),void t.invokeEventListeners(Ot,h,t.getState(),d);var p=t.getState();return c.skipTransition?(r(null,h),Ut):t.transitionToState(h,p,c,(function(e,n){if(e)if(e.redirect){var s=e.redirect;i(s.name,s.params,ut(ut({},c),{force:!0,redirected:!0}),r)}else r(e);else t.invokeEventListeners(At,n,p,c),r(null,n)}))}r({code:mt})}return t.navigate=i,t.navigate=i,t.navigateToDefault=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var s="object"==typeof e[0]?e[0]:{},o=2===e.length?e[1]:"function"==typeof e[0]?e[0]:Ut,r=t.getOptions();return r.defaultRoute?i(r.defaultRoute,r.defaultParams,s,o):function(){}},t.cancel=function(){return e&&(e("navigate"),e=null),t},t.transitionToState=function(i,n,s,o){return void 0===s&&(s={}),void 0===o&&(o=Ut),t.cancel(),t.invokeEventListeners(Rt,i,n),e=xt(t,i,n,s,(function(s,r){e=null,r=r||i,s?(s.code===Tt?t.invokeEventListeners(It,i,n):t.invokeEventListeners(Ot,i,n,s),o(s)):(t.setState(r),o(null,r))}))},t}var Bt=function(){};function jt(t){var e=!1;return t.isStarted=function(){return e},t.start=function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];var s,o,r=t.getOptions(),a=i[i.length-1],c="function"==typeof a?a:Bt,l="function"!=typeof i[0]?i[0]:void 0;if(e)return c({code:gt}),t;e=!0,t.invokeEventListeners(wt);var d=function(e,i,n){void 0===n&&(n=!0),e||t.invokeEventListeners(At,i,null,{replace:!0}),e&&n&&t.invokeEventListeners(Ot,i,null,e),c(e,i)};if(void 0===l&&!r.defaultRoute)return d({code:vt});if("string"==typeof l?s=l:"object"==typeof l&&(o=l),o)t.setState(o),d(null,o);else{o=void 0===s?null:t.matchPath(s);var h=function(){return t.navigateToDefault({replace:!0},c)},u=function(e){return t.navigate(e.name,e.params,{replace:!0,reload:!0,redirected:!0},c)},p=function(e){t.transitionToState(e,t.getState(),{},(function(t,e){t?t.redirect?u(t.redirect):r.defaultRoute?h():d(t,null,!1):d(null,e)}))};o?p(o):r.defaultRoute?h():r.allowNotFound?p(t.makeNotFoundState(s,{replace:!0})):d({code:ft,path:s},null)}return t},t.stop=function(){return e&&(t.setState(null),e=!1,t.invokeEventListeners(Ct)),t},t}var Ft=function(t){return"function"==typeof t?t:function(){return function(){return t}}};function Ht(t){var e={},i={},n={},s={};return t.getLifecycleFactories=function(){return[e,i]},t.getLifecycleFunctions=function(){return[n,s]},t.canDeactivate=function(i,s){var o=Ft(s);return e[i]=o,n[i]=t.executeFactory(o),t},t.clearCanDeactivate=function(i){return e[i]=void 0,n[i]=void 0,t},t.canActivate=function(e,n){var o=Ft(n);return i[e]=o,s[e]=t.executeFactory(o),t},t}var Gt=function(t,e,i){void 0===t&&(t=[]),void 0===e&&(e={}),void 0===i&&(i={});return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return function(e){return t.reduce((function(t,e){return e(t)}),e)}}(function(t){return function(e){var i=ut(ut({},pt),t);return e.getOptions=function(){return i},e.setOption=function(t,n){return i[t]=n,e},e}}(e),function(t){return function(e){var i=t;return e.setDependency=function(t,n){return i[t]=n,e},e.setDependencies=function(t){return Object.keys(t).forEach((function(i){return e.setDependency(i,t[i])})),e},e.getDependencies=function(){return i},e.getInjectables=function(){return[e,e.getDependencies()]},e.executeFactory=function(t){return t.apply(void 0,e.getInjectables())},e}}(i),Dt,Nt,jt,Ht,Vt,Lt,Pt,function(t){return function(e){e.forward=function(t,i){return e.config.forwardMap[t]=i,e};var i=t instanceof at?t:new at("","",t,{onAdd:n});function n(t){t.canActivate&&e.canActivate(t.name,t.canActivate),t.forwardTo&&e.forward(t.name,t.forwardTo),t.decodeParams&&(e.config.decoders[t.name]=t.decodeParams),t.encodeParams&&(e.config.encoders[t.name]=t.encodeParams),t.defaultParams&&(e.config.defaultParams[t.name]=t.defaultParams)}return e.rootNode=i,e.add=function(t,s){return i.add(t,n,!s),s&&i.sortDescendants(),e},e.addNode=function(t,n,s){return i.addNode(t,n),s&&e.canActivate(t,s),e},e.isActive=function(t,i,n,s){void 0===i&&(i={}),void 0===n&&(n=!1),void 0===s&&(s=!0);var o=e.getState();return!!o&&(n||o.name===t?e.areStatesEqual(e.makeState(t,i),o,s):e.areStatesDescendants(e.makeState(t,i),o))},e.buildPath=function(t,i){if(t===yt)return i.path;var n=ut(ut({},e.config.defaultParams[t]),i),s=e.getOptions(),o=s.trailingSlashMode,r=s.queryParamsMode,a=s.queryParams,c=e.config.encoders[t]?e.config.encoders[t](n):n;return e.rootNode.buildPath(t,c,{trailingSlashMode:o,queryParamsMode:r,queryParams:a,urlParamsEncoding:e.getOptions().urlParamsEncoding})},e.matchPath=function(t,i){var n=e.getOptions(),s=e.rootNode.matchPath(t,n);if(s){var o=s.name,r=s.params,a=s.meta,c=e.config.decoders[o]?e.config.decoders[o](r):r,l=e.forwardState(o,c),d=l.name,h=l.params,u=!1===n.rewritePathOnMatch?t:e.buildPath(d,h);return e.makeState(d,h,u,{params:a,source:i})}return null},e.setRootPath=function(t){e.rootNode.setPath(t)},e}}(t))({config:{decoders:{},encoders:{},defaultParams:{},forwardMap:{}}})},$t=function(){return $t=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},$t.apply(this,arguments)};function Wt(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),s=0;for(e=0;e<i;e++)for(var o=arguments[e],r=0,a=o.length;r<a;r++,s++)n[s]=o[r];return n}var zt=function(t){return function(){return t}},Kt=function(){},qt="undefined"!=typeof window&&window.history,Yt=function(t){try{return encodeURI(decodeURI(t))}catch(e){return t}},Jt=qt?{getBase:function(){return window.location.pathname},pushState:function(t,e,i){return window.history.pushState(t,e,i)},replaceState:function(t,e,i){return window.history.replaceState(t,e,i)},addPopstateListener:function(t,e){var i=e.useHash&&!(-1===window.navigator.userAgent.indexOf("Trident"));return window.addEventListener("popstate",t),i&&window.addEventListener("hashchange",t),function(){window.removeEventListener("popstate",t),i&&window.removeEventListener("hashchange",t)}},getLocation:function(t){var e=t.useHash?window.location.hash.replace(new RegExp("^#"+t.hashPrefix),""):window.location.pathname.replace(new RegExp("^"+t.base),"");return(Yt(e)||"/")+window.location.search},getState:function(){return window.history.state},getHash:function(){return window.location.hash}}:{getBase:zt(""),pushState:Kt,replaceState:Kt,addPopstateListener:Kt,getLocation:zt(""),getState:zt(null),getHash:zt("")},Xt={forceDeactivate:!0,useHash:!1,hashPrefix:"",base:"",mergeState:!1,preserveHash:!0},Qt="popstate";function Zt(t,e){void 0===e&&(e=Jt);var i,n=$t($t({},Xt),t),s={forceDeactivate:n.forceDeactivate,source:Qt};return function(t){var o=t.getOptions(),r=t.start;t.buildUrl=function(e,i){return(n.base||"")+(n.useHash?"#"+n.hashPrefix:"")+t.buildPath(e,i)};function a(t,i,s){var o=t?{meta:t.meta,name:t.name,params:t.params,path:t.path}:t,r=!0===n.mergeState?$t($t({},e.getState()),o):o;s?e.replaceState(r,"",i):e.pushState(r,"",i)}function c(i){var r=t.getState(),c=!i.state||!i.state.name,l=c?t.matchPath(e.getLocation(n),Qt):t.makeState(i.state.name,i.state.params,i.state.path,$t($t({},i.state.meta),{source:Qt}),i.state.meta.id),d=o.defaultRoute,h=o.defaultParams;l?r&&t.areStatesEqual(l,r,!1)||t.transitionToState(l,r,s,(function(e,i){if(e)if(e.redirect){var n=e.redirect,o=n.name,u=n.params;t.navigate(o,u,$t($t({},s),{replace:!0,force:!0,redirected:!0}))}else if(e.code===_t){var p=t.buildUrl(r.name,r.params);c||a(l,p,!0)}else d&&t.navigate(d,h,$t($t({},s),{reload:!0,replace:!0}));else t.invokeEventListeners(At,i,r,{replace:!0})})):d&&t.navigateToDefault($t($t({},s),{reload:!0,replace:!0}))}function l(){i&&(i(),i=void 0)}return t.matchUrl=function(e){return t.matchPath(function(t){var e=t.match(/^(?:http|https):\/\/(?:[0-9a-z_\-.:]+?)(?=\/)(.*)$/),i=(e?e[1]:t).match(/^(.+?)(#.+?)?(\?.+)?$/);if(!i)throw new Error("[router5] Could not parse url "+t);var s=i[1],o=i[2]||"",r=i[3]||"";return(n.useHash?o.replace(new RegExp("^#"+n.hashPrefix),""):n.base?s.replace(new RegExp("^"+n.base),""):s)+r}(e))},t.start=function(){for(var i=[],s=0;s<arguments.length;s++)i[s]=arguments[s];return 0===i.length||"function"==typeof i[0]?r.apply(void 0,Wt([e.getLocation(n)],i)):r.apply(void 0,i),t},t.replaceHistoryState=function(i,n,s){void 0===n&&(n={}),void 0===s&&(s="");var o=t.buildState(i,n),r=t.makeState(o.name,o.params,t.buildPath(o.name,o.params),{params:o.meta}),a=t.buildUrl(i,n);t.lastKnownState=r,e.replaceState(r,s,a)},{onStart:function(){n.useHash&&!n.base&&(n.base=e.getBase()),i=e.addPopstateListener(c,n)},onStop:l,teardown:l,onTransitionSuccess:function(i,s,o){var r=e.getState(),c=r&&r.meta&&r.name&&r.params,l=s&&t.areStatesEqual(s,i,!1),d=o.replace||!c||l,h=t.buildUrl(i.name,i.params);null===s&&!1===n.useHash&&!0===n.preserveHash&&(h+=e.getHash()),a(i,h,d)},onPopState:c}}}class te{static get router(){return this.router_}static get route(){let t=null;const e=this.router_;return e&&(t=e.getState()),t}static useBrowser(t){if(!Array.isArray(t)||!t.length)return void(this.event$=i.EMPTY);this.routes=t;const e=Gt(t,{allowNotFound:!1,autoCleanUp:!0,defaultRoute:"index",defaultParams:{},queryParams:{arrayFormat:"default",nullFormat:"default",booleanFormat:"default"},queryParamsMode:"default",trailingSlashMode:"default",strictTrailingSlash:!1,caseSensitive:!1,urlParamsEncoding:"default"});this.router_=e,e.usePlugin(Zt({useHash:!1})),e.start(),this.event$=i.from(e).pipe(n.startWith({route:e.getState(),previousRoute:null}))}static useBrowser$(t){return this.useBrowser(t),this.event$}static setRouterLink(t,e,i){void 0===t&&(t="it.access"),void 0===e&&(e=null),void 0===i&&(i={reload:!0});const n=this.router_;if(n)try{n.navigate(t,e,i)}catch(t){console.log("RouterService.setRouterLink.error",t)}}static replaceHistoryState(t,e){const i=this.router_;if(i)try{i.replaceHistoryState(t,e)}catch(t){console.log("RouterService.replaceHistoryState.error",t)}}static setCurrentParams(t){const e=this.router_;if(e)try{const i=this.route;i&&e.replaceHistoryState(i.name,t)}catch(t){console.log("RouterService.setCurrentParams.error",t)}}static buildPath(t,e){void 0===e&&(e=null);let i=null;const n=this.router_;if(n)try{i=n.buildPath(t,e)}catch(t){console.log("RouterService.buildPath.error",t)}return i}static buildUrl(t,e){void 0===e&&(e=null);let i=null;const n=this.router_;if(n)try{i=n.buildUrl(t,e)}catch(t){console.log("RouterService.buildUrl.error",t)}return i}static isActive(t,e,i,n){void 0===i&&(i=!1),void 0===n&&(n=!0);let s=!1;const o=this.router_;if(o)try{s=o.isActive(t,e,i,n)}catch(t){console.log("RouterService.isActive.error",t)}return s}}te.routes=[],te.router_=null;class ee{static set state(t){this.state$.next(t)}static get state(){return this.state$.getValue()}static patchState(t){t=Object.assign({},this.state,t),this.state=t}}ee.state$=new i.BehaviorSubject({});const ie={Publisher:"publisher",Attendee:"attendee",Streamer:"streamer",Viewer:"viewer",SmartDevice:"smart-device",SelfService:"self-service",Embed:"embed"};class ne{constructor(t){t&&Object.assign(this,t)}}const se=/^\d{9}-\d{4}-\d{13}(-\d+)?$/;class oe{get roleIndex(){return oe.getRoleIndex(this.role)}set roleIndex(t){if(oe.getRoleIndex(this.role)!==t){const e=Object.keys(ie)[t];this.role=ie[e]}}constructor(t){if(this.userId=ee.state.user?ee.state.user.id:0,this.role=ee.state.role||ie.Viewer,this.timestamp=(new Date).valueOf().toString(),this.pathId=null,"string"==typeof t){if(!t.match(se))return console.warn("MeetingId","invalid meetingId",t),null;t=oe.decompose(t)}"object"==typeof t&&(t.id&&(this.id=t.id),t.userId&&(this.userId=t.userId),t.role&&(this.role=t.role),t.roleIndex&&(this.roleIndex=t.roleIndex),t.timestamp&&(this.timestamp=t.timestamp),t.pathId&&(this.pathId=t.pathId))}toString(){return oe.compose(this.userId,this.roleIndex,this.timestamp,this.pathId)}toRoles(){const t=this.userId,e=this.timestamp,i=this.pathId;return{id:oe.compose(t,oe.getRoleIndex(ie.Publisher),e,i),idAttendee:oe.compose(t,oe.getRoleIndex(ie.Attendee),e,i),idStreamer:oe.compose(t,oe.getRoleIndex(ie.Streamer),e,i),idViewer:oe.compose(t,oe.getRoleIndex(ie.Viewer),e,i),idSmartDevice:oe.compose(t,oe.getRoleIndex(ie.SmartDevice),e,i),idSelfService:oe.compose(t,oe.getRoleIndex(ie.SelfService),e,i)}}static compose(t,e,i,n){return`${oe.padded(t,9)}-${oe.padded(e,4)}-${i}${n?`-${n}`:""}`}static decompose(t){const e=t.split("-");return{userId:parseInt(e[0]),roleIndex:parseInt(e[1]),timestamp:parseInt(e[2]),pathId:e[3]?parseInt(e[3]):null}}static generateMeetingId(){return(new oe).toRoles()}static getRoleIndex(t){return Object.keys(ie).reduce(((e,i,n)=>ie[i]===t?n:e),-1)}static padded(t,e){const i="000000000"+t;return i.substr(i.length-e)}}class re{get meetingId(){return this.link?new oe(this.link):null}constructor(t){if("string"==typeof(t=t||window.location.href)&&(t=re.decompose(t)),"object"==typeof t){if(Object.assign(this,t),t.user){const e=re.getName(t.user);if(e&&(this.name=e),x.flags.useExtendedUserInfo){const e=re.getFirstName(t.user);e&&(this.firstName=e);const i=re.getLastName(t.user);i&&(this.lastName=i);const n=re.getEmail(t.user);n&&(this.email=n)}}t.name&&(this.name=t.name),x.flags.useExtendedUserInfo&&(t.firstName&&(this.firstName=t.firstName),t.lastName&&(this.lastName=t.lastName),t.email&&(this.email=t.email))}this.link=this.link||null,this.name=this.name||null,this.firstName=this.firstName||null,this.lastName=this.lastName||null,this.email=this.email||null,this.role=this.role||null,this.viewId=this.viewId||null,this.pathId=this.pathId||null,this.embedViewId=this.embedViewId||null,this.support=this.support||!1}toParams(t){void 0===t&&(t=!1);let e={};return this.link&&(e.link=this.link),x.flags.useExtendedUserInfo?(this.firstName&&(e.firstName=this.firstName),this.lastName&&(e.lastName=this.lastName),this.email&&(e.email=this.email)):this.name&&(e.name=this.name),this.role&&!t&&(e.role=this.role),this.viewId&&(e.viewId=this.viewId),this.pathId&&(e.pathId=this.pathId),this.support&&(e.support=this.support),x.flags.useEncryptedUrl&&(e={p:re.encrypt(e)}),e}toString(t){let e;return void 0===t&&(t=!1),e=x.flags.useExtendedUserInfo?{link:this.link,firstName:this.firstName,lastName:this.lastName,email:this.email,role:t?null:this.role,viewId:this.viewId,pathId:this.pathId,support:this.support}:{link:this.link,name:this.name,role:t?null:this.role,viewId:this.viewId,pathId:this.pathId,support:this.support},re.compose(e)}toUrl(){const t=this.toParams();return re.getCurrentUrl(t)}toAccessCodeUrl(){const t=this.toParams();return re.getAccessCodeUrl(t)}toGuidedTourUrl(){const t=this.toParams();return re.getGuidedTourUrl(t)}copyToClipBoard(t){void 0===t&&(t=!1);const e=document.createElement("input");e.style.position="absolute",e.style.top="1000vh",document.querySelector("body").appendChild(e);const i=this.toParams(!0);e.value=window.location.origin+(t?re.getAccessCodeUrl(i):re.getGuidedTourUrl(i)),e.focus(),e.select(),e.setSelectionRange(0,99999),document.execCommand("copy"),e.parentNode.removeChild(e),alert(`link copiato!\n ${e.value}`)}replaceUrl(){te.setCurrentParams(this.toParams())}static replaceWithOptions(t){const e=re.decompose(window.location.href),i=new re(Object.assign(e,t));return i.replaceUrl(),i}static replaceWithUser(t){return this.replaceWithOptions({user:t})}static replaceWithName(t){return this.replaceWithOptions({name:t})}static replaceWithLink(t){return this.replaceWithOptions({link:t})}static getCurrentUrl(t){void 0===t&&(t=null);const e=te.route;if(e){const i=e.name;return te.buildUrl(i,t)}}static getAccessCodeUrl(t){void 0===t&&(t=null);const e=te.route;if(e){const i=`${e.params.lang}.accessCode`;return te.buildUrl(i,t)}}static getGuidedTourUrl(t){void 0===t&&(t=null);const e=te.route;if(e){const i=`${e.params.lang}.guidedTour`;return te.buildUrl(i,t)}}static getName(t){return t&&t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:null}static getFirstName(t){return t&&t.firstName?t.firstName:null}static getLastName(t){return t&&t.lastName?t.lastName:null}static getEmail(t){return t&&t.email?t.email:null}static compose(t){if(x.flags.useEncryptedUrl){return`?p=${re.encrypt(t)}`}return`?${(t=Object.keys(t).map((e=>({key:e,value:t[e]}))).filter((t=>null!=t.value&&!1!==t.value)).map((t=>`${t.key}=${t.value}`))).join("&")}`}static decompose(t){let e={};if(x.flags.useEncryptedUrl){const i=new URLSearchParams(t.split("?")[1]);i.has("p")&&(e=re.decrypt(i.get("p")))}else if(t.indexOf("?")>-1){new URLSearchParams(t.split("?")[1]).forEach(((t,i)=>{switch(i){case"viewId":case"pathId":case"embedViewId":t=t?parseInt(t):null;break;case"support":t=!!t&&"true"===t}e[i]=t}))}return e}static decrypt(t){return JSON.parse(window.atob(t))}static encrypt(t){return window.btoa(JSON.stringify(t))}static validateParams(t){if(x.flags.useEncryptedUrl){return{p:re.encrypt(t)}}return t}}class ae extends t.Structure{getFactory(t){let e=null;const i=te.routes.find((e=>e.name===t.name));return i&&(e=i.factory),e}onInit(){this.route$().pipe(n.switchMap((t=>this.factory$(t))),n.takeUntil(this.unsubscribe$)).subscribe((t=>{}))}route$(){return te.event$.pipe(n.map((t=>{const e=t.route;return this.route=e,e})))}factory$(e){const s=this.getFactory(e),{module:o,node:r}=t.getContext(this);return this.factory_=s,i.of(s).pipe(n.tap((()=>{this.element&&(this.element.parentNode.removeChild(this.element),o.remove(this.element,this),this.element=void 0,this.instance=void 0)})),n.map((()=>{if(s&&s.meta.template){let t=document.createElement("div");t.innerHTML=s.meta.template,1===t.children.length&&(t=t.firstElementChild),r.appendChild(t);const i=o.makeInstance(t,s,s.meta.selector,this,void 0,{route:e});return o.compile(t,i),this.instance=i,this.element=t,{element:t,instance:i}}})))}onChanges(){}}ae.meta={selector:"router-outlet,[router-outlet]",hosts:{host:ae}};class ce extends t.Component{onInit(){this.state={};const e=new re;if(e.link){const i=e.toGuidedTourUrl(),{node:n}=t.getContext(this);new QRious({element:n.querySelector(".qrcode"),value:i,size:256})}else window.location.href=window.location.origin+re.getGuidedTourUrl()}}function le(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function de(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?le(Object(i),!0).forEach((function(e){he(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):le(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function he(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}ce.meta={selector:"[access-code-component]",hosts:{host:ae},template:`\n\t\t<div class="page page--access-code">\n\t\t\t${g}\n\t\t\t\x3c!-- access-code --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t<div class="title" [innerHTML]="'access_code_title' | label"></div>\n\t\t\t\t\t\t<div class="picture">\n\t\t\t\t\t\t\t<canvas class="qrcode"></canvas>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t${f}\n\t\t\t${E}\n\t\t\t${S}\n\t\t</div>\n\t`};class ue extends t.Component{get group(){if(this.formGroup)return this.formGroup;if(!this.host)throw"missing form collection";return this.host.control}getControl(t){return this.group.get(t)}}function pe(t){return new e.FormGroup(function(t){const i=t.reduce(((t,i,n)=>{const s=[];if(i.required&&s.push("checkbox"===i.type?e.Validators.RequiredTrueValidator():e.Validators.RequiredValidator()),"email"===i.type&&s.push(e.Validators.EmailValidator()),"url"===i.type&&s.push(e.Validators.PatternValidator("(https?://(?:www.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9].[^s]{2,}|www.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9].[^s]{2,}|https?://(?:www.|(?!www))[a-zA-Z0-9]+.[^s]{2,}|www.[a-zA-Z0-9]+.[^s]{2,})")),null!=i.pattern&&s.push(e.Validators.PatternValidator(i.pattern)),t[i.name]=new e.FormControl(null!=i.value?i.value:null,s),"select"===i.type||"custom-select"===i.type){const e=(i.options||[]).slice();e.unshift({id:null,name:"select"}),t[i.name].options=e}return t}),{});return i}(t))}function me(t,e){const i=t.reduce(((t,e,i)=>(e.test&&(t[e.name]=e.test),t)),{});e.patch(i)}ue.meta={selector:"[controls]",inputs:["formGroup","fields"],hosts:{host:e.FormAbstractCollectionDirective},template:'\n\t\t<div *for="let field of fields">\n\t\t\t<div *if="[\'text\', \'email\', \'url\'].indexOf(field.type) !== -1" control-text [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'select\'" control-select [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'custom-select\'" control-custom-select [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'textarea\'" control-textarea [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<div *if="field.type == \'checkbox\'" control-checkbox [control]="getControl(field.name)" [label]="field.label | label"></div>\n\t\t\t<input *if="field.type == \'hidden\'" [name]="field.name" [formControl]="getControl(field.name)" value="" type="text" style="display:none !important;" />\n\t\t</div>\n\t'};class ve extends t.Pipe{static get labels(){return x.labels}static transform(t){if("@copy"===t)return this.getCopy();const e=ve.labels;let i=null!=e[t]?e[t]:t;return"string"==typeof i&&-1!==i.indexOf("@copy")&&(i=i.replace("@copy",this.getCopy())),i}static getKeys(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return ve.transform(e.map((t=>t.replace("-","_"))).join("_"))}static getCopy(){return`©${(new Date).getFullYear()}`}}ve.meta={name:"label"};class ge{static has(t){return new URLSearchParams(window.location.search).has(t)}static get(t){return new URLSearchParams(window.location.search).get(t)}static set(t,e){const i=new URLSearchParams(window.location.search);"string"==typeof t?i.set(t,e):i.set(t,""),this.pushParams(i)}static delete(t){const e=new URLSearchParams(window.location.search);e.has(t)&&(e.delete(t),this.pushParams(e))}static pushParams(t){if(window.history&&window.history.pushState){const e=document.title,i=`${window.location.href.split("?")[0]}?${t.toString()}`;window.history.pushState(t.toString(),e,i)}}static replace(t,e){const i=window.history;if(i&&i.replaceState){const n=window.location,s=document.title;if("/"===n.pathname){const t=n.origin+e+n.search;i.replaceState(i.state,s,t)}else if(-1!==n.href.indexOf(t)){const o=n.href.replace(t,e);i.replaceState(i.state,s,o)}}}static deserialize(t){const e=this.get("params");return this.decode(t,e)}static serialize(t,e){const i=this.deserialize(),n=this.encode(t,e,i);this.set("params",n)}static decode(t,e){let i=null;if(e){const t=window.atob(e);i=JSON.parse(t)}return t&&i&&(i=i[t]),i||null}static encode(t,e,i){i=i||{};let n=null;"string"==typeof t?i[t]=e:i=t;const s=JSON.stringify(i);return n=window.btoa(s),n}}class fe{static get lang(){return this.lang$.getValue()}static set lang(t){this.lang!==t&&this.lang$.next(t)}static setAlternates(t,e){this.languages=e,this.lang=t}static setRoute(t,e){const i=t.params.lang,n=x.languages.map((n=>{const s="it"===n?"Italiano":"English",o=t.name.replace(new RegExp(`(^${i}$)|(^${i}.)`),((t,e,i,s)=>e?n:`${n}.`)),r=e.find((t=>t.name===o));return r?{name:r.name,params:t.params,href:r.path,lang:r.defaultParams.lang,title:s}:null})).filter((t=>null!==t));this.setAlternates(i,n)}static get hasLanguages(){return this.languages.length>1}static get activeLanguage(){return this.languages.find((t=>t.lang===this.lang))}static getDefaultLanguages(){return x.alternates||[]}static getDefaultLanguage(){return x.defaultLanguage||(this.languages?this.languages[0].lang:null)}static setLanguage(t){this.lang=t.lang}static setLanguage$(t){if("string"==typeof t&&(t=this.languages.find((e=>e.lang===t))),!t)return;const e=x.flags.production?`/api/${t.lang}/labels/`:`./api/${t.lang}/labels.json`;return i.from(fetch(e).then((t=>t.json()))).pipe(n.tap((e=>{x.labels=e,te.replaceHistoryState(t.name,t.params);const i=this.activeLanguage.href.split("?")[0],n=t.href.split("?")[0];ge.replace(i,n),this.lang=t.lang})))}static setLanguage$_(t){return i.from(fetch(t.href).then((t=>t.text()))).pipe(n.tap((e=>{const i=/(window\.labels\s*=\s*\n*\s*\{((\{.+?\})|.)+?\})/gms.exec(e);i&&(new Function(i[0]).call(window),ve.setLabels());const n=/(window\.bhere\s*=\s*\n*\s*\{((\{.+?\})|.)+?\})/gms.exec(e);if(n){const t={};new Function(n[0].replace("window","this")).call(t),t.bhere&&w.merge(x,t.bhere)}ge.replace(this.activeLanguage.href,t.href),this.lang=t.lang})))}static toggleLanguages(){this.showLanguages=!this.showLanguages,this.pushChanges()}}fe.languages=fe.getDefaultLanguages(),fe.lang$=new i.BehaviorSubject(fe.getDefaultLanguage());class Ee extends t.Pipe{static transform(t){return t.replace(":lang",fe.lang)}}Ee.meta={name:"route"};const _e=[["480p_1",640,480,15,500,!0],["480p_2",640,480,30,1e3,!0],["480p_3",480,480,15,400,!0],["480p_4",640,480,30,750,!0],["480p_6",480,480,30,600,!0],["480p_8",848,480,15,610,!0],["480p_9",848,480,30,930,!0],["480p_10",640,480,10,400,!0],["720p_1",1280,720,15,1130,!0],["720p_2",1280,720,30,2e3,!0],["720p_3",1280,720,30,1710,!0],["720p_5",960,720,15,910,!0],["720p_6",960,720,30,1380,!0],["1080p_1",1920,1080,15,2080,!1],["1080p_2",1920,1080,30,3e3,!1],["1080p_3",1920,1080,30,3150,!1],["1080p_5",1920,1080,60,4780,!1]].map((t=>({profile:t[0],resolution:{width:t[1],height:t[2]},frameRate:{min:t[3],max:t[3]},bitrate:{min:t[4],max:t[4]},compatible:t[5]})));function Se(t){let e=x.profiles.streamer;switch(t.role){case ie.Publisher:case ie.SmartDevice:e=x.profiles.publisher||x.profiles.streamer;break;case ie.Attendee:e=x.profiles.attendee||x.profiles.streamer}return _e.find((t=>t.profile===e))}const be="idle",Te="checklist",ye="link",we="login",Ce="name",Re="device",Ie="should-connect",Ae="connecting",Oe="connected",Ne="addLike",ke="agoraEvent",Le="channelMembers",Pe="chatMessage",De="chatTypingBegin",Me="chatTypingEnd",xe="controlInfo",Ue="currentTimeMedia",Ve="menuToggle",Be="mode",je="navInfo",Fe="navLink",He="navLinkClose",Ge="navToGrid",$e="navToView",We="playMedia",ze="playModel",Ke="remoteSilencing",qe="requestControl",Ye="requestControlDismiss",Je="requestSpy",Xe="requestSpyDismiss",Qe="selectItem",Ze="setSnapshot",ti="showPanel",ei="slideChange",ii="supportRequest",ni="supportRequestAccepted",si="supportRequestRejected",oi="vrEnded",ri="vrStarted",ai="vrState",ci="zoomMedia",li="virtual-tour",di="live-meeting",hi="self-service-tour",ui="embed",pi="none";class mi{constructor(t){Object.assign(this,t)}}class vi extends mi{}class gi extends mi{}class fi extends mi{}class Ei extends mi{}class _i extends mi{}class Si extends mi{}class bi extends mi{}class Ti extends mi{}class yi{static http$(t,e,s,o){let r=null;return i.from(fetch(e,{method:t,headers:{Accept:"application/json","Content-Type":"application/json"},body:-1!==["POST","PUT","PATCH"].indexOf(t)?JSON.stringify(s):void 0}).then((t=>{r=t;try{const e=t.headers.get("content-type");let i;return i=e&&-1!==e.indexOf("application/json")?t.json():t.text(),t.ok?i:i.then((t=>Promise.reject(t)))}catch(e){return t.ok?(console.warn("HttpService.http$","Cannot parse response"),Promise.resolve()):Promise.reject(e)}}))).pipe(n.catchError((t=>i.throwError(this.getError(t,r)))))}static get$(t,e,i){const n=this.query(e);return this.http$("GET",`${t}${n}`,void 0,i)}static delete$(t){return this.http$("DELETE",t)}static post$(t,e){return this.http$("POST",t,e)}static put$(t,e){return this.http$("PUT",t,e)}static patch$(t,e){return this.http$("PATCH",t,e)}static query(t){return""}static getError(t,e){let i="object"==typeof t?t:{};return i.status||(i.status=e?e.status:0),i.statusCode||(i.statusCode=e?e.status:0),i.statusMessage||(i.statusMessage=e?e.statusText:t),i}}class wi{static setUser(t){this.user$.next(t)}static me$(){return yi.get$("/api/user/me").pipe(n.map((t=>this.mapUser(t))),n.catchError((t=>{if(404===t.status||404===t.statusCode)return i.of(null);throw t})),n.switchMap((t=>(this.setUser(t),this.user$))))}static login$(t){return yi.post$("/api/user/login",t).pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(t))))}static logout$(){return yi.get$("/api/user/logout").pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(null))))}static guidedTour$(t){return yi.post$("/api/user/guided-tour",t).pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(t))))}static selfServiceTour$(t){return yi.post$("/api/user/self-service-tour",t).pipe(n.map((t=>this.mapUser(t))),n.tap((t=>this.setUser(t))))}static selfServiceSupportRequest$(t,e,i){const s={user:t,meetingId:e,link:i};return yi.post$("/api/user/self-service-support-request",s).pipe(n.tap((e=>{x.flags.production||fetch(x.template.email.supportRequest).then((t=>t.text())).then((e=>{e=(e=e.replace("{{username}}",re.getName(t))).replace("{{href}}",i);const n=(new DOMParser).parseFromString(e,"text/html");setTimeout((()=>{const t=window.open();t.document.head.innerHTML=n.querySelector("head").innerHTML,t.document.body.innerHTML=n.querySelector("body").innerHTML}),3e3)}))})))}static resolve$(t,e){return"login"===e?this.login$(t):"guided-tour"===e?this.guidedTour$(t):"self-service-tour"===e?this.selfServiceTour$(t):void 0}static log$(t){return yi.post$("/api/user/log",t)}static temporaryUser$(t){return void 0===t&&(t=ie.Embed),i.of({id:this.uuid(),type:t,username:t}).pipe(n.map((t=>this.mapUser(t))),n.switchMap((t=>(this.setUser(t),this.user$))))}static overrideUser$(t){return void 0===t&&(t=ie.Embed),this.me$().pipe(n.switchMap((e=>e?(e.type=t,e.username=t,this.user$):this.temporaryUser$(t))))}static uuid(){return(new Date).getTime()}static mapUser(t){return new ne(t)}static getMode(t){let e;switch(t){case ie.Attendee:case ie.Streamer:case ie.Viewer:case ie.Publisher:e=li;break;case ie.SelfService:e=hi;break;case ie.SmartDevice:e=di;break;case ie.Embed:e=ui;break;default:e=pi}return e}}wi.user$=new i.BehaviorSubject(null);let Ci=0;class Ri{constructor(t){t&&Object.assign(this,t)}toJson(){return JSON.stringify(this)}static newEvent(t,e,i){console.log("WebhookEvent.newEvent",t,e,i);const n=new Ri,s=(new Date).getTime();return n.timestamp=s,n.id=`${s}-${++Ci}`,n.action=t,n.data=e,i&&(n.extra="string"==typeof i?JSON.parse(i):i),ee.state.link&&(n.meetingId=ee.state.link,n.userSessionId=ee.state.uid,n.userRole=ee.state.role,n.fullName=ee.state.name),n}static parseEvent(t){if(t&&"data"in t){const e="string"==typeof t.data?JSON.parse(t.data):t.data;return"action"in e?new Ri(e):null}return null}}class Ii{static internal$_(t){return i.of(t).pipe(n.tap((t=>{console.log("WebhookService.internal$_.postMessage",t),window.parent&&window.parent.postMessage(t.action,t.toJson())})),n.switchMap((t=>this.event$_.pipe(n.filter((t=>t.id==t.id)),n.first()))),n.map((e=>(console.log("WebhookService.internal$_.handleResponse_",t,e),this.handleResponse_(t,e)))),n.catchError((e=>this.handleError_(t,e))))}static send$_(t,e){return yi.post$(t,e).pipe(n.map((t=>this.handleResponse_(e,t))),n.catchError((t=>this.handleError_(e,t))))}static send$(t,e,n){if(console.log("WebhookService.send$",t,e,n),this.enabled){const s=Ri.newEvent(t,e,n),o=x.webhook.uris.map((t=>"internal"===t?this.internal$_(s):this.send$_(t,s)));return i.forkJoin(o)}return i.of(null)}static handleResponse_(t,e){console.log("WebhookService.handleResponse_",e);const i=Object.assign({},t);return i.remoteStatus=1,i.remoteResponse=e,i}static handleError_(t,e){const n=Object.assign({},t);return n.remoteStatus=0,n.remoteError=e,i.of(n)}static get enabled(){const t=x.webhook,e=t&&t.uris&&t.uris.length>0;return e&&(t.methods=t.methods||{},t.methods.nav=t.methods.nav||[]),e}}Ii.event$_=i.fromEvent(window,"message").pipe(n.map((t=>Ri.parseEvent(t))),n.filter((t=>null!==t)),n.shareReplay(1));class Ai extends t.Component{onInit(){this.state={status:"access"},window.onSSOPopupClose=t=>{"success"===t?(alert("Login Successful"),wi.me$().pipe(n.first()).subscribe((t=>{const e=Ee.transform(":lang.selfServiceTour"),i=x.pathMapper&&x.pathMapper.ssoLogin?x.pathMapper.ssoLogin(t):null;i?te.setRouterLink(e,re.validateParams({pathId:i})):te.setRouterLink(e)}))):alert("Login Failed")}}onSelfServiceTourRequest(){this.initRequestForm(),this.state.status="self-service-tour",this.pushChanges(),N&&-1!==window.navigator.userAgent.indexOf("OculusBrowser")&&(this.test(),this.onSubmit())}onGuidedTourRequest(){this.initRequestForm(),this.state.status="guided-tour",this.pushChanges()}onSSOLogin(t){const e=`${location.protocol}//${location.host}/sso/login`;return window.open(e,"BHere | SSO Login","left=20,top=20,width=600,height=600,toolbar=1,resizable=0"),t.preventDefault(),!1}onSSORegister(t){const e=`${location.protocol}//${location.host}/sso/register`;return window.open(e,"BHere | SSO Register","left=20,top=20,width=600,height=600,toolbar=1,resizable=0"),t.preventDefault(),!1}onGuidedTourAccess(){wi.logout$().pipe(n.first()).subscribe((()=>{te.setRouterLink(Ee.transform(":lang.guidedTour"))}))}onLogin(){this.initLoginForm(),this.state.status="login",this.pushChanges()}initRequestForm(){this.formSubscription&&this.formSubscription.unsubscribe();const t=this.data=x.data||{roles:[{id:1,name:"Show room"},{id:2,name:"Architetto"},{id:3,name:"Interior designer"},{id:4,name:"Privato"},{id:5,name:"Altro"}]},e=this.fields=x.fields||[{type:"text",name:"firstName",label:"access_first_name",required:!0,test:"Jhon"},{type:"text",name:"lastName",label:"access_last_name",required:!0,test:"Appleseed"},{type:"email",name:"email",label:"access_email",required:!0,test:"jhonappleseed@gmail.com"},{type:"custom-select",name:"role",label:"access_role",required:!0,options:t.roles,test:t.roles[0].id},{type:"checkbox",name:"privacy",label:"access_privacy_disclaimer",required:!0,test:!0}];e.push({type:"hidden",name:"checkField",value:"",test:""}),x.antiforgery&&e.push({type:"none",name:"checkRequest",value:x.antiforgery,test:x.antiforgery});const i=this.form=pe(e);this.controls=i.controls,this.formSubscription=i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),this.error=null}initLoginForm(){this.formSubscription&&this.formSubscription.unsubscribe();const t=this.form=new e.FormGroup({username:new e.FormControl(null,e.Validators.RequiredValidator()),password:new e.FormControl(null,e.Validators.RequiredValidator()),checkRequest:window.antiforgery||"",checkField:""});this.controls=t.controls,this.formSubscription=t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),this.error=null}test(){"login"===this.state.status?this.form.patch({username:"publisher",password:"publisher",checkRequest:window.antiforgery||"",checkField:""}):me(this.fields,this.form)}reset(){this.form.reset()}onBack(){this.state.status="access",this.pushChanges()}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e=de({},t),i=this.controls;Object.keys(e).forEach((t=>{if(i[t].options){const n=i[t].options;e[t]=n.find((i=>i.id===e[t])).name}}));const s=this.state.status;wi.resolve$(t,s).pipe(n.first()).subscribe((t=>{switch(console.log("!!!"),console.log("AccessComponent.onSubmit",t),s){case"guided-tour":this.onHandleHook("GuidedTour",e).pipe(n.first()).subscribe((t=>{this.state.status="guided-tour-success",this.pushChanges()}));break;case"self-service-tour":this.onHandleHook("SelfServiceTour",e).pipe(n.first()).subscribe((e=>{const i=Ee.transform(":lang.selfServiceTour"),n=x.pathMapper&&x.pathMapper.selfService?x.pathMapper.selfService(t):null;n?te.setRouterLink(i,re.validateParams({pathId:n})):te.setRouterLink(i)}));break;case"login":te.setRouterLink(Ee.transform(":lang.guidedTour"))}this.form.reset()}),(t=>{console.log("AccessComponent.error",t),this.error=t,this.pushChanges()}))}else this.form.touched=!0}isValid(){return this.form.valid}onHandleHook(t,e){const i=e;return Ii.send$(t,i,null)}}Ai.meta={selector:"[access-component]",hosts:{host:ae},template:`\n\t\t<div class="page page--access">\n\t\t\t\x3c!-- background --\x3e\n\t\t\t<div class="background" [class]="{ 'background--image': ('background.image' | env), 'background--video': ('background.video' | env) }" *if="state.status != 'connected'">\n\t\t\t\t<img [src]="'background.image' | env | asset" *if="'background.image' | env" />\n\t\t\t\t<video [src]="'background.video' | env | asset" *if="'background.video' | env" oncanplay="this.muted = true; this.classList.add('ready');" playsinline autoplay muted loop></video>\n\t\t\t</div>\n\t\t\t\x3c!-- access --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'access'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t<div class="title" [innerHTML]="'access_title' | label"></div>\n\t\t\t\t\t\t<div *if="'selfService' | flag">\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onSelfServiceTourRequest($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_tour' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'guidedTourRequest' | flag">\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_or' | label"></div>\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onGuidedTourRequest($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_guided_tour' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'guidedTourAccess' | flag">\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_has_meeting_id' | label"></div>\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onGuidedTourAccess($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_guided_tour_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'ssoLogin' | flag">\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_sso_login_info' | label"></div>\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onSSOLogin($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_sso_login_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div *if="'ssoRegister' | flag">\n\t\t\t\t\t\t\t<div class="info" [innerHTML]="'access_sso_register_info' | label"></div>\n\t\t\t\t\t\t\t<button type="button" class="btn--next" (click)="onSSORegister($event)">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_sso_register_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- guided-tour --\x3e\n\t\t\t<div class="ui ui--info" *if="state.status == 'self-service-tour' || state.status == 'guided-tour'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t\t<div class="title" *if="state.status == 'self-service-tour'" [innerHTML]="'access_fill_fields' | label"></div>\n\t\t\t\t\t\t\t<div class="title" *if="state.status == 'guided-tour'" [innerHTML]="'access_guided_tour_request' | label"></div>\n\t\t\t\t\t\t\t\x3c!-- controls --\x3e\n\t\t\t\t\t\t\t<div controls [formGroup]="form" [fields]="fields"></div>\n\t\t\t\t\t\t\t<div class="group--error" *if="error">\n\t\t\t\t\t\t\t\t<span class="status-code" [innerHTML]="error.statusCode"></span>\n\t\t\t\t\t\t\t\t<span class="status-message" [innerHTML]="error.statusMessage"></span>\n\t\t\t\t\t\t\t\t<span class="friendly-message" [innerHTML]="error.friendlyMessage"></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\x3c!-- <div class="info" *if="isValid()" [innerHTML]="'access_take_part' | label"></div> --\x3e\n\t\t\t\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t\t\t\t<span *if="!form.submitted" [innerHTML]="'access_send' | label"></span>\n\t\t\t\t\t\t\t\t<span *if="form.submitted" [innerHTML]="'access_sent' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="btn--mode" (click)="onBack($event)">\n\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_back' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- guided-tour success --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'guided-tour-success'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t<div class="title" [innerHTML]="'access_request_sent' | label"></div>\n\t\t\t\t\t\t<div class="info" [innerHTML]="'access_info_request' | label"></div>\n\t\t\t\t\t\t<button type="button" class="btn--mode" (click)="onBack($event)">\n\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t\t\t<span [innerHTML]="'access_back' | label"></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- login --\x3e\n\t\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'login'">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="'access_login' | label"></div>\n\t\t\t\t\t\t\t<input name="checkField" [formControl]="controls.checkField" value="" type="text" style="display:none !important;" />\n\t\t\t\t\t\t\t<div control-text [control]="controls.username" [label]="'access_username' | label"></div>\n\t\t\t\t\t\t\t<div control-password [control]="controls.password" [label]="'access_password' | label"></div>\n\t\t\t\t\t\t\t<div class="group--error" *if="error">\n\t\t\t\t\t\t\t\t<span class="status-code" [innerHTML]="error.statusCode"></span>\n\t\t\t\t\t\t\t\t<span class="status-message" [innerHTML]="error.statusMessage"></span>\n\t\t\t\t\t\t\t\t<span class="friendly-message" [innerHTML]="error.friendlyMessage"></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="'access_cta' | label"></div>\n\t\t\t\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_cta' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="btn--mode" (click)="onBack($event)">\n\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t\t\t\t<span [innerHTML]="'access_back' | label"></span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<header>\n\t\t\t\t\x3c!-- logo --\x3e\n\t\t\t\t<div class="btn--logo" (click)="onBack($event)">\n\t\t\t\t\t<img [src]="'logo' | env" *if="'logo' | env" />\n\t\t\t\t\t<svg viewBox="0 0 270 98" *if="!('logo' | env)"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t</div>\n\t\t\t\t${S}\n\t\t\t</header>\n\t\t\t<footer>\n\t\t\t\t<span class="group--colophon" *if="state.status != 'connected'">\n\t\t\t\t\t${E}\n\t\t\t\t\t${_}\n\t\t\t\t</span>\n\t\t\t\t\x3c!-- login --\x3e\n\t\t\t\t<button type="button" class="btn--absolute" (click)="onLogin($event)" *if="state.status == 'access'">\n\t\t\t\t\t<span [innerHTML]="'access_cta' | label"></span> <svg class="lock" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#lock"></use></svg>\n\t\t\t\t</button>\n\t\t\t</footer>\n\t\t</div>\n\t`};class Oi{static emoji$(){return null!=Oi.items_?i.of(Oi.items_):yi.get$(`${x.assets}api/emoji/emoji.json`).pipe(n.map((t=>(Oi.items_=t,t))))}}class Ni extends t.Component{onInit(){this.items=[],Oi.emoji$().pipe(n.first()).subscribe((t=>{setTimeout((()=>{this.items=t,this.pushChanges()}),1)}))}onSelect(t){this.emoji.next(t)}onClose(t){this.close.next()}}Ni.meta={selector:"[agora-chat-emoji]",outputs:["emoji","close"]};class ki{static message(t){this.message$.next(t)}static in(t){this.in$.next(t)}static sendBack(t){t=Object.assign({},t,{remoteId:t.clientId}),this.in$.next(t)}static out(t){this.out$.next(t)}}ki.message$=new i.ReplaySubject(1),ki.in$=new i.ReplaySubject(1),ki.send=ki.in,ki.out$=new i.ReplaySubject(1);var Li="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Pi(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Di={exports:{}};!function(t,e){t.exports=function(){function t(t,e){return e.forEach((function(e){e&&"string"!=typeof e&&!Array.isArray(e)&&Object.keys(e).forEach((function(i){if("default"!==i&&!(i in t)){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})}}))})),Object.freeze(t)}var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==Li?Li:"undefined"!=typeof self?self:{},i=function(t){try{return!!t()}catch(t){return!0}},n=!i((function(){var t=function(){}.bind();return"function"!=typeof t||t.hasOwnProperty("prototype")})),s=n,o=Function.prototype,r=o.bind,a=o.call,c=s&&r.bind(a,a),l=s?function(t){return t&&c(t)}:function(t){return t&&function(){return a.apply(t,arguments)}},d=l({}.isPrototypeOf),h=function(t){return t&&t.Math==Math&&t},u=h("object"==typeof globalThis&&globalThis)||h("object"==typeof window&&window)||h("object"==typeof self&&self)||h("object"==typeof e&&e)||function(){return this}()||Function("return this")(),p=n,m=Function.prototype,v=m.apply,g=m.call,f="object"==typeof Reflect&&Reflect.apply||(p?g.bind(v):function(){return g.apply(v,arguments)}),E=function(t){return"function"==typeof t},_={},S=!i((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),b=n,T=Function.prototype.call,y=b?T.bind(T):function(){return T.apply(T,arguments)},w={},C={}.propertyIsEnumerable,R=Object.getOwnPropertyDescriptor,I=R&&!C.call({1:2},1);w.f=I?function(t){var e=R(this,t);return!!e&&e.enumerable}:C;var A,O,N=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},k=l,L=k({}.toString),P=k("".slice),D=function(t){return P(L(t),8,-1)},M=l,x=i,U=D,V=u.Object,B=M("".split),j=x((function(){return!V("z").propertyIsEnumerable(0)}))?function(t){return"String"==U(t)?B(t,""):V(t)}:V,F=u.TypeError,H=function(t){if(null==t)throw F("Can't call method on "+t);return t},G=j,$=H,W=function(t){return G($(t))},z=E,K=function(t){return"object"==typeof t?null!==t:z(t)},q={},Y=q,J=u,X=E,Q=function(t){return X(t)?t:void 0},Z=function(t,e){return arguments.length<2?Q(Y[t])||Q(J[t]):Y[t]&&Y[t][e]||J[t]&&J[t][e]},tt=Z("navigator","userAgent")||"",et=u,it=tt,nt=et.process,st=et.Deno,ot=nt&&nt.versions||st&&st.version,rt=ot&&ot.v8;rt&&(O=(A=rt.split("."))[0]>0&&A[0]<4?1:+(A[0]+A[1])),!O&&it&&(!(A=it.match(/Edge\/(\d+)/))||A[1]>=74)&&(A=it.match(/Chrome\/(\d+)/))&&(O=+A[1]);var at=O,ct=at,lt=i,dt=!!Object.getOwnPropertySymbols&&!lt((function(){var t=Symbol();return!String(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&ct&&ct<41})),ht=dt&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,ut=Z,pt=E,mt=d,vt=ht,gt=u.Object,ft=vt?function(t){return"symbol"==typeof t}:function(t){var e=ut("Symbol");return pt(e)&&mt(e.prototype,gt(t))},Et=u.String,_t=function(t){try{return Et(t)}catch(t){return"Object"}},St=E,bt=_t,Tt=u.TypeError,yt=function(t){if(St(t))return t;throw Tt(bt(t)+" is not a function")},wt=yt,Ct=function(t,e){var i=t[e];return null==i?void 0:wt(i)},Rt=y,It=E,At=K,Ot=u.TypeError,Nt={exports:{}},kt=u,Lt=Object.defineProperty,Pt=function(t,e){try{Lt(kt,t,{value:e,configurable:!0,writable:!0})}catch(i){kt[t]=e}return e},Dt="__core-js_shared__",Mt=u[Dt]||Pt(Dt,{}),xt=Mt;(Nt.exports=function(t,e){return xt[t]||(xt[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.20.3",mode:"pure",copyright:"© 2014-2022 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.20.3/LICENSE",source:"https://github.com/zloirock/core-js"});var Ut=H,Vt=u.Object,Bt=function(t){return Vt(Ut(t))},jt=Bt,Ft=l({}.hasOwnProperty),Ht=Object.hasOwn||function(t,e){return Ft(jt(t),e)},Gt=l,$t=0,Wt=Math.random(),zt=Gt(1..toString),Kt=function(t){return"Symbol("+(void 0===t?"":t)+")_"+zt(++$t+Wt,36)},qt=u,Yt=Nt.exports,Jt=Ht,Xt=Kt,Qt=dt,Zt=ht,te=Yt("wks"),ee=qt.Symbol,ie=ee&&ee.for,ne=Zt?ee:ee&&ee.withoutSetter||Xt,se=function(t){if(!Jt(te,t)||!Qt&&"string"!=typeof te[t]){var e="Symbol."+t;Qt&&Jt(ee,t)?te[t]=ee[t]:te[t]=Zt&&ie?ie(e):ne(e)}return te[t]},oe=y,re=K,ae=ft,ce=Ct,le=function(t,e){var i,n;if("string"===e&&It(i=t.toString)&&!At(n=Rt(i,t)))return n;if(It(i=t.valueOf)&&!At(n=Rt(i,t)))return n;if("string"!==e&&It(i=t.toString)&&!At(n=Rt(i,t)))return n;throw Ot("Can't convert object to primitive value")},de=se,he=u.TypeError,ue=de("toPrimitive"),pe=function(t,e){if(!re(t)||ae(t))return t;var i,n=ce(t,ue);if(n){if(void 0===e&&(e="default"),i=oe(n,t,e),!re(i)||ae(i))return i;throw he("Can't convert object to primitive value")}return void 0===e&&(e="number"),le(t,e)},me=ft,ve=function(t){var e=pe(t,"string");return me(e)?e:e+""},ge=K,fe=u.document,Ee=ge(fe)&&ge(fe.createElement),_e=function(t){return Ee?fe.createElement(t):{}},Se=_e,be=!S&&!i((function(){return 7!=Object.defineProperty(Se("div"),"a",{get:function(){return 7}}).a})),Te=S,ye=y,we=w,Ce=N,Re=W,Ie=ve,Ae=Ht,Oe=be,Ne=Object.getOwnPropertyDescriptor;_.f=Te?Ne:function(t,e){if(t=Re(t),e=Ie(e),Oe)try{return Ne(t,e)}catch(t){}if(Ae(t,e))return Ce(!ye(we.f,t,e),t[e])};var ke=i,Le=E,Pe=/#|\.prototype\./,De=function(t,e){var i=xe[Me(t)];return i==Ve||i!=Ue&&(Le(e)?ke(e):!!e)},Me=De.normalize=function(t){return String(t).replace(Pe,".").toLowerCase()},xe=De.data={},Ue=De.NATIVE="N",Ve=De.POLYFILL="P",Be=De,je=yt,Fe=n,He=l(l.bind),Ge=function(t,e){return je(t),void 0===e?t:Fe?He(t,e):function(){return t.apply(e,arguments)}},$e={},We=S&&i((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),ze=u,Ke=K,qe=ze.String,Ye=ze.TypeError,Je=function(t){if(Ke(t))return t;throw Ye(qe(t)+" is not an object")},Xe=S,Qe=be,Ze=We,ti=Je,ei=ve,ii=u.TypeError,ni=Object.defineProperty,si=Object.getOwnPropertyDescriptor,oi="enumerable",ri="configurable",ai="writable";$e.f=Xe?Ze?function(t,e,i){if(ti(t),e=ei(e),ti(i),"function"==typeof t&&"prototype"===e&&"value"in i&&ai in i&&!i.writable){var n=si(t,e);n&&n.writable&&(t[e]=i.value,i={configurable:ri in i?i.configurable:n.configurable,enumerable:oi in i?i.enumerable:n.enumerable,writable:!1})}return ni(t,e,i)}:ni:function(t,e,i){if(ti(t),e=ei(e),ti(i),Qe)try{return ni(t,e,i)}catch(t){}if("get"in i||"set"in i)throw ii("Accessors not supported");return"value"in i&&(t[e]=i.value),t};var ci=$e,li=N,di=S?function(t,e,i){return ci.f(t,e,li(1,i))}:function(t,e,i){return t[e]=i,t},hi=u,ui=f,pi=l,mi=E,vi=_.f,gi=Be,fi=q,Ei=Ge,_i=di,Si=Ht,bi=function(t){var e=function(i,n,s){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(i);case 2:return new t(i,n)}return new t(i,n,s)}return ui(t,this,arguments)};return e.prototype=t.prototype,e},Ti=function(t,e){var i,n,s,o,r,a,c,l,d=t.target,h=t.global,u=t.stat,p=t.proto,m=h?hi:u?hi[d]:(hi[d]||{}).prototype,v=h?fi:fi[d]||_i(fi,d,{})[d],g=v.prototype;for(s in e)i=!gi(h?s:d+(u?".":"#")+s,t.forced)&&m&&Si(m,s),r=v[s],i&&(a=t.noTargetGet?(l=vi(m,s))&&l.value:m[s]),o=i&&a?a:e[s],i&&typeof r==typeof o||(c=t.bind&&i?Ei(o,hi):t.wrap&&i?bi(o):p&&mi(o)?pi(o):o,(t.sham||o&&o.sham||r&&r.sham)&&_i(c,"sham",!0),_i(v,s,c),p&&(Si(fi,n=d+"Prototype")||_i(fi,n,{}),_i(fi[n],s,o),t.real&&g&&!g[s]&&_i(g,s,o)))},yi=Math.ceil,wi=Math.floor,Ci=function(t){var e=+t;return e!=e||0===e?0:(e>0?wi:yi)(e)},Ri=Ci,Ii=Math.min,Ai=function(t){return t>0?Ii(Ri(t),9007199254740991):0},Oi=function(t){return Ai(t.length)},Ni=yt,ki=Bt,Pi=j,Di=Oi,Mi=u.TypeError,xi=function(t){return function(e,i,n,s){Ni(i);var o=ki(e),r=Pi(o),a=Di(o),c=t?a-1:0,l=t?-1:1;if(n<2)for(;;){if(c in r){s=r[c],c+=l;break}if(c+=l,t?c<0:a<=c)throw Mi("Reduce of empty array with no initial value")}for(;t?c>=0:a>c;c+=l)c in r&&(s=i(s,r[c],c,o));return s}},Ui={left:xi(!1),right:xi(!0)},Vi=i,Bi=function(t,e){var i=[][t];return!!i&&Vi((function(){i.call(null,e||function(){throw 1},1)}))},ji="process"==D(u.process),Fi=Ui.left,Hi=at,Gi=ji;Ti({target:"Array",proto:!0,forced:!Bi("reduce")||!Gi&&Hi>79&&Hi<83},{reduce:function(t){var e=arguments.length;return Fi(this,t,e,e>1?arguments[1]:void 0)}});var $i=q,Wi=function(t){return $i[t+"Prototype"]},zi=Wi("Array").reduce,Ki=d,qi=zi,Yi=Array.prototype,Ji=function(t){var e=t.reduce;return t===Yi||Ki(Yi,t)&&e===Yi.reduce?qi:e},Xi=Ji;let Qi=!0,Zi=!0;function tn(t,e,i){const n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function en(t,e,i){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(t,n){if(t!==e)return s.apply(this,arguments);const o=t=>{const e=i(t);e&&(n.handleEvent?n.handleEvent(e):n(e))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(n,o),s.apply(this,[t,o])};const o=n.removeEventListener;n.removeEventListener=function(t,i){if(t!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(i))return o.apply(this,arguments);const n=this._eventMap[e].get(i);return this._eventMap[e].delete(i),0===this._eventMap[e].size&&delete this._eventMap[e],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[t,n])},Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(t){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),t&&this.addEventListener(e,this["_on"+e]=t)},enumerable:!0,configurable:!0})}function nn(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(Qi=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function sn(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(Zi=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function on(){if("object"==typeof window){if(Qi)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function rn(t,e){Zi&&console.warn(t+" is deprecated, please use "+e+" instead.")}function an(t){const e={browser:null,version:null};if(void 0===t||!t.navigator)return e.browser="Not a browser.",e;const{navigator:i}=t;if(i.mozGetUserMedia)e.browser="firefox",e.version=tn(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===t.isSecureContext&&t.webkitRTCPeerConnection)e.browser="chrome",e.version=tn(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!t.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return e.browser="Not a supported browser.",e;e.browser="safari",e.version=tn(i.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype}return e}function cn(t){return"[object Object]"===Object.prototype.toString.call(t)}function ln(t){var e;return cn(t)?Xi(e=Object.keys(t)).call(e,(function(e,i){const n=cn(t[i]),s=n?ln(t[i]):t[i],o=n&&!Object.keys(s).length;return void 0===s||o?e:Object.assign(e,{[i]:s})}),{}):t}function dn(t,e,i){const n=i?"outbound-rtp":"inbound-rtp",s=new Map;if(null===e)return s;const o=[];return t.forEach((t=>{"track"===t.type&&t.trackIdentifier===e.id&&o.push(t)})),o.forEach((e=>{t.forEach((i=>{i.type===n&&i.trackId===e.id&&function t(e,i,n){i&&!n.has(i.id)&&(n.set(i.id,i),Object.keys(i).forEach((s=>{s.endsWith("Id")?t(e,e.get(i[s]),n):s.endsWith("Ids")&&i[s].forEach((i=>{t(e,e.get(i),n)}))})))}(t,i,s)}))})),s}var hn=Nt.exports,un=Kt,pn=hn("keys"),mn=function(t){return pn[t]||(pn[t]=un(t))},vn=!i((function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype})),gn=u,fn=Ht,En=E,_n=Bt,Sn=vn,bn=mn("IE_PROTO"),Tn=gn.Object,yn=Tn.prototype,wn=Sn?Tn.getPrototypeOf:function(t){var e=_n(t);if(fn(e,bn))return e[bn];var i=e.constructor;return En(i)&&e instanceof i?i.prototype:e instanceof Tn?yn:null},Cn=u,Rn=E,In=Cn.String,An=Cn.TypeError,On=l,Nn=Je,kn=function(t){if("object"==typeof t||Rn(t))return t;throw An("Can't set "+In(t)+" as a prototype")},Ln=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,i={};try{(t=On(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(i,[]),e=i instanceof Array}catch(t){}return function(i,n){return Nn(i),kn(n),e?t(i,n):i.__proto__=n,i}}():void 0),Pn={},Dn=Ci,Mn=Math.max,xn=Math.min,Un=function(t,e){var i=Dn(t);return i<0?Mn(i+e,0):xn(i,e)},Vn=W,Bn=Un,jn=Oi,Fn=function(t){return function(e,i,n){var s,o=Vn(e),r=jn(o),a=Bn(n,r);if(t&&i!=i){for(;r>a;)if((s=o[a++])!=s)return!0}else for(;r>a;a++)if((t||a in o)&&o[a]===i)return t||a||0;return!t&&-1}},Hn={includes:Fn(!0),indexOf:Fn(!1)},Gn={},$n=Ht,Wn=W,zn=Hn.indexOf,Kn=Gn,qn=l([].push),Yn=function(t,e){var i,n=Wn(t),s=0,o=[];for(i in n)!$n(Kn,i)&&$n(n,i)&&qn(o,i);for(;e.length>s;)$n(n,i=e[s++])&&(~zn(o,i)||qn(o,i));return o},Jn=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Xn=Yn,Qn=Jn.concat("length","prototype");Pn.f=Object.getOwnPropertyNames||function(t){return Xn(t,Qn)};var Zn={};Zn.f=Object.getOwnPropertySymbols;var ts=Z,es=Pn,is=Zn,ns=Je,ss=l([].concat),os=ts("Reflect","ownKeys")||function(t){var e=es.f(ns(t)),i=is.f;return i?ss(e,i(t)):e},rs=Ht,as=os,cs=_,ls=$e,ds={},hs=Yn,us=Jn,ps=Object.keys||function(t){return hs(t,us)},ms=S,vs=We,gs=$e,fs=Je,Es=W,_s=ps;ds.f=ms&&!vs?Object.defineProperties:function(t,e){fs(t);for(var i,n=Es(e),s=_s(e),o=s.length,r=0;o>r;)gs.f(t,i=s[r++],n[i]);return t};var Ss,bs=Z("document","documentElement"),Ts=Je,ys=ds,ws=Jn,Cs=Gn,Rs=bs,Is=_e,As=mn("IE_PROTO"),Os=function(){},Ns=function(t){return"<script>"+t+"<\/script>"},ks=function(t){t.write(Ns("")),t.close();var e=t.parentWindow.Object;return t=null,e},Ls=function(){try{Ss=new ActiveXObject("htmlfile")}catch(t){}var t,e;Ls="undefined"!=typeof document?document.domain&&Ss?ks(Ss):((e=Is("iframe")).style.display="none",Rs.appendChild(e),e.src=String("javascript:"),(t=e.contentWindow.document).open(),t.write(Ns("document.F=Object")),t.close(),t.F):ks(Ss);for(var i=ws.length;i--;)delete Ls.prototype[ws[i]];return Ls()};Cs[As]=!0;var Ps=Object.create||function(t,e){var i;return null!==t?(Os.prototype=Ts(t),i=new Os,Os.prototype=null,i[As]=t):i=Ls(),void 0===e?i:ys.f(i,e)},Ds=l("".replace),Ms=String(Error("zxcasd").stack),xs=/\n\s*at [^:]*:[^\n]*/,Us=xs.test(Ms),Vs=K,Bs=di,js={},Fs=js,Hs=se("iterator"),Gs=Array.prototype,$s={};$s[se("toStringTag")]="z";var Ws="[object z]"===String($s),zs=u,Ks=Ws,qs=E,Ys=D,Js=se("toStringTag"),Xs=zs.Object,Qs="Arguments"==Ys(function(){return arguments}()),Zs=Ks?Ys:function(t){var e,i,n;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(i=function(t,e){try{return t[e]}catch(t){}}(e=Xs(t),Js))?i:Qs?Ys(e):"Object"==(n=Ys(e))&&qs(e.callee)?"Arguments":n},to=Zs,eo=Ct,io=js,no=se("iterator"),so=function(t){if(null!=t)return eo(t,no)||eo(t,"@@iterator")||io[to(t)]},oo=y,ro=yt,ao=Je,co=_t,lo=so,ho=u.TypeError,uo=y,po=Je,mo=Ct,vo=Ge,go=y,fo=Je,Eo=_t,_o=function(t){return void 0!==t&&(Fs.Array===t||Gs[Hs]===t)},So=Oi,bo=d,To=function(t,e){var i=arguments.length<2?lo(t):e;if(ro(i))return ao(oo(i,t));throw ho(co(t)+" is not iterable")},yo=so,wo=function(t,e,i){var n,s;po(t);try{if(!(n=mo(t,"return"))){if("throw"===e)throw i;return i}n=uo(n,t)}catch(t){s=!0,n=t}if("throw"===e)throw i;if(s)throw n;return po(n),i},Co=u.TypeError,Ro=function(t,e){this.stopped=t,this.result=e},Io=Ro.prototype,Ao=function(t,e,i){var n,s,o,r,a,c,l,d=i&&i.that,h=!(!i||!i.AS_ENTRIES),u=!(!i||!i.IS_ITERATOR),p=!(!i||!i.INTERRUPTED),m=vo(e,d),v=function(t){return n&&wo(n,"normal",t),new Ro(!0,t)},g=function(t){return h?(fo(t),p?m(t[0],t[1],v):m(t[0],t[1])):p?m(t,v):m(t)};if(u)n=t;else{if(!(s=yo(t)))throw Co(Eo(t)+" is not iterable");if(_o(s)){for(o=0,r=So(t);r>o;o++)if((a=g(t[o]))&&bo(Io,a))return a;return new Ro(!1)}n=To(t,s)}for(c=n.next;!(l=go(c,n)).done;){try{a=g(l.value)}catch(t){wo(n,"throw",t)}if("object"==typeof a&&a&&bo(Io,a))return a}return new Ro(!1)},Oo=Zs,No=u.String,ko=function(t){if("Symbol"===Oo(t))throw TypeError("Cannot convert a Symbol value to a string");return No(t)},Lo=ko,Po=N,Do=!i((function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",Po(1,7)),7!==t.stack)})),Mo=Ti,xo=u,Uo=d,Vo=wn,Bo=Ln,jo=function(t,e,i){for(var n=as(e),s=ls.f,o=cs.f,r=0;r<n.length;r++){var a=n[r];rs(t,a)||i&&rs(i,a)||s(t,a,o(e,a))}},Fo=Ps,Ho=di,Go=N,$o=function(t,e){if(Us&&"string"==typeof t)for(;e--;)t=Ds(t,xs,"");return t},Wo=function(t,e){Vs(e)&&"cause"in e&&Bs(t,"cause",e.cause)},zo=Ao,Ko=function(t,e){return void 0===t?arguments.length<2?"":e:Lo(t)},qo=Do,Yo=se("toStringTag"),Jo=xo.Error,Xo=[].push,Qo=function(t,e){var i,n=arguments.length>2?arguments[2]:void 0,s=Uo(Zo,this);Bo?i=Bo(new Jo,s?Vo(this):Zo):(i=s?this:Fo(Zo),Ho(i,Yo,"Error")),void 0!==e&&Ho(i,"message",Ko(e)),qo&&Ho(i,"stack",$o(i.stack,1)),Wo(i,n);var o=[];return zo(t,Xo,{that:o}),Ho(i,"errors",o),i};Bo?Bo(Qo,Jo):jo(Qo,Jo,{name:!0});var Zo=Qo.prototype=Fo(Jo.prototype,{constructor:Go(1,Qo),message:Go(1,""),name:Go(1,"AggregateError")});Mo({global:!0},{AggregateError:Qo});var tr=E,er=Mt,ir=l(Function.toString);tr(er.inspectSource)||(er.inspectSource=function(t){return ir(t)});var nr,sr,or,rr=er.inspectSource,ar=E,cr=rr,lr=u.WeakMap,dr=ar(lr)&&/native code/.test(cr(lr)),hr=u,ur=l,pr=K,mr=di,vr=Ht,gr=Mt,fr=mn,Er=Gn,_r="Object already initialized",Sr=hr.TypeError,br=hr.WeakMap;if(dr||gr.state){var Tr=gr.state||(gr.state=new br),yr=ur(Tr.get),wr=ur(Tr.has),Cr=ur(Tr.set);nr=function(t,e){if(wr(Tr,t))throw new Sr(_r);return e.facade=t,Cr(Tr,t,e),e},sr=function(t){return yr(Tr,t)||{}},or=function(t){return wr(Tr,t)}}else{var Rr=fr("state");Er[Rr]=!0,nr=function(t,e){if(vr(t,Rr))throw new Sr(_r);return e.facade=t,mr(t,Rr,e),e},sr=function(t){return vr(t,Rr)?t[Rr]:{}},or=function(t){return vr(t,Rr)}}var Ir,Ar,Or,Nr={set:nr,get:sr,has:or,enforce:function(t){return or(t)?sr(t):nr(t,{})},getterFor:function(t){return function(e){var i;if(!pr(e)||(i=sr(e)).type!==t)throw Sr("Incompatible receiver, "+t+" required");return i}}},kr=S,Lr=Ht,Pr=Function.prototype,Dr=kr&&Object.getOwnPropertyDescriptor,Mr=Lr(Pr,"name"),xr={EXISTS:Mr,PROPER:Mr&&"something"===function(){}.name,CONFIGURABLE:Mr&&(!kr||kr&&Dr(Pr,"name").configurable)},Ur=di,Vr=function(t,e,i,n){n&&n.enumerable?t[e]=i:Ur(t,e,i)},Br=i,jr=E,Fr=Ps,Hr=wn,Gr=Vr,$r=se("iterator"),Wr=!1;[].keys&&("next"in(Or=[].keys())?(Ar=Hr(Hr(Or)))!==Object.prototype&&(Ir=Ar):Wr=!0);var zr=null==Ir||Br((function(){var t={};return Ir[$r].call(t)!==t}));jr((Ir=zr?{}:Fr(Ir))[$r])||Gr(Ir,$r,(function(){return this}));var Kr={IteratorPrototype:Ir,BUGGY_SAFARI_ITERATORS:Wr},qr=Zs,Yr=Ws?{}.toString:function(){return"[object "+qr(this)+"]"},Jr=Ws,Xr=$e.f,Qr=di,Zr=Ht,ta=Yr,ea=se("toStringTag"),ia=function(t,e,i,n){if(t){var s=i?t:t.prototype;Zr(s,ea)||Xr(s,ea,{configurable:!0,value:e}),n&&!Jr&&Qr(s,"toString",ta)}},na=Kr.IteratorPrototype,sa=Ps,oa=N,ra=ia,aa=js,ca=function(){return this},la=Ti,da=y,ha=function(t,e,i,n){var s=e+" Iterator";return t.prototype=sa(na,{next:oa(+!n,i)}),ra(t,s,!1,!0),aa[s]=ca,t},ua=wn,pa=ia,ma=Vr,va=js,ga=xr.PROPER,fa=Kr.BUGGY_SAFARI_ITERATORS,Ea=se("iterator"),_a="keys",Sa="values",ba="entries",Ta=function(){return this},ya=function(t,e,i,n,s,o,r){ha(i,e,n);var a,c,l,d=function(t){if(t===s&&v)return v;if(!fa&&t in p)return p[t];switch(t){case _a:case Sa:case ba:return function(){return new i(this,t)}}return function(){return new i(this)}},h=e+" Iterator",u=!1,p=t.prototype,m=p[Ea]||p["@@iterator"]||s&&p[s],v=!fa&&m||d(s),g="Array"==e&&p.entries||m;if(g&&(a=ua(g.call(new t)))!==Object.prototype&&a.next&&(pa(a,h,!0,!0),va[h]=Ta),ga&&s==Sa&&m&&m.name!==Sa&&(u=!0,v=function(){return da(m,this)}),s)if(c={values:d(Sa),keys:o?v:d(_a),entries:d(ba)},r)for(l in c)(fa||u||!(l in p))&&ma(p,l,c[l]);else la({target:e,proto:!0,forced:fa||u},c);return r&&p[Ea]!==v&&ma(p,Ea,v,{name:s}),va[e]=v,c},wa=W,Ca=js,Ra=Nr;$e.f;var Ia=ya,Aa="Array Iterator",Oa=Ra.set,Na=Ra.getterFor(Aa);Ia(Array,"Array",(function(t,e){Oa(this,{type:Aa,target:wa(t),index:0,kind:e})}),(function(){var t=Na(this),e=t.target,i=t.kind,n=t.index++;return!e||n>=e.length?(t.target=void 0,{value:void 0,done:!0}):"keys"==i?{value:n,done:!1}:"values"==i?{value:e[n],done:!1}:{value:[n,e[n]],done:!1}}),"values"),Ca.Arguments=Ca.Array;var ka=u.Promise,La=Vr,Pa=Z,Da=$e,Ma=S,xa=se("species"),Ua=d,Va=u.TypeError,Ba=se("iterator"),ja=!1;try{var Fa=0,Ha={next:function(){return{done:!!Fa++}},return:function(){ja=!0}};Ha[Ba]=function(){return this},Array.from(Ha,(function(){throw 2}))}catch(t){}var Ga=l,$a=i,Wa=E,za=Zs,Ka=rr,qa=function(){},Ya=[],Ja=Z("Reflect","construct"),Xa=/^\s*(?:class|function)\b/,Qa=Ga(Xa.exec),Za=!Xa.exec(qa),tc=function(t){if(!Wa(t))return!1;try{return Ja(qa,Ya,t),!0}catch(t){return!1}},ec=function(t){if(!Wa(t))return!1;switch(za(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Za||!!Qa(Xa,Ka(t))}catch(t){return!0}};ec.sham=!0;var ic,nc,sc,oc,rc=!Ja||$a((function(){var t;return tc(tc.call)||!tc(Object)||!tc((function(){t=!0}))||t}))?ec:tc,ac=rc,cc=_t,lc=u.TypeError,dc=Je,hc=function(t){if(ac(t))return t;throw lc(cc(t)+" is not a constructor")},uc=se("species"),pc=function(t,e){var i,n=dc(t).constructor;return void 0===n||null==(i=dc(n)[uc])?e:hc(i)},mc=l([].slice),vc=/(?:ipad|iphone|ipod).*applewebkit/i.test(tt),gc=u,fc=f,Ec=Ge,_c=E,Sc=Ht,bc=i,Tc=bs,yc=mc,wc=_e,Cc=vc,Rc=ji,Ic=gc.setImmediate,Ac=gc.clearImmediate,Oc=gc.process,Nc=gc.Dispatch,kc=gc.Function,Lc=gc.MessageChannel,Pc=gc.String,Dc=0,Mc={},xc="onreadystatechange";try{ic=gc.location}catch(t){}var Uc=function(t){if(Sc(Mc,t)){var e=Mc[t];delete Mc[t],e()}},Vc=function(t){return function(){Uc(t)}},Bc=function(t){Uc(t.data)},jc=function(t){gc.postMessage(Pc(t),ic.protocol+"//"+ic.host)};Ic&&Ac||(Ic=function(t){var e=yc(arguments,1);return Mc[++Dc]=function(){fc(_c(t)?t:kc(t),void 0,e)},nc(Dc),Dc},Ac=function(t){delete Mc[t]},Rc?nc=function(t){Oc.nextTick(Vc(t))}:Nc&&Nc.now?nc=function(t){Nc.now(Vc(t))}:Lc&&!Cc?(oc=(sc=new Lc).port2,sc.port1.onmessage=Bc,nc=Ec(oc.postMessage,oc)):gc.addEventListener&&_c(gc.postMessage)&&!gc.importScripts&&ic&&"file:"!==ic.protocol&&!bc(jc)?(nc=jc,gc.addEventListener("message",Bc,!1)):nc=xc in wc("script")?function(t){Tc.appendChild(wc("script")).onreadystatechange=function(){Tc.removeChild(this),Uc(t)}}:function(t){setTimeout(Vc(t),0)});var Fc,Hc,Gc,$c,Wc,zc,Kc,qc,Yc={set:Ic,clear:Ac},Jc=u,Xc=/ipad|iphone|ipod/i.test(tt)&&void 0!==Jc.Pebble,Qc=/web0s(?!.*chrome)/i.test(tt),Zc=u,tl=Ge,el=_.f,il=Yc.set,nl=vc,sl=Xc,ol=Qc,rl=ji,al=Zc.MutationObserver||Zc.WebKitMutationObserver,cl=Zc.document,ll=Zc.process,dl=Zc.Promise,hl=el(Zc,"queueMicrotask"),ul=hl&&hl.value;ul||(Fc=function(){var t,e;for(rl&&(t=ll.domain)&&t.exit();Hc;){e=Hc.fn,Hc=Hc.next;try{e()}catch(t){throw Hc?$c():Gc=void 0,t}}Gc=void 0,t&&t.enter()},nl||rl||ol||!al||!cl?!sl&&dl&&dl.resolve?((Kc=dl.resolve(void 0)).constructor=dl,qc=tl(Kc.then,Kc),$c=function(){qc(Fc)}):rl?$c=function(){ll.nextTick(Fc)}:(il=tl(il,Zc),$c=function(){il(Fc)}):(Wc=!0,zc=cl.createTextNode(""),new al(Fc).observe(zc,{characterData:!0}),$c=function(){zc.data=Wc=!Wc}));var pl=ul||function(t){var e={fn:t,next:void 0};Gc&&(Gc.next=e),Hc||(Hc=e,$c()),Gc=e},ml={},vl=yt,gl=function(t){var e,i;this.promise=new t((function(t,n){if(void 0!==e||void 0!==i)throw TypeError("Bad Promise constructor");e=t,i=n})),this.resolve=vl(e),this.reject=vl(i)};ml.f=function(t){return new gl(t)};var fl=Je,El=K,_l=ml,Sl=function(t,e){if(fl(t),El(e)&&e.constructor===t)return e;var i=_l.f(t);return(0,i.resolve)(e),i.promise},bl=u,Tl=function(t){try{return{error:!1,value:t()}}catch(t){return{error:!0,value:t}}},yl=function(){this.head=null,this.tail=null};yl.prototype={add:function(t){var e={item:t,next:null};this.head?this.tail.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return this.head=t.next,this.tail===t&&(this.tail=null),t.item}};var wl,Cl,Rl,Il="object"==typeof window,Al=Ti,Ol=u,Nl=Z,kl=y,Ll=ka,Pl=function(t,e,i){for(var n in e)i&&i.unsafe&&t[n]?t[n]=e[n]:La(t,n,e[n],i);return t},Dl=ia,Ml=function(t){var e=Pa(t),i=Da.f;Ma&&e&&!e[xa]&&i(e,xa,{configurable:!0,get:function(){return this}})},xl=yt,Ul=E,Vl=K,Bl=function(t,e){if(Ua(e,t))return t;throw Va("Incorrect invocation")},jl=rr,Fl=Ao,Hl=function(t,e){if(!e&&!ja)return!1;var i=!1;try{var n={};n[Ba]=function(){return{next:function(){return{done:i=!0}}}},t(n)}catch(t){}return i},Gl=pc,$l=Yc.set,Wl=pl,zl=Sl,Kl=function(t,e){var i=bl.console;i&&i.error&&(1==arguments.length?i.error(t):i.error(t,e))},ql=ml,Yl=Tl,Jl=yl,Xl=Nr,Ql=Be,Zl=Il,td=ji,ed=at,id=se("species"),nd="Promise",sd=Xl.getterFor(nd),od=Xl.set,rd=Xl.getterFor(nd),ad=Ll&&Ll.prototype,cd=Ll,ld=ad,dd=Ol.TypeError,hd=Ol.document,ud=Ol.process,pd=ql.f,md=pd,vd=!!(hd&&hd.createEvent&&Ol.dispatchEvent),gd=Ul(Ol.PromiseRejectionEvent),fd="unhandledrejection",Ed=Ql(nd,(function(){var t=jl(cd),e=t!==String(cd);if(!e&&66===ed)return!0;if(!ld.finally)return!0;if(ed>=51&&/native code/.test(t))return!1;var i=new cd((function(t){t(1)})),n=function(t){t((function(){}),(function(){}))};return(i.constructor={})[id]=n,!(i.then((function(){}))instanceof n)||!e&&Zl&&!gd})),_d=Ed||!Hl((function(t){cd.all(t).catch((function(){}))})),Sd=function(t){var e;return!(!Vl(t)||!Ul(e=t.then))&&e},bd=function(t,e){var i,n,s,o=e.value,r=1==e.state,a=r?t.ok:t.fail,c=t.resolve,l=t.reject,d=t.domain;try{a?(r||(2===e.rejection&&Rd(e),e.rejection=1),!0===a?i=o:(d&&d.enter(),i=a(o),d&&(d.exit(),s=!0)),i===t.promise?l(dd("Promise-chain cycle")):(n=Sd(i))?kl(n,i,c,l):c(i)):l(o)}catch(t){d&&!s&&d.exit(),l(t)}},Td=function(t,e){t.notified||(t.notified=!0,Wl((function(){for(var i,n=t.reactions;i=n.get();)bd(i,t);t.notified=!1,e&&!t.rejection&&wd(t)})))},yd=function(t,e,i){var n,s;vd?((n=hd.createEvent("Event")).promise=e,n.reason=i,n.initEvent(t,!1,!0),Ol.dispatchEvent(n)):n={promise:e,reason:i},!gd&&(s=Ol["on"+t])?s(n):t===fd&&Kl("Unhandled promise rejection",i)},wd=function(t){kl($l,Ol,(function(){var e,i=t.facade,n=t.value;if(Cd(t)&&(e=Yl((function(){td?ud.emit("unhandledRejection",n,i):yd(fd,i,n)})),t.rejection=td||Cd(t)?2:1,e.error))throw e.value}))},Cd=function(t){return 1!==t.rejection&&!t.parent},Rd=function(t){kl($l,Ol,(function(){var e=t.facade;td?ud.emit("rejectionHandled",e):yd("rejectionhandled",e,t.value)}))},Id=function(t,e,i){return function(n){t(e,n,i)}},Ad=function(t,e,i){t.done||(t.done=!0,i&&(t=i),t.value=e,t.state=2,Td(t,!0))},Od=function(t,e,i){if(!t.done){t.done=!0,i&&(t=i);try{if(t.facade===e)throw dd("Promise can't be resolved itself");var n=Sd(e);n?Wl((function(){var i={done:!1};try{kl(n,e,Id(Od,i,t),Id(Ad,i,t))}catch(e){Ad(i,e,t)}})):(t.value=e,t.state=1,Td(t,!1))}catch(e){Ad({done:!1},e,t)}}};Ed&&(ld=(cd=function(t){Bl(this,ld),xl(t),kl(wl,this);var e=sd(this);try{t(Id(Od,e),Id(Ad,e))}catch(t){Ad(e,t)}}).prototype,(wl=function(t){od(this,{type:nd,done:!1,notified:!1,parent:!1,reactions:new Jl,rejection:!1,state:0,value:void 0})}).prototype=Pl(ld,{then:function(t,e){var i=rd(this),n=pd(Gl(this,cd));return i.parent=!0,n.ok=!Ul(t)||t,n.fail=Ul(e)&&e,n.domain=td?ud.domain:void 0,0==i.state?i.reactions.add(n):Wl((function(){bd(n,i)})),n.promise},catch:function(t){return this.then(void 0,t)}}),Cl=function(){var t=new wl,e=sd(t);this.promise=t,this.resolve=Id(Od,e),this.reject=Id(Ad,e)},ql.f=pd=function(t){return t===cd||t===Rl?new Cl(t):md(t)}),Al({global:!0,wrap:!0,forced:Ed},{Promise:cd}),Dl(cd,nd,!1,!0),Ml(nd),Rl=Nl(nd),Al({target:nd,stat:!0,forced:Ed},{reject:function(t){var e=pd(this);return kl(e.reject,void 0,t),e.promise}}),Al({target:nd,stat:!0,forced:!0},{resolve:function(t){return zl(this===Rl?cd:this,t)}}),Al({target:nd,stat:!0,forced:_d},{all:function(t){var e=this,i=pd(e),n=i.resolve,s=i.reject,o=Yl((function(){var i=xl(e.resolve),o=[],r=0,a=1;Fl(t,(function(t){var c=r++,l=!1;a++,kl(i,e,t).then((function(t){l||(l=!0,o[c]=t,--a||n(o))}),s)})),--a||n(o)}));return o.error&&s(o.value),i.promise},race:function(t){var e=this,i=pd(e),n=i.reject,s=Yl((function(){var s=xl(e.resolve);Fl(t,(function(t){kl(s,e,t).then(i.resolve,n)}))}));return s.error&&n(s.value),i.promise}});var Nd=y,kd=yt,Ld=ml,Pd=Tl,Dd=Ao;Ti({target:"Promise",stat:!0},{allSettled:function(t){var e=this,i=Ld.f(e),n=i.resolve,s=i.reject,o=Pd((function(){var i=kd(e.resolve),s=[],o=0,r=1;Dd(t,(function(t){var a=o++,c=!1;r++,Nd(i,e,t).then((function(t){c||(c=!0,s[a]={status:"fulfilled",value:t},--r||n(s))}),(function(t){c||(c=!0,s[a]={status:"rejected",reason:t},--r||n(s))}))})),--r||n(s)}));return o.error&&s(o.value),i.promise}});var Md=yt,xd=Z,Ud=y,Vd=ml,Bd=Tl,jd=Ao,Fd="No one promise resolved";Ti({target:"Promise",stat:!0},{any:function(t){var e=this,i=xd("AggregateError"),n=Vd.f(e),s=n.resolve,o=n.reject,r=Bd((function(){var n=Md(e.resolve),r=[],a=0,c=1,l=!1;jd(t,(function(t){var d=a++,h=!1;c++,Ud(n,e,t).then((function(t){h||l||(l=!0,s(t))}),(function(t){h||l||(h=!0,r[d]=t,--c||o(new i(r,Fd)))}))})),--c||o(new i(r,Fd))}));return r.error&&o(r.value),n.promise}});var Hd=ka,Gd=Z,$d=E,Wd=pc,zd=Sl;Ti({target:"Promise",proto:!0,real:!0,forced:!!Hd&&i((function(){Hd.prototype.finally.call({then:function(){}},(function(){}))}))},{finally:function(t){var e=Wd(this,Gd("Promise")),i=$d(t);return this.then(i?function(i){return zd(e,t()).then((function(){return i}))}:t,i?function(i){return zd(e,t()).then((function(){throw i}))}:t)}});var Kd=l,qd=Ci,Yd=ko,Jd=H,Xd=Kd("".charAt),Qd=Kd("".charCodeAt),Zd=Kd("".slice),th=function(t){return function(e,i){var n,s,o=Yd(Jd(e)),r=qd(i),a=o.length;return r<0||r>=a?t?"":void 0:(n=Qd(o,r))<55296||n>56319||r+1===a||(s=Qd(o,r+1))<56320||s>57343?t?Xd(o,r):n:t?Zd(o,r,r+2):s-56320+(n-55296<<10)+65536}},eh=(th(!1),th(!0)),ih=ko,nh=Nr,sh=ya,oh="String Iterator",rh=nh.set,ah=nh.getterFor(oh);sh(String,"String",(function(t){rh(this,{type:oh,string:ih(t),index:0})}),(function(){var t,e=ah(this),i=e.string,n=e.index;return n>=i.length?{value:void 0,done:!0}:(t=eh(i,n),e.index+=t.length,{value:t,done:!1})}));var ch=q.Promise,lh={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},dh=u,hh=Zs,uh=di,ph=js,mh=se("toStringTag");for(var vh in lh){var gh=dh[vh],fh=gh&&gh.prototype;fh&&hh(fh)!==mh&&uh(fh,mh,vh),ph[vh]=ph.Array}var Eh=ch,_h=Eh;const Sh=on;function bh(t,e){const i=t&&t.navigator;if(!i.mediaDevices)return;const n=function(t){if("object"!=typeof t||t.mandatory||t.optional)return t;const e={};return Object.keys(t).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof t[i]?t[i]:{ideal:t[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const s=function(t,e){return t?t+e.charAt(0).toUpperCase()+e.slice(1):"deviceId"===e?"sourceId":e};if(void 0!==n.ideal){e.optional=e.optional||[];let t={};"number"==typeof n.ideal?(t[s("min",i)]=n.ideal,e.optional.push(t),t={},t[s("max",i)]=n.ideal,e.optional.push(t)):(t[s("",i)]=n.ideal,e.optional.push(t))}void 0!==n.exact&&"number"!=typeof n.exact?(e.mandatory=e.mandatory||{},e.mandatory[s("",i)]=n.exact):["min","max"].forEach((t=>{void 0!==n[t]&&(e.mandatory=e.mandatory||{},e.mandatory[s(t,i)]=n[t])}))})),t.advanced&&(e.optional=(e.optional||[]).concat(t.advanced)),e},s=function(t,s){if(e.version>=61)return s(t);if((t=JSON.parse(JSON.stringify(t)))&&"object"==typeof t.audio){const e=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])};e((t=JSON.parse(JSON.stringify(t))).audio,"autoGainControl","googAutoGainControl"),e(t.audio,"noiseSuppression","googNoiseSuppression"),t.audio=n(t.audio)}if(t&&"object"==typeof t.video){let o=t.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const r=e.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||r)){let e;if(delete t.video.facingMode,"environment"===o.exact||"environment"===o.ideal?e=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(e=["front"]),e)return i.mediaDevices.enumerateDevices().then((i=>{let r=(i=i.filter((t=>"videoinput"===t.kind))).find((t=>e.some((e=>t.label.toLowerCase().includes(e)))));return!r&&i.length&&e.includes("back")&&(r=i[i.length-1]),r&&(t.video.deviceId=o.exact?{exact:r.deviceId}:{ideal:r.deviceId}),t.video=n(t.video),Sh("chrome: "+JSON.stringify(t)),s(t)}))}t.video=n(t.video)}return Sh("chrome: "+JSON.stringify(t)),s(t)},o=function(t){return e.version>=64?t:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(t,e,n){s(t,(t=>{i.webkitGetUserMedia(t,e,(t=>{n&&n(o(t))}))}))}.bind(i),i.mediaDevices.getUserMedia){const t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(e){return s(e,(e=>t(e).then((t=>{if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((t=>{t.stop()})),new DOMException("","NotFoundError");return t}),(t=>_h.reject(o(t))))))}}}function Th(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function yh(t){if("object"==typeof t&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",(i=>{let n;n=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===i.track.id)):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[e.stream],this.dispatchEvent(s)})),e.stream.getTracks().forEach((i=>{let n;n=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((t=>t.track&&t.track.id===i.id)):{track:i};const s=new Event("track");s.track=i,s.receiver=n,s.transceiver={receiver:n},s.streams=[e.stream],this.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else en(t,"track",(t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t)))}function wh(t){if("object"==typeof t&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(t,e){return{track:e,get dtmf(){return void 0===this._dtmf&&("audio"===e.kind?this._dtmf=t.createDTMFSender(e):this._dtmf=null),this._dtmf},_pc:t}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,n){let s=i.apply(this,arguments);return s||(s=e(this,t),this._senders.push(s)),s};const n=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){n.apply(this,arguments);const e=this._senders.indexOf(t);-1!==e&&this._senders.splice(e,1)}}const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._senders=this._senders||[],i.apply(this,[t]),t.getTracks().forEach((t=>{this._senders.push(e(this,t))}))};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){this._senders=this._senders||[],n.apply(this,[t]),t.getTracks().forEach((t=>{const e=this._senders.find((e=>e.track===t));e&&this._senders.splice(this._senders.indexOf(e),1)}))}}else if("object"==typeof t&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Ch(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[t,i,n]=arguments;if(arguments.length>0&&"function"==typeof t)return e.apply(this,arguments);if(0===e.length&&(0===arguments.length||"function"!=typeof t))return e.apply(this,[]);const s=function(t){const e={};return t.result().forEach((t=>{const i={id:t.id,timestamp:t.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};t.names().forEach((e=>{i[e]=t.stat(e)})),e[i.id]=i})),e},o=function(t){return new Map(Object.keys(t).map((e=>[e,t[e]])))};if(arguments.length>=2){const n=function(t){i(o(s(t)))};return e.apply(this,[n,t])}return new _h(((t,i)=>{e.apply(this,[function(e){t(o(s(e)))},i])})).then(i,n)}}function Rh(t){if(!("object"==typeof t&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){const t=this;return this._pc.getStats().then((e=>dn(e,t.track,!0)))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),en(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){const t=this;return this._pc.getStats().then((e=>dn(e,t.track,!1)))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const t=arguments[0];let e,i,n;return this.getSenders().forEach((i=>{i.track===t&&(e?n=!0:e=i)})),this.getReceivers().forEach((e=>(e.track===t&&(i?n=!0:i=e),e.track===t))),n||e&&i?_h.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):e?e.getStats():i?i.getStats():_h.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Ih(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((t=>this._shimmedLocalStreams[t][0]))};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(t,i){if(!i)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=e.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(t){this._shimmedLocalStreams=this._shimmedLocalStreams||{},t.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")}));const e=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter((t=>-1===e.indexOf(t)));this._shimmedLocalStreams[t.id]=[t].concat(n)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[t.id],n.apply(this,arguments)};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(t){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},t&&Object.keys(this._shimmedLocalStreams).forEach((e=>{const i=this._shimmedLocalStreams[e].indexOf(t);-1!==i&&this._shimmedLocalStreams[e].splice(i,1),1===this._shimmedLocalStreams[e].length&&delete this._shimmedLocalStreams[e]})),s.apply(this,arguments)}}function Ah(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Ih(t);const i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const t=i.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((t=>this._reverseStreams[t.id]))};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(e){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},e.getTracks().forEach((t=>{if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[e.id]){const i=new t.MediaStream(e.getTracks());this._streams[e.id]=i,this._reverseStreams[i.id]=e,e=i}n.apply(this,[e])};const s=t.RTCPeerConnection.prototype.removeStream;function o(t,e){let i=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e],s=t._streams[n.id];i=i.replace(new RegExp(s.id,"g"),n.id)})),new RTCSessionDescription({type:e.type,sdp:i})}function r(t,e){let i=e.sdp;return Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e],s=t._streams[n.id];i=i.replace(new RegExp(n.id,"g"),s.id)})),new RTCSessionDescription({type:e.type,sdp:i})}t.RTCPeerConnection.prototype.removeStream=function(t){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[t.id]||t]),delete this._reverseStreams[this._streams[t.id]?this._streams[t.id].id:t.id],delete this._streams[t.id]},t.RTCPeerConnection.prototype.addTrack=function(e,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((t=>t===e)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const s=this.getSenders().find((t=>t.track===e));if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[i.id];if(o)o.addTrack(e),_h.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const n=new t.MediaStream([e]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find((t=>t.track===e))},["createOffer","createAnswer"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){const t=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[e=>{const i=o(this,e);t[0].apply(null,[i])},e=>{t[1]&&t[1].apply(null,e)},arguments[2]]):i.apply(this,arguments).then((t=>o(this,t)))}};t.RTCPeerConnection.prototype[e]=n[e]}));const a=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=r(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const t=c.get.apply(this);return""===t.type?t:o(this,t)}}),t.RTCPeerConnection.prototype.removeTrack=function(t){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!t._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(t._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let e;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((e=>t.track===e))&&(e=this._streams[i])})),e&&(1===e.getTracks().length?this.removeStream(this._reverseStreams[e.id]):e.removeTrack(t.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Oh(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}))}function Nh(t,e){en(t,"negotiationneeded",(t=>{const i=t.target;if(!(e.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return t}))}var kh=Object.freeze({__proto__:null,shimMediaStream:Th,shimOnTrack:yh,shimGetSendersWithDtmf:wh,shimGetStats:Ch,shimSenderReceiverGetStats:Rh,shimAddTrackRemoveTrackWithNative:Ih,shimAddTrackRemoveTrack:Ah,shimPeerConnection:Oh,fixNegotiationNeeded:Nh,shimGetUserMedia:bh,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&("function"==typeof e?t.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then((e=>{const n=i.video&&i.video.width,s=i.video&&i.video.height,o=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxFrameRate:o||3}},n&&(i.video.mandatory.maxWidth=n),s&&(i.video.mandatory.maxHeight=s),t.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});function Lh(t,e){const i=t&&t.navigator,n=t&&t.MediaStreamTrack;if(i.getUserMedia=function(t,e,n){rn("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(t).then(e,n)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const t=function(t,e,i){e in t&&!(i in t)&&(t[i]=t[e],delete t[e])},e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),t(i.audio,"autoGainControl","mozAutoGainControl"),t(i.audio,"noiseSuppression","mozNoiseSuppression")),e(i)},n&&n.prototype.getSettings){const e=n.prototype.getSettings;n.prototype.getSettings=function(){const i=e.apply(this,arguments);return t(i,"mozAutoGainControl","autoGainControl"),t(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const e=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),t(i,"autoGainControl","mozAutoGainControl"),t(i,"noiseSuppression","mozNoiseSuppression")),e.apply(this,[i])}}}}function Ph(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Dh(t,e){if("object"!=typeof t||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e],n={[e](){return arguments[0]=new("addIceCandidate"===e?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[t,s,o]=arguments;return n.apply(this,[t||null]).then((t=>{if(e.version<53&&!s)try{t.forEach((t=>{t.type=i[t.type]||t.type}))}catch(e){if("TypeError"!==e.name)throw e;t.forEach(((e,n)=>{t.set(n,Object.assign({},e,{type:i[e.type]||e.type}))}))}return t})).then(s,o)}}function Mh(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender)return;if(t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const t=i.apply(this,arguments);return t._pc=this,t}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):_h.resolve(new Map)}}function xh(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender)return;if(t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const t=e.apply(this,[]);return t.forEach((t=>t._pc=this)),t}),en(t,"track",(t=>(t.receiver._pc=t.srcElement,t))),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Uh(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(t){rn("removeStream","removeTrack"),this.getSenders().forEach((e=>{e.track&&t.getTracks().includes(e.track)&&this.removeTrack(e)}))})}function Vh(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function Bh(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let t=arguments[1]&&arguments[1].sendEncodings;void 0===t&&(t=[]),t=[...t];const i=t.length>0;i&&t.forEach((t=>{if("rid"in t&&!/^[a-z0-9]{0,16}$/i.test(t.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in t&&!(parseFloat(t.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in t&&!(parseFloat(t.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=e.apply(this,arguments);if(i){const{sender:e}=n,i=e.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=t,e.sendEncodings=t,this.setParametersPromises.push(e.setParameters(i).then((()=>{delete e.sendEncodings})).catch((()=>{delete e.sendEncodings}))))}return n})}function jh(t){if("object"!=typeof t||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const t=e.apply(this,arguments);return"encodings"in t||(t.encodings=[].concat(this.sendEncodings||[{}])),t})}function Fh(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?_h.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}function Hh(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?_h.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}var Gh=Object.freeze({__proto__:null,shimOnTrack:Ph,shimPeerConnection:Dh,shimSenderGetStats:Mh,shimReceiverGetStats:xh,shimRemoveStream:Uh,shimRTCDataChannel:Vh,shimAddTransceiver:Bh,shimGetParameters:jh,shimCreateOffer:Fh,shimCreateAnswer:Hh,shimGetUserMedia:Lh,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const t=new DOMException("getDisplayMedia without video constraints is undefined");return t.name="NotFoundError",t.code=8,_h.reject(t)}return!0===i.video?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})}});function $h(t){if("object"==typeof t&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(t){this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getAudioTracks().forEach((i=>e.call(this,i,t))),t.getVideoTracks().forEach((i=>e.call(this,i,t)))},t.RTCPeerConnection.prototype.addTrack=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];return n&&n.forEach((t=>{this._localStreams?this._localStreams.includes(t)||this._localStreams.push(t):this._localStreams=[t]})),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const e=this._localStreams.indexOf(t);if(-1===e)return;this._localStreams.splice(e,1);const i=t.getTracks();this.getSenders().forEach((t=>{i.includes(t.track)&&this.removeTrack(t)}))})}}function Wh(t){if("object"==typeof t&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=t=>{t.streams.forEach((t=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(t))return;this._remoteStreams.push(t);const e=new Event("addstream");e.stream=t,this.dispatchEvent(e)}))})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const t=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((e=>{if(t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.indexOf(e)>=0)return;t._remoteStreams.push(e);const i=new Event("addstream");i.stream=e,t.dispatchEvent(i)}))}),e.apply(t,arguments)}}}function zh(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,i=e.createOffer,n=e.createAnswer,s=e.setLocalDescription,o=e.setRemoteDescription,r=e.addIceCandidate;e.createOffer=function(t,e){const n=arguments.length>=2?arguments[2]:arguments[0],s=i.apply(this,[n]);return e?(s.then(t,e),_h.resolve()):s},e.createAnswer=function(t,e){const i=arguments.length>=2?arguments[2]:arguments[0],s=n.apply(this,[i]);return e?(s.then(t,e),_h.resolve()):s};let a=function(t,e,i){const n=s.apply(this,[t]);return i?(n.then(e,i),_h.resolve()):n};e.setLocalDescription=a,a=function(t,e,i){const n=o.apply(this,[t]);return i?(n.then(e,i),_h.resolve()):n},e.setRemoteDescription=a,a=function(t,e,i){const n=r.apply(this,[t]);return i?(n.then(e,i),_h.resolve()):n},e.addIceCandidate=a}function Kh(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=t=>i(qh(t))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(t,i,n){e.mediaDevices.getUserMedia(t).then(i,n)}.bind(e))}function qh(t){return t&&void 0!==t.video?Object.assign({},t,{video:ln(t.video)}):t}function Yh(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(t,i){if(t&&t.iceServers){const e=[];for(let i=0;i<t.iceServers.length;i++){let n=t.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(rn("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,e.push(n)):e.push(t.iceServers[i])}t.iceServers=e}return new e(t,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function Jh(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Xh(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(t){if(t){void 0!==t.offerToReceiveAudio&&(t.offerToReceiveAudio=!!t.offerToReceiveAudio);const e=this.getTransceivers().find((t=>"audio"===t.receiver.track.kind));!1===t.offerToReceiveAudio&&e?"sendrecv"===e.direction?e.setDirection?e.setDirection("sendonly"):e.direction="sendonly":"recvonly"===e.direction&&(e.setDirection?e.setDirection("inactive"):e.direction="inactive"):!0!==t.offerToReceiveAudio||e||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==t.offerToReceiveVideo&&(t.offerToReceiveVideo=!!t.offerToReceiveVideo);const i=this.getTransceivers().find((t=>"video"===t.receiver.track.kind));!1===t.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==t.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function Qh(t){"object"!=typeof t||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var Zh=Object.freeze({__proto__:null,shimLocalStreamsAPI:$h,shimRemoteStreamsAPI:Wh,shimCallbacksAPI:zh,shimGetUserMedia:Kh,shimConstraints:qh,shimRTCIceServerUrls:Yh,shimTrackEventTransceiver:Jh,shimCreateOfferLegacy:Xh,shimAudioContext:Qh}),tu="\t\n\v\f\r                　\u2028\u2029\ufeff",eu=H,iu=ko,nu=l("".replace),su="[\t\n\v\f\r                　\u2028\u2029\ufeff]",ou=RegExp("^"+su+su+"*"),ru=RegExp(su+su+"*$"),au=function(t){return function(e){var i=iu(eu(e));return 1&t&&(i=nu(i,ou,"")),2&t&&(i=nu(i,ru,"")),i}},cu={start:au(1),end:au(2),trim:au(3)},lu=xr.PROPER,du=i,hu=tu,uu=cu.trim;Ti({target:"String",proto:!0,forced:function(t){return du((function(){return!!hu[t]()||"​᠎"!=="​᠎"[t]()||lu&&hu[t].name!==t}))}("trim")},{trim:function(){return uu(this)}});var pu=Wi("String").trim,mu=d,vu=pu,gu=String.prototype,fu=function(t){var e=t.trim;return"string"==typeof t||t===gu||mu(gu,t)&&e===gu.trim?vu:e},Eu={exports:{}};!function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};e.localCName=e.generateIdentifier(),e.splitLines=function(t){return fu(t).call(t).split("\n").map((t=>fu(t).call(t)))},e.splitSections=function(t){return t.split("\nm=").map(((t,e)=>{var i;return fu(i=e>0?"m="+t:t).call(i)+"\r\n"}))},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter((t=>0===t.indexOf(i)))},e.parseCandidate=function(t){let e;e=0===t.indexOf("a=candidate:")?t.substring(12).split(" "):t.substring(10).split(" ");const i={foundation:e[0],component:{1:"rtp",2:"rtcp"}[e[1]]||e[1],protocol:e[2].toLowerCase(),priority:parseInt(e[3],10),ip:e[4],address:e[4],port:parseInt(e[5],10),type:e[7]};for(let t=8;t<e.length;t+=2)switch(e[t]){case"raddr":i.relatedAddress=e[t+1];break;case"rport":i.relatedPort=parseInt(e[t+1],10);break;case"tcptype":i.tcpType=e[t+1];break;case"ufrag":i.ufrag=e[t+1],i.usernameFragment=e[t+1];break;default:void 0===i[e[t]]&&(i[e[t]]=e[t+1])}return i},e.writeCandidate=function(t){const e=[];e.push(t.foundation);const i=t.component;"rtp"===i?e.push(1):"rtcp"===i?e.push(2):e.push(i),e.push(t.protocol.toUpperCase()),e.push(t.priority),e.push(t.address||t.ip),e.push(t.port);const n=t.type;return e.push("typ"),e.push(n),"host"!==n&&t.relatedAddress&&t.relatedPort&&(e.push("raddr"),e.push(t.relatedAddress),e.push("rport"),e.push(t.relatedPort)),t.tcpType&&"tcp"===t.protocol.toLowerCase()&&(e.push("tcptype"),e.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(e.push("ufrag"),e.push(t.usernameFragment||t.ufrag)),"candidate:"+e.join(" ")},e.parseIceOptions=function(t){return t.substr(14).split(" ")},e.parseRtpMap=function(t){let e=t.substr(9).split(" ");const i={payloadType:parseInt(e.shift(),10)};return e=e[0].split("/"),i.name=e[0],i.clockRate=parseInt(e[1],10),i.channels=3===e.length?parseInt(e[2],10):1,i.numChannels=i.channels,i},e.writeRtpMap=function(t){let e=t.payloadType;void 0!==t.preferredPayloadType&&(e=t.preferredPayloadType);const i=t.channels||t.numChannels||1;return"a=rtpmap:"+e+" "+t.name+"/"+t.clockRate+(1!==i?"/"+i:"")+"\r\n"},e.parseExtmap=function(t){const e=t.substr(9).split(" ");return{id:parseInt(e[0],10),direction:e[0].indexOf("/")>0?e[0].split("/")[1]:"sendrecv",uri:e[1]}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&"sendrecv"!==t.direction?"/"+t.direction:"")+" "+t.uri+"\r\n"},e.parseFmtp=function(t){const e={};let i;const n=t.substr(t.indexOf(" ")+1).split(";");for(let t=0;t<n.length;t++){var s,o;i=fu(s=n[t]).call(s).split("="),e[fu(o=i[0]).call(o)]=i[1]}return e},e.writeFmtp=function(t){let e="",i=t.payloadType;if(void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const n=[];Object.keys(t.parameters).forEach((e=>{void 0!==t.parameters[e]?n.push(e+"="+t.parameters[e]):n.push(e)})),e+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return e},e.parseRtcpFb=function(t){const e=t.substr(t.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}},e.writeRtcpFb=function(t){let e="",i=t.payloadType;return void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach((t=>{e+="a=rtcp-fb:"+i+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"})),e},e.parseSsrcMedia=function(t){const e=t.indexOf(" "),i={ssrc:parseInt(t.substr(7,e-7),10)},n=t.indexOf(":",e);return n>-1?(i.attribute=t.substr(e+1,n-e-1),i.value=t.substr(n+1)):i.attribute=t.substr(e+1),i},e.parseSsrcGroup=function(t){const e=t.substr(13).split(" ");return{semantics:e.shift(),ssrcs:e.map((t=>parseInt(t,10)))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substr(6)},e.parseFingerprint=function(t){const e=t.substr(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,e){let i="a=setup:"+e+"\r\n";return t.fingerprints.forEach((t=>{i+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"})),i},e.parseCryptoLine=function(t){const e=t.substr(9).split(" ");return{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+("object"==typeof t.keyParams?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+"\r\n"},e.parseCryptoKeyParams=function(t){if(0!==t.indexOf("inline:"))return null;const e=t.substr(7).split("|");return{keyMethod:"inline",keySalt:e[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:void 0,mkiLength:e[2]?e[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const n=e.matchPrefix(t+i,"a=ice-ufrag:")[0],s=e.matchPrefix(t+i,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substr(12),password:s.substr(10)}:null},e.writeIceParameters=function(t){let e="a=ice-ufrag:"+t.usernameFragment+"\r\na=ice-pwd:"+t.password+"\r\n";return t.iceLite&&(e+="a=ice-lite\r\n"),e},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=e.splitLines(t)[0].split(" ");for(let s=3;s<n.length;s++){const o=n[s],r=e.matchPrefix(t,"a=rtpmap:"+o+" ")[0];if(r){const n=e.parseRtpMap(r),s=e.matchPrefix(t,"a=fmtp:"+o+" ");switch(n.parameters=s.length?e.parseFmtp(s[0]):{},n.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+o+" ").map(e.parseRtcpFb),i.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase())}}}return e.matchPrefix(t,"a=extmap:").forEach((t=>{i.headerExtensions.push(e.parseExtmap(t))})),i},e.writeRtpDescription=function(t,i){let n="";n+="m="+t+" ",n+=i.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=i.codecs.map((t=>void 0!==t.preferredPayloadType?t.preferredPayloadType:t.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((t=>{n+=e.writeRtpMap(t),n+=e.writeFmtp(t),n+=e.writeRtcpFb(t)}));let s=0;return i.codecs.forEach((t=>{t.maxptime>s&&(s=t.maxptime)})),s>0&&(n+="a=maxptime:"+s+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((t=>{n+=e.writeExtmap(t)})),n},e.parseRtpEncodingParameters=function(t){const i=[],n=e.parseRtpParameters(t),s=-1!==n.fecMechanisms.indexOf("RED"),o=-1!==n.fecMechanisms.indexOf("ULPFEC"),r=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute)),a=r.length>0&&r[0].ssrc;let c;const l=e.matchPrefix(t,"a=ssrc-group:FID").map((t=>t.substr(17).split(" ").map((t=>parseInt(t,10)))));l.length>0&&l[0].length>1&&l[0][0]===a&&(c=l[0][1]),n.codecs.forEach((t=>{if("RTX"===t.name.toUpperCase()&&t.parameters.apt){let e={ssrc:a,codecPayloadType:parseInt(t.parameters.apt,10)};a&&c&&(e.rtx={ssrc:c}),i.push(e),s&&(e=JSON.parse(JSON.stringify(e)),e.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},i.push(e))}})),0===i.length&&a&&i.push({ssrc:a});let d=e.matchPrefix(t,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,i.forEach((t=>{t.maxBitrate=d}))),i},e.parseRtcpParameters=function(t){const i={},n=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"cname"===t.attribute))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=0===s.length;const o=e.matchPrefix(t,"a=rtcp-mux");return i.mux=o.length>0,i},e.writeRtcpParameters=function(t){let e="";return t.reducedSize&&(e+="a=rtcp-rsize\r\n"),t.mux&&(e+="a=rtcp-mux\r\n"),void 0!==t.ssrc&&t.cname&&(e+="a=ssrc:"+t.ssrc+" cname:"+t.cname+"\r\n"),e},e.parseMsid=function(t){let i;const n=e.matchPrefix(t,"a=msid:");if(1===n.length)return i=n[0].substr(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>"msid"===t.attribute));return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(t){const i=e.parseMLine(t),n=e.matchPrefix(t,"a=max-message-size:");let s;n.length>0&&(s=parseInt(n[0].substr(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(t,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:i.fmt,maxMessageSize:s};const r=e.matchPrefix(t,"a=sctpmap:");if(r.length>0){const t=r[0].substr(10).split(" ");return{port:parseInt(t[0],10),protocol:t[1],maxMessageSize:s}}},e.writeSctpDescription=function(t,e){let i=[];return i="DTLS/SCTP"!==t.protocol?["m="+t.kind+" 9 "+t.protocol+" "+e.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+e.port+"\r\n"]:["m="+t.kind+" 9 "+t.protocol+" "+e.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+e.port+" "+e.protocol+" 65535\r\n"],void 0!==e.maxMessageSize&&i.push("a=max-message-size:"+e.maxMessageSize+"\r\n"),i.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,21)},e.writeSessionBoilerplate=function(t,i,n){let s;const o=void 0!==i?i:2;return s=t||e.generateSessionId(),"v=0\r\no="+(n||"thisisadapterortc")+" "+s+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},e.getDirection=function(t,i){const n=e.splitLines(t);for(let t=0;t<n.length;t++)switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substr(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substr(2)},e.isRejected=function(t){return"0"===t.split(" ",2)[1]},e.parseMLine=function(t){const i=e.splitLines(t)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(t){const i=e.matchPrefix(t,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(t){if("string"!=typeof t||0===t.length)return!1;const i=e.splitLines(t);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},t.exports=e}(Eu);var _u=Eu.exports,Su=Object.freeze(t({__proto__:null,default:_u},[Eu.exports]));function bu(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(t){if("object"==typeof t&&t.candidate&&0===t.candidate.indexOf("a=")&&((t=JSON.parse(JSON.stringify(t))).candidate=t.candidate.substr(2)),t.candidate&&t.candidate.length){const i=new e(t),n=_u.parseCandidate(t.candidate),s=Object.assign(i,n);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new e(t)},t.RTCIceCandidate.prototype=e.prototype,en(t,"icecandidate",(e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e)))}function Tu(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||en(t,"icecandidate",(t=>{if(t.candidate){const e=_u.parseCandidate(t.candidate.candidate);"relay"===e.type&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24])}return t}))}function yu(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(t){if(!t||!t.sdp)return!1;const e=_u.splitSections(t.sdp);return e.shift(),e.some((t=>{const e=_u.parseMLine(t);return e&&"application"===e.kind&&-1!==e.protocol.indexOf("SCTP")}))},n=function(t){const e=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===e||e.length<2)return-1;const i=parseInt(e[1],10);return i!=i?-1:i},s=function(t){let i=65536;return"firefox"===e.browser&&(i=e.version<57?-1===t?16384:2147483637:e.version<60?57===e.version?65535:65536:2147483637),i},o=function(t,i){let n=65536;"firefox"===e.browser&&57===e.version&&(n=65535);const s=_u.matchPrefix(t.sdp,"a=max-message-size:");return s.length>0?n=parseInt(s[0].substr(19),10):"firefox"===e.browser&&-1!==i&&(n=2147483637),n},r=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===e.browser&&e.version>=76){const{sdpSemantics:t}=this.getConfiguration();"plan-b"===t&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const t=n(arguments[0]),e=s(t),i=o(arguments[0],t);let r;r=0===e&&0===i?Number.POSITIVE_INFINITY:0===e||0===i?Math.max(e,i):Math.min(e,i);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>r}),this._sctp=a}return r.apply(this,arguments)}}function wu(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(t,e){const i=t.send;t.send=function(){const n=arguments[0],s=n.length||n.size||n.byteLength;if("open"===t.readyState&&e.sctp&&s>e.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+e.sctp.maxMessageSize+" bytes)");return i.apply(t,arguments)}}const i=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const t=i.apply(this,arguments);return e(t,this),t},en(t,"datachannel",(t=>(e(t.channel,t.target),t)))}function Cu(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=t=>{const e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;const i=new Event("connectionstatechange",t);e.dispatchEvent(i)}return t},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function Ru(t,e){if(!t.RTCPeerConnection)return;if("chrome"===e.browser&&e.version>=71)return;if("safari"===e.browser&&e.version>=605)return;const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(e){if(e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")){const i=e.sdp.split("\n").filter((t=>"a=extmap-allow-mixed"!==fu(t).call(t))).join("\n");t.RTCSessionDescription&&e instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:e.type,sdp:i}):e.sdp=i}return i.apply(this,arguments)}}function Iu(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===e.browser&&e.version<78||"firefox"===e.browser&&e.version<68||"safari"===e.browser)&&arguments[0]&&""===arguments[0].candidate?_h.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),_h.resolve())})}function Au(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let t=arguments[0]||{};if("object"!=typeof t||t.type&&t.sdp)return i.apply(this,arguments);if(t={type:t.type,sdp:t.sdp},!t.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":t.type="offer";break;default:t.type="answer"}return t.sdp||"offer"!==t.type&&"answer"!==t.type?i.apply(this,[t]):("offer"===t.type?this.createOffer:this.createAnswer).apply(this).then((t=>i.apply(this,[t])))})}var Ou=Object.freeze({__proto__:null,shimRTCIceCandidate:bu,shimRTCIceCandidateRelayProtocol:Tu,shimMaxMessageSize:yu,shimSendThrowTypeError:wu,shimConnectionState:Cu,removeExtmapAllowMixed:Ru,shimAddIceCandidateNullOrEmpty:Iu,shimParameterlessSetLocalDescription:Au});let Nu,ku;!function(){let{window:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=on,n=an(t),s={browserDetails:n,commonShim:Ou,extractVersion:tn,disableLog:nn,disableWarnings:sn,sdp:Su};switch(n.browser){case"chrome":if(!kh||!Oh||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),s;if(null===n.version)return i("Chrome shim can not determine version, not shimming."),s;i("adapter.js shimming chrome."),s.browserShim=kh,Iu(t,n),Au(t),bh(t,n),Th(t),Oh(t,n),yh(t),Ah(t,n),wh(t),Ch(t),Rh(t),Nh(t,n),bu(t),Tu(t),Cu(t),yu(t,n),wu(t),Ru(t,n);break;case"firefox":if(!Gh||!Dh||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),s;i("adapter.js shimming firefox."),s.browserShim=Gh,Iu(t,n),Au(t),Lh(t,n),Dh(t,n),Ph(t),Uh(t),Mh(t),xh(t),Vh(t),Bh(t),jh(t),Fh(t),Hh(t),bu(t),Cu(t),yu(t,n),wu(t);break;case"safari":if(!Zh||!e.shimSafari)return i("Safari shim is not included in this adapter release."),s;i("adapter.js shimming safari."),s.browserShim=Zh,Iu(t,n),Au(t),Yh(t),Xh(t),zh(t),$h(t),Wh(t),Jh(t),Kh(t),Qh(t),bu(t),Tu(t),yu(t,n),wu(t),Ru(t,n);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window}),function(t){t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot"}(Nu||(Nu={})),function(t){t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger"}(ku||(ku={}));var Lu={exports:{}};!function(t,i){!function(e,n){var s="function",o="undefined",r="object",a="string",c="major",l="model",d="name",h="type",u="vendor",p="version",m="architecture",v="console",g="mobile",f="tablet",E="smarttv",_="wearable",S="embedded",b="Amazon",T="Apple",y="ASUS",w="BlackBerry",C="Google",R="Huawei",I="LG",A="Microsoft",O="Motorola",N="Samsung",k="Sharp",L="Sony",P="Xiaomi",D="Zebra",M="Facebook",x="Chromium OS",U="Mac OS",V=function(t){for(var e={},i=0;i<t.length;i++)e[t[i].toUpperCase()]=t[i];return e},B=function(t,e){return typeof t===a&&-1!==j(e).indexOf(j(t))},j=function(t){return t.toLowerCase()},F=function(t,e){if(typeof t===a)return t=t.replace(/^\s\s*/,""),typeof e===o?t:t.substring(0,350)},H=function(t,e){for(var i,o,a,c,l,d,h=0;h<e.length&&!l;){var u=e[h],p=e[h+1];for(i=o=0;i<u.length&&!l&&u[i];)if(l=u[i++].exec(t))for(a=0;a<p.length;a++)d=l[++o],typeof(c=p[a])===r&&c.length>0?2===c.length?typeof c[1]==s?this[c[0]]=c[1].call(this,d):this[c[0]]=c[1]:3===c.length?typeof c[1]!==s||c[1].exec&&c[1].test?this[c[0]]=d?d.replace(c[1],c[2]):n:this[c[0]]=d?c[1].call(this,d,c[2]):n:4===c.length&&(this[c[0]]=d?c[3].call(this,d.replace(c[1],c[2])):n):this[c]=d||n;h+=2}},G=function(t,e){for(var i in e)if(typeof e[i]===r&&e[i].length>0){for(var s=0;s<e[i].length;s++)if(B(e[i][s],t))return"?"===i?n:i}else if(B(e[i],t))return"?"===i?n:i;return t},$={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},W={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[d,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[d,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[d,p],[/opios[\/ ]+([\w\.]+)/i],[p,[d,"Opera Mini"]],[/\bopr\/([\w\.]+)/i],[p,[d,"Opera"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[d,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[d,"UCBrowser"]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[d,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[d,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[d,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[d,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[d,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[d,/(.+)/,"$1 Secure Browser"],p],[/\bfocus\/([\w\.]+)/i],[p,[d,"Firefox Focus"]],[/\bopt\/([\w\.]+)/i],[p,[d,"Opera Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[d,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[d,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[d,"Opera Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[d,"MIUI Browser"]],[/fxios\/([-\w\.]+)/i],[p,[d,"Firefox"]],[/\bqihu|(qi?ho?o?|360)browser/i],[[d,"360 Browser"]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[d,/(.+)/,"$1 Browser"],p],[/(comodo_dragon)\/([\w\.]+)/i],[[d,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[d,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[d],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[d,M],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[d,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[d,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[d,"Chrome Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[d,"Chrome WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[d,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[d,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[d,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,d],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[d,[p,G,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[d,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[d,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[d,"Firefox Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[d,p],[/(cobalt)\/([\w\.]+)/i],[d,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,j]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[m,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/windows (ce|mobile); ppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[m,/ower/,"",j]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[m,j]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[u,N],[h,f]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[u,N],[h,g]],[/\((ip(?:hone|od)[\w ]*);/i],[l,[u,T],[h,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[u,T],[h,f]],[/(macintosh);/i],[l,[u,T]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[u,k],[h,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[u,R],[h,f]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[l,[u,R],[h,g]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[u,P],[h,g]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[u,P],[h,f]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[u,"OPPO"],[h,g]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[u,"Vivo"],[h,g]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[l,[u,"Realme"],[h,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[u,O],[h,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[u,O],[h,f]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[u,I],[h,f]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[u,I],[h,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[u,"Lenovo"],[h,f]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[u,"Nokia"],[h,g]],[/(pixel c)\b/i],[l,[u,C],[h,f]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[u,C],[h,g]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[u,L],[h,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[u,L],[h,f]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[u,"OnePlus"],[h,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[u,b],[h,f]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[u,b],[h,g]],[/(playbook);[-\w\),; ]+(rim)/i],[l,u,[h,f]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[u,w],[h,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[u,y],[h,f]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[u,y],[h,g]],[/(nexus 9)/i],[l,[u,"HTC"],[h,f]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[l,/_/g," "],[h,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[u,"Acer"],[h,f]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[u,"Meizu"],[h,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,l,[h,g]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,l,[h,f]],[/(surface duo)/i],[l,[u,A],[h,f]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[u,"Fairphone"],[h,g]],[/(u304aa)/i],[l,[u,"AT&T"],[h,g]],[/\bsie-(\w*)/i],[l,[u,"Siemens"],[h,g]],[/\b(rct\w+) b/i],[l,[u,"RCA"],[h,f]],[/\b(venue[\d ]{2,7}) b/i],[l,[u,"Dell"],[h,f]],[/\b(q(?:mv|ta)\w+) b/i],[l,[u,"Verizon"],[h,f]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[u,"Barnes & Noble"],[h,f]],[/\b(tm\d{3}\w+) b/i],[l,[u,"NuVision"],[h,f]],[/\b(k88) b/i],[l,[u,"ZTE"],[h,f]],[/\b(nx\d{3}j) b/i],[l,[u,"ZTE"],[h,g]],[/\b(gen\d{3}) b.+49h/i],[l,[u,"Swiss"],[h,g]],[/\b(zur\d{3}) b/i],[l,[u,"Swiss"],[h,f]],[/\b((zeki)?tb.*\b) b/i],[l,[u,"Zeki"],[h,f]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],l,[h,f]],[/\b(ns-?\w{0,9}) b/i],[l,[u,"Insignia"],[h,f]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[u,"NextBook"],[h,f]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],l,[h,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],l,[h,g]],[/\b(ph-1) /i],[l,[u,"Essential"],[h,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[u,"Envizen"],[h,f]],[/\b(trio[-\w\. ]+) b/i],[l,[u,"MachSpeed"],[h,f]],[/\btu_(1491) b/i],[l,[u,"Rotor"],[h,f]],[/(shield[\w ]+) b/i],[l,[u,"Nvidia"],[h,f]],[/(sprint) (\w+)/i],[u,l,[h,g]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[u,A],[h,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[u,D],[h,f]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[u,D],[h,g]],[/smart-tv.+(samsung)/i],[u,[h,E]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[u,N],[h,E]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,I],[h,E]],[/(apple) ?tv/i],[u,[l,"Apple TV"],[h,E]],[/crkey/i],[[l,"Chromecast"],[u,C],[h,E]],[/droid.+aft(\w)( bui|\))/i],[l,[u,b],[h,E]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[l,[u,k],[h,E]],[/(bravia[\w ]+)( bui|\))/i],[l,[u,L],[h,E]],[/(mitv-\w{5}) bui/i],[l,[u,P],[h,E]],[/Hbbtv.*(technisat) (.*);/i],[u,l,[h,E]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,F],[l,F],[h,E]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[h,E]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,l,[h,v]],[/droid.+; (shield) bui/i],[l,[u,"Nvidia"],[h,v]],[/(playstation [345portablevi]+)/i],[l,[u,L],[h,v]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[u,A],[h,v]],[/((pebble))app/i],[u,l,[h,_]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[l,[u,T],[h,_]],[/droid.+; (glass) \d/i],[l,[u,C],[h,_]],[/droid.+; (wt63?0{2,3})\)/i],[l,[u,D],[h,_]],[/(quest( 2| pro)?)/i],[l,[u,M],[h,_]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[h,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[l,[h,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[h,f]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[h,f]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[h,g]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[d,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[d,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[d,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,d]],os:[[/microsoft (windows) (vista|xp)/i],[d,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[d,[p,G,$]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[d,"Windows"],[p,G,$]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[d,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[d,U],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,d],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[d,p],[/\(bb(10);/i],[p,[d,w]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[d,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[d,"Firefox OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[d,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[d,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[d,"Chromecast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[d,x],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[d,p],[/(sunos) ?([\w\.\d]*)/i],[[d,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[d,p]]},z=function(t,i){if(typeof t===r&&(i=t,t=n),!(this instanceof z))return new z(t,i).getResult();var c=typeof e!==o&&e.navigator?e.navigator:n,l=t||(c&&c.userAgent?c.userAgent:""),d=c&&c.userAgentData?c.userAgentData:n,h=i?function(t,e){var i={};for(var n in t)e[n]&&e[n].length%2==0?i[n]=e[n].concat(t[n]):i[n]=t[n];return i}(W,i):W;return this.getBrowser=function(){var t={};return t.name=n,t.version=n,H.call(t,l,h.browser),t.major=function(t){return typeof t===a?t.replace(/[^\d\.]/g,"").split(".")[0]:n}(t.version),c&&c.brave&&typeof c.brave.isBrave==s&&(t.name="Brave"),t},this.getCPU=function(){var t={};return t.architecture=n,H.call(t,l,h.cpu),t},this.getDevice=function(){var t={};return t.vendor=n,t.model=n,t.type=n,H.call(t,l,h.device),!t.type&&d&&d.mobile&&(t.type=g),"Macintosh"==t.model&&c&&typeof c.standalone!==o&&c.maxTouchPoints&&c.maxTouchPoints>2&&(t.model="iPad",t.type=f),t},this.getEngine=function(){var t={};return t.name=n,t.version=n,H.call(t,l,h.engine),t},this.getOS=function(){var t={};return t.name=n,t.version=n,H.call(t,l,h.os),!t.name&&d&&"Unknown"!=d.platform&&(t.name=d.platform.replace(/chrome os/i,x).replace(/macos/i,U)),t},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return l},this.setUA=function(t){return l=typeof t===a&&t.length>350?F(t,350):t,this},this.setUA(l),this};z.VERSION="0.7.34",z.BROWSER=V([d,p,c]),z.CPU=V([m]),z.DEVICE=V([l,u,h,v,g,E,f,_,S]),z.ENGINE=z.OS=V([d,p]),t.exports&&(i=t.exports=z),i.UAParser=z;var K=typeof e!==o&&(e.jQuery||e.Zepto);if(K&&!K.ua){var q=new z;K.ua=q.getResult(),K.ua.get=function(){return q.getUA()},K.ua.set=function(t){q.setUA(t);var e=q.getResult();for(var i in e)K.ua[i]=e[i]}}}("object"==typeof window?window:e)}(Lu,Lu.exports);const Pu=new Lu.exports;let Du,Mu,xu=Pu.getResult(),Uu=null;function Vu(t){if(!Uu){t&&Pu.setUA(t),xu=Pu.getResult();const e=function(t){if("Blink"===t.engine.name&&"WeChat"!==t.browser.name)return ku.CHROME;switch(t.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return ku.CHROME;case"Safari":case"Mobile Safari":return ku.SAFARI;case"Edge":return ku.EDGE;case"Firefox":return ku.FIREFOX;case"QQBrowser":return ku.QQ;case"Opera":return ku.OPERA;case"WeChat":return ku.WECHAT;default:return t.browser.name||""}}(xu),i=function(t){let e;return e="Blink"===t.engine.name?t.engine.version||"":t.browser.version||"",e.split(".")[0]}(xu),n=function(t){return"Windows"===t.os.name?t.os.version?t.os.name+" "+t.os.version:t.os.name:t.os.name||""}(xu),s=xu.os.version;if(!(e&&i&&n&&s))return{name:e,version:i,os:n,osVersion:s};Uu={name:e,version:i,os:n,osVersion:s}}return Uu}function Bu(){return Vu().os}function ju(){const t=Vu();return"".concat(t.os," ").concat(t.osVersion)}function Fu(){const t=Vu();return!!("WebKit"===xu.engine.name&&t.os===Nu.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==ku.SAFARI||Ku()&&t.name!==ku.SAFARI)}function Hu(){const t=Vu();if(Fu()){if(t.os===Nu.MAC_OS)return!0;if(t.os===Nu.IOS){const t=xu.os.version&&xu.os.version.split(".");if(t&&14===Number(t[0])&&t[1]&&Number(t[1])>=3)return!0;if(t&&Number(t[0])>14)return!0}}return!1}function Gu(){return"WebKit"===xu.engine.name}function $u(){return Vu().name===ku.CHROME}function Wu(){return Vu().name===ku.SAFARI}function zu(){return Vu().name===ku.FIREFOX}function Ku(){return Vu().os===Nu.IOS}function qu(t){const e=Vu();return!(e.name!==ku.CHROME||!e.osVersion)&&Number(e.version)>=t}function Yu(t){const e=Vu();return!(e.name!==ku.EDGE||!e.osVersion)&&Number(e.version)>=t}function Ju(t){const e=Vu();return!(e.name!==ku.OPERA||!e.osVersion)&&Number(e.version)>=t}function Xu(){const t=Vu();return!(t.name!==ku.CHROME||!t.osVersion)&&Number(t.version)<=90}function Qu(){const t=Vu();if(t.os!==Nu.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||14===Number(e[0])&&Number(e[1])<=6}function Zu(){const t=Vu();if(t.os!==Nu.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])}function tp(){const t=Vu();if(t.os!==Nu.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 16===Number(e[0])}function ep(){const t=Vu();if(t.os!==Nu.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])&&Number(e[1])>=1}function ip(){return Wu()&&navigator.maxTouchPoints>0}function np(){return Vu().name===ku.WECHAT}function sp(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function op(){const t=Vu();return t.name!==ku.EDGE&&t.name!==ku.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function rp(){return Bu()===Nu.ANDROID}function ap(){const t=Vu();return rp()&&(t.name===ku.CHROME||t.name===ku.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}!function(t){t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY"}(Du||(Du={})),function(t){t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver"}(Mu||(Mu={}));var cp={exports:{}},lp=Ti,dp=S,hp=$e.f;lp({target:"Object",stat:!0,forced:Object.defineProperty!==hp,sham:!dp},{defineProperty:hp});var up=q.Object,pp=cp.exports=function(t,e,i){return up.defineProperty(t,e,i)};up.defineProperty.sham&&(pp.sham=!0);var mp=cp.exports;function vp(t,e,i){return e in t?mp(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var gp,fp={exports:{}},Ep=function(t,e){return function(){for(var i=new Array(arguments.length),n=0;n<i.length;n++)i[n]=arguments[n];return t.apply(e,i)}},_p=Ep,Sp=Object.prototype.toString,bp=(gp=Object.create(null),function(t){var e=Sp.call(t);return gp[e]||(gp[e]=e.slice(8,-1).toLowerCase())});function Tp(t){return t=t.toLowerCase(),function(e){return bp(e)===t}}function yp(t){return Array.isArray(t)}function wp(t){return void 0===t}var Cp=Tp("ArrayBuffer");function Rp(t){return null!==t&&"object"==typeof t}function Ip(t){if("object"!==bp(t))return!1;var e=Object.getPrototypeOf(t);return null===e||e===Object.prototype}var Ap=Tp("Date"),Op=Tp("File"),Np=Tp("Blob"),kp=Tp("FileList");function Lp(t){return"[object Function]"===Sp.call(t)}var Pp=Tp("URLSearchParams");function Dp(t,e){if(null!=t)if("object"!=typeof t&&(t=[t]),yp(t))for(var i=0,n=t.length;i<n;i++)e.call(null,t[i],i,t);else for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.call(null,t[s],s,t)}var Mp,xp=(Mp="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(t){return Mp&&t instanceof Mp}),Up={isArray:yp,isArrayBuffer:Cp,isBuffer:function(t){return null!==t&&!wp(t)&&null!==t.constructor&&!wp(t.constructor)&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)},isFormData:function(t){var e="[object FormData]";return t&&("function"==typeof FormData&&t instanceof FormData||Sp.call(t)===e||Lp(t.toString)&&t.toString()===e)},isArrayBufferView:function(t){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&Cp(t.buffer)},isString:function(t){return"string"==typeof t},isNumber:function(t){return"number"==typeof t},isObject:Rp,isPlainObject:Ip,isUndefined:wp,isDate:Ap,isFile:Op,isBlob:Np,isFunction:Lp,isStream:function(t){return Rp(t)&&Lp(t.pipe)},isURLSearchParams:Pp,isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&"undefined"!=typeof window&&"undefined"!=typeof document},forEach:Dp,merge:function t(){var e={};function i(i,n){Ip(e[n])&&Ip(i)?e[n]=t(e[n],i):Ip(i)?e[n]=t({},i):yp(i)?e[n]=i.slice():e[n]=i}for(var n=0,s=arguments.length;n<s;n++)Dp(arguments[n],i);return e},extend:function(t,e,i){return Dp(e,(function(e,n){t[n]=i&&"function"==typeof e?_p(e,i):e})),t},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},stripBOM:function(t){return 65279===t.charCodeAt(0)&&(t=t.slice(1)),t},inherits:function(t,e,i,n){t.prototype=Object.create(e.prototype,n),t.prototype.constructor=t,i&&Object.assign(t.prototype,i)},toFlatObject:function(t,e,i){var n,s,o,r={};e=e||{};do{for(s=(n=Object.getOwnPropertyNames(t)).length;s-- >0;)r[o=n[s]]||(e[o]=t[o],r[o]=!0);t=Object.getPrototypeOf(t)}while(t&&(!i||i(t,e))&&t!==Object.prototype);return e},kindOf:bp,kindOfTest:Tp,endsWith:function(t,e,i){t=String(t),(void 0===i||i>t.length)&&(i=t.length),i-=e.length;var n=t.indexOf(e,i);return-1!==n&&n===i},toArray:function(t){if(!t)return null;var e=t.length;if(wp(e))return null;for(var i=new Array(e);e-- >0;)i[e]=t[e];return i},isTypedArray:xp,isFileList:kp},Vp=Up;function Bp(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var jp=function(t,e,i){if(!e)return t;var n;if(i)n=i(e);else if(Vp.isURLSearchParams(e))n=e.toString();else{var s=[];Vp.forEach(e,(function(t,e){null!=t&&(Vp.isArray(t)?e+="[]":t=[t],Vp.forEach(t,(function(t){Vp.isDate(t)?t=t.toISOString():Vp.isObject(t)&&(t=JSON.stringify(t)),s.push(Bp(e)+"="+Bp(t))})))})),n=s.join("&")}if(n){var o=t.indexOf("#");-1!==o&&(t=t.slice(0,o)),t+=(-1===t.indexOf("?")?"?":"&")+n}return t},Fp=Up;function Hp(){this.handlers=[]}Hp.prototype.use=function(t,e,i){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1},Hp.prototype.eject=function(t){this.handlers[t]&&(this.handlers[t]=null)},Hp.prototype.forEach=function(t){Fp.forEach(this.handlers,(function(e){null!==e&&t(e)}))};var Gp=Hp,$p=Up,Wp=Up;function zp(t,e,i,n,s){Error.call(this),this.message=t,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),n&&(this.request=n),s&&(this.response=s)}Wp.inherits(zp,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var Kp=zp.prototype,qp={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(t){qp[t]={value:t}})),Object.defineProperties(zp,qp),Object.defineProperty(Kp,"isAxiosError",{value:!0}),zp.from=function(t,e,i,n,s,o){var r=Object.create(Kp);return Wp.toFlatObject(t,r,(function(t){return t!==Error.prototype})),zp.call(r,t.message,e,i,n,s),r.name=t.name,o&&Object.assign(r,o),r};var Yp=zp,Jp={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Xp=Up,Qp=function(t,e){e=e||new FormData;var i=[];function n(t){return null===t?"":Xp.isDate(t)?t.toISOString():Xp.isArrayBuffer(t)||Xp.isTypedArray(t)?"function"==typeof Blob?new Blob([t]):Buffer.from(t):t}return function t(s,o){if(Xp.isPlainObject(s)||Xp.isArray(s)){if(-1!==i.indexOf(s))throw Error("Circular reference detected in "+o);i.push(s),Xp.forEach(s,(function(i,s){if(!Xp.isUndefined(i)){var r,a=o?o+"."+s:s;if(i&&!o&&"object"==typeof i)if(Xp.endsWith(s,"{}"))i=JSON.stringify(i);else if(Xp.endsWith(s,"[]")&&(r=Xp.toArray(i)))return void r.forEach((function(t){!Xp.isUndefined(t)&&e.append(a,n(t))}));t(i,a)}})),i.pop()}else e.append(o,n(s))}(t),e},Zp=Yp,tm=Up,em=tm.isStandardBrowserEnv()?{write:function(t,e,i,n,s,o){var r=[];r.push(t+"="+encodeURIComponent(e)),tm.isNumber(i)&&r.push("expires="+new Date(i).toGMTString()),tm.isString(n)&&r.push("path="+n),tm.isString(s)&&r.push("domain="+s),!0===o&&r.push("secure"),document.cookie=r.join("; ")},read:function(t){var e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},im=function(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)},nm=function(t,e){return e?t.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):t},sm=function(t,e){return t&&!im(e)?nm(t,e):e},om=Up,rm=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],am=Up,cm=am.isStandardBrowserEnv()?function(){var t,e=/(msie|trident)/i.test(navigator.userAgent),i=document.createElement("a");function n(t){var n=t;return e&&(i.setAttribute("href",n),n=i.href),i.setAttribute("href",n),{href:i.href,protocol:i.protocol?i.protocol.replace(/:$/,""):"",host:i.host,search:i.search?i.search.replace(/^\?/,""):"",hash:i.hash?i.hash.replace(/^#/,""):"",hostname:i.hostname,port:i.port,pathname:"/"===i.pathname.charAt(0)?i.pathname:"/"+i.pathname}}return t=n(window.location.href),function(e){var i=am.isString(e)?n(e):e;return i.protocol===t.protocol&&i.host===t.host}}():function(){return!0},lm=Yp;function dm(t){lm.call(this,null==t?"canceled":t,lm.ERR_CANCELED),this.name="CanceledError"}Up.inherits(dm,lm,{__CANCEL__:!0});var hm=dm,um=Up,pm=function(t,e,i){var n=i.config.validateStatus;i.status&&n&&!n(i.status)?e(new Zp("Request failed with status code "+i.status,[Zp.ERR_BAD_REQUEST,Zp.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):t(i)},mm=em,vm=jp,gm=sm,fm=function(t){var e,i,n,s={};return t?(om.forEach(t.split("\n"),(function(t){if(n=t.indexOf(":"),e=om.trim(t.substr(0,n)).toLowerCase(),i=om.trim(t.substr(n+1)),e){if(s[e]&&rm.indexOf(e)>=0)return;s[e]="set-cookie"===e?(s[e]?s[e]:[]).concat([i]):s[e]?s[e]+", "+i:i}})),s):s},Em=cm,_m=Jp,Sm=Yp,bm=hm,Tm=function(t){var e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""},ym=function(t){return new Promise((function(e,i){var n,s=t.data,o=t.headers,r=t.responseType;function a(){t.cancelToken&&t.cancelToken.unsubscribe(n),t.signal&&t.signal.removeEventListener("abort",n)}um.isFormData(s)&&um.isStandardBrowserEnv()&&delete o["Content-Type"];var c=new XMLHttpRequest;if(t.auth){var l=t.auth.username||"",d=t.auth.password?unescape(encodeURIComponent(t.auth.password)):"";o.Authorization="Basic "+btoa(l+":"+d)}var h=gm(t.baseURL,t.url);function u(){if(c){var n="getAllResponseHeaders"in c?fm(c.getAllResponseHeaders()):null,s={data:r&&"text"!==r&&"json"!==r?c.response:c.responseText,status:c.status,statusText:c.statusText,headers:n,config:t,request:c};pm((function(t){e(t),a()}),(function(t){i(t),a()}),s),c=null}}if(c.open(t.method.toUpperCase(),vm(h,t.params,t.paramsSerializer),!0),c.timeout=t.timeout,"onloadend"in c?c.onloadend=u:c.onreadystatechange=function(){c&&4===c.readyState&&(0!==c.status||c.responseURL&&0===c.responseURL.indexOf("file:"))&&setTimeout(u)},c.onabort=function(){c&&(i(new Sm("Request aborted",Sm.ECONNABORTED,t,c)),c=null)},c.onerror=function(){i(new Sm("Network Error",Sm.ERR_NETWORK,t,c,c)),c=null},c.ontimeout=function(){var e=t.timeout?"timeout of "+t.timeout+"ms exceeded":"timeout exceeded",n=t.transitional||_m;t.timeoutErrorMessage&&(e=t.timeoutErrorMessage),i(new Sm(e,n.clarifyTimeoutError?Sm.ETIMEDOUT:Sm.ECONNABORTED,t,c)),c=null},um.isStandardBrowserEnv()){var p=(t.withCredentials||Em(h))&&t.xsrfCookieName?mm.read(t.xsrfCookieName):void 0;p&&(o[t.xsrfHeaderName]=p)}"setRequestHeader"in c&&um.forEach(o,(function(t,e){void 0===s&&"content-type"===e.toLowerCase()?delete o[e]:c.setRequestHeader(e,t)})),um.isUndefined(t.withCredentials)||(c.withCredentials=!!t.withCredentials),r&&"json"!==r&&(c.responseType=t.responseType),"function"==typeof t.onDownloadProgress&&c.addEventListener("progress",t.onDownloadProgress),"function"==typeof t.onUploadProgress&&c.upload&&c.upload.addEventListener("progress",t.onUploadProgress),(t.cancelToken||t.signal)&&(n=function(t){c&&(i(!t||t&&t.type?new bm:t),c.abort(),c=null)},t.cancelToken&&t.cancelToken.subscribe(n),t.signal&&(t.signal.aborted?n():t.signal.addEventListener("abort",n))),s||(s=null);var m=Tm(h);m&&-1===["http","https","file"].indexOf(m)?i(new Sm("Unsupported protocol "+m+":",Sm.ERR_BAD_REQUEST,t)):c.send(s)}))},wm=Up,Cm=function(t,e){$p.forEach(t,(function(i,n){n!==e&&n.toUpperCase()===e.toUpperCase()&&(t[e]=i,delete t[n])}))},Rm=Yp,Im=Qp,Am={"Content-Type":"application/x-www-form-urlencoded"};function Om(t,e){!wm.isUndefined(t)&&wm.isUndefined(t["Content-Type"])&&(t["Content-Type"]=e)}var Nm,km={transitional:Jp,adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(Nm=ym),Nm),transformRequest:[function(t,e){if(Cm(e,"Accept"),Cm(e,"Content-Type"),wm.isFormData(t)||wm.isArrayBuffer(t)||wm.isBuffer(t)||wm.isStream(t)||wm.isFile(t)||wm.isBlob(t))return t;if(wm.isArrayBufferView(t))return t.buffer;if(wm.isURLSearchParams(t))return Om(e,"application/x-www-form-urlencoded;charset=utf-8"),t.toString();var i,n=wm.isObject(t),s=e&&e["Content-Type"];if((i=wm.isFileList(t))||n&&"multipart/form-data"===s){var o=this.env&&this.env.FormData;return Im(i?{"files[]":t}:t,o&&new o)}return n||"application/json"===s?(Om(e,"application/json"),function(t,e,i){if(wm.isString(t))try{return(e||JSON.parse)(t),wm.trim(t)}catch(t){if("SyntaxError"!==t.name)throw t}return(i||JSON.stringify)(t)}(t)):t}],transformResponse:[function(t){var e=this.transitional||km.transitional,i=e&&e.silentJSONParsing,n=e&&e.forcedJSONParsing,s=!i&&"json"===this.responseType;if(s||n&&wm.isString(t)&&t.length)try{return JSON.parse(t)}catch(t){if(s){if("SyntaxError"===t.name)throw Rm.from(t,Rm.ERR_BAD_RESPONSE,this,null,this.response);throw t}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:null},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};wm.forEach(["delete","get","head"],(function(t){km.headers[t]={}})),wm.forEach(["post","put","patch"],(function(t){km.headers[t]=wm.merge(Am)}));var Lm=km,Pm=Up,Dm=Lm,Mm=function(t){return!(!t||!t.__CANCEL__)},xm=Up,Um=function(t,e,i){var n=this||Dm;return Pm.forEach(i,(function(i){t=i.call(n,t,e)})),t},Vm=Mm,Bm=Lm,jm=hm;function Fm(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new jm}var Hm=Up,Gm=function(t,e){e=e||{};var i={};function n(t,e){return Hm.isPlainObject(t)&&Hm.isPlainObject(e)?Hm.merge(t,e):Hm.isPlainObject(e)?Hm.merge({},e):Hm.isArray(e)?e.slice():e}function s(i){return Hm.isUndefined(e[i])?Hm.isUndefined(t[i])?void 0:n(void 0,t[i]):n(t[i],e[i])}function o(t){if(!Hm.isUndefined(e[t]))return n(void 0,e[t])}function r(i){return Hm.isUndefined(e[i])?Hm.isUndefined(t[i])?void 0:n(void 0,t[i]):n(void 0,e[i])}function a(i){return i in e?n(t[i],e[i]):i in t?n(void 0,t[i]):void 0}var c={url:o,method:o,data:o,baseURL:r,transformRequest:r,transformResponse:r,paramsSerializer:r,timeout:r,timeoutMessage:r,withCredentials:r,adapter:r,responseType:r,xsrfCookieName:r,xsrfHeaderName:r,onUploadProgress:r,onDownloadProgress:r,decompress:r,maxContentLength:r,maxBodyLength:r,beforeRedirect:r,transport:r,httpAgent:r,httpsAgent:r,cancelToken:r,socketPath:r,responseEncoding:r,validateStatus:a};return Hm.forEach(Object.keys(t).concat(Object.keys(e)),(function(t){var e=c[t]||s,n=e(t);Hm.isUndefined(n)&&e!==a||(i[t]=n)})),i},$m="0.27.2",Wm=$m,zm=Yp,Km={};["object","boolean","number","function","string","symbol"].forEach((function(t,e){Km[t]=function(i){return typeof i===t||"a"+(e<1?"n ":" ")+t}}));var qm={};Km.transitional=function(t,e,i){function n(t,e){return"[Axios v"+Wm+"] Transitional option '"+t+"'"+e+(i?". "+i:"")}return function(i,s,o){if(!1===t)throw new zm(n(s," has been removed"+(e?" in "+e:"")),zm.ERR_DEPRECATED);return e&&!qm[s]&&(qm[s]=!0,console.warn(n(s," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(i,s,o)}};var Ym=Up,Jm=jp,Xm=Gp,Qm=function(t){return Fm(t),t.headers=t.headers||{},t.data=Um.call(t,t.data,t.headers,t.transformRequest),t.headers=xm.merge(t.headers.common||{},t.headers[t.method]||{},t.headers),xm.forEach(["delete","get","head","post","put","patch","common"],(function(e){delete t.headers[e]})),(t.adapter||Bm.adapter)(t).then((function(e){return Fm(t),e.data=Um.call(t,e.data,e.headers,t.transformResponse),e}),(function(e){return Vm(e)||(Fm(t),e&&e.response&&(e.response.data=Um.call(t,e.response.data,e.response.headers,t.transformResponse))),Promise.reject(e)}))},Zm=Gm,tv=sm,ev={assertOptions:function(t,e,i){if("object"!=typeof t)throw new zm("options must be an object",zm.ERR_BAD_OPTION_VALUE);for(var n=Object.keys(t),s=n.length;s-- >0;){var o=n[s],r=e[o];if(r){var a=t[o],c=void 0===a||r(a,o,t);if(!0!==c)throw new zm("option "+o+" must be "+c,zm.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new zm("Unknown option "+o,zm.ERR_BAD_OPTION)}},validators:Km},iv=ev.validators;function nv(t){this.defaults=t,this.interceptors={request:new Xm,response:new Xm}}nv.prototype.request=function(t,e){"string"==typeof t?(e=e||{}).url=t:e=t||{},(e=Zm(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var i=e.transitional;void 0!==i&&ev.assertOptions(i,{silentJSONParsing:iv.transitional(iv.boolean),forcedJSONParsing:iv.transitional(iv.boolean),clarifyTimeoutError:iv.transitional(iv.boolean)},!1);var n=[],s=!0;this.interceptors.request.forEach((function(t){"function"==typeof t.runWhen&&!1===t.runWhen(e)||(s=s&&t.synchronous,n.unshift(t.fulfilled,t.rejected))}));var o,r=[];if(this.interceptors.response.forEach((function(t){r.push(t.fulfilled,t.rejected)})),!s){var a=[Qm,void 0];for(Array.prototype.unshift.apply(a,n),a=a.concat(r),o=Promise.resolve(e);a.length;)o=o.then(a.shift(),a.shift());return o}for(var c=e;n.length;){var l=n.shift(),d=n.shift();try{c=l(c)}catch(t){d(t);break}}try{o=Qm(c)}catch(t){return Promise.reject(t)}for(;r.length;)o=o.then(r.shift(),r.shift());return o},nv.prototype.getUri=function(t){t=Zm(this.defaults,t);var e=tv(t.baseURL,t.url);return Jm(e,t.params,t.paramsSerializer)},Ym.forEach(["delete","get","head","options"],(function(t){nv.prototype[t]=function(e,i){return this.request(Zm(i||{},{method:t,url:e,data:(i||{}).data}))}})),Ym.forEach(["post","put","patch"],(function(t){function e(e){return function(i,n,s){return this.request(Zm(s||{},{method:t,headers:e?{"Content-Type":"multipart/form-data"}:{},url:i,data:n}))}}nv.prototype[t]=e(),nv.prototype[t+"Form"]=e(!0)}));var sv=nv,ov=hm;function rv(t){if("function"!=typeof t)throw new TypeError("executor must be a function.");var e;this.promise=new Promise((function(t){e=t}));var i=this;this.promise.then((function(t){if(i._listeners){var e,n=i._listeners.length;for(e=0;e<n;e++)i._listeners[e](t);i._listeners=null}})),this.promise.then=function(t){var e,n=new Promise((function(t){i.subscribe(t),e=t})).then(t);return n.cancel=function(){i.unsubscribe(e)},n},t((function(t){i.reason||(i.reason=new ov(t),e(i.reason))}))}rv.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},rv.prototype.subscribe=function(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]},rv.prototype.unsubscribe=function(t){if(this._listeners){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)}},rv.source=function(){var t;return{token:new rv((function(e){t=e})),cancel:t}};var av=rv,cv=Up,lv=Up,dv=Ep,hv=sv,uv=Gm,pv=function t(e){var i=new hv(e),n=dv(hv.prototype.request,i);return lv.extend(n,hv.prototype,i),lv.extend(n,i),n.create=function(i){return t(uv(e,i))},n}(Lm);pv.Axios=hv,pv.CanceledError=hm,pv.CancelToken=av,pv.isCancel=Mm,pv.VERSION=$m,pv.toFormData=Qp,pv.AxiosError=Yp,pv.Cancel=pv.CanceledError,pv.all=function(t){return Promise.all(t)},pv.spread=function(t){return function(e){return t.apply(null,e)}},pv.isAxiosError=function(t){return cv.isObject(t)&&!0===t.isAxiosError},fp.exports=pv,fp.exports.default=pv;var mv=fp.exports;class vv{constructor(t){vp(this,"logger",void 0),vp(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.debug(...this.prefixLists,...e)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.info(...this.prefixLists,...e)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.warning(...this.prefixLists,...e)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.logger.error(...this.prefixLists,...e)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}class gv{constructor(){vp(this,"_events",{}),vp(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map((t=>t.listener)):[]}on(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];-1===this._indexOfListener(i,e)&&i.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];-1===this._indexOfListener(i,e)&&i.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const i=this._events[t],n=this._indexOfListener(i,e);-1!==n&&i.splice(n,1),0===this._events[t].length&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map((t=>t));for(var i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];for(let i=0;i<e.length;i+=1){const s=e[i];s.once&&this.off(t,s.listener),s.listener.apply(this,n||[])}}safeEmit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];[...this._events[t]||[]].forEach((e=>{e.once&&this.off(t,e.listener);try{e.listener.apply(this,i)}catch(e){Av.error("safeEmit event:".concat(t," error ").concat(null==e?void 0:e.toString()))}}))}_indexOfListener(t,e){let i=t.length;for(;i--;)if(t[i].listener===e)return i;return-1}}const fv=new class extends gv{reportLogUploadError(t){this.emit("REPORT_LOG_UPLOAD",t)}};let Ev;!function(t){t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED"}(Ev||(Ev={}));class _v extends Error{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(e),vp(this,"code",void 0),vp(this,"message",void 0),vp(this,"data",void 0),vp(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),"\n").concat(this.stack):"".concat(this.stack)}print(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return"error"===t&&Av.error(this.toString()),"warning"===t&&Av.warning(this.toString()),this}throw(){throw this.print(),this}}const Sv={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function bv(t,e){const i=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,i)}function Tv(t,e,i,n){const s=Object.assign({},Sv,n);let o=s.timeout;const r=async()=>{await function(t){return new _h((e=>{window.setTimeout(e,t)}))}(o),o*=s.timeoutFactor,o=Math.min(s.maxRetryTimeout,o)};let a=!1;const c=new _h((async(n,o)=>{e=e||(()=>!1),i=i||(()=>!0);for(let c=0;c<s.maxRetryCount;c+=1){if(a)return o(new _v(Ev.OPERATION_ABORTED));try{const i=await t();if(!e(i,c))return n(i);if(c+1===s.maxRetryCount)return n(i);await r()}catch(t){if(!i(t,c))return o(t);if(c+1===s.maxRetryCount)return o(t);await r()}}}));return c.cancel=()=>a=!0,c}function yv(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function wv(){const t=new Date,e=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return e?(null==e?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const Cv={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Rv=Date.now(),Iv=t=>{for(const e in Cv)if(Object.prototype.hasOwnProperty.call(Cv,e)&&Cv[e]===t)return e;return"DEFAULT"},Av=new class{constructor(){vp(this,"proxyServerURL",void 0),vp(this,"logLevel",Cv.DEBUG),vp(this,"uploadState","collecting"),vp(this,"uploadLogWaitingList",[]),vp(this,"uploadLogUploadingList",[]),vp(this,"uploadErrorCount",0),vp(this,"currentLogID",0),vp(this,"url",void 0),vp(this,"extLog",((t,e)=>{this.appendLogToWaitingList(t,...e)}))}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Cv.DEBUG].concat(e);this.log.apply(this,n)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Cv.INFO].concat(e);this.log.apply(this,n)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Cv.WARNING].concat(e);this.log.apply(this,n)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Cv.ERROR].concat(e);this.log.apply(this,n)}upload(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[Cv.DEBUG].concat(e);this.uploadLog.apply(this,n)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Hv("UPLOAD_LOG",!0)}disableLogUpload(){Hv("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new vv(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Rv<100)return void setTimeout((()=>{this.log(...e)}),Date.now()-Rv);const n=Math.max(0,Math.min(4,e[0]));if(e[0]=yv()+" Agora-SDK [".concat(Iv(n),"]:"),this.appendLogToWaitingList(n,...e),n<this.logLevel)return;const s=yv()+" %cAgora-SDK [".concat(Iv(n),"]:");let o=[];if(!Gv("USE_NEW_LOG"))switch(n){case Cv.DEBUG:o=[s,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case Cv.INFO:o=[s,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case Cv.WARNING:o=[s,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case Cv.ERROR:o=[s,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Rv<100)return void setTimeout((()=>{this.uploadLog(...e)}),Date.now()-Rv);const n=Math.max(0,Math.min(4,e[0]));e[0]=yv()+" Agora-SDK [".concat(Iv(n),"]:"),this.appendLogToWaitingList(n,...e)}appendLogToWaitingList(t){if(!Gv("UPLOAD_LOG"))return;for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];Array.isArray(i[0])?i[0][0]=wv()+" Agora-SDK [".concat(Iv(t),"]:"):i[0]=wv()+" Agora-SDK [".concat(Iv(t),"]:");let s="";i.forEach((t=>{"object"==typeof t&&(t=JSON.stringify(t)),s+="".concat(t," ")})),this.uploadLogWaitingList.push({payload_str:s,log_level:t,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:Nv,process_id:Gv("PROCESS_ID"),payload:JSON.stringify(t)};return Tv((async()=>{const t=await mv.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(Gv("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(Gv("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if("OK"!==t.data){const e=new Error("unexpected upload log response");throw e.response=t,e}}),(()=>(this.uploadLogUploadingList=[],!1)),(t=>(t.response?fv.reportLogUploadError({status:t.response.status,data:t.response.data,headers:t.response.headers,message:t.message}):t.request?fv.reportLogUploadError({status:t.request.status,message:t.message}):fv.reportLogUploadError({status:-1,message:t.message}),!0)),{timeout:Gv("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:Gv("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,Gv("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),Gv("UPLOAD_LOG_INTERVAL"))})).catch((t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),Gv("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),Gv("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}},Ov="v4.18.2-0-g8d83af1d-dirty(7/11/2023, 7:07:15 PM)",Nv=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(e&&e[1]&&e[2]){const t=e[1],i=e[2];return"".concat(t,".").concat(i)}const i=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){const t=i[1],e=i[2];return"".concat(t,".").concat(100*(Number(e)+1))}return"4.0.0.999"}("4.18.2"),kv=function(){try{return!0===JSON.parse("true")}catch(t){return!0}}(),Lv=["CHINA","GLOBAL"],Pv=function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let t=0;t<6;t++)s.push("1");const o=s.join(""),r={};return r[t]=n,r[e]=o,Object.assign(r,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Pv;const Dv={"90p":Kv(160,90),"90p_1":Kv(160,90),"120p":Kv(160,120,15,30,65),"120p_1":Kv(160,120,15,30,65),"120p_3":Kv(120,120,15,30,50),"120p_4":Kv(212,120),"180p":Kv(320,180,15,30,140),"180p_1":Kv(320,180,15,30,140),"180p_3":Kv(180,180,15,30,100),"180p_4":Kv(240,180,15,30,120),"240p":Kv(320,240,15,40,200),"240p_1":Kv(320,240,15,40,200),"240p_3":Kv(240,240,15,40,140),"240p_4":Kv(424,240,15,40,220),"360p":Kv(640,360,15,80,400),"360p_1":Kv(640,360,15,80,400),"360p_3":Kv(360,360,15,80,260),"360p_4":Kv(640,360,30,80,600),"360p_6":Kv(360,360,30,80,400),"360p_7":Kv(480,360,15,80,320),"360p_8":Kv(480,360,30,80,490),"360p_9":Kv(640,360,15,80,800),"360p_10":Kv(640,360,24,80,800),"360p_11":Kv(640,360,24,80,1e3),"480p":Kv(640,480,15,100,500),"480p_1":Kv(640,480,15,100,500),"480p_2":Kv(640,480,30,100,1e3),"480p_3":Kv(480,480,15,100,400),"480p_4":Kv(640,480,30,100,750),"480p_6":Kv(480,480,30,100,600),"480p_8":Kv(848,480,15,100,610),"480p_9":Kv(848,480,30,100,930),"480p_10":Kv(640,480,10,100,400),"720p":Kv(1280,720,15,120,1130),"720p_1":Kv(1280,720,15,120,1130),"720p_2":Kv(1280,720,30,120,2e3),"720p_3":Kv(1280,720,30,120,1710),"720p_5":Kv(960,720,15,120,910),"720p_6":Kv(960,720,30,120,1380),"1080p":Kv(1920,1080,15,120,2080),"1080p_1":Kv(1920,1080,15,120,2080),"1080p_2":Kv(1920,1080,30,120,3e3),"1080p_3":Kv(1920,1080,30,120,3150),"1080p_5":Kv(1920,1080,60,120,4780),"1440p":Kv(2560,1440,30,120,4850),"1440p_1":Kv(2560,1440,30,120,4850),"1440p_2":Kv(2560,1440,60,120,7350),"4k":Kv(3840,2160,30,120,8910),"4k_1":Kv(3840,2160,30,120,8910),"4k_3":Kv(3840,2160,60,120,13500)},Mv={"480p":qv(640,480,5),"480p_1":qv(640,480,5),"480p_2":qv(640,480,30),"480p_3":qv(640,480,15),"720p":qv(1280,720,5),"720p_1":qv(1280,720,5),"720p_2":qv(1280,720,30),"720p_3":qv(1280,720,15),"1080p":qv(1920,1080,5),"1080p_1":qv(1920,1080,5),"1080p_2":qv(1920,1080,30),"1080p_3":qv(1920,1080,15)},xv={"1SL1TL":Yv(1,1),"3SL3TL":Yv(3,3),"2SL3TL":Yv(2,3)};function Uv(t){return t||(t="480p_1"),"string"==typeof t?Object.assign({},Dv[t]):t}function Vv(t){return"string"==typeof t?Object.assign({},Mv[t]):t}function Bv(t){return"string"==typeof t?Object.assign({},xv[t]):t}const jv={speech_low_quality:zv(16e3,!1),speech_standard:zv(32e3,!1,18),music_standard:zv(48e3,!1),standard_stereo:zv(48e3,!0,56),high_quality:zv(48e3,!1,128),high_quality_stereo:zv(48e3,!0,192)};function Fv(t){return"string"==typeof t?Object.assign({},jv[t]):t}function Hv(t,e,i){Object.keys($v).includes(t)&&(!i&&Object.keys(Wv).includes(t)||($v[t]=e))}function Gv(t){return $v[t]}const $v={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:Lv,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_WITH_FALLBACK_PROXY_PENDING_DURATION:2e3,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0}},Wv={};function zv(t,e,i){return{sampleRate:t,stereo:e,bitrate:i}}function Kv(t,e,i,n,s){return{width:t,height:e,frameRate:i,bitrateMin:n,bitrateMax:s}}function qv(t,e,i,n,s){return{width:{max:t},height:{max:e},frameRate:i,bitrateMin:n,bitrateMax:s}}function Yv(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}kv||($v.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],$v.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],$v.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],$v.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],$v.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],$v.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],$v.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",$v.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",$v.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",$v.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",$v.AREAS=["NORTH_AMERICA","OVERSEA"]);const Jv=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Xv=[],Qv=[];function Zv(t,e){return!!e&&Xv.some((i=>i.uid===t&&i.channelName===e))}var tg=ve,eg=$e,ig=N,ng=function(t,e,i){var n=tg(e);n in t?eg.f(t,n,ig(0,i)):t[n]=i},sg=Un,og=Oi,rg=ng,ag=u.Array,cg=Math.max,lg=function(t,e,i){for(var n=og(t),s=sg(e,n),o=sg(void 0===i?n:i,n),r=ag(cg(o-s,0)),a=0;s<o;s++,a++)rg(r,a,t[s]);return r.length=a,r},dg=lg,hg=Math.floor,ug=function(t,e){var i=t.length,n=hg(i/2);return i<8?pg(t,e):mg(t,ug(dg(t,0,n),e),ug(dg(t,n),e),e)},pg=function(t,e){for(var i,n,s=t.length,o=1;o<s;){for(n=o,i=t[o];n&&e(t[n-1],i)>0;)t[n]=t[--n];n!==o++&&(t[n]=i)}return t},mg=function(t,e,i,n){for(var s=e.length,o=i.length,r=0,a=0;r<s||a<o;)t[r+a]=r<s&&a<o?n(e[r],i[a])<=0?e[r++]:i[a++]:r<s?e[r++]:i[a++];return t},vg=ug,gg=tt.match(/firefox\/(\d+)/i),fg=!!gg&&+gg[1],Eg=/MSIE|Trident/.test(tt),_g=tt.match(/AppleWebKit\/(\d+)\./),Sg=!!_g&&+_g[1],bg=Ti,Tg=l,yg=yt,wg=Bt,Cg=Oi,Rg=ko,Ig=i,Ag=vg,Og=Bi,Ng=fg,kg=Eg,Lg=at,Pg=Sg,Dg=[],Mg=Tg(Dg.sort),xg=Tg(Dg.push),Ug=Ig((function(){Dg.sort(void 0)})),Vg=Ig((function(){Dg.sort(null)})),Bg=Og("sort"),jg=!Ig((function(){if(Lg)return Lg<70;if(!(Ng&&Ng>3)){if(kg)return!0;if(Pg)return Pg<603;var t,e,i,n,s="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)Dg.push({k:e+n,v:i})}for(Dg.sort((function(t,e){return e.v-t.v})),n=0;n<Dg.length;n++)e=Dg[n].k.charAt(0),s.charAt(s.length-1)!==e&&(s+=e);return"DGBEFHACIJK"!==s}}));bg({target:"Array",proto:!0,forced:Ug||!Vg||!Bg||!jg},{sort:function(t){void 0!==t&&yg(t);var e=wg(this);if(jg)return void 0===t?Mg(e):Mg(e,t);var i,n,s=[],o=Cg(e);for(n=0;n<o;n++)n in e&&xg(s,e[n]);for(Ag(s,function(t){return function(e,i){return void 0===i?-1:void 0===e?1:void 0!==t?+t(e,i)||0:Rg(e)>Rg(i)?1:-1}}(t)),i=s.length,n=0;n<i;)e[n]=s[n++];for(;n<o;)delete e[n++];return e}});var Fg=Wi("Array").sort,Hg=d,Gg=Fg,$g=Array.prototype,Wg=function(t){var e=t.sort;return t===$g||Hg($g,t)&&e===$g.sort?Gg:e};function zg(t,e){if("boolean"!=typeof t)throw new _v(Ev.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function Kg(t,e,i){if(!i.includes(t))throw new _v(Ev.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(i)))}function qg(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(t<i||t>n||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!nf(t))throw new _v(Ev.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(i,", ").concat(n,"]. integer only"))}function Yg(t,e){if("number"!=typeof t){if(!(t.min||t.max||t.ideal||t.exact))throw new _v(Ev.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));void 0!==t.min&&qg(t.min,"".concat(e,".min"),0,1/0),void 0!==t.max&&qg(t.max,"".concat(e,".max"),1,1/0),void 0!==t.exact&&qg(t.exact,"".concat(e,".exact"),1,1/0),void 0!==t.ideal&&qg(t.ideal,"".concat(e,".ideal"),1,1/0)}else qg(t,e,1,1/0)}function Jg(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==t)throw new _v(Ev.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!ef(t,i,n,s))throw new _v(Ev.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(i,",").concat(n,"].").concat(s?" ASCII characters only.":""))}function Xg(t,e){if(!Array.isArray(t))throw new _v(Ev.INVALID_PARAMS,"".concat(e," should be an array"))}function Qg(t){if("string"!=typeof t||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw Av.error("Invalid Channel Name ".concat(t)),new _v(Ev.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Zg(t){if(!("number"==typeof(e=t)&&Math.floor(e)===e&&0<=e&&e<=4294967295||ef(t,1,255)))throw Av.error("Invalid UID ".concat(t," ").concat(typeof t)),new _v(Ev.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;"string"==typeof t&&Av.warning("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}function tf(t){return null==t}function ef(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof t&&t.length<=i&&t.length>=e&&(!n||sf(t))}function nf(t){return"number"==typeof t&&t%1==0}function sf(t){if("string"!=typeof t)return!1;for(let e=0;e<t.length;e+=1){const i=t.charCodeAt(e);if(i<0||i>255)return!1}return!0}let of,rf,af;!function(t){t.FREE="free",t.UPLOADING="uploading"}(of||(of={})),function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}(rf||(rf={})),function(t){t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata"}(af||(af={}));const cf={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};function lf(t){return Jg(t.reportId,"params.reportId",0,100,!1),Jg(t.category,"params.category",0,100,!1),Jg(t.event,"params.event",0,100,!1),Jg(t.label,"params.label",0,100,!1),qg(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}const df={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let hf,uf,pf,mf,vf,gf,ff,Ef,_f,Sf,bf,Tf,yf,wf,Cf,Rf,If,Af,Of,Nf,kf,Lf,Pf,Df;function Mf(t){return qg(t.timeout,"config.timeout",0,1e5),qg(t.timeoutFactor,"config.timeoutFactor",0,100,!1),qg(t.maxRetryCount,"config.maxRetryConfig",0,1/0),qg(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function xf(t){return Kg(t.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Kg(t.mode,"config.mode",["rtc","live"]),void 0!==t.audioCodec&&Kg(t.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==t.proxyServer&&Jg(t.proxyServer,"config.proxyServer",1,1e4),void 0!==t.turnServer&&Vf(t.turnServer),void 0!==t.httpRetryConfig&&Mf(t.httpRetryConfig),void 0!==t.websocketRetryConfig&&Mf(t.websocketRetryConfig),!0}function Uf(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach((t=>{if(!t.urls)throw Error()}))}catch(t){return!1}return!0}function Vf(t){return Jg(t.turnServerURL,"turnServerURL"),Jg(t.username,"username"),Jg(t.password,"password"),t.udpport&&qg(t.udpport,"udpport",1,99999,!0),t.forceturn&&zg(t.forceturn,"forceturn"),t.security&&zg(t.security,"security"),t.tcpport&&qg(t.tcpport,"tcpport",1,99999,!0),!0}function Bf(t){return void 0!==t.level&&Kg(t.level,"level",[1,2,3]),!0}!function(t){t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats"}(hf||(hf={})),function(t){t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats"}(uf||(uf={})),function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(pf||(pf={})),function(t){t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(mf||(mf={})),function(t){t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.DATACHANNEL_FAILBACK="Client._datachannelFailback",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",t.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload"}(vf||(vf={})),function(t){t.TRACER="tracer"}(gf||(gf={})),function(t){t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND"}(ff||(ff={})),function(t){t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(Ef||(Ef={})),function(t){t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(_f||(_f={})),function(t){t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(Sf||(Sf={})),function(t){t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(bf||(bf={})),function(t){t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(Tf||(Tf={})),function(t){t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(yf||(yf={})),function(t){t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(wf||(wf={})),function(t){t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.FALLBACK="FALLBACK",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL"}(Cf||(Cf={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.INJECT_STREAM_STATUS="stream-inject-status",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(Rf||(Rf={})),function(t){t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK"}(If||(If={})),function(t){t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed"}(Af||(Af={})),function(t){t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_CONNECTING="datachannel_connecting",t.DATACHANNEL_FAILBACK="datachannel_failback"}(Of||(Of={})),function(t){t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.SUBSCRIBE="subscribe",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter"}(Nf||(Nf={})),function(t){t.PUBLISH_STATS="publish_stats",t.PUBLISH_RELATED_STATS="publish_related_stats",t.SUBSCRIBE_STATS="subscribe_stats",t.SUBSCRIBE_RELATED_STATS="subscribe_related_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.TRANSPORT_STATS="transport_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats"}(kf||(kf={})),function(t){t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list"}(Lf||(Lf={})),function(t){t.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",t.NEED_ANSWER="NEED_ANSWER",t.NEED_RENEGOTIATE="NEED_RENEGOTIATE",t.P2P_LOST="P2P_LOST",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NEED_UNPUB="NEED_UNPUB",t.NEED_UNSUB="NEED_UNSUB",t.NEED_UPLOAD="NEED_UPLOAD",t.NEED_CONTROL="NEED_CONTROL",t.START_RECONNECT="START_RECONNECT",t.END_RECONNECT="END_RECONNECT",t.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(Pf||(Pf={})),function(t){t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source"}(Df||(Df={}));const jf={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,currentPacketLossRate:0},Ff={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},Hf={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},Gf={uplinkNetworkQuality:0,downlinkNetworkQuality:0},$f={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Wf,zf,Kf;!function(t){t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(Wf||(Wf={})),function(t){t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t.INJECT="inject_streaming"}(zf||(zf={})),function(t){t[t.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",t[t.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",t[t.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",t[t.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",t[t.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",t[t.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",t[t.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",t[t.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",t[t.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",t[t.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(Kf||(Kf={}));const qf={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Yf={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Jf(t,e){Jg(t.url,"".concat(e,".url"),1,1e3,!1),tf(t.x)||qg(t.x,"".concat(e,".x"),0,1e4),tf(t.y)||qg(t.y,"".concat(e,".y"),0,1e4),tf(t.width)||qg(t.width,"".concat(e,".width"),0,1e4),tf(t.height)||qg(t.height,"".concat(e,".height"),0,1e4),tf(t.zOrder)||qg(t.zOrder,"".concat(e,".zOrder"),0,255),tf(t.alpha)||qg(t.alpha,"".concat(e,".alpha"),0,1,!1)}const Xf={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Qf={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let Zf,tE,eE,iE,nE,sE,oE,rE,aE,cE,lE,dE,hE,uE,pE,mE,vE,gE,fE,EE,_E;function SE(t){if(!t.channelName)throw new _v(Ev.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof t.uid)throw new _v(Ev.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&Jg(t.token,"info.token",1,2047),Zg(t.uid),Qg(t.channelName),!0}function bE(t){return Kg(t,"mediaSource",["screen","window","application"]),!0}!function(t){t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.INJECT_STREAM_STATUS="@live_uap-inject-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address"}(Zf||(Zf={})),function(t){t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(tE||(tE={})),function(t){t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(eE||(eE={})),function(t){t.CONNECT_FAILED="connect failed",t.CONNECT_TIMEOUT="connect timeout",t.WS_DISCONNECTED="websocket disconnected",t.REQUEST_TIMEOUT="request timeout",t.REQUEST_FAILED="request failed",t.WAIT_STATUS_TIMEOUT="wait status timeout",t.WAIT_STATUS_ERROR="wait status error",t.BAD_STATE="bad state",t.WS_ABORT="ws abort",t.AP_REQUEST_TIMEOUT="AP request timeout",t.AP_JSON_PARSE_ERROR="AP json parse error",t.AP_REQUEST_ERROR="AP request error",t.AP_REQUEST_ABORT="AP request abort"}(iE||(iE={})),function(t){t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile"}(nE||(nE={})),function(t){t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(sE||(sE={})),function(t){t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(oE||(oE={})),function(t){t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(rE||(rE={})),function(t){t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low"}(aE||(aE={})),function(t){t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_FAILBACK="datachannel_failback",t.RESET_SIGNAL="reset-signal"}(cE||(cE={})),function(t){t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data"}(lE||(lE={})),function(t){t[t.websocket=0]="websocket",t[t.datachannel=1]="datachannel"}(dE||(dE={})),function(t){t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track"}(hE||(hE={})),function(t){t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream"}(uE||(uE={})),function(t){t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM"}(pE||(pE={})),function(t){t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM"}(mE||(mE={})),function(t){t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY"}(vE||(vE={})),function(t){t.TRANSCEIVER_UPDATED="transceiver-updated"}(gE||(gE={})),function(t){t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed"}(fE||(fE={})),function(t){t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(EE||(EE={})),function(t){t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS"}(_E||(_E={}));const TE=[_E.AFRICA,_E.ASIA,_E.CHINA,_E.EUROPE,_E.GLOBAL,_E.INDIA,_E.JAPAN,_E.NORTH_AMERICA,_E.OCEANIA,_E.OVERSEA,_E.SOUTH_AMERICA];let yE;!function(t){t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL"}(yE||(yE={}));const wE={CHINA:{},ASIA:{CODE:yE.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:yE.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:yE.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:yE.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","\tuap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:yE.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:yE.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:yE.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:yE.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:yE.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:yE.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:yE.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:yE.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:yE.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};let CE,RE,IE,AE,OE,NE,kE,LE,PE,DE,ME,xE,UE,VE,BE,jE,FE,HE,GE,$E,WE,zE;kv&&(wE.CHINA={CODE:yE.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(t){t.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(CE||(CE={}));class KE extends gv{constructor(t,e){super(),vp(this,"onICEConnectionStateChange",void 0),vp(this,"onConnectionStateChange",void 0),vp(this,"onDTLSTransportStateChange",void 0),vp(this,"onDTLSTransportError",void 0),vp(this,"onICETransportStateChange",void 0),vp(this,"onFirstAudioReceived",void 0),vp(this,"onFirstVideoReceived",void 0),vp(this,"onFirstAudioDecoded",void 0),vp(this,"onFirstVideoDecoded",void 0),vp(this,"onFirstVideoDecodedTimeout",void 0),vp(this,"onSelectedLocalCandidateChanged",void 0),vp(this,"onSelectedRemoteCandidateChanged",void 0),vp(this,"establishPromise",void 0)}}!function(t){t.SEND="sendonly",t.RECV="recvonly",t.SENDRECV="sendrecv",t.INACTIVE="inactive"}(RE||(RE={})),function(t){t.VIDEO="video",t.AUDIO="audio"}(IE||(IE={})),function(t){t[t.UDP=0]="UDP",t[t.TCP=1]="TCP",t[t.RELAY=2]="RELAY"}(AE||(AE={})),function(t){t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.TCP_RESTART=1]="TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(OE||(OE={})),function(t){t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack"}(NE||(NE={})),function(t){t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected"}(kE||(kE={})),function(t){t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState"}(LE||(LE={})),function(t){t.ONLINE="ONLINE",t.OFFLINE="OFFLINE"}(PE||(PE={})),function(t){t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE"}(DE||(DE={})),function(t){t.ON_TRACK="on_track",t.ON_NODE="on_node"}(ME||(ME={})),function(t){t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints"}(xE||(xE={})),function(t){t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED"}(UE||(UE={})),function(t){t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED"}(VE||(VE={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(BE||(BE={})),function(t){t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK"}(jE||(jE={})),function(t){t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback"}(FE||(FE={})),function(t){t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.SECURITY_POLICY_VIOLATION="security-policy-violation"}(HE||(HE={})),function(t){t[t.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",t[t.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",t[t.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",t[t.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",t[t.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",t[t.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",t[t.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",t[t.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",t[t.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",t[t.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",t[t.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",t[t.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",t[t.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",t[t.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",t[t.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",t[t.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",t[t.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",t[t.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",t[t.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",t[t.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(GE||(GE={})),function(t){t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED"}($E||($E={})),function(t){t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(WE||(WE={})),function(t){t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED"}(zE||(zE={}));const qE={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1};function YE(){return qE}let JE;!function(t){t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"}(JE||(JE={}));var XE=D,QE=Array.isArray||function(t){return"Array"==XE(t)},ZE=u,t_=QE,e_=rc,i_=K,n_=se("species"),s_=ZE.Array,o_=function(t){var e;return t_(t)&&(e=t.constructor,(e_(e)&&(e===s_||t_(e.prototype))||i_(e)&&null===(e=e[n_]))&&(e=void 0)),void 0===e?s_:e},r_=function(t,e){return new(o_(t))(0===e?0:e)},a_=Ge,c_=j,l_=Bt,d_=Oi,h_=r_,u_=l([].push),p_=function(t){var e=1==t,i=2==t,n=3==t,s=4==t,o=6==t,r=7==t,a=5==t||o;return function(c,l,d,h){for(var u,p,m=l_(c),v=c_(m),g=a_(l,d),f=d_(v),E=0,_=h||h_,S=e?_(c,f):i||r?_(c,0):void 0;f>E;E++)if((a||E in v)&&(p=g(u=v[E],E,m),t))if(e)S[E]=p;else if(p)switch(t){case 3:return!0;case 5:return u;case 6:return E;case 2:u_(S,u)}else switch(t){case 4:return!1;case 7:u_(S,u)}return o?-1:n||s?s:S}},m_={forEach:p_(0),map:p_(1),filter:p_(2),some:p_(3),every:p_(4),find:p_(5),findIndex:p_(6),filterReject:p_(7)},v_=m_.forEach,g_=Bi("forEach")?[].forEach:function(t){return v_(this,t,arguments.length>1?arguments[1]:void 0)};Ti({target:"Array",proto:!0,forced:[].forEach!=g_},{forEach:g_});var f_=Wi("Array").forEach,E_=Zs,__=Ht,S_=d,b_=f_,T_=Array.prototype,y_={DOMTokenList:!0,NodeList:!0},w_=function(t){var e=t.forEach;return t===T_||S_(T_,t)&&e===T_.forEach||__(y_,E_(t))?b_:e},C_=Bt,R_=ps;Ti({target:"Object",stat:!0,forced:i((function(){R_(1)}))},{keys:function(t){return R_(C_(t))}});var I_=q.Object.keys,A_=Ji,O_=Ti,N_=QE,k_=l([].reverse),L_=[1,2];O_({target:"Array",proto:!0,forced:String(L_)===String(L_.reverse())},{reverse:function(){return N_(this)&&(this.length=this.length),k_(this)}});var P_=Wi("Array").reverse,D_=d,M_=P_,x_=Array.prototype,U_=function(t){var e=t.reverse;return t===x_||D_(x_,t)&&e===x_.reverse?M_:e},V_=i,B_=at,j_=se("species"),F_=function(t){return B_>=51||!V_((function(){var e=[];return(e.constructor={})[j_]=function(){return{foo:1}},1!==e[t](Boolean).foo}))},H_=Ti,G_=u,$_=QE,W_=rc,z_=K,K_=Un,q_=Oi,Y_=W,J_=ng,X_=se,Q_=mc,Z_=F_("slice"),tS=X_("species"),eS=G_.Array,iS=Math.max;H_({target:"Array",proto:!0,forced:!Z_},{slice:function(t,e){var i,n,s,o=Y_(this),r=q_(o),a=K_(t,r),c=K_(void 0===e?r:e,r);if($_(o)&&(i=o.constructor,(W_(i)&&(i===eS||$_(i.prototype))||z_(i)&&null===(i=i[tS]))&&(i=void 0),i===eS||void 0===i))return Q_(o,a,c);for(n=new(void 0===i?eS:i)(iS(c-a,0)),s=0;a<c;a++,s++)a in o&&J_(n,s,o[a]);return n.length=s,n}});var nS=Wi("Array").slice,sS=d,oS=nS,rS=Array.prototype,aS=function(t){var e=t.slice;return t===rS||sS(rS,t)&&e===rS.slice?oS:e};function cS(t,e,i,n,s){var o,r,a,c={};return w_(o=I_(n)).call(o,(function(t){c[t]=n[t]})),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=A_(r=U_(a=aS(i).call(i)).call(a)).call(r,(function(i,n){return n(t,e,i)||i}),c),s&&void 0!==c.initializer&&(c.value=c.initializer?c.initializer.call(s):void 0,c.initializer=void 0),void 0===c.initializer&&(mp(t,e,c),c=null),c}var lS=Wi("Array").keys,dS=Zs,hS=Ht,uS=d,pS=lS,mS=Array.prototype,vS={DOMTokenList:!0,NodeList:!0},gS=function(t){var e=t.keys;return t===mS||uS(mS,t)&&e===mS.keys||hS(vS,dS(t))?pS:e};function fS(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function ES(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?fS(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):fS(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let _S=0,SS=0;function bS(t,e,i,n){return new _h(((s,o)=>{e.timeout=e.timeout||Gv("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),_S+=JT(e.data)):i&&(e.data.size?_S+=e.data.size:e.data instanceof FormData?_S+=function(t){let e=0;return/DingTalk/i.test(navigator.userAgent)&&t.realFormData&&(t=t.realFormData),t.forEach((t=>{e+="string"==typeof t?JT(t):t.size})),e+138}(e.data):_S+=JT(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,mv.request(e).then((t=>{"string"==typeof t.data?SS+=JT(t.data):t.data instanceof ArrayBuffer||t.data instanceof Uint8Array?SS+=t.data.byteLength:SS+=JT(JSON.stringify(t.data)),n&&s({data:t.data,headers:t.headers}),s(t.data)})).catch((t=>{mv.isCancel(t)?o(new _v(Ev.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===t.code?o(new _v(Ev.NETWORK_TIMEOUT,t.message)):t.response?o(new _v(Ev.NETWORK_RESPONSE_ERROR,t.response.status)):o(new _v(Ev.NETWORK_ERROR,t.message))}))}))}async function TS(t,e){const i=new Blob([e.data],{type:"buffer"});return await bS(t,ES(ES({},e),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const yS=new class extends gv{set networkState(t){Av.info("[".concat(this._moduleName,"]")+"network state changed, "+this._networkState+" -> "+t),this.emit(DE.NETWORK_STATE_CHANGE,t,this._networkState),t===PE.ONLINE?this.emit(DE.ONLINE):t===PE.OFFLINE&&(this.onlineWaiter=new _h((t=>{this.once(DE.ONLINE,(()=>{this.onlineWaiter=void 0,t(PE.ONLINE)}))})),this.emit(DE.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}constructor(){super(),vp(this,"_moduleName","network-indicator"),vp(this,"_networkState",PE.ONLINE),vp(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=PE.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=PE.OFFLINE}))}};let wS=!1;const CS=new class extends gv{constructor(){super(...arguments),vp(this,"onAutoplayFailed",void 0),vp(this,"onAudioAutoplayFailed",void 0)}};function RS(){if(Vu(),!wS){const t=e=>{e.preventDefault(),wS=!1,ap()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};wS=!0,ap()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),Av.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),CS.onAutoplayFailed?CS.onAutoplayFailed():CS.onAudioAutoplayFailed?Av.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):Av.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),CS.emit("autoplay-failed")}}function IS(t){return(new TextEncoder).encode(t)}const AS=function(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i},OS=async t=>function(t,e){let i="";return new Uint8Array(t).forEach((t=>{i+=t.toString(e).padStart(2,"0")})),i}(await crypto.subtle.digest("SHA-256",IS(t)),16);function NS(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function kS(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?NS(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):NS(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function LS(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(e,i,n){const s=n.value;if("function"==typeof s){const o=t.className||e.__className__||("AgoraRTCClient"===e.constructor.name?"Client":e.constructor.name);n.value=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];let a=n;if(t.argsMap)try{a=t.argsMap(this,...n)}catch(t){Av.warning(t),a=[]}try{JSON.stringify(a)}catch(t){Av.warning("arguments for method ".concat(o,".").concat(String(i)," not serializable for apiInvoke.")),a=[]}const c=(t.report||PS).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(i)),options:a,tag:gf.TRACER,reportResult:t.reportResult},t.throttleTime);try{const e=s.apply(this,n);return e instanceof _h?e.then((e=>(c.onSuccess(t.reportResult&&e),e))).catch((t=>{throw c.onError(t),t})):(c.onSuccess(t.reportResult&&e),e)}catch(t){throw c.onError(t),t}}}return n}}const PS=new class{constructor(){vp(this,"baseInfoMap",new Map),vp(this,"proxyServer",void 0),vp(this,"clientList",Xv),vp(this,"eventUploadTimer",void 0),vp(this,"setSessionIdTimer",void 0),vp(this,"url",void 0),vp(this,"backupUrl",void 0),vp(this,"_appId",void 0),vp(this,"keyEventUploadPendingItems",[]),vp(this,"normalEventUploadPendingItems",[]),vp(this,"apiInvokeUploadPendingItems",[]),vp(this,"apiInvokeCount",0),vp(this,"ltsList",[]),vp(this,"lastSendNormalEventTime",Date.now()),vp(this,"customReportCounterTimer",void 0),vp(this,"customReportCount",0),vp(this,"extApiInvoke",(async t=>{for(const e of t){const t=kS(kS({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:gf.TRACER});this.sendApiInvoke(t)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),Gv("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),Gv("EVENT_REPORT_SEND_INTERVAL"))}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void Av.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const e=this.baseInfoMap.get(t),i=Date.now(),n=e.startTime;e.startTime=i,Av.debug("rewrite session ".concat(t," startTime: ").concat(i," , ").concat(i-n,"ms")),this.baseInfoMap.set(t,e)}setAppId(t){this._appId=t}reportApiInvoke(t,e,i){e.timeout=e.timeout||6e4,e.reportResult=void 0===e.reportResult||e.reportResult;const n=Date.now();this.apiInvokeCount+=1;const s=this.apiInvokeCount,o=()=>({tag:e.tag,invokeId:s,sid:t,name:e.name,apiInvokeTime:n,options:e.options,states:e.states||null}),r=!!Gv("SHOW_REPORT_INVOKER_LOG");r&&Av.info("".concat(e.name," start"),e.options);let a=!1;XT(e.timeout).then((()=>{a||(this.sendApiInvoke(kS(kS({},o()),{},{error:Ev.API_INVOKE_TIMEOUT,success:!1})),Av.debug("".concat(e.name," timeout")))}));const c=new _v(Ev.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:t=>{const n=()=>{if(a)throw c;return a=!0,this.sendApiInvoke(kS(kS({},o()),{},{success:!0},e.reportResult&&{result:t})),r&&Av.info("".concat(e.name," onSuccess")),t};return i?fy(n,e.name+"Success",i,(()=>a=!0)):n()},onError:t=>{const n=()=>{if(a)throw t;a=!0,this.sendApiInvoke(kS(kS({},o()),{},{success:!1,error:t})),r&&Av.info("".concat(e.name," onFailure"),t.toString())};return i?fy(n,e.name+"Error",i,(()=>a=!0)):n()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const i=Date.now(),n=this.createBaseInfo(t,i);n.cname=e.cname;const s=Object.assign({},{willUploadConsoleLog:Gv("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:kv?"global":"oversea",areas:Gv("AREAS")&&Gv("AREAS").join(",")},e.extend),o=Date.now(),r=kS(kS({},n),{},{eventType:hf.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,build:Ov,lts:o,elapse:o-i,extend:JSON.stringify(s),mode:e.mode,process:Gv("PROCESS_ID"),appType:Gv("APP_TYPE"),success:!0,version:Nv});this.send({type:uf.SESSION,data:r},!0)}joinChooseServer(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS({},n),{},{eventType:hf.JOIN_CHOOSE_SERVER,lts:s,eventElapse:s-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:s-i.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3});this.send({type:uf.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS({},n),{},{eventType:hf.REQ_USER_ACCOUNT,lts:s,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:s-i.startTime,eventElapse:s-e.lts,extend:JSON.stringify(e.extend)});this.send({type:uf.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info;e.vid&&(n.vid=e.vid),n.uid=e.uid,n.cid=e.cid;const s=Date.now(),{firstSuccess:o,avoidJoinStartTime:r,isProxy:a,addr:c}=e,l=s-(o&&r?r:i.startTime),d=kS(kS({},n),{},{eventType:hf.JOIN_GATEWAY,lts:s,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,elapse:l,eventElapse:s-e.lts,firstSuccess:o,signalChannel:e.signalChannel}),h=d.success?1:0;if(e.succ&&(i.lastJoinSuccessTime=s),o)this.send({type:uf.JOIN_GATEWAY,data:d},!0);else{let t;if(c)if(a){const e=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),i=c.match(/p=[0-9]{1,6}/g);t={isSuccess:h,gatewayIp:e&&e.length?e[0].split("=")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split("=")[1]:"",isProxy:a?1:0}}else{const e=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),i=c.match(/:[0-9]{1,6}/g);t={isSuccess:h,gatewayIp:e&&e.length?e[0].split("//")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split(":")[1]:"",isProxy:a?1:0}}else t={isSuccess:h,gatewayIp:"",port:"",isProxy:a?1:0};delete d.success,delete d.eventType,delete d.firstSuccess,d.vid=Number(d.vid);const e=Object.assign({},d,t,{eventType:hf.REJOIN_GATEWAY});this.send({type:uf.RE_JOIN_GATEWAY,data:e},!0)}}joinChannelTimeout(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=Date.now(),s=kS(kS({},i.info),{},{lts:n,timeout:e,elapse:n-i.startTime});this.send({type:uf.JOIN_CHANNEL_TIMEOUT,data:s},!0)}publish(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS({},n),{},{eventType:hf.PUBLISH,lts:s,eventElapse:e.eventElapse,elapse:s-i.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:uf.PUBLISH,data:o},!0)}subscribe(t,e,i){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,o=Date.now(),r=kS(kS({},s),{},{eventType:hf.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-n.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof e.peerid?r.peerSuid=e.peerid:r.peer=e.peerid,this.send({type:uf.SUBSCRIBE,data:r},!0)}wsCompressorInit(t){var e;const i=[...gS(e=this.baseInfoMap).call(e)],n=i.length?i[0]:"UnableToGetSid",s=this.baseInfoMap.get(n);if(!s)return;const o=s.info,r=Date.now(),a=kS(kS({},o),{},{eventType:hf.WS_COMPRESSOR_INIT,lts:r,eventElapse:t.eventElapse,elapse:r-s.startTime,status:t.status?1:2});this.send({type:uf.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(t,e,i,n){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),a=kS(kS(kS({},o),n),{},{elapse:r-s.startTime,eventType:e,lts:r,firstDecodeFrame:Math.max(r-s.startTime,0),apEnd:Math.max(n.apEnd-s.startTime,0),apStart:Math.max(n.apStart-s.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-s.startTime,0),joinGwStart:Math.max(n.joinGwStart-s.startTime,0),pcEnd:Math.max(n.pcEnd-s.startTime,0),pcStart:Math.max(n.pcStart-s.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-s.startTime,0),subscriberStart:Math.max(n.subscriberStart-s.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-s.startTime,0)});this.send({type:i,data:a},!0)}firstRemoteFrame(t,e,i,n){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),a=kS(kS(kS({},o),n),{},{elapse:r-s.startTime,eventType:e,lts:r});this.send({type:i,data:a},!0)}pcStats(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS(kS({},n),e),{},{vid:void 0===n.vid?0:Number(n.vid),elapse:s-i.startTime,eventType:hf.PC_STATS,lts:s});this.send({type:uf.PC_STATS,data:o},!0)}onGatewayStream(t,e,i,n){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),a=kS(kS(kS({},o),n),{},{eventType:e,lts:r});this.send({type:i,data:a},!0)}streamSwitch(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS({},n),{},{eventType:hf.STREAM_SWITCH,lts:s,isDual:e.isdual,elapse:s-i.startTime,success:e.succ});this.send({type:uf.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS({},n),{},{eventType:hf.REQUEST_PROXY_APPCENTER,lts:s,eventElapse:s-e.lts,elapse:s-i.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:uf.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS({},n),{},{eventType:hf.REQUEST_PROXY_WORKER_MANAGER,lts:s,eventElapse:s-e.lts,elapse:s-i.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:uf.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?Av.debug("reportProxyServerurl: ".concat(t)):Av.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS({},n),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:s,elapse:s-i.startTime,joinChannelSuccessElapse:s-(i.lastJoinSuccessTime||s),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:uf.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now();(function(t,e,i){const n=t[e];if(!n||"string"!=typeof n)return[t];t[e]="";const s=JT(JSON.stringify(t));let o=0;const r=[];let a=0;for(let c=0;c<n.length;c++)a+=n.charCodeAt(c)<=127?1:3,a<=i-s||(r[r.length]=YT(YT({},t),{},{[e]:n.substring(o,c)}),o=c,a=n.charCodeAt(c)<=127?1:3);return o!==n.length-1&&(r[r.length]=YT(YT({},t),{},{[e]:n.substring(o)})),r})(kS(kS(kS({},n),e),{},{elapse:s-i.startTime,lts:s,productType:"WebRTC"}),"payload",1300).forEach((t=>this.send({type:uf.WORKER_EVENT,data:t},!0)))}apworkerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS(kS({},n),e),{},{elapse:s-i.startTime,lts:s});this.send({type:uf.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS(kS({},n),e),{},{elapse:s-i.startTime,lts:s,extend:e.extend||void 0});this.send({type:uf.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,s=Date.now(),o=kS(kS(kS({},n),e),{},{elapse:s-i.startTime,lts:s});this.send({type:uf.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>Gv("CUSTOM_REPORT_LIMIT"))throw new _v(Ev.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const i=Date.now(),n=e.map((e=>({type:uf.USER_ANALYTICS,data:kS(kS({sid:t},e),{},{lts:i})})));try{Gv("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(t){throw Av.error("send custom report message failed",t.toString()),new _v(Ev.CUSTOM_REPORT_SEND_FAILED,t.message)}}autoplayFailed(t,e,i,n){if(!t)return;const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,r=Date.now(),a=kS(kS({},o),{},{vid:void 0===o.vid?0:Number(o.vid),lts:r,elapse:r-s.startTime,cbRegistered:CS.onAutoplayFailed||CS.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:e,trackId:n,extend:void 0});this.send({type:uf.AUTOPLAY_FAILED,data:a},!0)}sendApiInvoke(t){const e=Gv("NOT_REPORT_EVENT");if(t.tag&&e.includes&&e.includes(t.tag))return!1;if(null===t.sid)return this.apiInvokeUploadPendingItems.push(t),!1;const i=this.baseInfoMap.get(t.sid);if(!i)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:n,uid:s,cid:o}=i.info;let r;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof _v){const{code:e,message:i}=t.error;r=e||i||t.error.toString()}else r=t.error.toString();const a={invokeId:t.invokeId,sid:t.sid,cname:n,cid:o,uid:s,lts:t.lts,success:t.success,elapse:t.lts-i.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?r:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:uf.API_INVOKE,data:a},!1),!0}appendSessionId(){this.clientList.forEach((t=>{if(t._sessionId){const e=this.apiInvokeUploadPendingItems.length;for(let i=0;i<e;i++){const e=this.apiInvokeUploadPendingItems.shift();e&&(e.sid=t._sessionId,this.sendApiInvoke(Object.assign({},e)))}}}))}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>Gv("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const i=[],n=[];for(;t.length;){const e=t.shift();i.length<20?i.push(e):n.push(e)}t.push(...n);for(const t of[...i]){var s;-1!==this.ltsList.indexOf(t.data.lts)?(t.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(t.data.lts)):(this.ltsList.push(t.data.lts),Wg(s=this.ltsList).call(s,((t,e)=>t-e)))}return e||(this.lastSendNormalEventTime=Date.now()),Gv("ENABLE_EVENT_REPORT")?(i.length&&(Gv("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((t=>i=>{Gv("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(t):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(t),this.normalEventUploadPendingItems.length>Gv("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-Gv("NORMAL_EVENT_QUEUE_CAPACITY")),Av.warning("report: drop normal events"))))})(i)),t):t}async postDataToStatsCollector2(t){yS.networkState===PE.OFFLINE&&await _h.race([yS.onlineWaiter,XT(2*Sv.maxRetryTimeout)]);const e=t=>{let e=new Uint8Array;return t.forEach((t=>{const i=IS(JSON.stringify(t.data)),n=new ArrayBuffer(5),s=(t=>{let e=0;return Object.entries(uf).forEach((i=>{let[n,s]=i;s===t.type&&(e=mf[n])})),e})(t),o=new DataView(n);o.setUint16(0,i.byteLength,!0),o.setUint8(2,255&s),o.setUint8(3,s>>>8&255),o.setUint8(4,s>>>16&255),e=AS(e,new Uint8Array(n)),e=AS(e,i)})),e},i="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Gv("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(Gv("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let s=0;s<2;s+=1){1===s&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Gv("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(Gv("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await bS(n,{timeout:1e4,data:e(t),headers:kS(kS({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(t){if(1===s)throw t;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map((t=>JSON.stringify(t))),vid:(t=>{const e=t&&t.data.sid&&this.baseInfoMap.get(t.data.sid);return e&&e.info.vid&&+e.info.vid||0})(t[0])};yS.networkState===PE.OFFLINE&&await _h.race([yS.onlineWaiter,XT(2*Sv.maxRetryTimeout)]);const n=e?"/events/proto-raws":"/events/messages";let s=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Gv("EVENT_REPORT_DOMAIN"),"&p=").concat(Gv("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(Gv("EVENT_REPORT_DOMAIN"),":").concat(Gv("STATS_COLLECTOR_PORT")).concat(n));for(let t=0;t<2;t+=1){1===t&&(s=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Gv("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(Gv("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(Gv("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(Gv("STATS_COLLECTOR_PORT")).concat(n)));try{e?await TS(s,{timeout:1e4,data:i}):await bS(s,{timeout:1e4,data:i})}catch(e){if(1===t)throw e;continue}return}}createBaseInfo(t,e){const i=Object.assign({},df);return i.sid=t,this.baseInfoMap.set(t,{info:i,startTime:e}),i}reportResourceTiming(t,e){const i=performance.getEntriesByName(t),n=i[i.length-1];n&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:n,tag:gf.TRACER}).onSuccess()}};fv.on("REPORT_LOG_UPLOAD",(t=>{t.networkState=yS.networkState,PS.reportApiInvoke(null,{name:"logUploadError",options:t,tag:gf.TRACER})}));class DS extends gv{constructor(t,e){super(),vp(this,"trackMediaType",void 0),vp(this,"_ID",void 0),vp(this,"_rtpTransceiver",void 0),vp(this,"_lowRtpTransceiver",void 0),vp(this,"_hints",[]),vp(this,"_isClosed",!1),vp(this,"_originMediaStreamTrack",void 0),vp(this,"_mediaStreamTrack",void 0),vp(this,"_external",{}),this._ID=e||ZT(8,"track-"),this._originMediaStreamTrack=t,this._mediaStreamTrack=t,function(t){Qv.includes(t)||Qv.push(t)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){if(!t){const t=PS.reportApiInvoke(null,{name:vf.GET_MEDIA_STREAM_TRACK,options:[],tag:gf.TRACER});this._mediaStreamTrack&&"string"==typeof this._mediaStreamTrack.label?t.onSuccess(this._mediaStreamTrack.label):t.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===pE.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){const e=Qv.indexOf(t);-1!==e&&Qv.splice(e,1)}(this),this.emit(fE.CLOSED)}_updateRtpTransceiver(t,e){if(e===pE.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(gE.TRANSCEIVER_UPDATED,t,e)}}let MS,xS=1;class US{constructor(t){vp(this,"lockingPromise",_h.resolve()),vp(this,"locks",0),vp(this,"name",""),vp(this,"lockId",void 0),this.lockId=xS++,t&&(this.name=t),Av.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,Av.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat("string"==typeof t?t:""));const i=new _h((i=>{e=()=>{this.locks-=1,Av.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat("string"==typeof t?t:"")),i()}})),n=this.lockingPromise.then((()=>e));return this.lockingPromise=this.lockingPromise.then((()=>i)),n}}function VS(t,e){return function(i,n,s){const o=s.value;if("function"!=typeof o)throw new Error("Cannot use mutex on object property.");return s.value=async function(){const i=this[e];if(!i)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const s=await i.lock("From ".concat(t,".").concat(n));try{for(var r=arguments.length,a=new Array(r),c=0;c<r;c++)a[c]=arguments[c];return await o.apply(this,a)}finally{s()}},s}}class BS extends DS{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}constructor(t,e){super(t,e),vp(this,"_enabled",!0),vp(this,"_muted",!1),vp(this,"_isExternalTrack",!1),vp(this,"_isClosed",!1),vp(this,"_enabledMutex",void 0),vp(this,"processor",void 0),vp(this,"_processorContext",void 0),vp(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new US("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,e;return null!==(t=null===(e=this._originMediaStreamTrack)||void 0===e?void 0:e.label)&&void 0!==t?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,Av.debug("[".concat(this.getTrackId(),"] close")),this.emit(hE.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=i,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop(),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await oy(this,hE.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){Av.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fE.TRACK_ENDED)}stateCheck(t,e){if(Av.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(e,"]")),zg(e,t),this._enabled&&this._muted&&"enabled"===t&&!1===e)throw new _v(Ev.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print();if(!this._enabled&&!this._muted&&"muted"===t&&!0===e)throw new _v(Ev.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function jS(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}!function(t){t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change"}(MS||(MS={}));const FS=window.AudioContext||window.webkitAudioContext;let HS=null;const GS=new class extends gv{constructor(){super(...arguments),vp(this,"prevState",void 0),vp(this,"curState",void 0),vp(this,"currentTime",void 0),vp(this,"currentTimeStuckAt",void 0),vp(this,"interruptDetectorTrack",void 0),vp(this,"onLocalAudioTrackMute",(()=>{Av.info("ios15-interruption-start"),this.emit(MS.IOS_15_16_INTERRUPTION_START)})),vp(this,"onLocalAudioTrackUnmute",(async()=>{Av.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?Av.info("ios15-interruption-end-canceled"):(HS&&await HS.suspend(),this.emit(MS.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(t){Av.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){Av.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function $S(){if(!FS)return void Av.error("your browser is not support web audio");Av.info("create audio context");const t=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?jS(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):jS(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},Gv("WEBAUDIO_INIT_OPTIONS"));Av.debug("audio context init option:",JSON.stringify(t)),HS=new FS(t),GS.curState=HS.state,HS.onstatechange=()=>{GS.prevState=GS.curState,GS.curState=HS?HS.state:void 0;const{prevState:t,curState:e}=GS,i="running"===e,n="interrupted"===e,s="running"===t,o="suspended"===t,r="interrupted"===t,a=Vu().osVersion;(Ku()||ip())&&s&&n&&(Av.info("ios".concat(a,"-interruption-start")),GS.emit(MS.IOS_INTERRUPTION_START)),(Ku()||ip())&&(o||r)&&i&&(Av.info("ios".concat(a,"-interruption-end")),GS.emit(MS.IOS_INTERRUPTION_END)),t!==e&&(Av.debug("AudioContext State Change","".concat(t,"=>").concat(e)),GS.emit(MS.STATE_CHANGE))},setInterval((()=>{var t;const e=null===(t=HS)||void 0===t?void 0:t.currentTime;GS.currentTime!==e?(GS.currentTimeStuckAt&&(Av.debug("AudioContext current time resume at ".concat(e)),GS.currentTimeStuckAt=void 0),GS.currentTime=e):(e!==GS.currentTimeStuckAt&&(PS.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:e},tag:gf.TRACER}).onSuccess(),Av.warning("AudioContext current time stuck at ".concat(e))),GS.currentTimeStuckAt=e)}),5e3),async function(t){const e=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,n=!1,s=!1,o=!1;function r(e){"running"===t.state?a(!1):Ku()||ip()?"suspended"===t.state&&(a(!0),e&&t.resume().then(l,l)):"closed"!==t.state&&(a(!0),e&&t.resume().then(l,l))}function a(t){if(n!==t){n=t;for(let i=0,n=e;i<n.length;i+=1){const e=n[i];t?window.addEventListener(e,d,{capture:!0,passive:!0}):window.removeEventListener(e,d,{capture:!0,passive:!0})}}}function c(){r(!0)}function l(){r(!1)}function d(){r(!0)}function h(t){if(!o)if(i.paused)if(t){let e;u(!1),o=!0;try{e=i.play(),e?e.then(p,p):(i.addEventListener("playing",p),i.addEventListener("abort",p),i.addEventListener("error",p))}catch(t){p()}}else u(!0);else u(!1)}function u(t){if(s!==t){s=t;for(let i=0,n=e;i<n.length;i++){const e=n[i];t?window.addEventListener(e,m,{capture:!0,passive:!0}):window.removeEventListener(e,m,{capture:!0,passive:!0})}}}function p(){i.removeEventListener("playing",p),i.removeEventListener("abort",p),i.removeEventListener("error",p),o=!1,h(!1)}function m(){h(!0)}if(Ku()){const e=t.createMediaStreamDestination(),n=document.createElement("div");n.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=n.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=e.stream,h(!0)}GS.on(MS.STATE_CHANGE,c),r(!1)}(HS)}function WS(){if(!HS){if($S(),!HS)throw new _v(Ev.NOT_SUPPORTED,"can not create audio context");return HS}return HS}function zS(){return!!HS}function KS(t){if(function(){if(null!==qS)return qS;const t=WS(),e=t.createBufferSource(),i=t.createGain(),n=t.createGain();e.connect(i),e.connect(n),e.disconnect(i);let s=!1;try{e.disconnect(i)}catch(t){s=!0}return e.disconnect(),qS=s,s}())return;const e=t.connect,i=t.disconnect;t.connect=(i,n,s)=>(t._inputNodes||(t._inputNodes=[]),t._inputNodes.includes(i)||(i instanceof AudioNode?(t._inputNodes.push(i),e.call(t,i,n,s)):e.call(t,i,n)),t),t.disconnect=(n,s,o)=>{i.call(t),n?cy(t._inputNodes,n):t._inputNodes=[];for(const i of t._inputNodes)e.call(t,i)}}let qS=null;function YS(t,e){let i=!1;const n=1/e;if(Gv("DISABLE_WEBAUDIO")){const e=window.setInterval((()=>{i?window.clearInterval(e):t(performance.now()/1e3)}),1e3*n)}else{const e=WS();let s=e.createGain();s.gain.value=0,s.connect(e.destination);const o=()=>{if(i)return void(s=null);const r=e.createOscillator();r.onended=o,r.connect(s),r.start(0),r.stop(e.currentTime+n),t(e.currentTime)};o()}return()=>{i=!0}}class JS{constructor(){vp(this,"context",void 0),vp(this,"analyserNode",void 0),vp(this,"sourceNode",void 0),this.context=WS(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(t){}this.sourceNode=t,null==t||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode)return 0;if(!this.context||Ku()||ip()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode)return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);for(let i=0;i<t.length;++i)t[i]=e[i]/128-1}const e=Xi(t).call(t,((t,e)=>t+e*e),0)/t.length;return Math.max(10*Math.log10(e)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,e;null===(t=this.sourceNode)||void 0===t||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(e=this.sourceNode)||void 0===e||e.connect(this.analyserNode)}catch(t){Av.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class XS extends gv{get processSourceNode(){return this.sourceNode}set processedNode(t){var e;if(!this.isDestroyed&&this._processedNode!==t){try{var i;null===(i=this.sourceNode)||void 0===i||i.disconnect(this.outputNode)}catch(t){}null===(e=this._processedNode)||void 0===e||e.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),vp(this,"outputNode",void 0),vp(this,"outputTrack",void 0),vp(this,"isPlayed",!1),vp(this,"sourceNode",void 0),vp(this,"context",void 0),vp(this,"audioBufferNode",void 0),vp(this,"destNode",void 0),vp(this,"audioOutputLevel",0),vp(this,"volumeLevelAnalyser",void 0),vp(this,"_processedNode",void 0),vp(this,"playNode",void 0),vp(this,"isDestroyed",!1),vp(this,"onNoAudioInput",void 0),vp(this,"isNoAudioInput",!1),vp(this,"_noAudioInputCount",0),this.context=WS(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),KS(this.outputNode),this.volumeLevelAnalyser=new JS}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=t=>{this.emit(Df.ON_AUDIO_BUFFER,function(t){for(let e=0;e<t.outputBuffer.numberOfChannels;e+=1){const i=t.outputBuffer.getChannelData(e);for(let t=0;t<i.length;t+=1)i[t]=0}return t.inputBuffer}(t))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!YE().webAudioMediaStreamDest)throw new _v(Ev.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){"running"!==this.context.state&&dy((()=>{GS.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(t){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Ku()||ip()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();const e=this.volumeLevelAnalyser.getAnalyserNode();let i;e.getFloatTimeDomainData?(i=new Float32Array(e.fftSize),e.getFloatTimeDomainData(i)):(i=new Uint8Array(e.fftSize),e.getByteTimeDomainData(i));let n=!1;for(let t=0;t<i.length;t++)0!==i[t]&&(n=!0);return n?(this.isNoAudioInput=!1,!0):(await XT(200),await this.checkHasAudioInput(t?t+1:1)&&n)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,e;null===(t=this.processedNode)||void 0===t||t.disconnect(),null===(e=this.sourceNode)||void 0===e||e.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?null===(t=this.processedNode)||void 0===t||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class QS extends XS{get isFreeze(){return!1}constructor(t,e,i){var n;if(super(),vp(this,"sourceNode",void 0),vp(this,"track",void 0),vp(this,"clonedTrack",void 0),vp(this,"audioElement",void 0),vp(this,"isCurrentTrackCloned",!1),vp(this,"isRemoteTrack",!1),vp(this,"originVolumeLevelAnalyser",void 0),vp(this,"rebuildWebAudio",(async()=>{if(Av.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void Av.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>Av.info("resume success"))),Av.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const t=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?t.stop():this.isCurrentTrackCloned=!0;const e=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(e),KS(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const i=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(i,this.context.currentTime),KS(this.outputNode),this.emit(Df.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=e,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),"audio"!==t.kind)throw new _v(Ev.UNEXPECTED_ERROR);this.track=t;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!e,this.sourceNode=this.context.createMediaStreamSource(s),KS(this.sourceNode),i){const t=i.clone();t.enabled=!0,this.clonedTrack=t,Av.debug("create an unmuted track ".concat(t.id," from the original track ").concat(i.id," to get the volume"));const e=this.context.createMediaStreamSource(new MediaStream([t]));KS(e),this.originVolumeLevelAnalyser=new JS,this.originVolumeLevelAnalyser.updateSource(e)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const o=Vu();e&&o.os===Nu.IOS&&Number(null===(n=o.osVersion)||void 0===n?void 0:n.split(".")[0])<15&&(GS.on(MS.STATE_CHANGE,(()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((t=>{t||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const e=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(e),KS(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Df.UPDATE_SOURCE),this.audioElement.srcObject=e}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),GS.off("state-change",this.rebuildWebAudio),null===(t=this.originVolumeLevelAnalyser)||void 0===t||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const e=t.clone();e.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=e),Av.debug("create an unmuted track ".concat(e.id," from the original track ").concat(t.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([e]));KS(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function ZS(t,e){const i=(t,e)=>t?"number"!=typeof t?t.max||t.exact||t.ideal||t.min||e:t:e,n={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:i(e.height,1080),maxWidth:i(e.width,1920)}}};return e.frameRate&&"number"!=typeof e.frameRate?(n.video.mandatory.maxFrameRate=e.frameRate.max,n.video.mandatory.minFrameRate=e.frameRate.min):"number"==typeof e.frameRate&&(n.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(n)}async function tb(t){const e=await eb(t.mediaSource),i=await function(t){return new _h(((e,i)=>{const n=document.createElement("div");n.innerText="share screen",n.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const s=document.createElement("div");s.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const o=document.createElement("div");o.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",o.setAttribute("style","height: 12%;");const r=document.createElement("div");r.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const a=document.createElement("div");a.setAttribute("style","text-align: right; padding: 16px 0;");const c=document.createElement("button");c.innerHTML="cancel",c.setAttribute("style","width: 85px;"),c.onclick=()=>{document.body.removeChild(l);const t=new Error("NotAllowedError");t.name="NotAllowedError",i(t)},a.appendChild(c),s.appendChild(o),s.appendChild(r),s.appendChild(a);const l=document.createElement("div");l.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),l.appendChild(n),l.appendChild(s),document.body.appendChild(l),t.map((t=>{if(t.id){const i=document.createElement("div");i.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let n=t.thumbnail;const{width:s}=n.getSize();s>1920&&(n=n.resize({width:1920})),i.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+n.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+t.name.replace(/[\u00A0-\u9999<>\&]/g,(function(t){return"&#"+t.charCodeAt(0)+";"}))+"</span>",i.onclick=()=>{document.body.removeChild(l),e(t.id)},r.appendChild(i)}}))}))}(e);return await ZS(i,t)}async function eb(t){let e=["window","screen"];"application"!==t&&"window"!==t||(e=["window"]),"screen"===t&&(e=["screen"]);const i=nb();if(!i)throw new _v(Ev.ELECTRON_IS_NULL);let n=null;try{var s;n=(null===(s=i.desktopCapturer)||void 0===s?void 0:s.getSources({types:e}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch(t){n=null}n&&n.then||(n=new _h(((t,n)=>{i.desktopCapturer.getSources({types:e},((e,i)=>{e?n(e):t(i)}))})));try{return await n}catch(t){throw new _v(Ev.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,t.toString())}}let ib=null;function nb(){if(ib)return ib;try{return ib=window.require("electron"),ib}catch(t){return null}}function sb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}const ob=new US("safari");let rb=!1,ab=!1;async function cb(t,e){let i=0,n=null;for(;i<2;)try{n=await lb(t,e,i>0);break}catch(t){if(t instanceof _v)throw Av.error("[".concat(e,"] ").concat(t.toString())),t;const n=db(t.name||t.code||t,t.message);if(n.code===Ev.MEDIA_OPTION_INVALID){Av.debug("[".concat(e,"] detect media option invalid, retry")),i+=1,await XT(500);continue}throw Av.error("[".concat(e,"] ").concat(n.toString())),n}if(!n)throw new _v(Ev.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function lb(t,e,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new _v(Ev.NOT_SUPPORTED,"can not find getUserMedia");i&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const n=YE(),s=new MediaStream;if(t.audioSource&&s.addTrack(t.audioSource),t.videoSource&&s.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return Av.debug("Using Video Source/ Audio Source"),s;if(t.screen)if(nb())t.screen.sourceId?hb(s,await ZS(t.screen.sourceId,t.screen)):hb(s,await tb(t.screen));else if($u()&&t.screen.extensionId&&t.screen.mandatory){if(!n.getStreamFromExtension)throw new _v(Ev.NOT_SUPPORTED,"This browser does not support screen sharing");Av.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const i=await(r=t.screen.extensionId,a=e,new _h(((t,e)=>{try{chrome.runtime.sendMessage(r,{getStream:!0},(i=>{if(!i||!i.streamId)return Av.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),i),void e(new _v(Ev.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));t(i.streamId)}))}catch(t){Av.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(r,")"),t.toString()),e(new _v(Ev.CHROME_PLUGIN_NOT_INSTALL))}})));t.screen.mandatory.chromeMediaSourceId=i,hb(s,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(n.getDisplayMedia){var o;t.screen.mediaSource&&bE(t.screen.mediaSource);const i={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:null!==(o=t.screen.displaySurface)&&void 0!==o?o:"screen"===t.screen.mediaSource?"monitor":t.screen.mediaSource},{selfBrowserSurface:n,surfaceSwitching:r,systemAudio:a}=t.screen,c={selfBrowserSurface:n,surfaceSwitching:r,systemAudio:a};!n&&delete c.selfBrowserSurface,!r&&delete c.surfaceSwitching,!a&&delete c.systemAudio,Av.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:i,audio:!!t.screenAudio,controls:c})),hb(s,await navigator.mediaDevices.getDisplayMedia(function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?sb(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):sb(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({video:i,audio:!!t.screenAudio},c)))}else{if(!zu())throw Av.error("[".concat(e,"] This browser does not support screenSharing")),new _v(Ev.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&bE(t.screen.mediaSource);const i={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};Av.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(i))),hb(s,await navigator.mediaDevices.getUserMedia(i))}}var r,a;if(!t.video&&!t.audio)return s;let c={video:t.video,audio:t.audio},l=Gv("MEDIA_DEVICE_CONSTRAINTS");if(l)try{"string"==typeof l&&(l=JSON.parse(l)),c=function t(e,i){if(!_y(e)||!_y(i))return i;if(Array.isArray(e)&&!Array.isArray(i)||!Array.isArray(e)&&Array.isArray(i))return i;if(Array.isArray(i)&&Array.isArray(e)){const n=[...e];for(let s=0;s<i.length;s++)n[s]=t(e[s],i[s]);return n}{const n=YT({},e);for(const s in i)Object.prototype.hasOwnProperty.call(i,s)&&(Object.prototype.hasOwnProperty.call(e,s)?n[s]=t(e[s],i[s]):n[s]=i[s]);return n}}(c,l)}catch(t){}Av.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Vu();let d,h=null;(Wu()||Ku()||Fu())&&(h=await ob.lock());try{d=await navigator.mediaDevices.getUserMedia(c)}catch(t){throw h&&h(),t}return c.audio&&(rb=!0),c.video&&(ab=!0),hb(s,d),h&&h(),s}function db(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new _v(Ev.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new _v(Ev.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new _v(Ev.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new _v(Ev.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new _v(Ev.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new _v(Ev.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return Av.error("getUserMedia unexpected error",t),new _v(Ev.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function hb(t,e){const i=t.getVideoTracks()[0],n=t.getAudioTracks()[0],s=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(n&&t.removeTrack(n),t.addTrack(o)),s&&(i&&t.removeTrack(i),t.addTrack(s))}const ub=new class extends gv{get state(){return this._state}set state(t){t!==this._state&&(this.emit(Ef.STATE_CHANGE,t),this._state=t)}constructor(){super(),vp(this,"_state",ff.IDLE),vp(this,"isAccessMicrophonePermission",!1),vp(this,"isAccessCameraPermission",!1),vp(this,"lastAccessMicrophonePermission",!1),vp(this,"lastAccessCameraPermission",!1),vp(this,"checkdeviceMatched",!1),vp(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(Gv("ENUMERATE_DEVICES_INTERVAL")||(rp()||Bu()===Nu.HARMONY_OS)&&op())&&this.updateDevicesInfo()}),Gv("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((t=>Av.error(t.toString())))}async enumerateDevices(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new _v(Ev.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const n=await navigator.mediaDevices.enumerateDevices(),s=this.checkMediaDeviceInfoIsOk(n);let o=!this.isAccessMicrophonePermission&&t,r=!this.isAccessCameraPermission&&e;s.audio&&(o=!1),s.video&&(r=!1);let a=null,c=null,l=null;if(!i&&(o||r)){if(ob.isLocked&&(Av.debug("[device manager] wait GUM lock"),(await ob.lock())(),Av.debug("[device manager] GUM unlock")),rb&&(o=!1,this.isAccessMicrophonePermission=!0),ab&&(r=!1,this.isAccessCameraPermission=!0),Av.debug("[device manager] check media device permissions",t,e,o,r),o&&r){try{l=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(t){const e=db(t.name||t.code||t,t.message);if(e.code===Ev.PERMISSION_DENIED)throw e;Av.warning("getUserMedia failed in getDevices",e)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:t})}catch(t){const e=db(t.name||t.code||t,t.message);if(e.code===Ev.PERMISSION_DENIED)throw e;Av.warning("getUserMedia failed in getDevices",e)}this.isAccessMicrophonePermission=!0}else if(r){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(t){const e=db(t.name||t.code||t,t.message);if(e.code===Ev.PERMISSION_DENIED)throw e;Av.warning("getUserMedia failed in getDevices",e)}this.isAccessCameraPermission=!0}Av.debug("[device manager] mic permission",t,"cam permission",e)}try{const t=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((t=>t.stop())),c&&c.getTracks().forEach((t=>t.stop())),l&&l.getTracks().forEach((t=>t.stop())),a=null,c=null,l=null,t}catch(t){return a&&a.getTracks().forEach((t=>t.stop())),c&&c.getTracks().forEach((t=>t.stop())),l&&l.getTracks().forEach((t=>t.stop())),a=null,c=null,l=null,new _v(Ev.ENUMERATE_DEVICES_FAILED,t.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter((t=>"audioinput"===t.kind))}async getCamerasDevices(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter((t=>"videoinput"===t.kind))}async getSpeakers(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter((t=>"audiooutput"===t.kind))}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach((i=>{i.device.label===t&&(e=i.device.deviceId)})),e}async getDeviceById(t){const e=(await this.enumerateDevices(!0,!0,!0)).find((e=>e.deviceId===t));if(!e)throw new _v(Ev.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=ff.INITING;try{await this.updateDevicesInfo(),this.state=ff.INITEND}catch(t){throw Av.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=ff.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new _v(Ev.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),i=[];if(t[0]&&t[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;const e=t.find((t=>"audioinput"===t.kind&&"default"===t.deviceId)),i=t.find((t=>"audiooutput"===t.kind&&"default"===t.deviceId));e&&i?i.groupId===e.groupId?Av.debug("[device-check] default input ".concat(e.label," and output ").concat(i.label," is the same group")):Av.warning("[device-check] default input ".concat(e.label," and output ").concat(i.label," is not the same group")):Av.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(t);if(t.forEach((t=>{if(!t.deviceId)return;const n=this.deviceInfoMap.get("".concat(t.kind,"_").concat(t.deviceId));if("ACTIVE"!==(n?n.state:"INACTIVE")){const n={initAt:e,updateAt:e,device:t,state:"ACTIVE"};this.deviceInfoMap.set("".concat(t.kind,"_").concat(t.deviceId),n),i.push(n)}n&&(n.updateAt=e)})),this.deviceInfoMap.forEach(((t,n)=>{"ACTIVE"===t.state&&t.updateAt!==e&&(t.state="INACTIVE",i.push(t))})),this.state!==ff.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach((t=>{switch(t.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Ef.RECORDING_DEVICE_CHANGED,t);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Ef.CAMERA_DEVICE_CHANGED,t);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Ef.PLAYOUT_DEVICE_CHANGED,t)}})),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const e=t.filter((t=>"audioinput"===t.kind)),i=t.filter((t=>"videoinput"===t.kind)),n={audio:!1,video:!1};for(const t of e)if(t.label&&t.deviceId){n.audio=!0;break}for(const t of i)if(t.label&&t.deviceId){n.video=!0;break}return n}},pb=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],mb=new class{constructor(){vp(this,"onAutoplayFailed",void 0),vp(this,"elementMap",new Map),vp(this,"elementStateMap",new Map),vp(this,"elementsNeedToResume",[]),vp(this,"sinkIdMap",new Map),vp(this,"autoResumeAfterInterruption",(()=>{Array.from(this.elementMap.entries()).forEach((t=>{let[e,i]=t;const n=this.elementStateMap.get(e),s=i.srcObject.getAudioTracks()[0];Zu()?s&&"live"===s.readyState&&"running"===GS.curState&&(Av.debug("auto resume after interruption for iOS 15"),i.pause(),i.play()):n&&"paused"===n&&s&&"live"===s.readyState&&"running"===GS.curState&&(Av.debug("auto resume after interruption for iOS"),i.play())}))})),vp(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((t=>{let[e,i]=t;const n=i.srcObject.getAudioTracks()[0];n&&"live"===n.readyState&&(Av.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())}))})),this.autoResumeAudioElement(),GS.on(MS.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),GS.on(MS.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),GS.on(MS.STATE_CHANGE,(()=>{Ku()&&"suspended"===GS.prevState&&"running"===GS.curState&&this.autoResumeAfterInterruption()}))}async setSinkID(t,e){const i=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),i)try{await i.setSinkId(e)}catch(t){throw new _v(Ev.PERMISSION_DENIED,"can not set sink id: "+t.toString())}}play(t,e,i,n){if(this.elementMap.has(e))return;const s=document.createElement("audio");s.autoplay=!0,s.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,s),this.elementMap.set(e,s),this.elementStateMap.set(e,af.INIT),this.setVolume(e,i);const o=this.sinkIdMap.get(e);if(o)try{s.setSinkId(o).catch((t=>{Av.warning("[".concat(e,"] set sink id failed"),t.toString())}))}catch(t){Av.warning("[".concat(e,"] set sink id failed"),t.toString())}const r=s.play();r&&r.then&&r.catch((t=>{n&&PS.autoplayFailed(n,"audio",t.message,e),Av.warning("audio element play warning",t.toString()),this.elementMap.has(e)&&"NotAllowedError"===t.name&&(Av.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(s),dy((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),RS()})))}))}updateTrack(t,e){const i=this.elementMap.get(t);i&&(i.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&"playing"===this.elementStateMap.get(t)}setVolume(t,e){const i=this.elementMap.get(t);i&&(e=Math.max(0,Math.min(100,e)),i.volume=e/100)}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const i=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(i,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){pb.forEach((i=>{e.addEventListener(i,(i=>{const n=this.elementStateMap.get(t),s="pause"===i.type?"paused":i.type;if(Av.debug("[".concat(t,"] audio-element-status change ").concat(n," => ").concat(s)),"error"===i.type){const i=null==e?void 0:e.error;i&&Av.error("[".concat(t,"] media error, code: ").concat(i.code,", message: ").concat(i.message))}this.elementStateMap.set(t,s)}))}))}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach((t=>{t.play().then((t=>{Av.debug("Auto resume audio element success")})).catch((t=>{Av.warning("Auto resume audio element failed!",t)}))})),this.elementsNeedToResume=[]};new _h((t=>{document.body?t():window.addEventListener("load",(()=>t()))})).then((()=>{ap()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))}))}};function vb(){return function(t,e,i){const n=i.value;return"function"==typeof n&&(i.value=function(){this._isClosed&&new _v(Ev.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning");for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const s=n.apply(this,e);return s instanceof _h?new _h(((t,e)=>{s.then(t).catch(e)})):s}),i}}var gb=Wi("Array").values,fb=Zs,Eb=Ht,_b=d,Sb=gb,bb=Array.prototype,Tb={DOMTokenList:!0,NodeList:!0},yb=function(t){var e=t.values;return t===bb||_b(bb,t)&&e===bb.values||Eb(Tb,fb(t))?Sb:e};function wb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Cb(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?wb(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wb(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class Rb extends gv{constructor(t){super(),vp(this,"name","VideoProcessorDestination"),vp(this,"ID","0"),vp(this,"_source",void 0),vp(this,"videoContext",void 0),vp(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new _v(Ev.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new _v(Ev.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(ME.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(ME.ON_TRACK,void 0)}}class Ib extends gv{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e){super(),vp(this,"constraintsMap",new Map),vp(this,"statsRegistry",[]),vp(this,"usageRegistry",[]),vp(this,"trackId",void 0),vp(this,"direction",void 0),vp(this,"_chained",!1),this.trackId=t,this.direction=e}async getConstraints(){return await sy(this,xE.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,e){var i;return Av.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),oy(this,xE.REQUEST_UPDATE_CONSTRAINTS,Array.from(yb(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return Av.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),oy(this,xE.REQUEST_UPDATE_CONSTRAINTS,Array.from(yb(e=this.constraintsMap).call(e)))}registerStats(t,e,i){this.statsRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:i})}unregisterStats(t,e){const i=this.statsRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:i,type:n,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:e,processorName:i,type:n,stats:o})}catch(t){Av.error(new _v(Ev.UNEXPECTED_ERROR,t.message))}return t}registerUsage(t,e){this.usageRegistry.find((e=>e.processorID===t.ID&&e.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex((e=>e.processorID===t.ID&&e.processorName===t.name));-1!==e&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let i=e();i instanceof _h&&(i=await i),t.push(Cb(Cb({},i),{},{direction:this.direction}))}catch(t){Av.error("gather extension usage error",t)}return t}getDirection(){return this.direction}}class Ab extends gv{constructor(t){super(),vp(this,"name","AudioProcessorDestination"),vp(this,"ID","0"),vp(this,"inputTrack",void 0),vp(this,"inputNode",void 0),vp(this,"audioProcessorContext",void 0),vp(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new _v(Ev.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new _v(Ev.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(ME.ON_TRACK,void 0),this.emit(ME.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(ME.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(ME.ON_NODE,this.inputNode))}}class Ob extends gv{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e,i){super(),vp(this,"constraintsMap",new Map),vp(this,"statsRegistry",[]),vp(this,"audioContext",void 0),vp(this,"trackId",void 0),vp(this,"direction",void 0),vp(this,"usageRegistry",[]),vp(this,"_chained",!1),this.audioContext=t,this.trackId=e,this.direction=i}async getConstraints(){return sy(this,xE.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,e){var i;return Av.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),oy(this,xE.REQUEST_UPDATE_CONSTRAINTS,Array.from(yb(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),oy(this,xE.REQUEST_UPDATE_CONSTRAINTS,Array.from(yb(e=this.constraintsMap).call(e)))}registerStats(t,e,i){this.statsRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:i})}unregisterStats(t,e){const i=this.statsRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===e));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:i,type:n,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:e,processorName:i,type:n,stats:o})}catch(t){Av.error(new _v(Ev.UNEXPECTED_ERROR,t.message))}return t}registerUsage(t,e){this.usageRegistry.find((e=>e.processorID===t.ID&&e.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex((e=>e.processorID===t.ID&&e.processorName===t.name));-1!==e&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let i=e();i instanceof _h&&(i=await i),t.push(Cb(Cb({},i),{},{direction:this.direction}))}catch(t){Av.error("gather extension usage error",t)}return t}getDirection(){return this.direction}}class Nb extends gv{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),vp(this,"context",void 0),vp(this,"processSourceNode",void 0),vp(this,"outputTrack",void 0),vp(this,"processedNode",void 0),vp(this,"clonedTrack",void 0),vp(this,"outputNode",void 0),this.outputNode=new kb}setVolume(){}createOutputTrack(){throw new _v(Ev.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class kb{disconnect(){}connect(){}}let Lb,Pb=null;class Db{constructor(){vp(this,"state","open"),vp(this,"trigger",void 0),vp(this,"tasks",[]),Av.debug("[macro-task-queue] is created."),this.trigger=setTimeout((()=>{this.state="closed",Av.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map((t=>t.key)),"]")),this.trigger=void 0,this.tasks.forEach((t=>{let{func:e}=t;return e()})),this.tasks.length=0,Av.debug("[macro-task-queue] is closed.")}))}enqueue(t,e){"closed"!==this.state&&(this.tasks.push({key:t,func:e}),Av.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof t?t:"")))}runTask(t){if("closed"===this.state)return;const e=this.tasks.findIndex((e=>e.key===t));if(-1!==e){const i=this.tasks.splice(e,1);Av.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat("string"==typeof t?t:"")),i[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,Av.debug("[macro-task-queue] is closed."))}}function Mb(t){return function(e,i,n){var s;const o=null!==(s=n.value)&&void 0!==s?s:n.get,r=function(){Pb&&"open"===Pb.state&&Pb.runTask(t);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return null==o?void 0:o.apply(this,...i)};return n.value?n.value=r:n.get=r,n}}var xb,Ub,Vb,Bb,jb,Fb,Hb,Gb,$b,Wb,zb,Kb,qb,Yb,Jb,Xb,Qb,Zb,tT,eT,iT,nT,sT,oT,rT,aT,cT,lT,dT,hT,uT,pT,mT,vT,gT,fT,ET,_T,ST,bT,TT,yT;function wT(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function CT(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?wT(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wT(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}!function(t){t.UPDATE_TRACK_SOURCE="update-track-source"}(Lb||(Lb={}));let RT=(xb=Mb("INIT_WEBAUDIO"),Ub=Mb("INIT_WEBAUDIO"),Vb=Mb("INIT_WEBAUDIO"),Bb=LS({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),jb=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),Fb=vb(),Hb=VS("LocalAudioTrack","_enabledMutex"),Gb=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),$b=vb(),Wb=VS("LocalAudioTrack","_enabledMutex"),zb=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),Kb=vb(),qb=vb(),Yb=vb(),Jb=LS({argsMap:t=>[t.getTrackId()]}),Xb=vb(),Qb=LS({argsMap:t=>[t.getTrackId()]}),Zb=vb(),tT=LS({argsMap:t=>[t.getTrackId()]}),eT=LS({argsMap:(t,e)=>[t.getTrackId(),e.name]}),iT=LS({argsMap:t=>[t.getTrackId()]}),cS((nT=class extends BS{get _source(){return this._trackSource}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get processorDestination(){return this._processorDestination}set processorDestination(t){this._processorDestination=t}get isPlaying(){return this._useAudioElement?mb.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,i,n,s){super(t,i),vp(this,"trackMediaType","audio"),vp(this,"_encoderConfig",void 0),vp(this,"_trackSource",void 0),vp(this,"_enabled",!0),vp(this,"_volume",100),vp(this,"_useAudioElement",!1),vp(this,"_bypassWebAudio",!1),vp(this,"processor",void 0),vp(this,"_processorContext",void 0),vp(this,"_processorDestination",void 0),vp(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!n;const o=()=>{this.processorContext=new Ob(this._source.context,this.getTrackId(),"local"),this.processorDestination=new Ab(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Df.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))},r=s&&Wu()&&!zS();Gv("DISABLE_WEBAUDIO")?(this._source=new Nb,this._useAudioElement=!0,this._bypassWebAudio=!0):r?this._source=new Nb:(this._source=new QS(t,!1,this._getOriginVolumeLevel?t:void 0),Gv("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),o(),!Gv("DISABLE_WEBAUDIO")&&r&&(Pb||(Pb=new Db),Pb).enqueue("INIT_WEBAUDIO",(()=>{this._source=new QS(t,!1,this._getOriginVolumeLevel?t:void 0),Gv("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),o(),this.emit(Lb.UPDATE_TRACK_SOURCE)}))}setVolume(t){qg(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&mb.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void Av.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,oy(this,hE.NEED_REPLACE_TRACK,this).then((()=>{Av.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((t=>{Av.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),t)})))}catch(t){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement)throw new _v(Ev.NOT_SUPPORTED,"your browser does not support setting the audio output device");await mb.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,i){return this._setEnabled(t,e,i)}async _setEnabled(t,e,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(Av.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await oy(this,hE.NEED_ENABLE_TRACK,this),Av.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(t){throw i||(this._enabled=!1),Av.error("[".concat(this.getTrackId(),"] setEnabled to true error"),t.toString()),t}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await oy(this,hE.NEED_DISABLE_TRACK,this)}catch(t){throw i||(this._enabled=!0),Av.error("[".concat(this.getTrackId(),"] setEnabled to false error"),t.toString()),t}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,Av.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await oy(this,hE.NEED_MUTE_TRACK,this):await oy(this,hE.NEED_UNMUTE_TRACK,this))}getStats(){return py((()=>{Av.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),ry(this,hE.GET_STATS)||CT({},jf)}setAudioFrameCallback(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Df.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Df.ON_AUDIO_BUFFER),this._source.on(Df.ON_AUDIO_BUFFER,(e=>t(e)))}play(){Av.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(Av.debug("[".concat(this.getTrackId(),"] start audio playback in element")),mb.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){Av.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?mb.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Av.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&mb.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t.addEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop(),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:t,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await oy(this,hE.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return _h.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new _v(Ev.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new _v(Ev.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;null===(t=this._source.processSourceNode)||void 0===t||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ME.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await oy(this,hE.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await oy(this,hE.NEED_REPLACE_TRACK,this))})),this.processorDestination.on(ME.ON_NODE,(t=>{this._source.processedNode=t}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ME.ON_TRACK),this.processorDestination.removeAllListeners(ME.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(xE.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(xE.REQUEST_CONSTRAINTS)}}).prototype,"_source",[xb],Object.getOwnPropertyDescriptor(nT.prototype,"_source"),nT.prototype),cS(nT.prototype,"processorContext",[Ub],Object.getOwnPropertyDescriptor(nT.prototype,"processorContext"),nT.prototype),cS(nT.prototype,"processorDestination",[Vb],Object.getOwnPropertyDescriptor(nT.prototype,"processorDestination"),nT.prototype),cS(nT.prototype,"setVolume",[Bb],Object.getOwnPropertyDescriptor(nT.prototype,"setVolume"),nT.prototype),cS(nT.prototype,"setPlaybackDevice",[jb,Fb],Object.getOwnPropertyDescriptor(nT.prototype,"setPlaybackDevice"),nT.prototype),cS(nT.prototype,"setEnabled",[Hb,Gb,$b],Object.getOwnPropertyDescriptor(nT.prototype,"setEnabled"),nT.prototype),cS(nT.prototype,"setMuted",[Wb,zb,Kb],Object.getOwnPropertyDescriptor(nT.prototype,"setMuted"),nT.prototype),cS(nT.prototype,"getStats",[qb],Object.getOwnPropertyDescriptor(nT.prototype,"getStats"),nT.prototype),cS(nT.prototype,"setAudioFrameCallback",[Yb],Object.getOwnPropertyDescriptor(nT.prototype,"setAudioFrameCallback"),nT.prototype),cS(nT.prototype,"play",[Jb,Xb],Object.getOwnPropertyDescriptor(nT.prototype,"play"),nT.prototype),cS(nT.prototype,"stop",[Qb,Zb],Object.getOwnPropertyDescriptor(nT.prototype,"stop"),nT.prototype),cS(nT.prototype,"close",[tT],Object.getOwnPropertyDescriptor(nT.prototype,"close"),nT.prototype),cS(nT.prototype,"pipe",[eT],Object.getOwnPropertyDescriptor(nT.prototype,"pipe"),nT.prototype),cS(nT.prototype,"unpipe",[iT],Object.getOwnPropertyDescriptor(nT.prototype,"unpipe"),nT.prototype),nT),IT=(sT=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),oT=vb(),rT=VS("MicrophoneAudioTrack","_enabledMutex"),aT=LS({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),cT=vb(),lT=LS({argsMap:t=>[t.getTrackId()]}),cS((dT=class extends RT{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,i,n){super(t,e.encoderConfig?Fv(e.encoderConfig):{},n,Gv("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),vp(this,"_config",void 0),vp(this,"_deviceName","default"),vp(this,"_constraints",void 0),vp(this,"_originalConstraints",void 0),vp(this,"_enabled",!0),this._config=e,this._constraints=i,this._originalConstraints=i,this._deviceName=t.label,"boolean"==typeof e.bypassWebAudio&&(this._bypassWebAudio=e.bypassWebAudio),(Zu()||tp())&&GS.bindInterruptDetectorTrack(this),this.on(Lb.UPDATE_TRACK_SOURCE,(()=>{this.bindProcessorContextEvents()})),zS()&&this.bindProcessorContextEvents()}async setDevice(t){if(Av.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await ub.getDeviceById(t),i={};i.audio=CT({},this._constraints),i.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let n=null;try{n=await cb(i,this.getTrackId())}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setDevice failed"),t.toString()),n=await cb({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),t}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const e=await ub.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}Av.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,i){if(e)return Av.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(Av.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(n=this._source.clonedTrack)||void 0===n||n.stop(),i||(this._enabled=!1);try{await oy(this,hE.NEED_DISABLE_TRACK,this)}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setEnabled false failed"),t.toString()),t}return}const s=CT({},this._constraints),o=ub.searchDeviceIdByName(this._deviceName);o&&!s.deviceId&&(s.deviceId=o);try{i||(this._enabled=!0);const t=await cb({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(t.getAudioTracks()[0],!1),await oy(this,hE.NEED_ENABLE_TRACK,this)}catch(t){throw i||(this._enabled=!1),Av.error("[".concat(this.getTrackId(),"] setEnabled true failed"),t.toString()),t}Av.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Zu()||tp())&&GS.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Ku()||ip())&&this._enabled&&!this._isClosed&&GS.duringInterruption){const t=async()=>{GS.off(MS.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(Av.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};GS.on(MS.IOS_INTERRUPTION_END,t)}else Av.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fE.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=ub.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId=i),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const t=await cb({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(t.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(xE.REQUEST_UPDATE_CONSTRAINTS,(async(t,e,i)=>{try{const i=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(i),e()}catch(t){i(t)}})),this.processorContext.on(xE.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}}).prototype,"setDevice",[sT,oT],Object.getOwnPropertyDescriptor(dT.prototype,"setDevice"),dT.prototype),cS(dT.prototype,"setEnabled",[rT,aT,cT],Object.getOwnPropertyDescriptor(dT.prototype,"setEnabled"),dT.prototype),cS(dT.prototype,"close",[lT],Object.getOwnPropertyDescriptor(dT.prototype,"close"),dT.prototype),dT),AT=(hT=LS({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),uT=vb(),pT=LS({argsMap:t=>[t.getTrackId()]}),mT=vb(),vT=LS({argsMap:t=>[t.getTrackId()]}),gT=vb(),fT=LS({argsMap:t=>[t.getTrackId()]}),ET=vb(),_T=LS({argsMap:t=>[t.getTrackId()]}),ST=vb(),bT=LS({argsMap:t=>[t.getTrackId()]}),TT=vb(),cS((yT=class extends RT{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,i,n){super(e.createOutputTrack(),i,n),vp(this,"source",void 0),vp(this,"_bufferSource",void 0),this.source=t,this._bufferSource=e,this._bufferSource.on(Df.AUDIO_SOURCE_STATE_CHANGE,(t=>{this.safeEmit(fE.SOURCE_STATE_CHANGE,t)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(t){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}setAudioBufferPlaybackSpeed(t){qg(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[hT,uT],Object.getOwnPropertyDescriptor(yT.prototype,"startProcessAudioBuffer"),yT.prototype),cS(yT.prototype,"pauseProcessAudioBuffer",[pT,mT],Object.getOwnPropertyDescriptor(yT.prototype,"pauseProcessAudioBuffer"),yT.prototype),cS(yT.prototype,"seekAudioBuffer",[vT,gT],Object.getOwnPropertyDescriptor(yT.prototype,"seekAudioBuffer"),yT.prototype),cS(yT.prototype,"resumeProcessAudioBuffer",[fT,ET],Object.getOwnPropertyDescriptor(yT.prototype,"resumeProcessAudioBuffer"),yT.prototype),cS(yT.prototype,"stopProcessAudioBuffer",[_T,ST],Object.getOwnPropertyDescriptor(yT.prototype,"stopProcessAudioBuffer"),yT.prototype),cS(yT.prototype,"setAudioBufferPlaybackSpeed",[bT,TT],Object.getOwnPropertyDescriptor(yT.prototype,"setAudioBufferPlaybackSpeed"),yT.prototype),yT);class OT extends RT{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=WS().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,ZT(8,"track-mix-")),vp(this,"trackList",void 0),vp(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(t){}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return-1!==this.trackList.indexOf(t)}addAudioTrack(t){-1===this.trackList.indexOf(t)?(Av.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):Av.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(-1!==this.trackList.indexOf(t)){Av.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch(t){}cy(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach((e=>{e._encoderConfig&&((e._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=e._encoderConfig.bitrate),(e._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=e._encoderConfig.sampleRate),(e._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=e._encoderConfig.sampleSize),e._encoderConfig.stereo&&(t.stereo=!0))})),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach((e=>{e instanceof OT?e.emit(gE.TRANSCEIVER_UPDATED,t):e._updateRtpTransceiver(t)})))}}class NT extends gv{constructor(){super(...arguments),vp(this,"resultStorage",new Map)}setLocalAudioStats(t,e,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(i,e)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(i,e))}setLocalVideoStats(t,e,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(i,e)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(i,e)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(i))}setRemoteAudioStats(t,e){const i=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(e))}setRemoteVideoStats(t,e){const i=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(e))}record(t,e,i){if(Gv("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(t);if(n&&(n.result.push(i),n.result.length>=5)){const i=n.result.includes(!0);n.isPrevNormal&&!i&&this.emit("exception",kT[t],t,e),!n.isPrevNormal&&i&&this.emit("exception",kT[t]+2e3,t+"_RECOVER",e),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&0===t.receiveLevel)}checkAudioInputLevel(t,e){return e instanceof OT&&!e.isActive||!!e.muted||0!==t.sendVolumeLevel}checkFramerateInput(t,e){let i=null;e._encoderConfig&&e._encoderConfig.frameRate&&(i=FT(e._encoderConfig.frameRate));const n=t.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checkSendVideoBitrate(t,e){return!!e.muted||0!==t.sendBitrate}checkSendAudioBitrate(t,e){return e instanceof OT&&!e.isActive||!!e.muted||0!==t.sendBitrate}checkVideoDecode(t){return 0===t.receiveBitrate||0!==t.decodeFrameRate}}const kT={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},LT=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(i.length>0){const t=i[i.length-1];return Math.round(performance.now()-t.startTime)}return 0}measureFromPublishStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(i.length>0){const t=i[i.length-1];return Math.round(performance.now()-t.startTime)}return 0}};function PT(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function DT(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?PT(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):PT(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class MT{constructor(t){vp(this,"store",void 0),vp(this,"onStatsException",void 0),vp(this,"onUploadPublishDuration",void 0),vp(this,"onStatsChanged",void 0),vp(this,"localStats",new Map),vp(this,"remoteStats",new Map),vp(this,"updateStatsInterval",void 0),vp(this,"trafficStats",void 0),vp(this,"trafficStatsPeerList",[]),vp(this,"uplinkStats",void 0),vp(this,"exceptionMonitor",void 0),vp(this,"p2pChannel",void 0),vp(this,"scalabilityMode",Du.L1T1),vp(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=t,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new NT,this.exceptionMonitor.on("exception",((t,e,i)=>{this.onStatsException&&this.onStatsException(t,e,i)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(NE.LocalAudioTrack)||DT({},jf)}getLocalVideoTrackStats(){return this.localStats.get(NE.LocalVideoTrack)||DT({},Ff)}getRemoteAudioTrackStats(t){const e=(t,e)=>{if(!this.trafficStats)return e;const i=this.trafficStats.peer_delay.find((e=>e.peer_uid===t));return i&&(e.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),e},i={};if(t){var n;const s=null===(n=this.remoteStats.get(t))||void 0===n?void 0:n.audioStats;s&&(i[t]=e(t,s))}else Array.from(this.remoteStats.entries()).forEach((t=>{let[n,{audioStats:s}]=t;s&&(i[n]=e(n,s))}));return i}getRemoteNetworkQualityStats(t){const e={};if(t){var i;const n=null===(i=this.remoteStats.get(t))||void 0===i?void 0:i.networkStats;n&&(e[t]=n)}else Array.from(this.remoteStats.entries()).forEach((t=>{let[i,{networkStats:n}]=t;n&&(e[i]=n)}));return e}getRemoteVideoTrackStats(t){const e=(t,e)=>{if(!this.trafficStats)return e;const i=this.trafficStats.peer_delay.find((e=>e.peer_uid===t));return i&&(e.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),e},i={};if(t){var n;const s=null===(n=this.remoteStats.get(t))||void 0===n?void 0:n.videoStats;s&&(i[t]=e(t,s))}else Array.from(this.remoteStats.entries()).forEach((t=>{let[n,{videoStats:s}]=t;s&&(i[n]=e(n,s))}));return i}getRTCStats(){let t=0,e=0,i=0,n=0;const s=this.localStats.get(NE.LocalAudioTrack);s&&(t+=s.sendBytes,e+=s.sendBitrate);const o=this.localStats.get(NE.LocalVideoTrack);o&&(t+=o.sendBytes,e+=o.sendBitrate);const r=this.localStats.get(NE.LocalVideoLowTrack);r&&(t+=r.sendBytes,e+=r.sendBitrate),this.remoteStats.forEach((t=>{let{audioStats:e,videoStats:s}=t;e&&(i+=e.receiveBytes,n+=e.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:e,SendBytes:t,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter((t=>void 0!==t.B_ppad||void 0!==t.B_ppvd)),t.peer_delay.filter((t=>-1===this.trafficStatsPeerList.indexOf(t.peer_uid))).forEach((t=>{var e;const i=null===(e=this.p2pChannel)||void 0===e?void 0:e.getRemoteMedia(t.peer_uid),n=null!=i&&i.videoSSRC?LT.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?LT.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==t.B_ppad&&void 0!==t.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(t.peer_uid,t.B_ppad,t.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(t.peer_uid))})),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&Av.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,e,i){if(!t)return!1;const n=!!i&&e.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||e.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach((e=>{let[i,n]=e;switch(i){case NE.LocalVideoTrack:case NE.LocalVideoLowTrack:{const e=n,o=DT({},Ff),r=t.getStats(),a=t.getLocalMedia(i);if(r){const i=r.videoSend.find((t=>t.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(i){const n=t.getLocalVideoSize(),s=t.getEncoderConfig(NE.LocalVideoTrack);"H264"!==i.codec&&"H265"!==i.codec&&"VP8"!==i.codec&&"VP9"!==i.codec&&"AV1X"!==i.codec&&"AV1"!==i.codec||(o.codecType=i.codec),o.sendBytes=i.bytes,o.sendBitrate=e?8*Math.max(0,o.sendBytes-e.sendBytes):0,i.inputFrame?(o.captureFrameRate=i.inputFrame.frameRate,o.captureResolutionHeight=i.inputFrame.height,o.captureResolutionWidth=i.inputFrame.width):n&&(o.captureResolutionWidth=n.width,o.captureResolutionHeight=n.height),i.sentFrame?(o.sendFrameRate=i.sentFrame.frameRate,o.sendResolutionHeight=i.sentFrame.height,o.sendResolutionWidth=i.sentFrame.width):n&&(o.sendResolutionWidth=n.width,o.sendResolutionHeight=n.height),i.avgEncodeMs&&(o.encodeDelay=i.avgEncodeMs),s&&s.bitrateMax&&(o.targetSendBitrate=1e3*s.bitrateMax),o.sendPackets=i.packets,o.sendPacketsLost=i.packetsLost,o.totalDuration=e?e.totalDuration+1:1,o.totalFreezeTime=e?e.totalFreezeTime:0,this.isLocalVideoFreeze(i)&&(o.totalFreezeTime+=1),i.scalabilityMode&&this.scalabilityMode!==i.scalabilityMode&&(Av.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(i.scalabilityMode)),this.scalabilityMode=i.scalabilityMode)}this.trafficStats&&(o.sendPacketsLost=this.trafficStats.B_pvlr4/100)}var s;this.localStats.set(i,o),((null==e?void 0:e.sendResolutionWidth)!==o.sendResolutionWidth||(null==e?void 0:e.sendResolutionHeight)!==o.sendResolutionHeight)&&(null===(s=this.onStatsChanged)||void 0===s||s.call(this,"resolution",{width:o.sendResolutionWidth,height:o.sendResolutionHeight})),o&&a&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,a.track,o);break}case NE.LocalAudioTrack:{const e=n,s=DT({},jf),o=t.getStats(),r=t.getLocalMedia(i);if(o){const i=o.audioSend.find((t=>t.ssrc===(null==r?void 0:r.ssrcs[0].ssrcId)));if(i){if("opus"!==i.codec&&"aac"!==i.codec&&"PCMU"!==i.codec&&"PCMA"!==i.codec&&"G722"!==i.codec||(s.codecType=i.codec),i.inputLevel)s.sendVolumeLevel=Math.round(32767*i.inputLevel);else{const e=t.getLocalAudioVolume();e&&(s.sendVolumeLevel=Math.round(32767*e))}s.sendBytes=i.bytes,s.sendPackets=i.packets,s.sendPacketsLost=i.packetsLost,s.sendBitrate=e?8*Math.max(0,s.sendBytes-e.sendBytes):0}}this.trafficStats&&(s.sendPacketsLost=this.trafficStats.B_pvlr4/100),this.localStats.set(NE.LocalAudioTrack,s),s&&r&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,r.track,s);break}}}))}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{videoStats:n,audioStats:s,videoPcStats:o}]=e;const r=s,a=n,c=o,l=DT({},Hf),d=DT({},$f),h=DT({},Gf),{audioTrack:u,videoTrack:p,audioSSRC:m,videoSSRC:v}=t.getRemoteMedia(i),g=t.getStats(),f=null==g?void 0:g.audioRecv.find((t=>t.ssrc===m)),E=null==g?void 0:g.videoRecv.find((t=>t.ssrc===v)),_=this.trafficStats&&this.trafficStats.peer_delay.find((t=>t.peer_uid===i));if(f&&("opus"!==f.codec&&"aac"!==f.codec&&"PCMU"!==f.codec&&"PCMA"!==f.codec&&"G722"!==f.codec||(l.codecType=f.codec),f.outputLevel?l.receiveLevel=Math.round(32767*f.outputLevel):u&&(l.receiveLevel=Math.round(32767*u.getVolumeLevel())),l.receiveBytes=f.bytes,l.receivePackets=f.packets,l.receivePacketsLost=f.packetsLost,l.packetLossRate=l.receivePacketsLost/(l.receivePackets+l.receivePacketsLost),l.receiveBitrate=r?8*Math.max(0,l.receiveBytes-r.receiveBytes):0,l.totalDuration=r?r.totalDuration+1:1,l.totalFreezeTime=r?r.totalFreezeTime:0,l.freezeRate=l.totalFreezeTime/l.totalDuration,l.receiveDelay=f.jitterBufferMs,l.totalDuration>10&&MT.isRemoteAudioFreeze(u)&&(l.totalFreezeTime+=1)),E){"H264"!==E.codec&&"H265"!==E.codec&&"VP8"!==E.codec&&"VP9"!==E.codec&&"AV1X"!==E.codec&&"AV1"!==E.codec||(d.codecType=E.codec),d.receiveBytes=E.bytes,d.receiveBitrate=a?8*Math.max(0,d.receiveBytes-a.receiveBytes):0,d.decodeFrameRate=E.decodeFrameRate<0?0:E.decodeFrameRate,d.renderFrameRate=E.decodeFrameRate<0?0:E.decodeFrameRate,E.outputFrame&&(d.renderFrameRate=E.outputFrame.frameRate),E.receivedFrame?(d.receiveFrameRate=E.receivedFrame.frameRate,d.receiveResolutionHeight=E.receivedFrame.height,d.receiveResolutionWidth=E.receivedFrame.width):p&&(d.receiveResolutionHeight=p._videoHeight||0,d.receiveResolutionWidth=p._videoWidth||0),void 0!==E.framesRateFirefox&&(d.receiveFrameRate=Math.round(E.framesRateFirefox)),d.receivePackets=E.packets,d.receivePacketsLost=E.packetsLost,d.packetLossRate=d.receivePacketsLost/(d.receivePackets+d.receivePacketsLost),d.totalDuration=a?a.totalDuration+1:1,d.totalFreezeTime=a?a.totalFreezeTime:0,d.receiveDelay=E.jitterBufferMs||0;const e=!!v&&t.getRemoteVideoIsReady(v);p&&e&&MT.isRemoteVideoFreeze(p,E,c)&&(d.totalFreezeTime+=1),d.freezeRate=d.totalFreezeTime/d.totalDuration}_&&(l.end2EndDelay=_.B_ad,d.end2EndDelay=_.B_vd,l.transportDelay=_.B_ed,d.transportDelay=_.B_ed,l.currentPacketLossRate=_.B_ealr4/100,d.currentPacketLossRate=_.B_evlr4/100,h.uplinkNetworkQuality=_.B_punq?_.B_punq:0,h.downlinkNetworkQuality=_.B_pdnq?_.B_pdnq:0),this.remoteStats.set(i,{audioStats:l,videoStats:d,videoPcStats:E,networkStats:h}),u&&this.exceptionMonitor.setRemoteAudioStats(u,l),p&&this.exceptionMonitor.setRemoteVideoStats(p,d)}))}}const xT=new class extends gv{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),vp(this,"_lastHiddenTime",0),vp(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),Av.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}};function UT(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function VT(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?UT(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UT(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function BT(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(Gv("TURN_DOMAIN")):(Av.info("Cannot recognized as IP address ".concat(t,". Used As Host instead")),t)}function jT(t,e){var i,n;const s=Gv("GATEWAY_DOMAINS");let o=s[1]&&-1!==e.indexOf(s[1])?1:0;t.addresses=t.addresses||[];const r=t.addresses.map((t=>t.domain_prefix?{address:"".concat(t.domain_prefix,".").concat(s[o++%s.length],":").concat(t.port)}:t.ip.match(/^[\.\:\d]+$/)?{ip:t.ip,port:t.port,address:"".concat(t.ip.replace(/[^\d]/g,"-"),".").concat(s[o++%s.length],":").concat(t.port)}:(Av.info("Cannot recognized as IP address ".concat(t.ip,". Used As Host instead")),{ip:t.ip,port:t.port,address:"".concat(t.ip,":").concat(t.port)})));if(null!==(i=t.detail)&&void 0!==i&&i[18]&&"string"==typeof(null===(n=t.detail)||void 0===n?void 0:n[18])){const e=t.detail[18],i=null==e?void 0:e.split(";");for(let t=0;t<i.length;t++){var a;const e=fu(a=i[t]).call(a);r[t]&&e&&(r[t].ip6=e)}}return{gatewayAddrs:r,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function FT(t){return"number"==typeof t?t:t.exact||t.ideal||t.max||t.min||0}function HT(t){const e=t._encoderConfig;if(!e)return{};const i={resolution:e.width&&e.height?"".concat(FT(e.width),"x").concat(FT(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return"number"==typeof e.frameRate?(i.maxFrameRate=e.frameRate,i.minFrameRate=e.frameRate):e.frameRate&&(i.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,i.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),i}function GT(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function $T(t,e){let i,n,s;switch(e){case JE.CHOOSE_SERVER:i=4096,n="choose server";break;case JE.CLOUD_PROXY:i=1048576,n="proxy";break;case JE.CLOUD_PROXY_5:i=4194304,n="proxy5";break;case JE.CLOUD_PROXY_FALLBACK:i=4194310,n="proxy fallback";break;default:throw new _v(Ev.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach((e=>{e.buffer&&e.buffer.flag===i&&(s={code:e.buffer.code,addresses:(e.buffer.edges_services||[]).map((t=>VT(VT({},t),{},{ticket:e.buffer.cert}))),server_ts:t.enter_ts,uid:e.buffer.uid,cid:e.buffer.cid,cname:e.buffer.cname,detail:VT(VT({},e.buffer.detail),t.detail),flag:e.buffer.flag,opid:t.opid,cert:e.buffer.cert})})),!s)throw new _v(Ev.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(n," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return s}async function WT(t,e){return await _h.all(t.addresses.map((async t=>({address:BT(t.ip),tcpport:t.port,udpport:t.port,username:e&&Gv("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Pv.username,password:e&&Gv("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await OS(e.toString()):Pv.password}))))}function zT(t,e){const i=e._videoWidth||e.getMediaStreamTrack(!0).getSettings().width;return i||Av.warning("cannot get original video track's width, default scale down 4 times for low stream"),i?i/FT(t.width):4}function KT(t){let{candidateType:e,relayProtocol:i,type:n,address:s,port:o,protocol:r}=t;return"local-candidate"===n?{candidateType:e,relayProtocol:i,protocol:r}:{candidateType:e,relayProtocol:i,address:s,port:o,protocol:r}}function qT(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function YT(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?qT(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):qT(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function JT(t){return window.TextEncoder?(new TextEncoder).encode(t).length:t.length}function XT(t){return new _h((e=>{window.setTimeout(e,t)}))}function QT(t){const e=new _v(Ev.TIMEOUT,"timeout");return new _h(((i,n)=>{window.setTimeout((()=>n(e)),t)}))}function ZT(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,t).toLowerCase();return i.length===t?"".concat(e).concat(i):"".concat(e).concat(i)+ZT(t-i.length,"")}function ty(){return ZT(32,"").toUpperCase()}const ey=()=>{};function iy(t){return new _h(((e,i)=>{let n=!1;const s=document.createElement("video");s.setAttribute("autoplay",""),s.setAttribute("muted",""),s.muted=!0,s.autoplay=!0,s.setAttribute("playsinline",""),s.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(s);const o=Ku()?"canplay":"playing";s.addEventListener(o,(()=>{const t=s.videoWidth,i=s.videoHeight;!t&&zu()||(n=!0,s.srcObject=null,s.remove(),e([t,i]))})),s.srcObject=new MediaStream([t]),s.play().catch(ey),setTimeout((()=>{n||(s.srcObject=null,s.remove(),e([s.videoWidth,s.videoHeight]))}),4e3)}))}function ny(t){return _h.all(t.map((t=>t.then((t=>{throw t}),(t=>t))))).then((t=>{throw t}),(t=>t))}function sy(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return 0===t.getListeners(e).length?_h.reject(new _v(Ev.UNEXPECTED_ERROR,"can not emit promise")):new _h(((i,s)=>{t.emit(e,...n,i,s)}))}function oy(t,e){if(0===t.getListeners(e).length)return _h.resolve();for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return sy(t,e,...n)}function ry(t,e){if(0===t.getListeners(e).length)return null;for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return ay(t,e,...n)}function ay(t,e){let i=null,n=null;for(var s=arguments.length,o=new Array(s>2?s-2:0),r=2;r<s;r++)o[r-2]=arguments[r];if(t.emit(e,...o,(t=>{i=t}),(t=>{n=t})),null!==n)throw n;if(null===i)throw new _v(Ev.UNEXPECTED_ERROR,"handler is not sync");return i}function cy(t,e){const i=t.indexOf(e);-1!==i&&t.splice(i,1)}function ly(t){const e=[];return t.forEach((t=>{-1===e.indexOf(t)&&e.push(t)})),e}function dy(t){_h.resolve().then(t)}function hy(t){return JSON.parse(JSON.stringify(t))}const uy={};function py(t,e){uy[e]||(uy[e]=!0,t())}function my(t){const e=window.atob(t),i=new Uint8Array(new ArrayBuffer(e.length));for(let t=0;t<e.length;t+=1)i[t]=e.charCodeAt(t);return i}function vy(t){let e="";for(let i=0;i<t.length;i+=1)e+=String.fromCharCode(t[i]);return window.btoa(e)}const gy=new class{constructor(){vp(this,"fnMap",new Map)}throttleByKey(t,e,i,n){for(var s=arguments.length,o=new Array(s>4?s-4:0),r=4;r<s;r++)o[r-4]=arguments[r];if(this.fnMap.has(e)){const s=this.fnMap.get(e);if(s.threshold!==i){s.fn(...s.args),clearTimeout(s.timer);const r=window.setTimeout((()=>{const t=this.fnMap.get(e);t&&t.fn(...t.args),this.fnMap.delete(e)}),i);this.fnMap.set(e,{fn:t,threshold:i,timer:r,args:o,skipFn:n})}else s.skipFn&&s.skipFn(...s.args),this.fnMap.set(e,YT(YT({},s),{},{fn:t,args:o,skipFn:n}))}else{const s=window.setTimeout((()=>{const t=this.fnMap.get(e);t&&t.fn(...t.args),this.fnMap.delete(e)}),i);this.fnMap.set(e,{fn:t,threshold:i,timer:s,args:o,skipFn:n})}}},fy=gy.throttleByKey.bind(gy),Ey=async t=>{let{fragementLength:e,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:o}=t,r=0;const a=e;let c,l=0;const d=async()=>{const t=(()=>{const t=r*a,e=t+a;return i.slice(t,e).map(n)})();o&&o.push(...t);try{c=await ny(t)}catch(t){if(l+=a,r++,!(l>=i.length))return void await d();s(t)}t.forEach((t=>t.cancel()))};return await d(),c};function _y(t){return"object"==typeof t&&null!==t&&!(t instanceof RegExp)}const Sy={[_f.ACCESS_POINT]:{[Tf.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Tf.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Tf.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Tf.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Tf.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Tf.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voice service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Tf.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[_f.UNILBS]:{[bf.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[bf.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[bf.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[bf.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[bf.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[bf.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[bf.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[bf.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[bf.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[bf.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[bf.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[bf.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[_f.STRING_UID_ALLOCATOR]:{[Sf.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Sf.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Sf.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function by(t){const e=Sy[Math.floor(t/1e4)];if(!e)return{desc:"unkonw error",retry:!1};const i=e[t%1e4];if(!i){if(Math.floor(t/1e4)===_f.ACCESS_POINT){const e=t%1e4;if("1"===e.toString()[0])return{desc:t.toString(),retry:!1};if("2"===e.toString()[0])return{desc:t.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const Ty={[yf.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[yf.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[yf.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[yf.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[yf.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[yf.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[yf.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[yf.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[yf.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[yf.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[yf.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[yf.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[yf.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[yf.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[yf.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[yf.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[yf.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[yf.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[yf.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[yf.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[yf.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[yf.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[yf.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[yf.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[yf.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[yf.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[yf.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[yf.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[yf.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[yf.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[yf.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[yf.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[yf.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[yf.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[yf.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[yf.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[yf.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[yf.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[yf.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[yf.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[yf.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[yf.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[yf.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[yf.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[yf.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[yf.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[yf.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[yf.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[yf.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[yf.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[yf.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[yf.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[yf.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[yf.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[yf.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[yf.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[yf.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[yf.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[yf.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[yf.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[yf.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[yf.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[yf.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[yf.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function yy(t){return Ty[t]||{desc:"UNKNOW_ERROR_".concat(t),action:"failed"}}function wy(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}class Cy extends gv{get url(){return this.websocket?this.websocket.url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){["tryNext","recover"].includes(t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,"reconnecting"===this._state?this.emit(Wf.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Wf.CONNECTED):"closed"===this._state?this.emit(Wf.CLOSED):"failed"===this._state&&this.emit(Wf.FAILED))}resetReconnectCount(t){Av.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4?arguments[4]:void 0;super(),vp(this,"connectionID",0),vp(this,"currentURLIndex",0),vp(this,"urls",void 0),vp(this,"_reconnectMode","tryNext"),vp(this,"reconnectReason",void 0),vp(this,"_initMutex",new US("websocket")),vp(this,"name",void 0),vp(this,"_state","closed"),vp(this,"reconnectInterrupter",void 0),vp(this,"websocket",void 0),vp(this,"retryConfig",void 0),vp(this,"reconnectCount",0),vp(this,"forceCloseTimeout",5e3),vp(this,"onlineReconnectListener",void 0),vp(this,"useCompress",void 0),vp(this,"tryDoubleDomain",!1),vp(this,"wsInflateLength",0),vp(this,"wsDeflateLength",0),vp(this,"closeEstablishingWs",(()=>{})),vp(this,"store",void 0),vp(this,"joinChannelServiceRecordIndex",void 0),this.store=s,this.name=t,this.retryConfig=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?wy(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wy(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},e),this.useCompress=i,this.tryDoubleDomain=n;const{timeout:o,timeoutFactor:r}=e,a=Math.max(300,Math.floor(3*o/5)),c=Math.max(1.2,Math.floor(8*r)/10);PE.ONLINE&&(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c),yS.on(DE.NETWORK_STATE_CHANGE,((t,e)=>{t!==e&&(this.resetReconnectCount("network state change: ".concat(e," -> ").concat(t)),t===PE.ONLINE?(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c):(this.retryConfig.timeout=o,this.retryConfig.timeoutFactor=r))}))}getConnection(){return this.websocket||void 0}init(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this.forceCloseTimeout=e;const i=(e,i)=>{this.urls=t;const n=this.urls[this.currentURLIndex];this.state="connecting",this.createWebSocketConnection(n).then(e).catch(i),this.once(Wf.CLOSED,(()=>i(new _v(Ev.WS_DISCONNECT)))),this.once(Wf.CONNECTED,(()=>e()))};return this._initMutex.lock().then((t=>new _h(((t,e)=>{i(t,e)})).then((()=>{t()})).catch((()=>{t()}))))}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const t=this.websocket;e?setTimeout((()=>t.close()),500):t.close(),this.websocket=void 0}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,e){if(!this.websocket)return void Av.warning("[".concat(this.name,"] can not reconnect, no websocket"));var i;void 0!==t&&(this.reconnectMode=t),Av.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinChannelServiceRecordIndex&&(null===(i=this.store)||void 0===i||i.recordJoinChannelService({status:"error",errors:[new Error(e)]},this.joinChannelServiceRecordIndex));const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:e})}sendMessage(t){let e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new _v(Ev.WS_ABORT,"websocket is not ready");try{e||(t=JSON.stringify(t)),this.websocket.send(t)}catch(t){throw new _v(Ev.WS_ERR,"send websocket message error"+t.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,e=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:e}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t,e){return this.connectionID+=1,this.connectionID,this.joinChannelServiceRecordIndex=void 0,new _h(((i,n)=>{var s;const o=t=>{var e;null===(e=this.store)||void 0===e||e.signalChannelOpen(),Av.debug("[".concat(this.name,"] websocket opened:"),t),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},r=async t=>{if(Av.debug("[".concat(this.name,"] websocket close ").concat(this.websocket&&this.websocket.url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount<this.retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const e=ry(this,Wf.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,s=await this.reconnectWithAction(e);if("closed"===this.state)return void Av.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!s)return n(new _v(Ev.WS_DISCONNECT,"websocket reconnect failed: ".concat(t.code))),void this.close(!0);i()}else n(new _v(Ev.WS_DISCONNECT,"websocket close: ".concat(t.code))),this.close()},a=t=>{this.emit(Wf.ON_MESSAGE,t)};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),Gv("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=Gv("GATEWAY_WSS_ADDRESS")),Av.debug("[".concat(this.name,"] start connect, url: ").concat(t));const c=null===(s=this.store)||void 0===s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});this.chooseBestWebsocketConnection(t,!!e,c).then((t=>{var e;this.websocket=t,o&&o(t.url),t.onclose=r,t.onmessage=a,null===(e=this.store)||void 0===e||e.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinChannelServiceRecordIndex=c})).catch((t=>{var e;if(null===(e=this.store)||void 0===e||e.recordJoinChannelService({endTs:Date.now(),status:t instanceof _v&&t.code===Ev.WS_ABORT?"aborted":"error",errors:[t]},c),"closed"!==this.state){if(t instanceof _v&&t.code===Ev.WS_ERR){const e=new _v(Ev.WS_ERR,"init websocket failed! Error: ".concat(t.toString()));return Av.error("[".concat(this.name,"]").concat(e)),void n(e)}r&&r(t)}else n(new _v(Ev.WS_DISCONNECT,"websocket is closed: ".concat(t.toString())))}))}))}async reconnectWithAction(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(!this.urls)return!1;if("closed"===this.state)return!1;this.onlineReconnectListener||yS.networkState!==PE.OFFLINE||(this.onlineReconnectListener=yS.onlineWaiter&&yS.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>{i=!1},e){const e=bv(this.reconnectCount,this.retryConfig);Av.debug("[".concat(this.name,"] wait ").concat(e,"ms to reconnect websocket, mode: ").concat(t)),await _h.race([XT(e),this.onlineReconnectListener||new _h((()=>{}))])}if("closed"===this.state||!i)return!1;this.reconnectCount+=1;const n=async(t,e)=>{this.emit(Wf.RECONNECT_CREATE_CONNECTION,e),await this.createWebSocketConnection(t)};try{if("retry"===t){const e=this.urls[this.currentURLIndex];this.emit(Wf.RECONNECT_WAITTING_FINISH,t),await n(e,t)}else if("tryNext"===t){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return await this.reconnectWithAction("recover",!1);Av.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex));const e=this.urls[this.currentURLIndex];this.emit(Wf.RECONNECT_WAITTING_FINISH,t),await n(e,t)}else if("recover"===t){Av.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Wf.RECONNECT_WAITTING_FINISH,t),this.urls=await sy(this,Wf.REQUEST_NEW_URLS),this.currentURLIndex=0;const e=this.urls[this.currentURLIndex];await n(e,t)}return!0}catch(i){var s;return Av.error("[".concat(this.name,"] reconnect failed"),i.toString()),null!=i&&null!==(s=i.data)&&void 0!==s&&s.desc&&Array.isArray(i.data.desc)&&i.data.desc.length&&i.data.desc.includes("dynamic key expired")?(this.emit(Wf.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,e)}}async chooseBestWebsocketConnection(t,e,i){return new _h(((n,s)=>{let o=!1;const r=[];this.closeEstablishingWs=()=>{Av.debug("[choose-best-ws] close establishing websockets"),r.forEach((t=>{t.onclose=null,t.onopen=null,t.onmessage=null,t.close()})),s(new _v(Ev.WS_ABORT,"choose best websocket aborted"))};const a=Gv("GATEWAY_DOMAINS");let c;const l=t.indexOf("?h="),d=a.find((e=>-1!==l?t.includes(e,l):t.includes(e)));Av.debug("[choose-best-ws] currentDomain: ",d,", domains: ",a);let h=!this.tryDoubleDomain||e||!d;if(!h&&d){var u;const e=Date.now();try{a.forEach((e=>{const i=-1===l?t.replace(d,e):t.substr(0,l)+t.substr(l).replace(d,e),n=new WebSocket(i);n.binaryType="arraybuffer",r.push(n),Av.debug("[choose-best-ws] ws is connecting:",n.url)}))}catch(t){for(Av.debug("[choose-best-ws] ws create failed, fallback to single url"),r.forEach((t=>t.close()));r.length;)r.pop();h=!0}null===(u=this.store)||void 0===u||u.recordJoinChannelService({urls:r.map((t=>t.url)),service:"gateway"},i),r.forEach((t=>{t.onopen=()=>{if(o)return;const i=Date.now()-e;Av.debug("[choose-best-ws] ws open cost ".concat(i,"ms")),r.filter((e=>e!==t)).forEach((t=>{Av.debug("[choose-best-ws]close backup websocket: ".concat(t.url)),t.close()})),o=!0,n(t)},t.onclose=t=>{c=t,o||r.find((t=>!(t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING)))||(Av.debug("[choose-best-ws] all websocket is closed"),o=!0,s(c))},t.onmessage=e=>{Av.debug("[choose-best-ws]".concat(t.url," onmessage: ").concat(e.data))}})),XT(this.forceCloseTimeout).then((()=>{r.forEach((t=>{t.readyState!==WebSocket.OPEN&&t.close()}))}))}if(h){var p;let e;Av.debug("[choose-best-ws] use single url: ",t),null===(p=this.store)||void 0===p||p.recordJoinChannelService({urls:[t],service:"gateway"},i);try{e=new WebSocket(t),r.push(e),e.binaryType="arraybuffer"}catch(t){const e=new _v(Ev.WS_ERR,"init websocket failed! Error: ".concat(t.toString()));return Av.error("[".concat(this.name,"]").concat(e)),void s(e)}e.onopen=()=>{n(e)},e.onclose=t=>{s(t)},e.onmessage=t=>{Av.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(t.data))},XT(this.forceCloseTimeout).then((()=>{e&&e.readyState!==WebSocket.OPEN&&e.close()}))}})).then((t=>(this.closeEstablishingWs=void 0,t))).catch((t=>{throw this.closeEstablishingWs=void 0,t}))}}class Ry{constructor(t){vp(this,"input",[]),vp(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return 0===this.input.length?0:Xi(t=this.input).call(t,((t,e)=>t+e))/this.input.length}}class Iy extends gv{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Af.CONNECTED?this.emit(Of.WS_CONNECTED):t===Af.RECONNECTING?this.emit(Of.WS_RECONNECTING,this._websocketReconnectReason):t===Af.CLOSED&&this.emit(Of.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),vp(this,"_disconnectedReason",void 0),vp(this,"_websocketReconnectReason",void 0),vp(this,"_connectionState",Af.CLOSED),vp(this,"reconnectToken",void 0),vp(this,"websocket",void 0),vp(this,"openConnectionTime",void 0),vp(this,"clientId",void 0),vp(this,"lastMsgTime",Date.now()),vp(this,"uploadCache",[]),vp(this,"uploadCacheInterval",void 0),vp(this,"rttRolling",new Ry(5)),vp(this,"pingpongTimer",void 0),vp(this,"wsInflateDataTimer",void 0),vp(this,"pingpongTimeoutCount",0),vp(this,"joinResponse",void 0),vp(this,"multiIpOption",void 0),vp(this,"initError",void 0),vp(this,"spec",void 0),vp(this,"store",void 0),vp(this,"onWebsocketMessage",(t=>{if(t.data instanceof ArrayBuffer)return void this.emit(Of.ON_BINARY_DATA,t.data);const e=JSON.parse(t.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(e,"_id")){const t="res-@".concat(e._id);this.emit(t,e._result,e._message)}else if(Object.prototype.hasOwnProperty.call(e,"_type")){if(this.emit(e._type,e._message),e._type===Lf.ON_NOTIFICATION&&this.handleNotification(e._message),e._type===Lf.ON_USER_BANNED)switch(e._message.error_code){case 14:this.close(Cf.UID_BANNED);break;case 15:this.close(Cf.IP_BANNED);break;case 16:this.close(Cf.CHANNEL_BANNED)}if(e._type===Lf.ON_USER_LICENSE_BANNED)switch(e._message.error_code){case yf.ERR_LICENSE_MISSING:this.close(Cf.LICENSE_MISSING);break;case yf.ERR_LICENSE_EXPIRED:this.close(Cf.LICENSE_EXPIRED);break;case yf.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Cf.LICENSE_MINUTES_EXCEEDED);break;case yf.ERR_LICENSE_PERIOD_INVALID:this.close(Cf.LICENSE_PERIOD_INVALID);break;case yf.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Cf.LICENSE_MULTIPLE_SDK_SERVICE);break;case yf.ERR_LICENSE_ILLEGAL:this.close(Cf.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new Cy("gateway-".concat(this.clientId),this.spec.retryConfig,!0,!0,e),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Af.CONNECTED&&this.reconnect("retry",If.OFFLINE)}))}async request(t,e,i,n){const s=ZT(6,""),o={_id:s,_type:t,_message:e},r=this.websocket.connectionID,a=()=>new _h(((e,i)=>{if(this.connectionState===Af.CONNECTED)return e();const n=()=>{this.off(Of.WS_CLOSED,s),e()},s=()=>{this.off(Of.WS_CONNECTED,n),i(new _v(Ev.WS_ABORT))};this.once(Of.WS_CONNECTED,n),this.once(Of.WS_CLOSED,s),t!==Nf.PUBLISH&&t!==Nf.SUBSCRIBE&&t!==Nf.UNSUBSCRIBE&&t!==Nf.UNPUBLISH&&t!==Nf.CONTROL&&t!==Nf.RESTART_ICE||this.once(Of.DISCONNECT_P2P,(()=>{i(new _v(Ev.DISCONNECT_P2P))})),t!==Nf.PUBLISH&&t!==Nf.RESTART_ICE||this.once(Of.ABORT_P2P_EXECUTION,(()=>{i(new _v(Ev.DISCONNECT_P2P))}))}));if(this.connectionState!==Af.CONNECTING&&this.connectionState!==Af.RECONNECTING||t===Nf.JOIN||t===Nf.REJOIN||await a(),this.websocket.sendMessage(o,!0),n)return;const c=new _h(((i,n)=>{let o=!1;const a=(n,s)=>{o=!0,i({isSuccess:"success"===n,message:s||{}}),this.off(Of.WS_CLOSED,c),this.off(Of.WS_RECONNECTING,c),this.emit(Of.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),a);const c=()=>{n(new _v(Ev.WS_ABORT,"type: ".concat(t))),this.off(Of.WS_CLOSED,c),this.off(Of.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once(Of.WS_CLOSED,c),this.once(Of.WS_RECONNECTING,c),XT(Gv("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||o||(Av.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(Of.REQUEST_TIMEOUT,t,e))}))}));let l=null;try{l=await c}catch(n){if(this.connectionState===Af.CLOSED||t===Nf.LEAVE)throw new _v(Ev.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():t===Nf.JOIN||t===Nf.REJOIN?null:(await a(),await this.request(t,e))}if(l.isSuccess)return l.message;const d=Number(l.message.error_code||l.message.code),h=yy(d),u=new _v(Ev.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:d,data:l.message});return"success"===h.action?l.message:(Av.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(d,", message: ").concat(h.desc,", action: ").concat(h.action)),d===yf.ERR_TOO_MANY_BROADCASTERS?t===Nf.JOIN||t===Nf.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(d===yf.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,Av.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",If.MULTI_IP)):this.reconnect(h.action,If.SERVER_ERROR),t===Nf.JOIN||t===Nf.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new _h((i=>{const n=s=>{(!e||e(s))&&(this.off(t,n),i(s))};this.on(t,n)}))}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch(t){const e=Gv("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>e&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Af.CONNECTED)return;const t=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(t._type,t._message)}),Gv("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new _h(((i,n)=>{this.once(Of.WS_CONNECTED,(()=>i(this.joinResponse))),this.once(Of.WS_CLOSED,(()=>n(this.initError||new _v(Ev.WS_ABORT)))),this.connectionState=Af.CONNECTING,this.websocket.init(t).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4),setTimeout((()=>{e&&void 0===this.openConnectionTime&&(Av.debug("[".concat(this.clientId,"] init websocket timeout while join with fallback to proxy")),n(new _v(Ev.INIT_WEBSOCKET_TIMEOUT)))}),Gv("JOIN_WITH_FALLBACK_PROXY_PENDING_DURATION"))}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Cf.LEAVE,this.connectionState=Af.CLOSED,Av.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===Cf.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Cy("gateway-".concat(this.clientId),this.spec.retryConfig,!0,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(Of.ABORT_P2P_EXECUTION);const t=await sy(this,Of.REQUEST_JOIN_INFO),e=await this.request(Nf.JOIN,t);if(!e)return this.emit(Of.REPORT_JOIN_GATEWAY,Ev.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(Of.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Af.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new _v(Ev.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=ay(this,Of.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(Nf.REJOIN,t);return!!e&&(this.connectionState=Af.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach((t=>{this.emit(Lf.ON_USER_ONLINE,{uid:t.uid}),t.audio&&this.emit(Lf.ON_ADD_AUDIO_STREAM,{uid:t.uid,uint_id:t.uint_id,audio:!0,ssrcId:t.audio_ssrc}),t.video&&this.emit(Lf.ON_ADD_VIDEO_STREAM,{uid:t.uid,uint_id:t.uint_id,video:!0,ssrcId:t.video_ssrc}),t.audio_mute?this.emit(Lf.MUTE_AUDIO,{uid:t.uid}):this.emit(Lf.UNMUTE_AUDIO,{uid:t.uid}),t.video_mute?this.emit(Lf.MUTE_VIDEO,{uid:t.uid}):this.emit(Lf.UNMUTE_VIDEO,{uid:t.uid}),t.audio_enable_local?this.emit(Lf.ENABLE_LOCAL_AUDIO,{uid:t.uid}):this.emit(Lf.DISABLE_LOCAL_AUDIO,{uid:t.uid}),t.video_enable_local?this.emit(Lf.ENABLE_LOCAL_VIDEO,{uid:t.uid}):this.emit(Lf.DISABLE_LOCAL_VIDEO,{uid:t.uid}),t.audio||t.video||this.emit(Lf.ON_REMOVE_STREAM,{uid:t.uid,uint_id:t.uint_id})})),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){Av.debug("[".concat(this.clientId,"] receive notification: "),t);const e=yy(t.code);if("success"!==e.action){if("failed"!==e.action)return"quit"===e.action?("ERR_REPEAT_JOIN_CHANNEL"===e.desc&&this.close(Cf.UID_BANNED),void this.close()):void this.reconnect(e.action,If.SERVER_ERROR);Av.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=Gv("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(Av.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>Gv("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",If.TIMEOUT):this.request(Nf.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const t=Date.now()-e;this.rttRolling.add(t),Gv("REPORT_STATS")&&this.send(Nf.PING_BACK,{pingpongElapse:t})})).catch((t=>{}))}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:e}=this.websocket.getWsInflateData();0!==t&&0!==e&&this.upload(kf.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(Wf.RECONNECT_WAITTING_FINISH,(t=>{this.emit(Of.WS_RECONNECT_WAITTING_FINISH,t)})),this.websocket.on(Wf.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(Of.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(Wf.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Wf.CLOSED,(()=>{this.connectionState=Af.CLOSED})),this.websocket.on(Wf.FAILED,(()=>{this._disconnectedReason=Cf.NETWORK_ERROR,this.connectionState=Af.CLOSED})),this.websocket.on(Wf.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Af.CONNECTED?this.connectionState=Af.RECONNECTING:this.connectionState=Af.CONNECTING})),this.websocket.on(Wf.WILL_RECONNECT,((t,e)=>{if(ay(this,Of.IS_P2P_DISCONNECTED)&&"retry"===t)return Av.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Of.NEED_RENEW_SESSION),this.emit(Of.DISCONNECT_P2P),e("tryNext");"retry"!==t&&(Av.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(Of.NEED_RENEW_SESSION),this.emit(Of.DISCONNECT_P2P)),e(t)})),this.websocket.on(Wf.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{Av.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",If.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(Of.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof _v&&t.code===Ev.UNEXPECTED_RESPONSE&&t.data.code===yf.ERR_NO_AUTHORIZED)return Av.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",If.SERVER_ERROR);Av.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",If.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(Wf.REQUEST_NEW_URLS,((t,e)=>{sy(this,Of.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)})),this.websocket.on(Wf.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Lf.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}function Ay(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}class Oy extends gv{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){["tryNext","recover"].includes(t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,"reconnecting"===this._state?this.emit(FE.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(FE.CONNECTED):"closed"===this._state?this.emit(FE.CLOSED):"failed"===this._state&&this.emit(FE.FAILED))}constructor(t,e,i,n){super(),vp(this,"connectionID",0),vp(this,"currentURLIndex",0),vp(this,"reconnectReason",void 0),vp(this,"_reconnectMode","tryNext"),vp(this,"_initMutex",void 0),vp(this,"_name",void 0),vp(this,"_state","closed"),vp(this,"_reconnectInterrupter",void 0),vp(this,"_url",void 0),vp(this,"_retryConfig",void 0),vp(this,"_reconnectCount",0),vp(this,"_forceCloseTimeout",5e3),vp(this,"_onlineReconnectListener",void 0),vp(this,"_closeEstablishingTransmitter",(()=>{})),vp(this,"_store",void 0),vp(this,"_joinChannelServiceRecordIndex",void 0),vp(this,"_transmitter",void 0),vp(this,"_useCompress",void 0),vp(this,"_inflateLength",0),vp(this,"_deflateLength",0),this._store=n,this._name=t,this._retryConfig=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ay(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ay(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},e),this._useCompress=i}resetReconnectCount(t){Av.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const t=this._transmitter;e?setTimeout((()=>t.close()),500):t.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,e){if(!this._transmitter)return void Av.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;void 0!==t&&(this.reconnectMode=t),Av.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex&&(null===(i=this._store)||void 0===i||i.recordJoinChannelService({status:"error",errors:[new Error(e)]},this._joinChannelServiceRecordIndex));const n=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),n&&n.bind(this._transmitter)({code:9999,reason:e})}getInflateData(){const t=this._inflateLength,e=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:e}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}function Ny(t,e,i){if("getBigUint64"in DataView.prototype)return t.getBigUint64(e,i);const n=t.getUint32(e,i),s=t.getUint32(e+4,i),o=Number(!!i),r=Number(!i);return BigInt(n*r+s*o)<<BigInt(32)|BigInt(n*o+s*r)}function ky(t,e,i,n){if("setBigUint64"in DataView.prototype)return t.setBigUint64(e,i,n);const s=Number(i>>BigInt(32)),o=Number(i&BigInt(4294967295));n?(t.setUint32(e+4,s,n),t.setUint32(e,o,n)):(t.setUint32(e,s,n),t.setUint32(e+4,o,n))}let Ly;!function(t){t[t.Default=0]="Default",t[t.Ack=1]="Ack"}(Ly||(Ly={}));class Py{constructor(t,e,i){vp(this,"version",1),vp(this,"initialRTO",void 0),vp(this,"maxBatchAckCount",void 0),vp(this,"maxRTO",void 0),vp(this,"initialRTT",void 0),vp(this,"ID",void 0),vp(this,"rtt",void 0),vp(this,"packetNumber",1),vp(this,"rtoRatioMap",new Map),vp(this,"timeoutMap",new Map),vp(this,"unorderedPacketQueue",[]),vp(this,"batchAckPacketQueue",[]),vp(this,"lastOrderedPacketNumber",0),vp(this,"batchAckTimer",void 0),vp(this,"sendImpl",void 0),vp(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=e,this.ID=ZT(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:Gv("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:Gv("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:Gv("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:Gv("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:Gv("TRANSMITTER_MAX_RTO")}packetize(t,e){return{type:Ly.Default,version:this.version,packetNumber:e,payload:t}}serialize(t){switch(t.type){case Ly.Default:{let e;e="string"==typeof t.payload?(new TextEncoder).encode(t.payload):t.payload;const i=new ArrayBuffer(e.length+15),n=new DataView(i);return n.setUint16(0,t.version),n.setUint8(2,t.type),n.setUint32(3,t.packetNumber),ky(n,7,BigInt(t.sendTs)),new Uint8Array(n.buffer).set(e,15),i}case Ly.Ack:{const e=new ArrayBuffer(16),i=new DataView(e);return i.setUint16(0,t.version),i.setUint8(2,t.type),i.setUint32(3,t.maxAckPacketNumber),i.setUint8(7,t.shift),ky(i,8,BigInt(t.ackSendTs)),e}}}deserialize(t){const e=new DataView(t),i=e.getUint16(0),n=e.getUint8(2);switch(n){case Ly.Default:{const s=e.getUint32(3),o=Ny(e,7),r=t.slice(15),a=(new TextDecoder).decode(r);return{version:i,type:n,packetNumber:s,sendTs:Number(o),payload:a}}case Ly.Ack:{const t=e.getUint32(3),s=e.getUint8(7),o=Ny(e,8);return{version:i,type:n,maxAckPacketNumber:t,shift:s,ackSendTs:Number(o)}}default:throw Av.error("[".concat(this.ID,"] Unrecognized packet type ").concat(n)),new Error("Unrecognized packet type ".concat(n))}}sendMessage(t){const e=this.packetize(t,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(e),n=window.setTimeout((()=>{this.resendMessage(e)}),i);this.timeoutMap.set(e.packetNumber,n),this.sendPacket(e)}onData(t){const e=this.deserialize(t);e.type===Ly.Default?this.ack(e):e.type===Ly.Ack&&(this.updateRTT(e,Math.round(performance.now())),this.clearRTO(e))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((t=>{let[e,i]=t;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const e=this.calculateRTO(t),i=window.setTimeout((()=>{this.resendMessage(t)}),e);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}calculateRTO(t){const e=this.rtoRatioMap.get(t.packetNumber);if(void 0===e)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*e;return this.rtoRatioMap.set(t.packetNumber,e+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(t,e){const i=t.ackSendTs;this.rtt=this.rtt*(7/8)+(e-i-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const t=this.unorderedPacketQueue[0];if(!t){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(t.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Ly.Ack,version:this.version};this.sendPacket(e)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Ly.Ack,version:this.version};this.sendPacket(e)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Ly.Ack,version:this.version};this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===Ly.Default&&(t.sendTs=Math.round(performance.now()));const e=this.serialize(t);this.sendImpl(e)}clearRTO(t){for(let e=t.maxAckPacketNumber-t.shift;e<=t.maxAckPacketNumber;e++){const t=this.timeoutMap.get(e);void 0!==t&&window.clearTimeout(t),this.timeoutMap.delete(e),this.rtoRatioMap.delete(e)}}}class Dy extends Oy{constructor(t,e){super(t,e,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),vp(this,"_initMutex",void 0),vp(this,"_reconnectInterrupter",void 0),vp(this,"_url",void 0),vp(this,"_transmitter",void 0),vp(this,"_addresses",void 0),vp(this,"_reliableTransmission",void 0),this._initMutex=new US("datachannel");const{timeout:i,timeoutFactor:n}=e,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*n)/10);PE.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),yS.on(DE.NETWORK_STATE_CHANGE,((t,e)=>{t!==e&&(this.resetReconnectCount("network state change: ".concat(e," -> ").concat(t)),t===PE.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=e;const i=(e,i)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex((t=>t.fingerprint||Gv("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(e).catch(i),this.once(FE.CLOSED,(()=>i(new _v(Ev.WS_DISCONNECT)))),this.once(FE.CONNECTED,(()=>e()))};return this._initMutex.lock().then((t=>new _h(((t,e)=>{i(t,e)})).then((()=>{t()})).catch((()=>{t()}))))}sendMessage(t){let e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new _v(Ev.WS_ABORT,"datachannel is not ready");try{e||(t=JSON.stringify(t)),this._reliableTransmission.sendMessage(t)}catch(t){throw new _v(Ev.WS_ERR,"send datachannel signal message error"+t.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const e=JSON.stringify(t);return{compressed:e,compressedLength:e.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new _h(((e,i)=>{var n;const s=()=>{Av.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),e()},o=async t=>{var n;if(null===(n=this._closeEstablishingTransmitter)||void 0===n||n.call(this),Av.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const n=ry(this,FE.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,s=await this.reconnectWithAction(n);if("closed"===this.state)return void Av.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!s)return i(new _v(Ev.WS_DISCONNECT,"datachannel reconnect failed: ".concat(t.code))),void this.close(!0);e()}else i(new _v(Ev.WS_DISCONNECT,"datachannel close: ".concat(t.code))),this.close()},r=t=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.onData(t.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),Av.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const a=null===(n=this._store)||void 0===n?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),c=Date.now();sy(this,FE.TO_CONNECT_DATACHANNEL,t).then((t=>{var e,i;if(!t)throw new Error("transmissonInfo not exist yet");const{transmitter:n,close:l}=t;this._transmitter=n,null===(e=this._store)||void 0===e||e.signalChannelOpen();const d=Date.now()-c;Av.debug("[choose dc] dc open cost ".concat(d,"ms")),this._reliableTransmission=new Py((t=>{var e;this._transmitter&&"open"===this._transmitter.readyState&&(null===(e=this._transmitter)||void 0===e||e.send(t))}),(t=>{"string"==typeof t&&this.emit(FE.ON_MESSAGE,t)})),this._closeEstablishingTransmitter=()=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.close(),this._reliableTransmission=void 0,l()},s&&s(),n.onclose=o,n.onmessage=r,null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this._joinChannelServiceRecordIndex=a})).catch((t=>{var e;if(null===(e=this._store)||void 0===e||e.recordJoinChannelService({endTs:Date.now(),status:t instanceof _v&&t.code===Ev.WS_ABORT?"aborted":"error",errors:[t]},a),"closed"!==this.state){if(t instanceof _v&&t.code===Ev.WS_ERR){const e=new _v(Ev.WS_ERR,"init datachannel failed! Error: ".concat(t.toString()));return Av.error("[".concat(this._name,"]").concat(e)),void i(e)}o&&o(t)}else i(new _v(Ev.WS_DISCONNECT,"datachannel is closed: ".concat(t.toString())))}))}))}async reconnectWithAction(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||yS.networkState!==PE.OFFLINE||(this._onlineReconnectListener=yS.onlineWaiter&&yS.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},e){const e=bv(this._reconnectCount,this._retryConfig);Av.debug("[".concat(this._name,"] wait ").concat(e,"ms to reconnect datachannel, mode: ").concat(t)),await _h.race([XT(e),this._onlineReconnectListener||new _h((()=>{}))])}if("closed"===this.state||!i)return!1;this._reconnectCount+=1;const n=async(t,e)=>{this.emit(FE.RECONNECT_CREATE_CONNECTION,e),await this.createTransmitterConnection(t)};try{if("retry"===t){const e=this._addresses[this.currentURLIndex];this.emit(FE.RECONNECT_WAITTING_FINISH,t),await n(e,t)}else if("tryNext"===t){this.currentURLIndex+=1;for(let t=this.currentURLIndex;t<this._addresses.length;t++){if(this._addresses[t].fingerprint||Gv("FINGERPRINT")){this.currentURLIndex=t;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return Av.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);Av.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const e=this._addresses[this.currentURLIndex];this.emit(FE.RECONNECT_WAITTING_FINISH,t),await n(e,t)}else"recover"===t&&(Av.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(FE.RECONNECT_WAITTING_FINISH,t),this.emit(FE.FAILBACK));return!0}catch(i){var s;return Av.error("[".concat(this._name,"] reconnect failed"),i.toString()),null!=i&&null!==(s=i.data)&&void 0!==s&&s.desc&&Array.isArray(i.data.desc)&&i.data.desc.length&&i.data.desc.includes("dynamic key expired")?(this.emit(FE.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,e)}}}class My extends gv{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Af.CONNECTED?this.emit(Of.WS_CONNECTED):t===Af.RECONNECTING?this.emit(Of.WS_RECONNECTING,this._websocketReconnectReason):t===Af.CLOSED&&this.emit(Of.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),vp(this,"_disconnectedReason",void 0),vp(this,"_websocketReconnectReason",void 0),vp(this,"_connectionState",Af.CLOSED),vp(this,"reconnectToken",void 0),vp(this,"websocket",void 0),vp(this,"openConnectionTime",void 0),vp(this,"clientId",void 0),vp(this,"lastMsgTime",Date.now()),vp(this,"uploadCache",[]),vp(this,"uploadCacheInterval",void 0),vp(this,"rttRolling",new Ry(5)),vp(this,"pingpongTimer",void 0),vp(this,"inflateDataTimer",void 0),vp(this,"pingpongTimeoutCount",0),vp(this,"joinResponse",void 0),vp(this,"multiIpOption",void 0),vp(this,"initError",void 0),vp(this,"spec",void 0),vp(this,"store",void 0),vp(this,"onWebsocketMessage",(t=>{if(t instanceof ArrayBuffer)return void this.emit(Of.ON_BINARY_DATA,t);const e=JSON.parse(t);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(e,"_id")){const t="res-@".concat(e._id);this.emit(t,e._result,e._message)}else if(Object.prototype.hasOwnProperty.call(e,"_type")&&(this.emit(e._type,e._message),e._type===Lf.ON_NOTIFICATION&&this.handleNotification(e._message),e._type===Lf.ON_USER_BANNED))switch(e._message.error_code){case 14:this.close(Cf.UID_BANNED);break;case 15:this.close(Cf.IP_BANNED);break;case 16:this.close(Cf.CHANNEL_BANNED)}})),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new Dy("gateway-".concat(this.clientId),this.spec.retryConfig,!0,e),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Af.CONNECTED&&this.reconnect("retry",jE.OFFLINE)}))}async request(t,e,i,n){const s=ZT(6,""),o={_id:s,_type:t,_message:e},r=this.websocket.connectionID,a=()=>new _h(((e,i)=>{if(this.connectionState===Af.CONNECTED)return e();const n=()=>{this.off(Of.WS_CLOSED,s),e()},s=()=>{this.off(Of.WS_CONNECTED,n),i(new _v(Ev.WS_ABORT))};this.once(Of.WS_CONNECTED,n),this.once(Of.WS_CLOSED,s),t!==Nf.PUBLISH&&t!==Nf.SUBSCRIBE&&t!==Nf.UNSUBSCRIBE&&t!==Nf.UNPUBLISH&&t!==Nf.CONTROL&&t!==Nf.RESTART_ICE||this.once(Of.DISCONNECT_P2P,(()=>{i(new _v(Ev.DISCONNECT_P2P))})),t!==Nf.PUBLISH&&t!==Nf.RESTART_ICE||this.once(Of.ABORT_P2P_EXECUTION,(()=>{i(new _v(Ev.DISCONNECT_P2P))}))}));if(this.connectionState!==Af.CONNECTING&&this.connectionState!==Af.RECONNECTING||t===Nf.JOIN||t===Nf.REJOIN||await a(),t===Nf.LEAVE&&(this.websocket.unbindDcCloseEventListener(),n=!0),this.websocket.sendMessage(o,!0,!1),n)return;const c=new _h(((i,n)=>{let o=!1;const a=(n,s)=>{o=!0,i({isSuccess:"success"===n,message:s||{}}),this.off(Of.WS_CLOSED,c),this.off(Of.WS_RECONNECTING,c),this.emit(Of.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(s),a);const c=()=>{n(new _v(Ev.WS_ABORT,"type: ".concat(t))),this.off(Of.WS_CLOSED,c),this.off(Of.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once(Of.WS_CLOSED,c),this.once(Of.WS_RECONNECTING,c),XT(Gv("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||o||(Av.warning("dc request timeout, type: ".concat(t)),this.emit(Of.REQUEST_TIMEOUT,t,e))}))}));let l=null;try{l=await c}catch(n){if(this.connectionState===Af.CLOSED||t===Nf.LEAVE)throw new _v(Ev.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():t===Nf.JOIN||t===Nf.REJOIN?null:(await a(),await this.request(t,e))}if(l.isSuccess)return l.message;const d=Number(l.message.error_code||l.message.code),h=yy(d),u=new _v(Ev.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:d,data:l.message});return"success"===h.action?l.message:(Av.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(d,", message: ").concat(h.desc,", action: ").concat(h.action)),d===yf.ERR_TOO_MANY_BROADCASTERS?t===Nf.JOIN||t===Nf.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(d===yf.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,Av.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",jE.MULTI_IP)):this.reconnect(h.action,jE.SERVER_ERROR),t===Nf.JOIN||t===Nf.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new _h((i=>{const n=s=>{(!e||e(s))&&(this.off(t,n),i(s))};this.on(t,n)}))}upload(t,e){const i={_type:t,_message:e};try{this.websocket.sendMessage(i)}catch(t){const e=Gv("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>e&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Af.CONNECTED)return;const t=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(t._type,t._message)}),Gv("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const i={_type:t,_message:e};this.websocket.sendMessage(i)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new _h(((i,n)=>{this.once(Of.WS_CONNECTED,(()=>i(this.joinResponse))),this.once(Of.WS_CLOSED,(()=>n(this.initError||new _v(Ev.WS_ABORT)))),this.connectionState=Af.CONNECTING,this.websocket.init(t).catch(n),this.websocket.once(FE.FAILBACK,(()=>{void 0===this.openConnectionTime&&n(new _v(Ev.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{e&&void 0===this.openConnectionTime&&(Av.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),n(new _v(Ev.INIT_DATACHANNEL_TIMEOUT)))}),Gv("DC_JOIN_WITH_FAILBACK"))}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Cf.LEAVE,this.connectionState=Af.CLOSED,Av.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===Cf.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Dy("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(Of.ABORT_P2P_EXECUTION);const t=await sy(this,Of.DATACHANNEL_CONNECTING),e=await this.request(Nf.JOIN,t);if(!e)return this.emit(Of.REPORT_JOIN_GATEWAY,Ev.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(Of.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Af.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new _v(Ev.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=ay(this,Of.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(Nf.REJOIN,t);return!!e&&(this.connectionState=Af.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach((t=>{this.emit(Lf.ON_USER_ONLINE,{uid:t.uid}),t.audio&&this.emit(Lf.ON_ADD_AUDIO_STREAM,{uid:t.uid,uint_id:t.uint_id,audio:!0,ssrcId:t.audio_ssrc}),t.video&&this.emit(Lf.ON_ADD_VIDEO_STREAM,{uid:t.uid,uint_id:t.uint_id,video:!0,ssrcId:t.video_ssrc}),t.audio_mute?this.emit(Lf.MUTE_AUDIO,{uid:t.uid}):this.emit(Lf.UNMUTE_AUDIO,{uid:t.uid}),t.video_mute?this.emit(Lf.MUTE_VIDEO,{uid:t.uid}):this.emit(Lf.UNMUTE_VIDEO,{uid:t.uid}),t.audio_enable_local?this.emit(Lf.ENABLE_LOCAL_AUDIO,{uid:t.uid}):this.emit(Lf.DISABLE_LOCAL_AUDIO,{uid:t.uid}),t.video_enable_local?this.emit(Lf.ENABLE_LOCAL_VIDEO,{uid:t.uid}):this.emit(Lf.DISABLE_LOCAL_VIDEO,{uid:t.uid}),t.audio||t.video||this.emit(Lf.ON_REMOVE_STREAM,{uid:t.uid,uint_id:t.uint_id})})),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){Av.debug("[".concat(this.clientId,"] receive notification: "),t);const e=yy(t.code);if("success"!==e.action){if("failed"!==e.action)return"quit"===e.action?("ERR_REPEAT_JOIN_CHANNEL"===e.desc&&this.close(Cf.UID_BANNED),void this.close()):void this.reconnect(e.action,jE.SERVER_ERROR);Av.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=Gv("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(Av.warning("PINGPONG Timeout. Last Socket Message: ".concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>Gv("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",jE.TIMEOUT):this.request(Nf.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const t=Date.now()-e;this.rttRolling.add(t),Gv("REPORT_STATS")&&this.send(Nf.PING_BACK,{pingpongElapse:t})})).catch((t=>{}))}handleInflateData(){const{inflateLength:t,deflateLength:e}=this.websocket.getInflateData();0!==t&&0!==e&&this.upload(kf.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(FE.RECONNECT_WAITTING_FINISH,(t=>{this.emit(Of.WS_RECONNECT_WAITTING_FINISH,t)})),this.websocket.on(FE.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(Of.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(FE.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(FE.CLOSED,(()=>{this.connectionState=Af.CLOSED})),this.websocket.on(FE.FAILED,(()=>{this._disconnectedReason=Cf.NETWORK_ERROR,this.connectionState=Af.CLOSED})),this.websocket.on(FE.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Af.CONNECTED?this.connectionState=Af.RECONNECTING:this.connectionState=Af.CONNECTING})),this.websocket.on(FE.WILL_RECONNECT,((t,e)=>{if(ay(this,Of.IS_P2P_DISCONNECTED)&&"retry"===t)return Av.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Of.NEED_RENEW_SESSION),this.emit(Of.DISCONNECT_P2P),e("tryNext");"retry"!==t&&(Av.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(Of.NEED_RENEW_SESSION),this.emit(Of.DISCONNECT_P2P)),e(t)})),this.websocket.on(FE.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{Av.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",jE.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(Of.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof _v&&t.code===Ev.UNEXPECTED_RESPONSE&&t.data.code===yf.ERR_NO_AUTHORIZED)return Av.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",jE.SERVER_ERROR);Av.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",jE.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(FE.REQUEST_NEW_URLS,((t,e)=>{sy(this,Of.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)})),this.websocket.on(FE.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Lf.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(FE.TO_CONNECT_DATACHANNEL,(async(t,e,i)=>sy(this,Of.DATACHANNEL_PRECONNECT,t).then(e).catch(i))),this.websocket.on(FE.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(Of.DATACHANNEL_FAILBACK)}))}}function xy(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Uy(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?xy(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):xy(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}const Vy=new Map;class By extends gv{get state(){return this._state}set state(t){if(t===this._state)return;const e=this._state;this._state=t,"DISCONNECTED"===t&&this._disconnectedReason?this.emit(cE.CONNECTION_STATE_CHANGE,t,e,this._disconnectedReason):this.emit(cE.CONNECTION_STATE_CHANGE,t,e)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){Av.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,e){super(),vp(this,"store",void 0),vp(this,"joinInfo",void 0),vp(this,"key",void 0),vp(this,"signal",void 0),vp(this,"role",void 0),vp(this,"inChannelInfo",{joinAt:null,duration:0}),vp(this,"spec",void 0),vp(this,"_state","DISCONNECTED"),vp(this,"_statsCollector",void 0),vp(this,"_disconnectedReason",void 0),vp(this,"isSignalRecover",!1),vp(this,"hasChangeBGPAddress",!1),vp(this,"trafficStatsInterval",void 0),vp(this,"networkQualityInterval",void 0),vp(this,"_joinGatewayStartTime",0),vp(this,"_signalTimeout",!1),vp(this,"_clientRoleOptions",void 0),vp(this,"_isProactiveJoin",!1),this.store=t,this.spec=e,this.signal=this.store.useDataChannel?new My(Uy(Uy({},e),{},{retryConfig:e.websocketRetryConfig}),t):new Iy(Uy(Uy({},e),{},{retryConfig:e.websocketRetryConfig}),t),this._statsCollector=e.statsCollector,this.role=e.role||"audience",this._clientRoleOptions=e.clientRoleOptions,this.handleSignalEvents()}async join(t,e,i){if(this.signal instanceof My){let e=!1;"disabled"!==t.cloudProxyServer?(Av.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),e=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(Av.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),e=!0):t.apResponse.addresses.some((t=>t.fingerprint))||Gv("FINGERPRINT")||(Av.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),e=!0),e&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==t.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const n=Date.now();let s=Vy.get(t.cname);if(s||(s=new Map,Vy.set(t.cname,s)),this._isProactiveJoin=!0,s.has(t.uid)){const e=new _v(Ev.UID_CONFLICT);throw PS.joinGateway(t.sid,{lts:n,succ:!1,ec:e.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof My?"1":"0"}),this._isProactiveJoin=!1,e}s.set(t.uid,!0),this.joinInfo=t,this.key=e;let o=0;this.joinGatewayStartTime=n;const r=t.proxyServer;try{let e;if(Av.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof My?"datachannel":"websocket"," join uid ").concat(o)),this.signal instanceof My)e=await this.signal.init(t.apResponse.addresses,i);else{const n=t.proxyServer,s=n?t.gatewayAddrs.map((t=>{const e=t.address.split(":");return"wss://".concat(n,"/ws/?h=").concat(e[0],"&p=").concat(e[1])})):t.gatewayAddrs.map((t=>"wss://".concat(t.address)));e=await this.signal.init(s,i)}o=e.uid,Av.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof My?"datachannel":"websocket"," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(e){if(e&&e.code===Ev.INIT_WEBSOCKET_TIMEOUT)throw Av.warning("[".concat(this.store.clientId,"] User join failed"),e.toString()),e;if(e&&e.code===Ev.INIT_DATACHANNEL_TIMEOUT)throw Av.warning("[".concat(this.store.clientId,"] User join datachannel failed"),e.toString()),this.resetSignal(),e;throw Av.error("[".concat(this.store.clientId,"] User join failed"),e.toString()),PS.joinGateway(t.sid,{lts:n,succ:!1,ec:e.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!r,signalChannel:this.signal instanceof My?"1":"0"}),this._isProactiveJoin=!1,s.delete(t.uid),this.signal.close(),e}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),Av.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((t=>{Av.warning("[".concat(this.store.clientId,"] get traffic stats error"),t.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(cE.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(cE.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(cE.NETWORK_QUALITY,{uplinkNetworkQuality:GT(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:GT(this._statsCollector.trafficStats.B_dnq)}):this.emit(cE.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),o}async leave(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){e!==Cf.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==Af.CONNECTED||await function(t,e){return e===1/0?t:_h.race([t,QT(e)])}(this.signal.request(Nf.LEAVE,void 0,!0),3e3)}catch(t){Av.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),t)}this.signal.close(e),e!==Cf.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new _v(Ev.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const n={state:"offer",p2p_id:this.store.p2pId,ortc:e,mode:this.spec.mode,extend:Gv("PUB_EXTEND"),twcc:!!Gv("PUBLISH_TWCC"),rtx:!!Gv("USE_PUB_RTX")};try{return(await this.signal.request(Nf.PUBLISH,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===yf.ERR_PUBLISH_REQUEST_INVALID)return Av.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),n.toString()),await this.tryUnpubBeforeRepub(t,e),this.publish(t,e,!1);throw n}}async unpublish(t,e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new _v(Ev.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Nf.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(t){Av.warning("[".concat(this.store.clientId,"] unpublish warning: "),t)}}async subscribe(t,e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new _v(Ev.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const n={stream_id:t,stream_type:e.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Gv("SUBSCRIBE_TWCC"),rtx:!!Gv("USE_SUB_RTX"),extend:Gv("SUB_EXTEND"),ssrcId:e.ssrcId,svc:Array.isArray(Gv("SVC"))&&0!==Gv("SVC").length?Gv("SVC"):void 0};try{return(await this.signal.request(Nf.SUBSCRIBE,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===yf.ERR_SUBSCRIBE_REQUEST_INVALID)return Av.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),n.toString()),await this.tryUnsubBeforeResub(t,e),await this.subscribe(t,e,!1);throw n}}async subscribeAll(t,e){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new _v(Ev.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!Gv("USE_SUB_RTX")};try{return await this.signal.request(Nf.SUBSCRIBE_STREAMS,i,!0)}catch(i){if(e&&i.data&&i.data.code===yf.ERR_SUBSCRIBE_REQUEST_INVALID)return Av.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),i.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw i}}async setVideoProfile(t){const e=function(t){if(!(t.bitrateMax&&t.bitrateMin&&t.frameRate&&t.height&&t.width))return;let e=t.frameRate,i=t.width,n=t.height,s=!0;return"number"!=typeof e&&(e=e.exact||e.ideal||e.max||e.min||0,e||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,e||(s=!1)),s?{stream_type:0,width:i,height:n,fps:e,start_bps:1e3*t.bitrateMax,min_bps:1e3*t.bitrateMin,target_bps:1e3*t.bitrateMax}:void 0}(t);if(e)return this.signal.request(Nf.SET_VIDEO_PROFILE,e);Av.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,e){try{await this.signal.request(Nf.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:e},!0)}catch(t){Av.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),t)}}async massUnsubscribe(t){try{await this.signal.request(Nf.UNSUBSCRIBE_STREAMS,t,!0)}catch(t){Av.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),t)}}async reconnectPC(t){const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=t;return{gatewayEstablishParams:await this.signal.request(Nf.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Nf.GATEWAY_INFO)}async renewToken(t){await this.signal.request(Nf.RENEW_TOKEN,t),this.key=t.token}async setClientRole(t,e){if(e&&(this._clientRoleOptions=Object.assign({},e)),"CONNECTED"!==this.state)return void(this.role=t);let i;i="audience"===t?this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:0,await this.signal.request(Nf.SET_CLIENT_ROLE,{role:t,level:i,client_ts:Date.now()}),this.role=t}async setRemoteVideoStreamType(t,e){await this.signal.request(Nf.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:e})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(Nf.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,e){await this.signal.request(Nf.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:e})}async pickSVCLayer(t,e){await this.signal.request(Nf.PICK_SVC_LAYER,{stream_id:t,spatial_layer:e.spatialLayer,temporal_layer:e.temporalLayer})}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Uy({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(Nf.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=Vy.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(t){let e;return e=t.startsWith("dc")?t.match(/(dc\:\/\/)?([^:]+):(\d+)/):t.match(/(wss\:\/\/)?([^:]+):(\d+)/),e?{username:Pv.username,password:Pv.password,turnServerURL:e[2],tcpport:parseInt(e[3])+30,udpport:parseInt(e[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(Uy(Uy({},Pv),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const t=await this.signal.request(Nf.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.peer_delay.forEach((t=>{const e=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((e=>e.peer_uid===t.peer_uid));e&&e.B_st!==t.B_st&&dy((()=>{this.emit(cE.STREAM_TYPE_CHANGE,t.peer_uid,t.B_st)}))})),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){if(!this.joinInfo||!this.key)throw new _v(Ev.UNEXPECTED_ERROR,"can not generate join message, no join info");const e=Object.assign({},this.joinInfo.apResponse);let i=Gv("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(t){i=void 0}i&&i.length>128&&(i=void 0);const n=Uy({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Nv,browser:navigator.userAgent,process_id:Gv("PROCESS_ID"),mode:this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:e,extend:Gv("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:Gv("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:Gv("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof Gv("SUBSCRIBE_AUDIO_FILTER_TOPN")?Gv("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof Gv("ENABLE_PUBLISH_AUDIO_FILTER")?Gv("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof Gv("ENABLE_USER_LICENSE_CHECK")?Gv("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===Gv("USE_PUB_RTX")||!0===Gv("USE_SUB_RTX")||void 0}},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,Gv("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),e.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=e.addresses[this.signal.websocket.currentURLIndex].ticket,delete e.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new _v(Ev.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Of.WS_RECONNECT_WAITTING_FINISH,(t=>{["tryNext","recover"].includes(t)&&this.joinInfo&&PS.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(Of.WS_RECONNECT_CREATE_CONNECTION,(t=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(Of.WS_RECONNECTING,(t=>{this.joinInfo&&PS.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||If.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",PS.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(Of.WS_CLOSED,(t=>{let e;switch(t){case Cf.LEAVE:e=If.LEAVE;break;case Cf.UID_BANNED:case Cf.IP_BANNED:case Cf.CHANNEL_BANNED:case Cf.SERVER_ERROR:e=If.SERVER_ERROR;break;case Cf.FALLBACK:e=If.FALLBACK;break;case Cf.LICENSE_MISSING:case Cf.LICENSE_EXPIRED:case Cf.LICENSE_MINUTES_EXCEEDED:case Cf.LICENSE_PERIOD_INVALID:case Cf.LICENSE_MULTIPLE_SDK_SERVICE:case Cf.LICENSE_ILLEGAL:e=t;break;default:e=If.NETWORK_ERROR}Av.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(e||"undefined -> "+If.NETWORK_ERROR)),this.joinInfo&&PS.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===Cf.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e}),this._disconnectedReason=t,t!==Cf.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(Of.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&this._clientRoleOptions.level&&(Av.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions&&this._clientRoleOptions.level)),this.setClientRole(this.role,this._clientRoleOptions)),PS.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof My?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void Av.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));Hv("EVENT_REPORT_DOMAIN",t[1]),Hv("EVENT_REPORT_BACKUP_DOMAIN",t[1]),Hv("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}})),this.signal.on(Lf.ON_UPLINK_STATS,(t=>{this._statsCollector.updateUplinkStats(t)})),this.signal.on(Of.REQUEST_RECOVER,((t,e,i)=>{if(!this.joinInfo)return i(new _v(Ev.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,sy(this,cE.REQUEST_NEW_GATEWAY_LIST).then(e).catch(i)})),this.signal.on(Of.REQUEST_JOIN_INFO,(async t=>{var e;this.updateTurnConfigFromSignal();const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await sy(this,cE.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(e=this.joinInfo)||void 0===e?void 0:e.turnServer});t(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on(Of.REQUEST_REJOIN_INFO,(t=>{t(this.getRejoinMessage())})),this.signal.on(Of.REPORT_JOIN_GATEWAY,((t,e)=>{this.joinInfo&&(PS.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:t,addr:e,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof My?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(Of.IS_P2P_DISCONNECTED,(t=>{t(ay(this,cE.IS_P2P_DISCONNECTED))})),this.signal.on(Of.DISCONNECT_P2P,(()=>{this.emit(cE.DISCONNECT_P2P)})),this.signal.on(Of.NEED_RENEW_SESSION,(()=>{this.emit(cE.NEED_RENEW_SESSION)})),this.signal.on(Of.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(Of.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(Of.JOIN_RESPONSE,(t=>{const e=this.getCurrentGatewayAddress();this.emit(cE.JOIN_RESPONSE,t,e)})),this.signal.on(Of.DATACHANNEL_PRECONNECT,(async(t,e,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return sy(this,cE.DATACHANNEL_PRECONNECT,t,n).then(e).catch(i)})),this.signal.on(Of.DATACHANNEL_CONNECTING,(async t=>{const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=await sy(this,cE.REQUEST_DC_CONNECTION_PARAMS);t(this.getJoinMessage({ortc:{iceParameters:e,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on(Of.DATACHANNEL_FAILBACK,(()=>{Av.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(cE.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(t,e){try{await this.signal.request(Nf.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[e]},!0)}catch(t){throw Av.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),t),t}}async tryUnpubBeforeRepub(t,e){try{await this.signal.request(Nf.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(t){throw Av.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),t),t}}async tryMassUnsubBeforeResub(t){const e={users:t.map((t=>({stream_id:t.stream_id,stream_type:t.stream_type})))};try{await this.signal.request(Nf.UNSUBSCRIBE_STREAMS,e,!0)}catch(t){throw Av.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),t),t}}async muteLocal(t,e){const i={action:t.find((t=>t.stream_type===aE.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(Nf.CONTROL,i,!0,!0)}catch(t){throw Av.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),t),t}}async unmuteLocal(t,e){const i={action:t.find((t=>t.stream_type===aE.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(Nf.CONTROL,i,!0,!0)}catch(t){throw Av.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),t),t}}uploadStats(t,e){this.signal.upload(t,e)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const e={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(Nf.RESTART_ICE,e,!0)}catch(t){throw Av.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),t),t}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,If.P2P_FAILED)}getCurrentGatewayAddress(){var t;if(!Gv("GATEWAY_WSS_ADDRESS"))return null!==(t=this.joinInfo)&&void 0!==t&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(Nf.SET_PARAMETER,{enablePublishAudioFilter:t})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Cf.FALLBACK)),this.store.useDataChannel=!1,this.signal=new Iy(Uy(Uy({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(cE.RESET_SIGNAL,dE.websocket)}}
/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */!function(){var t;function i(t){var e=0;return function(){return e<t.length?{done:!1,value:t[e++]}:{done:!0}}}var n,s="function"==typeof Object.defineProperties?Object.defineProperty:function(t,e,i){return t==Array.prototype||t==Object.prototype||(t[e]=i.value),t},o=function(t){t=["object"==typeof globalThis&&globalThis,t,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof e&&e];for(var i=0;i<t.length;++i){var n=t[i];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);function r(t,e){if(e)t:{var i=o;t=t.split(".");for(var n=0;n<t.length-1;n++){var r=t[n];if(!(r in i))break t;i=i[r]}(e=e(n=i[t=t[t.length-1]]))!=n&&null!=e&&s(i,t,{configurable:!0,writable:!0,value:e})}}function a(t){return(t={next:t})[Symbol.iterator]=function(){return this},t}function c(t){var e="undefined"!=typeof Symbol&&Symbol.iterator&&t[Symbol.iterator];return e?e.call(t):{next:i(t)}}if(r("Symbol",(function(t){function e(t,e){this.A=t,s(this,"description",{configurable:!0,writable:!0,value:e})}if(t)return t;e.prototype.toString=function(){return this.A};var i="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",n=0;return function t(s){if(this instanceof t)throw new TypeError("Symbol is not a constructor");return new e(i+(s||"")+"_"+n++,s)}})),r("Symbol.iterator",(function(t){if(t)return t;t=Symbol("Symbol.iterator");for(var e="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),n=0;n<e.length;n++){var r=o[e[n]];"function"==typeof r&&"function"!=typeof r.prototype[t]&&s(r.prototype,t,{configurable:!0,writable:!0,value:function(){return a(i(this))}})}return t})),"function"==typeof Object.setPrototypeOf)n=Object.setPrototypeOf;else{var l;t:{var d={};try{d.__proto__={a:!0},l=d.a;break t}catch(t){}l=!1}n=l?function(t,e){if(t.__proto__=e,t.__proto__!==e)throw new TypeError(t+" is not extensible");return t}:null}var h=n;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(t){if(t.m)throw new TypeError("Generator is already running");t.m=!0}function m(t,e){return t.h=3,{value:e}}function v(t){this.g=new u,this.G=t}function g(t,e,i,n){try{var s=e.call(t.g.j,i);if(!(s instanceof Object))throw new TypeError("Iterator result "+s+" is not an object");if(!s.done)return t.g.m=!1,s;var o=s.value}catch(e){return t.g.j=null,t.g.s(e),f(t)}return t.g.j=null,n.call(t.g,o),f(t)}function f(t){for(;t.g.h;)try{var e=t.G(t.g);if(e)return t.g.m=!1,{value:e.value,done:!1}}catch(e){t.g.v=void 0,t.g.s(e)}if(t.g.m=!1,t.g.l){if(e=t.g.l,t.g.l=null,e.F)throw e.D;return{value:e.return,done:!0}}return{value:void 0,done:!0}}function E(t){this.next=function(e){return t.o(e)},this.throw=function(e){return t.s(e)},this.return=function(e){return function(t,e){p(t.g);var i=t.g.j;return i?g(t,"return"in i?i.return:function(t){return{value:t,done:!0}},e,t.g.return):(t.g.return(e),f(t))}(t,e)},this[Symbol.iterator]=function(){return this}}function _(t,e){return e=new E(new v(e)),h&&t.prototype&&h(e,t.prototype),e}if(u.prototype.o=function(t){this.v=t},u.prototype.s=function(t){this.l={D:t,F:!0},this.h=this.C||this.u},u.prototype.return=function(t){this.l={return:t},this.h=this.u},v.prototype.o=function(t){return p(this.g),this.g.j?g(this,this.g.j.next,t,this.g.o):(this.g.o(t),f(this))},v.prototype.s=function(t){return p(this.g),this.g.j?g(this,this.g.j.throw,t,this.g.o):(this.g.s(t),f(this))},r("Array.prototype.entries",(function(t){return t||function(){return function(t,e){t instanceof String&&(t+="");var i=0,n=!1,s={next:function(){if(!n&&i<t.length){var s=i++;return{value:e(s,t[s]),done:!1}}return n=!0,{done:!0,value:void 0}}};return s[Symbol.iterator]=function(){return s},s}(this,(function(t,e){return[t,e]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var S=function(t,e){for(var i=0;i<t.length;i++)e(t[i])},b=function(t){return t.replace(/\r?\n|\r/g,"\r\n")},T=function(t,e,i){return e instanceof Blob?(i=void 0!==i?String(i+""):"string"==typeof e.name?e.name:"blob",e.name===i&&"[object Blob]"!==Object.prototype.toString.call(e)||(e=new File([e],i)),[String(t),e]):[String(t),String(e)]},y=function(t,e){if(t.length<e)throw new TypeError(e+" argument required, but only "+t.length+" present.")},w="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,C=w.FormData,R=w.XMLHttpRequest&&w.XMLHttpRequest.prototype.send,I=w.Request&&w.fetch,A=w.navigator&&w.navigator.sendBeacon,O=w.Element&&w.Element.prototype,N=w.Symbol&&Symbol.toStringTag;N&&(Blob.prototype[N]||(Blob.prototype[N]="Blob"),"File"in w&&!File.prototype[N]&&(File.prototype[N]="File"));try{new File([],"")}catch(t){w.File=function(t,e,i){return t=new Blob(t,i||{}),Object.defineProperties(t,{name:{value:e},lastModified:{value:+(i&&void 0!==i.lastModified?new Date(i.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),N&&Object.defineProperty(t,N,{value:"File"}),t}}var k=function(t){return t.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},L=function(t){this.i=[];var e=this;t&&S(t.elements,(function(t){if(t.name&&!t.disabled&&"submit"!==t.type&&"button"!==t.type&&!t.matches("form fieldset[disabled] *"))if("file"===t.type){var i=t.files&&t.files.length?t.files:[new File([],"",{type:"application/octet-stream"})];S(i,(function(i){e.append(t.name,i)}))}else"select-multiple"===t.type||"select-one"===t.type?S(t.options,(function(i){!i.disabled&&i.selected&&e.append(t.name,i.value)})):"checkbox"===t.type||"radio"===t.type?t.checked&&e.append(t.name,t.value):(i="textarea"===t.type?b(t.value):t.value,e.append(t.name,i))}))};if((t=L.prototype).append=function(t,e,i){y(arguments,2),this.i.push(T(t,e,i))},t.delete=function(t){y(arguments,1);var e=[];t=String(t),S(this.i,(function(i){i[0]!==t&&e.push(i)})),this.i=e},t.entries=function t(){var e,i=this;return _(t,(function(t){if(1==t.h&&(e=0),3!=t.h)return e<i.i.length?t=m(t,i.i[e]):(t.h=0,t=void 0),t;e++,t.h=2}))},t.forEach=function(t,e){y(arguments,1);for(var i=c(this),n=i.next();!n.done;n=i.next()){var s=c(n.value);n=s.next().value,s=s.next().value,t.call(e,s,n,this)}},t.get=function(t){y(arguments,1);var e=this.i;t=String(t);for(var i=0;i<e.length;i++)if(e[i][0]===t)return e[i][1];return null},t.getAll=function(t){y(arguments,1);var e=[];return t=String(t),S(this.i,(function(i){i[0]===t&&e.push(i[1])})),e},t.has=function(t){y(arguments,1),t=String(t);for(var e=0;e<this.i.length;e++)if(this.i[e][0]===t)return!0;return!1},t.keys=function t(){var e,i,n,s=this;return _(t,(function(t){if(1==t.h&&(e=c(s),i=e.next()),3!=t.h)return i.done?void(t.h=0):(n=i.value,m(t,c(n).next().value));i=e.next(),t.h=2}))},t.set=function(t,e,i){y(arguments,2),t=String(t);var n=[],s=T(t,e,i),o=!0;S(this.i,(function(e){e[0]===t?o&&(o=!n.push(s)):n.push(e)})),o&&n.push(s),this.i=n},t.values=function t(){var e,i,n,s,o=this;return _(t,(function(t){if(1==t.h&&(e=c(o),i=e.next()),3!=t.h)return i.done?void(t.h=0):(n=i.value,(s=c(n)).next(),m(t,s.next().value));i=e.next(),t.h=2}))},L.prototype._asNative=function(){for(var t=new C,e=c(this),i=e.next();!i.done;i=e.next()){var n=c(i.value);i=n.next().value,n=n.next().value,t.append(i,n)}return t},L.prototype._blob=function(){var t="----formdata-polyfill-"+Math.random(),e=[],i="--"+t+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(t,n){return"string"==typeof t?e.push(i+k(b(n))+'"\r\n\r\n'+b(t)+"\r\n"):e.push(i+k(b(n))+'"; filename="'+k(t.name)+'"\r\nContent-Type: '+(t.type||"application/octet-stream")+"\r\n\r\n",t,"\r\n")})),e.push("--"+t+"--"),new Blob(e,{type:"multipart/form-data; boundary="+t})},L.prototype[Symbol.iterator]=function(){return this.entries()},L.prototype.toString=function(){return"[object FormData]"},O&&!O.matches&&(O.matches=O.matchesSelector||O.mozMatchesSelector||O.msMatchesSelector||O.oMatchesSelector||O.webkitMatchesSelector||function(t){for(var e=(t=(this.document||this.ownerDocument).querySelectorAll(t)).length;0<=--e&&t.item(e)!==this;);return-1<e}),N&&(L.prototype[N]="FormData"),R){var P=w.XMLHttpRequest.prototype.setRequestHeader;w.XMLHttpRequest.prototype.setRequestHeader=function(t,e){P.call(this,t,e),"content-type"===t.toLowerCase()&&(this.B=!0)},w.XMLHttpRequest.prototype.send=function(t){t instanceof L?(t=t._blob(),this.B||this.setRequestHeader("Content-Type",t.type),R.call(this,t)):R.call(this,t)}}I&&(w.fetch=function(t,e){return e&&e.body&&e.body instanceof L&&(e.body=e.body._blob()),I.call(this,t,e)}),A&&(w.navigator.sendBeacon=function(t,e){return e instanceof L&&(e=e._asNative()),A.call(this,t,e)}),w.FormData=L}}();const jy=()=>{const t=Gv("AREAS");return 0===t.length&&t.push(_E.GLOBAL),Xi(t).call(t,((t,e,i)=>{const n=Fy(e);return n?0===i?n:"".concat(t,",").concat(n):t}),"")},Fy=t=>t===_E.OVERSEA?"".concat(yE.ASIA,",").concat(yE.EUROPE,",").concat(yE.AFRICA,",").concat(yE.NORTH_AMERICA,",").concat(yE.SOUTH_AMERICA,",").concat(yE.OCEANIA):yE[t],Hy=t=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map((t=>{const i=wE[t],n=Object.keys(i);n&&n.map((t=>{"CODE"!==t&&(e[t]=e[t].concat(i[t]))}))})),e},Gy={GLOBAL:{ASIA:[_E.CHINA,_E.JAPAN,_E.INDIA,_E.KOREA,_E.HKMC],EUROPE:[],NORTH_AMERICA:[_E.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},$y=Object.keys(Gy[_E.GLOBAL]),Wy=[_E.CHINA,_E.NORTH_AMERICA,_E.EUROPE,_E.ASIA,_E.JAPAN,_E.INDIA,_E.OCEANIA,_E.SOUTH_AMERICA,_E.AFRICA,_E.KOREA,_E.HKMC,_E.US],zy=function(t,e){let i=[];if(t.includes(_E.GLOBAL)){const o=[_E.GLOBAL,_E.OVERSEA],r=Object.keys(wE);if(e===_E.GLOBAL)throw new _v(Ev.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===_E.CHINA)i=[_E.OVERSEA];else if(s=e,$y.includes(s)){const t=(n=e,Gy[_E.GLOBAL][n]||[]),s=[...o,e,...t];i=r.filter((t=>!s.includes(t)))}else if(function(t){let e=!1;return $y.forEach((i=>{Gy[_E.GLOBAL][i].includes(t)&&(e=!0)})),e}(e)){const t=function(t){let e;return $y.forEach((i=>{Gy[_E.GLOBAL][i].includes(t)&&(e=i)})),e}(e),n=[...o,t,e];i=r.filter((t=>!n.includes(t)))}else i=t;i=function(t){const e=[];return Wy.forEach((i=>{t.includes(i)&&e.push(i)})),e.concat(t.filter((t=>!Wy.includes(t))))}(i)}else i=t;var n,s;return i};function Ky(t){if(!t&&Gv("AREAS").includes(_E.EXTENSIONS))return Av.debug("update area from ap : reset"),void qy(Lv,!0);if(!Gv("AREAS").includes(_E.GLOBAL)||!t)return;let e=wE.EXTENSIONS;e&&(e={CODE:Fy(_E.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},Av.debug("update area from ap success: ".concat(t,",config is "),e),Hv("AREAS",[_E.EXTENSIONS],!0),Object.keys(e).map((t=>{Hv(t,"LOG_UPLOAD_SERVER"===t||"EVENT_REPORT_DOMAIN"===t||"EVENT_REPORT_BACKUP_DOMAIN"===t||"PROXY_SERVER_TYPE3"===t?e[t][0]:e[t])})))}function qy(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=PS.reportApiInvoke(null,{name:vf.SET_AREA,options:t,tag:gf.TRACER});try{let n=[];if("string"==typeof t&&(n=[t]),Array.isArray(t)&&(t.forEach((t=>{if(!TE.includes(t))throw new _v(Ev.INVALID_PARAMS,"invalid area code")})),n=t),"[object Object]"===Object.prototype.toString.call(t)){const{areaCode:e,excludedArea:i}=t;if(!e)throw new _v(Ev.INVALID_PARAMS,"area code is needed");let s=e;"string"==typeof e&&(s=[e]),n=i?zy(s,i):s}if(!e){if(Wv.AREAS){const t=new _v(Ev.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(t),void Av.warning("setArea is prohibited because of config-distribute")}if(n.includes(_E.GLOBAL)&&Gv("AREAS")===_E.EXTENSIONS){const t=new _v(Ev.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(t),void Av.warning("setArea is prohibited because of ap extensions")}}Hv("AREAS",n,e);const s=Hy(n);Object.keys(s).map((t=>{Hv(t,"LOG_UPLOAD_SERVER"===t||"EVENT_REPORT_DOMAIN"===t||"EVENT_REPORT_BACKUP_DOMAIN"===t||"PROXY_SERVER_TYPE3"===t?s[t][0]:s[t])})),Av.debug("set area success:",n.join(","))}catch(t){throw i.onError(t),t}i.onSuccess()}function Yy(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Jy(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Yy(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Yy(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let Xy=1;function Qy(t,e,i,n,s){Xy+=1;const o={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:Xy,requestId:Xy,version:Nv,cname:i.cname},r={service_name:e,json_body:JSON.stringify(o)};let a,c,l=t[0];return Tv((async()=>{a=Date.now();const t=await bS(l,{data:r,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,0!==t.code){const e=new _v(Ev.UNEXPECTED_RESPONSE,"live streaming ap error, code"+t.code,{retry:!0,responseTime:c});throw Av.error(e.toString()),e}const i=JSON.parse(t.json_body);if(200!==i.code){const t=new _v(Ev.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:c});throw Av.error(t.toString()),t}if(!i.servers||0===i.servers.length){const t=new _v(Ev.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:c});throw Av.error(t.toString()),t}const s=function(t,e){return{addressList:t.servers.map((t=>"wss://".concat(t.address.replace(/\./g,"-"),".").concat(Gv("WORKER_DOMAIN"),":").concat(t.wss,"?serviceName=").concat(encodeURIComponent(e)))),workerToken:t.workerToken,vid:t.vid}}(i,e);return Gv("LIVE_STREAMING_ADDRESS")&&(s.addressList=Gv("LIVE_STREAMING_ADDRESS")instanceof Array?Gv("LIVE_STREAMING_ADDRESS"):[Gv("LIVE_STREAMING_ADDRESS")]),Jy(Jy({},s),{},{responseTime:c})}),((n,s)=>(PS.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(n.addressList),firstSuccess:0===s,responseTime:c,serverIp:t[s%t.length]}),!1)),((n,s)=>(PS.apworkerEvent(i.sid,{success:!1,sc:n.data&&n.data.code||200,serviceName:e,responseTime:c,serverIp:t[s%t.length]}),!!(n.code!==Ev.OPERATION_ABORTED&&n.code!==Ev.UNEXPECTED_RESPONSE||n.data&&n.data.retry)&&(l=t[(s+1)%t.length],!0))),s)}let Zy=1;function tw(t,e,i,n){let{url:s,areaCode:o}=t;const r=Date.now();let a;const[c,l]=ow(e,o,[JE.CHOOSE_SERVER]);let d=yS.networkState;return Tv((async()=>{d&&yS.networkState===PE.OFFLINE&&yS.onlineWaiter&&await _h.race([yS.onlineWaiter,XT(n&&n.maxRetryTimeout||Sv.maxRetryTimeout)]),d=yS.networkState;const{data:t,headers:o}=await bS(s,{data:c,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a="1"===o.http3?1:-1,PS.reportResourceTiming(s,e.sid),iw(t,s,e,r,[JE.CHOOSE_SERVER],a);const l=$T(t,JE.CHOOSE_SERVER);return nw(l),jT(l,s)}),(t=>(t&&PS.joinChooseServer(e.sid,{lts:r,succ:!0,csAddr:s,opid:l,serverList:t.gatewayAddrs.map((t=>t.address)),ec:null,cid:t.cid.toString(),uid:t.uid.toString(),csIp:t.csIp,unilbsServerIds:[JE.CHOOSE_SERVER].toString(),isHttp3:a}),!1)),(t=>t.code!==Ev.OPERATION_ABORTED&&(t.code===Ev.CAN_NOT_GET_GATEWAY_SERVER?t.data.retry:(PS.joinChooseServer(e.sid,{lts:r,succ:!1,csAddr:s,serverList:null,opid:l,ec:t.code,csIp:t.data&&t.data.csIp,unilbsServerIds:[JE.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:d}),isHttp3:a}),Av.warning("[".concat(e.clientId,"] Choose server network error, retry"),t),!0))),n)}function ew(t,e,i,n){let s,{url:o,areaCode:r,serviceIds:a}=t;const c=Date.now(),[l,d]=ow(e,r,a);let h;return Tv((async()=>{h&&yS.networkState===PE.OFFLINE&&yS.onlineWaiter&&await _h.race([yS.onlineWaiter,XT(n&&n.maxRetryTimeout||Sv.maxRetryTimeout)]),h=yS.networkState;const{data:t,headers:r}=await bS(o,{data:l,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);s="1"===r.http3?1:-1,PS.reportResourceTiming(o,e.sid),iw(t,o,e,c,a,s);const d=$T(t,JE.CHOOSE_SERVER),u=$T(t,"proxy5"===e.cloudProxyServer?JE.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?JE.CLOUD_PROXY:JE.CLOUD_PROXY_FALLBACK);return nw(d),{gatewayInfo:jT(d,o),proxyInfo:u,url:o}}),(t=>(t.gatewayInfo&&PS.joinChooseServer(e.sid,{lts:c,succ:!0,csAddr:o,serverList:t.gatewayInfo.gatewayAddrs.map((t=>t.address)),ec:null,opid:d,cid:t.gatewayInfo.cid.toString(),uid:t.gatewayInfo.uid.toString(),csIp:t.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:s}),t.proxyInfo&&PS.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:t.proxyInfo.addresses.map((t=>t.ip)).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1)),(t=>t.code!==Ev.OPERATION_ABORTED&&(t.code===Ev.CAN_NOT_GET_GATEWAY_SERVER?t.data.retry:(PS.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:t.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),Av.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),t),!0))),n)}const iw=(t,e,i,n,s,o)=>{const r=[],a=r=>{4096===r.flag?PS.joinChooseServer(i.sid,{lts:n,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:r.error.message,csIp:r.error.data&&r.error.data.csIp,unilbsServerIds:s.toString(),isHttp3:o}):1048576!==r.flag&&4194304!==r.flag&&4194310!==r.flag||PS.joinWebProxyAP(i.sid,{lts:n,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:r.error.code,eventType:i.cloudProxyServer,unilbsServerIds:s.toString()})};if(t.response_body.forEach((e=>{const i=e.buffer.code;if(23===e.uri&&0===i&&!e.buffer.edges_services)if(4194310===e.buffer.flag)Av.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),e.buffer.edges_services=[];else{const i={error:new _v(Ev.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:e.buffer.flag};r.push(i),a(i)}if(0!==i){const n=by(i),s={error:new _v(Ev.CAN_NOT_GET_GATEWAY_SERVER,n.desc,{desc:n.desc,retry:n.retry,csIp:t.detail[502]}),flag:e.buffer.flag};4194310===e.buffer.flag?Av.warning(s.error.toString()):r.push(s),a(s)}})),r.length)throw Av.warning("[".concat(i.clientId,"] multi unilbs ").concat(e," failed, ").concat(r.map((t=>"flag: ".concat(t.flag,", message: ").concat(t.error.message,", retry: ").concat(t.error.data.retry))).join(" | "))),new _v(Ev.CAN_NOT_GET_GATEWAY_SERVER,r.map((t=>"flag: ".concat(t.flag,", message: ").concat(t.error.message))).join(" | "),{retry:!!r.find((t=>t.error.data.retry)),csIp:t.detail[502],desc:[...new Set(r.map((t=>{var e,i;return null==t||null===(e=t.error)||void 0===e||null===(i=e.data)||void 0===i?void 0:i.desc})).filter((t=>!!t)))]})},nw=t=>{var e,i,n,s;if(t.addresses&&0===t.addresses.length&&0===t.code)throw new _v(Ev.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(Gv("AP_AREA")&&(null!==(n=t.detail)&&void 0!==n&&n[23]&&"string"==typeof(null===(s=t.detail)||void 0===s?void 0:s[23])?Ky(t.detail[23].toLowerCase()):Ky()),null!==(e=t.detail)&&void 0!==e&&e[19]&&"string"==typeof(null===(i=t.detail)||void 0===i?void 0:i[19])){const e=t.detail[19],i=null==e?void 0:e.split(";");for(let e=0;e<i.length;e++){var o;const n=fu(o=i[e]).call(o);t.addresses[e]&&i&&(t.addresses[e].fingerprint=n)}}if(Gv("GATEWAY_ADDRESS")&&Gv("GATEWAY_ADDRESS").length>0){Av.debug("assign gateway address to",Gv("GATEWAY_ADDRESS"));const e=Gv("GATEWAY_ADDRESS").map((e=>{var i,n;const s=null!==(i=null===(n=t.addresses.find((t=>t.ip===e.ip&&t.port===e.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:e.ip,port:e.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:s}}));t.addresses=e}},sw=(t,e)=>{if(t.response_body&&t.response_body.length){const e=t.response_body[0];if(0!==e.buffer.code){const t=by(e.buffer.code);throw new _v(Ev.UPDATE_TICKET_FAILED,"[".concat(e.buffer.code,"]: ").concat(t.desc),{retry:t.retry})}return e.buffer.ticket}throw Av.debug("update ticket request received ap response without response body:",e),new _v(Ev.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},ow=(t,e,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:{6:t.stringUid,11:e,12:Gv("USE_NEW_TOKEN")?"1":void 0,22:e},key:t.token,service_ids:i,uid:t.uid||0}}]};s.request_bodies.forEach((e=>{t.multiIP&&t.multiIP.gateway_ip&&(e.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},rw=(t,e)=>{const i=Math.floor(Math.random()*10**12),n={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map((t=>({ip:t.ip,port:t.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};let aw=0;async function cw(t,e,i,n){const s=async function(t,e,i,n){let s=null;const o=[],r=async()=>{const s=Gv("WEBCS_DOMAIN").slice(0,Gv("AJAX_REQUEST_CONCURRENT")).map((e=>({url:t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:jy()}))),r=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((t=>t.url))}),a=await Ey({fragementLength:Gv("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>(Av.debug("[".concat(t.clientId,"] Connect to choose_server:"),n.url),tw(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},r),t[0]},promisesCollector:o});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},r),a},a=async()=>{if(await XT(1e3),null!==s)return s;const r=Gv("WEBCS_DOMAIN_BACKUP_LIST").map((e=>({url:t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:jy()}))),a=n.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((t=>t.url))}),c=await Ey({fragementLength:Gv("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:n=>(Av.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),n.url),tw(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},a),t[0]},promisesCollector:o});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c};try{return s=await ny([r(),a()]),o.length&&o.forEach((t=>t.cancel&&"function"==typeof t.cancel&&t.cancel())),s}catch(t){throw t[0]}}(t,e,i,n);return{gatewayInfo:await s}}async function lw(t,e,i,n,s){const o=t.cloudProxyServer;if("disabled"===o){if(!n)return;if(t.useLocalAccessPoint)return await cw(t,e,i,s);if(Gv("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:n,proxyInfo:o}=await uw(t,e,i,s);return t.turnServer&&"auto"!==t.turnServer.mode||(t.turnServer={mode:"manual",servers:o.map((t=>({turnServerURL:t.address,tcpport:t.tcpport||Pv.tcpport,udpport:t.udpport||Pv.udpport,username:t.username||Pv.username,password:t.password||Pv.password,forceturn:!1,security:!0})))}),{gatewayInfo:n}}return await cw(t,e,i,s)}const{proxyInfo:r,gatewayInfo:a}=await uw(t,e,i,s),c={gatewayInfo:a};return t.turnServer={mode:"manual",servers:r.map((t=>({turnServerURL:t.address,tcpport:"proxy3"===o?void 0:t.tcpport?t.tcpport:Pv.tcpport,udpport:"proxy4"===o?void 0:t.udpport?t.udpport:Pv.udpport,username:t.username||Pv.username,password:t.password||Pv.password,forceturn:"proxy4"!==o,security:"proxy5"===o})))},Av.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),c}async function dw(t,e,i,n,s){const o=Gv("ACCOUNT_REGISTER").slice(0,Gv("AJAX_REQUEST_CONCURRENT"));let r=[];r=e.proxyServer?o.map((t=>"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"))):o.map((t=>"https://".concat(t,"/api/v1")));const a=null==s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:r});try{const o=await async function(t,e,i,n,s){const o=Date.now(),r={sid:i.sid,opid:10,appid:i.appId,string_uid:e};let a=t[0];const c=await Tv((()=>bS(a+"".concat(-1===a.indexOf("?")?"?":"&","action=stringuid"),{data:r,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((i,n)=>{if(0===i.code){if(i.uid<=0||i.uid>=Math.pow(2,32))throw Av.error("Invalid Uint Uid ".concat(e," => ").concat(i.uid),i),PS.reqUserAccount(r.sid,{lts:o,success:!1,serverAddr:a,stringUid:r.string_uid,uid:i.uid,errorCode:Ev.INVALID_UINT_UID_FROM_STRING_UID,extend:r}),new _v(Ev.INVALID_UINT_UID_FROM_STRING_UID);return PS.reqUserAccount(r.sid,{lts:o,success:!0,serverAddr:a,stringUid:r.string_uid,uid:i.uid,errorCode:null,extend:r}),!1}const s=by(i.code);return s.retry&&(a=t[(n+1)%t.length]),PS.reqUserAccount(r.sid,{lts:o,success:!1,serverAddr:a,stringUid:r.string_uid,uid:i.uid,errorCode:s.desc,extend:r}),s.retry}),((e,i)=>e.code!==Ev.OPERATION_ABORTED&&(PS.reqUserAccount(r.sid,{lts:o,success:!1,serverAddr:a,stringUid:r.string_uid,uid:null,errorCode:e.code,extend:r}),a=t[(i+1)%t.length],!0)),s);if(0!==c.code){const t=by(c.code);throw new _v(Ev.UNEXPECTED_RESPONSE,t.desc)}return c}(r,t,e,i,n);return null==s||s.recordJoinChannelService({status:"success",endTs:Date.now()},a),o.uid}catch(t){throw null==s||s.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[t]},a),t}}async function hw(t,e,i){const n=Gv("CDS_AP").slice(0,Gv("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"):"https://".concat(e,"/api/v1?action=config"))).map((n=>function(t,e,i,n){const s=Vu(),o={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:e.appId,version:Nv,cname:e.cname,sid:e.sid,session_id:e.sid,detail:"",proxyServer:e.proxyServer}};return Tv((()=>bS(t,{data:o,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(t=>t.code!==Ev.OPERATION_ABORTED),n)}(n,t,e,i)));let s=null,o=null,r={};try{s=await ny(n)}catch(t){if(t.code===Ev.OPERATION_ABORTED)throw t;o=t}if(n.forEach((t=>t.cancel())),PS.reportApiInvoke(t.sid,{name:vf.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:s}}).onSuccess(),s&&s.test_tags)try{r=function(t){if(!t.test_tags)return{};const e=t.test_tags,i=Object.keys(e),n={};return i.forEach((t=>{var i;const s=fu(i=t.slice(4)).call(i),o=JSON.parse(e[t])[1];n[s]=o})),n}(s)}catch(t){}return r}async function uw(t,e,i,n){const s=Gv("PROXY_SERVER_TYPE3"),o=(t,e,i)=>{let n=i||s;return Array.isArray(n)&&(n=e%2==0?s[1]:s[0]),"https://".concat(n,"/ap/?url=").concat(t)};let r=null;const a=[],c=async()=>{const s=Gv("WEBCS_DOMAIN").slice(0,Gv("AJAX_REQUEST_CONCURRENT")).map(((e,i)=>{let n;return n="disabled"===t.cloudProxyServer&&t.proxyServer?o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(e,"/api/v2/transpond/webrtc?v=2"):o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:jy(),serviceIds:[JE.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?JE.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?JE.CLOUD_PROXY:JE.CLOUD_PROXY_FALLBACK]}})),r=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((t=>t.url))}),c=await Ey({fragementLength:Gv("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>(Av.debug("[".concat(t.clientId,"] Connect to choose_server:"),n.url),ew(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},r),t[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},r),c},l=async()=>{if(await XT(1e3),null!==r)return r;const s=Gv("WEBCS_DOMAIN_BACKUP_LIST").map(((e,i)=>{let n;return n="disabled"===t.cloudProxyServer&&t.proxyServer?o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(e,"/api/v2/transpond/webrtc?v=2"):o("".concat(e,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:jy(),serviceIds:[JE.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?JE.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?JE.CLOUD_PROXY:JE.CLOUD_PROXY_FALLBACK]}})),c=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((t=>t.url))}),l=await Ey({fragementLength:Gv("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>(Av.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),n.url),ew(n,t,e,i)),allFailedhandler:t=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:t},c),t[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),l};let d,h,u;try{({gatewayInfo:d,proxyInfo:h,url:u}=await ny([c(),l()]))}catch(t){throw t[0]}if(a.length&&a.forEach((t=>t.cancel&&"function"==typeof t.cancel&&t.cancel())),!d||!h)throw new _v(Ev.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=u,"disabled"!==t.cloudProxyServer&&Array.isArray(s)&&u){const e=/^https?:\/\/(.+?)(\/.*)?$/.exec(u)[1];s.includes(e)&&(t.proxyServer=e,Av.setProxyServer(e),PS.setProxyServer(e))}return r={gatewayInfo:d,proxyInfo:await WT(h,d.uid)},r}async function pw(t,e,i,n){const s=Gv("UAP_AP").slice(0,Gv("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap")));return await Qy(s,t,e,i,n)}async function mw(t,e,i){const n=Gv("UAP_AP").slice(0,Gv("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap"))).map((n=>function(t,e,i,n){const s={command:"convergeAllocateEdge",sid:e.sid,appId:e.appId,token:e.token,ts:Date.now(),version:Nv,cname:e.cname,uid:e.uid.toString(),requestId:Zy,seq:Zy};Zy+=1;const o={service_name:"tele_channel",json_body:JSON.stringify(s)};return Tv((async()=>{const e=await bS(t,{data:o,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==e.code){const t=new _v(Ev.UNEXPECTED_RESPONSE,"cross channel ap error, code"+e.code,{retry:!0});throw Av.error(t.toString()),t}const n=JSON.parse(e.json_body);if(200!==n.code){const t=new _v(Ev.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(n.code,", reason: ").concat(n.reason));throw Av.error(t.toString()),t}if(!n.servers||0===n.servers.length){const t=new _v(Ev.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw Av.error(t.toString()),t}return{vid:n.vid,workerToken:n.workerToken,addressList:(Gv("CHANNEL_MEDIA_RELAY_SERVERS")||n.servers).map((t=>"wss://".concat(t.address.replace(/\./g,"-"),".").concat(Gv("WORKER_DOMAIN"),":").concat(t.wss)))}}),void 0,(t=>!!(t.code!==Ev.OPERATION_ABORTED&&t.code!==Ev.UNEXPECTED_RESPONSE||t.data&&t.data.retry)),n)}(n,t,e,i)));try{const t=await ny(n);return n.forEach((t=>t.cancel())),t}catch(t){throw t[0]}}async function vw(t,e,i){let n=null;const s=[],o=async o=>{const r=Gv(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v2/transpond/webrtc?v=2"):"https://".concat(e,"/api/v2/transpond/webrtc?v=2")));return o&&(await XT(1e3),null!==n)?n:await Ey({fragementLength:Gv("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:n=>(Av.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),n),function(t,e,i,n){const[s]=rw(e,[JE.CHOOSE_SERVER]);let o=yS.networkState;return Tv((async()=>{o&&yS.networkState===PE.OFFLINE&&yS.onlineWaiter&&await _h.race([yS.onlineWaiter,XT(n&&n.maxRetryTimeout||Sv.maxRetryTimeout)]),o=yS.networkState;const e=await bS(t,{data:s,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0);return sw(e,t)}),(()=>!1),(t=>t.code!==Ev.OPERATION_ABORTED&&(t.code===Ev.UPDATE_TICKET_FAILED?t.data.retry:(Av.warning("[".concat(e.clientId,"] update ticket network error, retry"),t),!0))),n)}(n,t,e,i)),allFailedhandler:t=>{throw t[0]},promisesCollector:s})};try{return n=await ny([o(!1),o(!0)]),s.length&&s.forEach((t=>t.cancel&&"function"==typeof t.cancel&&t.cancel())),n}catch(t){throw t[0]}}function gw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function fw(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?gw(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):gw(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class Ew extends gv{constructor(){super(),vp(this,"configs",void 0),vp(this,"joinInfo",void 0),vp(this,"cancelToken",void 0),vp(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),vp(this,"interval",void 0),vp(this,"mutex",new US("config-distribute")),vp(this,"mutableParamsRead",!1)}startGetConfigDistribute(t,e){this.joinInfo=t,this.cancelToken=e,this.interval&&this.stopGetConfigDistribute(),Gv("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),Gv("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,PS.reportApiInvoke(null,{options:void 0,name:vf.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:gf.TRACER}).onSuccess(JSON.stringify(Wv))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void Av.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const e=await this.mutex.lock();try{t=await hw(this.joinInfo,this.cancelToken,this.retryConfig),Av.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(t){const e=new _v(Ev.NETWORK_RESPONSE_ERROR,t);Av.warning("[config-distribute] ".concat(e.toString()))}finally{e()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(t){var e;(e=t)&&e.uplink&&e.id&&void 0!==e.uplink.max_bitrate&&void 0!==e.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==t.id&&this.emit(CE.UPDATE_BITRATE_LIMIT,t):this.emit(CE.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&fw({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){var e;const i=Wg(e=Object.keys(t).filter((t=>/^webrtc_ng_global_parameter/.test(t)))).call(e);for(let e=0;e<i.length;e++)for(let n=i.length-1;n>e;n--){const e=i[n];if("number"==typeof t[e].__priority){const s=t[e].__priority,o=i[n-1];if("number"==typeof t[o].__priority){if(!(s>t[o].__priority))continue;{const t=e;i[n]=i[n-1],i[n-1]=t}}else{const t=e;i[n]=i[n-1],i[n-1]=t}}}const n={};i.forEach((e=>{const i=t[e],s=i.__expires;Object.keys(i).forEach((t=>{"__priority"===t||"__expires"===t||Object.prototype.hasOwnProperty.call(n,t)||(n[t]=fw({value:i[t]},s&&{expires:s}))}))}));try{const t=JSON.stringify(n),e=window.btoa(t);window.localStorage.setItem("websdk_ng_global_parameter",e),Av.debug("Caching global parameters ".concat(t))}catch(t){Av.error("Error caching global parameters:",t.message)}}}function _w(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Sw(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?_w(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):_w(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class bw extends gv{constructor(t,e,i,n){super(),vp(this,"spec",void 0),vp(this,"token",void 0),vp(this,"websocket",void 0),vp(this,"pingpongTimer",void 0),vp(this,"reconnectMode","retry"),vp(this,"serviceMode",void 0),vp(this,"reqId",0),vp(this,"commandReqId",0),vp(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),vp(this,"handleWebSocketMessage",(t=>{if(!t.data)return;const e=JSON.parse(t.data);e.requestId?this.emit("@".concat(e.requestId,"-").concat(e.sid),e):this.serviceMode===zf.INJECT?this.emit(Zf.INJECT_STREAM_STATUS,e):(PS.workerEvent(this.spec.sid,{actionType:"status",serverCode:e.code,workerType:this.serviceMode===zf.TRANSCODE?1:2}),this.emit(Zf.PUBLISH_STREAM_STATUS,e))})),this.spec=e,this.token=t,this.serviceMode=n,this.websocket=new Cy("live-streaming",i),this.websocket.on(Wf.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Wf.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Wf.REQUEST_NEW_URLS,((t,e)=>{sy(this,Zf.REQUEST_NEW_ADDRESS).then(t).catch(e)})),this.websocket.on(Wf.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(t){return this.websocket.init(t)}async request(t,e,i,n){this.reqId+=1,"request"===t&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new _v(Ev.UNEXPECTED_ERROR);const r=Sw({command:t,sdkVersion:"4.18.2"===Nv?"0.0.1":Nv,seq:o,requestId:o,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},e);if("closed"===this.websocket.state)throw new _v(Ev.WS_DISCONNECT);const a=()=>new _h(((t,e)=>{this.websocket.once(Wf.CLOSED,(()=>e(new _v(Ev.WS_ABORT)))),this.websocket.once(Wf.CONNECTED,t)}));"connected"!==this.websocket.state&&await a(),r.clientRequest&&(r.clientRequest.workerToken=this.token);const c=new _h(((t,e)=>{const i=()=>{e(new _v(Ev.WS_ABORT))};this.websocket.once(Wf.RECONNECTING,i),this.websocket.once(Wf.CLOSED,i),this.once("@".concat(o,"-").concat(this.spec.sid),(e=>{t(e)}))}));n&&PS.workerEvent(this.spec.sid,Sw(Sw({},n),{},{requestId:s,actionType:"request",payload:JSON.stringify(e.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(r);let d=null;try{d=await c}catch(n){if("closed"===this.websocket.state)throw n;return await a(),await this.request(t,e,i)}return n&&PS.workerEvent(this.spec.sid,Sw(Sw({},n),{},{requestId:s,actionType:"response",payload:JSON.stringify(d.serverResponse),serverCode:d.code,success:200===d.code,responseTime:Date.now()-l})),200!==d.code&&this.handleResponseError(d),d}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t="4.18.2"===Nv?"0.0.1":Nv;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case eE.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void Av.warning("live stream response already exists stream");case eE.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case eE.LIVE_STREAM_RESPONSE_BAD_STREAM:case eE.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new _v(Ev.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case eE.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;throw new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case eE.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new _v(Ev.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case eE.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new _v(Ev.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Zf.WARNING,e,t.serverResponse.url)}case eE.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const e=new _v(Ev.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Zf.WARNING,e,t.serverResponse.url)}case eE.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case eE.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new _v(Ev.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case eE.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const e=new _v(Ev.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Zf.WARNING,e,t.serverResponse.url)}case eE.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case eE.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case eE.LIVE_STREAM_RESPONSE_WORKER_LOST:case eE.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;throw new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case eE.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===t.serverResponse.command||"UninjectStream"===t.serverResponse.command)return;if("UpdateTranscoding"===t.serverResponse.command||"ControlStream"===t.serverResponse.command)return new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case eE.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case eE.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case eE.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case eE.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new _v(Ev.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(ey)}),6e3)}}function Tw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function yw(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Tw(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Tw(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class ww extends gv{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Sv,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Sv;super(),vp(this,"onLiveStreamWarning",void 0),vp(this,"onLiveStreamError",void 0),vp(this,"onInjectStatusChange",void 0),vp(this,"spec",void 0),vp(this,"retryTimeout",1e4),vp(this,"connection",void 0),vp(this,"httpRetryConfig",void 0),vp(this,"wsRetryConfig",void 0),vp(this,"streamingTasks",new Map),vp(this,"isStartingStreamingTask",!1),vp(this,"taskMutex",new US("live-streaming")),vp(this,"cancelToken",mv.CancelToken.source()),vp(this,"transcodingConfig",void 0),vp(this,"injectConfig",yw({},Qf)),vp(this,"injectLoopTimes",0),vp(this,"uapResponse",void 0),vp(this,"lastTaskId",1),vp(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=i,this.wsRetryConfig=e}async setTranscodingConfig(t){const e=yw(yw({},Xf),t);66!==e.videoCodecProfile&&77!==e.videoCodecProfile&&100!==e.videoCodecProfile&&(Av.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(e.videoCodecProfile," -> 100")),e.videoCodecProfile=100),e.transcodingUsers||(e.transcodingUsers=e.userConfigs),e.transcodingUsers&&(e.transcodingUsers=e.transcodingUsers.map((t=>yw(yw(yw({},qf),t),{},{zOrder:t.zOrder?t.zOrder+1:1})))),function(t){tf(t.width)||qg(t.width,"config.width",0,1e4),tf(t.height)||qg(t.height,"config.height",0,1e4),tf(t.videoBitrate)||qg(t.videoBitrate,"config.videoBitrate",1,1e6),tf(t.videoFrameRate)||qg(t.videoFrameRate,"config.videoFrameRate"),tf(t.lowLatency)||zg(t.lowLatency,"config.lowLatency"),tf(t.audioSampleRate)||Kg(t.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),tf(t.audioBitrate)||qg(t.audioBitrate,"config.audioBitrate",1,128),tf(t.audioChannels)||Kg(t.audioChannels,"config.audioChannels",[1,2,3,4,5]),tf(t.videoGop)||qg(t.videoGop,"config.videoGop"),tf(t.videoCodecProfile)||Kg(t.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),tf(t.userCount)||qg(t.userCount,"config.userCount",0,17),tf(t.backgroundColor)||qg(t.backgroundColor,"config.backgroundColor",0,16777215),tf(t.userConfigExtraInfo)||Jg(t.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),t.transcodingUsers&&!tf(t.transcodingUsers)&&(Xg(t.transcodingUsers,"config.transcodingUsers"),t.transcodingUsers.forEach(((t,e)=>{Zg(t.uid),tf(t.x)||qg(t.x,"transcodingUser[".concat(e,"].x"),0,1e4),tf(t.y)||qg(t.y,"transcodingUser[".concat(e,"].y"),0,1e4),tf(t.width)||qg(t.width,"transcodingUser[".concat(e,"].width"),0,1e4),tf(t.height)||qg(t.height,"transcodingUser[".concat(e,"].height"),0,1e4),tf(t.zOrder)||qg(t.zOrder-1,"transcodingUser[".concat(e,"].zOrder"),0,100),tf(t.alpha)||qg(t.alpha,"transcodingUser[".concat(e,"].alpha"),0,1,!1)}))),tf(t.watermark)||Jf(t.watermark,"watermark"),tf(t.backgroundImage)||Jf(t.backgroundImage,"backgroundImage"),t.images&&!tf(t.images)&&(Xg(t.images,"config.images"),t.images.forEach(((t,e)=>{Jf(t,"images[".concat(e,"]"))})))}(e);const i=[];e.images&&i.push(...e.images.map((t=>yw(yw(yw({},Yf),t),{},{zOrder:255})))),e.backgroundImage&&(i.push(yw(yw(yw({},Yf),e.backgroundImage),{},{zOrder:0})),delete e.backgroundImage),e.watermark&&(i.push(yw(yw(yw({},Yf),e.watermark),{},{zOrder:255})),delete e.watermark),e.images=i,e.transcodingUsers&&(e.userConfigs=e.transcodingUsers.map((t=>yw({},t))),e.userCount=e.transcodingUsers.length,delete e.transcodingUsers);const n=(e.userConfigs||[]).map((t=>"number"==typeof t.uid?_h.resolve(t.uid):dw(t.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await _h.all(n)).forEach(((t,i)=>{e.userConfigs&&e.userConfigs[i]&&(e.userConfigs[i].uid=t)})),this.transcodingConfig=e,this.connection)try{var s;const t=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(yb(s=this.streamingTasks).call(s)).map((t=>t.taskId)).join("#")});Av.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(t.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(t){if(!t.data||!t.data.retry)throw t;t.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((e=>{Av.warning("[".concat(this.spec.clientId,"] live streaming receive error"),t.toString(),"try to republish",e.url),this.startLiveStreamingTask(e.url,e.mode,t).then((()=>{Av.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(e.url," success"))})).catch((t=>{Av.error("[".concat(this.spec.clientId,"] live streaming republish failed"),e.url,t.toString()),this.onLiveStreamError&&this.onLiveStreamError(e.url,t)}))}))}}setInjectStreamConfig(t,e){this.injectConfig=Object.assign({},this.injectConfig,t),this.injectLoopTimes=e}async startLiveStreamingTask(t,e,i){var n;if(Array.from(yb(n=this.streamingTasks).call(n)).find((t=>t.mode===zf.INJECT))&&e===zf.INJECT)return new _v(Ev.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&e===zf.TRANSCODE)throw new _v(Ev.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let s={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};Av.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(e));const o=await this.taskMutex.lock();if(!this.connection&&i)return void o();if(this.streamingTasks.get(t)&&!i)return o(),new _v(Ev.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(e))}catch(t){throw o(),t}switch(e){case zf.TRANSCODE:s.transcodingConfig=yw({},this.transcodingConfig);break;case zf.RAW:break;case zf.INJECT:s={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(s.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const r=this.lastTaskId++;try{const n=new _h(((e,n)=>{XT(this.retryTimeout).then((()=>{if(i)return n(i);const e=this.statusError.get(t);return e?(this.statusError.delete(t),n(e)):void 0}))})),a=await _h.race([this.connection.request("request",{clientRequest:s},!0,{url:t,command:"PublishStream",workerType:e===zf.TRANSCODE?1:2,requestByUser:!i,tid:r.toString()}),n]);this.isStartingStreamingTask=!1,Av.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(a.code)),this.streamingTasks.set(t,{clientRequest:s,mode:e,url:t,taskId:r}),o()}catch(n){if(o(),this.isStartingStreamingTask=!1,!n.data||!n.data.retry||i)throw n;return n.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,e,n)):await this.startLiveStreamingTask(t,e,n)}}stopLiveStreamingTask(t){return new _h(((e,i)=>{const n=this.streamingTasks.get(t);if(!n||!this.connection)return new _v(Ev.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=n.mode;n.abortTask=()=>{Av.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),e()},this.connection.request("request",{clientRequest:{command:s===zf.INJECT?"UninjectStream":"UnpublishStream",url:n.url}},!1,{url:t,command:"UnPublishStream",workerType:s===zf.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((i=>{Av.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(i.code)),this.streamingTasks.delete(t),0===this.streamingTasks.size&&s!==zf.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),e(),s===zf.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Kf.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)})).catch(i)}))}async controlInjectStream(t,e,i,n){const s=this.streamingTasks.get(t);if(!s||!this.connection||s.mode!==zf.INJECT)throw new _v(Ev.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:t,control:e,audioVolume:i,position:n}})).serverResponse}resetAllTask(){var t;const e=Array.from(yb(t=this.streamingTasks).call(t));this.terminate();for(const t of e)this.startLiveStreamingTask(t.url,t.mode).catch((e=>{this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=mv.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new _v(Ev.UNEXPECTED_ERROR,"live streaming connection has already connected");const e=await sy(this,tE.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=e,this.connection=new bw(e.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Zf.WARNING,((t,e)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(e,t))),this.connection.on(Zf.PUBLISH_STREAM_STATUS,(t=>this.handlePublishStreamServer(t))),this.connection.on(Zf.INJECT_STREAM_STATUS,(t=>this.handleInjectStreamServerStatus(t))),this.connection.on(Zf.REQUEST_NEW_ADDRESS,((e,i)=>{if(!this.connection)return i(new _v(Ev.UNEXPECTED_ERROR,"can not get new live streaming address list"));sy(this,tE.REQUEST_WORKER_MANAGER_LIST,t).then((t=>{this.uapResponse=t,e(t.addressList)})).catch(i)})),await this.connection.init(e.addressList),this.connection}handlePublishStreamServer(t){const e=t.serverStatus&&t.serverStatus.url||"empty_url",i=this.streamingTasks.get(e),n=t.reason;switch(t.code){case eE.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case eE.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case eE.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case eE.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const n=new _v(Ev.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(i)return Av.error(n.toString()),this.onLiveStreamError&&this.onLiveStreamError(e,n);if(!this.isStartingStreamingTask)return;this.statusError.set(e,n)}case eE.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new _v(Ev.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,n);return this.onLiveStreamWarning&&this.onLiveStreamWarning(e,t)}case eE.LIVE_STREAM_RESPONSE_WORKER_LOST:case eE.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const e=Array.from(yb(s=this.streamingTasks).call(s));for(const i of e)i.abortTask?i.abortTask():(Av.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,new _v(Ev.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then((()=>{Av.debug("[".concat(this.spec.clientId,"] republish live stream success"),i.url)})).catch((t=>{Av.error(t.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,t)})));return}}}handleInjectStreamServerStatus(t){const e=Number(t.uid),i=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Kf.INJECT_STREAM_STATUS_START_SUCCESS,e,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Kf.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,e,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Kf.INJECT_STREAM_STATUS_START_UNAUTHORIZED,e,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Kf.INJECT_STREAM_STATUS_BROKEN,e,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Kf.INJECT_STREAM_STATUS_START_TIMEOUT,e,i),void this.streamingTasks.delete(i);default:return void Av.debug("inject stream server status",t)}}hasUrl(t){return this.streamingTasks.has(t)}}class Cw{constructor(){vp(this,"destChannelMediaInfos",new Map),vp(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){SE(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){SE(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Qg(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function Rw(t){if(!(t instanceof Cw))return new _v(Ev.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),i=t.getDestChannelMediaInfo();return e?0===i.size?new _v(Ev.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new _v(Ev.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}class Iw extends gv{constructor(t,e,i){super(),vp(this,"ws",void 0),vp(this,"requestId",1),vp(this,"heartBeatTimer",void 0),vp(this,"joinInfo",void 0),vp(this,"clientId",void 0),vp(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),vp(this,"onClose",(t=>{this.emit("close"),this.dispose()})),vp(this,"onMessage",(t=>{const e=JSON.parse(t.data);if(!e||"serverResponse"!==e.command||!e.requestId)return e&&"serverStatus"===e.command&&e.serverStatus&&e.serverStatus.command?(this.emit("status",e.serverStatus),void this.emit(e.serverStatus.command,e.serverStatus)):void 0;this.emit("req_".concat(e.requestId),e)})),this.joinInfo=t,this.clientId=e,this.ws=new Cy("cross-channel-".concat(this.clientId),i),this.ws.on(Wf.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Wf.CONNECTED,this.onOpen),this.ws.on(Wf.ON_MESSAGE,this.onMessage),this.ws.on(Wf.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(t){const e=this.requestId++;return t.requestId=e,t.seq=e,this.ws.sendMessage(t),e}waitStatus(t){return new _h(((e,i)=>{const n=window.setTimeout((()=>{i(new _v(Ev.TIMEOUT,"wait status timeout, status: ".concat(t)))}),5e3);this.once(t,(s=>{window.clearTimeout(n),s.state&&0!==s.state?i(new _v(Ev.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):e(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new _v(Ev.WS_ABORT))}))}))}async request(t){if("closed"===this.ws.state)throw new _v(Ev.WS_DISCONNECT);const e=()=>new _h(((t,e)=>{this.ws.once(Wf.CLOSED,(()=>e(new _v(Ev.WS_ABORT)))),this.ws.once(Wf.CONNECTED,t)}));"connected"!==this.ws.state&&await e();const i=this.sendMessage(t),n=new _h(((t,e)=>{const n=()=>{e(new _v(Ev.WS_ABORT))};this.ws.once(Wf.RECONNECTING,n),this.ws.once(Wf.CLOSED,n),this.once("req_".concat(i),t),XT(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(Wf.RECONNECTING,n),this.ws.off(Wf.CLOSED,n),e(new _v(Ev.TIMEOUT,"cross channel ws request timeout"))}))})),s=await n;if(!s||200!==s.code)throw new _v(Ev.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(t){this.ws.removeAllListeners(Wf.REQUEST_NEW_URLS),this.ws.on(Wf.REQUEST_NEW_URLS,(e=>{e(t)})),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const e=this.requestId++;return t.requestId=e,this.ws.sendMessage(t),e}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class Aw extends gv{set state(t){t!==this._state&&(t!==oE.RELAY_STATE_FAILURE&&(this.errorCode=rE.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,e,i,n,s){super(),vp(this,"joinInfo",void 0),vp(this,"sid",void 0),vp(this,"clientId",void 0),vp(this,"cancelToken",mv.CancelToken.source()),vp(this,"workerToken",void 0),vp(this,"requestId",0),vp(this,"signal",void 0),vp(this,"prevChannelMediaConfig",void 0),vp(this,"httpRetryConfig",void 0),vp(this,"_resolution",void 0),vp(this,"_state",oE.RELAY_STATE_IDLE),vp(this,"errorCode",rE.RELAY_OK),vp(this,"onStatus",(t=>{Av.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(t))),t&&t.command&&("onAudioPacketReceived"===t.command&&this.emit("event",sE.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===t.command&&this.emit("event",sE.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===t.command&&(this.errorCode=rE.SRC_TOKEN_EXPIRED,this.state=oE.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===t.command&&(this.errorCode=rE.DEST_TOKEN_EXPIRED,this.state=oE.RELAY_STATE_FAILURE))})),vp(this,"onReconnect",(async()=>{Av.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",sE.NETWORK_DISCONNECTED),this.state=oE.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((t=>{this.state!==oE.RELAY_STATE_IDLE&&(Av.error("auto restart channel media relay failed",t.toString()),this.errorCode=rE.SERVER_CONNECTION_LOST,this.state=oE.RELAY_STATE_FAILURE)}))})),this.joinInfo=t,this.clientId=e,this.sid=ty(),this.signal=new Iw(this.joinInfo,this.clientId,i),this.httpRetryConfig=n,this._resolution=s}async startChannelMediaRelay(t){if(this.state!==oE.RELAY_STATE_IDLE)throw new _v(Ev.INVALID_OPERATION);this.state=oE.RELAY_STATE_CONNECTING,await this.connect(),Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(t){if(t.data&&t.data.serverResponse&&"SetSourceChannel"===t.data.serverResponse.command)throw new _v(Ev.CROSS_CHANNEL_FAILED_JOIN_SRC);if(t.data&&t.data.serverResponse&&"SetDestChannelStatus"===t.serverResponse.command)throw new _v(Ev.CROSS_CHANNEL_FAILED_JOIN_DEST);if(t.data&&t.data.serverResponse&&"StartPacketTransfer"===t.serverResponse.command)throw new _v(Ev.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw t}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==oE.RELAY_STATE_RUNNING)throw new _v(Ev.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==oE.RELAY_STATE_RUNNING)throw new _v(Ev.INVALID_OPERATION);const e=this.genMessage(nE.SetVideoProfile);await this.signal.request(e),Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),Av.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=oE.RELAY_STATE_IDLE,this.dispose()}dispose(){Av.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=mv.CancelToken.source(),this.state=oE.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await mw(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",sE.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const e=this.genMessage(nE.StopPacketTransfer);await this.signal.request(e),await this.signal.waitStatus("Normal Quit"),Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=this.genMessage(nE.SetSdkProfile,t);await this.signal.request(i),Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const n=this.genMessage(nE.SetSourceChannel,t);await this.signal.request(n),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",sE.PACKET_JOINED_SRC_CHANNEL),Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const s=this.genMessage(nE.SetSourceUserId,t);await this.signal.request(s),Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(nE.SetDestChannel,t);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",sE.PACKET_JOINED_DEST_CHANNEL),Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const r=this.genMessage(nE.StartPacketTransfer,t);await this.signal.request(r),this.emit("event",sE.PACKET_SENT_TO_DEST_CHANNEL),this.state=oE.RELAY_STATE_RUNNING,Av.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const e=this.genMessage(nE.UpdateDestChannel,t);await this.signal.request(e),this.emit("event",sE.PACKET_UPDATE_DEST_CHANNEL),Av.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(nE.StopPacketTransfer);await this.signal.request(t),Av.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,e){const i=[],n=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Nv,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.18.2"===o.sdkVersion&&(o.sdkVersion="0.0.1");let r=null,a=null;switch(t){case nE.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case nE.SetSourceChannel:if(a=e&&e.getSrcChannelMediaInfo(),!a)throw new _v(Ev.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case nE.SetSourceUserId:if(a=e&&e.getSrcChannelMediaInfo(),!a)throw new _v(Ev.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case nE.SetDestChannel:if(r=e&&e.getDestChannelMediaInfo(),!r)throw new _v(Ev.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((t=>{i.push(t.channelName),n.push(t.uid+""),s.push(t.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:s},o;case nE.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case nE.Reconnect:return o.clientRequest={command:"Reconnect"},o;case nE.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case nE.UpdateDestChannel:if(r=e&&e.getDestChannelMediaInfo(),!r)throw new _v(Ev.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((t=>{i.push(t.channelName),n.push(t.uid+""),s.push(t.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:s},o;case nE.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}const Ow=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new _h(((i,n)=>{e.toBlob((async t=>{if(e.remove(),t){const n=await Nw(t);i({buffer:n,width:e.width,height:e.height})}else n(new _v(Ev.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,1)}))},Nw=async t=>{const e=await t.arrayBuffer();return new Uint8Array(e)};function kw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Lw(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?kw(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):kw(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class Pw{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(t){t!==this._videoElementStatus&&(Av.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}constructor(t){vp(this,"trackId",void 0),vp(this,"config",void 0),vp(this,"onFirstVideoFrameDecoded",void 0),vp(this,"freezeTimeCounterList",[]),vp(this,"renderFreezeAccTime",0),vp(this,"isKeepLastFrame",!1),vp(this,"timeUpdatedCount",0),vp(this,"freezeTime",0),vp(this,"playbackTime",0),vp(this,"lastTimeUpdatedTime",0),vp(this,"autoplayFailed",!1),vp(this,"videoTrack",void 0),vp(this,"videoElement",void 0),vp(this,"cacheVideoElement",void 0),vp(this,"videoElementCheckInterval",void 0),vp(this,"_videoElementStatus",af.NONE),vp(this,"isGettingVideoDimensions",!1),vp(this,"startGetVideoDimensions",(()=>{const t=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return Av.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(t,500)};!this.isGettingVideoDimensions&&t()})),vp(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===GS.curState&&(Av.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(ju())),ep()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),vp(this,"handleVideoEvents",(t=>{switch(t.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=af.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch(t){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=af.CANPLAY;break;case"stalled":this.videoElementStatus=af.STALLED;break;case"suspend":this.videoElementStatus=af.SUSPEND;break;case"pause":this.videoElementStatus=af.PAUSED,Ku()||ip()||Wu()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(Av.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=af.WAITING;break;case"abort":this.videoElementStatus=af.ABORT;break;case"ended":this.videoElementStatus=af.ENDED;break;case"emptied":this.videoElementStatus=af.EMPTIED;break;case"error":{this.videoElementStatus=af.ERROR;const t=this.videoElement.error;t&&Av.error("[".concat(this.trackId,"] media error, code: ").concat(t.code,", message: ").concat(t.message));break}case"timeupdate":{const t=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=t);const e=t-this.lastTimeUpdatedTime,i=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=t,xT.lastVisibleTime<xT.lastHiddenTime||i<xT.lastHiddenTime||i<xT.lastVisibleTime)return;for(e>Gv("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=e),this.playbackTime+=e;this.playbackTime>=6e3;){this.playbackTime-=6e3;const t=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(t),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),vp(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(Av.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(ju())),ep()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),GS.on(MS.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),GS.on(MS.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return null!==(t=this.videoElement.parentElement)&&void 0!==t?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const e=this.videoElement.play();e&&e.catch&&e.catch((e=>{t&&PS.autoplayFailed(t,"video",e.message,this.trackId),"NotAllowedError"===e.name?(Av.warning("detected video element autoplay failed",e),this.autoplayFailed=!0,this.handleAutoPlayFailed()):Av.warning("[".concat(this.trackId,"] play warning: "),e)}));const i=Vu();if(("Safari"===i.name&&15===Number(i.version)||Zu())&&e&&e.then&&e.catch){const t=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};e.then(t).catch(t)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const e=t.getContext("2d");if(!e)return Av.error("create canvas context failed!"),new ImageData(2,2);e.drawImage(this.videoElement,0,0,t.width,t.height);const i=e.getImageData(0,0,t.width,t.height);return t.remove(),i}async getCurrentFrameToUint8Array(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const n=i.getContext("2d");return n?(n.drawImage(this.videoElement,0,0,i.width,i.height),new _h(((n,s)=>{i.toBlob((async t=>{if(i.remove(),t){const e=await Nw(t);n({buffer:e,width:i.width,height:i.height})}else s(new _v(Ev.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,e<0?.1:e>1?1:e)}))):await Ow(t)}destroy(){GS.off(MS.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),GS.off(MS.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=af.INIT,!this.videoElementCheckInterval&&(Dw.forEach((t=>{this.videoElement.addEventListener(t,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{(function(t){return t!==document.body&&document.body.contains(t)})(this.videoElement)||(this.videoElementStatus=af.DESTROYED)}),1e3),Gv("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,e;let i;const n=(t,e)=>{if(this.videoElementStatus===af.PLAYING){if(i){const t=e.presentationTime-i.presentationTime;t>Gv("VIDEO_FREEZE_DURATION")&&xT.lastVisibleTime>=xT.lastHiddenTime&&i.timestamp>xT.lastVisibleTime&&i.timestamp>xT.lastHiddenTime&&(this.renderFreezeAccTime+=t)}i=Lw(Lw({},e),{},{timestamp:t})}var s,o;Gv("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(s=(o=this.videoElement).requestVideoFrameCallback)||void 0===s||s.call(o,n))};null===(t=(e=this.videoElement).requestVideoFrameCallback)||void 0===t||t.call(e,n)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),rp()&&(this.videoElement.poster="noposter");const i=Vu();"Safari"===i.name&&15===Number(i.version)||Zu()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,zu()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,zu()&&this.videoElement.load());const n=this.videoElement.play();void 0!==n&&n.catch((t=>{Av.debug("[".concat(this.trackId,"] playback interrupted"),t.toString())}))}resetVideoElement(){Dw.forEach((t=>{this.videoElement&&this.videoElement.removeEventListener(t,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=af.NONE}handleAutoPlayFailed(){const t=e=>{e.preventDefault(),this.videoElement.play().then((()=>{Av.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((t=>{Av.error(t)})),this.autoplayFailed=!1,ap()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};ap()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),RS()}}const Dw=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class Mw extends Pw{constructor(t){super(t),vp(this,"container",void 0),vp(this,"slot",void 0),this.slot=t.element,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const e=t.element;e!==this.slot&&(this.destroy(),this.slot=e),this.createElements()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var e;null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var e;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,i):await Ow(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch(t){}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",Gv("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var t;!this.container||null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if(null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(t){}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function xw(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const i=Uv(t.encoderConfig);return e.width=i.width,e.height=i.height,!sp()&&i.frameRate&&(e.frameRate=i.frameRate),Vu().name===ku.EDGE&&"object"==typeof e.frameRate&&(e.frameRate.max=60),zu()&&(e.frameRate={ideal:30,max:30}),e}function Uw(t){const e={};t.screenSourceType&&(e.mediaSource=t.screenSourceType),t.extensionId&&$u()&&(e.extensionId=t.extensionId);const{displaySurface:i,selfBrowserSurface:n,surfaceSwitching:s,systemAudio:o}=t;(qu(107)||Yu(107)||Ju(93))&&(i&&(Kg(i,"displaySurface",["browser","window","monitor"]),e.displaySurface=i),n?(Kg(n,"selfBrowserSurface",["exclude","include"]),e.selfBrowserSurface=n):e.selfBrowserSurface="include",s&&(Kg(s,"surfaceSwitching",["exclude","include"]),e.surfaceSwitching=s)),(qu(105)||Yu(105)||Ju(91))&&o&&(Kg(o,"systemAudio",["exclude","include"]),e.systemAudio=o),t.electronScreenSourceId&&(e.sourceId=t.electronScreenSourceId);const r=t.encoderConfig?Vv(t.encoderConfig):null;return e.mandatory={chromeMediaSource:"desktop",maxWidth:r?r.width:void 0,maxHeight:r?r.height:void 0},r&&(r.frameRate&&("number"==typeof r.frameRate?(e.mandatory.maxFrameRate=r.frameRate,e.mandatory.minFrameRate=r.frameRate):(e.mandatory.maxFrameRate=r.frameRate.max||r.frameRate.ideal||r.frameRate.exact||void 0,e.mandatory.minFrameRate=r.frameRate.min||r.frameRate.ideal||r.frameRate.exact||void 0),e.frameRate=r.frameRate),r.width&&(e.width=r.width),r.height&&(e.height=r.height)),e}function Vw(t){const e={};if(sp()||(void 0!==t.AGC&&(e.autoGainControl=t.AGC),void 0!==t.AEC&&(e.echoCancellation=t.AEC),void 0!==t.ANS&&(e.noiseSuppression=t.ANS,$u()&&t.ANS&&(e.googHighpassFilter=t.ANS))),t.encoderConfig){const i=Fv(t.encoderConfig);e.channelCount=i.stereo?2:1,e.sampleRate=i.sampleRate,e.sampleSize=i.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),rp()&&(e.sampleRate=void 0),e}var Bw,jw;!function(t){t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE"}(Bw||(Bw={})),function(t){t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(jw||(jw={}));var Fw,Hw,Gw,$w,Ww,zw,Kw,qw,Yw,Jw,Xw,Qw,Zw,tC,eC,iC,nC,sC,oC,rC,aC,cC,lC,dC,hC,uC,pC,mC,vC,gC,fC,EC,_C,SC,bC=new class{constructor(){vp(this,"_clientSize",null),vp(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),vp(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),vp(this,"getStyle",(t=>window.getComputedStyle(t,null))),vp(this,"checkCssVisibleProperty",(t=>{let e=!0;const i=this.getStyle(t),{display:n,visibility:s,opacity:o,filter:r}=i;return("none"===n||["hidden","collapse"].includes(s)||Number(o)<.1)&&(e=!1),!!e&&(r&&r.split(" ").filter((t=>{const e=t.split("(")[0];return["brightness","blur","opacity"].includes(e)})).map((t=>{const[e,i]=t.split(/\(|\)/);return[e,Number(i.match(/^[0-9\.]+/))]})).forEach((t=>{const[i,n]=t;switch(i){case"brightness":(n<.1||n>3)&&(e=!1);break;case"blur":n>3&&(e=!1);break;case"opacity":n<.1&&(e=!1)}})),e)})),vp(this,"checkPropertyUpToAllParentNodes",((t,e)=>{let i=!0,n=!0;const s=t=>e(t);let o=t;for(;o&&n;)s(o)||(i=!1,n=!1),o=o.parentElement,o||(n=!1);return i})),vp(this,"checkActualCssVisibleIncludeInherit",(t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty))),vp(this,"getSizeAboutClient",(t=>{const{width:e,height:i,left:n,right:s,top:o,bottom:r}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:i,left:n,right:s,top:o,bottom:r,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),vp(this,"checkActualSize",(()=>{const{width:t,height:e,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(t,e,i)})),vp(this,"elementFromPoint",((t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null)),vp(this,"checkCoverForAPoint",((t,e,i)=>{const n=this.elementFromPoint(t,e);return null!==n&&n!==i})),vp(this,"getPointPositionList",(()=>{const{width:t,height:e,left:i,top:n}=this._clientSize,s=t/6,o=e/6,r=[],a=10**6;for(let t=0;t<5;t++)for(let e=0;e<5;e++){const c=(i*a+(0===t?.1:4===t?(s*t*a-1e5)/a:s*t)*a)/a,l=(n*a+(0===e?.1:4===e?(o*e*a-1e5)/a:o*e)*a)/a;r.push({x:c,y:l})}return[...r]})),vp(this,"checkElementCover",(t=>this.getPointPositionList().map((e=>this.checkCoverForAPoint(e.x,e.y,t))).filter((t=>!!t)).length>6)),vp(this,"checkSizeIsVisible",((t,e,i)=>(t>50||i/t<=10)&&(e>50||i/e<=10))),vp(this,"checkSizeOfPartInClient",(()=>{const{left:t,right:e,top:i,bottom:n,clientHeight:s,clientWidth:o,clientMin:r}=this._clientSize;let a,c,l,d;if(t<0)a=0;else{if(!(t<o))return!1;a=t}if(e<0)return!1;if(c=e<o?e:o,i<0)l=0;else{if(!(i<s))return!1;l=i}if(n<0)return!1;d=n<s?n:s;const h=c-a,u=d-l;return this.checkSizeIsVisible(h,u,r)})),vp(this,"returnHiddenResult",(t=>(this._clientSize=null,{visible:!1,reason:t}))),vp(this,"checkOneElementVisible",(t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Bw.COVERED);{const t=this.checkActualSize(),e=this.checkSizeOfPartInClient();return t&&!e?this.returnHiddenResult(Bw.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Bw.SIZE)}}return this.returnHiddenResult(Bw.STYLE)}return this.returnHiddenResult(jw.UNMOUNTED)}return this.returnHiddenResult(jw.INVALID_HTML_ELEMENT)})),vp(this,"checkElementIsMountedOnDom",(t=>this.checkPropertyUpToAllParentNodes(t,(t=>"HTML"!==t.nodeName.toUpperCase()?null!==t.parentElement:!!document.documentElement))))}};function TC(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function yC(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?TC(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):TC(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let wC=(Fw=LS({argsMap:(t,e,i)=>[t.getTrackId(),"string"==typeof e?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),Hw=vb(),Gw=LS({argsMap:t=>[t.getTrackId()]}),$w=VS("LocalVideoTrack","_enabledMutex"),Ww=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),zw=vb(),Kw=VS("LocalVideoTrack","_enabledMutex"),qw=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),Yw=vb(),Jw=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),Xw=vb(),Qw=vb(),Zw=LS({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),tC=vb(),eC=vb(),iC=vb(),nC=vb(),sC=vb(),oC=vb(),rC=vb(),aC=LS({argsMap:(t,e)=>[t.getTrackId(),e.name]}),cC=LS({argsMap:t=>[t.getTrackId()]}),lC=LS({argsMap:t=>[t.getTrackId()]}),dC=LS({argsMap:(t,e,i)=>[t.getTrackId(),e.label,i]}),cS((hC=class t extends BS{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==af.PLAYING)}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,e,i,n,s,o){if(super(t,s),vp(this,"trackMediaType","video"),vp(this,"_player",void 0),vp(this,"_videoVisibleTimer",null),vp(this,"_previousVideoVisibleStatus",void 0),vp(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),vp(this,"_encoderConfig",void 0),vp(this,"_scalabiltyMode",{numSpatialLayers:1,numTemporalLayers:1}),vp(this,"_optimizationMode",void 0),vp(this,"_videoHeight",void 0),vp(this,"_videoWidth",void 0),vp(this,"_forceBitrateLimit",void 0),vp(this,"_enabled",!0),vp(this,"processorDestination",void 0),vp(this,"_processorContext",void 0),Wu()){const{width:e,height:i}=t.getSettings();this._videoWidth=e,this._videoHeight=i}else this.updateMediaStreamTrackResolution();this._encoderConfig=e,this._scalabiltyMode=i,this._optimizationMode=n,this._hints=o||[],-1===this._hints.indexOf(uE.SCREEN_TRACK)&&this.updateBitrateFromProfile(),e&&-1!==this._hints.indexOf(uE.CUSTOM_TRACK)&&this.setEncoderConfiguration(e),this.processorContext=new Ib(this.getTrackId(),"local"),this.processorDestination=new Rb(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t){const e=document.getElementById(t);e?t=e:(Av.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}Av.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=yC(yC(yC({},this._getDefaultPlayerConfig()),e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new Pw(i):this._player=new Mw(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const t=this.getVideoElementVisibleStatus();this.safeEmit(fE.VIDEO_ELEMENT_VISIBLE_STATUS,t)}catch(t){}}),Gv("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Av.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(Av.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await oy(this,hE.NEED_DISABLE_TRACK,this)}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setEnabled to false error"),t.toString()),t}return e||(this._enabled=!1),void Av.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await oy(this,hE.NEED_ENABLE_TRACK,this)}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setEnabled to true error"),t.toString()),t}Av.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,Av.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await oy(this,hE.NEED_MUTE_TRACK,this):await oy(this,hE.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(t,e){if(!this._enabled)throw new _v(Ev.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t=Uv(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const e=xw({encoderConfig:t});(Wu()||Ku()||ip())&&(e.deviceId=void 0),Av.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(e));try{await this._originMediaStreamTrack.applyConstraints(e),this.updateMediaStreamTrackResolution()}catch(t){const e=new _v(Ev.UNEXPECTED_ERROR,t.toString());throw Av.error("[".concat(this.getTrackId(),"] applyConstraints error"),e.toString()),e}}this._encoderConfig=t,-1===this._hints.indexOf(uE.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await oy(this,hE.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw()}}getStats(){return py((()=>{Av.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),ry(this,hE.GET_STATS)||yC({},Ff)}async setBeautyEffect(t){Av.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,e):await Ow(t)}clone(e,i,n,s){const o=this._mediaStreamTrack.clone();return new t(o,e,i,n,s)}async setBitrateLimit(t){if(Av.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t){this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate);try{await oy(this,hE.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw()}}}async setOptimizationMode(t){if("motion"!==t&&"detail"!==t&&"balanced"!==t)return void Av.error(Ev.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const e=this._optimizationMode;try{this._optimizationMode=t,await oy(this,hE.SET_OPTIMIZATION_MODE,this)}catch(t){throw this._optimizationMode=e,Av.error("[".concat(this.getTrackId(),"] set optimization mode failed"),t.toString()),t}Av.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(1===t.numSpatialLayers&&1!==t.numTemporalLayers)return Av.error(Ev.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabiltyMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabiltyMode=t,Av.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){iy(this._originMediaStreamTrack).then((t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e})).catch(ey)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:e,frameRate:i}=this.getMediaStreamTrackSettings();if(!t||!e||!i)return;const[n,s]=function(t,e,i){const n=Gv("BITRATE_ADAPTER_TYPE");let s;const o=200*Math.pow(i/15,.6)*Math.pow(t*e/640/360,.75),r=o;if("STANDARD_BITRATE"===n)s=4*o;else{if("COMPATIABLE_BITRATE"!==n)return;s=2*o}return[Math.floor(s),Math.floor(r)]}(t,e,i)||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=s,this._encoderConfig.bitrateMax=n,Av.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(e,", fps: ").concat(i,"] => [brMax: ").concat(n,", brMin: ").concat(s,"]")))}getVideoElementVisibleStatus(){try{var t,e;const i=null==this||null===(t=this._player)||void 0===t?void 0:t.getContainerElement(),n={track:this,element:null==this||null===(e=this._player)||void 0===e?void 0:e.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:s,slot:o}=n;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const t=bC.checkOneElementVisible(s),e=Object.assign({},t);if(e.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=e.visible;const t=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});e.visible?t.onSuccess("Video is visible"):t.onSuccess("Invisible because of ".concat(e.reason))}return e}return}catch(t){throw new _v(Ev.GET_VIDEO_ELEMENT_VISIBLE_ERROR,t.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new _v(Ev.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}async replaceTrack(t,e){if(!(t instanceof MediaStreamTrack))throw new _v(Ev.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==t.kind)throw new _v(Ev.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,e,!0),this.updateMediaStreamTrackResolution()}bindProcessorDestinationEvents(){this.processorDestination.on(ME.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await oy(this,hE.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await oy(this,hE.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ME.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(xE.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(xE.REQUEST_CONSTRAINTS)}}).prototype,"play",[Fw,Hw],Object.getOwnPropertyDescriptor(hC.prototype,"play"),hC.prototype),cS(hC.prototype,"stop",[Gw],Object.getOwnPropertyDescriptor(hC.prototype,"stop"),hC.prototype),cS(hC.prototype,"setEnabled",[$w,Ww,zw],Object.getOwnPropertyDescriptor(hC.prototype,"setEnabled"),hC.prototype),cS(hC.prototype,"setMuted",[Kw,qw,Yw],Object.getOwnPropertyDescriptor(hC.prototype,"setMuted"),hC.prototype),cS(hC.prototype,"setEncoderConfiguration",[Jw,Xw],Object.getOwnPropertyDescriptor(hC.prototype,"setEncoderConfiguration"),hC.prototype),cS(hC.prototype,"getStats",[Qw],Object.getOwnPropertyDescriptor(hC.prototype,"getStats"),hC.prototype),cS(hC.prototype,"setBeautyEffect",[Zw,tC],Object.getOwnPropertyDescriptor(hC.prototype,"setBeautyEffect"),hC.prototype),cS(hC.prototype,"getCurrentFrameData",[eC],Object.getOwnPropertyDescriptor(hC.prototype,"getCurrentFrameData"),hC.prototype),cS(hC.prototype,"getCurrentFrameImage",[iC],Object.getOwnPropertyDescriptor(hC.prototype,"getCurrentFrameImage"),hC.prototype),cS(hC.prototype,"setBitrateLimit",[nC],Object.getOwnPropertyDescriptor(hC.prototype,"setBitrateLimit"),hC.prototype),cS(hC.prototype,"setOptimizationMode",[sC],Object.getOwnPropertyDescriptor(hC.prototype,"setOptimizationMode"),hC.prototype),cS(hC.prototype,"setScalabiltyMode",[oC],Object.getOwnPropertyDescriptor(hC.prototype,"setScalabiltyMode"),hC.prototype),cS(hC.prototype,"updateMediaStreamTrackResolution",[rC],Object.getOwnPropertyDescriptor(hC.prototype,"updateMediaStreamTrackResolution"),hC.prototype),cS(hC.prototype,"pipe",[aC],Object.getOwnPropertyDescriptor(hC.prototype,"pipe"),hC.prototype),cS(hC.prototype,"unpipe",[cC],Object.getOwnPropertyDescriptor(hC.prototype,"unpipe"),hC.prototype),cS(hC.prototype,"close",[lC],Object.getOwnPropertyDescriptor(hC.prototype,"close"),hC.prototype),cS(hC.prototype,"replaceTrack",[dC],Object.getOwnPropertyDescriptor(hC.prototype,"replaceTrack"),hC.prototype),hC),CC=(uC=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),pC=vb(),mC=VS("CameraVideoTrack","_enabledMutex"),vC=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),gC=vb(),fC=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),EC=vb(),_C=LS({argsMap:t=>[t.getTrackId()]}),cS((SC=class extends wC{get __className__(){return"CameraVideoTrack"}constructor(t,e,i,n,s,o){super(t,Uv(e.encoderConfig),n,s,o),vp(this,"_config",void 0),vp(this,"_originalConstraints",void 0),vp(this,"_constraints",void 0),vp(this,"_enabled",!0),vp(this,"_deviceName","default"),vp(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(Zu()||tp())&&!function(){const t=Vu();if(t.os!==Nu.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])&&Number(e[1])>=2}()&&np()&&this._enabled&&!this._isClosed&&(Av.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=e,this._originalConstraints=i,this._constraints=i,this._deviceName=t.label,this._encoderConfig=Uv(this._config.encoderConfig),GS.on(MS.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),GS.on(MS.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){if(Av.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const e=await ub.getDeviceById(t),i={};i.video=yC({},this._constraints),i.video.deviceId={exact:t},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let n=null;try{n=await cb(i,this.getTrackId())}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setDevice failed"),t.toString()),n=await cb({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),t}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const e=await ub.getDeviceById(t);this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}Av.info("[".concat(this.getTrackId(),"] setDevice success"))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(Av.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const t=await cb({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(t.getVideoTracks()[0],!1)}await oy(this,hE.NEED_ENABLE_TRACK,this)}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setEnabled true error"),t.toString()),t}this.updateMediaStreamTrackResolution(),Av.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),e||(this._enabled=!1);try{await oy(this,hE.NEED_DISABLE_TRACK,this)}catch(t){throw Av.error("[".concat(this.getTrackId(),"] setEnabled to false error"),t.toString()),t}Av.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,e){if(!this._enabled)throw new _v(Ev.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t=Uv(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin);const i=hy(this._config);i.encoderConfig=t;const n=xw(i);(Wu()||Ku()||ip())&&(n.deviceId=void 0),Av.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(t){const e=new _v(Ev.UNEXPECTED_ERROR,t.toString());throw Av.error("[".concat(this.getTrackId(),"] applyConstraints error"),e.toString()),e}this._config=i,this._constraints=n,this._originalConstraints=n,this._encoderConfig=t,-1===this._hints.indexOf(uE.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await oy(this,hE.NEED_UPDATE_VIDEO_ENCODER,this)}catch(t){return t.throw()}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Ku()||ip())&&this._enabled&&!this._isClosed&&GS.duringInterruption){const t=async()=>{GS.off(MS.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(Av.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};GS.on(MS.IOS_INTERRUPTION_END,t)}else Av.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fE.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=ub.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId={exact:i}),this._enabled){const t=await cb({video:e},this.getTrackId());this._constraints=e,await this._updateOriginMediaStreamTrack(t.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),GS.off(MS.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),GS.off(MS.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}bindProcessorContextEvents(){this.processorContext.on(xE.REQUEST_UPDATE_CONSTRAINTS,(async(t,e,i)=>{try{const i=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(i),e()}catch(t){i(t)}})),this.processorContext.on(xE.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}}).prototype,"setDevice",[uC,pC],Object.getOwnPropertyDescriptor(SC.prototype,"setDevice"),SC.prototype),cS(SC.prototype,"setEnabled",[mC,vC,gC],Object.getOwnPropertyDescriptor(SC.prototype,"setEnabled"),SC.prototype),cS(SC.prototype,"setEncoderConfiguration",[fC,EC],Object.getOwnPropertyDescriptor(SC.prototype,"setEncoderConfiguration"),SC.prototype),cS(SC.prototype,"close",[_C],Object.getOwnPropertyDescriptor(SC.prototype,"close"),SC.prototype),SC);class RC{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio)return this._audioTrack}get videoTrack(){if(this.hasVideo)return this._videoTrack}constructor(t,e){vp(this,"uid",void 0),vp(this,"_uintid",void 0),vp(this,"_trust_in_room_",!0),vp(this,"_trust_audio_enabled_state_",!0),vp(this,"_trust_video_enabled_state_",!0),vp(this,"_trust_audio_mute_state_",!0),vp(this,"_trust_video_mute_state_",!0),vp(this,"_audio_muted_",!1),vp(this,"_video_muted_",!1),vp(this,"_audio_enabled_",!0),vp(this,"_video_enabled_",!0),vp(this,"_audio_added_",!1),vp(this,"_video_added_",!1),vp(this,"_trust_video_stream_added_state_",!0),vp(this,"_trust_audio_stream_added_state_",!0),vp(this,"_audioTrack",void 0),vp(this,"_videoTrack",void 0),vp(this,"_audioSSRC",void 0),vp(this,"_videoSSRC",void 0),vp(this,"_audioOrtc",void 0),vp(this,"_videoOrtc",void 0),vp(this,"_cname",void 0),vp(this,"_rtxSsrcId",void 0),this.uid=t,this._uintid=e}}var IC=Eh,AC=ml,OC=Tl;Ti({target:"Promise",stat:!0},{try:function(t){var e=AC.f(this),i=OC(t);return(i.error?e.reject:e.resolve)(i.value),e.promise}});var NC=IC,kC=Ti,LC=u,PC=i,DC=QE,MC=K,xC=Bt,UC=Oi,VC=ng,BC=r_,jC=F_,FC=at,HC=se("isConcatSpreadable"),GC=9007199254740991,$C="Maximum allowed index exceeded",WC=LC.TypeError,zC=FC>=51||!PC((function(){var t=[];return t[HC]=!1,t.concat()[0]!==t})),KC=jC("concat"),qC=function(t){if(!MC(t))return!1;var e=t[HC];return void 0!==e?!!e:DC(t)};kC({target:"Array",proto:!0,forced:!zC||!KC},{concat:function(t){var e,i,n,s,o,r=xC(this),a=BC(r,0),c=0;for(e=-1,n=arguments.length;e<n;e++)if(qC(o=-1===e?r:arguments[e])){if(c+(s=UC(o))>GC)throw WC($C);for(i=0;i<s;i++,c++)i in o&&VC(a,c,o[i])}else{if(c>=GC)throw WC($C);VC(a,c++,o)}return a.length=c,a}});var YC={},JC=D,XC=W,QC=Pn.f,ZC=lg,tR="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];YC.f=function(t){return tR&&"Window"==JC(t)?function(t){try{return QC(t)}catch(t){return ZC(tR)}}(t):QC(XC(t))};var eR={},iR=se;eR.f=iR;var nR=q,sR=Ht,oR=eR,rR=$e.f,aR=function(t){var e=nR.Symbol||(nR.Symbol={});sR(e,t)||rR(e,t,{value:oR.f(t)})},cR=Ti,lR=u,dR=Z,hR=f,uR=y,pR=l,mR=S,vR=dt,gR=i,fR=Ht,ER=QE,_R=E,SR=K,bR=d,TR=ft,yR=Je,wR=Bt,CR=W,RR=ve,IR=ko,AR=N,OR=Ps,NR=ps,kR=Pn,LR=YC,PR=Zn,DR=_,MR=$e,xR=ds,UR=w,VR=mc,BR=Vr,jR=Nt.exports,FR=Gn,HR=Kt,GR=se,$R=eR,WR=aR,zR=ia,KR=Nr,qR=m_.forEach,YR=mn("hidden"),JR="Symbol",XR=GR("toPrimitive"),QR=KR.set,ZR=KR.getterFor(JR),tI=Object.prototype,eI=lR.Symbol,iI=eI&&eI.prototype,nI=lR.TypeError,sI=lR.QObject,oI=dR("JSON","stringify"),rI=DR.f,aI=MR.f,cI=LR.f,lI=UR.f,dI=pR([].push),hI=jR("symbols"),uI=jR("op-symbols"),pI=jR("string-to-symbol-registry"),mI=jR("symbol-to-string-registry"),vI=jR("wks"),gI=!sI||!sI.prototype||!sI.prototype.findChild,fI=mR&&gR((function(){return 7!=OR(aI({},"a",{get:function(){return aI(this,"a",{value:7}).a}})).a}))?function(t,e,i){var n=rI(tI,e);n&&delete tI[e],aI(t,e,i),n&&t!==tI&&aI(tI,e,n)}:aI,EI=function(t,e){var i=hI[t]=OR(iI);return QR(i,{type:JR,tag:t,description:e}),mR||(i.description=e),i},_I=function(t,e,i){t===tI&&_I(uI,e,i),yR(t);var n=RR(e);return yR(i),fR(hI,n)?(i.enumerable?(fR(t,YR)&&t[YR][n]&&(t[YR][n]=!1),i=OR(i,{enumerable:AR(0,!1)})):(fR(t,YR)||aI(t,YR,AR(1,{})),t[YR][n]=!0),fI(t,n,i)):aI(t,n,i)},SI=function(t,e){yR(t);var i=CR(e),n=NR(i).concat(wI(i));return qR(n,(function(e){mR&&!uR(bI,i,e)||_I(t,e,i[e])})),t},bI=function(t){var e=RR(t),i=uR(lI,this,e);return!(this===tI&&fR(hI,e)&&!fR(uI,e))&&(!(i||!fR(this,e)||!fR(hI,e)||fR(this,YR)&&this[YR][e])||i)},TI=function(t,e){var i=CR(t),n=RR(e);if(i!==tI||!fR(hI,n)||fR(uI,n)){var s=rI(i,n);return!s||!fR(hI,n)||fR(i,YR)&&i[YR][n]||(s.enumerable=!0),s}},yI=function(t){var e=cI(CR(t)),i=[];return qR(e,(function(t){fR(hI,t)||fR(FR,t)||dI(i,t)})),i},wI=function(t){var e=t===tI,i=cI(e?uI:CR(t)),n=[];return qR(i,(function(t){!fR(hI,t)||e&&!fR(tI,t)||dI(n,hI[t])})),n};if(vR||(BR(iI=(eI=function(){if(bR(iI,this))throw nI("Symbol is not a constructor");var t=arguments.length&&void 0!==arguments[0]?IR(arguments[0]):void 0,e=HR(t),i=function(t){this===tI&&uR(i,uI,t),fR(this,YR)&&fR(this[YR],e)&&(this[YR][e]=!1),fI(this,e,AR(1,t))};return mR&&gI&&fI(tI,e,{configurable:!0,set:i}),EI(e,t)}).prototype,"toString",(function(){return ZR(this).tag})),BR(eI,"withoutSetter",(function(t){return EI(HR(t),t)})),UR.f=bI,MR.f=_I,xR.f=SI,DR.f=TI,kR.f=LR.f=yI,PR.f=wI,$R.f=function(t){return EI(GR(t),t)},mR&&aI(iI,"description",{configurable:!0,get:function(){return ZR(this).description}})),cR({global:!0,wrap:!0,forced:!vR,sham:!vR},{Symbol:eI}),qR(NR(vI),(function(t){WR(t)})),cR({target:JR,stat:!0,forced:!vR},{for:function(t){var e=IR(t);if(fR(pI,e))return pI[e];var i=eI(e);return pI[e]=i,mI[i]=e,i},keyFor:function(t){if(!TR(t))throw nI(t+" is not a symbol");if(fR(mI,t))return mI[t]},useSetter:function(){gI=!0},useSimple:function(){gI=!1}}),cR({target:"Object",stat:!0,forced:!vR,sham:!mR},{create:function(t,e){return void 0===e?OR(t):SI(OR(t),e)},defineProperty:_I,defineProperties:SI,getOwnPropertyDescriptor:TI}),cR({target:"Object",stat:!0,forced:!vR},{getOwnPropertyNames:yI,getOwnPropertySymbols:wI}),cR({target:"Object",stat:!0,forced:gR((function(){PR.f(1)}))},{getOwnPropertySymbols:function(t){return PR.f(wR(t))}}),oI&&cR({target:"JSON",stat:!0,forced:!vR||gR((function(){var t=eI();return"[null]"!=oI([t])||"{}"!=oI({a:t})||"{}"!=oI(Object(t))}))},{stringify:function(t,e,i){var n=VR(arguments),s=e;if((SR(e)||void 0!==t)&&!TR(t))return ER(e)||(e=function(t,e){if(_R(s)&&(e=uR(s,this,t,e)),!TR(e))return e}),n[1]=e,hR(oI,null,n)}}),!iI[XR]){var CI=iI.valueOf;BR(iI,XR,(function(t){return uR(CI,this)}))}zR(eI,JR),FR[YR]=!0,aR("asyncIterator"),aR("hasInstance"),aR("isConcatSpreadable"),aR("iterator"),aR("match"),aR("matchAll"),aR("replace"),aR("search"),aR("species"),aR("split"),aR("toPrimitive"),aR("toStringTag"),aR("unscopables"),ia(u.JSON,"JSON",!0);var RI=q.Symbol;aR("asyncDispose"),aR("dispose"),aR("matcher"),aR("metadata"),aR("observable"),aR("patternMatch"),aR("replaceAll");var II=RI,AI=eR.f("asyncIterator"),OI=AI;function NI(t){this.wrapped=t}function kI(t){var e,i;function n(e,i){try{var o=t[e](i),r=o.value,a=r instanceof NI;NC.resolve(a?r.wrapped:r).then((function(t){a?n("return"===e?"return":"next",t):s(o.done?"return":"normal",t)}),(function(t){n("throw",t)}))}catch(t){s("throw",t)}}function s(t,s){switch(t){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?n(e.key,e.arg):i=null}this._invoke=function(t,s){return new NC((function(o,r){var a={key:t,arg:s,resolve:o,reject:r,next:null};i?i=i.next=a:(e=i=a,n(t,s))}))},"function"!=typeof t.return&&(this.return=void 0)}function LI(t){return function(){return new kI(t.apply(this,arguments))}}function PI(t){return new NI(t)}kI.prototype["function"==typeof II&&OI||"@@asyncIterator"]=function(){return this},kI.prototype.next=function(t){return this._invoke("next",t)},kI.prototype.throw=function(t){return this._invoke("throw",t)},kI.prototype.return=function(t){return this._invoke("return",t)};var DI=eR.f("iterator");function MI(t,e){var i={},n=!1;function s(i,s){return n=!0,s=new NC((function(e){e(t[i](s))})),{done:!1,value:e(s)}}return i[void 0!==II&&DI||"@@iterator"]=function(){return this},i.next=function(t){return n?(n=!1,t):s("next",t)},"function"==typeof t.throw&&(i.throw=function(t){if(n)throw n=!1,t;return s("throw",t)}),"function"==typeof t.return&&(i.return=function(t){return n?(n=!1,t):s("return",t)}),i}var xI=AI,UI={exports:{}};function VI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function BI(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?VI(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):VI(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function jI(t,e,i,n,s,o,r){let a=[],c=[],l=[],d=[],h=!1,u=!1;if(UI.exports.parse(t).mediaDescriptions.forEach((t=>{r&&r!==t.attributes.direction||("video"!==t.media.mediaType||h||(c=t.attributes.payloads,d=t.attributes.extmaps,h=!0),"audio"!==t.media.mediaType||u||(a=t.attributes.payloads,l=t.attributes.extmaps,u=!0))})),!d||0===c.length)throw new Error("Cannot get video capabilities from SDP.");if(!l||0===a.length)throw new Error("Cannot get audio capabilities from SDP.");return c.forEach((t=>{var e;null!==(e=t.rtpMap)&&void 0!==e&&e.clockRate&&(t.rtpMap.clockRate=parseInt(t.rtpMap.clockRate))})),a.forEach((t=>{var e;null!==(e=t.rtpMap)&&void 0!==e&&e.clockRate&&(t.rtpMap.clockRate=parseInt(t.rtpMap.clockRate))})),e&&(a=a.filter((t=>{var e;return"rtx"!==(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())})),c=c.filter((t=>{var e;return"rtx"!==(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())}))),i&&(c=c.filter((t=>{var e;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName)||"")}))),n&&(a=a.filter((t=>{var e;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName)||"")}))),s&&(null==s?void 0:s.length)>0&&(a=a.filter((t=>{var e;return s.includes((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"")}))),o&&(null==o?void 0:o.length)>0&&(c=c.filter((t=>{var e;return o.includes((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"")}))),{audioCodecs:a,videoCodecs:c,audioExtensions:l,videoExtensions:d}}function FI(t){const e=UI.exports.parse(t);let i,n;for(const t of e.mediaDescriptions){if(!i){const e=t.attributes.iceUfrag,n=t.attributes.icePwd;if(!e||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:e,icePwd:n}}if(!n){const e=t.attributes.fingerprints;e.length>0&&(n={fingerprints:e})}}if(!n&&e.attributes.fingerprints.length>0&&(n={fingerprints:e.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function HI(t,e){const i=[],n=t.attributes.ssrcGroups.filter((t=>"FID"===t.semantic)),s=t.attributes.ssrcGroups.find((t=>"SIM"===t.semantic)),o=t.attributes.ssrcs;if(s)s.ssrcIds.forEach((t=>{var s;const o=null===(s=n.find((e=>e.ssrcIds[0]===t)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:t,rtx:e?o:void 0})}));else if(n.length>0){const t=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:t,rtx:e?s:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function GI(t,e){const{cname:i}=t;let n;e&&e.ip&&"number"==typeof e.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],Av.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),Av.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):n=t.iceParameters.candidates.map((t=>({foundation:t.foundation,componentId:"1",transport:t.protocol,priority:t.priority.toString(),connectionAddress:t.ip,port:t.port.toString(),type:t.type,extension:{}})));const s={fingerprints:t.dtlsParameters.fingerprints.map((t=>({hashFunction:t.algorithm,fingerprint:t.fingerprint})))},o={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let r;switch(t.dtlsParameters.role){case"server":r="passive";break;case"client":r="active";break;case"auto":r="actpass"}return{dtlsParameters:s,iceParameters:o,candidates:n,rtpCapabilities:ZI(t.rtpCapabilities),setup:r,cname:i}}function $I(t,e,i){const n=[],s=[];return t.forEach((t=>{let{ssrcId:o,rtx:r}=t;const a=ZT(8,"track-"),c={ssrcId:o,attributes:BI({label:a,mslabel:i=i||ZT(10,""),msid:"".concat(i," ").concat(a)},e&&{cname:e})};if(n.push(c),void 0!==r){const t={ssrcId:r,attributes:BI({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},e&&{cname:e})};n.push(t),s.push({semantic:"FID",ssrcIds:[o,r]})}})),t.length>1&&s.push({semantic:"SIM",ssrcIds:t.map((t=>{let{ssrcId:e}=t;return e}))}),{ssrcs:n,ssrcGroups:s}}function WI(t,e){e instanceof RT&&t.attributes.payloads.forEach((t=>{var i;const n=null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.minptime="10",t.fmtp.parameters.useinbandfec="1";const s=e._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!zu()&&(t.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(t.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),t.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"))}))}function zI(t){const e=t.attributes.unrecognized.findIndex((t=>"x-google-flag"===t.attField&&"conference"===t.attValue));-1!==e&&t.attributes.unrecognized.splice(e,1)}function KI(t,e){if(!(e instanceof wC&&e._encoderConfig&&-1===e._hints.indexOf(uE.SCREEN_TRACK)))return;const i=e._encoderConfig;YE().supportMinBitrate&&i.bitrateMin&&t.attributes.payloads.forEach((t=>{var e;["h264","h265","vp8","vp9","av1"].includes((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"")&&(t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),YE().supportMinBitrate&&!e._hints.includes(uE.LOW_STREAM)&&i.bitrateMax&&t.attributes.payloads.forEach((t=>{var e;["h264","h265","vp8","vp9","av1"].includes((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"")&&(t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters["x-google-start-bitrate"]="".concat(Gv("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function qI(t){if("video"!==t.media.mediaType)return;const e=Vu();if(e.name!==ku.SAFARI&&e.os!==Nu.IOS)return;const i=t.attributes.extmaps.findIndex((t=>/video-orientation/g.test(t.extensionName)));-1!==i&&t.attributes.extmaps.splice(i,1)}function YI(t,e,i){if(!e)return;let n,s;if("video"===t.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===e.twcc){const e=n.find((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName));e&&(t.attributes.extmaps.find((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName))||t.attributes.extmaps.push({entry:e.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(t,e){return e.filter((e=>!!t.find((t=>t.payloadType===e.payloadType&&!!t.rtcpFeedbacks.find((t=>"transport-cc"===t.type))))))}(s,t.attributes.payloads).forEach((t=>{t.rtcpFeedbacks.find((t=>"transport-cc"===t.type))||t.rtcpFeedbacks.push({type:"transport-cc"})})))}else if(!1===e.twcc){const e=t.attributes.extmaps.findIndex((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName));-1!==e&&t.attributes.extmaps.splice(e,1),t.attributes.payloads.forEach((t=>{const e=t.rtcpFeedbacks.findIndex((t=>"transport-cc"===t.type));-1!==e&&t.rtcpFeedbacks.splice(e,1)}))}if(!0===e.remb){const e=n.find((t=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===t.extensionName));e&&(t.attributes.extmaps.find((t=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===t.extensionName))||t.attributes.extmaps.push({entry:e.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(t,e){return e.filter((e=>!!t.find((t=>t.payloadType===e.payloadType&&!!t.rtcpFeedbacks.find((t=>"goog-remb"===t.type))))))}(s,t.attributes.payloads).forEach((t=>{t.rtcpFeedbacks.find((t=>"goog-remb"===t.type))||t.rtcpFeedbacks.push({type:"goog-remb"})})))}else if(!1===e.remb){const e=t.attributes.extmaps.findIndex((t=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===t.extensionName));-1!==e&&t.attributes.extmaps.splice(e,1),t.attributes.payloads.forEach((t=>{const e=t.rtcpFeedbacks.findIndex((t=>"goog-remb"===t.type));-1!==e&&t.rtcpFeedbacks.splice(e,1)}))}}function JI(t,e,i){if(zu())return;if("video"!==t.media.mediaType)return;if(!(e instanceof wC))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!Gv("SIMULCAST"))return;if(void 0===e._scalabiltyMode||e._scalabiltyMode.numSpatialLayers<=1)return;const n="vp8"===i?2:e._scalabiltyMode.numSpatialLayers,s=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find((t=>"FID"===t.semantic&&t.ssrcIds[0]===s.ssrcId)),r={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let e=1;e<n;e++)t.attributes.ssrcs.push({ssrcId:s.ssrcId+e,attributes:hy(s.attributes)}),r.ssrcIds.push(s.ssrcId+e),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+e,attributes:hy(s.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+e,o.ssrcIds[1]+e]}));t.attributes.ssrcGroups.unshift(r)}async function XI(t,e,i,n,s){const o=new RTCPeerConnection;o.addTransceiver("video",{direction:"sendonly"}),o.addTransceiver("audio",{direction:"sendonly"}),o.addTransceiver("video",{direction:"recvonly"}),o.addTransceiver("audio",{direction:"recvonly"});const r=(await o.createOffer()).sdp,a=jI(r,t,e,i,n,s,"sendonly"),c=jI(r,t,e,i,n,s,"recvonly"),l={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},d={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(QI(a,c,"videoExtensions",l,d,h),QI(a,c,"videoCodecs",l,d,h),QI(a,c,"audioExtensions",l,d,h),QI(a,c,"audioCodecs",l,d,h),Gv("RAISE_H264_BASELINE_PRIORITY")){const t=h.videoCodecs.findIndex((t=>{var e,i;return"h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==t){const e=h.videoCodecs.findIndex((t=>{var e;return"h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())}));if(e<t){Av.debug("raising H264 baseline profile priority");const i=h.videoCodecs[t];h.videoCodecs.splice(t,1),h.videoCodecs.splice(e,0,i)}-1!==e&&(d.videoCodecs=d.videoCodecs.filter((t=>{var e,i;return!("h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==e&&Gv("FILTER_SEND_H264_BASELINE")&&(l.videoCodecs=l.videoCodecs.filter((t=>{var e,i;return!("h264"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}try{o.close()}catch(t){}return{send:l,recv:d,sendrecv:h}}function QI(t,e,i,n,s,o){if("videoExtensions"===i||"audioExtensions"===i){const r=[];return t[i].forEach((t=>{e[i].some(((e,i)=>{if(t.entry===e.entry&&t.extensionName===e.extensionName)return r.push(i),!0}))?o[i].push(t):n[i].push(t)})),void e[i].forEach(((t,e)=>{-1===r.indexOf(e)&&s[i].push(t)}))}if("videoCodecs"===i||"audioCodecs"===i){const r=[];return t[i].forEach((t=>{e[i].some(((e,i)=>{if(t.payloadType===e.payloadType&&JSON.stringify(t)===JSON.stringify(e))return r.push(i),!0}))?o[i].push(t):n[i].push(t)})),void e[i].forEach(((t,e)=>{-1===r.indexOf(e)&&s[i].push(t)}))}}function ZI(t){const{send:e,recv:i,sendrecv:n}=t;if(!n){if(!e||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:i}}let s,o;return e?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...e.audioCodecs,...n.audioCodecs],s.videoCodecs=[...e.videoCodecs,...n.videoCodecs],s.audioExtensions=[...e.audioExtensions,...n.audioExtensions],s.videoExtensions=[...e.videoExtensions,...n.videoExtensions]):s=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:s,recv:o}}function tA(t){"audio"===t.media.mediaType&&t.attributes.payloads.filter((t=>{var e;return"opus"===(null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())})).forEach((t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"}))}function eA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function iA(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?eA(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):eA(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}!function(t,e){t.exports=(()=>{var t={8:(t,e,i)=>{i.r(e),i.d(e,{Parser:()=>T,Printer:()=>I,parse:()=>k,print:()=>L});const n="\n",s="".concat("\r").concat(n),o=" ";let r;function a(t){return t>="0"&&t<="9"}function c(t){return t>="!"&&t<="~"}function l(t){return c(t)||t>=""&&t<="ÿ"}function d(t){return"!"===t||t>="#"&&t<="'"||t>="*"&&t<="+"||t>="-"&&t<="."||t>="0"&&t<="9"||t>="A"&&t<="Z"||t>="^"&&t<="~"}function h(t){return t>="1"&&t<="9"}function u(t){return t>="A"&&t<="Z"||t>="a"&&t<="z"}function p(t){return"d"===t||"h"===t||"m"===t||"s"===t}function m(t){return t>""&&t<"\t"||t>"\v"&&t<"\f"||t>""&&t<"ÿ"}function v(t){return u(t)||a(t)||"+"===t||"/"===t}function g(t){return a(t)||u(t)||"+"===t||"/"===t||"-"===t||"_"===t}function f(t){return u(t)||a(t)||"+"===t||"/"===t}function E(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function _(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?E(Object(i),!0).forEach((function(e){S(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):E(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function S(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}!function(t){t.VERSION="v",t.ORIGIN="o",t.SESSION_NAME="s",t.INFORMATION="i",t.URI="u",t.EMAIL="e",t.PHONE="p",t.CONNECTION="c",t.BANDWIDTH="b",t.TIME="t",t.REPEAT="r",t.ZONE_ADJUSTMENTS="z",t.KEY="k",t.ATTRIBUTE="a",t.MEDIA="m"}(r||(r={}));class b{consumeText(t,e){let i=e;for(;i<t.length;){const e=t[i];if("\0"===e||"\r"===e||e===n)break;i+=1}if(i-e==0)throw new Error("Invalid text, at ".concat(t));return i}consumeUnicastAddress(t,e,i){return this.consumeTill(t,e,o)}consumeOneOrMore(t,e,i){let n=e;for(;i(t[n]);)n++;if(n-e==0)throw new Error("Invalid rule at ".concat(e,"."));return n}consumeSpace(t,e){if(t[e]===o)return e+1;throw new Error("Invalid space at ".concat(e,"."))}consumeIP4Address(t,e){let i=e;for(let e=0;e<4;e++)if(i=this.consumeDecimalUChar(t,i),3!==e){if("."!==t[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(t,e){let i=e;for(let e=0;e<3&&a(t[i]);e++,i++);if(i-e==0)throw new Error("Invalid decimal uchar.");const n=parseInt(t.slice(e,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(t,e){let i=this.consumeHexpart(t,e);return":"===t[i]?(i+=1,i=this.consumeIP4Address(t,i),i):i}consumeHexpart(t,e){let i=e;if(":"===t[i]&&":"===t[i+1]){i+=2;try{i=this.consumeHexseq(t,i)}catch(t){}return i}if(i=this.consumeHexseq(t,i),":"===t[i]&&":"===t[i+1]){i+=2;try{i=this.consumeHexseq(t,i)}catch(t){}return i}return i}consumeHexseq(t,e){let i=e;for(;i=this.consumeHex4(t,i),":"===t[i]&&":"!==t[i+1];)i+=1;return i}consumeHex4(t,e){let i=0;for(;i<4;i++)if(!((n=t[e+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return e+i}consumeFQDN(t,e){let i=e;for(;a(t[i])||u(t[i])||"-"===t[i]||"."===t[i];)i+=1;if(i-e<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(t,e){return this.consumeOneOrMore(t,e,l)}consumeMulticastAddress(t,e,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(t,e);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(t,e);default:try{return this.consumeFQDN(t,e)}catch(i){return this.consumeExtnAddr(t,e)}}}consumeIP6MulticastAddress(t,e){const i=this.consumeHexpart(t,e);return"/"===t[i]?this.consumeInteger(t,i+1):i}consumeIP4MulticastAddress(t,e){let i=e+3;const n=t.slice(e,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let e=0;e<3;e++){if("."!==t[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(t,i)}return"/"===t[i]&&(i+=1),i=this.consumeTTL(t,i),"/"===t[i]&&(i=this.consumeInteger(t,i)),i}consumeInteger(t,e){if(!h(t[e]))throw new Error("Invalid integer.");for(e+=1;a(t[e]);)e+=1;return e}consumeTTL(t,e){if("0"===t[e])return e+1;if(!h(t[e]))throw new Error("Invalid TTL.");e+=1;for(let i=0;i<2&&a(t[e]);i++)e+=1;return e}consumeToken(t,e){return this.consumeOneOrMore(t,e,d)}consumeTime(t,e){let i=e;if("0"===t[i])return i+1;for(h(t[i])&&(i+=1);a(t[i]);)i++;if(i-e<10)throw new Error("Invalid time");return i}consumeAddress(t,e){return this.consumeTill(t,e,o)}consumeTypedTime(t,e){let i=e;return i=this.consumeOneOrMore(t,i,a),p(t[i])?i+1:i}consumeRepeatInterval(t,e){if(!h(t[e]))throw new Error("Invalid repeat interval");for(e+=1;a(t[e]);)e+=1;return p(t[e])&&(e+=1),e}consumePort(t,e){return this.consumeOneOrMore(t,e,a)}consume(t,e,i){for(let n=0;n<i.length;n++){if(e+n>=t.length)throw new Error("consume exceeding value length");if(t[e+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return e+i.length}consumeTill(t,e,i){let n=e;for(;n<t.length&&("string"!=typeof i||t[n]!==i)&&("function"!=typeof i||!i(t[n]));)n++;return n}}class T extends b{constructor(){super(),S(this,"records",[]),S(this,"currentLine",0)}parse(t){const e=this.probeEOL(t);this.records=t.split(e).filter((t=>!!t.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),o=this.parseInformation(),r=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),l=this.parseConnection(),d=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),m=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:o,uri:r,emails:a,phones:c,connection:l,bandwidths:d,timeFields:h,key:u,attributes:p,mediaDescriptions:m}}getCurrentRecord(){const t=this.records[this.currentLine];if(!t)throw new Error("Record doesn't exit.");return t}probeEOL(t){for(let e=0;e<t.length;e++)if(t[e]===n)return"\r"===t[e-1]?s:n;throw new Error("Invalid newline character.")}parseLine(t,e){if(t.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=t[0];if("="!==t[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:t.slice(2),line:e,cur:0}}parseSessionAttribute(){const t=new w;for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(t=>d(t)&&":"!==t)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,m)),t.parse(i),this.currentLine++}return t.digest()}parseMediaAttributes(t){const e=new C(t);for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(t=>d(t)&&":"!==t)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,m)),e.parse(i),this.currentLine++}return e.digest()}parseKey(){const t=this.getCurrentRecord();if(t.type===r.KEY){if("prompt"===t.value||"clear:"===t.value||"base64:"===t.value||"uri:"===t.value)return t.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const t=this.getCurrentRecord();if(t.type===r.ZONE_ADJUSTMENTS){const e=[];for(;;)try{const i=this.extract(t,this.consumeTime);this.consumeSpaceForRecord(t);let n=!1;"-"===t.value[t.cur]&&(n=!0,t.cur+=1);const s=this.extract(t,this.consumeTypedTime);e.push({time:i,typedTime:s,back:n})}catch(t){break}if(0===e.length)throw new Error("Invalid zone adjustments");return this.currentLine++,e}return[]}parseRepeat(){const t=[];for(;;){const e=this.getCurrentRecord();if(e.type!==r.REPEAT)break;{const i=this.extract(e,this.consumeRepeatInterval),n=this.parseTypedTime(e);t.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return t}parseTypedTime(t){const e=[];for(;;)try{this.consumeSpaceForRecord(t),e.push(this.extract(t,this.consumeTypedTime))}catch(t){break}if(0===e.length)throw new Error("Invalid typed time.");return e}parseTime(){const t=this.getCurrentRecord(),e=this.extract(t,this.consumeTime);this.consumeSpaceForRecord(t);const i=this.extract(t,this.consumeTime);return this.currentLine++,{startTime:e,stopTime:i}}parseBandWidth(){const t=[];for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==r.BANDWIDTH)break;{const i=this.extractOneOrMore(e,d);if(":"!==e.value[e.cur])throw new Error("Invalid bandwidth field.");e.cur++;const n=this.extractOneOrMore(e,a);t.push({bwtype:i,bandwidth:n}),this.currentLine++}}return t}parseVersion(){const t=this.getCurrentRecord();if(t.type!==r.VERSION)throw new Error("first sdp record must be version");const e=t.value.slice(0,this.consumeOneOrMore(t.value,0,a));if(e.length!==t.value.length)throw new Error('invalid proto version, "v='.concat(t.value,'"'));return this.currentLine++,e}parseOrigin(){const t=this.getCurrentRecord();if(t.type!==r.ORIGIN)throw new Error("second line of sdp must be origin");const e=this.extractOneOrMore(t,l);this.consumeSpaceForRecord(t);const i=this.extractOneOrMore(t,a);this.consumeSpaceForRecord(t);const n=this.extractOneOrMore(t,a);this.consumeSpaceForRecord(t);const s=this.extractOneOrMore(t,d);this.consumeSpaceForRecord(t);const o=this.extractOneOrMore(t,d);this.consumeSpaceForRecord(t);const c=this.extract(t,this.consumeUnicastAddress);return this.currentLine++,{username:e,sessId:i,sessVersion:n,nettype:s,addrtype:o,unicastAddress:c}}parseSessionName(){const t=this.getCurrentRecord();if(t.type===r.SESSION_NAME){const e=this.extract(t,this.consumeText);return this.currentLine++,e}}parseInformation(){const t=this.getCurrentRecord();if(t.type!==r.INFORMATION)return;const e=this.extract(t,this.consumeText);return this.currentLine++,e}parseUri(){const t=this.getCurrentRecord();if(t.type===r.URI)return this.currentLine++,t.value}parseEmail(){const t=[];for(;;){const e=this.getCurrentRecord();if(e.type!==r.EMAIL)break;t.push(e.value),this.currentLine++}return t}parsePhone(){const t=[];for(;;){const e=this.getCurrentRecord();if(e.type!==r.PHONE)break;t.push(e.value),this.currentLine++}return t}parseConnection(){const t=this.getCurrentRecord();if(t.type===r.CONNECTION){const e=this.extractOneOrMore(t,d);this.consumeSpaceForRecord(t);const i=this.extractOneOrMore(t,d);this.consumeSpaceForRecord(t);const n=this.extract(t,this.consumeAddress);return this.currentLine++,{nettype:e,addrtype:i,address:n}}}parseMedia(){const t=this.getCurrentRecord(),e=this.extract(t,this.consumeToken);this.consumeSpaceForRecord(t);let i=this.extract(t,this.consumePort);"/"===t.value[t.cur]&&(t.cur+=1,i+=this.extract(t,this.consumeInteger)),this.consumeSpaceForRecord(t);const n=[];for(n.push(this.extract(t,this.consumeToken));"/"===t.value[t.cur];)t.cur+=1,n.push(this.extract(t,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(t);return this.currentLine++,{mediaType:e,port:i,protos:n,fmts:s}}parseTimeFields(){const t=[];for(;this.getCurrentRecord().type===r.TIME;){const e=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();t.push({time:e,repeats:i,zones:n})}return t}parseMediaDescription(){const t=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.MEDIA;){const e=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),o=this.parseKey(),r=this.parseMediaAttributes(e);t.push({media:e,information:i,connections:n,bandwidths:s,key:o,attributes:r})}return t}parseConnections(){const t=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.CONNECTION;)t.push(this.parseConnection());return t}parseFmt(t){const e=[];for(;;)try{this.consumeSpaceForRecord(t),e.push(this.extract(t,this.consumeToken))}catch(t){break}if(0===e.length)throw new Error("Invalid fmts");return e}extract(t,e,...i){const n=e.call(this,t.value,t.cur,...i),s=t.value.slice(t.cur,n);return t.cur=n,s}extractOneOrMore(t,e){const i=this.consumeOneOrMore(t.value,t.cur,e),n=t.value.slice(t.cur,i);return t.cur=i,n}consumeSpaceForRecord(t){if(t.value[t.cur]!==o)throw new Error("Invalid space at ".concat(t.cur,"."));t.cur+=1}}class y extends b{constructor(...t){super(...t),S(this,"attributes",void 0),S(this,"digested",!1)}extractOneOrMore(t,e,i){const n=this.consumeOneOrMore(t.attValue,t._cur,e),s=t.attValue.slice(t._cur,n),[o,r]=i||[];if("number"==typeof o&&s.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof r&&s.length>r)throw new Error("error in length, should be less or equal than ".concat(r," characters."));return t._cur=n,s}consumeAttributeSpace(t){if(t.attValue[t._cur]!==o)throw new Error("Invalid space at ".concat(t._cur,"."));t._cur+=1}extract(t,e,...i){if(!t.attValue)throw new Error("Nothing to extract from attValue.");const n=e.call(this,t.attValue,t._cur,...i),s=t.attValue.slice(t._cur,n);return t._cur=n,s}atEnd(t){if(!t.attValue)throw new Error;return t._cur>=t.attValue.length}peekChar(t){if(!t.attValue)throw new Error;return t.attValue[t._cur]}peek(t,e){if(!t.attValue)throw new Error;for(let i=0;i<e.length;i++)if(e[i]!==t.attValue[t._cur+i])return!1;return!0}parseIceUfrag(t){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(t,v,[4,256])}parseIcePwd(t){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(t,v,[22,256])}parseIceOptions(t){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const e=[];for(;!this.atEnd(t);){e.push(this.extractOneOrMore(t,v));try{this.consumeAttributeSpace(t)}catch(e){if(this.atEnd(t))break;throw e}}this.attributes.iceOptions=e}parseFingerprint(t){const e=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill);this.attributes.fingerprints.push({hashFunction:e,fingerprint:i})}parseExtmap(t){const e=this.extractOneOrMore(t,a);let i;"/"===this.peekChar(t)&&(this.extract(t,this.consume,"/"),i=this.extract(t,this.consumeToken)),this.consumeAttributeSpace(t);const n=this.extract(t,this.consumeTill,o),s=_(_({entry:parseInt(e,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(t)===o&&(this.consumeAttributeSpace(t),s.extensionAttributes=this.extract(t,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(t){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const e=this.extract(t,this.consumeTill);if("active"!==e&&"passive"!==e&&"actpass"!==e&&"holdconn"!==e)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=e}}class w extends y{constructor(...t){super(...t),S(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(t){if(this.digested)throw new Error("already digested");try{switch(t.attField){case"group":this.parseGroup(t);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(t);break;case"ice-pwd":this.parseIcePwd(t);break;case"ice-options":this.parseIceOptions(t);break;case"fingerprint":this.parseFingerprint(t);break;case"setup":this.parseSetup(t);break;case"tls-id":this.parseTlsId(t);break;case"identity":this.parseIdentity(t);break;case"extmap":this.parseExtmap(t);break;case"msid-semantic":this.parseMsidSemantic(t);break;default:t.ignored=!0,this.attributes.unrecognized.push(t)}}catch(e){throw console.error("parsing session attribute ".concat(t.attField,' error, "a=').concat(t.attField,":").concat(t.attValue,'"')),e}if(!t.ignored&&t.attValue&&!this.atEnd(t))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(t){const e=this.extract(t,this.consumeToken),i=[];for(;!this.atEnd(t)&&this.peekChar(t)===o;)this.consumeAttributeSpace(t),i.push(this.extract(t,this.consumeToken));this.attributes.groups.push({semantic:e,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(t){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(t,g)}parseIdentity(t){const e=this.extractOneOrMore(t,f),i=[];for(;!this.atEnd(t)&&this.peekChar(t)===o;){this.consumeAttributeSpace(t);const e=this.extract(t,this.consumeToken);this.extract(t,this.consume,"=");const n=this.extractOneOrMore(t,(t=>t!==o&&m(t)));i.push({name:e,value:n})}this.attributes.identities.push({assertionValue:e,extensions:i})}parseMsidSemantic(t){this.peekChar(t)===o&&this.consumeAttributeSpace(t);const e={semantic:this.extract(t,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(t)}catch(t){break}if("*"===this.peekChar(t)){this.extract(t,this.consume,"*"),e.applyForAll=!0;break}{const i=this.extract(t,this.consumeTill,o);e.identifierList.push(i)}}this.attributes.msidSemantic=e}}class C extends y{constructor(t){super(),S(this,"attributes",void 0),-1!==t.protos.indexOf("RTP")||t.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(t){if(this.digested)throw new Error("already digested");try{switch(t.attField){case"extmap":this.parseExtmap(t);break;case"setup":this.parseSetup(t);break;case"ice-ufrag":this.parseIceUfrag(t);break;case"ice-pwd":this.parseIcePwd(t);break;case"ice-options":this.parseIceOptions(t);break;case"candidate":this.parseCandidate(t);break;case"remote-candidate":this.parseRemoteCandidate(t);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(t);break;case"rtpmap":this.parseRtpmap(t);break;case"ptime":this.parsePtime(t);break;case"maxptime":this.parseMaxPtime(t);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(t);break;case"ssrc":this.parseSSRC(t);break;case"fmtp":this.parseFmtp(t);break;case"rtcp-fb":this.parseRtcpFb(t);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(t);break;case"mid":this.parseMid(t);break;case"msid":this.parseMsid(t);break;case"imageattr":this.parseImageAttr(t);break;case"rid":this.parseRid(t);break;case"simulcast":this.parseSimulcast(t);break;case"sctp-port":this.parseSctpPort(t);break;case"max-message-size":this.parseMaxMessageSize(t);break;case"ssrc-group":this.parseSSRCGroup(t);break;default:t.ignored=!0,this.attributes.unrecognized.push(t)}}catch(e){throw console.error("parsing media attribute ".concat(t.attField,' error, "a=').concat(t.attField,":").concat(t.attValue,'"')),e}if(!t.ignored&&t.attValue&&!this.atEnd(t))throw new Error("attribute parsing error")}parseCandidate(t){const e=this.extractOneOrMore(t,v,[1,32]);this.consumeAttributeSpace(t);const i=this.extractOneOrMore(t,a,[1,5]);this.consumeAttributeSpace(t);const n=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t);const s=this.extractOneOrMore(t,a,[1,10]);this.consumeAttributeSpace(t);const r=this.extract(t,this.consumeAddress);this.consumeAttributeSpace(t);const l=this.extract(t,this.consumePort);this.consumeAttributeSpace(t),this.extract(t,this.consume,"typ"),this.consumeAttributeSpace(t);const d={foundation:e,componentId:i,transport:n,priority:s,connectionAddress:r,port:l,type:this.extract(t,this.consumeToken),extension:{}};for(this.peek(t," raddr")&&(this.extract(t,this.consume," raddr"),this.consumeAttributeSpace(t),d.relAddr=this.extract(t,this.consumeAddress)),this.peek(t," rport")&&(this.extract(t,this.consume," rport"),this.consumeAttributeSpace(t),d.relPort=this.extract(t,this.consumePort));this.peekChar(t)===o;){this.consumeAttributeSpace(t);const e=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t),d.extension[e]=this.extractOneOrMore(t,c)}this.attributes.candidates.push(d)}parseRemoteCandidate(t){const e=[];for(;;){const i=this.extractOneOrMore(t,a,[1,5]);this.consumeAttributeSpace(t);const n=this.extract(t,this.consumeAddress);this.consumeAttributeSpace(t);const s=this.extract(t,this.consumePort);e.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(t)}catch(t){break}}this.attributes.remoteCandidatesList.push(e)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(t){const e=this.extract(t,this.consumeToken);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill,"/");this.extract(t,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(t,a)};this.atEnd(t)||"/"!==this.peekChar(t)||(this.extract(t,this.consume,"/"),n.encodingParameters=parseInt(this.extract(t,this.consumeTill),10));const s=this.attributes.payloads.find((t=>t.payloadType===parseInt(e,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(e,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(t){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(t,this.consumeTill)}parseMaxPtime(t){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(t,this.consumeTill)}parseDirection(t){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=t.attField}parseSSRC(t){const e=this.extractOneOrMore(t,a);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill,":");let n;":"===this.peekChar(t)&&(this.extract(t,this.consume,":"),n=this.extract(t,this.consumeTill));const s=this.attributes.ssrcs.find((t=>t.ssrcId===parseInt(e,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(e,10),attributes:{[i]:n}})}parseFmtp(t){const e=this.extract(t,this.consumeTill,o);this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill),n={};i.split(";").forEach((t=>{let[e,i]=t.split("=");e=e.trim();const s="string"==typeof i?i.trim():null;"string"==typeof e&&e.length>0&&(n[e]=s)}));const s=this.attributes.payloads.find((t=>t.payloadType===parseInt(e,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(e,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(t){const e={},i=this.extract(t,this.consumeTill,"=");t._cur++;const n=this.extract(t,this.consumeTill,";");for(e[i]=n;";"===t.attValue[t._cur];){const i=this.extract(t,this.consumeTill,"=");t._cur++;const n=this.extract(t,this.consumeTill,";");e[i]=n}return e}parseRtcpFb(t){let e="";e="*"===this.peekChar(t)?this.extract(t,this.consume,"*"):this.extract(t,this.consumeTill,o),this.consumeAttributeSpace(t);const i=this.extract(t,this.consumeTill,o);let n;if("trr-int"===i)n={type:i,interval:this.extract(t,this.consumeTill)};else{const e={type:i};this.peekChar(t)===o&&(this.consumeAttributeSpace(t),e.parameter=this.extract(t,this.consumeToken),this.peekChar(t)===o&&(e.additional=this.extract(t,this.consumeTill))),n=e}if("*"===e)this.attributes.rtcpFeedbackWildcards.push(n);else{const t=this.attributes.payloads.find((t=>t.payloadType===parseInt(e,10)));t?t.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(e,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(t){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const e={port:this.extract(t,this.consumePort)};this.peekChar(t)===o&&(this.consumeAttributeSpace(t),e.netType=this.extractOneOrMore(t,d),this.consumeAttributeSpace(t),e.addressType=this.extractOneOrMore(t,d),this.consumeAttributeSpace(t),e.address=this.extract(t,this.consumeAddress)),this.attributes.rtcp=e}parseMsid(t){const e={id:this.extractOneOrMore(t,d,[1,64])};this.peekChar(t)===o&&(this.consumeAttributeSpace(t),e.appdata=this.extractOneOrMore(t,d,[1,64])),this.attributes.msids.push(e)}parseImageAttr(t){this.attributes.imageattr.push(t.attValue)}parseRid(t){const e=this.extractOneOrMore(t,(t=>u(t)||a(t)||"_"===t||"-"===t));this.consumeAttributeSpace(t);const i={id:e,direction:this.extract(t,this.consumeToken),params:[]};if(this.peekChar(t)===o){if(this.consumeAttributeSpace(t),this.peek(t,"pt=")){this.extract(t,this.consume,"pt=");const e=[];for(;;){const i=this.extract(t,this.consumeToken);e.push(i);try{this.extract(t,this.consume,",")}catch(t){break}}i.payloads=e,this.peekChar(t)===o&&this.extract(t,this.consume,o)}for(;;){const e=this.extract(t,this.consumeToken);switch(e){case"depend":{const n={type:e,rids:this.extract(t,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:e};"="===this.peekChar(t)&&(this.extract(t,this.consume,"="),n.val=this.extract(t,this.consumeTill,";")),i.params.push(n)}}try{this.extract(t,this.consume,";")}catch(t){break}}}this.attributes.rids.push(i)}parseSimulcast(t){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=t.attValue,this.extract(t,this.consumeTill)}parseSctpPort(t){this.attributes.sctpPort=this.extractOneOrMore(t,a,[1,5])}parseMaxMessageSize(t){this.attributes.maxMessageSize=this.extractOneOrMore(t,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(t){this.attributes.mid=this.extract(t,this.consumeToken)}parseSSRCGroup(t){const e=this.extract(t,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(t);const e=this.extract(t,this.consumeInteger);i.push(parseInt(e,10))}catch(t){break}this.attributes.ssrcGroups.push({semantic:e,ssrcIds:i})}}function R(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class I{constructor(){R(this,"eol",s)}print(t,e){let i="";return e&&(this.eol=e),i+=this.printVersion(t.version),i+=this.printOrigin(t.origin),i+=this.printSessionName(t.sessionName),i+=this.printInformation(t.information),i+=this.printUri(t.uri),i+=this.printEmail(t.emails),i+=this.printPhone(t.phones),i+=this.printConnection(t.connection),i+=this.printBandwidth(t.bandwidths),i+=this.printTimeFields(t.timeFields),i+=this.printKey(t.key),i+=this.printSessionAttributes(t.attributes),i+=this.printMediaDescription(t.mediaDescriptions),i}printVersion(t){return"v=".concat(t).concat(this.eol)}printOrigin(t){return"o=".concat(t.username," ").concat(t.sessId," ").concat(t.sessVersion," ").concat(t.nettype," ").concat(t.addrtype," ").concat(t.unicastAddress).concat(this.eol)}printSessionName(t){return t?"s=".concat(t).concat(this.eol):""}printInformation(t){return t?"i=".concat(t).concat(this.eol):""}printUri(t){return t?"u=".concat(t).concat(this.eol):""}printEmail(t){let e="";for(const i of t)e+="e=".concat(i).concat(this.eol);return e}printPhone(t){let e="";for(const i of t)e+="e=".concat(i).concat(this.eol);return e}printConnection(t){return t?"c=".concat(t.nettype," ").concat(t.addrtype," ").concat(t.address).concat(this.eol):""}printBandwidth(t){let e="";for(const i of t)e+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return e}printTimeFields(t){let e="";for(const i of t){e+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const t of i.repeats)e+="r=".concat(t.repeatInterval," ").concat(t.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(e+="z=",e+="z=".concat(i.zoneAdjustments.map((t=>"".concat(t.time," ").concat(t.back?"-":""," ").concat(t.typedTime))).join(" ")).concat(this.eol),e+=this.eol)}return e}printKey(t){return t?"k=".concat(t).concat(this.eol):""}printAttributes(t){let e="";for(const i of t)e+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return e}printMediaDescription(t){let e="";for(const i of t)e+=this.printMedia(i.media),e+=this.printInformation(i.information),e+=this.printConnections(i.connections),e+=this.printBandwidth(i.bandwidths),e+=this.printKey(i.key),e+=this.printMediaAttributes(i);return e}printConnections(t){let e="";for(const i of t)e+=this.printConnection(i);return e}printMedia(t){return"m=".concat(t.mediaType," ").concat(t.port," ").concat(t.protos.join("/")," ").concat(t.fmts.join(" ")).concat(this.eol)}printSessionAttributes(t){return new O(this.eol).print(t)}printMediaAttributes(t){return new N(this.eol).print(t)}}class A{constructor(t){R(this,"eol",void 0),this.eol=t}printIceUfrag(t){return void 0===t?"":"a=ice-ufrag:".concat(t).concat(this.eol)}printIcePwd(t){return void 0===t?"":"a=ice-pwd:".concat(t).concat(this.eol)}printIceOptions(t){return void 0===t?"":"a=ice-options:".concat(t.join(o)).concat(this.eol)}printFingerprints(t){return t.length>0?t.map((t=>"a=fingerprint:".concat(t.hashFunction).concat(o).concat(t.fingerprint))).join(this.eol)+this.eol:""}printExtmap(t){return t.map((t=>"a=extmap:".concat(t.entry).concat(t.direction?"/".concat(t.direction):"").concat(o).concat(t.extensionName).concat(t.extensionAttributes?"".concat(o).concat(t.extensionAttributes):"").concat(this.eol))).join("")}printSetup(t){return void 0===t?"":"a=setup:".concat(t).concat(this.eol)}printUnrecognized(t){return t.map((t=>"a=".concat(t.attField).concat(t.attValue?":".concat(t.attValue):"").concat(this.eol))).join("")}}class O extends A{print(t){let e="";return e+=this.printGroups(t.groups),e+=this.printMsidSemantic(t.msidSemantic),e+=this.printIceLite(t.iceLite),e+=this.printIceUfrag(t.iceUfrag),e+=this.printIcePwd(t.icePwd),e+=this.printIceOptions(t.iceOptions),e+=this.printFingerprints(t.fingerprints),e+=this.printSetup(t.setup),e+=this.printTlsId(t.tlsId),e+=this.printIdentity(t.identities),e+=this.printExtmap(t.extmaps),e+=this.printUnrecognized(t.unrecognized),e}printGroups(t){let e="";return t.length>0&&(e+=t.map((t=>"a=group:".concat(t.semantic).concat(t.identificationTag.map((t=>"".concat(o).concat(t))).join("")).concat(this.eol))).join("")),e}printIceLite(t){return void 0===t?"":"a=ice-lite"+this.eol}printTlsId(t){return t?"a=tls-id:".concat(t).concat(this.eol):""}printIdentity(t){return 0===t.length?"":t.map((t=>"a=identity:".concat(t.assertionValue).concat(t.extensions.map((t=>"".concat(o).concat(t.name).concat(t.value?"=".concat(t.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(t){if(!t)return"";let e="a=msid-semantic:".concat(t.semantic);return t.applyForAll?e+="".concat(o,"*"):t.identifierList.length>0&&(e+=t.identifierList.map((t=>"".concat(o).concat(t)))),e+this.eol}}class N extends A{print(t){const e=t.attributes;let i="";return i+=this.printRTCP(e.rtcp),i+=this.printIceUfrag(e.iceUfrag),i+=this.printIcePwd(e.icePwd),i+=this.printIceOptions(e.iceOptions),i+=this.printCandidates(e.candidates),i+=this.printRemoteCandidatesList(e.remoteCandidatesList),i+=this.printEndOfCandidates(e.endOfCandidates),i+=this.printFingerprints(e.fingerprints),i+=this.printSetup(e.setup),i+=this.printMid(e.mid),i+=this.printExtmap(e.extmaps),i+=this.printRTPRelated(e),i+=this.printPtime(e.ptime),i+=this.printMaxPtime(e.maxPtime),i+=this.printDirection(e.direction),i+=this.printSSRCGroups(e.ssrcGroups),i+=this.printSSRC(e.ssrcs),i+=this.printRTCPMux(e.rtcpMux),i+=this.printRTCPMuxOnly(e.rtcpMuxOnly),i+=this.printRTCPRsize(e.rtcpRsize),i+=this.printMSId(e.msids),i+=this.printImageattr(e.imageattr),i+=this.printRid(e.rids),i+=this.printSimulcast(e.simulcast),i+=this.printSCTPPort(e.sctpPort),i+=this.printMaxMessageSize(e.maxMessageSize),i+=this.printUnrecognized(e.unrecognized),i}printCandidates(t){return t.map((t=>"a=candidate:".concat(t.foundation).concat(o).concat(t.componentId).concat(o).concat(t.transport).concat(o).concat(t.priority).concat(o).concat(t.connectionAddress).concat(o).concat(t.port).concat(o,"typ").concat(o).concat(t.type).concat(t.relAddr?"".concat(o,"raddr").concat(o).concat(t.relAddr):"").concat(t.relPort?"".concat(o,"rport").concat(o).concat(t.relPort):"").concat(Object.keys(t.extension).map((e=>"".concat(o).concat(e).concat(o).concat(t.extension[e]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(t){return t.map((t=>"a=remote-candidates:".concat(t.join(o)).concat(this.eol))).join("")}printEndOfCandidates(t){return void 0===t?"":"a=end-of-candidates"+this.eol}printRTPRelated(t){if(!t.payloads)return"";const e=t.payloads;let i="";i+=t.rtcpFeedbackWildcards.map((t=>this.printRTCPFeedback("*",t))).join("");for(const t of e)i+=this.printRtpMap(t.payloadType,t.rtpMap),i+=this.printFmtp(t.payloadType,t.fmtp),i+=t.rtcpFeedbacks.map((e=>this.printRTCPFeedback(t.payloadType,e))).join("");return i}printFmtp(t,e){if(!e)return"";const i=Object.keys(e.parameters);return 1===i.length&&null===e.parameters[i[0]]?"a=fmtp:".concat(t).concat(o).concat(i[0]).concat(this.eol):"a=fmtp:".concat(t).concat(o).concat(Object.keys(e.parameters).map((t=>"".concat(t,"=").concat(e.parameters[t]))).join(";")).concat(this.eol)}printRtpMap(t,e){return e?"a=rtpmap:".concat(t).concat(o).concat(e.encodingName,"/").concat(e.clockRate).concat(e.encodingParameters?"/".concat(e.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(t,e){let i="a=rtcp-fb:".concat(t).concat(o),n=e;return"trr-int"===n.type?i+="ttr-int".concat(o).concat(n.interval):(n=n,i+="".concat(n.type),n.parameter&&(i+="".concat(o).concat(n.parameter),n.additional&&(i+="".concat(o).concat(n.additional)))),i+this.eol}printPtime(t){return void 0===t?"":"a=ptime:".concat(t).concat(this.eol)}printMaxPtime(t){return void 0===t?"":"a=maxptime:".concat(t).concat(this.eol)}printDirection(t){return void 0===t?"":"a=".concat(t).concat(this.eol)}printSSRC(t){return t.map((t=>Object.keys(t.attributes).map((e=>"a=ssrc:".concat(t.ssrcId.toString(10)).concat(o).concat(e).concat(t.attributes[e]?":".concat(t.attributes[e]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(t){return void 0===t?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(t){return void 0===t?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(t){return void 0===t?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(t){if(void 0===t)return"";let e="a=rtcp:".concat(t.port);return t.netType&&(e+="".concat(o).concat(t.netType)),t.addressType&&(e+="".concat(o).concat(t.addressType)),t.address&&(e+="".concat(o).concat(t.address)),e+this.eol}printMSId(t){return t.map((t=>"a=msid:".concat(t.id).concat(t.appdata?"".concat(o).concat(t.appdata):"").concat(this.eol))).join("")}printImageattr(t){return t.map((t=>"a=imageattr:".concat(t).concat(this.eol))).join("")}printRid(t){return t.map((t=>{let e="a=rid:".concat(t.id).concat(o).concat(t.direction);return t.payloads&&(e+="".concat(o,"pt=").concat(t.payloads.join(","))),t.params.length>0&&(e+="".concat(o).concat(t.params.map((t=>"depend"===t.type?"depend=".concat(t.rids.join(",")):"".concat(t.type,"=").concat(t.val))).join(";"))),e+this.eol})).join("")}printSimulcast(t){return void 0===t?"":"a=simulcast:".concat(t).concat(this.eol)}printSCTPPort(t){return void 0===t?"":"a=sctp-port:".concat(t).concat(this.eol)}printMaxMessageSize(t){return void 0===t?"":"a=max-message-size:".concat(t).concat(this.eol)}printMid(t){return void 0===t?"":"a=mid:".concat(t).concat(this.eol)}printSSRCGroups(t){return t.map((t=>"a=ssrc-group:".concat(t.semantic).concat(t.ssrcIds.map((t=>"".concat(o).concat(t.toString(10)))).join("")).concat(this.eol))).join("")}}function k(t){return(new T).parse(t)}function L(t,e){return(new I).print(t,e)}}},e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={exports:{}};return t[n](s,s.exports,i),s.exports}return i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(8)})()}(UI);class nA{constructor(t){vp(this,"sessionDesc",void 0),vp(this,"localCapabilities",void 0),vp(this,"rtpCapabilities",void 0),vp(this,"candidates",void 0),vp(this,"iceParameters",void 0),vp(this,"dtlsParameters",void 0),vp(this,"setup",void 0),vp(this,"currentMidIndex",void 0),vp(this,"cname",void 0),t=hy(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,sdkCodec:a,cname:c}=t,l=UI.exports.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=e,this.dtlsParameters=i,this.setup=o,this.localCapabilities=r,this.cname=c;for(let t=0;t<l.mediaDescriptions.length;t++){const r=l.mediaDescriptions[t];r.attributes.iceUfrag=e.iceUfrag,r.attributes.icePwd=e.icePwd,r.attributes.fingerprints=i.fingerprints,r.attributes.candidates=n,r.attributes.setup=o,"video"===r.media.mediaType&&(r.media.fmts=s.videoCodecs.map((t=>t.payloadType.toString(10))),r.attributes.payloads=s.videoCodecs,r.attributes.extmaps=s.videoExtensions),"audio"===r.media.mediaType&&(r.media.fmts=s.audioCodecs.map((t=>t.payloadType.toString(10))),r.attributes.payloads=s.audioCodecs,r.attributes.extmaps=s.audioExtensions),l.mediaDescriptions[t]=this.mungMediaDesc(r)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return UI.exports.print(this.sessionDesc)}send(t,e,i){const{ssrcs:n,ssrcGroups:s}=$I(e,this.cname),o=this.sessionDesc.mediaDescriptions.find((e=>t===IE.VIDEO?"video"===e.media.mediaType:"audio"===e.media.mediaType)),r=n[0].attributes.label,a=n[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(n),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:r,mslabel:a}}batchSend(t){return t.map((t=>{let{kind:e,ssrcMsg:i}=t;return this.send(e,i,void 0)}))}stopSending(t){this.sessionDesc.mediaDescriptions.forEach((e=>{const i=[],n=[],s=[];e.attributes.ssrcs.forEach((e=>{t.includes(e.attributes.label||"")?s.push(e):i.push(e)})),e.attributes.ssrcGroups.forEach((t=>{s.map((t=>t.ssrcId)).includes(t.ssrcIds[0])||n.push(t)})),e.attributes.ssrcs=i,e.attributes.ssrcGroups=n}))}mute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}receive(t,e,i){t.forEach(((t,e)=>{const i=t._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(t){}updateCandidates(t){t===AE.TCP?this.candidates.forEach((t=>{-1===this.candidates.findIndex((e=>"tcp"===e.transport&&e.connectionAddress===t.connectionAddress&&e.port===t.port))&&this.candidates.push(iA(iA({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})):this.candidates=this.candidates.filter((t=>"tcp"!==t.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(t){t=hy(t),this.iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}mungRecvMediaDsec(t,e){const i=hy(t);return WI(i,e),KI(i,e),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===t));if(-1!==i){const t=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=t}}bumpMid(t){this.currentMidIndex+=t}updateTrackLabel(t,e,i){const n=this.sessionDesc.mediaDescriptions.find((e=>t===IE.VIDEO?"video"===e.attributes.mid:"audio"===e.attributes.mid));if(n){const t=n.attributes.ssrcs.find((t=>t.attributes.label===e));var s;t&&(t.attributes.label=i,null===(s=t.attributes.msid)||void 0===s||s.replace(e,i))}}mungMediaDesc(t){const e=hy(t);return zI(e),function(t){const e=t.attributes.extmaps.find((t=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t.extensionName));e&&t.attributes.extmaps.splice(t.attributes.extmaps.indexOf(e),1),t.attributes.payloads.forEach((t=>{const e=t.rtcpFeedbacks.findIndex((t=>"transport-cc"===t.type));-1!==e&&t.rtcpFeedbacks.splice(e,1)}))}(e),e}getSSRC(t){for(const e of this.sessionDesc.mediaDescriptions)for(const i of e.attributes.ssrcs)if(i.attributes.label===t)return[i]}}function sA(t){if(Array.isArray(t))return t.map((t=>t));if(!oA(t))return t;const e={};for(const i in t)oA(t[i])||Array.isArray(t[i])?e[i]=sA(t[i]):e[i]=t[i];return e}function oA(t){return!("object"!=typeof t||Array.isArray(t)||!t)}function rA(){const t=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return t&&t[0]?Number(t[0].split("/")[1]):null}function aA(t){return!!window.RTCStatsReport&&t.getStats()instanceof _h}class cA{constructor(t){vp(this,"input",[]),vp(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const lA={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},dA={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:lA,remoteCandidate:lA}},hA={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},uA={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,qpSumPerFrame:0},pA={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0},mA={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function vA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function gA(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?vA(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):vA(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class fA{constructor(t,e){vp(this,"onFirstVideoReceived",void 0),vp(this,"onFirstVideoDecoded",void 0),vp(this,"onFirstAudioReceived",void 0),vp(this,"onFirstVideoDecodedTimeout",void 0),vp(this,"onFirstAudioDecoded",void 0),vp(this,"onSelectedLocalCandidateChanged",void 0),vp(this,"onSelectedRemoteCandidateChanged",void 0),vp(this,"videoIsReady",!1),vp(this,"videoIsReady2",{}),vp(this,"pc",void 0),vp(this,"options",void 0),vp(this,"intervalTimer",void 0),vp(this,"stats",sA(dA)),vp(this,"isFirstVideoReceived",{}),vp(this,"isFirstVideoDecoded",{}),vp(this,"isFirstAudioReceived",{}),vp(this,"isFirstAudioDecoded",{}),vp(this,"isFirstVideoDecodedTimeout",{}),vp(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new _h((t=>{t({local:gA({},lA),remote:gA({},lA)})}))}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const e=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,o=0,r=0;for(const a of i)t[a].forEach(((t,i)=>{if(!this.lossRateWindowStats[e-1][a][i]||!this.lossRateWindowStats[0][a][i])return;const c=this.lossRateWindowStats[e-1][a][i].packets-this.lossRateWindowStats[0][a][i].packets,l=this.lossRateWindowStats[e-1][a][i].packetsLost-this.lossRateWindowStats[0][a][i].packetsLost;"videoSend"===a||"audioSend"===a?(n+=c,o+=l):(s+=c,r+=l),Number.isNaN(c)||Number.isNaN(c)?t.packetLostRate=0:t.packetLostRate=c<=0||l<=0?0:l/(c+l)}));t.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),t.recvPacketLossRate=s<=0||r<=0?0:r/(s+r)}}function EA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function _A(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?EA(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):EA(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class SA extends fA{constructor(){super(...arguments),vp(this,"_stats",dA),vp(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=sA(dA);const i=e.filter((t=>"ssrc"===t.type));this.processSSRCStats(i);const n=e.find((t=>"VideoBwe"===t.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach((t=>{const e=t.id.includes("send");switch("".concat(t.mediaType,"_").concat(e?"send":"recv")){case"video_send":{const e=sA(uA);e.codec=t.googCodecName,e.adaptionChangeReason="none",t.googCpuLimitedResolution&&(e.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(e.adaptionChangeReason="bandwidth"),e.avgEncodeMs=Number(t.googAvgEncodeMs),e.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},e.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},e.firsCount=Number(t.googFirReceived),e.nacksCount=Number(t.googNacksReceived),e.plisCount=Number(t.googPlisReceived),e.frameCount=Number(t.framesEncoded),e.bytes=Number(t.bytesSent),e.packets=Number(t.packetsSent),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(e),this._stats.rtt=e.rttMs;break}case"video_recv":{const e=sA(hA),i=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(e.codec=t.googCodecName,e.targetDelayMs=Number(t.googTargetDelayMs),e.renderDelayMs=Number(t.googRenderDelayMs),e.currentDelayMs=Number(t.googCurrentDelayMs),e.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),e.decodeMs=Number(t.googDecodeMs),e.maxDecodeMs=Number(t.googMaxDecodeMs),e.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},e.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},e.decodeFrameRate=Number(t.googFrameRateDecoded),e.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},e.jitterBufferMs=Number(t.googJitterBufferMs),e.firsCount=Number(t.googFirsSent),e.nacksCount=Number(t.googNacksSent),e.plisCount=Number(t.googPlisSent),e.framesDecodeCount=Number(t.framesDecoded),e.bytes=Number(t.bytesReceived),e.packets=Number(t.packetsReceived),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,e.decodedFrame.width,e.decodedFrame.height),this.isFirstVideoDecoded[e.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;e.framesDecodeFreezeTime=n.framesDecodeFreezeTime,e.framesDecodeInterval=n.framesDecodeInterval,e.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(i.lts=Date.now(),e.framesDecodeInterval=s,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<i.stats.framesDecodeCount&&(e.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:_A({},e),lts:Date.now()}),this._stats.videoRecv.push(e);break}case"audio_recv":{const e=sA(mA);e.codec=t.googCodecName,e.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,e.decodingCNG=Number(t.googDecodingCNG),e.decodingCTN=Number(t.googDecodingCTN),e.decodingCTSG=Number(t.googDecodingCTSG),e.decodingNormal=Number(t.googDecodingNormal),e.decodingPLC=Number(t.googDecodingPLC),e.decodingPLCCNG=Number(t.googDecodingPLCCNG),e.expandRate=Number(t.googExpandRate),e.accelerateRate=Number(t.googAccelerateRate),e.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),e.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),e.speechExpandRate=Number(t.googSpeechExpandRate),e.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),e.jitterBufferMs=Number(t.googJitterBufferMs),e.jitterMs=Number(t.googJitterReceived),e.bytes=Number(t.bytesReceived),e.packets=Number(t.packetsReceived),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),e.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.decodingNormal>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),this._stats.audioRecv.push(e);break}case"audio_send":{const e=sA(pA);e.codec=t.googCodecName,e.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,e.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),e.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),e.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),e.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),e.bytes=Number(t.bytesSent),e.packets=Number(t.packetsSent),e.packetsLost=Number(t.packetsLost),e.ssrc=Number(t.ssrc),e.rttMs=Number(t.googRtt||0),this._stats.rtt=e.rttMs,this._stats.audioSend.push(e);break}}}))}_getStats(){return new _h(((t,e)=>{this.pc.getStats(t,e)}))}statsResponsesToObjects(t){const e=[];return t.result().forEach((t=>{const i={id:t.id,timestamp:t.timestamp.valueOf().toString(),type:t.type};t.names().forEach((e=>{i[e]=t.stat(e)})),e.push(i)})),e}}function bA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function TA(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?bA(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):bA(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class yA extends fA{constructor(){super(...arguments),vp(this,"_stats",dA),vp(this,"report",void 0),vp(this,"lastDecodeVideoReceiverStats",new Map),vp(this,"lastVideoFramesRecv",new Map),vp(this,"lastVideoFramesSent",new Map),vp(this,"lastVideoFramesDecode",new Map),vp(this,"lastVideoJBDelay",new Map),vp(this,"lastAudioJBDelay",new Map),vp(this,"mediaBytesSent",new Map),vp(this,"mediaBytesRetransmit",new Map),vp(this,"mediaBytesTargetEncode",new Map),vp(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=sA(dA),this.report.forEach((t=>{switch(t.type){case Mu.OUTBOUND:"audio"===t.mediaType?this.processAudioOutboundStats(t):"video"===t.mediaType&&this.processVideoOutboundStats(t);break;case Mu.INBOUND:"audio"===t.mediaType?this.processAudioInboundStats(t):"video"===t.mediaType&&this.processVideoInboundStats(t);break;case Mu.TRANSPORT:{const e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case Mu.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),e={local:TA({},lA),remote:TA({},lA)};return t.forEach((i=>{let n;if(i.type===Mu.TRANSPORT&&(n=t.get(i.selectedCandidatePairId)),i.type===Mu.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(t,e)=>{t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol)};if(n.localCandidateId){const s=t.get(n.localCandidateId);s&&i(e.local,s)}if(n.remoteCandidateId){const s=t.get(n.remoteCandidateId);s&&i(e.remote,s)}}})),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach((e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)})),this._stats.audioSend.forEach((e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){const e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===Mu.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===Mu.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===Mu.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(TA({},e),TA({},this.stats.selectedCandidatePair.localCandidate)),t.type===Mu.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(TA({},e),TA({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find((e=>e.ssrc===t.ssrc));e||(e=sA(mA),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,this.processAudioTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),"number"==typeof t.concealedSamples&&(e.concealedSamples=t.concealedSamples)}processVideoInboundStats(t){let e=this._stats.videoRecv.find((e=>e.ssrc===t.ssrc));e||(e=sA(hA),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(e.ssrc),n=this.lastVideoFramesDecode.get(e.ssrc),s=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){const t=e.decodedFrame?e.decodedFrame.width:0,i=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,t,i),this.isFirstVideoDecoded[e.ssrc]=!0}if(i){const n=i.stats,o=s-i.lts;e.framesDecodeFreezeTime=n.framesDecodeFreezeTime,e.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&o>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(i.lts=Date.now(),e.framesDecodeInterval=o,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<n.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(i.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-i.qpSum)/(t.framesDecoded-i.stats.framesDecodeCount))}n&&s-n.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-n.count)/((s-n.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:e.decodeFrameRate})):n?e.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:0}),t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:TA({},e),lts:i?i.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find((e=>e.ssrc===t.ssrc));e||(e=sA(uA),this._stats.videoSend.push(e));const i=this.mediaBytesSent.get(t.ssrc);if(i)i.add(t.bytesSent);else{const e=new cA(10);e.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,e)}if(void 0!==t.retransmittedBytesSent){const e=this.mediaBytesRetransmit.get(t.ssrc);if(e)e.add(t.retransmittedBytesSent);else{const e=new cA(10);e.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,e)}}if(t.totalEncodedBytesTarget){const e=this.mediaBytesTargetEncode.get(t.ssrc);if(e)e.add(t.totalEncodedBytesTarget);else{const e=new cA(10);e.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,e)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,t.totalEncodeTime&&t.framesEncoded){const i=this.lastEncoderMs.get(t.ssrc);if(!i||i.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const n=t.framesEncoded-i.lastFrameCount,s=t.totalEncodeTime-i.lastEncoderTime;e.avgEncodeMs=1e3*s/n}}if(t.framesEncoded&&t.qpSum){const i=this.lastEncoderMs.get(t.ssrc);!i||i.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-i.lastQpSum)/(t.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const i=this.findRemoteStatsId(t.ssrc,Mu.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find((e=>e.ssrc===t.ssrc));if(e||(e=sA(pA),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const i=this.findRemoteStatsId(t.ssrc,Mu.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}findRemoteStatsId(t,e){var i;const n=Array.from(yb(i=this.report).call(i)).find((i=>i.type===e&&i.ssrc===t));return n?n.id:null}processVideoMediaSource(t,e){const i=this.report.get(t);i&&i.width&&i.height&&i.framesPerSecond&&(e.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(t,e){const i=this.report.get(t);i&&(e.inputLevel=i.audioLevel)}processVideoTrackSenderStats(t,e,i){var n,s,o;const r=e?this.report.get(e):void 0,a=null!==(n=null==r?void 0:r.framesSent)&&void 0!==n?n:t.framesSent;let c=null!==(s=null==r?void 0:r.frameWidth)&&void 0!==s?s:t.frameWidth,l=null!==(o=null==r?void 0:r.frameHeight)&&void 0!==o?o:t.frameHeight;if("number"!=typeof a)return;"number"==typeof c&&"number"==typeof l||(c=0,l=0);let d=0;const h=Date.now(),u=this.lastVideoFramesSent.get(i.ssrc);u&&h-u.lts>=800?(d=Math.round((a-u.count)/((h-u.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:a,lts:h,rate:d})):u?d=u.rate:this.lastVideoFramesSent.set(i.ssrc,{count:a,lts:h,rate:0}),i.sentFrame={width:c,height:l,frameRate:Math.max(0,d)}}processVideoTrackReceiverStats(t,e,i){var n,s,o,r,a;const c=e?this.report.get(e):void 0,l=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:t.framesReceived,d=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:t.frameWidth,h=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:t.frameHeight,u=null!==(r=null==c?void 0:c.jitterBufferDelay)&&void 0!==r?r:t.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:t.jitterBufferEmittedCount;if("number"==typeof l){const t=this.lastVideoFramesRecv.get(i.ssrc),e=Date.now();i.framesReceivedCount=l;let n=0;t&&e-t.lts>=800?(n=Math.round((l-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:e,rate:n})):t?n=t.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:e,rate:0}),i.receivedFrame={width:d||0,height:h||0,frameRate:n||0},i.decodedFrame={width:d||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:d||0,height:h||0,frameRate:i.decodeFrameRate||0}}if(u&&p){let t=this.lastVideoJBDelay.get(i.ssrc);this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p}),t||(t={jitterBufferDelay:0,jitterBufferEmittedCount:0});const e=1e3*(u-t.jitterBufferDelay)/(p-t.jitterBufferEmittedCount);i.jitterBufferMs=e,i.currentDelayMs=Math.round(e)}}processAudioTrackSenderStats(t,e,i){var n,s,o,r;const a=e?this.report.get(e):void 0,c=null!==(n=null!==(s=null==a?void 0:a.echoReturnLoss)&&void 0!==s?s:t.echoReturnLoss)&&void 0!==n?n:0,l=null!==(o=null!==(r=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==r?r:t.echoReturnLossEnhancement)&&void 0!==o?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=l}processAudioTrackReceiverStats(t,e,i){var n,s,o,r,a,c,l;const d=e?this.report.get(e):void 0,h=null!==(n=null==d?void 0:d.removedSamplesForAcceleration)&&void 0!==n?n:t.removedSamplesForAcceleration,u=null!==(s=null==d?void 0:d.totalSamplesReceived)&&void 0!==s?s:t.totalSamplesReceived,p=null!==(o=null==d?void 0:d.jitterBufferDelay)&&void 0!==o?o:t.jitterBufferDelay,m=null!==(r=null==d?void 0:d.jitterBufferEmittedCount)&&void 0!==r?r:t.jitterBufferEmittedCount,v=null!==(a=null==d?void 0:d.audioLevel)&&void 0!==a?a:null==t?void 0:t.audioLevel,g=null!==(c=null==d?void 0:d.totalSamplesDuration)&&void 0!==c?c:null==t?void 0:t.totalSamplesDuration,f=null!==(l=null==d?void 0:d.concealedSamples)&&void 0!==l?l:t.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&m){let t=this.lastAudioJBDelay.get(i.ssrc);this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:m}),t||(t={jitterBufferDelay:0,jitterBufferEmittedCount:0});const e=1e3*(p-t.jitterBufferDelay)/(m-t.jitterBufferEmittedCount);i.jitterBufferMs=Math.round(e)}i.outputLevel=v;let E=1920;g&&u&&(E=u/g/50,i.receivedFrames=Math.round(u/E)),f&&(i.droppedFrames=Math.round(f/E))}processRemoteInboundStats(t,e){const i=this.report.get(t);i&&(e.packetsLost=i.packetsLost,i.roundTripTime&&(e.rttMs=1e3*i.roundTripTime))}getCodecFromCodecStats(t){const e=this.report.get(t);if(!e)return"";const i=e.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let t=0,e=null,i=null;this.mediaBytesSent.forEach((e=>{t+=e.diffMean()})),this.mediaBytesRetransmit.forEach((t=>{e=null===e?t.diffMean():e+t.diffMean()})),this.mediaBytesTargetEncode.forEach((t=>{i=null===i?t.diffMean():i+t.diffMean()}));const n=null!==e?t-e:t;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},null!==e&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class wA extends fA{updateStats(){return _h.resolve()}}function CA(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=rA();return o?o<76?new SA(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new yA(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):aA(t)?new yA(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new wA(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}var RA;function IA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function AA(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?IA(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):IA(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let OA=(cS((RA=class t extends KE{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}constructor(e,i){super(e,i),vp(this,"store",void 0),vp(this,"peerConnection",void 0),vp(this,"remoteSDP",void 0),vp(this,"initialOffer",void 0),vp(this,"statsFilter",void 0),vp(this,"useRTX",!1),vp(this,"localCapabilities",void 0),vp(this,"localCandidateCount",0),vp(this,"allCandidatesReceived",!1),vp(this,"establishPromise",void 0),vp(this,"mutex",new US("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(t.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=CA(this.peerConnection,Gv("STATS_UPDATE_INTERVAL"),void 0,zu()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=FI(t.sdp),i=jI(t.sdp,!this.useRTX,Gv("FILTER_VIDEO_FEC"),Gv("FILTER_AUDIO_FEC"),["opus"]);return this.localCapabilities=i,this.initialOffer=t,AA(AA({},e),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:t.sdp})}catch(t){throw new _v(Ev.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new nA({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const r=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}send(t,e){var i=this;return LI((function*(){const n=yield PI(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=t.map((t=>i.peerConnection.addTrack(t._mediaStreamTrack))),o=yield PI(i.peerConnection.createOffer()),r=UI.exports.parse(o.sdp),a=t.map((t=>{const e=t._mediaStreamTrack,n=r.mediaDescriptions.find((t=>t.attributes.mid===e.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(t,e,i){const n=t.attributes.ssrcs.filter((t=>t.attributes.label===e)),s=t.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const t=s.find((t=>-1!==t.ssrcIds.indexOf(n[0].ssrcId)));return t?[{ssrcId:t.ssrcIds[0],rtx:i?t.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,e.id,i.useRTX)}));let c;try{c=yield a}catch(t){throw s.forEach((t=>{Wu()&&t.replaceTrack(null),i.peerConnection.removeTrack(t)})),t}const l=i.mungSendOfferSDP(o.sdp,t);i.remoteSDP.receive(t,e,c);const d=i.remoteSDP.toString();return yield PI(i.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield PI(i.applySendEncodings(s,t)),yield PI(i.peerConnection.setRemoteDescription({type:"answer",sdp:d})),t.map(((t,e)=>{const i=t._mediaStreamTrack.id;return{localSSRC:a[e],id:i}}))}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(t.toString()))}finally{n()}}))()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const e=this.peerConnection.getSenders().filter((e=>{var i;return-1!==t.indexOf((null===(i=e.track)||void 0===i?void 0:i.id)||"")}));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");e.map((t=>{Wu()&&t.replaceTrack(null),this.peerConnection.removeTrack(t)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(t.toString()))}}async receive(t,e,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(t,e,n),o=new _h(((e,n)=>{const o=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),r=n=>{const a=Vu();if(("Safari"===a.name&&11===Number(a.version)||Ku())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(t,i,n.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(o),void e(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",r),clearTimeout(o),void e(n.track)};this.peerConnection.addEventListener("track",r)})),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const a=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(a),{track:await o,id:i}}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter((e=>{var i;return-1!==t.indexOf((null===(i=e.track)||void 0===i?void 0:i.id)||"")}));if(e.length!==t.length)throw new Error("sender' length doesn't match mids' length.");e.map((t=>{if(Wu()&&t.track)t.track.enabled=!1;else{const e=t.getParameters();e.encodings.forEach((t=>t.active=!1)),t.setParameters(e)}}))}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter((e=>{var i;return-1!==t.indexOf((null===(i=e.track)||void 0===i?void 0:i.id)||"")}));if(e.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");e.map((async t=>{if(Wu()&&t.track)t.track.enabled=!0;else{const e=t.getParameters();e.encodings.forEach((t=>t.active=!0)),await t.setParameters(e)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(t){var e=this;return LI((function*(){const i=yield PI(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(YE().supportPCSetConfiguration){const i=e.peerConnection.getConfiguration(),n=t===AE.RELAY?"relay":"all";i.iceTransportPolicy!==n&&(Av.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,e.peerConnection.setConfiguration(i))}else if(t===AE.RELAY)return;t!==AE.RELAY&&e.remoteSDP.updateCandidates(t);const n=yield PI(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=FI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const r=e.remoteSDP.toString();yield PI(e.peerConnection.setLocalDescription(n)),yield PI(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){Av.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),t)}finally{i()}}))()}close(){var t;this.peerConnection.close(),null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const t=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(t.sdp,[e]);this.remoteSDP.updateRecvMedia(e._mediaStreamTrack.kind,e);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,t.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getSenders().filter((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));1===i.length&&await this.applySendEncodings(i,[e])}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getSenders().find((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));i&&await i.replaceTrack(t._mediaStreamTrack)}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Av.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Av.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Gv("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(Uf(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.servers)),Gv("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}async applySendEncodings(t,e){try{if(!YE().supportSetRtpSenderParameters)return;if(t.length!==e.length)return;for(let n=0;n<t.length;n++){var i;const s=t[n],o=e[n];if(!o)continue;const r={},a={};if(o instanceof wC)switch(o._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(Gv("DSCP_TYPE")&&op()){const t=Gv("DSCP_TYPE");["very-low","low","medium","high"].includes(t)&&(a.networkPriority=t)}const c=s.getParameters(),l=null===(i=c.encodings)||void 0===i?void 0:i[0];l&&Object.assign(l,a),Object.assign(c,r),await s.setParameters(c)}}catch(t){Av.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e){const i=UI.exports.parse(t);return e.forEach(((t,e)=>{const n=t._mediaStreamTrack,s=i.mediaDescriptions.find((t=>t.attributes.mid===n.kind));s&&WI(s,t)})),UI.exports.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;null===(e=this.onFirstAudioReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;null===(e=this.onFirstVideoReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;null===(e=this.onFirstAudioDecoded)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,t,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const e=this.remoteSDP.batchSend(t).map(((e,i)=>{let{id:n,mslabel:s}=e;const{kind:o}=t[i];return new _h(((t,e)=>{const i=setTimeout((()=>{e(new Error("Cannot receive track, id: ".concat(n)))}),1e4),r=e=>{const a=Vu();if("Safari"===a.name&&11===Number(a.version)&&e.track.id!==n&&e.streams[0].id===s){var c;const s=e.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,n,e.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(i),void t({track:s,id:n})}if(e.track.id===n)return this.peerConnection.removeEventListener("track",r),clearTimeout(i),void t({track:e.track,id:n})};this.peerConnection.addEventListener("track",r)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await _h.all(e)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return null==e?void 0:e[0].ssrcId}setConfiguration(e){if(YE().supportPCSetConfiguration){const i=t.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"connect"),RA.prototype),cS(RA.prototype,"stopSending",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"stopSending"),RA.prototype),cS(RA.prototype,"receive",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"receive"),RA.prototype),cS(RA.prototype,"stopReceiving",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"stopReceiving"),RA.prototype),cS(RA.prototype,"muteRemote",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"muteRemote"),RA.prototype),cS(RA.prototype,"unmuteRemote",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"unmuteRemote"),RA.prototype),cS(RA.prototype,"muteLocal",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"muteLocal"),RA.prototype),cS(RA.prototype,"unmuteLocal",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"unmuteLocal"),RA.prototype),cS(RA.prototype,"close",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"close"),RA.prototype),cS(RA.prototype,"updateEncoderConfig",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"updateEncoderConfig"),RA.prototype),cS(RA.prototype,"updateSendParameters",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"updateSendParameters"),RA.prototype),cS(RA.prototype,"replaceTrack",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"replaceTrack"),RA.prototype),cS(RA.prototype,"getRemoteSSRC",[NA],Object.getOwnPropertyDescriptor(RA.prototype,"getRemoteSSRC"),RA.prototype),RA);function NA(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function kA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function LA(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?kA(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):kA(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}const PA="9",DA=4e4;class MA{get localCapabilities(){return hy(this._localCapabilities)}get rtpCapabilities(){return hy(this._rtpCapabilities)}get candidates(){return hy(this._candidates)}get iceParameters(){return hy(this._iceParameters)}get dtlsParameters(){return hy(this._dtlsParameters)}constructor(t){vp(this,"sessionDesc",void 0),vp(this,"_localCapabilities",void 0),vp(this,"_rtpCapabilities",void 0),vp(this,"_candidates",void 0),vp(this,"_iceParameters",void 0),vp(this,"_dtlsParameters",void 0),vp(this,"setup",void 0),vp(this,"currentMidIndex",void 0),vp(this,"cname",void 0),vp(this,"firefoxSsrcMidMap",new Map),t=hy(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=t,c=UI.exports.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=s,this._candidates=n,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const l=this.rtpCapabilities.send;for(const t of c.mediaDescriptions){if(t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd,t.attributes.fingerprints=i.fingerprints,t.attributes.candidates=n,t.attributes.setup=o,"video"===t.media.mediaType&&(t.media.fmts=l.videoCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=l.videoCodecs,t.attributes.extmaps=l.videoExtensions,Gv("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=$I([{ssrcId:DA,rtx:Gv("USE_SUB_RTX")?40001:void 0}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}if("audio"===t.media.mediaType&&(t.media.fmts=l.audioCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=l.audioCodecs,t.attributes.extmaps=l.audioExtensions,tA(t),Gv("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=$I([{ssrcId:2e4}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const t=Gv("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const e=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<t;o++){const t=2*o+2e4,r=2*o+DA,{ssrcs:a,ssrcGroups:c}=$I([{ssrcId:t}],this.cname),{ssrcs:l,ssrcGroups:d}=$I([{ssrcId:r,rtx:Gv("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:PA,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:d,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:PA,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return UI.exports.print(this.sessionDesc)}send(t,e,i,n){const{ssrcs:s,ssrcGroups:o}=$I(e,this.cname,Gv("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(zu()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const t=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const e=this.findAvailableMediaIndex(t,s);let i;return-1===e||1===e&&(Wu()||Xu())||0===e&&Gv("USE_SUB_RTX")||Qu()?(i=this.createOrRecycleSendMedia(t,s,o,"sendonly",n),this.updateBundleMids()):(i=hy(this.sessionDesc.mediaDescriptions[e]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(i,n)),zu()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(t){const e=t.map((t=>{let{kind:e,ssrcMsg:i,mslabel:n}=t;return this.send(e,i,n)})),i=[];let n=!1;return e.forEach((t=>{let{mid:e,needExchangeSDP:s}=t;s&&(n=!0),i.push(e)})),{mids:i,needExchangeSDP:n}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>e.attributes.mid&&-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach((t=>{"0"===t.attributes.mid||zu()||Qu()?t.attributes.ssrcs=[]:(t.attributes.ssrcs=[],t.attributes.direction="inactive",t.media.port="0")})),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>t.includes(e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="inactive"}))}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>t.includes(e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="recvonly"}))}receive(t,e,i,n){t.forEach(((t,s)=>{this.createOrRecycleRecvMedia(t,[],"recvonly",e,i,n[s])})),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach((t=>{t.media.port="0",t.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(t){t===AE.TCP?this._candidates.forEach((t=>{-1===this._candidates.findIndex((e=>"tcp"===e.transport&&e.connectionAddress===t.connectionAddress&&e.port===t.port))&&this._candidates.push(LA(LA({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})):this._candidates=this._candidates.filter((t=>"tcp"!==t.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(t){t=hy(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===t&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(zu()){if(n){const t=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(t||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!t||t!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(t,e,i,n,s,o){const r=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=this.localCapabilities.send;let l=[];if(r===IE.VIDEO){var d,h;if(Gv("H264_PROFILE_LEVEL_ID")&&"h264"===n&&(l=a.videoCodecs.filter((t=>{var e,i;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes(n)&&(null==t||null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])===Gv("H264_PROFILE_LEVEL_ID")}))),!l||0===(null===(d=l)||void 0===d?void 0:d.length)){const t=c.videoCodecs.filter((t=>{var e;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes(n)}));0!==t.length&&(l=a.videoCodecs.filter((e=>t.some((t=>t.payloadType===e.payloadType)))))}if(Gv("USE_PUB_RTX")){const t=l.map((t=>t.payloadType.toString())),e=a.videoCodecs.filter((e=>{var i,n;return"rtx"===(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName)&&t.includes((null===(n=e.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));l=[...l,...e]}0===l.length&&(Av.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(h=a.videoCodecs[0].rtpMap)||void 0===h?void 0:h.encodingName)),l=a.videoCodecs)}else l=a.audioCodecs.filter((t=>{var e;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes(s)})),0===l.length&&(Av.warning("codec ".concat(s," not included in rtpCapabilities, fallback to opus")),l=a.audioCodecs.filter((t=>{var e;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes("opus")})));const u=r===IE.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const p="".concat(this.currentMidIndex);let m={media:{mediaType:r,port:PA,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(p)}};m=this.mungRecvMediaDsec(m,t,o);const v=this.findFirstClosedMedia(r);if(v){const t=this.sessionDesc.mediaDescriptions.indexOf(v);this.sessionDesc.mediaDescriptions[t]=m}else this.sessionDesc.mediaDescriptions.push(m);return m}createOrRecycleSendMedia(t,e,i,n,s){const o=this.rtpCapabilities.send,r=t===IE.VIDEO?o.videoCodecs:o.audioCodecs,a=t===IE.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let l={media:{mediaType:t,port:PA,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};l=this.mungSendMediaDesc(l,s);const d=this.findFirstClosedMedia(t);if(d){const t=this.sessionDesc.mediaDescriptions.indexOf(d);this.sessionDesc.mediaDescriptions[t]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((t=>"0"!==t.media.port)).map((t=>t.attributes.mid))}mungRecvMediaDsec(t,e,i){const n=hy(t);return zI(n),WI(n,e),KI(n,e),qI(n),YI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(t,e){const i=hy(t);return YI(i,e,this.localCapabilities.recv),tA(i),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===t));if(-1!==i){const t=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=t}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find((e=>zu()?"0"===e.media.port&&e.media.mediaType===t:"0"===e.media.port))}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find((e=>{var i,n;return(null===(i=e.attributes)||void 0===i||null===(n=i.ssrcs[0])||void 0===n?void 0:n.ssrcId)===t[0].ssrcId}))}getSSRC(t){var e;return null===(e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t)))||void 0===e?void 0:e.attributes.ssrcs}}var xA;function UA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function VA(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?UA(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UA(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let BA=(cS((xA=class t extends KE{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,e,i;return null!==(t=null===(e=this.peerConnection.getReceivers()[0])||void 0===e||null===(i=e.transport)||void 0===i?void 0:i.state)&&void 0!==t?t:null}constructor(e,i){super(e,i),vp(this,"store",void 0),vp(this,"peerConnection",void 0),vp(this,"remoteSDP",void 0),vp(this,"initialOffer",void 0),vp(this,"transportEventReceiver",void 0),vp(this,"statsFilter",void 0),vp(this,"localCapabilities",void 0),vp(this,"localCandidateCount",0),vp(this,"allCandidatesReceived",!1),vp(this,"selectedCandidatePairTimer",void 0),vp(this,"establishPromise",void 0),vp(this,"mutex",new US("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(t.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=CA(this.peerConnection,Gv("STATS_UPDATE_INTERVAL"),void 0,zu()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=FI(t.sdp),i=await XI(!Gv("USE_PUB_RTX")&&!Gv("USE_SUB_RTX"),Gv("FILTER_VIDEO_FEC"),Gv("FILTER_AUDIO_FEC"));return this.localCapabilities=ZI(i),this.initialOffer=t,VA(VA({},e),{},{rtpCapabilities:i,offerSDP:t.sdp})}catch(t){throw new _v(Ev.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new MA({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:this.localCapabilities,cname:o});const r=this.remoteSDP.toString(),a=UI.exports.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((t=>"audio"===t.media.mediaType));c&&tA(c);const l=UI.exports.print(a),d=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),null==d||d(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r});const h=this.peerConnection.getTransceivers()[0];if(null!=h&&h.receiver&&this.tryBindTransportEvents(h.receiver),Gv("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const e=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(e)}}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(t.toString()))}}send(t,e,i){var n=this;return LI((function*(){const s=yield PI(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];t.forEach((t=>{const e=n.peerConnection.addTransceiver(t._mediaStreamTrack,{direction:"sendonly"});o.push(e),t._updateRtpTransceiver(e)})),zu()&&!0===Gv("SIMULCAST")&&(yield PI(n.applySimulcastForFirefox(o,t)));const r=yield PI(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(t.length),c=n.mungSendOfferSDP(r.sdp,t,a),l=UI.exports.parse(c),d=a.map((t=>{const e=l.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("Cannot extract ssrc from mediaDescription.");return HI(e,Gv("USE_PUB_RTX"))}));let h;try{h=yield d}catch(s){h=[],n.remoteSDP.receive(t,e,i,h);const o=n.remoteSDP.toString();throw yield PI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield PI(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield PI(n.stopSending(a,!0)),s}n.remoteSDP.receive(t,e,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield PI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield PI(n.applySimulcastEncodings(o,t)),yield PI(n.applySendEncodings(o,t)),null==p||p(u),yield PI(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((t,e)=>{const i=a[e];return{localSSRC:d[e],id:i,transceiver:t}}))}catch(t){throw t instanceof _v?t:new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(t.toString()))}finally{s()}}))()}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const e=this.peerConnection.getTransceivers().filter((e=>-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");e.map((t=>{var e;t.direction="inactive",null===(e=t.stop)||void 0===e||e.call(t)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(t);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(t.toString()))}finally{i&&i()}}async receive(t,e,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,n);if(o){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(n.sdp,s,t);null==i||i(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),Av.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else Av.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((t=>t.mid===s));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:s,transceiver:r}}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const t=this.remoteSDP.toString(),e=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==e||e(i.sdp||""),await this.peerConnection.setLocalDescription(i),Av.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else Av.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return e.map((t=>{const e=this.peerConnection.getTransceivers().find((e=>e.mid===t));if(!e)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:e.receiver.track,id:t,transceiver:e}}))}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((t=>{t.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((async(t,e)=>{t.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(t){var e=this;return LI((function*(){const i=yield PI(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(YE().supportPCSetConfiguration){const i=e.peerConnection.getConfiguration(),n=t===AE.RELAY?"relay":"all";i.iceTransportPolicy!==n&&(Av.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,e.peerConnection.setConfiguration(i))}else if(t===AE.RELAY)return;t!==AE.RELAY&&e.remoteSDP.updateCandidates(t);const n=yield PI(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=FI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const r=e.remoteSDP.toString(),a=e.logSDPExchange(n.sdp||"","offer","local","restartICE");e.store.descriptionStart(),yield PI(e.peerConnection.setLocalDescription(n)),null==a||a(r),yield PI(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){Av.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),t)}finally{i()}}))()}close(){var t;this.peerConnection.close(),null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,t.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter((e=>e.mid===t));1===i.length&&(this.isVP8Simulcast(e)?zu()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find((t=>t.mid===e));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const e=t[0].transport.iceTransport,{local:i,remote:n}=e.getSelectedCandidatePair();return{local:VA(VA({},lA),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:VA(VA({},lA),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Av.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Av.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Gv("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(Uf(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.servers)),Gv("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Gv("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(i.iceTransportPolicy="relay")})))),Gv("ENABLE_ENCODED_TRANSFORM")&&YE().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(BT(t.turnServerURL),":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&!Gv("FORCE_TURN_TCP")&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}tryBindTransportEvents(t){const e=t.transport;if(e){this.transportEventReceiver=t,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=t=>{var e;null===(e=this.onDTLSTransportError)||void 0===e||e.call(this,"error"in t?t.error:t)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:t,remote:e}=i.getSelectedCandidatePair();Av.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol}),", remote ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol,address:e.address,port:e.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async applySendEncodings(t,e){try{if(!YE().supportSetRtpSenderParameters)return;if(t.length!==e.length)return;for(let c=0;c<t.length;c++){const l=t[c],d=e[c];if(d&&d instanceof wC){var i,n;if(this.isVP8Simulcast(d))continue;const t={},e={};switch(d._optimizationMode){case"motion":t.degradationPreference="maintain-framerate";break;case"detail":t.degradationPreference="maintain-resolution";break;default:t.degradationPreference="balanced"}var s,o,r,a;if(null!==(i=d._encoderConfig)&&void 0!==i&&i.bitrateMax&&(e.maxBitrate=1e3*(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)),d._hints.includes(uE.LOW_STREAM)&&(null!==(o=d._encoderConfig)&&void 0!==o&&o.frameRate&&(e.maxFramerate=FT(d._encoderConfig.frameRate)),null!==(r=d._encoderConfig)&&void 0!==r&&r.scaleResolutionDownBy&&(null===(a=d._encoderConfig)||void 0===a?void 0:a.scaleResolutionDownBy)>1&&(e.scaleResolutionDownBy=d._encoderConfig.scaleResolutionDownBy)),Gv("DSCP_TYPE")&&op()){const t=Gv("DSCP_TYPE");["very-low","low","medium","high"].includes(t)&&(e.networkPriority=t)}const c=l.sender.getParameters(),h=null===(n=c.encodings)||void 0===n?void 0:n[0];zu()&&!h&&(t.encodings=[e]),h&&Object.assign(h,e),Object.assign(c,t),await l.sender.setParameters(c)}}}catch(t){Av.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e,i){const n=UI.exports.parse(t);return e.forEach(((t,e)=>{const s=i[e],o=n.mediaDescriptions.find((t=>t.attributes.mid===s));o&&(WI(o,t),JI(o,t,this.store.codec))})),UI.exports.print(n)}mungReceiveAnswerSDP(t,e,i){const n=UI.exports.parse(t),s=n.mediaDescriptions.find((t=>t.attributes.mid===e));return s&&i===IE.AUDIO&&"audio"===s.media.mediaType&&tA(s),UI.exports.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;null===(e=this.onFirstAudioReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;null===(e=this.onFirstVideoReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;null===(e=this.onFirstAudioDecoded)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;null===(e=this.onFirstVideoDecodedTimeout)||void 0===e||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let r=0;r<t.length;r++){var i,n,s,o;const a=t[r],c=e[r];if(c instanceof wC&&!c._hints.includes(uE.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabiltyMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=c._scalabiltyMode)||void 0===o?void 0:o.numSpatialLayers)>1&&"vp8"===this.store.codec){const t={},e={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};t.encodings=[{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:e.high}];const i=a.sender.getParameters();await a.sender.setParameters(Object.assign(i,t))}}}async applySimulcastEncodings(t,e){if(!zu()&&t.length===e.length)for(let i=0;i<t.length;i++){const n=e[i];if(n instanceof wC&&this.isVP8Simulcast(n)){const e=t[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=e.sender.getParameters();await e.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(t){var e,i,n,s;return!!(t instanceof wC&&Gv("SIMULCAST")&&"vp8"===this.store.codec&&!t._hints.includes(uE.LOW_STREAM)&&null!==(e=t._encoderConfig)&&void 0!==e&&e.bitrateMax&&(null===(i=t._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=t._scalabiltyMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=t._scalabiltyMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(t,e,i,n){if(Gv("SDP_LOGGING"))return Av.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(e," SDP during P2PConnection.").concat(n,"\n"),t),"offer"===e?t=>{this.logSDPExchange(t,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return null==e?void 0:e[0].ssrcId}setConfiguration(e){if(YE().supportPCSetConfiguration){const i=t.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"connect"),xA.prototype),cS(xA.prototype,"receive",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"receive"),xA.prototype),cS(xA.prototype,"batchReceive",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"batchReceive"),xA.prototype),cS(xA.prototype,"stopReceiving",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"stopReceiving"),xA.prototype),cS(xA.prototype,"muteRemote",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"muteRemote"),xA.prototype),cS(xA.prototype,"unmuteRemote",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"unmuteRemote"),xA.prototype),cS(xA.prototype,"muteLocal",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"muteLocal"),xA.prototype),cS(xA.prototype,"unmuteLocal",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"unmuteLocal"),xA.prototype),cS(xA.prototype,"close",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"close"),xA.prototype),cS(xA.prototype,"updateEncoderConfig",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"updateEncoderConfig"),xA.prototype),cS(xA.prototype,"updateSendParameters",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"updateSendParameters"),xA.prototype),cS(xA.prototype,"replaceTrack",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"replaceTrack"),xA.prototype),cS(xA.prototype,"getRemoteSSRC",[jA],Object.getOwnPropertyDescriptor(xA.prototype,"getRemoteSSRC"),xA.prototype),xA);function jA(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function FA(t,e){let i=document.createElement("video"),n=document.createElement("canvas");i.setAttribute("style","display:none"),n.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),n.width=FT(e.width),n.height=FT(e.height);const s=FT(e.framerate||15);document.body.append(i),document.body.append(n);let o=t._mediaStreamTrack;i.srcObject=new MediaStream([o]),i.play();const r=n.getContext("2d");if(!r)throw new _v(Ev.UNEXPECTED_ERROR,"can not get canvas context");const a=YE(),c=n.captureStream(a.supportRequestFrame?0:s).getVideoTracks()[0],l=YS((()=>(()=>{if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const t=i.videoWidth,e=i.videoHeight/t,s=n.width*e;Math.abs(s-n.height)>=2&&(Av.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(s)),n.height=s)}r.drawImage(i,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,i.srcObject=new MediaStream([o]))})()),s),d=c.stop;return c.stop=()=>{d.call(c),l(),i&&(i.remove(),i=null),n&&(n.width=0,n.remove(),n=null),Av.debug("clean low stream renderer")},c}var HA,GA,$A,WA,zA,KA,qA,YA,JA,XA,QA,ZA;function tO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function eO(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?tO(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):tO(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class iO extends DS{getUserId(){return this._userId}constructor(t,e,i,n){super(t,"track-".concat(t.kind,"-").concat(e,"-").concat(n.clientId,"_").concat(ZT(5,""))),vp(this,"_userId",void 0),vp(this,"_uintId",void 0),vp(this,"_isDestroyed",!1),vp(this,"store",void 0),vp(this,"processor",void 0),vp(this,"processorContext",void 0),this._userId=e,this._uintId=i,this.store=n}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,Av.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let nO=(HA=LS({argsMap:(t,e,i)=>[t.getTrackId(),"string"==typeof e?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),GA=LS({argsMap:t=>[t.getTrackId()]}),$A=LS({argsMap:(t,e)=>[t.getTrackId(),e.name]}),WA=LS({argsMap:t=>[t.getTrackId()]}),cS((zA=class extends iO{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==af.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,i,n){super(t,e,i,n),vp(this,"_videoVisibleTimer",null),vp(this,"_previousVideoVisibleStatus",void 0),vp(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),vp(this,"trackMediaType","video"),vp(this,"_videoWidth",void 0),vp(this,"_videoHeight",void 0),vp(this,"_player",void 0),vp(this,"processorDestination",void 0),vp(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new Ib(this.getTrackId(),"remote"),this.processorDestination=new Rb(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return py((()=>{Av.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),ry(this,hE.GET_STATS)||eO({},$f)}play(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t){const e=document.getElementById(t);e?t=e:(Av.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}Av.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=eO(eO({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new Pw(i):this._player=new Mw(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(EE.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const t=this.getVideoElementVisibleStatus();this.safeEmit(EE.VIDEO_ELEMENT_VISIBLE_STATUS,t)}catch(t){}}),Gv("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Av.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){iy(this._originMediaStreamTrack).then((t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e})).catch(ey)}_updatePlayerSource(){Av.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const i=null==this||null===(t=this._player)||void 0===t?void 0:t.getContainerElement(),n={track:this,element:null==this||null===(e=this._player)||void 0===e?void 0:e.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:s,slot:o}=n;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const t=bC.checkOneElementVisible(s),e=Object.assign({},t);if(e.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=e.visible;const t=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});e.visible?t.onSuccess("Video is visible"):t.onSuccess("Invisible because of ".concat(e.reason))}return e}return}catch(t){throw new _v(Ev.GET_VIDEO_ELEMENT_VISIBLE_ERROR,t.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new _v(Ev.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ME.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ME.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}).prototype,"play",[HA],Object.getOwnPropertyDescriptor(zA.prototype,"play"),zA.prototype),cS(zA.prototype,"stop",[GA],Object.getOwnPropertyDescriptor(zA.prototype,"stop"),zA.prototype),cS(zA.prototype,"pipe",[$A],Object.getOwnPropertyDescriptor(zA.prototype,"pipe"),zA.prototype),cS(zA.prototype,"unpipe",[WA],Object.getOwnPropertyDescriptor(zA.prototype,"unpipe"),zA.prototype),zA),sO=(KA=LS({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),qA=LS({argsMap:(t,e)=>[t.getTrackId(),e]}),YA=LS({argsMap:t=>[t.getTrackId()]}),JA=LS({argsMap:t=>[t.getTrackId()]}),XA=LS({argsMap:(t,e)=>[t.getTrackId(),e.name]}),QA=LS({argsMap:t=>[t.getTrackId()]}),cS((ZA=class extends iO{get isPlaying(){return this._useAudioElement?mb.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,i,n){super(t,e,i,n),vp(this,"trackMediaType","audio"),vp(this,"_source",void 0),vp(this,"_useAudioElement",!0),vp(this,"_volume",100),vp(this,"processorContext",void 0),vp(this,"processorDestination",void 0),vp(this,"_played",!1),vp(this,"_bypassWebAudio",!1),Gv("DISABLE_WEBAUDIO")?(this._source=new Nb,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new QS(t,!0),Gv("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Df.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(EE.FIRST_FRAME_DECODED)})),this.processorContext=new Ob(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Ab(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Df.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Df.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Df.ON_AUDIO_BUFFER),this._source.on(Df.ON_AUDIO_BUFFER,(e=>t(e)))}setVolume(t){this._volume=t,this._useAudioElement?mb.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement)throw new _v(Ev.NOT_SUPPORTED,"your browser does not support setting the audio output device");await mb.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return py((()=>{Av.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),ry(this,hE.GET_STATS)||eO({},Hf)}play(){Av.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(Av.debug("[".concat(this.getTrackId(),"] use audio element to play")),mb.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){Av.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?mb.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Av.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&mb.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new _v(Ev.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new _v(Ev.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new _v(Ev.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;null===(t=this._source.processSourceNode)||void 0===t||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ME.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(ME.ON_NODE,(t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ME.ON_TRACK),this.processorDestination.removeAllListeners(ME.ON_NODE)}}).prototype,"setVolume",[KA],Object.getOwnPropertyDescriptor(ZA.prototype,"setVolume"),ZA.prototype),cS(ZA.prototype,"setPlaybackDevice",[qA],Object.getOwnPropertyDescriptor(ZA.prototype,"setPlaybackDevice"),ZA.prototype),cS(ZA.prototype,"play",[YA],Object.getOwnPropertyDescriptor(ZA.prototype,"play"),ZA.prototype),cS(ZA.prototype,"stop",[JA],Object.getOwnPropertyDescriptor(ZA.prototype,"stop"),ZA.prototype),cS(ZA.prototype,"pipe",[XA],Object.getOwnPropertyDescriptor(ZA.prototype,"pipe"),ZA.prototype),cS(ZA.prototype,"unpipe",[QA],Object.getOwnPropertyDescriptor(ZA.prototype,"unpipe"),ZA.prototype),ZA);function oO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function rO(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?oO(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):oO(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}class aO extends gv{constructor(){super(),vp(this,"uplinkStatsUploadInterval",void 0),vp(this,"uplinkRelatedStatsUploadInterval",void 0),vp(this,"uplinkDenoiserStatsUploadInterval",void 0),vp(this,"transportStatsUploadInterval",void 0),vp(this,"uplinkExtensionStatsUploadInterval",void 0),vp(this,"downlinkExtensionStatsUploadInterval",void 0),vp(this,"extensionUsageStatsUploadInterval",void 0),vp(this,"downlinkStatsUploadInterval",void 0),vp(this,"downlinkRelatedStatsUploadInterval",void 0),vp(this,"lastStats",void 0),vp(this,"uploadUnplinkStarted",!1),vp(this,"uploadDownlinkStarted",!1),vp(this,"uploadTransportStarted",!1),vp(this,"uploadExtensionUsageStarted",!1),vp(this,"requestStats",void 0),vp(this,"requestLocalMedia",void 0),vp(this,"requestRemoteMedia",void 0),vp(this,"requestAllTracks",void 0),vp(this,"requestVideoIsReady",void 0),vp(this,"requestUpload",void 0)}startUploadTransportStats(){this.uploadTransportStarted||(this.uploadTransportStarted=!0,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestStats)||void 0===t?void 0:t.call(this);e&&this.uploadTransportStats(e)}),1e3))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval);const t=new Map;this.extensionUsageStatsUploadInterval=window.setInterval((async()=>{var e,i,n;const s=Date.now(),o={connectionInterval:Gv("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:s};let r=[];const a=(null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this))||[];for(const t of a)!t.muted&&t.enabled&&(r=r.concat(await t.getProcessorUsage()));const c=(null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[];for(const[t,e]of c)e.has(IE.VIDEO)&&t.videoTrack&&(r=r.concat(await t.videoTrack.getProcessorUsage())),e.has(IE.AUDIO)&&t.audioTrack&&(r=r.concat(await t.audioTrack.getProcessorUsage()));if(0===r.length)return;o.details=function(t,e){const i={};for(const{id:r,value:a,level:c,direction:l}of t){var n;const t=null!==(n=e.get(r))&&void 0!==n?n:0,d=2===a?t+Gv("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:t;var s,o;e.set(r,d),i[r]?(2===a&&(i[r].value=a),c>i[r].level&&(i[r].level=c),"remote"===l&&(i[r].remoteUidCount+=1),i[r].totalTs=null!==(s=e.get(r))&&void 0!==s?s:0):i[r]={value:a,level:c,remoteUidCount:"local"===l?0:1,totalTs:null!==(o=e.get(r))&&void 0!==o?o:0}}return Object.keys(i).map((t=>{const{level:e,value:n,totalTs:s}=i[t];return{id:t,level:e,value:n,totalTs:s}}))}(r,t);const l=Date.now(),d=l>s?l:s+1;null===(n=this.requestUpload)||void 0===n||n.call(this,kf.EXTENSION_USAGE_STATS,{usageStats:o,sendTs:d})}),Gv("EXTENSION_USAGE_UPLOAD_INTERVAL"))}startUploadUplinkStats(){this.uploadUnplinkStarted||(this.uploadUnplinkStarted=!0,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestStats)||void 0===t?void 0:t.call(this);e&&(this.uploadUplinkStats(e),this.lastStats=e)}),3e3),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkRelatedStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestStats)||void 0===t?void 0:t.call(this);e&&this.uploadRelatedUplinkStats(e,this.lastStats),this.lastStats=e}),1e3),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestAllTracks)||void 0===t?void 0:t.call(this);e&&this.uploadDenoiserStats(e)}),2e3),this.uplinkExtensionStatsUploadInterval&&window.clearInterval(this.uplinkExtensionStatsUploadInterval),this.uplinkExtensionStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestAllTracks)||void 0===t?void 0:t.call(this);e&&this.uploadExtensionStats(e)}),2e3))}uploadTransportStats(t){dy((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,kf.TRANSPORT_STATS,function(t){const e={connectionType:100,googRtt:t.rtt};if("relay"===t.selectedCandidatePair.localCandidate.candidateType){const i=t.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(e.connectionType=101),"tcp"===i&&(e.connectionType=103),"tls"===i&&(e.connectionType=104)}return e}(t))}))}uploadUplinkStats(t){var e;((null===(e=this.requestLocalMedia)||void 0===e?void 0:e.call(this))||[]).forEach((e=>{let[i,{track:n,ssrcs:s}]=e;switch(i){case NE.LocalVideoLowTrack:case NE.LocalVideoTrack:{const e=function(t,e,i){var n;const s=e.videoSend.find((e=>e.ssrc===t));if(!s)return null;const o={id:ZT(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:s.ssrc.toString()};switch(o.A_vstd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",s.sentFrame&&(o.A_fhs=s.sentFrame.height.toString(),o.A_frs=s.sentFrame.frameRate.toString(),o.A_fws=s.sentFrame.width.toString()),s.adaptionChangeReason){case"none":o.A_ac="0";break;case"cpu":o.A_ac="1";break;case"bandwidth":o.A_ac="2";break;case"other":o.A_ac="3"}return o.A_lvps=cf[i._player?i._player.videoElementStatus:"uninit"].toString(),o.A_nr=null===(n=s.nacksCount)||void 0===n?void 0:n.toString(),s.avgEncodeMs&&(o.A_aem=s.avgEncodeMs.toFixed(0).toString()),o}(s[0].ssrcId,t,n),o=i===NE.LocalVideoTrack?function(t,e,i){var n,s,o,r,a,c,l,d;const h=e.videoSend.find((e=>e.ssrc===t));if(!h)return null;const u={id:ZT(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:h.ssrc.toString()},p=null!==(n=null!==(s=null===(o=h.inputFrame)||void 0===o?void 0:o.height)&&void 0!==s?s:null==i?void 0:i._videoHeight)&&void 0!==n?n:0,m=null!==(r=null!==(a=null===(c=h.inputFrame)||void 0===c?void 0:c.width)&&void 0!==a?a:null==i?void 0:i._videoWidth)&&void 0!==r?r:0,v=null!==(l=null===(d=h.inputFrame)||void 0===d?void 0:d.frameRate)&&void 0!==l?l:0;return p&&(u.A_fhi=p+""),m&&(u.A_fwi=m+""),v&&(u.A_fri=v+""),u}(s[0].ssrcId,t,n):null;e&&dy((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,kf.PUBLISH_STATS,{stream_type:i===NE.LocalVideoLowTrack?"low":"high",stats:rO(rO({},e),o)})}));const r=function(t){const e={id:"bweforvideo",timestamp:new Date(t.timestamp).toISOString(),type:"VideoBwe"};return t.bitrate.retransmit&&(e.A_rb=t.bitrate.retransmit.toString()),t.bitrate.targetEncoded&&(e.A_teb=t.bitrate.targetEncoded.toString()),e.A_aeb=t.bitrate.actualEncoded.toString(),e.A_tb=t.bitrate.transmit.toString(),void 0!==t.sendBandwidth&&(e.A_asb=t.sendBandwidth.toString()),e}(t);r&&setTimeout((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,kf.PUBLISH_STATS,{stream_type:i===NE.LocalVideoLowTrack?"low":"high",stats:r})}),1e3);break}case NE.LocalAudioTrack:{const e=function(t,e,i){const n=e.audioSend.find((e=>e.ssrc===t));if(!n)return null;const s={id:ZT(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:n.ssrc.toString()};return s.A_astd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",n.inputLevel?s.A_ail=Math.round(100*n.inputLevel).toString():s.A_ail=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),s.A_apil=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),n.aecReturnLoss&&(s.A_ecrl=Math.round(n.aecReturnLoss).toString()),n.aecReturnLossEnhancement&&(s.A_ecrle=Math.round(n.aecReturnLossEnhancement).toString()),s}(s[0].ssrcId,t,n);e&&dy((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,kf.PUBLISH_STATS,{stream_type:"high",stats:e})}));break}}}))}uploadRelatedUplinkStats(t,e){var i;((null===(i=this.requestLocalMedia)||void 0===i?void 0:i.call(this))||[]).filter((t=>{let[e]=t;return e===NE.LocalVideoLowTrack||e===NE.LocalVideoTrack})).forEach((e=>{let[i,{ssrcs:n}]=e;const s=function(t,e){const i=e.videoSend.find((e=>e.ssrc===t));return i?{mediaType:"video",isVideoMute:!1,frameRateInput:i.inputFrame&&i.inputFrame.frameRate.toString(),frameRateSent:i.sentFrame&&i.sentFrame.frameRate.toString(),googRtt:i.rttMs.toString(),qpSumPerFrame:Math.floor(i.qpSumPerFrame).toString()}:null}(n[0].ssrcId,t);s&&dy((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,kf.PUBLISH_RELATED_STATS,{stream_type:i===NE.LocalVideoLowTrack?"low":"high",stats:s})}))}))}uploadDenoiserStats(t){for(let s=0;s<t.length;s++){const o=t[s];if(o instanceof IT){var e,i,n;const t=null===(e=(i=o._external).getDenoiserStats)||void 0===e?void 0:e.call(i);return void(t&&(null===(n=this.requestUpload)||void 0===n||n.call(this,kf.DENOISER_STATS,t)))}}}uploadExtensionStats(t){for(let e=0;e<t.length;e++)t[e].getProcessorStats().forEach((t=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,t.type,t.stats)}))}stopUploadUplinkStats(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0)}startUploadDownlinkStats(){if(this.uploadDownlinkStarted)return;let t;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let e=!1;this.downlinkStatsUploadInterval=window.setInterval((()=>{var i;const n=null===(i=this.requestStats)||void 0===i?void 0:i.call(this);n&&(this.uploadDownlinkStats(n,e,t),t=n),e=!e}),3e3),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkRelatedStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestStats)||void 0===t?void 0:t.call(this);e&&(this.uploadRelatedDownlinkStats(e,this.lastStats),this.lastStats=e)}),1e3),this.downlinkExtensionStatsUploadInterval&&window.clearInterval(this.downlinkExtensionStatsUploadInterval),this.downlinkExtensionStatsUploadInterval=window.setInterval((()=>{var t;const e=null===(t=this.requestRemoteMedia)||void 0===t?void 0:t.call(this);e&&this.uploadDownlinkExtensionStats(e)}),2e3)}uploadDownlinkStats(t,e,i){var n;((null===(n=this.requestRemoteMedia)||void 0===n?void 0:n.call(this))||[]).forEach((n=>{let[s,o]=n;if(o.has(IE.VIDEO)&&s.videoTrack){const n=s.videoTrack?function(t,e,i,n,s){const o=e.videoRecv.find((e=>e.ssrc===t));if(!o)return null;const r={id:ZT(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:o.ssrc.toString()};var a,c;if(r.bytesReceived=o.bytes.toString(),r.packetsLost=o.packetsLost.toString(),r.packetsReceived=o.packets.toString(),o.framesRateFirefox&&(r.A_frr=o.framesRateFirefox.toString()),o.receivedFrame?(r.A_frr=o.receivedFrame.frameRate.toString(),r.A_fhr=o.receivedFrame.height.toString(),r.A_fwr=o.receivedFrame.width.toString()):(r.A_fhr=null===(a=n._videoHeight)||void 0===a?void 0:a.toString(),r.A_fwr=null===(c=n._videoWidth)||void 0===c?void 0:c.toString()),r.A_frd=o.decodeFrameRate.toString(),o.outputFrame&&(r.A_fro=o.outputFrame.frameRate.toString()),void 0!==o.jitterBufferMs&&(r.A_jbm=Math.floor(o.jitterBufferMs).toString()),void 0!==o.currentDelayMs&&(r.A_cdm=Math.floor(o.currentDelayMs).toString()),r.A_fs=o.firsCount.toString(),r.A_ns=o.nacksCount.toString(),r.A_ps=o.plisCount.toString(),n&&(r.A_vrtd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),n._player&&n._player.freezeTimeCounterList.length>0&&(r.A_vrft=Math.round(n._player.freezeTimeCounterList.splice(0,1)[0]).toString()),s&&n._player&&"visible"===xT.visibility){const t=Math.min(6e3,n._player.renderFreezeAccTime);r.A_vrrft=Math.round(t).toString(),n._player.renderFreezeAccTime=Math.max(0,n._player.renderFreezeAccTime-t)}if(r.A_rvps=cf[n._player?n._player.videoElementStatus:"uninit"].toString(),i){const e=i.videoRecv.find((e=>e.ssrc===t));if(e&&void 0!==o.totalInterFrameDelay&&void 0!==o.totalSquaredInterFrameDelay&&void 0!==e.totalInterFrameDelay&&void 0!==e.totalSquaredInterFrameDelay){const t=o.totalInterFrameDelay-e.totalInterFrameDelay,i=o.totalSquaredInterFrameDelay-e.totalSquaredInterFrameDelay,n=o.framesDecodeCount-e.framesDecodeCount,s=t/n*1e3,a=Math.round(1e3*Math.sqrt((i-Math.pow(t,2)/n)/n));!isNaN(a)&&s+a>Math.max(3*s,s+150)&&(r.A_ifdsd=a.toString())}}return r}(s._videoSSRC,t,i,s.videoTrack,e):void 0;n&&dy((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,kf.SUBSCRIBE_STATS,{stream_id:s.uid,stats:n})}))}if(o.has(IE.AUDIO)&&s.audioTrack){const e=s.audioTrack?function(t,e,i,n){const s=e.audioRecv.find((e=>e.ssrc===t));if(!s)return null;const o={id:ZT(10,""),timestamp:new Date(e.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:s.ssrc.toString()};if(o.bytesReceived=s.bytes.toString(),o.packetsLost=s.packetsLost.toString(),o.packetsReceived=s.packets.toString(),s.outputLevel?o.A_aol=Math.round(100*s.outputLevel).toString():o.A_aol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),o.A_apol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),n&&(o.A_artd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),o.A_jr=s.jitterMs.toString(),o.A_jbm=Math.floor(s.jitterBufferMs).toString(),o.A_cdm=Math.floor(s.jitterBufferMs).toString(),o.A_raps=cf[mb.getPlayerState(n.getTrackId())].toString(),i){const e=i.audioRecv.find((e=>e.ssrc===t));if(e){const t=s.concealedSamples-e.concealedSamples;t>0&&(o.A_cs=Math.round(t).toString())}}return o}(s._audioSSRC,t,i,s.audioTrack):void 0;e&&dy((()=>{var t;return null===(t=this.requestUpload)||void 0===t?void 0:t.call(this,kf.SUBSCRIBE_STATS,{stream_id:s.uid,stats:e})}))}}))}uploadRelatedDownlinkStats(t,e){var i;((null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[]).forEach((i=>{let[n,s]=i;if(s.has(IE.VIDEO)&&n.videoTrack){var o;const i=!0===(n._videoSSRC&&(null===(o=this.requestVideoIsReady)||void 0===o?void 0:o.call(this,n._videoSSRC))||!1),s=function(t,e,i,n,s,o){const r=i.videoRecv.find((e=>e.ssrc===t)),a=s?s.videoRecv.find((e=>e.ssrc===t)):void 0;if(!r)return null;const c=MT.isRemoteVideoFreeze(o,r,a)&&e,l={mediaType:"video",isVideoMute:!1,peerId:n,frameRateReceived:r.receivedFrame&&r.receivedFrame.frameRate.toString(),frameRateDecoded:r.decodedFrame&&r.decodedFrame.frameRate.toString(),isFreeze:c,bytesReceived:r.bytes.toString(),packetsReceived:r.packets.toString(),packetsLost:r.packetsLost.toString(),qpSumPerFrame:Math.floor(r.qpSumPerFrame).toString()};return r.framesRateFirefox&&(l.frameRateDecoded=r.framesRateFirefox.toString(),l.frameRateReceived=r.framesRateFirefox.toString()),l}(n._videoSSRC,i,t,n.uid,e,n.videoTrack);s&&dy((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,kf.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:s})}))}if(s.has(IE.AUDIO)&&n.audioTrack){const e=function(t,e,i,n){const s=e.audioRecv.find((e=>e.ssrc===t));if(!s)return null;const o=MT.isRemoteAudioFreeze(n);return{mediaType:"audio",isAudioMute:!1,peerId:i,googJitterReceived:s.jitterMs.toString(),isFreeze:o,bytesReceived:s.bytes.toString(),packetsReceived:s.packets.toString(),packetsLost:s.packetsLost.toString(),frameReceived:s.receivedFrames.toString(),frameDropped:s.droppedFrames.toString()}}(n._audioSSRC,t,n.uid,n.audioTrack);e&&dy((()=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,kf.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:e})}))}}))}stopUploadDownlinkStats(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0)}stopUploadTransportStats(){this.uploadTransportStarted&&(this.uploadTransportStarted=!1,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=void 0)}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval),this.extensionUsageStatsUploadInterval=void 0)}uploadDownlinkExtensionStats(t){t.forEach((t=>{let[e,i]=t;i.has(IE.VIDEO)&&e.videoTrack&&e.videoTrack.getProcessorStats().forEach((t=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,t.type,t.stats)})),i.has(IE.AUDIO)&&e.audioTrack&&e.audioTrack.getProcessorStats().forEach((t=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,t.type,t.stats)}))}))}}function cO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function lO(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?cO(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):cO(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}const dO="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",hO="9",uO=2e4,pO=4e4;class mO{get localCapabilities(){return hy(this._localCapabilities)}get rtpCapabilities(){return hy(this._rtpCapabilities)}get candidates(){return hy(this._candidates)}get iceParameters(){return hy(this._iceParameters)}get dtlsParameters(){return hy(this._dtlsParameters)}constructor(t){vp(this,"sessionDesc",void 0),vp(this,"_localCapabilities",void 0),vp(this,"_rtpCapabilities",void 0),vp(this,"_candidates",void 0),vp(this,"_iceParameters",void 0),vp(this,"_dtlsParameters",void 0),vp(this,"setup",void 0),vp(this,"currentMidIndex",void 0),vp(this,"cname",void 0),vp(this,"firefoxSsrcMidMap",new Map),t=hy(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=t,c=UI.exports.parse(dO);this._rtpCapabilities=s,this._candidates=n,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const l=this.rtpCapabilities.send;for(const t of c.mediaDescriptions){if(t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd,t.attributes.fingerprints=i.fingerprints,t.attributes.candidates=n,t.attributes.setup=o,"application"===t.media.mediaType&&(t.attributes.sctpPort="5000"),"video"===t.media.mediaType&&(t.media.fmts=l.videoCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=l.videoCodecs,t.attributes.extmaps=l.videoExtensions,Gv("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=$I([{ssrcId:pO,rtx:Gv("USE_SUB_RTX")?40001:void 0}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}if("audio"===t.media.mediaType&&(t.media.fmts=l.audioCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=l.audioCodecs,t.attributes.extmaps=l.audioExtensions,tA(t),Gv("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=$I([{ssrcId:uO}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(t){const e=UI.exports.parse(dO);this._rtpCapabilities=t;const i=this.rtpCapabilities.send;for(const t of e.mediaDescriptions){if(t.attributes.iceUfrag=this._iceParameters.iceUfrag,t.attributes.icePwd=this._iceParameters.icePwd,t.attributes.fingerprints=this._dtlsParameters.fingerprints,t.attributes.candidates=this._candidates,t.attributes.setup=this.setup,"application"===t.media.mediaType&&(t.attributes.sctpPort="5000"),"video"===t.media.mediaType&&(t.media.fmts=i.videoCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=i.videoCodecs,t.attributes.extmaps=i.videoExtensions,Gv("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=$I([{ssrcId:pO,rtx:Gv("USE_SUB_RTX")?40001:void 0}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}if("audio"===t.media.mediaType&&(t.media.fmts=i.audioCodecs.map((t=>t.payloadType.toString(10))),t.attributes.payloads=i.audioCodecs,t.attributes.extmaps=i.audioExtensions,Gv("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:i}=$I([{ssrcId:uO}],this.cname);t.attributes.ssrcs=e,t.attributes.ssrcGroups=i}}this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1}preloadRemoteMedia(t){this.rtpCapabilities;const e=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<t;o++){const t=2*o+uO,r=2*o+pO,{ssrcs:a,ssrcGroups:c}=$I([{ssrcId:t}],this.cname),{ssrcs:l,ssrcGroups:d}=$I([{ssrcId:r,rtx:Gv("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:hO,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:d,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:hO,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return UI.exports.print(this.sessionDesc)}send(t,e,i,n){const{ssrcs:s,ssrcGroups:o}=$I(e,this.cname,Gv("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(zu()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const t=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const e=this.findAvailableMediaIndex(t,s);let i;return-1===e||Wu()||Ku()||Xu()||0===e&&Gv("USE_SUB_RTX")?(i=this.createOrRecycleSendMedia(t,s,o,"sendonly",n),this.updateBundleMids()):(i=hy(this.sessionDesc.mediaDescriptions[e]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(i,n)),zu()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(t){const e=t.map((t=>{let{kind:e,ssrcMsg:i,mslabel:n}=t;return this.send(e,i,n)})),i=[];let n=!1;return e.forEach((t=>{let{mid:e,needExchangeSDP:s}=t;s&&(n=!0),i.push(e)})),{mids:i,needExchangeSDP:n}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>e.attributes.mid&&-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach((t=>{"0"===t.attributes.mid||zu()||Wu()||Ku()?t.attributes.ssrcs=[]:(t.attributes.ssrcs=[],t.attributes.direction="inactive",t.media.port="0")})),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>t.includes(e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="inactive"}))}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>t.includes(e.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((t=>{t.attributes.direction="recvonly"}))}receive(t,e,i,n){t.forEach(((t,s)=>{this.createOrRecycleRecvMedia(t,[],"recvonly",e,i,n[s])})),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter((e=>-1!==t.indexOf(e.attributes.mid)));if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach((t=>{t.media.port="0",t.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(t){t===AE.TCP?this._candidates.forEach((t=>{-1===this._candidates.findIndex((e=>"tcp"===e.transport&&e.connectionAddress===t.connectionAddress&&e.port===t.port))&&this._candidates.push(lO(lO({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})):this._candidates=this._candidates.filter((t=>"tcp"!==t.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(t){t=hy(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===t&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(zu()){if(n){const t=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(t||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!t||t!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(t,e,i,n,s,o){const r=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=this.localCapabilities.send;let l=[];if(r===IE.VIDEO){var d,h;if(Gv("H264_PROFILE_LEVEL_ID")&&"h264"===n&&(l=a.videoCodecs.filter((t=>{var e,i;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes(n)&&(null==t||null===(i=t.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])===Gv("H264_PROFILE_LEVEL_ID")}))),!l||0===(null===(d=l)||void 0===d?void 0:d.length)){const t=c.videoCodecs.filter((t=>{var e;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes(n)}));0!==t.length&&(l=a.videoCodecs.filter((e=>t.some((t=>t.payloadType===e.payloadType)))))}if(Gv("USE_PUB_RTX")){const t=l.map((t=>t.payloadType.toString())),e=a.videoCodecs.filter((e=>{var i,n;return"rtx"===(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName)&&t.includes((null===(n=e.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));l=[...l,...e]}0===l.length&&(Av.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(h=a.videoCodecs[0].rtpMap)||void 0===h?void 0:h.encodingName)),l=a.videoCodecs)}else l=a.audioCodecs.filter((t=>{var e;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes(s)})),0===l.length&&(Av.warning("codec ".concat(s," not included in rtpCapabilities, fallback to opus")),l=a.audioCodecs.filter((t=>{var e;return((null===(e=t.rtpMap)||void 0===e?void 0:e.encodingName.toLowerCase())||"").includes("opus")})));const u=r===IE.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const p="".concat(this.currentMidIndex);let m={media:{mediaType:r,port:hO,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(p)}};m=this.mungRecvMediaDsec(m,t,o);const v=this.findFirstClosedMedia(r);if(v){const t=this.sessionDesc.mediaDescriptions.indexOf(v);this.sessionDesc.mediaDescriptions[t]=m}else this.sessionDesc.mediaDescriptions.push(m);return m}createOrRecycleSendMedia(t,e,i,n,s){const o=this.rtpCapabilities.send,r=t===IE.VIDEO?o.videoCodecs:o.audioCodecs,a=t===IE.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let l={media:{mediaType:t,port:hO,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((t=>t.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};l=this.mungSendMediaDesc(l,s);const d=this.findFirstClosedMedia(t);if(d){const t=this.sessionDesc.mediaDescriptions.indexOf(d);this.sessionDesc.mediaDescriptions[t]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((t=>"0"!==t.media.port)).map((t=>t.attributes.mid))}mungRecvMediaDsec(t,e,i){const n=hy(t);return zI(n),WI(n,e),KI(n,e),qI(n),YI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(t,e){const i=hy(t);return YI(i,e,this.localCapabilities.recv),tA(i),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===t));if(-1!==i){const t=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=t}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find((e=>zu()?"0"===e.media.port&&e.media.mediaType===t:"0"===e.media.port))}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find((e=>{var i,n;return(null===(i=e.attributes)||void 0===i||null===(n=i.ssrcs[0])||void 0===n?void 0:n.ssrcId)===t[0].ssrcId}))}getSSRC(t){var e;return null===(e=this.sessionDesc.mediaDescriptions.find((e=>e.attributes.mid===t)))||void 0===e?void 0:e.attributes.ssrcs}}var vO;function gO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function fO(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?gO(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):gO(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let EO=(cS((vO=class t extends KE{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(t,e,i){super(t,e),vp(this,"store",void 0),vp(this,"peerConnection",void 0),vp(this,"remoteSDP",void 0),vp(this,"initialOffer",void 0),vp(this,"transportEventReceiver",void 0),vp(this,"statsFilter",void 0),vp(this,"localCapabilities",void 0),vp(this,"localCandidateCount",0),vp(this,"allCandidatesReceived",!1),vp(this,"establishPromise",void 0),vp(this,"mutex",new US("NVExtentionsConnection-mutex")),vp(this,"rtcMedia",void 0),this.store=e,this.peerConnection=i,this.statsFilter=CA(this.peerConnection,Gv("STATS_UPDATE_INTERVAL"),void 0,zu()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(t){try{const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=FI(t.sdp),i=await XI(!Gv("USE_PUB_RTX")&&!Gv("USE_SUB_RTX"),Gv("FILTER_VIDEO_FEC"),Gv("FILTER_AUDIO_FEC"));return this.localCapabilities=i,this.initialOffer=t,fO(fO({},e),{},{rtpCapabilities:i,offerSDP:t.sdp})}catch(t){throw new _v(Ev.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new mO({remoteIceParameters:t,remoteDtlsParameters:e,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:ZI(this.localCapabilities),cname:o});const r=this.remoteSDP.toString(),a=UI.exports.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((t=>"audio"===t.media.mediaType));c&&tA(c);const l=UI.exports.print(a),d=this.logSDPExchange(l||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),null==d||d(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(t.toString()))}}async updateRemoteConnect(t){var e,i,n;null===(e=this.remoteSDP)||void 0===e||e.updateRemoteRTPCapabilities(t),null===(i=this.remoteSDP)||void 0===i||i.preloadRemoteMedia(2);const s=null===(n=this.remoteSDP)||void 0===n?void 0:n.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),Av.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(t,e,i){var n=this;return LI((function*(){const s=yield PI(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];t.forEach((t=>{const e=n.peerConnection.addTransceiver(t._mediaStreamTrack,{direction:"sendonly"});o.push(e)})),zu()&&!0===Gv("SIMULCAST")&&(yield PI(n.applySimulcastForFirefox(o,t)));const r=yield PI(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(t.length),c=n.mungSendOfferSDP(r.sdp,t,a),l=UI.exports.parse(c),d=a.map((t=>{const e=l.mediaDescriptions.find((e=>e.attributes.mid===t));if(!e)throw new Error("Cannot extract ssrc from mediaDescription.");return HI(e,Gv("USE_PUB_RTX"))}));let h;try{h=yield d}catch(s){h=[],n.remoteSDP.receive(t,e,i,h);const o=n.remoteSDP.toString();throw yield PI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield PI(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield PI(n.stopSending(a,!0)),s}n.remoteSDP.receive(t,e,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield PI(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield PI(n.applySimulcastEncodings(o,t)),yield PI(n.applySendEncodings(o,t)),null==p||p(u),yield PI(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((t,e)=>{const i=a[e];return{localSSRC:d[e],id:i,transceiver:t}}))}catch(t){throw t instanceof _v?t:new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(t.toString()))}finally{s()}}))()}async stopSending(t,e){const i=e?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const e=this.peerConnection.getTransceivers().filter((e=>-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");e.map((t=>{var e;t.direction="inactive",null===(e=t.stop)||void 0===e||e.call(t)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(t);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(t.toString()))}finally{i&&i()}}async receive(t,e,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,e,i,n);if(o){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(n.sdp,s,t);null==i||i(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),Av.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else Av.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((t=>t.mid===s));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:s}}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(t.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const t=this.remoteSDP.toString(),e=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==e||e(i.sdp||""),await this.peerConnection.setLocalDescription(i),Av.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else Av.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return e.map((t=>{const e=this.peerConnection.getTransceivers().find((e=>e.mid===t));if(!e)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:e.receiver.track,id:t}}))}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(t.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(t.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(t.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(t.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((t=>{t.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(t.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter((e=>e.mid&&-1!==t.indexOf(e.mid)));if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map((async(t,e)=>{t.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(t.toString()))}}restartICE(t){var e=this;return LI((function*(){const i=yield PI(e.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(YE().supportPCSetConfiguration){const i=e.peerConnection.getConfiguration(),n=t===AE.RELAY?"relay":"all";i.iceTransportPolicy!==n&&(Av.debug("restartICE change iceTransportPolicy from [".concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,e.peerConnection.setConfiguration(i))}else if(t===AE.RELAY)return;t!==AE.RELAY&&e.remoteSDP.updateCandidates(t);const n=yield PI(e.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=FI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;e.remoteSDP.restartICE(o);const r=e.remoteSDP.toString(),a=e.logSDPExchange(n.sdp||"","offer","local","restartICE");yield PI(e.peerConnection.setLocalDescription(n)),null==a||a(r),yield PI(e.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(t){Av.warning("restart ICE failed, abort operation",t)}finally{i()}}))()}close(){var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(t){throw new _v(Ev.EXCHANGE_SDP_FAILED,t.toString())}}async updateSendParameters(t,e){const i=this.peerConnection.getTransceivers().filter((e=>e.mid===t));1===i.length&&(this.isVP8Simulcast(e)?zu()||await this.applySimulcastEncodings(i,[e]):await this.applySendEncodings(i,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const i=this.peerConnection.getTransceivers().find((t=>t.mid===e));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}getP2PConnectionParams(){var t;if(null===(t=this.peerConnection.currentLocalDescription)||void 0===t||!t.sdp||!this.localCapabilities)throw new Error;return fO(fO({},FI(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Av.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Av.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Gv("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(Uf(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.servers)),Gv("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Gv("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(BT(t.turnServerURL),":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&!Gv("FORCE_TURN_TCP")&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}async applySendEncodings(t,e){try{if(!YE().supportSetRtpSenderParameters)return;if(t.length!==e.length)return;for(let c=0;c<t.length;c++){const l=t[c],d=e[c];if(d&&d instanceof wC){var i,n;if(this.isVP8Simulcast(d))continue;const t={},e={};switch(d._optimizationMode){case"motion":t.degradationPreference="maintain-framerate";break;case"detail":t.degradationPreference="maintain-resolution";break;default:t.degradationPreference="balanced"}var s,o,r,a;if(null!==(i=d._encoderConfig)&&void 0!==i&&i.bitrateMax&&(e.maxBitrate=1e3*(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)),d._hints.includes(uE.LOW_STREAM)&&(null!==(o=d._encoderConfig)&&void 0!==o&&o.frameRate&&(e.maxFramerate=FT(d._encoderConfig.frameRate)),null!==(r=d._encoderConfig)&&void 0!==r&&r.scaleResolutionDownBy&&(null===(a=d._encoderConfig)||void 0===a?void 0:a.scaleResolutionDownBy)>1&&(e.scaleResolutionDownBy=d._encoderConfig.scaleResolutionDownBy)),Gv("DSCP_TYPE")&&op()){const t=Gv("DSCP_TYPE");["very-low","low","medium","high"].includes(t)&&(e.networkPriority=t)}const c=l.sender.getParameters(),h=null===(n=c.encodings)||void 0===n?void 0:n[0];zu()&&!h&&(t.encodings=[e]),h&&Object.assign(h,e),Object.assign(c,t),await l.sender.setParameters(c)}}}catch(t){Av.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(t,e,i){const n=UI.exports.parse(t);return e.forEach(((t,e)=>{const s=i[e],o=n.mediaDescriptions.find((t=>t.attributes.mid===s));o&&(WI(o,t),JI(o,t,this.store.codec))})),UI.exports.print(n)}mungReceiveAnswerSDP(t,e,i){const n=UI.exports.parse(t),s=n.mediaDescriptions.find((t=>t.attributes.mid===e));return s&&i===IE.AUDIO&&"audio"===s.media.mediaType&&tA(s),UI.exports.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;null===(e=this.onFirstAudioReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;null===(e=this.onFirstVideoReceived)||void 0===e||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;null===(e=this.onFirstAudioDecoded)||void 0===e||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,t,e,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;null===(e=this.onFirstVideoDecodedTimeout)||void 0===e||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let r=0;r<t.length;r++){var i,n,s,o;const a=t[r],c=e[r];if(c instanceof wC&&!c._hints.includes(uE.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabiltyMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=c._scalabiltyMode)||void 0===o?void 0:o.numSpatialLayers)>1&&"vp8"===this.store.codec){const t={},e={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};t.encodings=[{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:e.high}];const i=a.sender.getParameters();await a.sender.setParameters(Object.assign(i,t))}}}async applySimulcastEncodings(t,e){if(!zu()&&t.length===e.length)for(let i=0;i<t.length;i++){const n=e[i];if(n instanceof wC&&this.isVP8Simulcast(n)){const e=t[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=e.sender.getParameters();await e.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(t){var e,i,n,s;return!!(t instanceof wC&&Gv("SIMULCAST")&&"vp8"===this.store.codec&&!t._hints.includes(uE.LOW_STREAM)&&null!==(e=t._encoderConfig)&&void 0!==e&&e.bitrateMax&&(null===(i=t._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=t._scalabiltyMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=t._scalabiltyMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(t,e,i,n){if(Gv("SDP_LOGGING"))return Av.upload("exchanging ".concat(i," ").concat(e," SDP during NVExtentionsConnection.").concat(n,"\n"),t),"offer"===e?t=>{this.logSDPExchange(t,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return null==e?void 0:e[0].ssrcId}setConfiguration(e){if(YE().supportPCSetConfiguration){const i=t.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}}).prototype,"connect",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"connect"),vO.prototype),cS(vO.prototype,"updateRemoteConnect",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"updateRemoteConnect"),vO.prototype),cS(vO.prototype,"receive",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"receive"),vO.prototype),cS(vO.prototype,"batchReceive",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"batchReceive"),vO.prototype),cS(vO.prototype,"stopReceiving",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"stopReceiving"),vO.prototype),cS(vO.prototype,"muteRemote",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"muteRemote"),vO.prototype),cS(vO.prototype,"unmuteRemote",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"unmuteRemote"),vO.prototype),cS(vO.prototype,"muteLocal",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"muteLocal"),vO.prototype),cS(vO.prototype,"unmuteLocal",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"unmuteLocal"),vO.prototype),cS(vO.prototype,"close",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"close"),vO.prototype),cS(vO.prototype,"updateEncoderConfig",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"updateEncoderConfig"),vO.prototype),cS(vO.prototype,"updateSendParameters",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"updateSendParameters"),vO.prototype),cS(vO.prototype,"replaceTrack",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"replaceTrack"),vO.prototype),cS(vO.prototype,"getRemoteSSRC",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"getRemoteSSRC"),vO.prototype),vO);function _O(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From NVExtentionsConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}var SO;function bO(t){var e,i,n,s=2;for("undefined"!=typeof Symbol&&(i=xI,n=Symbol.iterator);s--;){if(i&&null!=(e=t[i]))return e.call(t);if(n&&null!=(e=t[n]))return new TO(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function TO(t){function e(t){if(Object(t)!==t)return _h.reject(new TypeError(t+" is not an object."));var e=t.done;return _h.resolve(t.value).then((function(t){return{value:t,done:e}}))}return(TO=function(t){this.s=t,this.n=t.next}).prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var i=this.s.return;return void 0===i?_h.resolve({value:t,done:!0}):e(i.apply(this.s,arguments))},throw:function(t){var i=this.s.return;return void 0===i?_h.reject(t):e(i.apply(this.s,arguments))}},new TO(t)}let yO=(cS((SO=class t extends KE{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,i){super(e,i),vp(this,"store",void 0),vp(this,"peerConnection",void 0),vp(this,"cname",void 0),vp(this,"mutex",new US("DataChannelConnection-mutex")),vp(this,"dataChannel",void 0),vp(this,"_p2pConnection",void 0),vp(this,"establishPromise",void 0),vp(this,"_nvMedia",void 0),this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(t.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new EO(e,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var t;const e=null===(t=this._nvMedia)||void 0===t?void 0:t.getLocalRtpCapabilities();return await this._p2pConnection.establish(e)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(t,e,i,n,s,o){return this.cname=o,await this._p2pConnection.connect(t,e,i,n,s,o),await new _h(((t,e)=>{const n=setTimeout((()=>{this.closeSignal(),e(new _v(Ev.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void t()},this.dataChannel.onerror=t=>{this.closeSignal(),e(t)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}send(t,e,i){var n=this;return LI((function*(){const s=yield PI(n.mutex.lock("From DataChannelConnection.send"));try{return yield*MI(bO(n._p2pConnection.send(t,e,i)),PI)}finally{s()}}))()}async stopSending(t,e){return this._p2pConnection.stopSending(t,e)}async receive(t,e,i,n){return this._nvMedia?(Av.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,e,this.cname)):(Av.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,e,i,n))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var e=this;return LI((function*(){return yield*MI(bO(e._p2pConnection.restartICE(t)),PI)}))()}close(){var t;null===(t=this._nvMedia)||void 0===t||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var e;null===(e=this._nvMedia)||void 0===e||e.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,e){return await this._p2pConnection.updateEncoderConfig(t,e)}async updateSendParameters(t,e){return await this._p2pConnection.updateSendParameters(t,e)}setStatsRemoteVideoIsReady(t,e){this._p2pConnection.setStatsRemoteVideoIsReady(t,e)}async replaceTrack(t,e){return await this._p2pConnection.replaceTrack(t,e)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,e,i,n){if(Gv("SDP_LOGGING"))return Av.upload("exchanging ".concat(i," ").concat(e," SDP during DataChannelConnection.").concat(n,"\n"),t),"offer"===e?t=>{this.logSDPExchange(t,"answer","local"===i?"remote":"local",n)}:void 0}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(Uf(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.servers)),Gv("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),Gv("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((t=>{t.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(t){const e=[];return t.forEach((t=>{t.security?t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turns:".concat(BT(t.turnServerURL),":").concat(t.tcpport,"?transport=tcp")}):(t.udpport&&!Gv("FORCE_TURN_TCP")&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.udpport,"?transport=udp")}),t.tcpport&&e.push({username:t.username,credential:t.password,credentialType:"password",urls:"turn:".concat(t.turnServerURL,":").concat(t.tcpport,"?transport=tcp")}))})),e}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var e;return null===(e=this.onICEConnectionStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var e;return null===(e=this.onConnectionStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var e;return null===(e=this.onDTLSTransportStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var e;return null===(e=this.onDTLSTransportError)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var e;return null===(e=this.onICETransportStateChange)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var e;return null===(e=this.onFirstAudioReceived)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var e;return null===(e=this.onFirstVideoReceived)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var e;return null===(e=this.onFirstAudioDecoded)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,e,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,t,e,i)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var e;return null===(e=this.onFirstVideoDecodedTimeout)||void 0===e?void 0:e.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,e)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,t,e)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,e)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,t,e)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}}).prototype,"connect",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"connect"),SO.prototype),cS(SO.prototype,"receive",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"receive"),SO.prototype),cS(SO.prototype,"stopReceiving",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"stopReceiving"),SO.prototype),cS(SO.prototype,"muteRemote",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"muteRemote"),SO.prototype),cS(SO.prototype,"unmuteRemote",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"unmuteRemote"),SO.prototype),cS(SO.prototype,"muteLocal",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"muteLocal"),SO.prototype),cS(SO.prototype,"unmuteLocal",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"unmuteLocal"),SO.prototype),cS(SO.prototype,"close",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"close"),SO.prototype),cS(SO.prototype,"updateEncoderConfig",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"updateEncoderConfig"),SO.prototype),cS(SO.prototype,"updateSendParameters",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"updateSendParameters"),SO.prototype),cS(SO.prototype,"replaceTrack",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"replaceTrack"),SO.prototype),cS(SO.prototype,"getRemoteSSRC",[wO],Object.getOwnPropertyDescriptor(SO.prototype,"getRemoteSSRC"),SO.prototype),SO);function wO(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From DataChannelConnection.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}var CO;function RO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function IO(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?RO(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):RO(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function AO(t){var e,i,n,s=2;for("undefined"!=typeof Symbol&&(i=xI,n=Symbol.iterator);s--;){if(i&&null!=(e=t[i]))return e.call(t);if(n&&null!=(e=t[n]))return new OO(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function OO(t){function e(t){if(Object(t)!==t)return _h.reject(new TypeError(t+" is not an object."));var e=t.done;return _h.resolve(t.value).then((function(t){return{value:t,done:e}}))}return(OO=function(t){this.s=t,this.n=t.next}).prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var i=this.s.return;return void 0===i?_h.resolve({value:t,done:!0}):e(i.apply(this.s,arguments))},throw:function(t){var i=this.s.return;return void 0===i?_h.reject(t):e(i.apply(this.s,arguments))}},new OO(t)}let NO=(cS((CO=class extends gv{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(LE.StateChange,e,this._state)}constructor(t,e){super(),vp(this,"store",void 0),vp(this,"statsUploader",void 0),vp(this,"connection",void 0),vp(this,"localTrackMap",new Map),vp(this,"remoteUserMap",new Map),vp(this,"pendingLocalTracks",[]),vp(this,"pendingRemoteTracks",[]),vp(this,"statsCollector",void 0),vp(this,"isPlanB",!1),vp(this,"shouldForwardP2PCreation",void 0),vp(this,"iceFailedCount",0),vp(this,"dtlsFailedCount",0),vp(this,"mutex",new US("P2PChannel-mutex")),vp(this,"_state",kE.Disconnected),vp(this,"_pcStatsUploadType",Gv("NEW_ICE_RESTART")?OE.FIRST_CONNECTION:OE.OLD_FIRST_CONNECTION),vp(this,"_isInRestartIce",!1),vp(this,"_isStartRestartIce",!1),vp(this,"_restartStates",["disconnected","failed"]),vp(this,"_restartTimer",void 0),vp(this,"_isFirstConnected",!0),vp(this,"handleMuteLocalTrack",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==kE.Connected)return void i(new _v(Ev.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(t);if(0===s.length)return void e();const o=s.find((t=>"videoLowTrack"===t[0]));o&&o[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(s.map((t=>{let[,{id:e}]=t;return e})));const r=this.createMuteMessage(s);await oy(this,LE.RequestMuteLocal,r),e()}catch(t){i(t)}finally{n()}})),vp(this,"handleUnmuteLocalTrack",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==kE.Connected)return void i(new _v(Ev.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(t);if(0===s.length)return void e();const o=s.find((t=>"videoLowTrack"===t[0]));if(o){const e=o[1];if(e.track._originMediaStreamTrack.stop(),YE().supportDualStreamEncoding){const i=t._mediaStreamTrack.clone();e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i}else{const i=FA(t,ay(this,LE.RequestLowStreamParameter));e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i}await new _h(((t,i)=>{this.handleReplaceTrack(e.track,t,i,!0)}))}await this.connection.unmuteLocal(s.map((t=>{let[,{id:e}]=t;return e})));const r=this.createUnmuteMessage(s);await oy(this,LE.RequestUnmuteLocal,r),e()}catch(t){i(t)}finally{n()}})),vp(this,"handleUpdateVideoEncoder",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(NE.LocalVideoTrack);if(!this.connection||!i||i.track!==t||this.state!==kE.Connected)return void e();const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),await this.connection.updateEncoderConfig(s,o),this.emit(LE.UpdateVideoEncoder,o),e()}catch(t){i(t)}finally{n()}})),vp(this,"handleSetOptimizationMode",(async(t,e,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const i=this.localTrackMap.get(NE.LocalVideoTrack);if(!this.connection||!i||i.track!==t||this.state!==kE.Connected)return;const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),e()}catch(t){i(t)}finally{n()}})),vp(this,"handleReplaceTrack",(async(t,e,i,n)=>{let s;Av.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(t.getTrackId(),"]")),"boolean"==typeof n&&n||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var o;const i=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(!this.connection||!i||this.state!==kE.Connected)return void e();if(await(null===(o=this.connection)||void 0===o?void 0:o.replaceTrack(t,i[1].id)),this.isPlanB){const e=i[1];e.id=t._mediaStreamTrack.id,this.localTrackMap.set(i[0],e)}if(i[0]===NE.LocalVideoTrack&&YE().supportDualStreamEncoding){const e=this.localTrackMap.get(NE.LocalVideoLowTrack);if(e){const i=t._mediaStreamTrack.clone();e.track._originMediaStreamTrack.stop(),e.track._mediaStreamTrack=i,e.track._originMediaStreamTrack=i,await new _h(((t,i)=>{this.handleReplaceTrack(e.track,t,i,!0)}))}}e()}catch(t){i(t)}finally{var r;null===(r=s)||void 0===r||r()}})),vp(this,"handleGetLocalVideoStats",(t=>{t(this.statsCollector.getLocalVideoTrackStats())})),vp(this,"handleGetLocalAudioStats",(t=>{t(this.statsCollector.getLocalAudioTrackStats())})),vp(this,"handleGetRemoteVideoStats",(t=>this.statsCollector.getRemoteVideoTrackStats(t.uid)[t.uid])),vp(this,"handleGetRemoteAudioStats",(t=>this.statsCollector.getRemoteAudioTrackStats(t.uid)[t.uid])),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new aO,this.bindStatsUploaderEvents(),this.isPlanB=!YE().supportUnifiedPlan||Gv("CHROME_FORCE_PLAN_B")&&op(),this.shouldForwardP2PCreation=Gv("FORWARD_P2P_CREATION")&&YE().supportPCSetConfiguration,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new yO({},this.store):this.isPlanB?new OA({},this.store):new BA({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){var i;this.state=kE.New;const n=this.shouldForwardP2PCreation&&"closed"===(null===(i=this.connection)||void 0===i?void 0:i.peerConnectionState);if(this.shouldForwardP2PCreation&&!n||(n&&this.connection&&(Av.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new yO(t,this.store):this.isPlanB?new OA(t,this.store):new BA(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new _v(Ev.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=Gv("NEW_ICE_RESTART")?OE.FIRST_CONNECTION:OE.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,e,i,n,s,o){if(!this.connection)throw new _v(Ev.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof yO?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(t,e,i,n,s,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kE.Connected)}async preConnect(t,e,i,n,s,o){if(!this.connection)throw new _v(Ev.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const r=await this.connection.connect(t,e,i,n,s,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kE.Connected,r}getEstablishParams(){if(this.connection instanceof yO)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}publish(t,e,i){var n=this;return LI((function*(){const s=yield PI(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==kE.Connected){if(n.state===kE.Disconnected)throw new _v(Ev.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(t);const e=t.filter((t=>-1===n.pendingLocalTracks.indexOf(t)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(e))}n.store.pubId=n.store.pubId+1,LT.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(t,e,i);if(0===o.length)return void(yield PI(n.tryToUnmuteAudio(t)));yield*MI(AO(n.doPublish(n.connection,o)),PI)}finally{s()}}))()}doPublish(t,e){var i=this;return LI((function*(){e.forEach((t=>{let{track:e,type:n}=t;const s=Date.now();i.store.publish(e.getTrackId(),n===NE.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(e);const n=yield PI(t.send(e.map((t=>{let{track:e}=t;return e})),i.store.codec,i.store.audioCodec)),s=(yield PI(n.next())).value,o=i.createGatewayPublishMessage(e,s);let r;try{r=yield o}catch(t){throw n.throw(t),(null==t?void 0:t.code)===Ev.WS_ABORT&&e.forEach((t=>{let{track:e}=t;-1===i.pendingLocalTracks.indexOf(e)&&i.pendingLocalTracks.push(e)})),i.unbindLocalTrackEvents(e),t}const a=i.mapPubResToRemoteConfig(o,r),c=(yield PI(n.next(a))).value;e.forEach((t=>{let{type:e}=t;i.statsCollector.addLocalStats(e)})),i.assignLocalTracks(e,c),i.statsUploader.startUploadUplinkStats(),e.forEach((t=>{let{track:e,type:n}=t;const s=Date.now();i.store.publish(e.getTrackId(),n===NE.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}publishLowStream(t){var e=this;return LI((function*(){if(!e.connection||e.state!==kE.Connected)return;const i=yield PI(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const s=e.localTrackMap.get(NE.LocalVideoTrack);if(!s)throw new _v(Ev.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(NE.LocalVideoLowTrack))throw new _v(Ev.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(s.track,t),type:NE.LocalVideoLowTrack}];if(yield*MI(AO(e.doPublish(e.connection,o)),PI),s.track.muted||!s.track.enabled){var n;const t=null===(n=e.localTrackMap.get(NE.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==t&&(yield PI(e.connection.muteLocal([t])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(Av.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await sy(this,LE.RequestRePublish,this.pendingLocalTracks),this.emit(LE.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async reSubscribe(t){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:e,kind:i}=this.pendingRemoteTracks[t];(i!==IE.AUDIO||e._audio_added_&&e._audioSSRC)&&(i!==IE.VIDEO||e._video_added_&&e._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(t)await sy(this,LE.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:e}of this.pendingRemoteTracks)await this.subscribe(t,e,e===IE.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach((t=>{let{user:e}=t;this.emit(LE.MediaReconnectEnd,e.uid)})),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==kE.Connected)return void t.forEach((t=>{const e=this.pendingLocalTracks.indexOf(t);-1!==e&&this.pendingLocalTracks.splice(e,1)}));const e=this.filterTobeUnpublishedTracks(t);if(0===e.length)return;const i=e.find((t=>"videoLowTrack"===t[0]));return i&&i[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishLowStream(){if(!this.connection||this.state!==kE.Connected)return;const t=this.localTrackMap.get(NE.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[NE.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const i=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map((t=>{let[,{id:e}]=t;return e}))),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map((t=>{let[e,{track:i}]=t;return{type:e,track:i}}))),e.forEach((t=>{let[e]=t;this.statsCollector.removeLocalStats(e)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadUplinkStats(),i}async subscribe(t,e,i,n,s){var o;if(!this.connection||this.state!==kE.Connected)throw new _v(Ev.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(o=this.remoteUserMap.get(t))&&void 0!==o&&o.has(e))return;let r,a,c;if(s){const i=s.find((t=>{let{stream_type:i}=t;return i===e}));if(!i)throw new _v(Ev.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const n=await this.connection.receive(e,i.ssrcs,String(t._uintid),i.attributes);this.connection instanceof BA&&(c=n.transceiver),r=n.track,a=n.id}else{const s=await this.connection.receive(e,[{ssrcId:i,rtx:n}],String(t._uintid),void 0);this.connection instanceof BA&&(c=s.transceiver),r=s.track,a=s.id}e===IE.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(r):(t._audioTrack=new sO(r,t.uid,t._uintid,this.store),Av.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(r):(t._videoTrack=new nO(r,t.uid,t._uintid,this.store),Av.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack));const l=this.remoteUserMap.get(t);l?l.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadDownlinkStats();const d=this.pendingRemoteTracks.findIndex((i=>{let{user:n,kind:s}=i;return n.uid===t.uid&&e===s}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(LE.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==kE.Connected)throw new _v(Ev.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter((t=>{var e;let{user:i,mediaType:n}=t;return!(null!==(e=this.remoteUserMap.get(i))&&void 0!==e&&e.has(n))}));const e=await this.connection.batchReceive(t.map((t=>{let{user:e,mediaType:i,ssrcId:n,rtxSsrcId:s}=t;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(e._uintid)}})));t.forEach(((t,i)=>{let{user:n,mediaType:s}=t;const{track:o,id:r,transceiver:a}=e[i];s===IE.AUDIO?(n._audioTrack?n._audioTrack._updateOriginMediaStreamTrack(o):(n._audioTrack=new sO(o,n.uid,n._uintid,this.store),Av.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(n._audioTrack.getTrackId()))),a&&n._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._audioTrack)):(n._videoTrack?n._videoTrack._updateOriginMediaStreamTrack(o):(n._videoTrack=new nO(o,n.uid,n._uintid,this.store),Av.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(n._videoTrack.getTrackId()))),a&&n._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._videoTrack));const c=this.remoteUserMap.get(n);c?c.set(s,r):this.remoteUserMap.set(n,new Map([[s,r]])),this.statsCollector.addRemoteStats(n.uid),this.statsUploader.startUploadDownlinkStats();const l=this.pendingRemoteTracks.findIndex((t=>{let{user:e,kind:i}=t;return e.uid===n.uid&&s===i}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(LE.MediaReconnectEnd,n.uid))}))}async unsubscribe(t,e,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==e?n.uid===t.uid&&e===s:n.uid===t.uid}));if(n.forEach((t=>{const e=this.pendingRemoteTracks.indexOf(t);this.pendingRemoteTracks.splice(e,1)})),this.connection&&this.state===kE.Connected||i||n.forEach((e=>{let{kind:i}=e;var n;if(i===IE.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===IE.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}})),!this.connection||this.state!==kE.Connected)return;const s=this.filterTobeUnSubscribedTracks(t,e);if(0===s.length)return;await this.connection.stopReceiving(s.map((t=>{let[,{id:e}]=t;return e})));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),s.forEach((t=>{let[e,{kind:n}]=t;var s,o;if(n===IE.VIDEO&&e._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(e._videoSSRC,!1)),n===IE.VIDEO)this.unbindRemoteTrackEvents(e._videoTrack),i||(null===(o=e._videoTrack)||void 0===o||o._destroy(),e._videoTrack=void 0);else if(n===IE.AUDIO){var r;this.unbindRemoteTrackEvents(e._audioTrack),i||(null===(r=e._audioTrack)||void 0===r||r._destroy(),e._audioTrack=void 0)}})),o}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:i,mediaType:n}of t){const t=this.pendingRemoteTracks.filter((t=>{let{user:e,kind:s}=t;return void 0!==n?e.uid===i.uid&&n===s:e.uid===i.uid}));t.forEach((t=>{const e=this.pendingRemoteTracks.indexOf(t);this.pendingRemoteTracks.splice(e,1)})),e=e.concat(t)}if(!this.connection||this.state!==kE.Connected)return void e.forEach((t=>{let{user:e,kind:i}=t;var n;if(i===IE.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===IE.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}}));const i=Xi(t).call(t,((t,e)=>{let{user:i,mediaType:n}=e;const s=this.filterTobeUnSubscribedTracks(i,n);return t.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((t=>{let[,{id:e}]=t;return e})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),i.forEach((t=>{let[e,{kind:i}]=t;var n,s;if(i===IE.VIDEO&&e._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(e._videoSSRC,!1)),i===IE.VIDEO)this.unbindRemoteTrackEvents(e._videoTrack),null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0;else if(i===IE.AUDIO){var o;this.unbindRemoteTrackEvents(e._audioTrack),null===(o=e._audioTrack)||void 0===o||o._destroy(),e._audioTrack=void 0}})),n}async muteRemote(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void Av.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void Av.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const n=e===IE.VIDEO?t._videoSSRC:t._audioSSRC;void 0!==n&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);i?i.get(e)||Av.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,".")):Av.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."))}getAllTracks(t){const e=this.localTrackMap.get(NE.LocalAudioTrack);if((null==e?void 0:e.track)instanceof OT){const i=e.track;return Array.from(this.localTrackMap.entries()).filter((t=>{let[e]=t;return e!==NE.LocalAudioTrack})).filter((e=>{let[i]=e;return!(t&&i===NE.LocalVideoLowTrack)})).map((t=>{let[,{track:e}]=t;return e})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((e=>{let[i]=e;return!(t&&i===NE.LocalVideoLowTrack)})).map((t=>{let[,{track:e}]=t;return e}))}reportPublishEvent(t,e,i,n,s){if(t){const i=this.localTrackMap.get(NE.LocalAudioTrack),o=n?this.localTrackMap.get(NE.LocalVideoLowTrack):this.localTrackMap.get(NE.LocalVideoTrack);PS.publish(this.store.sessionId,{eventElapse:LT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:null==i?void 0:i.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(uE.SCREEN_TRACK)),audio:!!i,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var o;i||(i=[]);const r=i.find((t=>t instanceof RT)),a=n?null===(o=this.localTrackMap.get(NE.LocalVideoTrack))||void 0===o?void 0:o.track:i.find((t=>t instanceof wC));PS.publish(this.store.sessionId,{eventElapse:LT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(uE.SCREEN_TRACK)),audio:!!r,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(t,e,i,n){const s=n===IE.VIDEO?i._videoSSRC:i._audioSSRC;s&&PS.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===IE.VIDEO,audio:n===IE.AUDIO,peerid:i.uid,subscribeRequestid:n===IE.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:LT.measureFromSubscribeStart(this.store.clientId,s)})}reset(){Av.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new US("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new yO({},this.store):this.isPlanB?new OA({},this.store):new BA({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(NE.LocalAudioTrack);if((null==t?void 0:t.track)instanceof OT){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach((t=>{e.removeAudioTrack(t)}))}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.state=kE.Disconnected}getStats(){var t;return null===(t=this.connection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return(null===(e=this.connection)||void 0===e?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(NE.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(NE.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof wC||e&&e.track instanceof RT?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from(gS(e=this.remoteUserMap).call(e)).find((e=>e.uid===t));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map((t=>{let[e]=t;return{uid:e.uid,level:e.audioTrack?100*e.audioTrack._source.getAccurateVolumeLevel():0}}));const e=this.localTrackMap.get(NE.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Wg(t).call(t,((t,e)=>t.level-e.level)),t}async disconnectForReconnect(){this.connection&&(Av.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=kE.Reconnecting,Gv("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&(null===(i=e._videoTrack._player.getVideoElement())||void 0===i||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new yO({},this.store):this.isPlanB?new OA({},this.store):new BA({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((t=>{let[e,{track:i}]=t;switch(e){case NE.LocalVideoTrack:i._hints.includes(uE.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case NE.LocalAudioTrack:i instanceof OT?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case NE.LocalVideoLowTrack:}})),this.emit(LE.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,i]=t;Array.from(gS(i).call(i)).forEach((t=>{this.setPendingRemoteMedia(e,t)})),this.emit(LE.MediaReconnectStart,e.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),Av.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((t instanceof RC?t.uid:t)===n.uid&&e===s)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return LI((function*(){if(!e.connection||e.state!==kE.Connected||e.connection instanceof yO)return;const i=yield PI(e.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield PI(e.connection.restartICE(t));const s=yield PI(n.next());if(s.done)return;const o=s.value,r=yield o;switch(e.reportPCDisconnectedOrFailed(t),t){case AE.TCP:e._pcStatsUploadType=OE.TCP_RESTART;break;case AE.RELAY:e._pcStatsUploadType=OE.RELAY_RESTART;break;default:e._pcStatsUploadType=OE.OLD_RESTART}e._isInRestartIce=!0,n.next(r)}catch(t){var s;null===(s=n)||void 0===s||s.throw(t)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(NE.LocalVideoTrack),i=this.localTrackMap.get(NE.LocalAudioTrack),n=t.videoSend.find((t=>t.ssrc===(null==e?void 0:e.ssrcs[0].ssrcId))),s=t.audioSend.find((t=>t.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const o=ry(this,LE.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,l=(c&&o?(c+o)/2:c||o)||0,d=100*t.sendPacketLossRate*.7/50+.3*l/1500,h=d<.17?1:d<.36?2:d<.59?3:d<.1?4:5,u=null==e?void 0:e.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(uE.SCREEN_TRACK)){const e=u._encoderConfig.bitrateMax,i=t.bitrate.actualEncoded;if(e&&i){const t=(1e3*e-i)/(1e3*e);return Jv[t<.15?0:t<.3?1:t<.45?2:t<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=t.audioRecv.find((t=>t.ssrc===s)),a=t.videoRecv.find((t=>t.ssrc===o));if(!r&&!a)return void(e+=1);const c=ry(this,LE.NeedSignalRTT),l=t.rtt,d=(l&&c?(l+c)/2:l||c)||0,h=r?r.jitterMs:void 0,u=t.recvPacketLossRate;let p=.7*u*100/50+.3*d/1500;h&&(p=.6*u*100/50+.2*d/1500+.2*h/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new _h(((e,i)=>{this.handleMuteLocalTrack(t,e,i)}))}filterTobePublishedTracks(t,e,i){const n=[],s=YE(),o=this.getAllTracks();t=ly(t=t.filter((t=>-1===o.indexOf(t))));let r=!1,a=!1;for(const o of t){if(o instanceof wC&&(this.localTrackMap.has(NE.LocalVideoTrack)||r?new _v(Ev.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:NE.LocalVideoTrack}),r=!0),e)){const t=this.getLowVideoTrack(o,i);n.push({track:t,type:NE.LocalVideoLowTrack})}if(o instanceof RT){const t=this.localTrackMap.get(NE.LocalAudioTrack);if(t){if(!(t.track instanceof OT))throw new _v(Ev.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new _v(Ev.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");t.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const t=n.find((t=>{let{type:e}=t;return e===NE.LocalAudioTrack}));if(!(t.track instanceof OT))throw new _v(Ev.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new _v(Ev.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");t.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof OT||o._bypassWebAudio)n.push({track:o,type:NE.LocalAudioTrack});else{const t=new OT;t.addAudioTrack(o),n.push({track:t,type:NE.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=ly(t=t.filter((t=>-1!==i.indexOf(t))));for(const i of t){if(i instanceof RT){const t=this.localTrackMap.get(NE.LocalAudioTrack);if(!t)continue;t.track instanceof OT?(t.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===t.track.trackList.length&&(e.push([NE.LocalAudioTrack,t]),t.track.close())):e.push([NE.LocalAudioTrack,t])}if(i instanceof wC){const t=this.localTrackMap.get(NE.LocalVideoTrack);if(!t)continue;e.push([NE.LocalVideoTrack,t]);const i=this.localTrackMap.get(NE.LocalVideoLowTrack);i&&e.push([NE.LocalVideoLowTrack,i])}}return e}bindLocalTrackEvents(t){t.forEach((t=>{let{track:e,type:i}=t;switch(i){case NE.LocalVideoTrack:e.addListener(hE.GET_STATS,this.handleGetLocalVideoStats),e.addListener(hE.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(hE.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(hE.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),e.addListener(hE.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),e.addListener(hE.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(hE.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(hE.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case NE.LocalAudioTrack:this.bindLocalAudioTrackEvents(e);case NE.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(t,e){t instanceof OT?t.trackList.forEach((t=>{t.addListener(hE.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(hE.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(hE.GET_STATS,this.handleGetLocalAudioStats),t.addListener(hE.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(hE.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.addListener(hE.GET_STATS,this.handleGetLocalAudioStats),t.addListener(hE.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(hE.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(hE.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(hE.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(hE.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map((t=>{let[e,{track:i}]=t;return{track:i,type:e}}))),t.forEach((t=>{let{track:e,type:i}=t;switch(i){case NE.LocalVideoTrack:e.off(hE.GET_STATS,this.handleGetLocalVideoStats),e.off(hE.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(hE.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(hE.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),e.off(hE.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),e.off(hE.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(hE.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(hE.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case NE.LocalAudioTrack:this.unbindLocalAudioTrackEvents(e);case NE.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(t){t instanceof OT?t.trackList.forEach((t=>{t.off(hE.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(hE.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(hE.GET_STATS,this.handleGetLocalAudioStats),t.off(hE.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(hE.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.off(hE.GET_STATS,this.handleGetLocalAudioStats),t.off(hE.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(hE.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(hE.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(hE.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(hE.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof nO&&e.addListener(hE.GET_STATS,(e=>{e(this.handleGetRemoteVideoStats(t))})),e instanceof sO&&e.addListener(hE.GET_STATS,(e=>{e(this.handleGetRemoteAudioStats(t))}))}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(hE.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,i]=t;i.has(IE.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(IE.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)}))}createGatewayPublishMessage(t,e){return t.map(((t,i)=>{let n,s,{track:o,type:r}=t;switch(r){case NE.LocalAudioTrack:n=aE.Audio,s={dtx:o instanceof IT&&o._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case NE.LocalVideoTrack:n=o._hints.includes(uE.SCREEN_TRACK)?aE.Screen:aE.High,s=IO(IO({},HT(o)),{},{codec:this.store.codec});break;case NE.LocalVideoLowTrack:n=aE.Low,s=IO(IO({},HT(o)),{},{codec:this.store.codec})}return{stream_type:n,attributes:s,ssrcs:e[i]}}))}createGatewayUnpublishMessage(t){return t.map((t=>{let e,[i,{track:n,ssrcs:s,id:o}]=t;switch(i){case NE.LocalVideoTrack:e=n._hints.includes(uE.SCREEN_TRACK)?aE.Screen:aE.High;break;case NE.LocalAudioTrack:e=aE.Audio;break;case NE.LocalVideoLowTrack:e=aE.Low}return{stream_type:e,ssrcs:s,mid:o}}))}assignLocalTracks(t,e){t.forEach(((t,i)=>{let{track:n,type:s}=t;this.localTrackMap.set(s,{track:n,id:e[i].id,ssrcs:e[i].localSSRC})}))}withdrawLocalTracks(t){t.forEach((t=>{let[e]=t;this.localTrackMap.delete(e)}))}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(Av.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(LE.PeerConnectionStateChange,e),"connected"!==e||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===e&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),Gv("NEW_ICE_RESTART")){if(this._restartStates.includes(e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const e=e=>{"disconnected"!==t.iceConnectionState&&"checking"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||(Av.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(e)),"CONNECTED"===ry(this,LE.QueryClientConnectionState)&&this.emit(LE.RequestRestartICE,e))},i=()=>{"disconnected"!==t.iceConnectionState&&"checking"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),Av.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(LE.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},n=Gv("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(Gv("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&YE().supportPCSetConfiguration)e(AE.RELAY),this._restartTimer=window.setTimeout(i,n);else if(zu())e(AE.UDP),this._restartTimer=window.setTimeout(i,4e3);else{if(e(AE.TCP),YE().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{e(AE.RELAY),this._restartTimer=window.setTimeout(i,n)}),n));this._restartTimer=window.setTimeout(i,n)}}),800))}}else{if("disconnected"===e&&"disconnected"===t.iceConnectionState)return setTimeout((()=>{"disconnected"===t.iceConnectionState&&Gv("ICE_RESTART")&&"CONNECTED"===ry(this,LE.QueryClientConnectionState)&&this.emit(LE.RequestRestartICE)}),800),void setTimeout((()=>{"disconnected"===t.peerConnectionState&&(Av.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(LE.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===e&&(Av.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(LE.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=t=>{"connected"!==t||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),Av.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),PS.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:gf.TRACER}).onSuccess(),this.emit(LE.IceConnectionStateChange,t)},t.onICETransportStateChange=t=>{Av.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},t.onDTLSTransportStateChange=t=>{Av.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},t.onDTLSTransportError=t=>{Av.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},t.onFirstAudioDecoded=t=>{var e;const i=Array.from(gS(e=this.remoteUserMap).call(e)).find((e=>e._audioSSRC===t));var n;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),null===(n=i.audioTrack)||void 0===n||n.emit(EE.FIRST_FRAME_DECODED),PS.firstRemoteFrame(this.store.sessionId,hf.FIRST_AUDIO_DECODE,uf.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:LT.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=t=>{var e;const i=Array.from(gS(e=this.remoteUserMap).call(e)).find((e=>e._audioSSRC===t));i&&PS.firstRemoteFrame(this.store.sessionId,hf.FIRST_AUDIO_RECEIVED,uf.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:LT.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(t,e,i)=>{this.reportVideoFirstFrameDecoded(t,e,i)},t.onFirstVideoReceived=t=>{var e;const i=Array.from(gS(e=this.remoteUserMap).call(e)).find((e=>e._videoSSRC===t));i&&PS.firstRemoteFrame(this.store.sessionId,hf.FIRST_VIDEO_RECEIVED,uf.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:LT.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(t,e)=>{const i="relay"===t.candidateType,n="relay"===e.candidateType;"unknown"!==e.candidateType&&i===n||this.emit(LE.ConnectionTypeChange,i),Av.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(KT(e))," -> ").concat(JSON.stringify(KT(t)),")"))},t.onSelectedRemoteCandidateChanged=(t,e)=>{Av.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(KT(e))," -> ").concat(JSON.stringify(KT(t)),")"))},t.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(t){const e=[];if(-1===this.getAllTracks().indexOf(t))return e;const i=this.localTrackMap.get(NE.LocalAudioTrack);if(t instanceof RT&&(null==i?void 0:i.track)instanceof OT)return i.track.isActive||e.push([NE.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n&&(e.push(n),n[0]===NE.LocalVideoTrack)){const t=this.localTrackMap.get(NE.LocalVideoLowTrack);t&&e.push([NE.LocalVideoLowTrack,t])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(NE.LocalAudioTrack);if(t instanceof RT&&(null==i?void 0:i.track)instanceof OT)return i.track.isActive&&e.push([NE.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find((e=>{let[,{track:i}]=e;return t===i}));if(n)if(n[0]===NE.LocalVideoTrack){e.push(n);const t=this.localTrackMap.get(NE.LocalVideoLowTrack);t&&e.push([NE.LocalVideoLowTrack,t])}else e.push(n);return e}createMuteMessage(t){return t.map((t=>{let e,[i,{track:n,ssrcs:s,id:o}]=t;switch(i){case NE.LocalAudioTrack:e=aE.Audio;break;case NE.LocalVideoTrack:e=n._hints.includes(uE.SCREEN_TRACK)?aE.Screen:aE.High;break;case NE.LocalVideoLowTrack:e=aE.Low}return{stream_type:e,ssrcs:s,mid:o}}))}createUnmuteMessage(t){return t.map((t=>{let e,[i,{track:n,ssrcs:s,id:o}]=t;switch(i){case NE.LocalAudioTrack:e=aE.Audio;break;case NE.LocalVideoTrack:e=n._hints.includes(uE.SCREEN_TRACK)?aE.Screen:aE.High;break;case NE.LocalVideoLowTrack:e=aE.Low}return{stream_type:e,ssrcs:s,mid:o}}))}filterTobeUnSubscribedTracks(t,e){const i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){const s=n.get(e);if(!s)return i;i.push([t,{kind:e,id:s}])}else Array.from(n.entries()).forEach((e=>{let[n,s]=e;i.push([t,{kind:n,id:s}])}));return i}createUnsubscribeMessage(t){const e=[];return t.forEach((t=>{let[i,{kind:n,id:s}]=t;switch(n){case IE.VIDEO:return void(i._videoSSRC&&e.push({stream_type:IE.VIDEO,ssrcId:i._videoSSRC}));case IE.AUDIO:return void(i._audioSSRC&&e.push({stream_type:IE.AUDIO,ssrcId:i._audioSSRC}))}})),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach((t=>{let[i,{kind:n}]=t;if(e.has(i)){let t=e.get(i);n===IE.VIDEO?t|=lE.Video:t|=lE.Audio,e.set(i,t)}else n===IE.VIDEO?e.set(i,lE.Video):e.set(i,lE.Audio)})),{users:Array.from(e.entries()).map((t=>{let[e,i]=t;return{stream_id:e.uid,stream_type:i}}))}}withdrawRemoteTracks(t){t.forEach((t=>{let[e,{kind:i}]=t;const n=this.remoteUserMap.get(e);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(e))}))}async updateBitrateLimit(t){const e=this.localTrackMap.get(NE.LocalVideoTrack),i=this.localTrackMap.get(NE.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),i&&t.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(t,e){return t.map(((t,i)=>{var n;let{stream_type:s}=t;return null===(n=e.find((t=>{let{stream_type:e}=t;return s===e})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(t){for(let i=0;i<t.length;i++)if(t[i]instanceof RT){var e;const n=this.filterTobeUnmutedTracks(t[i]);if(0===n.length)continue;await(null===(e=this.connection)||void 0===e?void 0:e.unmuteLocal(n.map((t=>{let[,{id:e}]=t;return e}))));const s=this.createUnmuteMessage(n);return void await oy(this,LE.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!(null===(e=this.connection)||void 0===e||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(LE.RequestUploadStats,t,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await XT(bv(this.dtlsFailedCount,Sv)),this.emit(LE.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await sy(this,LE.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(LE.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(NE.LocalVideoTrack)||this.pendingLocalTracks.some((t=>t instanceof wC))}throwIfTrackTypeNotMatch(t){if(t.filter((t=>t instanceof wC)).length>1)throw new _v(Ev.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter((t=>t instanceof RT)).length>1&&(t.some((t=>t instanceof RT&&t._bypassWebAudio))||!YE().webAudioMediaStreamDest))throw new _v(Ev.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof wC&&this.pendingLocalTracks.some((t=>t instanceof wC)))throw new _v(Ev.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof RT&&this.pendingLocalTracks.some((t=>t instanceof RT))&&(!YE().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some((t=>t instanceof RT&&t._bypassWebAudio))))throw new _v(Ev.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const i=YE().supportDualStreamEncoding,n=IO(IO({},{width:160,height:120,framerate:15,bitrate:50}),e);let s;s=i?t._mediaStreamTrack.clone():FA(t,n);const o=ZT(8,"track-low-"),r=new wC(s,IO(IO({},i&&{scaleResolutionDownBy:zT(n,t)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on(gE.TRANSCEIVER_UPDATED,(e=>{t._updateRtpTransceiver(e,pE.LOW_STREAM)})),r._hints.push(uE.LOW_STREAM),t.addListener(hE.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof BA){var s,o,r,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:d,peerConnectionState:h}=this.connection,{local:u,remote:p}=await this.connection.getSelectedCandidatePair();PS.pcStats(this.store.sessionId,{startTime:c,eventElapse:t-c||0,iceconnectionsate:l,dtlsstate:d,connectionstate:h,intSucc:e?1:2,error:n,selectedLocalCandidateProtocol:null!==(s=null==u?void 0:u.protocol)&&void 0!==s?s:"",selectedLocalCandidateType:null!==(o=u.candidateType)&&void 0!==o?o:"",selectedLocalCandidateAddress:"".concat(u.address,":").concat(u.port),selectedRemoteCandidateProtocol:null!==(r=p.protocol)&&void 0!==r?r:"",selectedRemoteCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:i})}}reportVideoFirstFrameDecoded(t,e,i,n){var s;const o=Array.from(gS(s=this.remoteUserMap).call(s)).find((e=>e._videoSSRC===t));if(o){n||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,r=s.subscribe.find((t=>t.userId===o.uid&&"video"===t.type));PS.firstRemoteVideoDecode(this.store.sessionId,hf.FIRST_VIDEO_DECODE,uf.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:LT.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(null==r?void 0:r.subscribeEnd)||0,subscriberStart:(null==r?void 0:r.subscribeStart)||0,videoAddNotify:(null==r?void 0:r.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(t);if(!n)return!1;const s=n.get(e);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(t){Av.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===kE.Connected?(Av.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===dE.datachannel?new yO({},this.store):this.isPlanB?new OA({},this.store):new BA({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((t=>{let[e,{track:i}]=t;e===NE.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,pE.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof BA&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===OE.TCP_RESTART&&t===AE.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,OE.DISCONNECTED_OR_FAILED)))}}).prototype,"startP2PConnection",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"startP2PConnection"),CO.prototype),cS(CO.prototype,"connect",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"connect"),CO.prototype),cS(CO.prototype,"preConnect",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"preConnect"),CO.prototype),cS(CO.prototype,"unpublish",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"unpublish"),CO.prototype),cS(CO.prototype,"unpublishLowStream",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"unpublishLowStream"),CO.prototype),cS(CO.prototype,"subscribe",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"subscribe"),CO.prototype),cS(CO.prototype,"massSubscribe",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"massSubscribe"),CO.prototype),cS(CO.prototype,"unsubscribe",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"unsubscribe"),CO.prototype),cS(CO.prototype,"massUnsubscribe",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"massUnsubscribe"),CO.prototype),cS(CO.prototype,"muteRemote",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"muteRemote"),CO.prototype),cS(CO.prototype,"unmuteRemote",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"unmuteRemote"),CO.prototype),cS(CO.prototype,"hasRemoteMediaWithLock",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"hasRemoteMediaWithLock"),CO.prototype),cS(CO.prototype,"disconnectForReconnect",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"disconnectForReconnect"),CO.prototype),cS(CO.prototype,"updateBitrateLimit",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"updateBitrateLimit"),CO.prototype),cS(CO.prototype,"remoteMediaSsrcChanged",[kO],Object.getOwnPropertyDescriptor(CO.prototype,"remoteMediaSsrcChanged"),CO.prototype),CO);function kO(t,e,i){const n=t[e];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const t=this.mutex,i=await t.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function LO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function PO(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?LO(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):LO(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var DO;!function(t){t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL"}(DO||(DO={}));class MO{constructor(t,e,i,n){vp(this,"state",void 0),this.state={codec:t,audioCodec:e,mode:i,clientId:n,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1}}dispatch(t){this.state=function(t,e){switch(e.type){case DO.SET_SESSION_ID:return PO(PO({},t),{},{sessionId:e.sessionId});case DO.SET_P2P_ID:return PO(PO({},t),{},{p2pId:e.p2pId});case DO.SET_UID:return PO(PO({},t),{},{uid:e.uid});case DO.SET_PUB_ID:return PO(PO({},t),{},{pubId:e.pubId});case DO.KEY_METRIC_CLIENT_CREATED:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{clientCreated:e.metric})});case DO.KEY_METRIC_JOIN_START:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{joinStart:e.metric})});case DO.AVOID_JOIN_START:return PO(PO({},t),{},{avoidJoinStart:e.avoidJoinStart});case DO.KEY_METRIC_JOIN_END:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{joinEnd:e.metric})});case DO.KEY_METRIC_REQUEST_AP_START:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{requestAPStart:e.metric})});case DO.KEY_METRIC_REQUEST_AP_END:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{requestAPEnd:e.metric})});case DO.KEY_METRIC_JOIN_GATEWAY_START:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{joinGatewayStart:e.metric})});case DO.KEY_METRIC_JOIN_GATEWAY_END:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{joinGatewayEnd:e.metric})});case DO.KEY_METRIC_PEER_CONNECTION_START:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{peerConnectionStart:e.metric})});case DO.KEY_METRIC_PEER_CONNECTION_END:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{peerConnectionEnd:e.metric})});case DO.KEY_METRIC_DESCRIPTION_START:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{descriptionStart:e.metric})});case DO.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{signalChannelOpen:e.metric})});case DO.KEY_METRIC_ICE_CONNECTION_END:return PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{iceConnectionEnd:e.metric})});case DO.KEY_METRIC_PUBLISH:{const i=t.keyMetrics.publish,n=i.findIndex((t=>t.trackId===e.metric.trackId));return-1!==n?(i[n]=PO(PO({},i[n]),e.metric),PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{publish:[...i]})})):PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{publish:[...t.keyMetrics.publish,e.metric]})})}case DO.KEY_METRIC_SUBSCRIBE:{const i=t.keyMetrics.subscribe,n=i.findIndex((t=>t.userId===e.metric.userId&&t.type===e.metric.type));return-1!==n?(i[n]=PO(PO({},i[n]),e.metric),PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{subscribe:[...i]})})):PO(PO({},t),{},{keyMetrics:PO(PO({},t.keyMetrics),{},{subscribe:[...t.keyMetrics.subscribe,e.metric]})})}case DO.SET_CLOUD_PROXY_SERVER_MODE:return t.cloudProxyServerMode=e.mode,t;case DO.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof e.index?t.joinChannelServiceRecords=[...t.joinChannelServiceRecords,e.record]:(t.joinChannelServiceRecords[e.index]=PO(PO({},t.joinChannelServiceRecords[e.index]),e.record),t.joinChannelServiceRecords=[...t.joinChannelServiceRecords]),t;case DO.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return t.joinChannelServiceRecords=[],t;case DO.RESET_KEY_METRICS:return t.keyMetrics={publish:[],subscribe:[]},t;case DO.SET_USE_DATACHANNEL:return PO(PO({},t),{},{useDataChannel:e.val});default:return t}}(this.state,t)}set sessionId(t){this.dispatch({type:DO.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}get codec(){return this.state.codec}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:DO.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:DO.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:DO.SET_UID,uid:t})}get uid(){return this.state.uid}set pubId(t){this.dispatch({type:DO.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:DO.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(t){this.dispatch({type:DO.SET_USE_DATACHANNEL,val:t})}get useDataChannel(){return this.state.useDataChannel}clientCreated(){this.dispatch({type:DO.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:DO.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:DO.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:DO.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:DO.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:DO.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:DO.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:DO.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:DO.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:DO.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:DO.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:DO.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,e,i,n){this.dispatch({type:DO.KEY_METRIC_PUBLISH,metric:PO(PO({trackId:t,type:e},i&&{publishStart:i}),n&&{publishEnd:n})})}subscribe(t,e,i,n,s,o,r){this.dispatch({type:DO.KEY_METRIC_SUBSCRIBE,metric:PO(PO(PO(PO(PO({userId:t,type:e},i&&{subscribeStart:i}),n&&{subscribeEnd:n}),s&&{firstFrame:s}),o&&{streamAdded:o}),r&&{firstDecoded:r})})}massSubscribe(t,e,i,n){t.forEach((t=>{this.dispatch({type:DO.KEY_METRIC_SUBSCRIBE,metric:PO(PO(PO({userId:t.userId,type:t.type},e&&{subscribeStart:e}),i&&{subscribeEnd:i}),n&&{firstFrame:n})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,e){"gateway"===t.service&&Array.isArray(t.urls)&&(t.urls=t.urls.map((t=>t.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return"number"!=typeof e?(this.dispatch({type:DO.RECORD_JOIN_CHANNEL_SERVICE,record:PO(PO({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(e<0||e>=this.state.joinChannelServiceRecords.length||this.dispatch({type:DO.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:e}),e)}catch(t){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:DO.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:DO.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(t){return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:DO.AVOID_JOIN_START,avoidJoinStart:t})}}let xO;const UO=()=>"HTTPS"===(xO||xO||(xO=(window.location.protocol.split(":")[0]||"").toUpperCase(),xO)),VO=()=>void 0!==window.isSecureContext;function BO(t){let e=JO();return function(t,e){let i=t.appId;void 0!==i&&(dN(e,10),nN(e,i));let n=t.cid;void 0!==n&&(dN(e,16),dN(e,n));let s=t.cname;void 0!==s&&(dN(e,26),nN(e,s));let o=t.deviceId;void 0!==o&&(dN(e,34),nN(e,o));let r=t.elapse;void 0!==r&&(dN(e,40),hN(e,r));let a=t.fileSize;void 0!==a&&(dN(e,48),hN(e,qO(a)));let c=t.height;void 0!==c&&(dN(e,56),hN(e,qO(c)));let l=t.jpg;void 0!==l&&(dN(e,66),dN(e,l.length),function(t,e){let i=tN(t,e.length);t.bytes.set(e,i)}(e,l));let d=t.networkType;void 0!==d&&(dN(e,72),hN(e,qO(d)));let h=t.osType;void 0!==h&&(dN(e,80),hN(e,qO(h)));let u=t.requestId;void 0!==u&&(dN(e,90),nN(e,u));let p=t.sdkVersion;void 0!==p&&(dN(e,98),nN(e,p));let m=t.sequence;void 0!==m&&(dN(e,104),hN(e,qO(m)));let v=t.sid;void 0!==v&&(dN(e,114),nN(e,v));let g=t.timestamp;void 0!==g&&(dN(e,120),hN(e,g));let f=t.uid;void 0!==f&&(dN(e,128),dN(e,f));let E=t.vid;void 0!==E&&(dN(e,136),dN(e,E));let _=t.width;void 0!==_&&(dN(e,144),hN(e,qO(_)));let S=t.service;void 0!==S&&(dN(e,152),dN(e,S));let b=t.callbackData;void 0!==b&&(dN(e,162),nN(e,b));let T=t.jpgEncryption;void 0!==T&&(dN(e,168),dN(e,T));let y=t.requestType;void 0!==y&&(dN(e,176),dN(e,y));let w=t.scorePorn;void 0!==w&&(dN(e,185),cN(e,w));let C=t.scoreSexy;void 0!==C&&(dN(e,193),cN(e,C));let R=t.scoreNeutral;void 0!==R&&(dN(e,201),cN(e,R));let I=t.scene;void 0!==I&&(dN(e,208),dN(e,I));let A=t.ossFilePrefix;void 0!==A&&(dN(e,218),nN(e,A));let O=t.serviceVendor;if(void 0!==O)for(let t of O){dN(e,226);let i=JO();HO(t,i),dN(e,i.limit),sN(e,i),XO(i)}}(t,e),function(t){let e=t.bytes,i=t.limit;return e.length===i?e:e.subarray(0,i)}(e)}function jO(t){return function(t){let e={};t:for(;!ZO(t);){let i=lN(t);switch(i>>>3){case 0:break t;case 1:e.code=lN(t);break;case 2:e.msg=iN(t,lN(t));break;case 3:{let i=GO(t);e.data=FO(t),t.limit=i;break}default:$O(t,7&i)}}return e}({bytes:e=t,offset:0,limit:e.length});var e}function FO(t){let e={};t:for(;!ZO(t);){let i=lN(t);switch(i>>>3){case 0:break t;case 1:e.requestId=iN(t,lN(t));break;case 2:e.requestType=lN(t)>>>0;break;case 3:e.scorePorn=aN(t);break;case 4:e.scoreSexy=aN(t);break;case 5:e.scoreNeutral=aN(t);break;case 6:e.requestScene=lN(t)>>>0;break;case 7:e.scene=lN(t)>>>0;break;default:$O(t,7&i)}}return e}function HO(t,e){let i=t.service;void 0!==i&&(dN(e,8),dN(e,i));let n=t.vendor;void 0!==n&&(dN(e,16),dN(e,n));let s=t.token;void 0!==s&&(dN(e,26),nN(e,s));let o=t.callbackUrl;void 0!==o&&(dN(e,34),nN(e,o))}function GO(t){let e=lN(t),i=t.limit;return t.limit=t.offset+e,i}function $O(t,e){switch(e){case 0:for(;128&oN(t););break;case 2:QO(t,lN(t));break;case 5:QO(t,4);break;case 1:QO(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let WO=new Float32Array(1);new Uint8Array(WO.buffer);let zO=new Float64Array(1),KO=new Uint8Array(zO.buffer);function qO(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let YO=[];function JO(){const t=YO.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function XO(t){YO.push(t)}function QO(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function ZO(t){return t.offset>=t.limit}function tN(t,e){let i=t.bytes,n=t.offset,s=t.limit,o=n+e;if(o>i.length){let e=new Uint8Array(2*o);e.set(i),t.bytes=e}return t.offset=o,o>s&&(t.limit=o),n}function eN(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function iN(t,e){let i=eN(t,e),n=String.fromCharCode,s=t.bytes,o="�",r="";for(let t=0;t<e;t++){let a,c,l,d,h=s[t+i];0==(128&h)?r+=n(h):192==(224&h)?t+1>=e?r+=o:(a=s[t+i+1],128!=(192&a)?r+=o:(d=(31&h)<<6|63&a,d<128?r+=o:(r+=n(d),t++))):224==(240&h)?t+2>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],32896!=(49344&(a|c<<8))?r+=o:(d=(15&h)<<12|(63&a)<<6|63&c,d<2048||d>=55296&&d<=57343?r+=o:(r+=n(d),t+=2))):240==(248&h)?t+3>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],l=s[t+i+3],8421504!=(12632256&(a|c<<8|l<<16))?r+=o:(d=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&l,d<65536||d>1114111?r+=o:(d-=65536,r+=n(55296+(d>>10),56320+(1023&d)),t+=3))):r+=o}return r}function nN(t,e){let i=e.length,n=0;for(let t=0;t<i;t++){let s=e.charCodeAt(t);s>=55296&&s<=56319&&t+1<i&&(s=(s<<10)+e.charCodeAt(++t)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}dN(t,n);let s=tN(t,n),o=t.bytes;for(let t=0;t<i;t++){let n=e.charCodeAt(t);n>=55296&&n<=56319&&t+1<i&&(n=(n<<10)+e.charCodeAt(++t)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function sN(t,e){let i=tN(t,e.limit),n=t.bytes,s=e.bytes;for(let t=0,o=e.limit;t<o;t++)n[t+i]=s[t]}function oN(t){return t.bytes[eN(t,1)]}function rN(t,e){let i=tN(t,1);t.bytes[i]=e}function aN(t){let e=eN(t,8),i=t.bytes;return KO[0]=i[e++],KO[1]=i[e++],KO[2]=i[e++],KO[3]=i[e++],KO[4]=i[e++],KO[5]=i[e++],KO[6]=i[e++],KO[7]=i[e++],zO[0]}function cN(t,e){let i=tN(t,8),n=t.bytes;zO[0]=e,n[i++]=KO[0],n[i++]=KO[1],n[i++]=KO[2],n[i++]=KO[3],n[i++]=KO[4],n[i++]=KO[5],n[i++]=KO[6],n[i++]=KO[7]}function lN(t){let e,i=0,n=0;do{e=oN(t),i<32&&(n|=(127&e)<<i),i+=7}while(128&e);return n}function dN(t,e){for(e>>>=0;e>=128;)rN(t,127&e|128),e>>>=7;rN(t,e)}function hN(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,s=e.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=tN(t,o),a=t.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}const uN=async(t,e,i)=>{const n=function(t){const e=[];for(let i=0;i<t.length;i+=2)e.push(parseInt(t.slice(i,i+2),16));return Uint8Array.from(e)}(function(t){const e="0123456789abcdef";function i(t){let i,n="";for(i=0;i<=3;i++)n+=e.charAt(t>>8*i+4&15)+e.charAt(t>>8*i&15);return n}function n(t,e){const i=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(i>>16)<<16|65535&i}function s(t,e,i,s,o,r){return n(function(t,e){return t<<e|t>>>32-e}(n(n(e,t),n(s,r)),o),i)}function o(t,e,i,n,o,r,a){return s(e&i|~e&n,t,e,o,r,a)}function r(t,e,i,n,o,r,a){return s(e&n|i&~n,t,e,o,r,a)}function a(t,e,i,n,o,r,a){return s(e^i^n,t,e,o,r,a)}function c(t,e,i,n,o,r,a){return s(i^(e|~n),t,e,o,r,a)}const l=function(t){let e;const i=1+(t.length+8>>6),n=new Array(16*i);for(e=0;e<16*i;e++)n[e]=0;for(e=0;e<t.length;e++)n[e>>2]|=t.charCodeAt(e)<<e%4*8;return n[e>>2]|=128<<e%4*8,n[16*i-2]=8*t.length,n}(t);let d,h,u,p,m,v=1732584193,g=-271733879,f=-1732584194,E=271733878;for(d=0;d<l.length;d+=16)h=v,u=g,p=f,m=E,v=o(v,g,f,E,l[d+0],7,-680876936),E=o(E,v,g,f,l[d+1],12,-389564586),f=o(f,E,v,g,l[d+2],17,606105819),g=o(g,f,E,v,l[d+3],22,-1044525330),v=o(v,g,f,E,l[d+4],7,-176418897),E=o(E,v,g,f,l[d+5],12,1200080426),f=o(f,E,v,g,l[d+6],17,-1473231341),g=o(g,f,E,v,l[d+7],22,-45705983),v=o(v,g,f,E,l[d+8],7,1770035416),E=o(E,v,g,f,l[d+9],12,-1958414417),f=o(f,E,v,g,l[d+10],17,-42063),g=o(g,f,E,v,l[d+11],22,-1990404162),v=o(v,g,f,E,l[d+12],7,1804603682),E=o(E,v,g,f,l[d+13],12,-40341101),f=o(f,E,v,g,l[d+14],17,-1502002290),g=o(g,f,E,v,l[d+15],22,1236535329),v=r(v,g,f,E,l[d+1],5,-165796510),E=r(E,v,g,f,l[d+6],9,-1069501632),f=r(f,E,v,g,l[d+11],14,643717713),g=r(g,f,E,v,l[d+0],20,-373897302),v=r(v,g,f,E,l[d+5],5,-701558691),E=r(E,v,g,f,l[d+10],9,38016083),f=r(f,E,v,g,l[d+15],14,-660478335),g=r(g,f,E,v,l[d+4],20,-405537848),v=r(v,g,f,E,l[d+9],5,568446438),E=r(E,v,g,f,l[d+14],9,-1019803690),f=r(f,E,v,g,l[d+3],14,-187363961),g=r(g,f,E,v,l[d+8],20,1163531501),v=r(v,g,f,E,l[d+13],5,-1444681467),E=r(E,v,g,f,l[d+2],9,-51403784),f=r(f,E,v,g,l[d+7],14,1735328473),g=r(g,f,E,v,l[d+12],20,-1926607734),v=a(v,g,f,E,l[d+5],4,-378558),E=a(E,v,g,f,l[d+8],11,-2022574463),f=a(f,E,v,g,l[d+11],16,1839030562),g=a(g,f,E,v,l[d+14],23,-35309556),v=a(v,g,f,E,l[d+1],4,-1530992060),E=a(E,v,g,f,l[d+4],11,1272893353),f=a(f,E,v,g,l[d+7],16,-155497632),g=a(g,f,E,v,l[d+10],23,-1094730640),v=a(v,g,f,E,l[d+13],4,681279174),E=a(E,v,g,f,l[d+0],11,-358537222),f=a(f,E,v,g,l[d+3],16,-722521979),g=a(g,f,E,v,l[d+6],23,76029189),v=a(v,g,f,E,l[d+9],4,-640364487),E=a(E,v,g,f,l[d+12],11,-421815835),f=a(f,E,v,g,l[d+15],16,530742520),g=a(g,f,E,v,l[d+2],23,-995338651),v=c(v,g,f,E,l[d+0],6,-198630844),E=c(E,v,g,f,l[d+7],10,1126891415),f=c(f,E,v,g,l[d+14],15,-1416354905),g=c(g,f,E,v,l[d+5],21,-57434055),v=c(v,g,f,E,l[d+12],6,1700485571),E=c(E,v,g,f,l[d+3],10,-1894986606),f=c(f,E,v,g,l[d+10],15,-1051523),g=c(g,f,E,v,l[d+1],21,-2054922799),v=c(v,g,f,E,l[d+8],6,1873313359),E=c(E,v,g,f,l[d+15],10,-30611744),f=c(f,E,v,g,l[d+6],15,-1560198380),g=c(g,f,E,v,l[d+13],21,1309151649),v=c(v,g,f,E,l[d+4],6,-145523070),E=c(E,v,g,f,l[d+11],10,-1120210379),f=c(f,E,v,g,l[d+2],15,718787259),g=c(g,f,E,v,l[d+9],21,-343485551),v=n(v,h),g=n(g,u),f=n(f,p),E=n(E,m);return i(v)+i(g)+i(f)+i(E)}(""+e+i)).slice(0,16),s=n.slice(0,12),o=await window.crypto.subtle.importKey("raw",n,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},o,t))},pN=async(t,e,i)=>await uN(t.buffer,e,i);function mN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}const vN=new Map([["moderation",1],["supervise",2]]);class gN extends gv{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(BE.CONNECTION_STATE_CHANGE,e,t)}get inspectType(){return this._inspectType}set inspectType(t){var e;this._inspectMode=Xi(e=t.map((t=>vN.get(t)||0))).call(e,((t,e)=>t+e)),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(t){super(),vp(this,"name","AgoraRTCVideoContentInspect"),vp(this,"_connectionState",UE.CONNECTING),vp(this,"_innerConnectionState",void 0),vp(this,"sequence",0),vp(this,"inspectStartTime",void 0),vp(this,"workerManagerConnection",void 0),vp(this,"workerConnection",void 0),vp(this,"workerMessageLengthLimit",void 0),vp(this,"inspectIntervalMinimum",void 0),vp(this,"qualityRatio",void 0),vp(this,"_connectInfo",void 0),vp(this,"_cancelTokenSource",mv.CancelToken.source()),vp(this,"_retryConfig",void 0),vp(this,"wmSequence",0),vp(this,"inspectInterval",void 0),vp(this,"inspectTimer",null),vp(this,"ossFilePrefix",void 0),vp(this,"extraInfo",void 0),vp(this,"_inspectType",void 0),vp(this,"_inspectMode",void 0),vp(this,"_quality",1),vp(this,"qualityTimer",null),vp(this,"_inspectId",void 0),vp(this,"_needWorkUrlOnly",!1),vp(this,"inspectImage",(()=>{if(this.connectionState!==UE.CONNECTED)throw new _v(Ev.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===UE.CONNECTED?this.requestToInspectImage():Av.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=ZT(5,"inspect-"),this.workerMessageLengthLimit=Gv("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=Gv("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=Gv("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Cy("worker-manager-"+this._inspectId,Sv),this.on(BE.STATE_CHANGE,((t,e)=>{this._innerConnectionState=t,Av.debug("[".concat(this._inspectId,"] Inspect operation :").concat(VE[t]," ").concat(e||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new Cy("worker-"+this._inspectId,Sv),this.handleWorkerEvents()}async init(t,e){this.emit(BE.STATE_CHANGE,VE.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=e,new _h(((n,s)=>{this.on(BE.CONNECTION_STATE_CHANGE,((t,e)=>{e===UE.CONNECTED&&n()})),this.requestAP(t,i,e).then((t=>{this.connectWorkerManager(t)})).catch((t=>{s(t)}))}))}async requestAP(t,e,i){const n=Gv("WEBCS_DOMAIN").map((t=>"https://".concat(t,"/api/v1"))),s=await function(t,e,i,n){let{appId:s,areaCode:o,cname:r,sid:a,token:c,uid:l}=e;aw++;const d="image_moderation_api",h={service_name:d,json_body:JSON.stringify({appId:s,areaCode:o,cname:r,command:"allocateEdge",requestId:aw,seq:aw,sid:a,token:c,ts:Date.now(),uid:l+""})};let u,p,m=t[0];return Tv((async()=>{u=Date.now();const t=await bS(m,{data:h,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-u,0!==t.code){const e=new _v(Ev.UNEXPECTED_RESPONSE,"image inspect ap error, code"+t.code,{retry:!0,responseTime:p});throw Av.error(e.toString()),e}const e=JSON.parse(t.json_body);if(200!==e.code){const t=new _v(Ev.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(e.code,", reason: ").concat(e.reason),{code:e.code,responseTime:p});throw Av.error(t.toString()),t}if(!e.servers||!Array.isArray(e.servers)||0===e.servers.length){const t=new _v(Ev.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:e.code,responseTime:p});throw Av.error(t.toString()),t}const n=Gv("VIDEO_INSPECT_WORKER_MANAGER_HOST"),s=Gv("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:e.servers.map((t=>{let{address:e,wss:i}=t;if(e&&i)return"wss://".concat(e.replace(/\./g,"-"),".").concat(n,":").concat(s||i)})).filter((t=>!!t)),workerToken:e.workerToken,vid:e.vid,responseTime:p}}),((e,i)=>(PS.apworkerEvent(a,{success:!0,sc:200,serviceName:d,responseDetail:JSON.stringify(e.addressList),firstSuccess:0===i,responseTime:p,serverIp:t[i%t.length]}),!1)),((e,i)=>(PS.apworkerEvent(a,{success:!1,sc:e.data&&e.data.code||200,serviceName:d,responseTime:p,serverIp:t[i%t.length]}),!!(e.code!==Ev.OPERATION_ABORTED&&e.code!==Ev.UNEXPECTED_RESPONSE||e.data&&e.data.retry)&&(m=t[(i+1)%t.length],!0))),n)}(n,t,e,i);this.emit(BE.STATE_CHANGE,VE.AP_CONNECTED);const{addressList:o}=s;return this.wmSequence++,o}async connectWorkerManager(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=e,this.emit(BE.STATE_CHANGE,VE.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Wf.CONNECTED,(async()=>{this.emit(BE.STATE_CHANGE,VE.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.18.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Wf.CLOSED,(()=>{this._innerConnectionState<VE.GET_WORKER_MANAGER_RESPONSE&&Av.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(Wf.FAILED,(()=>{this._innerConnectionState<VE.GET_WORKER_MANAGER_RESPONSE&&Av.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(Wf.RECONNECTING,(()=>{this._innerConnectionState<VE.GET_WORKER_MANAGER_RESPONSE&&Av.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(Wf.ON_MESSAGE,(async t=>{this.emit(BE.STATE_CHANGE,VE.GET_WORKER_MANAGER_RESPONSE);const e=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(t.data);if(200!==i.code)throw Av.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new _v(Ev.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&e))throw Av.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new _v(Ev.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const t=Gv("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,n=e.replace(/:\d+\/?$/,":".concat(t));this.emit(BE.STATE_CHANGE,VE.CONNECT_WORKER,n),this._needWorkUrlOnly?this.emit(BE.REQUEST_NEW_WORKER_URL,n):await this.connectWorker(n)}})),this.workerManagerConnection.on(Wf.WILL_RECONNECT,((t,e)=>{e(t)})),this.workerManagerConnection.on(Wf.REQUEST_NEW_URLS,((t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)}))}handleWorkerEvents(){this.workerConnection.on(Wf.CONNECTED,(async()=>{this.emit(BE.STATE_CHANGE,VE.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=UE.CONNECTED})),this.workerConnection.on(Wf.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const i=jO(new Uint8Array(t.data));if(Gv("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&Av.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),200===i.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(BE.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var e;const t={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},n=Xi(e=Object.keys(t)).call(e,((e,i)=>t[e]>t[i]?e:i),"porn"),s=Object.keys(t).find((t=>t===n));this.emit(BE.INSPECT_RESULT,s)}else this.emit(BE.INSPECT_RESULT,void 0,new _v(Ev.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(BE.INSPECT_RESULT,void 0,new _v(Ev.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else Av.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(BE.INSPECT_RESULT,void 0,new _v(Ev.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Wf.CLOSED,(()=>{this.connectionState=UE.CLOSED})),this.workerConnection.on(Wf.FAILED,(()=>{this.connectionState=UE.CLOSED})),this.workerConnection.on(Wf.RECONNECTING,(()=>{this.connectionState=this.connectionState===UE.CONNECTED?UE.RECONNECTING:UE.CONNECTING})),this.workerConnection.on(Wf.WILL_RECONNECT,((t,e)=>{"recover"===t&&e(t),e("tryNext")})),this.workerConnection.on(Wf.REQUEST_NEW_URLS,((t,e)=>{this.workerManagerConnection.close(),this.once(BE.REQUEST_NEW_WORKER_URL,(e=>{t([e])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((t=>{this.connectWorkerManager(t,!0)})).catch((t=>{e(t)}))}))}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){this.sequence++;const t=ry(this,BE.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(BE.INSPECT_RESULT,void 0,new _v(Ev.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(t,e);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(BE.INSPECT_RESULT,void 0,new _v(Ev.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,e){let{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a}=e;const c=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),d=await pN(l,i,n),h=this.sequence+"-"+s+"-"+a+"-"+c+"-"+ZT(12,""),u={appId:i,cid:s,cname:n,deviceId:"",elapse:gN.intToLong(Number(c-this.inspectStartTime)),fileSize:d.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:d,networkType:6,osType:7,requestId:h,sdkVersion:"4.18.2",sequence:this.sequence,sid:r,timestamp:gN.intToLong(c),uid:a,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete u.callbackData,void 0===this.ossFilePrefix&&delete u.ossFilePrefix;const p=BO(u);if(p.byteLength<this.workerMessageLengthLimit){if(Gv("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const t=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?mN(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):mN(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},u);delete t.jpg,Av.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(t))}return p}{const e=this.quality*this.qualityRatio;return this.quality=e,await this.generateRequestData(t,{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=mv.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=UE.CLOSED,this.emit(BE.STATE_CHANGE,VE.CLOSED)}}function fN(t){let e=function(){const t=bN.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(t,e){let i=t.appId;void 0!==i&&(LN(e,10),AN(e,i));let n=t.cid;void 0!==n&&(LN(e,16),LN(e,n));let s=t.cname;void 0!==s&&(LN(e,26),AN(e,s));let o=t.deviceId;void 0!==o&&(LN(e,34),AN(e,o));let r=t.elapse;void 0!==r&&(LN(e,40),DN(e,r));let a=t.fileSize;void 0!==a&&(LN(e,48),DN(e,SN(a)));let c=t.height;void 0!==c&&(LN(e,56),DN(e,SN(c)));let l=t.jpg;void 0!==l&&(LN(e,66),LN(e,l.length),RN(e,l));let d=t.networkType;void 0!==d&&(LN(e,72),DN(e,SN(d)));let h=t.osType;void 0!==h&&(LN(e,80),DN(e,SN(h)));let u=t.requestId;void 0!==u&&(LN(e,90),AN(e,u));let p=t.sdkVersion;void 0!==p&&(LN(e,98),AN(e,p));let m=t.sequence;void 0!==m&&(LN(e,104),DN(e,SN(m)));let v=t.sid;void 0!==v&&(LN(e,114),AN(e,v));let g=t.timestamp;void 0!==g&&(LN(e,120),DN(e,g));let f=t.uid;void 0!==f&&(LN(e,128),LN(e,f));let E=t.vid;void 0!==E&&(LN(e,136),LN(e,E));let _=t.width;void 0!==_&&(LN(e,144),DN(e,SN(_)));let S=t.service;void 0!==S&&(LN(e,152),LN(e,S));let b=t.callbackData;void 0!==b&&(LN(e,162),LN(e,b.length),RN(e,b));let T=t.ticket;void 0!==T&&(LN(e,170),AN(e,T))}(t,e),function(t){let e=t.bytes,i=t.limit;return e.length===i?e:e.subarray(0,i)}(e)}function EN(t){return function(t){let e={};t:for(;!yN(t);){let i=kN(t);switch(i>>>3){case 0:break t;case 1:e.code=kN(t);break;case 2:e.msg=IN(t,kN(t));break;case 3:e.requestId=IN(t,kN(t));break;case 4:e.timestamp=PN(t,!1);break;default:_N(t,7&i)}}return e}({bytes:e=t,offset:0,limit:e.length});var e}function _N(t,e){switch(e){case 0:for(;128&ON(t););break;case 2:TN(t,kN(t));break;case 5:TN(t,4);break;case 1:TN(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function SN(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let bN=[];function TN(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function yN(t){return t.offset>=t.limit}function wN(t,e){let i=t.bytes,n=t.offset,s=t.limit,o=n+e;if(o>i.length){let e=new Uint8Array(2*o);e.set(i),t.bytes=e}return t.offset=o,o>s&&(t.limit=o),n}function CN(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function RN(t,e){let i=wN(t,e.length);t.bytes.set(e,i)}function IN(t,e){let i=CN(t,e),n=String.fromCharCode,s=t.bytes,o="�",r="";for(let t=0;t<e;t++){let a,c,l,d,h=s[t+i];0==(128&h)?r+=n(h):192==(224&h)?t+1>=e?r+=o:(a=s[t+i+1],128!=(192&a)?r+=o:(d=(31&h)<<6|63&a,d<128?r+=o:(r+=n(d),t++))):224==(240&h)?t+2>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],32896!=(49344&(a|c<<8))?r+=o:(d=(15&h)<<12|(63&a)<<6|63&c,d<2048||d>=55296&&d<=57343?r+=o:(r+=n(d),t+=2))):240==(248&h)?t+3>=e?r+=o:(a=s[t+i+1],c=s[t+i+2],l=s[t+i+3],8421504!=(12632256&(a|c<<8|l<<16))?r+=o:(d=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&l,d<65536||d>1114111?r+=o:(d-=65536,r+=n(55296+(d>>10),56320+(1023&d)),t+=3))):r+=o}return r}function AN(t,e){let i=e.length,n=0;for(let t=0;t<i;t++){let s=e.charCodeAt(t);s>=55296&&s<=56319&&t+1<i&&(s=(s<<10)+e.charCodeAt(++t)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}LN(t,n);let s=wN(t,n),o=t.bytes;for(let t=0;t<i;t++){let n=e.charCodeAt(t);n>=55296&&n<=56319&&t+1<i&&(n=(n<<10)+e.charCodeAt(++t)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function ON(t){return t.bytes[CN(t,1)]}function NN(t,e){let i=wN(t,1);t.bytes[i]=e}function kN(t){let e,i=0,n=0;do{e=ON(t),i<32&&(n|=(127&e)<<i),i+=7}while(128&e);return n}function LN(t,e){for(e>>>=0;e>=128;)NN(t,127&e|128),e>>>=7;NN(t,e)}function PN(t,e){let i,n=0,s=0,o=0;return i=ON(t),n=127&i,128&i&&(i=ON(t),n|=(127&i)<<7,128&i&&(i=ON(t),n|=(127&i)<<14,128&i&&(i=ON(t),n|=(127&i)<<21,128&i&&(i=ON(t),s=127&i,128&i&&(i=ON(t),s|=(127&i)<<7,128&i&&(i=ON(t),s|=(127&i)<<14,128&i&&(i=ON(t),s|=(127&i)<<21,128&i&&(i=ON(t),o=127&i,128&i&&(i=ON(t),o|=(127&i)<<7))))))))),{low:n|s<<28,high:s>>>4|o<<24,unsigned:e}}function DN(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,s=e.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=wN(t,o),a=t.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}const MN={},xN={},UN=4294967296,VN=0x10000000000000000,BN=VN/2,jN=WN(0,!0),FN=WN(0),HN=zN(0,-2147483648,!1),GN=zN(-1,2147483647,!1),$N=zN(-1,-1,!0);function WN(t,e){let i,n,s;return e?(s=0<=(t>>>=0)&&t<256)&&(n=xN[t],n)?n:(i=zN(t,0,!0),s&&(xN[t]=i),i):(s=-128<=(t|=0)&&t<128)&&(n=MN[t],n)?n:(i=zN(t,t<0?-1:0,!1),s&&(MN[t]=i),i)}function zN(t,e,i){return{low:0|t,high:0|e,unsigned:!!i}}function KN(t,e){if(isNaN(t))return e?jN:FN;if(e){if(t<0)return jN;if(t>=VN)return $N}else{if(t<=-BN)return HN;if(t+1>=BN)return GN}return t<0?e?jN:FN:zN(t%UN|0,t/UN|0,e)}function qN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}class YN extends gv{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(WE.CONNECTION_STATE_CHANGE,t,e)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(t){var e;super(),vp(this,"name","AgoraRTCImageModeration"),vp(this,"_connectionState",$E.CONNECTING),vp(this,"_sequence",0),vp(this,"_moderationStartTime",void 0),vp(this,"_workerConnection",void 0),vp(this,"_workerMessageLengthLimit",void 0),vp(this,"_qualityRatio",void 0),vp(this,"_connectInfo",void 0),vp(this,"_cancelTokenSource",mv.CancelToken.source()),vp(this,"_retryConfig",void 0),vp(this,"_moderationInterval",void 0),vp(this,"_moderationTimer",null),vp(this,"_moderationMode",1),vp(this,"_quality",1),vp(this,"_qualityTimer",null),vp(this,"_ticket",void 0),vp(this,"_moderationIntervalMinimum",void 0),vp(this,"_uploadFailedNum",0),vp(this,"_uploadNum",0),vp(this,"_uploadTimer",null),vp(this,"_moderationId",void 0),vp(this,"inspectImage",(()=>{if(this.connectionState!==$E.CONNECTED)throw new _v(Ev.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===$E.CONNECTED?this.requestToInspectImage():Av.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=ZT(5,"image-moderation-"),this._workerMessageLengthLimit=Gv("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=Gv("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(e=t.interval)&&void 0!==e?e:1e3,this._qualityRatio=Gv("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Cy("worker-"+this._moderationId,Sv),this.on(WE.STATE_CHANGE,((t,e)=>{Av.debug("[".concat(this._moderationId,"] Moderation operation :").concat(zE[t]," ").concat(e||""))})),this.handleWorkerEvents()}async init(t,e){this.emit(WE.STATE_CHANGE,zE.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=e,new _h(((n,s)=>{this.on(WE.CONNECTION_STATE_CHANGE,((t,e)=>{t===$E.CONNECTED&&n()})),this.requestAP(t,i,e).then((t=>{this.connectWorker(t)})).catch((t=>{s(t)}))}))}updateConfig(t){var e;this._moderationInterval=null!==(e=t.interval)&&void 0!==e?e:1e3,Av.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===$E.CONNECTED&&this.inspectImage()}async requestAP(t,e,i){const n=Gv("WEBCS_DOMAIN").map((t=>"https://".concat(t,"/api/v1"))),s=await function(t,e,i,n){let{appId:s,areaCode:o,cname:r,sid:a,token:c,uid:l}=e;aw++;const d="moderation_plugin",h={service_name:d,json_body:JSON.stringify({appId:s,areaCode:o,cname:r,command:"allocateEdge",requestId:aw,seq:aw,sid:a,appToken:c,ts:Date.now(),uid:l+""})};let u,p,m=t[0];return Tv((async()=>{u=Date.now();const t=await bS(m,{data:h,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-u,0!==t.code){const e=new _v(Ev.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+t.code,{retry:!0,responseTime:p});throw Av.error(e.toString()),e}const e=JSON.parse(t.json_body);if(200!==e.code){const t=new _v(Ev.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(e.code,", reason: ").concat(e.reason),{code:e.code,responseTime:p});throw Av.error(t.toString()),t}if(!e.servers||!Array.isArray(e.servers)||0===e.servers.length){const t=new _v(Ev.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:e.code,responseTime:p});throw Av.error(t.toString()),t}if(!e.servers.some((t=>!!t.wss))){const t=new _v(Ev.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:e.code,responseTime:p});throw Av.error(t.toString()),t}const n=Gv("IMAGE_MODERATION_WORKER_HOST");return{addressList:e.servers.map((t=>{let{address:e,wss:i}=t;if(e&&i)return"wss://".concat(e.replace(/\./g,"-"),".").concat(n,":").concat(i,"/moderation")})).filter((t=>!!t)),workerToken:e.workerToken,vid:e.vid,ticket:e.appTicket,responseTime:p}}),((e,i)=>(PS.apworkerEvent(a,{success:!0,sc:200,serviceName:d,responseDetail:JSON.stringify(e.addressList),firstSuccess:0===i,responseTime:p,serverIp:t[i%t.length]}),!1)),((e,i)=>(PS.apworkerEvent(a,{success:!1,sc:e.data&&e.data.code||200,serviceName:d,responseTime:p,serverIp:t[i%t.length]}),!!(e.code!==Ev.OPERATION_ABORTED&&e.code!==Ev.UNEXPECTED_RESPONSE||e.data&&e.data.retry)&&(m=t[(i+1)%t.length],!0))),n)}(n,t,e,i);this.emit(WE.STATE_CHANGE,zE.AP_CONNECTED);const{addressList:o,ticket:r}=s;return this._ticket=r,o}async connectWorker(t){this.emit(WE.STATE_CHANGE,zE.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(Wf.CONNECTED,(async()=>{this.emit(WE.STATE_CHANGE,zE.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=$E.CONNECTED})),this._workerConnection.on(Wf.CLOSED,(()=>{this.connectionState=$E.CLOSED})),this._workerConnection.on(Wf.FAILED,(()=>{this.connectionState=$E.CLOSED})),this._workerConnection.on(Wf.RECONNECTING,(()=>{this.connectionState=this.connectionState===$E.CONNECTED?$E.RECONNECTING:$E.CONNECTING})),this._workerConnection.on(Wf.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const e=EN(new Uint8Array(t.data));Gv("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Av.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(e)),this._uploadNum++,void 0===e.code||0===e.code||(this._uploadFailedNum++,Av.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(e.code,", msg is ").concat(e.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{PS.reportApiInvoke(this._connectInfo.sid||null,{name:vf.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,e.code],tag:gf.TRACER}).onError(new _v(Ev.IMAGE_MODERATION_UPLOAD_FAILED,e.msg)),this._uploadTimer=null}),Gv("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else Av.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Wf.WILL_RECONNECT,((t,e)=>{"recover"===t&&e(t),e("tryNext")})),this._workerConnection.on(Wf.REQUEST_NEW_URLS,((t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)}))}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=ry(this,WE.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(Gv("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Av.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(t,e);this._workerConnection.sendMessage(i,!0,!0)}else Gv("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Av.debug("Only the track being published can be inspected")}async generateRequestData(t,e){let{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a}=e;const c=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),d=await pN(l,i,n),h=this._sequence+"-"+s+"-"+a+"-"+c+"-"+ZT(12,""),u={appId:i,cid:s,cname:n,deviceId:"",elapse:YN.intToLong(Number(c-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:d,networkType:6,osType:7,requestId:h,sdkVersion:"4.18.2",sequence:this._sequence,sid:r,timestamp:KN(c),uid:a,vid:o,service:this._moderationMode,ticket:this._ticket},p=fN(u);if(p.byteLength<this._workerMessageLengthLimit){if(Gv("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const t=function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?qN(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):qN(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}({},u);delete t.jpg,Av.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(t))}return p}{const e=this.quality*this._qualityRatio;return this.quality=e,await this.generateRequestData(t,{appId:i,cname:n,cid:s,vid:o,sid:r,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=mv.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=$E.CLOSED,this.emit(WE.STATE_CHANGE,zE.CLOSED)}}var JN,XN,QN,ZN,tk,ek,ik,nk,sk,ok,rk,ak,ck,lk,dk,hk,uk,pk,mk,vk,gk,fk,Ek,_k,Sk,bk,Tk,yk,wk,Ck,Rk,Ik,Ak,Ok,Nk,kk,Lk,Pk,Dk,Mk;function xk(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Uk(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?xk(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):xk(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}let Vk=(JN=LS(),XN=LS({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),e.map((t=>t?Object(t).toString():"null")))}),QN=LS({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||(e=[e]),e.map((t=>t.getTrackId())))}),ZN=LS({argsMap:(t,e,i)=>[e.uid,i]}),tk=LS({argsMap:(t,e)=>e.map((t=>{let{user:e,mediaType:i}=t;return[null==e?void 0:e.uid,i]}))}),ek=LS({argsMap:(t,e,i)=>[e.uid,i]}),ik=LS({argsMap:(t,e)=>e.map((t=>{let{user:e,mediaType:i}=t;return{uid:null==e?void 0:e.uid,mediaType:i}}))}),nk=LS(),sk=LS(),ok=LS(),rk=LS(),ak=LS(),ck=LS(),lk=LS(),dk=LS(),hk=LS(),uk=LS(),pk=LS(),mk=LS(),vk=LS(),gk=LS(),fk=LS({argsMap:(t,e)=>[e]}),Ek=LS(),_k=LS(),Sk=LS(),bk=LS(),Tk=LS(),yk=LS(),wk=LS(),Ck=LS(),Rk=LS(),Ik=LS(),Ak=LS({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),Ok=LS(),Nk=LS(),kk=LS(),Lk=LS(),Pk=LS({reportResult:!0}),Dk=LS(),cS((Mk=class extends gv{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get mode(){return this._config.mode}get role(){var t;return(null===(t=this._config)||void 0===t?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let e;if(super(),vp(this,"store",void 0),vp(this,"_uid",void 0),vp(this,"_channelName",void 0),vp(this,"_uintUid",void 0),vp(this,"_users",[]),vp(this,"_config",void 0),vp(this,"_clientId",void 0),vp(this,"_appId",void 0),vp(this,"_sessionId",null),vp(this,"_key",void 0),vp(this,"_joinInfo",void 0),vp(this,"_gateway",void 0),vp(this,"_statsCollector",void 0),vp(this,"_configDistribute",void 0),vp(this,"_leaveMutex",new US("client-leave")),vp(this,"_publishMutex",new US("client-publish")),vp(this,"_renewTokenMutex",new US("client-renewtoken")),vp(this,"_subscribeMutex",new US("client-subscribe")),vp(this,"_encryptionMode","none"),vp(this,"_encryptionSecret",null),vp(this,"_encryptionSalt",null),vp(this,"_proxyServer",void 0),vp(this,"_turnServer",{servers:[],mode:"auto"}),vp(this,"_cloudProxyServerMode","disabled"),vp(this,"_isDualStreamEnabled",!1),vp(this,"_defaultStreamFallbackType",void 0),vp(this,"_lowStreamParameter",void 0),vp(this,"_streamFallbackTypeCacheMap",new Map),vp(this,"_remoteStreamTypeCacheMap",new Map),vp(this,"_axiosCancelSource",mv.CancelToken.source()),vp(this,"_audioVolumeIndicationInterval",void 0),vp(this,"_networkQualityInterval",void 0),vp(this,"_userOfflineTimeout",void 0),vp(this,"_streamRemovedTimeout",void 0),vp(this,"_injectStreamingClient",void 0),vp(this,"_liveTranscodeStreamingClient",void 0),vp(this,"_liveRawStreamingClient",void 0),vp(this,"_channelMediaRelayClient",void 0),vp(this,"_networkQualitySensitivity","normal"),vp(this,"_p2pChannel",void 0),vp(this,"_useLocalAccessPoint",!1),vp(this,"_setLocalAPVersion",void 0),vp(this,"_joinAndNotLeaveYet",!1),vp(this,"_numberOfJoinCount",0),vp(this,"_remoteDefaultVideoStreamType",void 0),vp(this,"_inspect",void 0),vp(this,"_moderation",void 0),vp(this,"_license",void 0),vp(this,"_handleLocalTrackEnable",((t,e,i)=>{this.publish(t,!1).then(e).catch(i)})),vp(this,"_handleLocalTrackDisable",((t,e,i)=>{this.unpublish(t).then(e).catch(i)})),vp(this,"_handleUserOnline",(t=>{if(Gv("BLOCK_LOCAL_CLIENT")&&Zv(t.uid,this.channelName))return void Av.debug("[".concat(t.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof t.uid&&Av.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const e=this._users.find((e=>e.uid===t.uid));if(e)e._trust_in_room_=!0;else{const e=new RC(t.uid,t.uint_id||t.uid);this._users.push(e),Av.debug("[".concat(this._clientId,"] user online"),t.uid),this.safeEmit(Rf.USER_JOINED,e)}})),vp(this,"_handleUserOffline",(t=>{if(Gv("BLOCK_LOCAL_CLIENT")&&Zv(t.uid,this.channelName))return;const e=this._users.find((e=>e.uid===t.uid));e&&(this._handleRemoveStream(t),cy(this._users,e),this._remoteStreamTypeCacheMap.delete(e.uid),this._streamFallbackTypeCacheMap.delete(e.uid),Av.debug("[".concat(this._clientId,"] user offline"),t.uid,"reason:",t.reason),this.safeEmit(Rf.USER_LEAVED,e,t.reason))})),vp(this,"_handleAddAudioOrVideoStream",((t,e,i,n,s,o,r)=>{if(Gv("BLOCK_LOCAL_CLIENT")&&Zv(e,this.channelName))return;const a=this._users.find((t=>t.uid===e));if(!a)return void Av.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));Av.debug("[".concat(this._clientId,"] stream added with uid ").concat(e,", type ").concat(t)),this.store.subscribe(a.uid,t,void 0,void 0,void 0,Date.now());const c="audio"===t?a.hasAudio:a.hasVideo;a._uintid||(a._uintid=s||e),"audio"===t?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,"audio"===t?(a._audio_added_=!0,void 0!==i&&(a._audioSSRC=i),void 0!==n&&(a._cname=n),o&&(a._audioOrtc=o)):(a._video_added_=!0,void 0!==i&&(a._videoSSRC=i),void 0!==n&&(a._cname=n),void 0!==r&&(a._rtxSsrcId=r),o&&(a._videoOrtc=o)),("audio"===t?a.hasAudio:a.hasVideo)&&!c&&(Av.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(t)),this.safeEmit(Rf.USER_PUBLISHED,a,t)),"video"===t?PS.onGatewayStream(this._sessionId,hf.ON_ADD_VIDEO_STREAM,uf.ON_ADD_VIDEO_STREAM,{peer:s||e}):PS.onGatewayStream(this._sessionId,hf.ON_ADD_AUDIO_STREAM,uf.ON_ADD_AUDIO_STREAM,{peer:s||e}),this._p2pChannel.remoteMediaSsrcChanged(a,t,i).then((e=>{if(e)return Av.debug("[".concat(this._clientId,"] resubscribe ").concat(t," for user ").concat(a.uid," after rejoin because SSRC id changed.")),this._p2pChannel.unsubscribe(a,t,!0).then((()=>this._subscribe(a,t,!0).catch((t=>{Av.error("[".concat(this._clientId,"] resubscribe error"),t.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(a,t)&&(Av.debug("[".concat(this._clientId,"] resubscribe ").concat(t," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,t,!0).catch((t=>{Av.error("[".concat(this._clientId,"] resubscribe error"),t.toString())})))})),vp(this,"_handleRemoveStream",(t=>{if(Gv("BLOCK_LOCAL_CLIENT")&&Zv(t.uid,this.channelName))return;const e=this._users.find((e=>e.uid===t.uid));if(!e)return void Av.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));Av.debug("[".concat(this._clientId,"] stream removed with uid ").concat(t.uid));let i=()=>{};e.hasAudio&&e.hasVideo?i=()=>{Av.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished audio track")),this.safeEmit(Rf.USER_UNPUBLISHED,e,"audio"),Av.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished video track")),this.safeEmit(Rf.USER_UNPUBLISHED,e,"video")}:e.hasVideo?i=()=>{Av.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished video track")),this.safeEmit(Rf.USER_UNPUBLISHED,e,"video")}:e.hasAudio&&(i=()=>{Av.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished audio track")),this.safeEmit(Rf.USER_UNPUBLISHED,e,"audio")}),e._trust_audio_stream_added_state_=!0,e._trust_video_stream_added_state_=!0,e._audio_added_=!1,e._video_added_=!1,this._p2pChannel.unsubscribe(e).then((t=>{if(t)return this._gateway.unsubscribe(t,e.uid)})),e._audioSSRC=void 0,e._videoSSRC=void 0,e._audioOrtc=void 0,e._videoOrtc=void 0,e._rtxSsrcId=void 0,PS.onGatewayStream(this._sessionId,hf.ON_REMOVE_STREAM,uf.ON_REMOVE_STREAM,{peer:t.uint_id||t.uid}),i()})),vp(this,"_handleSetStreamLocalEnable",((t,e,i)=>{if(Gv("BLOCK_LOCAL_CLIENT")&&Zv(e,this.channelName))return;const n=this._users.find((t=>t.uid===e));if(!n)return void Av.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));Av.debug("[".concat(this._clientId,"] local ").concat(t," ").concat(i?"enabled":"disabled"," with uid ").concat(e));const s="audio"===t?n.hasAudio:n.hasVideo;if("audio"===t){n._trust_audio_enabled_state_=!0;const t=n._audio_enabled_;if(n._audio_enabled_=i,n._audio_enabled_===t)return;{const t=n._audio_enabled_?"enable-local-audio":"disable-local-audio";Av.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(Rf.USER_INFO_UPDATED,e,t)}}else{n._trust_video_enabled_state_=!0;const t=n._video_enabled_;if(n._video_enabled_=i,n._video_enabled_===t)return;{const t=n._video_enabled_?"enable-local-video":"disable-local-video";Av.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(Rf.USER_INFO_UPDATED,e,t)}}const o="audio"===t?n.hasAudio:n.hasVideo;return s!==o?!s&&o?(Av.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(t)),void this.safeEmit(Rf.USER_PUBLISHED,n,t)):("video"===t&&n._videoTrack&&n._videoTrack._destroy(),"audio"===t&&n._audioTrack,this._p2pChannel.muteRemote(n,t),Av.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(t)),void this.safeEmit(Rf.USER_UNPUBLISHED,n,t)):void 0})),vp(this,"_handleMuteStream",((t,e,i)=>{if(Gv("BLOCK_LOCAL_CLIENT")&&Zv(t,this.channelName))return;Av.debug("[".concat(this._clientId,"] receive mute message"),t,e,i);const n=this._users.find((e=>e.uid===t));if(!n)return void Av.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(t));const s="audio"===e?n.hasAudio:n.hasVideo;if("audio"===e){n._trust_audio_mute_state_=!0;const e=n._audio_muted_;if(n._audio_muted_=i,n._audio_muted_===e)return;{const e=n._audio_muted_?"mute-audio":"unmute-audio";Av.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(Rf.USER_INFO_UPDATED,t,e)}}else{n._trust_video_mute_state_=!0;const e=n._video_muted_;if(n._video_muted_=i,n._video_muted_===e)return;{const e=n._video_muted_?"mute-video":"unmute-video";Av.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(Rf.USER_INFO_UPDATED,t,e)}}const o="audio"===e?n.hasAudio:n.hasVideo;if(s!==o){if(!s&&o)return("audio"===e?n._audioSSRC:n._videoSSRC)?(Av.info("[".concat(this._clientId,"] remote user ").concat(t," published ").concat(e)),void this.safeEmit(Rf.USER_PUBLISHED,n,e)):void Av.warning("[".concat(this._clientId,"] remote user ").concat(t," receive ").concat(e," unmute message  before add stream message, ").concat(e," SSRC doesn't exist yet."));"video"===e&&n._videoTrack&&n._videoTrack._destroy(),"audio"===e&&n._audioTrack,this._p2pChannel.muteRemote(n,e),Av.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished ").concat(e)),this.safeEmit(Rf.USER_UNPUBLISHED,n,e)}})),vp(this,"_handleP2PLost",(async t=>{Av.debug("[".concat(this._clientId,"] receive p2p lost"),t),parseInt(t.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():Av.warning("[".concat(this._clientId,"] P2PLost stream not found"),t)})),vp(this,"_handleTokenWillExpire",(()=>{Av.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Rf.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),vp(this,"_handleBeforeUnload",(t=>{"beforeunload"===t.type&&void 0!==t.returnValue&&""!==t.returnValue||(this.leave(),Av.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),vp(this,"_handleUpdateNetworkQuality",(()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(Rf.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const t={downlinkNetworkQuality:0,uplinkNetworkQuality:0};t.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),t.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Rf.NETWORK_QUALITY,t)})),this._config=t,this._clientId=ZT(5,"client-"),this.store=new MO(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),Av.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Nv," build: ").concat(Ov,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Bf(t.clientRoleOptions),e=Object.assign({},t.clientRoleOptions)}catch(t){Av.warning("[".concat(this._clientId,"] ").concat(t.toString()))}this._statsCollector=new MT(this.store),this._statsCollector.onStatsException=(t,e,i)=>{Av.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(t,", msg: ").concat(e,", uid: ").concat(i)),this.safeEmit(Rf.EXCEPTION,{code:t,msg:e,uid:i})},this._statsCollector.onUploadPublishDuration=(t,e,i,n)=>{const s=this._users.find((e=>e.uid===t));s&&PS.peerPublishStatus(this._sessionId,{subscribeElapse:n,audioPublishDuration:e,videoPublishDuration:i,peer:s._uintid})},this.store.useDataChannel=YE().supportDataChannel&&Gv("SIGNAL_CHANNEL"),this._gateway=new By(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||Sv,httpRetryConfig:t.httpRetryConfig||Sv,forceWaitGatewayResponse:void 0===t.forceWaitGatewayResponse||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:e}),this._configDistribute=new Ew,this._p2pChannel=new NO(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async join(t,e,i,n,s){const o=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);const r=UO(),a=VO()?window.isSecureContext:"Browser Not Support";if(!VO()&&!r||!window.isSecureContext){const t="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";Av.warning(t)}const c=ty();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),Av.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const l=PS.reportApiInvoke(c,{name:vf.JOIN,options:[t,e,i,n],states:{isHttps:r,isSecureContext:a},tag:gf.TRACER});PS.setAppId(t);try{if(!i&&null!==i)throw new _v(Ev.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Jg(i,"token",1,2047),Jg(t,"appid",1,2047),Qg(e),n&&Zg(n),s&&Jg(s,"optionalInfo",1,2047)}catch(t){throw l.onError(t),t}if(Av.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._leaveMutex.isLocked&&(Av.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),Av.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const t=new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw l.onError(t),t}this._sessionId||(this._sessionId=c,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const d=Uk({clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:"string"!=typeof n?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:s,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(d.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof n&&(d.stringUid=n,this._uintUid?(d.uid=this._uintUid,this._uintUid=void 0):d.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(d.aesmode=this._encryptionMode,d.aespassword=await(async t=>{const e=my("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),i=await window.crypto.subtle.importKey("spki",e,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),n=IS(t),s=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},i,n);return vy(new Uint8Array(s))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(d.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:e,appId:t});const h=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&h===this._sessionId&&PS.joinChannelTimeout(this._sessionId,5)}),5e3);try{let n;const s=d.cloudProxyServer;if(["proxy3","proxy4","proxy5"].includes(s)){const t=Gv("PROXY_SERVER_TYPE3");Array.isArray(t)?d.proxyServer=t[0]:d.proxyServer=t}if(PS.setProxyServer(d.proxyServer),Av.setProxyServer(d.proxyServer),this.store.requestAPStart(),d.stringUid&&!d.uid){const t=await dw(d.stringUid,d,this._axiosCancelSource.token,this._config.httpRetryConfig||Sv,this.store);Av.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(d.stringUid," => ").concat(t)),d.uid=t,n=await lw(d,this._axiosCancelSource.token,this._config.httpRetryConfig||Sv,!0,this.store)}else n=await lw(d,this._axiosCancelSource.token,this._config.httpRetryConfig||Sv,!0,this.store);if(!this._joinAndNotLeaveYet)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(d,this._axiosCancelSource.token),this._configDistribute.on(CE.UPDATE_BITRATE_LIMIT,(t=>{this._p2pChannel.updateBitrateLimit(t)}))}),0),this._key=i||t;const o=n.gatewayInfo;this._joinInfo=Uk(Uk({},d),{},{cid:o.cid,uid:d.uid?d.uid:o.uid,vid:o.vid,apResponse:o.res,uni_lbs_ip:o.uni_lbs_ip,gatewayAddrs:o.gatewayAddrs});const r=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));l.onSuccess(r),this._appId=t,this._channelName=d.cname,this._uid=r,this.store.uid=r,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Wu()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const a=d.stringUid?"string uid: ".concat(d.stringUid,",uid: ").concat(d.uid):"uid: ".concat(this._uid);return Av.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(a)),setTimeout((()=>{Av.startUpload()}),5e3),this.store.joinEnd(),u=this,Xv.includes(u)||Xv.push(u),r}catch(t){const e=Array.isArray(t)?t[0]:t;throw e&&e.code===Ev.OPERATION_ABORTED?Av.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),e):Av.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),e),e.code!==Ev.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),l.onError(e),e}var u}_joinGateway(){if(!this._joinInfo||!this._key)throw new _v(Ev.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!Gv("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((t=>t)).catch((t=>{if(t.code===Ev.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,Cf.FALLBACK),t;if(t.code===Ev.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,Cf.FALLBACK),t;throw t})).then((t=>{if(t instanceof _v){if(t.code===Ev.INIT_WEBSOCKET_TIMEOUT){if(Av.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new _v(Ev.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const t=Gv("PROXY_SERVER_TYPE3");if(Array.isArray(t))if(this._joinInfo.apUrl){const e=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=e.slice(e.length-2).join(".");t.forEach((t=>{this._joinInfo&&t.includes(i)&&(this._joinInfo.proxyServer=t)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=t[0])}else this._joinInfo.proxyServer=t[0];else this._joinInfo.proxyServer=t;const e=Gv("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return e&&e[1]&&"443"!==e[1]&&Av.setProxyServer(this._joinInfo.proxyServer),"443"!==Gv("STATS_COLLECTOR_PORT").toString()&&PS.setProxyServer(this._joinInfo.proxyServer),PS.reportApiInvoke(this._sessionId,{name:vf.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:gf.TRACER}).onSuccess(),this.safeEmit(Rf.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),Gv("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((t=>{"forceturn"in t&&(t.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(Av.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new _v(Ev.INVALID_OPERATION);return PS.reportApiInvoke(this._sessionId,{name:vf.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:gf.TRACER}).onSuccess(),this._joinGateway()}return t})).then((t=>t))}async leave(){Av.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Wu()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(t){const e=Xv.indexOf(t);-1!==e&&Xv.splice(e,1)}(this);const t=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return Av.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave("CONNECTED"!==this.connectionState),Av.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(Array.isArray(t)||(t=[t]),0===t.length)throw new _v(Ev.INVALID_PARAMS,"track list is empty");if("audience"===this._gateway.role)throw new _v(Ev.INVALID_OPERATION,"audience can not publish stream");for(const i of t){if(!(i instanceof BS))throw new _v(Ev.INVALID_PARAMS,"parameter is not local track");if(!i._enabled&&e)throw new _v(Ev.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(i.getTrackId()))}Av.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(t.map((t=>"".concat(t.getTrackId()," ")))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&t.forEach((t=>{const e=this._configDistribute.getBitrateLimit();t instanceof wC&&e&&t.setBitrateLimit(e.uplink)}));try{await this._publishHighStream(t),Av.info("[".concat(this._clientId,"] Publish success, id ").concat(t.map((t=>"".concat(t.getTrackId()," ")))))}catch(t){throw Av.error("[".concat(this._clientId,"] publish error"),t.toString()),t}finally{i()}}async unpublish(t){if(!this._joinInfo||void 0===this._uid)throw new _v(Ev.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");t?Array.isArray(t)||(t=[t]):t=this._p2pChannel.getAllTracks(!0),Av.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map((t=>"".concat(t.getTrackId()," ")))," "));const e=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.unpublish(i,this._uid),Av.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map((t=>"".concat(t.getTrackId())))))}catch(t){throw Av.error("[".concat(this._clientId,"] unpublish error"),t.toString()),t}finally{e&&e()}}async subscribe(t,e){return this._subscribe(t,e)}async _subscribe(t,e,i){if(Kg(e,"mediaType",["audio","video"]),!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((e=>e===t))){const e=new _v(Ev.INVALID_REMOTE_USER,"user is not in the channel");throw Av.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),e}if(!t.hasAudio&&!t.hasVideo){const e=new _v(Ev.INVALID_REMOTE_USER,"user is not published");throw Av.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),e}if(!(i||("audio"!==e||t.hasAudio&&void 0!==t._audioSSRC)&&("video"!==e||t.hasVideo&&void 0!==t._videoSSRC))){const i=new _v(Ev.REMOTE_USER_IS_NOT_PUBLISHED);throw Av.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),i}const n="audio"===e?t._audioSSRC:t._videoSSRC,s="audio"===e?t._audioOrtc:t._videoOrtc,o="video"===e?t._rtxSsrcId:void 0,r={stream_type:"audio"===e?IE.AUDIO:IE.VIDEO,ssrcId:n},a=await this._subscribeMutex.lock();Av.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{LT.markSubscribeStart(this.store.clientId,n),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,n,o,s);try{await this._gateway.subscribe(t.uid,r,!0)}catch(i){if((null==i?void 0:i.code)!==Ev.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),i;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(i){throw this._p2pChannel.reportSubscribeEvent(!1,null==i?void 0:i.code,t,e),i}Av.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch((t=>{Av.warning("[".concat(this._clientId,"] auto set fallback failed"),t)}));const c="audio"===e?t._audioTrack:t._videoTrack;if(!c)throw new _v(Ev.UNEXPECTED_ERROR,"can not find remote track in user object");return c}catch(e){throw Av.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),e),e}finally{a()}}async massSubscribe(t){if(Xg(t,"subscribeList"),!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),i=new Map,n=await this._subscribeMutex.lock();Av.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i)})).join("; ")));const s=(t=[...t]).map((t=>{let{user:e,mediaType:i}=t;return{user:e,mediaType:i}})),o=await this._p2pChannel.globalLock();try{var r;for(let e=t.length-1;e>=0;e--){const n=t[e],{user:o,mediaType:r}=n;if(Kg(r,"mediaType",["audio","video"]),!o){const t=new _v(Ev.INVALID_PARAMS,"user property does not exist in subscribeList item");throw Av.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),t}if(!this._users.find((t=>t===o))){const i=new _v(Ev.INVALID_REMOTE_USER,"user is not in the channel");Av.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),s[e].error=i,t.splice(e,1);continue}if("audio"===r&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===r&&(!o.hasVideo||void 0===o._videoSSRC)){const i=new _v(Ev.REMOTE_USER_IS_NOT_PUBLISHED);Av.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(r,", remote user is not published")),s[e].error=i,t.splice(e,1);continue}const a=lE.Video|lE.LwoVideo,c=i.get(o);if(c){if("video"===r?c&a:c&lE.Audio){t.splice(e,1),Av.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(r," twice"));continue}i.set(o,c|("video"===r?a:lE.Audio))}else i.set(o,"video"===r?a:lE.Audio)}for(let e=t.length-1;e>=0;e--){const n=t[e],{user:s,mediaType:o}=n,r=lE.Video|lE.LwoVideo;if(this._p2pChannel.hasRemoteMedia(s,o)){await this._p2pChannel.unmuteRemoteNoLock(s,o);const n=i.get(s);i.set(s,"video"===o?n^r:n^lE.Audio),t.splice(e,1)}}this.store.massSubscribe(t.map((t=>({userId:t.user.uid,type:t.mediaType}))),e);const a=Xi(r=Array.from(i.entries())).call(r,((t,e)=>{let[i,n]=e;if(0===n)return t;const s={stream_id:i.uid,stream_type:n};return n&lE.Audio&&(s.audio_ssrc=i._audioSSRC),n&lE.Video&&(s.video_ssrc=i._videoSSRC),t.push(s),t}),[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map((t=>{let{user:e,mediaType:i}=t;return{user:e,mediaType:i,ssrcId:i===IE.VIDEO?e._videoSSRC:e._audioSSRC,rtxSsrcId:i===IE.VIDEO?e._rtxSsrcId:void 0}})));const i=new Map;if(a.length>0){const t=await this._gateway.subscribeAll(a,!0);((null==t?void 0:t.users)||[]).forEach((t=>{let{stream_id:e,video_error_code:n,audio_error_code:s,error_code:o}=t;(n||s||o)&&i.set(e,{video_error_code:n,audio_error_code:s,error_code:o})}))}if(Array.from(i.entries()).length>0){const t=Array.from(i.entries()).map((t=>{let e,[i,n]=t;return n.error_code||n.video_error_code&&n.audio_error_code?e=void 0:n.video_error_code?e=IE.VIDEO:n.audio_error_code&&(e=IE.AUDIO),{user:this.remoteUsers.find((t=>t.uid===i)),mediaType:e}}));await this._p2pChannel.massUnsubscribeNoLock(t)}for(const t of s){const e=i.get(t.user.uid);if(e){const i=e.error_code||"audio"===t.mediaType&&e.audio_error_code||"video"===t.mediaType&&e.video_error_code;if(i){const e=yy(i);Av.error("user:".concat(t.user.uid," mediaType:").concat(t.mediaType," has massSubscribe error ").concat(e.desc)),t.error=new _v(Ev.SUBSCRIBE_FAILED,"code ".concat(i,": ").concat(e.desc))}}t.error||("video"===t.mediaType?t.track=t.user.videoTrack:t.track=t.user.audioTrack)}return this.store.massSubscribe(s.filter((t=>!t.error)).map((t=>({userId:t.user.uid,type:t.mediaType}))),void 0,Date.now()),s.forEach((t=>{var i;PS.subscribe(this.store.sessionId,{succ:!!t.error,ec:(null===(i=t.error)||void 0===i?void 0:i.code)||null,video:t.mediaType===IE.VIDEO,audio:t.mediaType===IE.AUDIO,peerid:t.user.uid,subscribeRequestid:t.mediaType===IE.VIDEO?t.user._videoSSRC:t.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e)},!0)})),Av.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i)})).join("; "))),s}catch(e){throw await this._p2pChannel.massUnsubscribeNoLock(t),e}}finally{o(),n()}}async unsubscribe(t,e){if(e&&Kg(e,"mediaType",["audio","video"]),!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((e=>e===t))){const e=new _v(Ev.INVALID_REMOTE_USER,"user is not in the channel");throw Av.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),e}Av.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const i=await this._subscribeMutex.lock();try{const n=await this._p2pChannel.unsubscribe(t,e);n&&await this._gateway.unsubscribe(n,t.uid),Av.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}catch(e){if(e.code===Ev.DISCONNECT_P2P)return void Av.warning("disconnecting p2p, abort unsubscribe request.");throw Av.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),e.toString()),e}finally{i()}}async massUnsubscribe(t){if(Xg(t,"unsubscribeList"),!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");Av.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i,";")})).join())),t=[...t];const e=new Map;for(let i=t.length-1;i>=0;i--){const{user:n,mediaType:s}=t[i];if(!n){const t=new _v(Ev.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw Av.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),t}if(Kg(s,"mediaType",["video","audio",void 0]),!this._users.find((t=>t===n))){Av.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),t.splice(i,1);continue}const o=lE.Video|lE.LwoVideo;if(e.has(n)){const r=e.get(n);let a;switch(s){case"video":a=r&o;break;case"audio":a=r&lE.Audio;break;default:a=r&(lE.Audio|o)}if(a){Av.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(n.uid,",mediaType:").concat(s," twice.")),t.splice(i,1);continue}s?"audio"===s?e.set(n,r|lE.Audio):"video"===s&&e.set(n,r|o):e.set(n,r|lE.Audio|o)}else s?"audio"===s?e.set(n,lE.Audio):"video"===s&&e.set(n,o):e.set(n,lE.Audio|o)}try{const e=await this._p2pChannel.massUnsubscribe(t);e&&await this._gateway.massUnsubscribe(e),Av.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map((t=>{let{user:e,mediaType:i}=t;return"user: ".concat(null==e?void 0:e.uid,", mediaType: ").concat(i,";")})).join()))}catch(t){if(t.code===Ev.DISCONNECT_P2P)return void Av.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw Av.error("[".concat(this._clientId,"] massUnsubscribe error"),t.toString()),t}}setLowStreamParameter(t){!function(t){if(!t)throw new _v(Ev.INVALID_PARAMS);tf(t.width)||Yg(t.width,"streamParameter.width"),tf(t.height)||Yg(t.height,"streamParameter.height"),tf(t.framerate)||Yg(t.framerate,"streamParameter.framerate"),tf(t.bitrate)||qg(t.bitrate,"streamParameter.bitrate")}(t),(!t.width&&t.height||t.width&&!t.height)&&Av.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),Av.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t}async enableDualStream(){if(!YE().supportDualStream)throw PS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new _v(Ev.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new _v(Ev.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw PS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,PS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),Av.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(NE.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw PS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,PS.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),Av.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(t){Kg(t,"role",["audience","host"])}(t),e&&Bf(e),"rtc"===this.mode)throw Av.warning("[".concat(this._clientId,"]rtc mode can not use setClientRole")),new _v(Ev.INVALID_OPERATION,"rtc mode can not use setClientRole");if(e&&e.level&&"host"===t)throw new _v(Ev.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===t&&this._p2pChannel.hasLocalMedia())throw new _v(Ev.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,e),this._config.role=t,Av.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}setProxyServer(t,e){if(Jg(t,"proxyServer"),!e){if("DISCONNECTED"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new _v(Ev.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,PS.setProxyServer(this._proxyServer),Av.setProxyServer(this._proxyServer),Av.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if("DISCONNECTED"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new _v(Ev.INVALID_OPERATION,"You have already set the proxy")}if(Uf(t))return this._turnServer={servers:t,mode:"original-manual"},void Av.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map((t=>t.urls)).join(","),"."));t.forEach((t=>Vf(t))),this._turnServer={servers:t,mode:"manual"},Av.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if("DISCONNECTED"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"you should set license before join channel");if(Jg(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new _v(Ev.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,Av.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if("DISCONNECTED"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new _v(Ev.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let i;switch(void 0===t&&(t=3),t){case 1:case 2:throw new _v(Ev.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new _v(Ev.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,Av.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"Stop proxy server after leave channel");PS.setProxyServer(),Av.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",Av.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new _v(Ev.INVALID_PARAMS,"accessPoints is required.");Xg(t.accessPoints.serverList,"accessPoints.serverList"),Jg(t.accessPoints.domain,"accessPoints.domain");const e=(t,e)=>{qg(t,e,0,65535,!0)};let i=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),i=t.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new _v(Ev.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");Gv("CLOSE_AFB_FOR_LOCAL_AP")&&(Hv("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Hv("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,s=t.accessPoints.domain,o=t.accessPoints.serverList.map((t=>n.test(t)?"".concat(t.replace(/\./g,"-"),".").concat(s):t)),r=o.map((t=>"".concat(t,":").concat(i)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Hv("WEBCS_DOMAIN",r),Hv("WEBCS_DOMAIN_BACKUP_LIST",r),Hv("GATEWAY_DOMAINS",[s]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(Xg(t.report.hostname,"report.hostname"),Hv("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Hv("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Hv("EVENT_REPORT_DOMAIN",o[0]),Hv("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),Hv("STATS_COLLECTOR_PORT",a),t.report?Hv("ENABLE_EVENT_REPORT",!0):Hv("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(Xg(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let l=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),l=t.log.port),Hv("LOG_UPLOAD_SERVER","".concat(c,":").concat(l));let d=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(Xg(t.cds.hostname,"cds.hostname"),d=t.cds.hostname):d=o;let h=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),h=t.cds.port),Hv("CDS_AP",d.map((t=>"".concat(t,":").concat(h)))),t.cds?Hv("ENABLE_CONFIG_DISTRIBUTE",!0):Hv("ENABLE_CONFIG_DISTRIBUTE",!1),Av.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(Xg(t,"serverList"),Jg(e,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new _v(Ev.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map((t=>i.test(t)?"".concat(t.replace(/\./g,"-"),".").concat(e):t)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Hv("WEBCS_DOMAIN",t),Hv("WEBCS_DOMAIN_BACKUP_LIST",t),Hv("GATEWAY_DOMAINS",[e]),Hv("EVENT_REPORT_DOMAIN",t[0]),Hv("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Hv("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),Av.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(Kg(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw Av.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else Av.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){Kg(e,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout((()=>{const e=this._users.find((e=>e.uid===t));e&&e.videoTrack&&e.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(t){throw Av.error("[".concat(this._clientId,"] set remote video stream type error"),t.toString()),t}Av.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){Kg(e,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(t){throw Av.error("[".concat(this._clientId,"] set stream fallback option"),t.toString()),t}Av.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,i){if(function(t){Kg(t,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])}(t),Jg(e,"secret"),["aes-128-gcm2","aes-256-gcm2"].includes(t)){if(!i||!(i instanceof Uint8Array&&32===i.length))throw new _v(Ev.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new _v(Ev.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(e)||Av.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=t,this._encryptionSecret=e,i&&(this._encryptionSalt=vy(i))}async renewToken(t){if(Jg(t,"token",1,2047),!this._key||!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const i=await this._renewTokenMutex.lock();try{if(Gv("USE_NEW_TOKEN")){Av.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const e=await vw(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Sv);Av.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:e})}else Av.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});Av.debug("[".concat(this._clientId,"] renewToken success"))}catch(t){throw this._key=e,this._joinInfo.token=e,Av.error("[".concat(this._clientId,"] renewToken failed"),t.toString()),t}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?Av.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(Rf.VOLUME_INDICATOR,t)}),Gv("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if("h264"!==this.codec)throw new _v(Ev.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new _v(Ev.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new _v(Ev.LIVE_STREAMING_TASK_CONFLICT);const i=e?zf.TRANSCODE:zf.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(t,i)}setLiveTranscoding(t){return this._createLiveStreamingClient(zf.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((e=>e&&e.hasUrl(t)));if(!e.length)throw new _v(Ev.INVALID_PARAMS,"can not find live streaming url to stop");await _h.all(e.map((e=>e&&e.stopLiveStreamingTask(t))))}async addInjectStreamUrl(t,e){if(!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(zf.INJECT);i.setInjectStreamConfig(e,0),await i.startLiveStreamingTask(t,zf.INJECT)}async removeInjectStreamUrl(){var t;const e=this._createLiveStreamingClient(zf.INJECT),i=Array.from(yb(t=e.streamingTasks).call(t)).find((t=>t.mode===zf.INJECT));if(!this._joinInfo||!i)throw new _v(Ev.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(t){Rw(t);const e=this._createChannelMediaRelayClient();await e.startChannelMediaRelay(t)}async updateChannelMediaRelay(t){Rw(t);const e=this._createChannelMediaRelayClient();await e.updateChannelMediaRelay(t)}async stopChannelMediaRelay(){const t=this._createChannelMediaRelayClient();await t.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"can not send data stream, not joined");if("string"==typeof t&&(t=(new TextEncoder).encode(t)),new Blob([t]).size>1024)throw new _v(Ev.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(Nf.DATA_STREAM,{payload:vy(t)},!e)}sendMetadata(t){if(!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new _v(Ev.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Nf.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:vy(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(lf),!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"can not send custom report, not joined");await PS.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){Kg(e.spatialLayer,"spatialLayer",[0,1,2,3]),Kg(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(t){throw Av.error("[".concat(this._clientId,"] pick SVC layer failed"),t.toString()),t}}_reset(){if(Av.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=mv.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._users.forEach((t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy()})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new US("client-publish"),this._subscribeMutex=new US("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(t){}if(this._moderation)try{this.setImageModeration(!1)}catch(t){}}_startSession(t,e){const i=t||ty();t?Av.debug("[".concat(this._clientId,"] new Session ").concat(i)):Av.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i)),this._sessionId=i,this.store.sessionId=i,e?PS.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:e.channel,appid:e.appId,mode:this.mode}):this._joinInfo?PS.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._joinInfo.cname,appid:this._joinInfo.appId,mode:this.mode}):this._gateway.joinInfo&&PS.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId,mode:this.mode}),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(t){if(!this._joinInfo||void 0===this._uid)throw new _v(Ev.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Gv("FORCE_TURN")&&!Gv("TURN_ENABLE_TCP")&&!Gv("TURN_ENABLE_UDP"))throw new _v(Ev.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");Av.debug("[".concat(this._clientId,"] publish high stream"));try{const i=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter),n=(await i.next()).value;if(n){var e;let s;try{s=await this._gateway.publish(this._uid,n,!0)}catch(t){if(t.code!==Ev.DISCONNECT_P2P)throw i.throw(t),t}await i.next((null===(e=s)||void 0===e?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const e of t)e instanceof wC&&e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig),!e.muted&&e.enabled||await this._p2pChannel.muteLocalTrack(e)}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,t),(null==e?void 0:e.code)===Ev.WS_ABORT)return;throw e}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new _v(Ev.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new _v(Ev.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));Av.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const t=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await t.next()).value;if(i){var e;let n;try{n=await this._gateway.publish(this._uid,i,!0)}catch(e){if(e.code!==Ev.DISCONNECT_P2P)throw t.throw(e),e}t.next((null===(e=n)||void 0===e?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,void 0,!0),(null==t?void 0:t.code)===Ev.WS_ABORT)return;throw t}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new _v(Ev.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const e=()=>new ww(this._joinInfo,this._config.websocketRetryConfig||Sv,this._config.httpRetryConfig||Sv),i=t=>{t.onLiveStreamError=(t,e)=>{PS.reportApiInvoke(this._sessionId,{name:vf.ON_LIVE_STREAM_ERROR,options:[t,e],tag:gf.TRACER}).onSuccess(),this.safeEmit(Rf.LIVE_STREAMING_ERROR,t,e)},t.onLiveStreamWarning=(t,e)=>{PS.reportApiInvoke(this._sessionId,{name:vf.ON_LIVE_STREAM_WARNING,options:[t,e],tag:gf.TRACER}).onSuccess(),this.safeEmit(Rf.LIVE_STREAMING_WARNING,t,e)},t.on(tE.REQUEST_WORKER_MANAGER_LIST,((t,e,i)=>{if(!this._joinInfo)return i(new _v(Ev.INVALID_OPERATION,"can not find join info to get worker manager"));pw(t,this._joinInfo,this._axiosCancelSource.token,Sv).then(e).catch(i)}))};switch(t){case zf.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=e(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case zf.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=e(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case zf.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=e(),this._injectStreamingClient.on(tE.REQUEST_WORKER_MANAGER_LIST,((t,e,i)=>{if(!this._joinInfo)return i(new _v(Ev.INVALID_OPERATION,"can not find join info to get worker manager"));pw(t,this._joinInfo,this._axiosCancelSource.token,Sv).then(e).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(t,e,i)=>{this.emit(Rf.INJECT_STREAM_STATUS,t,e,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new _v(Ev.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:e}=this.getLocalVideoStats(),i={width:t,height:e};this._channelMediaRelayClient=new Aw(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Sv,this._config.httpRetryConfig||Sv,i),this._channelMediaRelayClient.on("state",(t=>{t===oE.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(Rf.CHANNEL_MEDIA_RELAY_STATE,t)})),this._channelMediaRelayClient.on("event",(t=>{this.safeEmit(Rf.CHANNEL_MEDIA_RELAY_EVENT,t)})),this._statsCollector.onStatsChanged=(t,e)=>{var i;"resolution"===t&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(e))}}return this._channelMediaRelayClient}_handleGatewayEvents(){this._gateway.on(cE.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(cE.CONNECTION_STATE_CHANGE,((t,e,i)=>{var n;if(i===Cf.FALLBACK)return;const s=()=>{this.safeEmit(Rf.CONNECTION_STATE_CHANGE,t,e,i)};if(PS.reportApiInvoke(this._sessionId||(null===(n=this._gateway.joinInfo)||void 0===n?void 0:n.sid)||null,{name:vf.CONNECTION_STATE_CHANGE,options:[t,e,i],tag:gf.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:i})),Av.info("[".concat(this._clientId,"] connection state change: ").concat(e," -> ").concat(t)),"DISCONNECTED"===t)return this._reset(),void s();if("RECONNECTING"===t)this._users.forEach((t=>{t._trust_in_room_=!1,t._trust_audio_enabled_state_=!1,t._trust_video_enabled_state_=!1,t._trust_audio_mute_state_=!1,t._trust_video_mute_state_=!1,t._trust_audio_stream_added_state_=!1,t._trust_video_stream_added_state_=!1,t._audioSSRC=void 0,t._videoSSRC=void 0,t._videoOrtc=void 0,t._audioOrtc=void 0,t._cname=void 0,t._rtxSsrcId=void 0})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===t){var o;this._streamFallbackTypeCacheMap.forEach(((t,e)=>{this._gateway.setStreamFallbackOption(e,t).catch((t=>{Av.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),t)}))})),this._remoteStreamTypeCacheMap.forEach(((t,e)=>{this._gateway.setRemoteVideoStreamType(e,t).catch((t=>{Av.warning("[".concat(this._clientId,"] auto set remote stream type failed"),t)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(o=this._joinInfo)||void 0===o?void 0:o.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{Av.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((t=>{Av.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(t))})),this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter((t=>!t._trust_in_room_)).forEach((t=>{Av.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(t.uid)),this._handleUserOffline({uid:t.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((t=>{t._trust_audio_mute_state_||(Av.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(t.uid)),this._handleMuteStream(t.uid,"audio",!1)),t._trust_video_mute_state_||(Av.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(t.uid)),this._handleMuteStream(t.uid,"video",!1)),t._trust_audio_enabled_state_||(Av.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(t.uid)),this._handleSetStreamLocalEnable("audio",t.uid,!0)),t._trust_video_enabled_state_||(Av.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(t.uid)),this._handleSetStreamLocalEnable("video",t.uid,!0)),t._trust_video_stream_added_state_||(Av.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(t.uid)),this._handleResetAddStream(t,"video")),t._trust_audio_stream_added_state_||(Av.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(t.uid)),this._handleResetAddStream(t,"audio")),t._video_added_||t._audio_added_||(Av.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(t.uid)),this._handleRemoveStream({uid:t.uid,uint_id:t._uintid}))})))}),1e3)}s()})),this._gateway.on(cE.REQUEST_NEW_GATEWAY_LIST,((t,e)=>{if(!this._joinInfo)return e(new _v(Ev.UNEXPECTED_ERROR,"can not recover, no join info"));cw(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Sv,this.store).then((e=>{this._joinInfo&&(this._joinInfo.apResponse=e.gatewayInfo.res,this._joinInfo.gatewayAddrs=e.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=e.gatewayInfo.uni_lbs_ip),t(e.gatewayInfo.gatewayAddrs.map((t=>{if(this._joinInfo&&this._joinInfo.proxyServer){const e=t.address.split(":");return"wss://".concat(this._joinInfo.proxyServer,"/ws/?h=").concat(e[0],"&p=").concat(e[1])}return"wss://".concat(t.address)})))})).catch(e)})),this._gateway.on(cE.NETWORK_QUALITY,(t=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(Rf.NETWORK_QUALITY,t)})),this._gateway.on(cE.STREAM_TYPE_CHANGE,((t,e)=>{this.safeEmit(Rf.STREAM_TYPE_CHANGED,t,e),PS.reportApiInvoke(this._sessionId,{name:vf.STREAM_TYPE_CHANGE,options:[t,e],tag:gf.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))})),this._gateway.on(cE.IS_P2P_DISCONNECTED,(t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)})),this._gateway.on(cE.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(cE.REQUEST_P2P_CONNECTION_PARAMS,(async(t,e,i)=>{try{e(await this._p2pChannel.startP2PConnection(t))}catch(t){i(t)}})),this._gateway.on(cE.JOIN_RESPONSE,((t,e)=>{const{dtlsParameters:i,iceParameters:n,candidates:s,rtpCapabilities:o,setup:r,cname:a}=GI(t.ortc,e);this._p2pChannel.connect(n,i,s,o,r,a)})),this._gateway.on(cE.REQUEST_DC_CONNECTION_PARAMS,(t=>{t(this._p2pChannel.getEstablishParams())})),this._gateway.on(cE.RESET_SIGNAL,(t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents()})),this._gateway.on(cE.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(cE.DATACHANNEL_PRECONNECT,(async(t,e,i,n)=>{var s,o,r,a,c,l;await this._p2pChannel.startP2PConnection({turnServer:null===(s=this._joinInfo)||void 0===s?void 0:s.turnServer},!0);const d=function(t,e){let i;return e&&e.ip&&"number"==typeof e.port?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],Av.debug("Using remote candidate from AP ".concat(e.ip,":").concat(e.port)),e.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),Av.debug("Using IPV6 remote candidate from AP ".concat(e.ip6,":").concat(e.port)))):i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],i}(t,e);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(o=this._joinInfo)||void 0===o?void 0:o.apResponse.cid,"_").concat(null===(r=this._joinInfo)||void 0===r?void 0:r.apResponse.cert),icePwd:"".concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cid,"_").concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(l=Gv("FINGERPRINT"))&&void 0!==l?l:t.fingerprint}]},d,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(i).catch(n)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(Lf.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Lf.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Lf.ON_ADD_AUDIO_STREAM,(t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc))),this._gateway.signal.on(Lf.ON_ADD_VIDEO_STREAM,(t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId))),this._gateway.signal.on(Lf.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Lf.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Lf.MUTE_AUDIO,(t=>this._handleMuteStream(t.uid,"audio",!0))),this._gateway.signal.on(Lf.UNMUTE_AUDIO,(t=>this._handleMuteStream(t.uid,"audio",!1))),this._gateway.signal.on(Lf.MUTE_VIDEO,(t=>this._handleMuteStream(t.uid,"video",!0))),this._gateway.signal.on(Lf.UNMUTE_VIDEO,(t=>this._handleMuteStream(t.uid,"video",!1))),this._gateway.signal.on(Lf.RECEIVE_METADATA,(t=>{const e=my(t.metadata);this.safeEmit(Rf.RECEIVE_METADATA,t.uid,e)})),this._gateway.signal.on(Lf.ON_DATA_STREAM,(t=>{t.seq&&delete t.seq,t.payload=my(t.payload),this.safeEmit(Rf.STREAM_MESSAGE,t.uid,t.payload),this.onStreamMessage&&this.onStreamMessage(t)})),this._gateway.signal.on(Lf.ON_CRYPT_ERROR,(()=>{py((()=>{Av.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Rf.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(Lf.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Lf.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{Av.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0),this.safeEmit(Rf.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(Lf.ON_STREAM_FALLBACK_UPDATE,(t=>{Av.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(Rf.STREAM_FALLBACK,t.stream_id,1===t.stream_type?"fallback":"recover")})),this._gateway.signal.on(Lf.ON_PUBLISH_STREAM,(t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),Av.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))})),this._gateway.signal.on(Lf.ENABLE_LOCAL_VIDEO,(t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)})),this._gateway.signal.on(Lf.DISABLE_LOCAL_VIDEO,(t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)})),this._gateway.signal.on(Of.REQUEST_TIMEOUT,((t,e)=>{if(this._joinInfo)switch(t){case Nf.PUBLISH:{if(!e)return;const t=(e=e).ortc;if(t){var i,n,s,o;const r=t.some((t=>{let{stream_type:e}=t;return e===aE.Audio})),a=t.some((t=>{let{stream_type:e}=t;return e!==aE.Audio})),c=t.some((t=>{let{stream_type:e}=t;return e===aE.Screen||e===aE.ScreenLow}));"offer"===e.state&&PS.publish(this._joinInfo.sid,{eventElapse:LT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:Ev.TIMEOUT,audio:r,video:a,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:r?null===(i=t.find((t=>{let{stream_type:e}=t;return e===aE.Audio})))||void 0===i||null===(n=i.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:a?null===(s=t.find((t=>{let{stream_type:e}=t;return e!==aE.Audio})))||void 0===s||null===(o=s.ssrcs[0])||void 0===o?void 0:o.ssrcId.toString():void 0})}break}case Nf.SUBSCRIBE:(e=e)&&PS.subscribe(this._joinInfo.sid,{succ:!1,ec:Ev.TIMEOUT,audio:e.stream_type===IE.AUDIO,video:e.stream_type===IE.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:LT.measureFromSubscribeStart(this.store.clientId,e.ssrcId)})}})),this._gateway.signal.on(Lf.ON_P2P_OK,(t=>{this.uid,this._uid})),this._gateway.signal.on(Lf.ON_PUBLISHED_USER_LIST,(t=>{if(null==t||!t.users)return;Gv("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter((t=>!Zv(t.audio_ssrc,this.channelName))));const e=[],i=[];for(const n of t.users){let t=this._users.find((t=>t.uid===n.stream_id));t?t._trust_in_room_=!0:(t=new RC(n.stream_id,n.stream_id),this._users.push(t),0===this.getListeners(Rf.PUBLISHED_USER_LIST).length&&(Av.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.safeEmit(Rf.USER_JOINED,t)));const s=lE.Audio&n.stream_type,o=(lE.Video|lE.LwoVideo)&n.stream_type,r=s&&t.hasAudio,a=o&&t.hasVideo;o&&(t._trust_video_stream_added_state_=!0,t._video_added_=!0,t._videoSSRC=n.video_ssrc,t._rtxSsrcId=n.video_rtx),s&&(t._trust_audio_stream_added_state_=!0,t._audio_added_=!0,t._audioSSRC=n.audio_ssrc),s&&!r&&0===this.getListeners(Rf.PUBLISHED_USER_LIST).length&&(Av.info("[".concat(this._clientId,"] remote user ").concat(t.uid," published audio")),this.safeEmit(Rf.USER_PUBLISHED,t,"audio")),o&&!a&&0===this.getListeners(Rf.PUBLISHED_USER_LIST).length&&(Av.info("[".concat(this._clientId,"] remote user ").concat(t.uid," published video")),this.safeEmit(Rf.USER_PUBLISHED,t,"video")),(s&&!r||o&&!a)&&e.push(t),o&&this._p2pChannel.hasPendingRemoteMedia(t,"video")&&i.push({user:t,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(t,"audio")&&i.push({user:t,mediaType:"audio"})}i.length>0&&(Av.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map((t=>"user: ".concat(t.user.uid,", mediaType: ").concat(t.mediaType))).join("; ")," ")),this.massSubscribe(i).catch((t=>{Av.error("[".concat(this._clientId,"] mass resubscribe error"),t.toString())}))),this.getListeners(Rf.PUBLISHED_USER_LIST).length>0?(Av.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map((t=>t.uid)).join(", "))),this.safeEmit(Rf.PUBLISHED_USER_LIST,e)):Av.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map((t=>t.uid)).join(", ")))}))}_handleP2PChannelEvents(){this._p2pChannel.on(LE.RequestMuteLocal,(async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(t){t.code===Ev.DISCONNECT_P2P?e():i(t)}else e()})),this._p2pChannel.on(LE.RequestUnmuteLocal,(async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(t){t.code===Ev.DISCONNECT_P2P?e():i(t)}else e()})),this._p2pChannel.on(LE.RequestRePublish,((t,e,i)=>{this.publish(t,!1).then(e).catch(i)})),this._p2pChannel.on(LE.RequestReSubscribe,(async(t,e,i)=>{try{for(const{user:e,kind:i}of t)i===IE.VIDEO?await this.subscribe(e,"video"):await this.subscribe(e,"audio");e()}catch(t){i(t)}})),this._p2pChannel.on(LE.RequestUploadStats,((t,e)=>{this._gateway.uploadStats(t,e)})),this._p2pChannel.on(LE.MediaReconnectStart,(t=>{this.safeEmit(Rf.MEDIA_RECONNECT_START,t)})),this._p2pChannel.on(LE.MediaReconnectEnd,(t=>{this.safeEmit(Rf.MEDIA_RECONNECT_END,t)})),this._p2pChannel.on(LE.NeedSignalRTT,(t=>{t(this._gateway.getSignalRTT())})),this._p2pChannel.on(LE.RequestRestartICE,(async t=>{const e=await this._p2pChannel.restartICE(t),i=await e.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(t){return void e.throw(t)}const{iceParameters:o}=function(t){const e=t.iceParameters;return{iceParameters:{iceUfrag:e.iceUfrag,icePwd:e.icePwd}}}(s);await e.next({remoteIceParameters:o})})),this._p2pChannel.on(LE.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(LE.RequestReconnectPC,(async()=>{var t;const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(t=this._joinInfo)||void 0===t?void 0:t.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:r,iceParameters:a,candidates:c,rtpCapabilities:l,setup:d,cname:h}=GI(s,o);await this._p2pChannel.connect(a,r,c,l,d,h),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(LE.RequestUnpublishForReconnectPC,(async(t,e,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(t,this._uid),e()):i()})),this._p2pChannel.on(LE.P2PLost,(()=>{this.safeEmit(Rf.P2P_LOST,this.store.uid)})),this._p2pChannel.on(LE.UpdateVideoEncoder,(t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)})),this._p2pChannel.on(LE.ConnectionTypeChange,(t=>{this.safeEmit(Rf.IS_USING_CLOUD_PROXY,t)})),this._p2pChannel.on(LE.RequestLowStreamParameter,(t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(LE.QueryClientConnectionState,(t=>{t(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new _v(Ev.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new _v(Ev.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const e=[...new Set(t.inspectType)];e.forEach((t=>{if(!["supervise","moderation"].includes(t))throw new _v(Ev.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(t," is not a valid inspect type."))})),t.inspectType=e}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new _v(Ev.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const e=new gN(t);this._inspect=e,this.handleVideoInspectEvents(this._inspect),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Sv)}catch(t){throw Array.isArray(t)?t[0]:t}}async disableContentInspect(){if(!this._inspect)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(zg(t,"enabled"),t){if(!e)throw new _v(Ev.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(qg(e.interval,"interval",1e3,1/0),"CONNECTED"!==this.connectionState||!this._joinInfo)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(e);const t=new YN(e);this._moderation=t,this.handleImageModerationEvents(this._moderation),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Sv)}catch(t){throw Array.isArray(t)?t[0]:t}}else{if(!this._moderation)throw new _v(Ev.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}}handleImageModerationEvents(t){t.on(WE.CONNECTION_STATE_CHANGE,((e,i)=>{if(this.emit(Rf.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,i),e===$E.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new _v(Ev.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}})),t.on(WE.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((t=>"video"===t.trackMediaType))[0])}))}handleVideoInspectEvents(t){t.on(BE.CONNECTION_STATE_CHANGE,((e,i)=>{if(this.emit(Rf.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,i),i===UE.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.emit(Rf.CONTENT_INSPECT_ERROR,new _v(Ev.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}})),t.on(BE.INSPECT_RESULT,((t,e)=>{var i;if((null==e?void 0:e.code)===Ev.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return Av.debug("Stop inspect content because that has left channel"),null==this||null===(i=this._inspect)||void 0===i||i.close(),void(this._inspect=void 0);this.emit(Rf.CONTENT_INSPECT_RESULT,t,e)})),t.on(BE.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((t=>"video"===t.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return Av.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){zg(t,"enabled"),Hv("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}}).prototype,"leave",[JN],Object.getOwnPropertyDescriptor(Mk.prototype,"leave"),Mk.prototype),cS(Mk.prototype,"publish",[XN],Object.getOwnPropertyDescriptor(Mk.prototype,"publish"),Mk.prototype),cS(Mk.prototype,"unpublish",[QN],Object.getOwnPropertyDescriptor(Mk.prototype,"unpublish"),Mk.prototype),cS(Mk.prototype,"subscribe",[ZN],Object.getOwnPropertyDescriptor(Mk.prototype,"subscribe"),Mk.prototype),cS(Mk.prototype,"massSubscribe",[tk],Object.getOwnPropertyDescriptor(Mk.prototype,"massSubscribe"),Mk.prototype),cS(Mk.prototype,"unsubscribe",[ek],Object.getOwnPropertyDescriptor(Mk.prototype,"unsubscribe"),Mk.prototype),cS(Mk.prototype,"massUnsubscribe",[ik],Object.getOwnPropertyDescriptor(Mk.prototype,"massUnsubscribe"),Mk.prototype),cS(Mk.prototype,"setLowStreamParameter",[nk],Object.getOwnPropertyDescriptor(Mk.prototype,"setLowStreamParameter"),Mk.prototype),cS(Mk.prototype,"enableDualStream",[sk],Object.getOwnPropertyDescriptor(Mk.prototype,"enableDualStream"),Mk.prototype),cS(Mk.prototype,"disableDualStream",[ok],Object.getOwnPropertyDescriptor(Mk.prototype,"disableDualStream"),Mk.prototype),cS(Mk.prototype,"setClientRole",[rk],Object.getOwnPropertyDescriptor(Mk.prototype,"setClientRole"),Mk.prototype),cS(Mk.prototype,"setProxyServer",[ak],Object.getOwnPropertyDescriptor(Mk.prototype,"setProxyServer"),Mk.prototype),cS(Mk.prototype,"setTurnServer",[ck],Object.getOwnPropertyDescriptor(Mk.prototype,"setTurnServer"),Mk.prototype),cS(Mk.prototype,"setLicense",[lk],Object.getOwnPropertyDescriptor(Mk.prototype,"setLicense"),Mk.prototype),cS(Mk.prototype,"startProxyServer",[dk],Object.getOwnPropertyDescriptor(Mk.prototype,"startProxyServer"),Mk.prototype),cS(Mk.prototype,"stopProxyServer",[hk],Object.getOwnPropertyDescriptor(Mk.prototype,"stopProxyServer"),Mk.prototype),cS(Mk.prototype,"setLocalAccessPointsV2",[uk],Object.getOwnPropertyDescriptor(Mk.prototype,"setLocalAccessPointsV2"),Mk.prototype),cS(Mk.prototype,"setLocalAccessPoints",[pk],Object.getOwnPropertyDescriptor(Mk.prototype,"setLocalAccessPoints"),Mk.prototype),cS(Mk.prototype,"setRemoteDefaultVideoStreamType",[mk],Object.getOwnPropertyDescriptor(Mk.prototype,"setRemoteDefaultVideoStreamType"),Mk.prototype),cS(Mk.prototype,"setRemoteVideoStreamType",[vk],Object.getOwnPropertyDescriptor(Mk.prototype,"setRemoteVideoStreamType"),Mk.prototype),cS(Mk.prototype,"setStreamFallbackOption",[gk],Object.getOwnPropertyDescriptor(Mk.prototype,"setStreamFallbackOption"),Mk.prototype),cS(Mk.prototype,"setEncryptionConfig",[fk],Object.getOwnPropertyDescriptor(Mk.prototype,"setEncryptionConfig"),Mk.prototype),cS(Mk.prototype,"renewToken",[Ek],Object.getOwnPropertyDescriptor(Mk.prototype,"renewToken"),Mk.prototype),cS(Mk.prototype,"enableAudioVolumeIndicator",[_k],Object.getOwnPropertyDescriptor(Mk.prototype,"enableAudioVolumeIndicator"),Mk.prototype),cS(Mk.prototype,"startLiveStreaming",[Sk],Object.getOwnPropertyDescriptor(Mk.prototype,"startLiveStreaming"),Mk.prototype),cS(Mk.prototype,"setLiveTranscoding",[bk],Object.getOwnPropertyDescriptor(Mk.prototype,"setLiveTranscoding"),Mk.prototype),cS(Mk.prototype,"stopLiveStreaming",[Tk],Object.getOwnPropertyDescriptor(Mk.prototype,"stopLiveStreaming"),Mk.prototype),cS(Mk.prototype,"addInjectStreamUrl",[yk],Object.getOwnPropertyDescriptor(Mk.prototype,"addInjectStreamUrl"),Mk.prototype),cS(Mk.prototype,"removeInjectStreamUrl",[wk],Object.getOwnPropertyDescriptor(Mk.prototype,"removeInjectStreamUrl"),Mk.prototype),cS(Mk.prototype,"startChannelMediaRelay",[Ck],Object.getOwnPropertyDescriptor(Mk.prototype,"startChannelMediaRelay"),Mk.prototype),cS(Mk.prototype,"updateChannelMediaRelay",[Rk],Object.getOwnPropertyDescriptor(Mk.prototype,"updateChannelMediaRelay"),Mk.prototype),cS(Mk.prototype,"stopChannelMediaRelay",[Ik],Object.getOwnPropertyDescriptor(Mk.prototype,"stopChannelMediaRelay"),Mk.prototype),cS(Mk.prototype,"sendCustomReportMessage",[Ak],Object.getOwnPropertyDescriptor(Mk.prototype,"sendCustomReportMessage"),Mk.prototype),cS(Mk.prototype,"pickSVCLayer",[Ok],Object.getOwnPropertyDescriptor(Mk.prototype,"pickSVCLayer"),Mk.prototype),cS(Mk.prototype,"enableContentInspect",[Nk],Object.getOwnPropertyDescriptor(Mk.prototype,"enableContentInspect"),Mk.prototype),cS(Mk.prototype,"disableContentInspect",[kk],Object.getOwnPropertyDescriptor(Mk.prototype,"disableContentInspect"),Mk.prototype),cS(Mk.prototype,"setImageModeration",[Lk],Object.getOwnPropertyDescriptor(Mk.prototype,"setImageModeration"),Mk.prototype),cS(Mk.prototype,"getJoinChannelServiceRecords",[Pk],Object.getOwnPropertyDescriptor(Mk.prototype,"getJoinChannelServiceRecords"),Mk.prototype),cS(Mk.prototype,"setPublishAudioFilterEnabled",[Dk],Object.getOwnPropertyDescriptor(Mk.prototype,"setPublishAudioFilterEnabled"),Mk.prototype),Mk);class Bk extends XS{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(Df.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),vp(this,"audioBuffer",void 0),vp(this,"sourceNode",void 0),vp(this,"startPlayTime",0),vp(this,"startPlayOffset",0),vp(this,"pausePlayTime",0),vp(this,"options",void 0),vp(this,"currentLoopCount",0),vp(this,"currentPlaybackSpeed",100),vp(this,"_currentState","stopped"),this.audioBuffer=t,this.options=e,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer.duration}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration}updateOptions(t){"stopped"===this.currentState?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):Av.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=t,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch(t){}this.reset()}}setAudioBufferPlaybackSpeed(t){this.sourceNode&&("playing"===this.currentState&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const jk=new Map;async function Fk(t,e){let i=null;if("string"==typeof t){const e=jk.get(t);if(e)return Av.debug("use cached audio resource: ",t),e;try{i=(await Tv((()=>mv.get(t,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(t){throw new _v(Ev.FETCH_AUDIO_FILE_FAILED,t.toString())}}else{const e=new _h(((e,i)=>{const n=new FileReader;n.onload=t=>{t.target?e(t.target.result):i(new _v(Ev.READ_LOCAL_AUDIO_FILE_ERROR))},n.onerror=()=>{i(new _v(Ev.READ_LOCAL_AUDIO_FILE_ERROR))},n.readAsArrayBuffer(t)}));i=await e}const n=await function(t){const e=WS();return new _h(((i,n)=>{e.decodeAudioData(t,(t=>{i(t)}),(t=>{n(new _v(Ev.DECODE_AUDIO_FILE_FAILED,t.toString()))}))}))}(i);return"string"==typeof t&&e&&jk.set(t,n),n}function Hk(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Gk(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Hk(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Hk(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function $k(t,e,i,n){i.optimizationMode&&(n&&n.width&&n.height?(i.encoderConfig=Gk(Gk({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),"motion"!==i.optimizationMode&&"detail"!==i.optimizationMode||(e.contentHint=i.optimizationMode,e.contentHint===i.optimizationMode?Av.debug("[".concat(t,"] set content hint to"),i.optimizationMode):Av.debug("[".concat(t,"] set content hint failed")))):Av.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}const Wk=Vu().name;function zk(t,e,i,n){let s,o=0,r=null;return new _h(((a,c)=>{setTimeout((()=>{s&&(s(),a(o))}),e),s=YS((()=>{!function(){o>n&&s&&(s(),a(o));const e=i.getContext("2d");if(!e){const t=new _v(Ev.UNEXPECTED_ERROR,"can not get canvas 2d context.");return Av.error(t.toString()),void c(t)}e.drawImage(t,0,0,160,120);const l=e.getImageData(0,0,i.width,i.height),d=Math.floor(l.data.length/3);if(r){for(let t=0;t<d;t+=3)if(l.data[t]!==r[t])return o+=1,void(r=l.data);r=l.data}else r=l.data}()}),30)}))}class Kk{constructor(t,e){vp(this,"id",0),vp(this,"element",void 0),vp(this,"peerPair",void 0),vp(this,"context",void 0),vp(this,"audioPlayerElement",void 0),vp(this,"audioTrack",void 0),Kk.count+=1,this.id=Kk.count,this.element=t,this.context=e}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const e=document.createElement("audio");e.srcObject=new MediaStream([t.track]),e.play(),this.audioPlayerElement=e}}async switchSdp(){if(!this.peerPair)return;const t=async(t,e)=>{const i="offer"===e?await t.createOffer():await t.createAnswer();return await t.setLocalDescription(i),"complete"===t.iceGatheringState?t.localDescription:new _h((e=>{t.onicegatheringstatechange=()=>{"complete"===t.iceGatheringState&&e(t.localDescription)}}))},e=async(t,e)=>await t.setRemoteDescription(e);try{const i=await t(this.peerPair[0],"offer");await e(this.peerPair[1],i);const n=await t(this.peerPair[1],"answer");await e(this.peerPair[0],n)}catch(t){throw new _v(Ev.LOCAL_AEC_ERROR,t.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let e;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),e=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(e)}catch(t){throw new _v(Ev.LOCAL_AEC_ERROR,t.toString()).print()}if(!e)throw new _v(Ev.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=e.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,e=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(e),await this.switchSdp()}close(){Av.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((t=>{t.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var qk,Yk;vp(Kk,"count",0);const Jk=window.AudioContext||window.webkitAudioContext,Xk=new(qk=LS({report:PS}),cS((Yk=class{constructor(){vp(this,"units",[]),vp(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return Av.debug("the system does not need to process local aec"),-1;this.context||(this.context=new Jk);let e=this.units.find((e=>e&&e.getElement()===t));return e||(e=new Kk(t,this.context),this.units.push(e)),e.startEchoCancellation(),Av.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Vu().name!==ku.SAFARI}}).prototype,"processExternalMediaAEC",[qk],Object.getOwnPropertyDescriptor(Yk.prototype,"processExternalMediaAEC"),Yk.prototype),Yk);function Qk(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Zk(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Qk(Object(i),!0).forEach((function(e){vp(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Qk(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}const tL=window||document;function eL(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!tL)return;const i=iL._cspEventHandlerPointer;if(i&&e)return void console.error(i,e);const n=t=>{if(!(t&&t.blockedURI&&(iL.onSecurityPolicyViolation||iL.getListeners(HE.SECURITY_POLICY_VIOLATION).length>0)))return;const e=t.blockedURI;Gv("CSP_DETECTED_HOSTNAME_LIST").some((t=>e.includes(t)))&&(iL.onSecurityPolicyViolation&&"function"==typeof iL.onSecurityPolicyViolation&&iL.onSecurityPolicyViolation(t),iL.getListeners(HE.SECURITY_POLICY_VIOLATION).length>0&&iL.safeEmit(HE.SECURITY_POLICY_VIOLATION,t))};i&&tL.removeEventListener("securitypolicyviolation",i),(e||t&&"function"==typeof t||iL.getListeners(HE.SECURITY_POLICY_VIOLATION).length>0)&&tL.addEventListener("securitypolicyviolation",n),iL._cspEventHandlerPointer=n}Hv("PROCESS_ID","process-".concat(ZT(8,""),"-").concat(ZT(4,""),"-").concat(ZT(4,""),"-").concat(ZT(4,""),"-").concat(ZT(12,""))),function(){const t=Vu();qE.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),qE.getStreamFromExtension=t.name===ku.CHROME&&Number(t.version)>34,qE.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let e=!1;try{t.addTransceiver("audio"),e=!0}catch(t){}return t.close(),e}(),qE.supportMinBitrate=t.name===ku.CHROME||t.name===ku.EDGE,qE.supportSetRtpSenderParameters=function(){const t=Vu();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!op()||!(!Wu()&&!Fu())||t.name===ku.FIREFOX&&Number(t.version)>=64)}(),t.name===ku.SAFARI&&(Number(t.version)>=14?qE.supportDualStream=!0:qE.supportDualStream=!1),qE.webAudioMediaStreamDest=function(){const t=Vu();return!(t.name===ku.SAFARI&&Number(t.version)<12)}(),qE.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,qE.supportWebGL="undefined"!=typeof WebGLRenderingContext,qE.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,op()||(qE.webAudioWithAEC=!0),qE.supportShareAudio=function(){const t=Vu();return(t.os===Nu.WIN_10||t.os===Nu.WIN_81||t.os===Nu.WIN_7||t.os===Nu.LINUX||t.os===Nu.MAC_OS)&&t.name===ku.CHROME&&Number(t.version)>=74}(),qE.supportDualStreamEncoding=function(){const t=Vu();return!!Gv("DISABLE_WEBAUDIO")||"Safari"===t.name&&Number(t.version)>=14||!!("Chrome"===t.name&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&Gv("CHROME_DUAL_STREAM_USE_ENCODING"))}(),qE.supportDataChannel=!!(qu(76)||function(t){const e=Vu();return!(e.name!==ku.FIREFOX||!e.osVersion)&&Number(e.version)>=t}(68)||function(t){const e=Vu();return!(e.name!==ku.SAFARI||!e.osVersion)&&Number(e.version)>=t}(14)),qE.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!zu()&&!!t&&t.prototype.setConfiguration instanceof Function}(),qE.supportWebRTCEncodedTransform=function(){const t=Vu();return"Chrome"===t.name&&Number(t.version)>=86}(),Av.info("browser compatibility",JSON.stringify(qE),JSON.stringify(t))}(),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void Av.error("Error loading sdk config",t.message)}if(t)try{const e=JSON.parse(window.atob(t)),i=Date.now();Av.debug("Loading global parameters from cache",e),Object.keys(e).forEach((t=>{if(Object.prototype.hasOwnProperty.call($v,t)){const{value:n,expires:s}=e[t];if(s&&s<=i)return;Wv[t]=n,$v[t]=n}}))}catch(e){Av.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(Wv.AREAS)&&Wv.AREAS.length>0&&qy(Wv.AREAS,!0);const iL=function(t){const e=new gv,i=t,n={getListeners:e.getListeners.bind(e),on:(t,i)=>(function(t,e){t===HE.SECURITY_POLICY_VIOLATION&&eL(e,!0)}(t,i),e.on.bind(e)(t,i)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return Zk(Zk({},i),n)}({__CLIENT_LIST__:Xv,__TRACK_LIST__:Qv,VERSION:Nv,BUILD:Ov,setParameter:(t,e,i)=>{Av.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Hv(t,e,i)},getParameter:Gv,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection;e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});const i=(await e.createOffer()).sdp;if(!i)return t;e.close(),e=null,t=function(t){const e={video:[],audio:[]};return t.match(/ VP8/i)&&e.video.push("VP8"),t.match(/ VP9/i)&&e.video.push("VP9"),t.match(/ AV1/i)&&e.video.push("AV1"),t.match(/ H264/i)&&e.video.push("H264"),t.match(/ H265/i)&&e.video.push("H265"),t.match(/ opus/i)&&e.audio.push("OPUS"),t.match(/ PCMU/i)&&e.audio.push("PCMU"),t.match(/ PCMA/i)&&e.audio.push("PCMA"),t.match(/ G722/i)&&e.audio.push("G722"),e}(i)}catch(t){throw new _v(Ev.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return t},checkSystemRequirements:function(){const t=PS.reportApiInvoke(null,{name:vf.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:gf.TRACER});let e=!1;try{const t=window.RTCPeerConnection,i=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,n=window.WebSocket;e=!!(t&&i&&n)}catch(t){return Av.error("check system requirement failed: ",t),!1}let i=!1;const n=Vu();n.name===ku.CHROME&&Number(n.version)>=58&&(!Gu()||Hu())&&(i=!0),n.name===ku.FIREFOX&&Number(n.version)>=56&&(i=!0),n.name===ku.OPERA&&Number(n.version)>=45&&(i=!0),n.name===ku.SAFARI&&Number(n.version)>=11&&(i=!0),(np()||Vu().name===ku.QQ)&&(i=!0),Av.debug("checkSystemRequirements, api:",e,"browser",i);const s=e&&i;return t.onSuccess(s),s},getDevices:function(t){return ub.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return ub.getRecordingDevices(t)},getCameras:function(t){return ub.getCamerasDevices(t)},getElectronScreenSources:eb,getPlaybackDevices:function(t){return ub.getSpeakers(t)},createClient:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const e=PS.reportApiInvoke(null,{name:vf.CREATE_CLIENT,options:[t],tag:gf.TRACER});try{xf(t)}catch(t){throw e.onError(t),t}return void 0===t.audioCodec&&(t.audioCodec="opus"),e.onSuccess(),new Vk(Uk(Uk({forceWaitGatewayResponse:!0},t),{},{role:"rtc"===t.mode?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CREATE_CAM_VIDEO_TRACK,options:[Gk({},t)]}),i=xw(t),n=ZT(8,"track-cam-");let s=null;Av.info("start create camera video track with config",JSON.stringify(t),"trackId",n);try{s=(await cb({video:i},n)).getVideoTracks()[0]||null}catch(t){throw e.onError(t),t}if(!s){const t=new _v(Ev.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(t),t.throw()}t.optimizationMode&&$k(n,s,t,Uv(t.encoderConfig));const o=new CC(s,t,i,t.scalabiltyMode?Bv(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n);return e.onSuccess(o.getTrackId()),Av.info("create camera video success, trackId:",n),o},createCustomVideoTrack:function(t){const e=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),i=new wC(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Bv(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,ZT(8,"track-cus-"),[uE.CUSTOM_TRACK]);return e.onSuccess(i.getTrackId()),Av.info("create custom video track success with config",t,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable";const i=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CREATE_SCREEN_VIDEO_TRACK,options:[Gk({},t),e]});t.encoderConfig?"string"==typeof t.encoderConfig||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const n=Uw(t),s=ZT(8,"track-scr-v-");let o=null,r=null;const a=YE();if(!a.supportShareAudio&&"enable"===e){const t=new _v(Ev.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(t),t.throw()}Av.info("start create screen video track with config",t,"withAudio",e,"trackId",s);try{const t=await cb({screen:n,screenAudio:"auto"===e?a.supportShareAudio:"enable"===e},s);o=t.getVideoTracks()[0]||null,r=t.getAudioTracks()[0]||null}catch(t){throw i.onError(t),t}if(!o){const t=new _v(Ev.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(t),t.throw()}if(!r&&"enable"===e){o&&o.stop();const t=new _v(Ev.SHARE_AUDIO_NOT_ALLOWED);return i.onError(t),t.throw()}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&($k(s,o,t,t.encoderConfig&&Vv(t.encoderConfig)),t.encoderConfig&&"string"!=typeof t.encoderConfig&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const c=new wC(o,t.encoderConfig?Vv(t.encoderConfig):{},t.scalabiltyMode?Bv(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,s,[uE.SCREEN_TRACK]);if(!r)return i.onSuccess(c.getTrackId()),Av.info("create screen video track success","video:",c.getTrackId()),c;const l=new RT(r,void 0,ZT(8,"track-scr-a-"),!1,!0);return i.onSuccess([c.getTrackId(),l.getTrackId()]),Av.info("create screen video track success","video:",c.getTrackId(),"audio:",l.getTrackId()),[c,l]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CREATE_MIC_AND_CAM_TRACKS,options:[t,e]}),n=xw(e),s=Vw(t),o=ZT(8,"track-mic-"),r=ZT(8,"track-cam-");let a=null,c=null;Av.info("start create camera video track(".concat(r,") and microphone audio track(").concat(o,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{const t=await cb({audio:s,video:n},"".concat(o,"-").concat(r));a=t.getAudioTracks()[0],c=t.getVideoTracks()[0]}catch(t){throw i.onError(t),t}if(!a||!c){const t=new _v(Ev.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(t),t.throw()}e.optimizationMode&&$k(r,c,e,Uv(e.encoderConfig));const l=new IT(a,t,s,o),d=new CC(c,e,n,e.scalabiltyMode?Bv(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return i.onSuccess([l.getTrackId(),d.getTrackId()]),Av.info("create camera video track(".concat(r,") and microphone audio track(").concat(o,") success")),[l,d]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CREATE_MIC_AUDIO_TRACK,options:[t]}),i=Vw(t),n=ZT(8,"track-mic-");let s=null;Av.info("start create microphone audio track with config",JSON.stringify(t),"trackId",n);try{s=(await cb({audio:i},n)).getAudioTracks()[0]||null}catch(t){throw e.onError(t),t}if(!s){const t=new _v(Ev.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(t),t.throw()}const o=new IT(s,t,i,n);return e.onSuccess(o.getTrackId()),Av.info("create microphone audio track success, trackId:",n),o},createCustomAudioTrack:function(t){const e=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),i=new RT(t.mediaStreamTrack,t.encoderConfig?Fv(t.encoderConfig):{},ZT(8,"track-cus-"),!1,!0);return Av.info("create custom audio track success with config",t,"trackId",i.getTrackId()),e.onSuccess(i.getTrackId()),i},createBufferSourceAudioTrack:async function(t){const e=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CREATE_BUFFER_AUDIO_TRACK,options:[t]});if(Gv("DISABLE_WEBAUDIO"))throw new _v(Ev.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const i=ZT(8,"track-buf-");Av.info("start create buffer source audio track with config",JSON.stringify(t),"trackId",i);const n=t.source;if(!(t.source instanceof AudioBuffer))try{t.source=await Fk(t.source,t.cacheOnlineFile)}catch(t){return e.onError(t),t.throw()}const s=new Bk(t.source),o=new AT(n,s,t.encoderConfig?Fv(t.encoderConfig):{},i);return Av.info("create buffer source audio track success, trackId:",i),e.onSuccess(o.getTrackId()),o},setAppType:function(t){if(Av.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw Av.debug("Invalid appType"),new _v(Ev.INVALID_PARAMS,"invalid app type",t);Hv("APP_TYPE",Math.floor(t))},setLogLevel:function(t){Av.setLogLevel(t)},enableLogUpload:function(){Gv("USE_NEW_LOG")?Hv("UPLOAD_LOG",!0):Av.enableLogUpload()},disableLogUpload:function(){Gv("USE_NEW_LOG")?Hv("UPLOAD_LOG",!1):Av.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new Cw},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof RT||t instanceof sO)){const t=new _v(Ev.INVALID_TRACK,"the parameter is not a audio track");return i.onError(t),t.throw()}e&&e<1e3&&(e=1e3);const n=t instanceof RT?t.getTrackLabel():"remote_track",s=t.getVolumeLevel();let o=s,r=s;const a=Date.now();return new _h((s=>{const c=setInterval((()=>{const l=t.getVolumeLevel();o=l>o?l:o,r=l<r?l:r;const d=o-r>1e-4,h=Date.now()-a;if(d||h>e){clearInterval(c);const e=d,r={duration:h,deviceLabel:n,maxVolumeLevel:o,result:e};Av.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(r))),i.onSuccess(r),s(e)}}),200)}))},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=PS.reportApiInvoke(null,{tag:gf.TRACER,name:vf.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof wC||t instanceof nO)){const t=new _v(Ev.INVALID_TRACK,"the parameter is not a video track");return i.onError(t),t.throw()}const n=4;e&&e<1e3&&(e=1e3);const s=t instanceof wC?t.getTrackLabel():"remote_track",o=t.getMediaStreamTrack(!0),r=document.createElement("video");r.style.width="1px",r.style.height="1px",r.setAttribute("muted",""),r.muted=!0,r.setAttribute("playsinline",""),r.controls=!1,(Wu()||Fu())&&(r.style.opacity="0.01",r.style.position="fixed",r.style.left="0",r.style.top="0",document.body.appendChild(r)),r.srcObject=new MediaStream([o]),r.play();const a=document.createElement("canvas");a.width=160,a.height=120;let c=0,l=0;try{const t=Date.now();c=await zk(r,e,a,n),l=Date.now()-t}catch(t){throw i.onError(t),t}Wk===ku.SAFARI&&(r.pause(),r.remove()),r.srcObject=null;const d=c>n,h={duration:l,changedPicNum:c,deviceLabel:s,result:d};return Av.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(h))),i.onSuccess(h),d},setArea:qy,audioElementPlayCenter:mb,processExternalMediaAEC:function(t){Xk.processExternalMediaAEC(t)},registerExtensions:function(t){t.forEach((t=>{const e=t;e.__registered__=!0,e.logger.hookLog=Av.extLog,e.reporter.hookApiInvoke=PS.extApiInvoke,e.parameters&&Object.keys(e.parameters).forEach((t=>{e.parameters[t]=Gv(t)}))}))},ChannelMediaRelayError:rE,ChannelMediaRelayEvent:sE,ChannelMediaRelayState:oE,RemoteStreamFallbackType:vE,RemoteStreamType:mE,ConnectionDisconnectedReason:Cf,AudienceLatencyLevelType:wf,AREAS:_E});return Object.defineProperties(iL,{onAudioAutoplayFailed:{get:()=>CS.onAudioAutoplayFailed,set:t=>{CS.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>CS.onAutoplayFailed,set:t=>{CS.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>iL._onSecurityPolicyViolation,set(t){iL._onSecurityPolicyViolation=t,eL(t)}}}),ub.on(Ef.CAMERA_DEVICE_CHANGED,(t=>{Av.info("camera device changed",JSON.stringify(t)),iL.onCameraChanged&&iL.onCameraChanged(t),iL.safeEmit(HE.CAMERA_CHANGED,t)})),ub.on(Ef.RECORDING_DEVICE_CHANGED,(t=>{Av.info("microphone device changed",JSON.stringify(t)),iL.onMicrophoneChanged&&iL.onMicrophoneChanged(t),iL.safeEmit(HE.MICROPHONE_CHANGED,t)})),ub.on(Ef.PLAYOUT_DEVICE_CHANGED,(t=>{Av.debug("playout device changed",JSON.stringify(t)),iL.onPlaybackDeviceChanged&&iL.onPlaybackDeviceChanged(t),iL.safeEmit(HE.PLAYBACK_DEVICE_CHANGED,t)})),mb.onAutoplayFailed=()=>{Av.info("detect audio element autoplay failed"),CS.onAudioAutoplayFailed&&CS.onAudioAutoplayFailed()},GS.on("autoplay-failed",(()=>{Av.info("detect webaudio autoplay failed"),CS.onAudioAutoplayFailed&&CS.onAudioAutoplayFailed(),iL.safeEmit(HE.AUTOPLAY_FAILED)})),window&&(window.__ARTC__=iL),iL}()}(Di);var Mi=Pi(Di.exports);const xi="unknown",Ui="ios",Vi="android",Bi="windowsPhone",ji="vrHeadset";class Fi{static get platform(){return this.platform_||(this.platform_=this.getDevicePlatform()),this.platform_}static get isIOS(){return-1!==["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].indexOf(navigator.platform)||-1!==navigator.userAgent.indexOf("Mac")&&"ontouchend"in document}static get isVRHeadset(){return-1!==navigator.userAgent.indexOf("VR")||-1!==navigator.userAgent.indexOf("Quest")||-1!==navigator.userAgent.indexOf("Oculus")}static getDevicePlatform(){const t=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(t)?Bi:/android/i.test(t)?Vi:this.isIOS?Ui:this.isVRHeadset?ji:xi}}const Hi=1,Gi=2,$i=3,Wi=4,zi=5;class Ki{static setLevel(t){this.level_=t}static getLevel(){return x.flags.production?Hi:this.level_}static error(){this.getLevel()>=Hi&&console.error(...arguments)}static warn(){this.getLevel()>=Gi&&console.warn(...arguments)}static info(){this.getLevel()>=$i&&console.info(...arguments)}static log(){this.getLevel()>=Wi&&console.log(...arguments)}}Ki.level_=zi;class qi{static delete(t){this.isSessionStorageSupported()&&window.sessionStorage.removeItem(t)}static exist(t){if(this.isSessionStorageSupported())return void 0!==window.sessionStorage[t]}static get(t){let e=null;if(this.isSessionStorageSupported()&&void 0!==window.sessionStorage[t])try{e=JSON.parse(window.sessionStorage[t])}catch(e){console.log("SessionStorageService.get.error parsing",t,e)}return e}static set(t,e){if(this.isSessionStorageSupported())try{const i=[],n=JSON.stringify(e,(function(t,e){if("object"==typeof e&&null!==e){if(-1!==i.indexOf(e))return;i.push(e)}return e}));window.sessionStorage.setItem(t,n)}catch(i){console.log("SessionStorageService.set.error serializing",t,e,i)}}static isSessionStorageSupported(){if(this.supported)return!0;let t=!1;try{t="sessionStorage"in window&&null!==window.sessionStorage,t?(window.sessionStorage.setItem("test","1"),window.sessionStorage.removeItem("test")):t=!1}catch(e){t=!1}return this.supported=t,t}}class Yi{constructor(t,e,i){void 0===i&&(i=!1),this.user=t,this.mediaType=e,this.isLocal=i,this.clientInfo=null,this.texture=null,this.element=null,this.parentNode=null}get streamId(){return this.user?.uid.toString()}get hasVideo(){return this.user?.hasVideo}get hasAudio(){return this.user?.hasAudio}get videoTrack(){return this.user?.videoTrack}get audioTrack(){return this.user?.audioTrack}get video(){return!!this.videoTrack}get audio(){return!!this.audioTrack}get userMuteVideo(){return!!this.videoTrack&&this.videoTrack.muted}get userMuteAudio(){return!!this.audioTrack&&this.audioTrack.muted}getTracks(){const t=[];return this.user.hasVideo&&t.push(this.videoTrack),this.user.hasAudio&&t.push(this.audioTrack),t}async muteVideo(){this.videoTrack&&await this.videoTrack.setMuted(!0)}async unmuteVideo(){this.videoTrack&&await this.videoTrack.setMuted(!1)}async muteAudio(){this.audioTrack&&await this.audioTrack.setMuted(!0)}async unmuteAudio(){this.audioTrack&&await this.audioTrack.setMuted(!1)}getAudioLevel(){return this.audioTrack?this.audioTrack.getVolumeLevel():0}isPlaying(){return this.videoTrack?.isPlaying||this.audioTrack?.isPlaying}play(t){for(;t.childElementCount>0;)t.removeChild(t.firstElementChild);this.parentNode=t,"video"===this.mediaType?(this.videoTrack.play(t,{fit:"cover",mirror:void 0}),this.element=t.firstElementChild,Ki.log("Stream.play.videoTrack",t,this.element)):this.audioTrack&&!this.isLocal&&this.audioTrack.play()}stop(){this.videoTrack&&this.videoTrack.isPlaying&&this.videoTrack.stop(),this.audioTrack&&this.audioTrack.isPlaying&&this.audioTrack.stop()}close(){this.videoTrack&&this.videoTrack.close(),this.audioTrack&&this.audioTrack.close()}update(t){this.user=t.user,this.mediaType=t.mediaType}resume(t){Ki.log("Stream.resume",t,this.element),this.element&&t.appendChild(this.element)}}const Ji="client",Xi="editor";class Qi{static set editorStreams(t){this.editorStreams$.next(t)}static get editorStreams(){return this.editorStreams$.getValue()}static set editorScreens(t){this.editorScreens$.next(t)}static get editorScreens(){return this.editorScreens$.getValue()}static set local(t){this.local$.next(t)}static get local(){return this.local$.getValue()}static set screen(t){this.screen$.next(t)}static get screen(){return this.screen$.getValue()}static set remotes(t){this.remotes$.next(t)}static get remotes(){return this.remotes$.getValue()}static set peers(t){this.peers$.next(t)}static get peers(){return this.peers$.getValue()}static orderedRemotes$(){return i.combineLatest([Qi.remotes$,i.interval(1e3)]).pipe(n.map((t=>{const e=[];return t[0].forEach((t=>{let i=null,n=null,s=null,o=0,r=0,a=0;t.clientInfo&&(o=t.clientInfo.audioLevel=t.getAudioLevel(),r=t.clientInfo.peekAudioLevel=Math.max(t.clientInfo.audioLevel,.2),a=t.clientInfo.order,i=t.clientInfo.role||null,n=t.clientInfo.uid||null,s=t.clientInfo.screenUid||null),e.push({role:i,uid:n,screenUid:s,audioLevel:o,peekAudioLevel:r,order:a,remote:t})})),e.sort(((t,e)=>{const i=t.role===ie.Publisher?2:t.role===ie.Attendee?1:0;return(e.role===ie.Publisher?2:e.role===ie.Attendee?1:0)-i||e.peekAudioLevel-t.peekAudioLevel||(t.order||0)-(e.order||0)})),e.forEach(((t,e)=>{t.remote.clientInfo&&(t.remote.clientInfo.order=e)})),e})),n.distinctUntilChanged(((t,e)=>t.map((t=>`${t.uid}-${t.screenUid}`)).join("|")===e.map((t=>`${t.uid}-${t.screenUid}`)).join("|"))),n.map((t=>t.map((t=>t.remote)))))}static getEditorStreams$(){return i.of(null).pipe(n.switchMap((()=>{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&this.mode===Xi){const t=document.querySelector("body"),e=document.createElement("div"),i=document.createElement("video");e.setAttribute("id","stream-editor"),e.setAttribute("style","position:absolute; top: 5000px; line-height: 0;"),e.appendChild(i),t.appendChild(e),navigator.mediaDevices.getUserMedia({video:{width:800,height:450}}).then((t=>{"srcObject"in i?i.srcObject=t:i.src=window.URL.createObjectURL(t),i.oncanplay=()=>{const t={streamId:"editor",clientInfo:{role:ie.Publisher,uid:"editor"}},e={streamId:"editor",clientInfo:{role:ie.Attendee,uid:"editor"}},i={streamId:"editor",clientInfo:{role:ie.SmartDevice,uid:"editor"}};this.editorStreams$.next([t,e,e,e,e,i])},i.play()})).catch((t=>{console.log("EditorComponent.getUserMedia.error",t.name,t.message)}))}return this.editorStreams$})),n.shareReplay(1))}static getEditorScreens$(){return i.of(null).pipe(n.switchMap((()=>{if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia&&this.mode===Xi){const t=document.querySelector("body"),e=document.createElement("div"),i=document.createElement("video");e.setAttribute("id","stream-editor-screen"),e.setAttribute("style","position:absolute; top: 5000px; line-height: 0;"),e.appendChild(i),t.appendChild(e),navigator.mediaDevices.getDisplayMedia({screen:{width:800,height:450}}).then((t=>{"srcObject"in i?i.srcObject=t:i.src=window.URL.createObjectURL(t),i.oncanplay=()=>{const t={streamId:"editor-screen",clientInfo:{role:ie.Publisher,uid:"editor",screenUid:"editor-screen"}},e={streamId:"editor-screen",clientInfo:{role:ie.Attendee,uid:"editor",screenUid:"editor-screen"}};this.editorScreens$.next([t,e])},i.play()})).catch((t=>{console.log("EditorComponent.getUserMedia.error",t.name,t.message)}))}return this.editorScreens$})),n.shareReplay(1))}static get publisherStreamId(){const t=this.remotes.slice(),e=this.local;e&&t.unshift(e);const i=t.find((t=>t.clientInfo&&t.clientInfo.role===ie.Publisher&&t.clientInfo.uid===t.streamId));return i?i.streamId:null}static getPublisherStreamId$(){const t=this.publisherStreamId;return t?i.of(t):this.streams$.pipe(n.map((()=>this.publisherStreamId)),n.filter((t=>t)))}static get attendeeStreamId(){const t=this.remotes.slice(),e=this.local;e&&t.unshift(e);const i=t.find((t=>t.clientInfo&&t.clientInfo.role===ie.Attendee&&t.clientInfo.uid===t.streamId));return i?i.streamId:null}static getAttendeeStreamId$(){const t=this.attendeeStreamId;return t?i.of(t):this.streams$.pipe(n.map((()=>this.attendeeStreamId)),n.filter((t=>t)))}static getRemoteById(t){const e=Qi.remotes.find((e=>e.streamId===t));if(e)return e}static remoteAdd(t){const e=this.remotes.slice(),i=e.find((e=>e.streamId===t.streamId));i?i.update(t):e.push(t),this.remotes=e}static remoteRemove(t){const e=this.remotes.slice(),i=e.find((e=>e.streamId===t));return i&&(i.stop(),e.splice(e.indexOf(i),1),this.remotes=e),i}static remoteSetClientInfo(t,e){const i=this.remotes,n=i.find((e=>e.streamId===t));n&&(n.clientInfo=e),this.remotes=i}}Qi.mode=Ji,Qi.editorStreams$=new i.BehaviorSubject(null),Qi.editorScreens$=new i.BehaviorSubject(null),Qi.local$=new i.BehaviorSubject(null),Qi.screen$=new i.BehaviorSubject(null),Qi.remotes$=new i.BehaviorSubject([]),Qi.peers$=new i.BehaviorSubject([]),Qi.streams$=i.combineLatest([Qi.local$,Qi.screen$,Qi.remotes$,Qi.getEditorStreams$(),Qi.getEditorScreens$()]).pipe(n.map((t=>{const e=t[0],i=t[1],n=t[2],s=t[3],o=t[4];let r=n;return e&&(r=r.slice(),r.push(e)),i&&(r=r.slice(),r.push(i)),s&&r.push(...s),o&&r.push(...o),r})),n.shareReplay(1));class Zi extends class{constructor(){this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}once(t,e){const i=n=>{e(n),this.off(t,i)};this.on(t,i)}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}has(t){const e=this.events[t];return e&&e.length}}{static getSingleton(t){if(!R)return this.AGORA||(this.AGORA=new Zi(t)),this.AGORA}constructor(t){if(Zi.AGORA)throw"AgoraService is a singleton";super(),this.previousMuteAudio_=!1,this.channelState={},this.channelSnapshot={},this.onException=this.onException.bind(this),this.onUserJoined=this.onUserJoined.bind(this),this.onUserLeft=this.onUserLeft.bind(this),this.onUserPublished=this.onUserPublished.bind(this),this.onUserUnpublished=this.onUserUnpublished.bind(this),this.onUserInfoUpdated=this.onUserInfoUpdated.bind(this),this.onVolumeIndicator=this.onVolumeIndicator.bind(this),this.onConnectionStateChange=this.onConnectionStateChange.bind(this),this.onTokenPrivilegeWillExpire=this.onTokenPrivilegeWillExpire.bind(this),this.onTokenPrivilegeDidExpire=this.onTokenPrivilegeDidExpire.bind(this),this.onMessage=this.onMessage.bind(this);const e=ee.state;ee.patchState({devices:e.role!==ie.Attendee&&t?t:{videos:[],audios:[]},quality:Se(e),membersCount:0})}get isHostRole(){return ee.state.role===ie.Publisher||ee.state.role===ie.Attendee}get isAudienceRole(){return ee.state.role===ie.Viewer||ee.state.role===ie.SelfService}addStreamDevice(t){this.removeStreamDevice();const e={deviceId:"video-stream",label:"videostream",kind:"videostream",src:t},i={deviceId:"audio-stream",label:"videostream",kind:"videostream",src:t},n=ee.state.devices;n.videos.push(e),n.audios.push(i),ee.patchState({devices:n})}removeStreamDevice(){const t=ee.state.devices;t.videos=t.videos.filter((t=>"videostream"!==t.kind)),t.audios=t.audios.filter((t=>"videostream"!==t.kind)),ee.patchState({devices:t})}devices$(){const t=ee.state.devices,e=this.defaultVideos=this.defaultVideos||t.videos.slice(),n=this.defaultAudios=this.defaultAudios||t.videos.slice();t.videos=e.slice(),t.audios=n.slice();return i.from((async()=>{const e=await Mi.createCameraVideoTrack(),i=await Mi.createMicrophoneAudioTrack(),n=await Zi.getDevices();e.close(),i.close();for(let e=0;e<n.length;e++){const i=n[e];"videoinput"===i.kind&&i.deviceId&&t.videos.push({label:i.label||"camera-"+t.videos.length,deviceId:i.deviceId,kind:i.kind}),"audioinput"===i.kind&&i.deviceId&&t.audios.push({label:i.label||"microphone-"+t.audios.length,deviceId:i.deviceId,kind:i.kind})}if(t.videos.length>0||t.audios.length>0)return t;throw t})())}async connect(t){if(!ee.state.connecting){const e=ee.state.devices;t&&(e.video=t.video,e.audio=t.audio),ee.patchState({status:Ae,connecting:!0,devices:e}),setTimeout((async()=>{await this.createClient();const t=this.getChannelNameLink();Zi.rtcToken$(t).subscribe((async e=>{Ki.log("AgoraService.rtcToken$",e),await this.join(e.token,t)}))}),250)}return ee.state$}connect$(t){return i.from(this.connect(t)).pipe(n.switchMap((()=>ee.state$)))}membersCount$(t){const e=this.messageClient;return i.interval(3e3).pipe(n.switchMap((()=>i.from(e.getChannelMemberCount([t])))),n.map((e=>e[t])),n.catchError((t=>(Ki.error("AgoraService.membersCount$.error",t),i.of(0)))),n.distinctUntilChanged())}observeMemberCount(){this.unobserveMemberCount(),this.isHostRole&&(this.membersCountSubscription=this.membersCount$(ee.state.channelNameLink).subscribe((t=>{ee.patchState({membersCount:t})})))}unobserveMemberCount(){this.membersCountSubscription&&(this.membersCountSubscription.unsubscribe(),this.membersCountSubscription=null,ee.patchState({membersCount:0}))}async createClient(){if(this.client)return this.client;try{Mi.setLogLevel(2);const t=this.client=Mi.createClient({mode:"live",codec:"h264"});t.on("exception",this.onException),t.on("user-joined",this.onUserJoined),t.on("user-left",this.onUserLeft),t.on("user-published",this.onUserPublished),t.on("user-unpublished",this.onUserUnpublished),t.on("user-info-updated",this.onUserInfoUpdated),t.on("onTokenPrivilegeWillExpire",this.onTokenPrivilegeWillExpire),t.on("onTokenPrivilegeDidExpire",this.onTokenPrivilegeDidExpire);(this.messageClient=AgoraRTM.createInstance(x.appKey,{logFilter:AgoraRTM.LOG_FILTER_OFF})).setParameters({logFilter:AgoraRTM.LOG_FILTER_OFF}),Ki.log("AgoraService.createClient","client initialized");await t.setClientRole(this.isAudienceRole?"audience":"host"),x.flags.useProxy&&(t.startProxyServer(3),Ki.log("AgoraService.createClient.startProxyServer"))}catch(t){Ki.error("AgoraService.createClient.error",t),this.client=null}return this.client}getChannelNameLink(){let t=ee.state.link||"";const e=t.match(/(\d{9})-(\d{4})-(\d{13})/);e&&(t=`${e[1]}-${e[3]}`);return`${ee.state.channelName}-${t}`}static getUniqueUserId(){return(1e13*(100*(1+Math.floor(8*Math.random()))+10*(1+Math.floor(8*Math.random()))+1*(1+Math.floor(8*Math.random())))+Date.now()).toString()}async join(t,e){this.channel=null;const i=this.client,n=qi.get("bHereClientId")||Zi.getUniqueUserId();Ki.log("AgoraService.join",{token:t,channelNameLink:e,clientId:n});try{const s=await i.join(x.appKey,e,t,n);ee.patchState({status:Oe,channelNameLink:e,connected:!0,uid:s}),qi.set("bHereClientId",s),Zi.rtmToken$(s).subscribe((async t=>{try{if(await this.joinMessageChannel(t.token,s),!this.isAudienceRole){const t=await this.autoDetectDevice();await this.createMediaStream(s,t.video,t.audio)}this.observeMemberCount()}catch(t){Ki.error("AgoraService.join.joinMessageChannel.error",t)}}))}catch(t){Ki.error("AgoraService.join.error",t),"DYNAMIC_KEY_EXPIRED"===t&&Zi.rtcToken$(e).subscribe((async t=>{await this.join(t.token,e)}))}}joinMessageChannel(t,e){let i;return new Promise(((n,s)=>{const o=this.messageClient;Ki.log("AgoraService.joinMessageChannel",o),o.login({token:t,uid:e.toString()}).then((()=>(Ki.log("AgoraService.joinMessageChannel.login.success"),i=o.createChannel(ee.state.channelNameLink),i.join()))).then((()=>{this.channel=i,i.on("ChannelMessage",this.onMessage),this.emit("channel",i),n(e),Ki.log("AgoraService.joinMessageChannel.join.success"),i.getMembers().then((t=>{t=t.filter((t=>t!==e.toString()));const i={type:Le,members:t};this.broadcastMessage(i),Ki.log("AgoraService.joinMessageChannel.members",i)})),Ki.log("AgoraService.joinMessageChannel",ee.state.channelNameLink)})).catch((t=>{Ki.error("AgoraService.joinMessageChannel.error",t),s(t)}))}))}detectDevices(t){Zi.getDevices().then((e=>{const i=[],n=[];for(let t=0;t<e.length;t++){const s=e[t];"videoinput"==s.kind&&i.push({label:s.label||"camera-"+i.length,deviceId:s.deviceId,kind:s.kind}),"audioinput"==s.kind&&n.push({label:s.label||"microphone-"+i.length,deviceId:s.deviceId,kind:s.kind})}t({videos:i,audios:n})})).catch((t=>{Ki.error("AgoraService.detectDevices",t)}))}getVideoOptions(t,e){return new Promise(((i,n)=>{if(e)if("videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";var s=new Hls;s.attachMedia(n),s.on(Hls.Events.MEDIA_ATTACHED,(()=>{s.loadSource(e.src),s.on(Hls.Events.MANIFEST_PARSED,((e,s)=>{n.play().then((e=>{const s=n.captureStream();t.videoSource=s.getVideoTracks()[0],i(t)}),(t=>{Ki.error("AgoraService.getVideoOptions.error",t)}))}))}))}else if("videoplayer"===e.kind||"videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";const s=n.captureStream();t.videoSource=s.getVideoTracks()[0],i(t)}else t.cameraId=e.deviceId,i(t);else i(t)}))}getAudioOptions(t,e){return new Promise(((i,n)=>{if(e)if("videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";var s=new Hls;s.attachMedia(n),s.on(Hls.Events.MEDIA_ATTACHED,(()=>{s.loadSource(e.src),s.on(Hls.Events.MANIFEST_PARSED,((e,o)=>{s.loadLevel=o.levels.length-1,n.play().then((e=>{const s=n.captureStream();t.audioSource=s.getAudioTracks()[0],i(t)}),(t=>{Ki.error("AgoraService.getAudioOptions.error",t)}))}))}))}else if("videoplayer"===e.kind||"videostream"===e.kind){const n=document.querySelector("#"+e.deviceId);n.crossOrigin="anonymous";const s=n.captureStream();t.audioSource=s.getAudioTracks()[0],i(t)}else t.microphoneId=e.deviceId,i(t);else i(t)}))}async autoDetectDevice(){const t=ee.state;if(t.role===ie.SmartDevice){const t=await Zi.getDevices(),e={videos:[],audios:[],video:null,audio:null};return t.forEach((t=>{"videoinput"===t.kind?e.videos.push(t):"audioinput"===t.kind&&e.audios.push(t)})),e.video=e.videos[0]||null,e.audio=e.audios[0]||null,ee.patchState({devices:e}),e}return t.devices}async createMediaStream(t,e,i){const n={streamID:t,video:Boolean(e),audio:Boolean(i),screen:!1};await this.getVideoOptions(n,e),await this.getAudioOptions(n,i);const s=Object.assign({},ee.state.quality);await this.createLocalStreamWithOptions(n,s)}async createLocalStreamWithOptions(t,e){try{let i,n;Ki.log("AgoraService.createLocalStreamWithOptions",t,e),t.video&&(i=await Mi.createCameraVideoTrack({cameraId:t.cameraId,encoderConfig:e.profile})),t.audio&&(n=await Mi.createMicrophoneAudioTrack({microphoneId:t.microphoneId}));const s={uid:t.streamID,videoTrack:i,audioTrack:n,hasVideo:void 0!==i,hasAudio:void 0!==n},o=new Yi(s,t.video?"video":"audio",!0);Qi.local=o,setTimeout((async()=>{await this.publishLocalStream()}),1),Ki.log("AgoraService.createLocalStreamWithOptions.success",o)}catch(t){Ki.error("AgoraService.createLocalStreamWithOptions.error",t)}}async publishLocalStream(){try{Ki.log("AgoraService.publishLocalStream");const t=await this.setUserState(),e=Qi.local,i=this.client;await i.publish(e.getTracks()),e.clientInfo=t,Qi.local=e}catch(t){throw Ki.error("AgoraService.publishLocalStream.error",t),t}}async unpublishLocalStream(){try{Ki.log("AgoraService.unpublishLocalStream");const t=this.client,e=Qi.local;e&&await t.unpublish(e.getTracks()),await this.clearLocalUserAttributes(),Qi.local=null}catch(t){throw Ki.error("AgoraService.unpublishLocalStream.error",t),t}}async closeLocalStream(){try{const t=Qi.local;t&&await t.close(),await this.clearLocalUserAttributes(),Qi.local=null,Ki.log("AgoraService.closeLocalStream",t)}catch(t){throw Ki.error("AgoraService.closeLocalStream.error",t),t}}async leaveChannel(){try{ee.patchState({connecting:!1}),await this.closeLocalStream(),await this.closeScreenStream(),Qi.remotes=[],Qi.peers=[],await this.leaveMessageChannel(),await this.leaveClient(),await this.leaveScreenClient()}catch(t){throw Ki.error("AgoraService.leaveChannel.error",t),t}}leaveClient(){return new Promise(((t,e)=>{const i=this.client;i?i.leave((()=>{this.client=null,x.flags.useProxy&&(i.stopProxyServer(),Ki.log("AgoraService.leaveClient.stopProxyServer")),t()}),(t=>{Ki.error("AgoraService.leaveClient.error",t),e(t)})):t()}))}leaveMessageChannel(){return new Promise(((t,e)=>{{this.unobserveMemberCount();const i=this.channel;if(!i)return t();const n=this.messageClient;i.leave().then((()=>{this.channel=null,n.logout().then((()=>{this.messageClient=null,t()}),e)}),e)}}))}async toggleCamera(){const t=Qi.local;t&&t.video&&(t.userMuteVideo?(await t.unmuteVideo(),ee.patchState({cameraMuted:!1}),this.broadcastEvent(new _i({streamId:t.streamId})),this.setUserState()):(await t.muteVideo(),ee.patchState({cameraMuted:!0}),this.broadcastEvent(new Ei({streamId:t.streamId})),this.setUserState()))}async toggleAudio(){const t=Qi.local;t&&t.audio&&(t.userMuteAudio?(await t.unmuteAudio(),ee.patchState({audioMuted:!1}),this.broadcastEvent(new bi({streamId:t.streamId})),this.setUserState()):(await t.muteAudio(),ee.patchState({audioMuted:!0}),this.broadcastEvent(new Si({streamId:t.streamId})),this.setUserState()))}setAudio(t){const e=Qi.local;e&&e.audio&&(t?(this.previousMuteAudio_=e.userMuteAudio,e.userMuteAudio||(e.muteAudio(),ee.patchState({audioMuted:!0}),this.broadcastEvent(new Si({streamId:e.streamId})),this.setUserState())):e.userMuteAudio&&!this.previousMuteAudio_&&(e.unmuteAudio(),ee.patchState({audioMuted:!1}),this.broadcastEvent(new bi({streamId:e.streamId})),this.setUserState()))}toggleMode(){const t=ee.state.mode===li?di:li;ee.patchState({mode:t}),ki.send({type:Be,mode:t}),this.setChannelState({mode:t})}toggleNavInfo(){const t=!ee.state.showNavInfo;ee.patchState({showNavInfo:t}),ki.send({type:je,showNavInfo:t})}requestControl(t){return new Promise(((e,i)=>{this.sendRequestControl(t).then((t=>{ee.patchState({controlling:t,spying:!1}),e(t),this.setChannelState({controlling:t,spying:""})}))}))}requestSpy(t){return new Promise(((e,i)=>{this.sendRequestSpy(t).then((t=>{ee.patchState({spying:t,controlling:!1}),e(t),this.setChannelState({spying:t,controlling:""})}))}))}dismissControl(t){return void 0===t&&(t=!1),new Promise(((e,i)=>{const n=ee.state.controlling;n?this.sendRequestControlDismiss(n).then((()=>{ee.patchState({controlling:!1}),e(n),t||this.setChannelState({controlling:""})})):e(!1)}))}dismissSpy(t){return void 0===t&&(t=!1),new Promise(((e,i)=>{const n=ee.state.spying;n?this.sendRequestSpyDismiss(n).then((()=>{ee.patchState({spying:!1}),e(n),t||this.setChannelState({spying:""})})):e(!1)}))}toggleControl(t){this.dismissSpy(!0).then((()=>{this.dismissControl(!0).then((e=>{e!==t?this.requestControl(t).then((t=>{Ki.log("AgoraService.toggleControl",t)})):this.setChannelState({controlling:""})}))}))}toggleSpy(t){this.dismissControl(!0).then((()=>{this.dismissSpy(!0).then((e=>{e!==t?this.requestSpy(t).then((t=>{Ki.log("AgoraService.toggleSpy",t)})):this.setChannelState({spying:""})}))}))}sendRequestControl(t){return new Promise(((e,i)=>{this.sendMessage({type:qe,controllingId:t}).then((()=>{e(t)}))}))}sendRequestSpy(t){return new Promise(((e,i)=>{this.sendMessage({type:Je,spyingId:t}).then((()=>{e(t)}))}))}sendRequestControlDismiss(t){return new Promise(((e,i)=>{this.sendMessage({type:Ye,controllingId:t}).then((()=>{e(t)}))}))}sendRequestSpyDismiss(t){return new Promise(((e,i)=>{this.sendMessage({type:Xe,spyingId:t}).then((()=>{e(t)}))}))}toggleSilence(){const t=!ee.state.silencing;this.sendMessage({type:Ke,silencing:t}),ee.patchState({silencing:t})}newMessageId(){return`${ee.state.uid}-${Date.now().toString()}`}navToView(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=!1),ee.state.controlling!==ee.state.uid&&ee.state.spying!==ee.state.uid||this.sendMessage({type:$e,viewId:t,keepOrientation:e,useLastOrientation:i})}getSessionStats(){this.client.getSessionStats((t=>{Ki.log(`\nAgoraService.getSessionStats\n\tDuration: ${t.Duration}\n\tUserCount: ${t.UserCount}\n\tSendBytes: ${t.SendBytes}\n\tRecvBytes: ${t.RecvBytes}\n\tSendBitrate: ${t.SendBitrate}\n\tRecvBitrate: ${t.RecvBitrate}\n`)}))}getSystemStats(){this.client.getSystemStats((t=>{Ki.log(`\nAgoraService.getSystemStats\n\t\t\tBatteryLevel: ${t.BatteryLevel}\n`)}))}sendMessage(t){return new Promise(((e,i)=>{if(ee.state.connected){switch(t.clientId=ee.state.uid,t.type){case xe:case Ue:case Ve:case Be:case je:case Fe:case He:case Ge:case $e:case We:case ze:case Qe:case ti:case ei:case oi:case ri:case ai:case ci:case Ze:if(ee.state.controlling!==ee.state.uid&&ee.state.spying!==ee.state.uid)return}const n=t=>{switch(e(t),t.type){case qe:this.broadcastMessage(t);break;case Ze:this.setChannelSnapshot(t)}},s=(t,e)=>{Ki.log("AgoraService.sendMessage",t);try{const i=JSON.stringify(t);t.messageId&&this.once(`message-${t.messageId}`,(t=>{n(t)})),e.sendMessage({text:i}).then((()=>{t.messageId||n(t)})).catch((t=>{Ki.error("AgoraService.sendMessage.error",t)}))}catch(t){Ki.error("AgoraService.sendMessage.error",t)}},o=this.channel;if(o)s(t,o);else try{this.once("channel",(e=>{s(t,e)}))}catch(t){Ki.error("AgoraService.sendMessage.error",t),i(t)}}else Ki.error("AgoraService.sendMessage.error","not connected")}))}getChannelAttributes(){return Ki.log("AgoraService.getChannelAttributes"),new Promise(((t,e)=>{const i=this.messageClient;if(i){i.getChannelAttributes(ee.state.channelNameLink).then((e=>{Ki.log("AgoraService.getChannelAttributes",e),t(e)})).catch((e=>{Ki.error("AgoraService.getChannelAttributes.error",e),t({})}))}else Ki.error("AgoraService.getChannelAttributes.noop"),t({})}))}getChannelAttributesByKeys(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return Ki.log("AgoraService.getChannelAttributesByKeys",e),new Promise(((t,i)=>{const n=this.messageClient;if(n){n.getChannelAttributes(ee.state.channelNameLink,e).then((e=>{Ki.log("AgoraService.getChannelAttributesByKeys",e);const i={};Object.keys(e).forEach((t=>{i[t]=e[t].value})),t(i)})).catch((e=>{Ki.error("AgoraService.getChannelAttributesByKeys.error",e),t({})}))}else Ki.error("AgoraService.getChannelAttributesByKeys.noop",e),t({})}))}getChannelMessages(){return Ki.log("AgoraService.getChannelMessages"),i.from(this.getChannelAttributes()).pipe(n.map((t=>Object.keys(t).filter((t=>0===t.indexOf("message-"))).map((e=>t[e])))),n.map((t=>{t.sort(((t,e)=>t.lastUpdateTs-e.lastUpdateTs));const e=t.map((t=>JSON.parse(t.value)));return Ki.log("AgoraService.getChannelMessages",e),e})),n.catchError((t=>(Ki.error("AgoraService.getChannelMessages.error",t),i.of([])))))}addOrUpdateChannelAttributes(t){return Ki.log("AgoraService.addOrUpdateChannelAttributes",t),new Promise(((e,i)=>{const n=this.messageClient;if(n&&Object.keys(t).length>0){n.addOrUpdateChannelAttributes(ee.state.channelNameLink,t,{enableNotificationToChannelMembers:!1}).then((()=>{Ki.log("AgoraService.addOrUpdateChannelAttributes",t)})).catch((t=>{Ki.error("AgoraService.addOrUpdateChannelAttributes.error",t)})).finally((()=>{e()}))}else Ki.error("AgoraService.addOrUpdateChannelAttributes.noop",t),e()}))}getInitialSession(){this.getChannelSession().then((t=>{ee.patchState(t.state),t.state.controlling&&t.snapshot&&this.broadcastMessage(t.snapshot),window.dispatchEvent(new Event("resize"))}))}getChannelSession(){return Ki.log("AgoraService.getChannelSession"),new Promise(((t,e)=>{this.getChannelAttributesByKeys("channelState","channelSnapshot").then((e=>{const i={state:{},snapshot:{}};if(e.channelState){const t=JSON.parse(e.channelState);this.channelState=t,i.state=t}if(e.channelSnapshot){const t=JSON.parse(e.channelSnapshot);this.channelSnapshot=t,i.snapshot=t}Ki.log("AgoraService.getChannelSession",i),t(i)})).catch((e=>{Ki.error("AgoraService.getChannelSession.error",e),t({})}))}))}getChannelState(){return Ki.log("AgoraService.getChannelState"),new Promise(((t,e)=>{this.getChannelAttributesByKeys("channelState").then((e=>{if(e.channelState){const i=JSON.parse(e.channelState);this.channelState=i,Ki.log("AgoraService.getChannelState",i),t(i)}else t({})})).catch((e=>{Ki.error("AgoraService.getChannelState.error",e),t({})}))}))}setChannelState(t){const e=de(de({},this.channelState||{}),t);return Ki.log("AgoraService.setChannelState",t,e),this.addOrUpdateChannelAttributes({channelState:JSON.stringify(e)})}getChannelSnapshot(){return Ki.log("AgoraService.getChannelSnapshot"),new Promise(((t,e)=>{this.getChannelAttributesByKeys("channelSnapshot").then((e=>{if(e.channelSnapshot){const i=JSON.parse(e.channelSnapshot);this.channelSnapshot=i,Ki.log("AgoraService.getChannelSnapshot",i),t(i)}else t({})})).catch((e=>{Ki.error("AgoraService.getChannelSnapshot.error",e),t({})}))}))}setChannelSnapshot(t){const e=de(de({},this.channelSnapshot||{}),t);return Ki.log("AgoraService.setChannelSnapshot",t,e),this.addOrUpdateChannelAttributes({channelSnapshot:JSON.stringify(e)})}padStart(t,e,i){void 0===e&&(e=5),void 0===i&&(i="0");const n=String(t);return n.length>=e?n:new Array(e-n.length+1).join(i)+n}addOrUpdateChannelMessages(t){const e={};return t.forEach((t=>{const i=Math.floor(1e4*Math.random()),n=`message-${t.date}-${this.padStart(i)}`;e[n]=JSON.stringify(t)})),this.addOrUpdateChannelAttributes(e)}deleteChannelAttributesByKeys(t){return Ki.log("AgoraService.deleteChannelAttributesByKeys",t),new Promise(((e,i)=>{const n=this.messageClient;if(n&&t.length>0){n.deleteChannelAttributesByKeys(ee.state.channelNameLink,t,{enableNotificationToChannelMembers:!1}).then((()=>{Ki.log("AgoraService.deleteChannelAttributesByKeys",t),e()})).catch((t=>{Ki.error("AgoraService.deleteChannelAttributesByKeys.error",t),i(t)}))}else Ki.error("AgoraService.deleteChannelAttributesByKeys.noop",t),i("missing rtm client or keys")}))}setUserState(){const t={role:ee.state.role,name:ee.state.name,uid:ee.state.uid,screenUid:ee.state.screenUid,cameraMuted:ee.state.cameraMuted,audioMuted:ee.state.audioMuted};return Ki.log("AgoraService.setUserState",t),this.addOrUpdateLocalUserAttributes({clientInfo:JSON.stringify(t)}).then((()=>t))}getUserState(t){return this.getUserAttributes(t).then((t=>{const e=JSON.parse(t.clientInfo||"");return Ki.log("AgoraService.getUserState",e),e}))}addOrUpdateLocalUserAttributes(t){return Ki.log("AgoraService.addOrUpdateLocalUserAttributes",t),new Promise(((e,i)=>{const n=this.messageClient;if(n&&Object.keys(t).length>0){n.addOrUpdateLocalUserAttributes(t).then((()=>{Ki.log("AgoraService.addOrUpdateLocalUserAttributes",t),e()})).catch((t=>{Ki.error("AgoraService.addOrUpdateLocalUserAttributes.error",t),i(t)}))}else Ki.error("AgoraService.addOrUpdateLocalUserAttributes.noop",t),i("missing rtm client or attributes")}))}getUserAttributes(t){return Ki.log("AgoraService.getUserAttributes",t),new Promise(((e,i)=>{const n=this.messageClient;if(n){n.getUserAttributes(t).then((t=>{Ki.log("AgoraService.getUserAttributes",t),e(t)})).catch((t=>{Ki.error("AgoraService.getUserAttributes.error",t),i(t)}))}else Ki.error("AgoraService.getUserAttributes","missing rtm client"),i("missing rtm client")}))}clearLocalUserAttributes(){return Ki.log("AgoraService.clearLocalUserAttributes"),new Promise(((t,e)=>{const i=this.messageClient;if(i){i.clearLocalUserAttributes().then((()=>{Ki.log("AgoraService.clearLocalUserAttributes"),t()})).catch((e=>{Ki.error("AgoraService.clearLocalUserAttributes.error",e),t()}))}else t()}))}checkBroadcastMessage(t){switch(t.type){case Ye:ee.patchState({controlling:!1}),t.controllingId===ee.state.uid&&this.closeScreenStream();break;case Xe:ee.patchState({spying:!1});break;case Ze:(ee.state.role===ie.Publisher||ee.state.controlling&&ee.state.controlling!==ee.state.uid)&&this.broadcastMessage(t);break;case Ke:ee.state.role===ie.Streamer&&this.broadcastMessage(t);break;case xe:case Ue:case Ve:case Be:case je:case Fe:case He:case Ge:case $e:case We:case ze:case Qe:case ti:case ei:case oi:case ri:case ai:case ci:(ee.state.controlling&&ee.state.controlling!==ee.state.uid||ee.state.spying&&ee.state.spying!==ee.state.uid)&&this.broadcastMessage(t);break;default:this.broadcastMessage(t)}}broadcastMessage(t){ki.out(t)}broadcastEvent(t){ki.out({type:ke,event:t})}peerAdd(t){Ki.log("AgoraService.peerAdd",t);const e={uid:t},i=Qi.peers;i.push(e),Qi.peers=i,this.broadcastEvent(new vi({peer:e}))}peerRemove(t){Ki.log("AgoraService.peerRemove",t);const e=Qi.peers,i=e.find((e=>e.uid===t));i&&(e.splice(e.indexOf(i),1),Qi.peers=e)}onMessage(t,e){if(e!==ee.state.uid){Ki.log("AgoraService.onMessage",t.text,e);const i=JSON.parse(t.text);if(i.messageId&&this.has(`message-${i.messageId}`)&&this.emit(`message-${i.messageId}`,i),i.remoteId&&i.remoteId!==ee.state.uid&&i.remoteId!==ee.state.screenUid)return;if(i.type===ri){const t=document.createElement("div");t.classList.add("player__vr"),i.container=t}this.checkBroadcastMessage(i)}else Ki.log("AgoraService.onMessage",t.text)}onException(t){Ki.error("AgoraService.onException",t)}async onUserJoined(t){Ki.log("AgoraService.onUserJoined",t),this.peerAdd(t.uid)}async onUserLeft(t,e){Ki.log("AgoraService.onUserLeft",t,e);const i=t.uid.toString();if(i!==ee.state.uid){const t=this.remoteRemove(i);t&&t.clientInfo&&(t.clientInfo.role===ie.Publisher?ee.state.role===ie.SelfService?ee.patchState({hosted:!0,controlling:!1,spying:!1,silencing:!1}):ee.patchState({hosted:!1,controlling:!1,spying:!1,silencing:!1}):(ee.state.controlling===i&&ee.patchState({controlling:!1}),ee.state.spying===i&&ee.patchState({spying:!1})))}this.peerRemove(i)}async onUserPublished(t,e){const i=t.uid.toString();if(Ki.log("AgoraService.onUserPublished",i,t,e),i!==ee.state.uid&&i!==ee.state.screenUid){await this.client.subscribe(t,e);const i=new Yi(t,e);await this.remoteAdd(i)}else{const t={role:ee.state.role,name:ee.state.name,uid:ee.state.uid,screenUid:ee.state.screenUid},e=Qi.local;e.clientInfo=t,Qi.local=e}}async remoteAdd(t){Ki.log("AgoraService.remoteAdd",t),Qi.remoteAdd(t),this.broadcastEvent(new gi({stream:t}));const e=t.streamId;setTimeout((async()=>{const t=await this.getUserState(e);if(Ki.log("AgoraService.remoteAdd.getUserState",t),Qi.remoteSetClientInfo(e,t),t.cameraMuted&&this.broadcastEvent(new Ei({streamId:e})),t.audioMuted&&this.broadcastEvent(new Si({streamId:e})),t.role===ie.Publisher){const t={hosted:!0};ee.patchState(t),this.getInitialSession()}}),100)}async onUserUnpublished(t,e){const i=t.uid.toString();Ki.log("AgoraService.onUserUnpublished",i,t,e),i===ee.state.uid?Qi.local=null:i===ee.state.screenUid?Qi.screen=null:"video"===e?this.remoteRemove(i):"audio"===e&&t.audioTrack?.stop()}remoteRemove(t){const e=Qi.remoteRemove(t);return e&&e.clientInfo&&e.clientInfo.role===ie.Publisher&&e.clientInfo.screenUid!==t&&ee.patchState({hosted:!1}),e}onUserInfoUpdated(t){switch(Ki.log("AgoraService.onUserInfoUpdated",t),t.msg){case"mute-audio":this.broadcastEvent(new Si({streamId:t.uid}));break;case"unmute-audio":this.broadcastEvent(new bi({streamId:t.uid}));break;case"mute-video":this.broadcastEvent(new Ei({streamId:t.uid}));break;case"unmute-video":this.broadcastEvent(new _i({streamId:t.uid}))}this.broadcastEvent(new fi({streamId:t.uid,message:t.msg}))}onVolumeIndicator(t){const e=t.attr.map((t=>({streamId:t.uid,level:t.level})));this.broadcastEvent(new Ti({streams:e}))}onConnectionStateChange(t){Ki.log("AgoraService.onConnectionStateChange",t)}onTokenPrivilegeWillExpire(t){Ki.log("AgoraService.onTokenPrivilegeWillExpire");const e=this.client,i=this.getChannelNameLink();Zi.rtcToken$(i).subscribe((async t=>{t.token&&(await e.renewToken(t.token),Ki.log("AgoraService.onTokenPrivilegeWillExpire.renewed"))}))}onTokenPrivilegeDidExpire(t){Ki.log("AgoraService.onTokenPrivilegeDidExpire");const e=this.client,i=this.getChannelNameLink();Zi.rtcToken$(i).subscribe((async t=>{t.token&&(await e.renewToken(t.token),Ki.log("AgoraService.onTokenPrivilegeDidExpire.renewed"))}))}toggleScreen(){Qi.screen?this.closeScreenStream():this.screenClient?this.createScreenStream(ee.state.screenUid):this.createScreenClient().then((()=>{const t=this.getChannelNameLink();Zi.rtcToken$(t).subscribe((async e=>{Ki.log("AgoraService.toggleScreen.rtcToken$",e),await this.screenJoin(e.token,t)}))}))}async createScreenClient(){if(this.screenClient)return this.screenClient;try{const t=this.screenClient=Mi.createClient({mode:"live",codec:"h264"});t.on("error",this.onScreenError),t.on("stream-published",this.onScreenStreamPublished),t.on("stream-unpublished",this.onScreenStreamUnpublished),x.flags.useProxy&&(t.startProxyServer(3),Ki.log("AgoraService.createScreenClient.startProxyServer"))}catch(t){Ki.error("AgoraService.createScreenClient.error",t),this.screenClient=null}return this.screenClient}async screenJoin(t,e){const i=this.screenClient,n=Zi.getUniqueUserId();try{const s=await i.join(x.appKey,e,t,n);Ki.log("AgoraService.screenJoin",s),ee.patchState({screenUid:s}),this.createScreenStream(s)}catch(t){Ki.error("AgoraService.screenJoin.error",t),"DYNAMIC_KEY_EXPIRED"===t&&Zi.rtcToken$(e).subscribe((async t=>{await this.screenJoin(t.token,e)}))}}createScreenStream(t){const e={streamID:t,audio:!1,video:!1,screen:!0},i=Mi.createStream(e);i.setScreenProfile(x.profiles.screen),Ki.log("AgoraService.createScreenStream",e);const n=()=>{this.closeScreenStream()};i.init((()=>{Qi.screen=i,i.on("stopScreenSharing",n),i.muteAudio(),setTimeout((()=>{this.publishScreenStream()}),1)}),(function(t){Ki.error("AgoraService.createScreenStream.screen.init.error",t)}))}async publishScreenStream(){try{Ki.log("AgoraService.publishScreenStream");const t=await this.setUserState(),e=Qi.screen,i=this.screenClient;await i.publish(e.getTracks()),e.clientInfo=t,Qi.screen=e}catch(t){throw Ki.error("AgoraService.publishScreenStream.error",t),t}}async unpublishScreenStream(){try{const t=this.screenClient,e=Qi.screen;t&&e&&await t.unpublish(e.getTracks()),Qi.screen=null,Ki.log("AgoraService.unpublishScreenStream",e)}catch(t){throw Ki.error("AgoraService.unpublishScreenStream.error",t),t}}async closeScreenStream(){try{const t=Qi.screen;t&&await t.close(),Qi.screen=null,Ki.log("AgoraService.closeScreenStream",t)}catch(t){throw Ki.error("AgoraService.closeScreenStream.error",t),t}}leaveScreenClient(){return new Promise(((t,e)=>{const i=this.screenClient;i?i.leave((()=>{this.screenClient=null,x.flags.useProxy&&(i.stopProxyServer(),Ki.log("AgoraService.leaveScreenClient.stopProxyServer")),t()}),(t=>{Ki.error("AgoraService.leaveScreenClient.error",t),e(t)})):t()}))}onScreenError(t){Ki.error("AgoraService.onScreenError",t)}onScreenStreamPublished(t){const e=Qi.screen;e.clientInfo={role:ee.state.role,name:ee.state.name,uid:ee.state.uid,screenUid:ee.state.screenUid},Qi.screen=e}onScreenStreamUnpublished(t){Qi.screen=null}static rtcToken$(t){return x.flags.useToken?yi.post$("/api/token/rtc",{channelName:t,uid:null}):i.of({token:null})}static rtmToken$(t){return x.flags.useToken?yi.post$("/api/token/rtm",{uid:t}):i.of({token:null})}static checkRtcConnection(){return new Promise(((t,e)=>{try{const i=Mi.createClient({mode:"live",codec:"h264"});x.flags.useProxy&&i.startProxyServer(3),Zi.checkRtcTryJoin(i).then((e=>{t(e)})).catch((t=>{e(t)})).finally((()=>{i.leave((()=>{x.flags.useProxy&&i.stopProxyServer()}),(()=>{}))}))}catch(t){e(t)}}))}static checkRtcTryJoin(t){return new Promise(((e,i)=>{const n="checkRtcConnection";Zi.rtcToken$(n).subscribe((async s=>{try{const i=await t.join(x.appKey,n,s.token,null);e(i)}catch(e){if("DYNAMIC_KEY_EXPIRED"===e)return Zi.checkRtcTryJoin(t);Ki.error("AgoraService.checkRtcConnection.error",e),i(e)}}),(t=>i(t)))}))}static checkRtmConnection(t){return new Promise(((e,i)=>{try{let n,s=AgoraRTM.createInstance(x.appKey,{logFilter:AgoraRTM.LOG_FILTER_OFF});s.setParameters({logFilter:AgoraRTM.LOG_FILTER_OFF}),Zi.rtmToken$(t).subscribe((o=>{s.login({token:o.token,uid:t.toString()}).then((()=>{n=s.createChannel("checkRtcConnection"),n.join().then((()=>{e(t),n.leave()})).catch((t=>{i(t)})).finally((()=>{n.leave().then((()=>{n=null,s.logout().then((()=>{s=null})).catch((()=>{}))})).catch((()=>{}))}))})).catch((t=>{Ki.error("checkRtmConnection.error",t),i(t)})).finally((()=>{s&&s.logout().then((()=>{s=null})).catch((()=>{}))}))}),(t=>i(t)))}catch(t){i(t)}}))}static async getDevices(){let t=Zi.devices_;if(t)return t;{t=Zi.devices_=[];const e={audio:!0,video:!0};if(Fi.platform===Ui&&(e.video={facingMode:"user"}),Fi.platform===ji&&(e.video=!1),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const i=await navigator.mediaDevices.getUserMedia(e),n=await navigator.mediaDevices.enumerateDevices();return i.getTracks().forEach((t=>{t.stop()})),n.forEach((e=>{t.push(e)})),t}throw"Media device not available"}}static fixLegacy(){["moz","webkit"].forEach((t=>{Ki.log("AgoraService.fixLegacy",`${t}RTC`),Object.getOwnPropertyNames(window).filter((t=>0===t.indexOf("RTC"))).map((e=>{const i=`${t}${e}`;void 0!==window[e]&&void 0===window[i]&&(window[i]=window[e])}))}))}}class tn{constructor(t,e,i){this.type=Pe,this.clientId_=e,"string"==typeof t?(this.date=Date.now(),this.clientId=e,this.name=i,this.message=t):"object"==typeof t&&(this.date=t.date,this.clientId=t.clientId,this.name=t.name,this.message=t.message);const n=this.name.split(" ");this.shortName=n[0].substr(0,1).toUpperCase()+(n.length>1?n[1]:n[0]).substr(0,1).toUpperCase()}get me(){return this.clientId===this.clientId_}getPayload(){return{date:this.date,clientId:this.clientId,name:this.name,message:this.message}}getCopy(){return new tn({date:this.date,clientId:this.clientId,name:this.name,message:this.message},this.clientId_)}}class en extends t.Component{constructor(){super(...arguments),this.typings_=!1}onInit(){this.rows=1,this.showEmoji=!1,this.demo=-1!==window.location.pathname.indexOf("layout");const t=this.form=new e.FormGroup({message:null});if(this.controls=t.controls,t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.checkTypings(t),this.pushChanges()})),ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.type){case Pe:this.pushMessage(new tn(t,ee.state.uid,ee.state.name));break;case De:this.typingBegin(t);break;case Me:this.typingEnd(t)}})),this.messages=[],this.groupedMessages=[],this.demo){const t=en.getFakeList().map((t=>new tn(t,ee.state.uid,ee.state.name)));this.updateMessages(t.slice(0,5)),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.clientId=t.clientId||ee.state.uid,t.type){case Pe:break;case De:case Me:ki.out(t)}}))}else{const t=this.agora=Zi.getSingleton();t&&t.getChannelMessages().pipe(n.first()).subscribe((t=>{t=t.map((t=>new tn(t,ee.state.uid,ee.state.name))),this.updateMessages(t)}))}}onView(){}onChanges(){}onDestroy(){en.to&&(clearTimeout(en.to),en.to=null)}onSubmit(){const t=this.secureText(this.form.value.message),e=this.createMessage(t);this.sendMessage(e),this.form.get("message").value=null,this.demo}onKeyDown(e){if("Enter"===e.key){e.shiftKey?(this.rows=Math.min(4,this.rows+1),this.pushChanges()):(e.preventDefault(),this.onSubmit(),this.rows=1);const{node:i}=t.getContext(this);i.querySelector("textarea").setAttribute("rows",this.rows)}}onToggleEmoji(){this.showEmoji=!this.showEmoji,this.pushChanges()}onSelectEmoji(t){this.showEmoji=!1,this.form.get("message").value=(this.form.get("message").value||"")+t.char}secureText(t){return(new DOMParser).parseFromString(t,"text/html").body.textContent||""}createMessage(t){return new tn(t,ee.state.uid,ee.state.name)}sendMessage(t){this.pushMessage(t);const e=this.agora;e&&e.addOrUpdateChannelMessages([t.getPayload()]),ki.send(t)}onClose(t){this.close.next()}scrollToBottom(){const{node:e}=t.getContext(this),i=e.querySelector(".group--scrollview");i.scrollTop=i.scrollHeight}pushMessage(t){const e=this.messages?this.messages.slice():[];this.removeTyping({type:De,clientId:t.clientId},this.messages),e.push(t),this.updateMessages(e)}typingBegin(t){const e=this.messages?this.messages.slice():[];e.push(t),this.updateMessages(e)}typingEnd(t){const e=this.messages?this.messages.slice():[];this.removeTyping({type:De,clientId:t.clientId},e),this.updateMessages(e)}removeTyping(t,e,i){void 0===i&&(i=!0);const n=e.reduce(((e,i,n)=>i.type===t.type&&i.clientId===t.clientId?n:e),-1);return-1!==n&&(e.splice(n,1),!0===i&&this.removeTyping(t,e,!0)),n}checkTypings(t){const e=t.message&&t.message.length>0||!1;this.typings_!==e&&(this.typings_=e,e?ki.send({type:De}):ki.send({type:Me}))}updateMessages(t){this.messages=t,this.groupedMessages=[],this.pushChanges();const e=[];t.forEach((t=>{if(t.type===Pe){const i=e.length?e[e.length-1]:null;i&&i.clientId===t.clientId?i.message+=`<p>${t.message}</p>`:e.push(t.getCopy())}else if(t.type===De){const i=e.reduce(((e,i,n)=>i.clientId===t.clientId?i:e),null);i&&(i.typing=!0)}})),this.groupedMessages=e,this.pushChanges(),setTimeout((()=>{this.scrollToBottom()}),1)}isValid(){return this.form.valid&&this.form.value.message&&this.form.value.message.length>0}randomMessage(){en.to&&(clearTimeout(en.to),en.to=null),en.to=setTimeout((()=>{const t=en.createRandomMessage();this.sendMessage(t)}),1e3*(2+6*Math.random()))}}en.meta={selector:"[agora-chat]",outputs:["close"],template:'\n\t\t<div class="group--scrollview" [class]="\'rows--\' + rows">\n\t\t\t<div class="group--virtual" *virtual="let item of groupedMessages" [mode]="4" [width]="350" [gutter]="0" [reverse]="true">\n\t\t\t\t\x3c!-- serve un nodo figlio --\x3e\n\t\t\t\t<div class="listing__item message" [class]="{ me: item.me, typing: item.typing }">\n\t\t\t\t\t<div class="message__avatar" [title]="item.name"><span [innerHTML]="item.shortName"></span></div>\n\t\t\t\t\t<div class="message__content">\n\t\t\t\t\t\t<div [innerHTML]="item.message | message"></div>\n\t\t\t\t\t\t<div class="typing-indicator">\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t\t<span></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="group--message" [class]="\'rows--\' + rows">\n\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.message.validators.length, \'addon\': controls.message.valid }">\n\t\t\t\t\t\x3c!-- <input type="text" class="control--text" [formControl]="controls.message" [placeholder]="\'bhere_write_a_message\' | label" /> --\x3e\n\t\t\t\t\t<button type="button" class="control--pre" (click)="onToggleEmoji()">\n\t\t\t\t\t\t<svg class="emoji" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#emoji"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<textarea class="control--text" [formControl]="controls.message" [placeholder]="\'bhere_write_a_message\' | label" rows="1" (keydown)="onKeyDown($event)"></textarea>\n\t\t\t\t\t<button type="submit" class="control--addon">\n\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#send"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</form>\n\t\t</div>\n\t\t<div class="group--close">\n\t\t\t<button type="button" class="btn--close" [title]="\'title_close\' | label" (click)="onClose($event)">\n\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="group--emoji" [class]="\'rows--\' + rows" agora-chat-emoji (emoji)="onSelectEmoji($event)" (close)="onToggleEmoji()" *if="showEmoji">\n\t\t\t<div class="group--virtual" *virtual="let item of items" [mode]="1" [width]="40" [gutter]="10" [reverse]="true">\n\t\t\t\t\x3c!-- serve un nodo figlio --\x3e\n\t\t\t\t<div class="listing__item emoji">\n\t\t\t\t\t<button type="button" class="btn--emoji" (click)="onSelect(item)"><span [innerHTML]="item.char"></span></button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--close">\n\t\t\t\t<button type="button" class="btn--close" [title]="\'title_close\' | label" (click)="onClose($event)">\n\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t'},en.getFakeList=()=>{let t=[{date:161459223e4,name:"Jhon Appleseed",message:"Function-based web-enabled benchmark",clientId:"7341614597544882"},{date:161459224e4,name:"Jhon Appleseed",message:"Customizable exuding superstructure",clientId:"7341614597544882"},{date:161459225e4,name:"Gilles Pitkins",message:"Synergistic interactive archive",clientId:"cfe9ff5b-f7da-449d-bf5a-3184b5eba6ea"},{date:161459226e4,name:"Jhon Appleseed",message:"Digitized client-server initiative",clientId:"7341614597544882"},{date:161459227e4,name:"Jhon Appleseed",message:"Quality-focused tertiary open system",clientId:"7341614597544882"},{date:161459228e4,name:"Jhon Appleseed",message:"Exclusive uniform middleware",clientId:"7341614597544882"},{date:161459229e4,name:"John Pruckner",message:"Decentralized disintermediate extranet",clientId:"ae51e846-d043-41e9-bb5c-3189181e5b43"},{date:16145923e5,name:"Lamont Georgievski",message:"Enhanced static approach",clientId:"1961cd9e-93aa-4bd0-b96a-89fcbd36b257"},{date:161459231e4,name:"Jhon Appleseed",message:"Ergonomic clear-thinking info-mediaries",clientId:"7341614597544882"},{date:161459232e4,name:"Jeri Pedroni",message:"Grass-roots dynamic encryption",clientId:"13d69bba-3656-449b-8fe3-d7a87062b044"},{date:161459233e4,name:"Frederik Dechelle",message:"Compatible disintermediate policy",clientId:"9151ebe0-efa8-40b4-a341-b8fd489e9c88"},{date:161459234e4,name:"Jhon Appleseed",message:"Inverse user-facing adapter",clientId:"7341614597544882"},{date:161459235e4,name:"Jhon Appleseed",message:"Future-proofed even-keeled application",clientId:"7341614597544882"},{date:161459236e4,name:"Cassie Jonathon",message:"Profit-focused content-based budgetary management",clientId:"5b3dc6f3-2a3d-493d-aac5-66ddfce2d709"},{date:161459237e4,name:"Jhon Appleseed",message:"Managed intermediate monitoring",clientId:"7341614597544882"},{date:161459238e4,name:"Jhon Appleseed",message:"Exclusive client-server encoding",clientId:"7341614597544882"},{date:161459239e4,name:"Jhon Appleseed",message:"Cross-group system-worthy matrices",clientId:"7341614597544882"},{date:16145924e5,name:"Jhon Appleseed",message:"Upgradable encompassing benchmark",clientId:"7341614597544882"},{date:161459241e4,name:"Emelen Beevors",message:"Function-based full-range knowledge base",clientId:"c93aea47-ebd8-4e5e-88fd-52053dd35cd1"},{date:161459242e4,name:"Jhon Appleseed",message:"Synergistic system-worthy capability",clientId:"7341614597544882"}];for(;t.length<100;)t=t.concat(t);return t},en.createRandomMessage=t=>new tn({date:Date.now(),clientId:"9fe0e1b9-6a6b-418b-b916-4bbff3eeb123",name:"Herman frederick",message:"Lorem ipsum dolor"},ee.state.uid,ee.state.name),en.randomMessage=(t,e)=>{en.to&&(clearTimeout(en.to),en.to=null),en.to=setTimeout((()=>{const i=function(){const t=e.filter((t=>"7341614597544882"!==t.id));let i=t[Math.floor(t.length*Math.random())];return i=new tn({date:Date.now(),clientId:"9fe0e1b9-6a6b-418b-b916-4bbff3eeb123",name:i.name,message:i.message},ee.state.uid,ee.state.name),i}();t.sendMessage(i),en.randomMessage(t,e)}),1e3*(2+6*Math.random()))};class nn extends t.Component{}nn.meta={selector:"[agora-check]",inputs:["value"],template:'\n\t\t<svg *if="value == null" class="checkmark idle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">\n\t\t\t<circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>\n\t\t</svg>\n\t\t<svg *if="value === true" class="checkmark success" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">\n\t\t\t<circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>\n\t\t\t<path class="checkmark__icon" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" stroke-linecap="round"/>\n\t\t</svg>\n\t\t<svg *if="value === false" class="checkmark error" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">\n\t\t\t<circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>\n\t\t\t<path class="checkmark__icon" stroke-linecap="round" fill="none" d="M16 16 36 36 M36 16 16 36"/>\n\t\t</svg>\n\t'};class sn{constructor(t){this.data=t}}class on extends sn{}class rn extends sn{}class an{static get hasModal(){return this.hasModal_}static set hasModal(t){if(this.hasModal_!==t){this.hasModal_=t;const e=document.querySelector("body");t?e.classList.add("modal-open"):e.classList.remove("modal-open")}}static open$(t){return this.busy$.next(!0),(t.iframe?i.of(`<div class="iframe-modal" iframe-modal src="${t.iframe}"></div>`):this.getTemplate$(t)).pipe(n.map((e=>({node:this.getNode(e),data:t.data,modal:t}))),n.tap((t=>{this.modal$.next(t),this.hasModal=!0,this.busy$.next(!1)})),n.switchMap((t=>this.events$)),n.tap((t=>this.hasModal=!1)))}static getTemplate$(t){return t.src?i.from(fetch(t.src).then((t=>t.text()))):t.template?i.of(t.template):i.EMPTY}static getNode(t){const e=document.createElement("div");e.innerHTML=t;return e.firstElementChild}static reject(t){this.modal$.next(null),this.events$.next(new rn(t))}static resolve(t){this.modal$.next(null),this.events$.next(new on(t))}}an.modal$=new i.Subject,an.events$=new i.Subject,an.busy$=new i.Subject;class cn{static delete(t){this.isLocalStorageSupported()&&window.localStorage.removeItem(t)}static exist(t){if(this.isLocalStorageSupported())return void 0!==window.localStorage[t]}static get(t){let e=null;if(this.isLocalStorageSupported()&&void 0!==window.localStorage[t])try{e=JSON.parse(window.localStorage[t])}catch(e){console.log("LocalStorageService.get.error parsing",t,e)}return e}static set(t,e){if(this.isLocalStorageSupported())try{const i=[],n=JSON.stringify(e,(function(t,e){if("object"==typeof e&&null!==e){if(-1!==i.indexOf(e))return;i.push(e)}return e}));window.localStorage.setItem(t,n)}catch(i){console.log("LocalStorageService.set.error serializing",t,e,i)}}static isLocalStorageSupported(){if(this.supported)return!0;let t=!1;try{t="localStorage"in window&&null!==window.localStorage,t?(window.localStorage.setItem("test","1"),window.localStorage.removeItem("test")):t=!1}catch(e){t=!1}return this.supported=t,t}}const ln=100;class dn{static checklist$(){return ee.state$.pipe(n.first(),n.map((t=>{const e={shouldCheckAudio:!0,shouldCheckVideo:!0,key:"checklist_audio_video",uid:null,checklist:{browser:null,https:null,video:null,audio:null,rtc:null,rtm:null},errors:{}};return t.role===ie.Viewer&&(e.shouldCheckAudio=!1,e.shouldCheckVideo=!1),Fi.platform===ji&&(e.shouldCheckAudio=!0,e.shouldCheckVideo=!1),e.key=`checklist${e.shouldCheckAudio?"_audio":""}${e.shouldCheckVideo?"_video":""}`,e})),n.switchMap((t=>(!0===cn.get(t.key)&&Object.keys(t.checklist).forEach((e=>{t.checklist[e]=!0})),i.of(t)))))}static isChecked(t){return Object.keys(t.checklist).reduce(((e,i,n)=>{const s=e&&t.checklist[i];switch(i){case"audio":return s||!t.shouldCheckAudio;case"video":return s||!t.shouldCheckVideo;default:return s}}),!0)}static isChecked$(){return this.checklist$().pipe(n.map((t=>this.isChecked(t))))}static checkEvent$(){return this.checklist$().pipe(n.switchMap((t=>{if(!0===Object.keys(t.checklist).reduce(((e,i,n)=>e&&t.checklist[i]),!0))return i.of(t);{cn.set(t.key,!1);const e=new i.Subject,s=i.of(t).pipe(n.delay(1e3),n.switchMap((t=>(e.next(t),this.checkBrowserEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkHttpsEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkAudioEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkVideoEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkRtcEvent$(t)))),n.switchMap((t=>(e.next(t),this.checkRtmEvent$(t)))),n.tap((t=>{cn.set(t.key,!0)})));return i.merge(e,s)}})))}static check$(){return this.checklist$().pipe(n.switchMap((t=>!0===Object.keys(t.checklist).reduce(((e,i,n)=>e&&t.checklist[i]),!0)?i.of(t):(cn.set(t.key,!1),i.of(t).pipe(n.delay(1e3),n.switchMap((t=>this.checkBrowserEvent$(t))),n.switchMap((t=>this.checkHttpsEvent$(t))),n.switchMap((t=>this.checkAudioEvent$(t))),n.switchMap((t=>this.checkVideoEvent$(t))),n.switchMap((t=>this.checkRtcEvent$(t))),n.switchMap((t=>this.checkRtmEvent$(t))),n.tap((t=>{cn.set(t.key,!0)})))))))}static checkBrowser$(){const t=AgoraRTC.checkSystemRequirements();return i.of(t)}static checkBrowserEvent$(t){return this.checkBrowser$().pipe(n.switchMap((e=>(t.checklist.browser=e,e?i.of(t).pipe(n.delay(ln)):(t.errors.browser=ve.transform("bhere_browser_error"),this.checkHttpsEvent$(t).pipe(n.switchMap((t=>i.throwError(t)))))))),n.catchError((e=>(console.log("checkBrowserEvent$.error",e),t.checklist.browser=!1,t.errors.browser=ve.transform("bhere_browser_error"),i.throwError(t)))))}static checkHttps$(){const t="https:"===window.location.protocol;return i.of(t)}static checkHttpsEvent$(t){return this.checkHttps$().pipe(n.switchMap((e=>(t.checklist.https=e,e?i.of(t).pipe(n.delay(ln)):(t.errors.https=ve.transform("bhere_https_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkHttpsEvent$.error",e),t.checklist.https=!1,t.errors.https=ve.transform("bhere_https_error"),i.throwError(t)))))}static checkAudio$(){return i.from(Zi.getDevices()).pipe(n.map((t=>null!=t.find((t=>"audioinput"===t.kind&&t.deviceId)))))}static checkAudioEvent$(t){return t.shouldCheckAudio?this.checkAudio$().pipe(n.switchMap((e=>(t.checklist.audio=e,e?i.of(t).pipe(n.delay(ln)):(t.errors.audio=ve.transform("bhere_audio_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkAudioEvent$.error",e),t.checklist.audio=!1,t.errors.audio=ve.transform("bhere_audio_error"),i.throwError(t))))):i.of(t)}static checkVideo$(){return i.from(Zi.getDevices()).pipe(n.map((t=>null!=t.find((t=>"videoinput"===t.kind&&t.deviceId)))))}static checkVideoEvent$(t){return t.shouldCheckVideo?this.checkVideo$().pipe(n.switchMap((e=>(t.checklist.video=e,e?i.of(t).pipe(n.delay(ln)):(t.errors.video=ve.transform("bhere_video_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkVideoEvent$.error",e),t.checklist.video=!1,t.errors.video=ve.transform("bhere_video_error"),i.throwError(t))))):i.of(t)}static checkRtc$(){return i.from(Zi.checkRtcConnection())}static checkRtcEvent$(t){return this.checkRtc$().pipe(n.switchMap((e=>(t.uid=e,t.checklist.rtc=!1!==e,e?i.of(t).pipe(n.delay(ln)):(t.errors.rtc=ve.transform("bhere_rtc_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkRtcEvent$.error",e),t.checklist.rtc=!1,t.errors.rtc=ve.transform("bhere_rtc_error"),i.throwError(t)))))}static checkRtm$(t){return i.from(Zi.checkRtmConnection(t))}static checkRtmEvent$(t){return this.checkRtm$(t.uid).pipe(n.switchMap((e=>(t.checklist.rtm=!1!==e,e?i.of(t):(t.errors.rtm=ve.transform("bhere_rtm_error"),i.throwError(t))))),n.catchError((e=>(console.log("checkRtmEvent$.error",e),t.checklist.rtm=!1,t.errors.rtm=ve.transform("bhere_rtm_error"),i.throwError(t)))))}}class hn extends t.Component{onClose(){an.resolve()}}hn.meta={selector:"[agora-configure-firewall-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form" [innerHTML]="\'bhere_configure_firewall\' | label"></div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="button" class="btn--accept" (click)="onClose()">\n\t\t\t\t\t<span>Chiudi</span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t'},hn.chunk=()=>'<div class="configure-firewall-modal" agora-configure-firewall-modal></div>';class un extends t.Component{onInit(){this.platform=Fi.platform,this.checklist={},this.errors={},this.state={},this.busy=!0,this.shouldCheckAudio=!1,this.shouldCheckVideo=!1,dn.checkEvent$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.shouldCheckAudio=t.shouldCheckAudio,this.shouldCheckVideo=t.shouldCheckVideo,this.checklist=t.checklist,this.errors=t.errors||{};const e=dn.isChecked(t);e?(this.checklist.success=e,this.busy=!1,this.pushChanges(),this.state.role===ie.SmartDevice&&this.onNext()):this.pushChanges()}),(t=>{this.errors=t.errors||{},this.checklist.error=!0,this.busy=!1,this.pushChanges()}))}onNext(){this.checked.next(this.checklist)}openHttps(){window.location.href=window.location.href.replace("http://","https://").replace(":5000",":6443")}showFirewallConfiguration(){an.open$({template:hn.chunk()}).pipe(n.first()).subscribe()}}un.meta={selector:"[agora-checklist]",outputs:["checked"],template:'\n\t<div class="group--info">\n\t\t<div class="group--info__content stagger--childs">\n\t\t\t<div class="title" *if="busy" [innerHTML]="\'bhere_checklist_busy\' | label"></div>\n\t\t\t<div class="title" *if="checklist.success" [innerHTML]="\'bhere_checklist_success\' | label"></div>\n\t\t\t<div class="title" *if="checklist.error" [innerHTML]="\'bhere_checklist_error\' | label"></div>\n\t\t\t<ul class="group--checklist stagger--childs">\n\t\t\t\t<li class="checklist__item check"><span>Browser</span> <span agora-check [value]="checklist.browser"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.browser"><a class="btn--link" href="https://browsehappy.com/" target="_blank" rel="noopener" [innerHTML]="errors.browser"></a></li>\n\t\t\t\t<li class="checklist__item check"><span>Https</span> <span agora-check [value]="checklist.https"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.https"><a class="btn--link" (click)="openHttps()" [innerHTML]="errors.https"></a></li>\n\t\t\t\t<li class="checklist__item check" *if="shouldCheckAudio"><span>Audio</span> <span agora-check [value]="checklist.audio"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.audio"><span [innerHTML]="errors.audio"></span></li>\n\t\t\t\t<li class="checklist__item check" *if="shouldCheckVideo"><span>Video</span> <span agora-check [value]="checklist.video"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.video"><span [innerHTML]="errors.video"></span></li>\n\t\t\t\t<li class="checklist__item check"><span>Realtime Communication</span> <span agora-check [value]="checklist.rtc"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.rtc"><a class="btn--link" (click)="showFirewallConfiguration()" [innerHTML]="errors.rtc"></a></li>\n\t\t\t\t<li class="checklist__item check"><span>Realtime Messaging</span> <span agora-check [value]="checklist.rtm"></span></li>\n\t\t\t\t<li class="checklist__item error" *if="errors.rtm"><a class="btn--link" (click)="showFirewallConfiguration()" [innerHTML]="errors.rtm"></a></li>\n\t\t\t</ul>\n\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !checklist.success, ready: checklist.success }" (click)="onNext()">\n\t\t\t\t<span [innerHTML]="\'bhere_proceed\' | label"></span>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t'};class pn{static get context(){return!this.context_&&"AudioContext"in window&&(this.context_=new AudioContext),this.context_}static get analyser(){if(!this.analyser_)try{this.analyser_=this.context.createAnalyser()}catch(t){console.log("AudioStreamService.analyser",t)}return this.analyser_}static addSource(t){const e=t instanceof MediaStream?t.id:t;return this.sources_[e]||(t instanceof MediaStream?this.sources_[e]=this.context.createMediaStreamSource(t.clone()):this.sources_[e]=this.context.createMediaElementSource(t)),this.sources_[e]}static removeSource(t){const e=t instanceof MediaStream?t.id:t;return this.removeSourceKey(e)}static removeSourceKey(t){let e;return this.sources_[t]&&(e=this.sources_[t],this.analyser&&e.disconnect(this.analyser),e.disconnect(),delete this.sources_[t]),e}static frequency$(t,e){if(void 0===e&&(e=64),e%2==1)throw e;const s=new Uint8Array(e/2);if(this.context){const o=this.analyser;if(o){o.fftSize=e;this.addSource(t).connect(o)}const r=new i.BehaviorSubject(s);return pn.frame$.pipe(n.withLatestFrom(r),n.map((t=>{let[e,i]=t;return o&&o.getByteFrequencyData(i),i})),n.tap((t=>r.next(t))),n.finalize((()=>{this.removeSource(t)})))}return i.of(s)}static volume$(t){const e={volume:0,clipped:!1};if(this.context){const s=this.addSource(t),o=pn.audioMeterCreate();s.connect(o);const r=new i.BehaviorSubject(e);return pn.frame$.pipe(n.withLatestFrom(r),n.map((t=>{let[e,i]=t;return i.clipped=o.checkClipping(),i.volume=o.volume,i})),n.tap((t=>r.next(t))),n.finalize((()=>{this.removeSource(t)})))}return i.of(e)}static audioMeterCreate(t,e,i){void 0===t&&(t=.98),void 0===e&&(e=.95),void 0===i&&(i=750);const n=this.context;if(n){const s=n.createScriptProcessor(512);return s.onaudioprocess=this.audioMeterProcess,s.checkClipping=this.audioMeterClip,s.dispose=this.audioMeterDispose,s.clipping=!1,s.lastClip=0,s.volume=0,s.clipLevel=t,s.averaging=e,s.clipLag=i,s.connect(n.destination),s}}static audioMeterProcess(t){const e=t.inputBuffer.getChannelData(0),i=e.length;let n,s=0;for(let t=0;t<i;t++)n=e[t],Math.abs(n)>=this.clipLevel&&(this.clipping=!0,this.lastClip=window.performance.now()),s+=n*n;const o=Math.sqrt(s/i);this.volume=Math.max(o,this.volume*this.averaging)}static audioMeterClip(){return!!this.clipping&&(this.lastClip+this.clipLag<window.performance.now()&&(this.clipping=!1),this.clipping)}static audioMeterDispose(){this.disconnect(),this.onaudioprocess=null}static step$(t){return i.Observable.create((e=>{requestAnimationFrame((i=>{const n=t?(i-t.startTime)/1e3:0;e.next({startTime:i,deltaTime:n})}))})).pipe(n.map((t=>(t.deltaTime>1/30&&(t.deltaTime=1/30),t))))}static dispose(){Object.keys(this.sources_).forEach((t=>{this.removeSourceKey(t)}));const t=this.analyser;t&&t.disconnect(),this.sources_={}}}pn.sources_={},pn.frame$=i.of(void 0).pipe(n.expand((t=>pn.step$(t))),n.filter((t=>void 0!==t)),n.map((t=>t.deltaTime)),n.share());class mn extends t.Component{get video(){return this.video_}set video(t){this.video_!==t&&(this.video_=t,this.change&&(this.change.next(),this.init(),this.initStream()))}get audio(){return this.audio_}set audio(t){this.audio_!==t&&(this.audio_=t,this.change&&(this.change.next(),this.init(),this.initStream()))}get hasPreview(){return this.platform!==Ui&&this.platform!==ji}onInit(){this.init()}init(){if(this.initialized_)return;this.initialized_=!0,this.platform=Fi.platform;const{node:e}=t.getContext(this);this.onLoadedMetadata=this.onLoadedMetadata.bind(this);(this.preview=e.querySelector("video")).addEventListener("loadedmetadata",this.onLoadedMetadata);const i=e.querySelector(".audio");this.hasPreview&&(this.bars=new Array(32).fill(0).map((t=>{const e=document.createElement("div");return e.classList.add("bar"),i.appendChild(e),e})))}onDestroy(){this.preview.removeEventListener("loadedmetadata",this.onLoadedMetadata),this.hasPreview&&pn.dispose()}initStream(){const e=this.preview;if(!this.preview)return;const{node:i}=t.getContext(this);if(this.video_||this.audio_){if(i.classList.add("ready"),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const t=Se(ee.state),i={video:!!this.video_&&{deviceId:this.video_,width:{ideal:t.resolution.width},height:{ideal:t.resolution.height},frameRate:{ideal:t.frameRate.min,max:t.frameRate.max}},audio:!!this.audio_&&{deviceId:this.audio_}};this.platform===Ui&&(i.video.facingMode="user"),navigator.mediaDevices.getUserMedia(i).then((t=>{this.hasPreview?("srcObject"in e?e.srcObject=t:e.src=window.URL.createObjectURL(t),this.audio_&&this.analyzeData(t),this.loadingStream_=t):this.stream.next(t)})).catch((t=>{console.log("AgoraDevicePreviewComponent.initStream.error",t.name,t.message),this.stream.next(null)}))}}else i.classList.remove("ready"),this.hasPreview&&("srcObject"in e?e.srcObject=null:e.src=null,this.analyzeData(null)),this.stream.next(null)}onLoadedMetadata(e){const{node:i}=t.getContext(this);i.classList.add("loaded"),this.preview.play(),this.stream.next(this.loadingStream_)}analyzeData(t){this.frequencySubscription&&this.frequencySubscription.unsubscribe(),t&&(this.frequencySubscription=pn.frequency$(t,64).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.bars.forEach(((e,i)=>{const n=Math.min(100,5+t[i])/100;e.style.left=3.125*i+"%",e.style.transform=`scale(1,${n})`,e.style.opacity=n}))})))}}mn.meta={selector:"[agora-device-preview]",outputs:["stream","change"],inputs:["video","audio"]};class vn extends t.Component{get hasPreview(){return this.platform!==Ui&&this.platform!==ji}onInit(){if(this.platform=Fi.platform,this.isHttps="https:"===window.location.protocol,this.state={},this.devices={videos:[],audios:[]},this.stream=null,this.form=null,this.isHttps){const t=this.agora=Zi.getSingleton();ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()})),t&&t.devices$().subscribe((t=>{this.devices=t,this.initForm(t),this.pushChanges()}),(t=>{console.log("AgoraDeviceComponent.devices$.error",t)}))}}openHttps(t){window.location.href=window.location.href.replace("http://","https://").replace(":5000",":6443")}initForm(t){const i=this.form=new e.FormGroup({video:new e.FormControl(null,t.videos.length?e.Validators.RequiredValidator():void 0),audio:new e.FormControl(null,t.audios.length?e.Validators.RequiredValidator():void 0)}),s=this.controls=i.controls,o=t.videos.map((t=>({id:t.deviceId,name:t.label})));o.length>0&&o.unshift({id:null,name:"bhere_select_video"}),s.video.options=o;const r=t.audios.map((t=>({id:t.deviceId,name:t.label})));r.length>0&&r.unshift({id:null,name:"bhere_select_audio"}),s.audio.options=r,i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()}))}onStreamDidChange(t){this.stream=null,this.pushChanges()}onStream(t){this.stream=t,this.pushChanges()}isValid(){return this.form.valid&&(this.stream||!this.hasPreview)}onEnter(t){const e=this.form.value,i=this.devices;i.video=i.videos.find((t=>t.deviceId===e.video)),i.audio=i.audios.find((t=>t.deviceId===e.audio)),this.enter.next(i)}}vn.meta={selector:"[agora-device]",outputs:["enter"],template:'\n\t<div class="group--info" *if="!isHttps">\n\t\t<div class="group--info__content stagger--childs">\n\t\t\t<div class="title" [innerHTML]="\'bhere_invalid_protocol\' | label"></div>\n\t\t\t<div class="info" [innerHTML]="\'bhere_reload_in_https\' | label"></div>\n\t\t\t<button type="button" class="btn--connect" (click)="openHttps($event)">\n\t\t\t\t<span [innerHTML]="\'bhere_reload\' | label"></span>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t<div class="group--info" *if="form">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onEnter($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\x3c!-- PREVIEW --\x3e\n\t\t\t<div class="agora-device-preview" agora-device-preview [video]="controls.video.value" [audio]="controls.audio.value" (stream)="onStream($event)" (change)="onStreamDidChange($event)" *if="this.hasPreview">\n\t\t\t\t<video class="video" muted></video>\n\t\t\t\t<div class="audio"></div>\n\t\t\t</div>\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\x3c!-- VIDEO --\x3e\n\t\t\t\t<div control-custom-select [control]="controls.video" label="Video" *if="devices.videos.length"></div>\n\t\t\t\t\x3c!-- AUDIO --\x3e\n\t\t\t\t<div control-custom-select [control]="controls.audio" label="Audio" *if="devices.audios.length"></div>\n\t\t\t\t<div class="info" *if="!isValid()" [innerHTML]="\'bhere_select_video_audio\' | label"></div>\n\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="\'bhere_video_audio_connected\' | label"></div>\n\t\t\t\t<button type="submit" class="btn--connect" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t\t\t\t<span *if="!state.connecting" [innerHTML]="\'bhere_enter\' | label"></span>\n\t\t\t\t\t<span *if="state.connecting" [innerHTML]="\'bhere_connecting\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};const gn={WaitingRoom:{id:1,name:"waiting-room"},Panorama:{id:2,name:"panorama"},PanoramaGrid:{id:3,name:"panorama-grid"},Room3d:{id:4,name:"room-3d"},Model:{id:5,name:"model"},Media:{id:6,name:"media"}},fn={Nav:{id:1,name:"nav"},Plane:{id:2,name:"plane"},CurvedPlane:{id:3,name:"curved-plane"},Model:{id:4,name:"model"},Texture:{id:5,name:"texture"}};class En{constructor(t){t&&(Object.assign(this,t),this.updateIndices(t.items)),this.items=(this.items||[]).filter((t=>function(t){let e;if(t.type.name===fn.Nav.name)e=null==t.viewId||function(t){return!Nn(t.title)&&!Nn(t.abstract)}(t)||ee.state.navigable;else e=!0;return e}(t))).map((t=>An(t))),this.tiles&&(this.tiles=this.tiles.map((t=>On(t)))),this.originalItems=this.items.slice(),this.lastOrientation={latitude:0,longitude:0},this.path=!0}get payload(){const t={};return Object.keys(this).forEach((e=>{if(-1!==En.allowedProps.indexOf(e))switch(e){case"items":t[e]=this[e].map((t=>An(t).payload));break;case"tiles":t[e]=this[e].map((t=>On(t).payload));break;default:t[e]=this[e]}})),t}get pathItems(){return this.items.filter((t=>t.path))}get shortType(){return this.type?this.type.split("-").map((t=>t.substring(0,1).toUpperCase())).join(""):"??"}updateIndices(t){if(t){let e=0,i=0,n=0,s=0,o=0;t.forEach(((t,r)=>{if(t.index=r,t.asset)switch(t.asset.file){case"publisherStream":t.asset.index=e++;break;case"nextAttendeeStream":t.asset.index=i++;break;case"smartDeviceStream":t.asset.index=n++;break;case"publisherScreen":t.asset.index=s++;break;case"attendeeScreen":t.asset.index=o++}}))}}}En.allowedProps=["id","type","name","hidden","likes","asset","items","orientation","zoom","ar","tiles","invertAxes","flipAxes"];class _n extends En{constructor(t){super(t)}}class Sn extends En{static mapTiles(t,e,i,n){void 0===t&&(t=[]),void 0===e&&(e=!1),void 0===i&&(i=!1),void 0===n&&(n="");const s=e?-1:1;return t.map(((t,e)=>{const o=new THREE.Vector2;return(t="string"==typeof t?{id:e+1,asset:{folder:n,file:t},navs:[]}:t).asset.file.replace(/_x([-|\d]+)_y([-|\d]+)/g,((t,e,n)=>{i?(o.y=parseInt(e),o.x=parseInt(n)*s):(o.x=parseInt(e),o.y=parseInt(n)*s)})),{id:t.id,type:Object.assign({},gn.PanoramaGrid),asset:t.asset,navs:t.navs||[],indices:o}}))}set index(t){this.index_!==t&&(this.index_=t,this.tiles.forEach(((e,i)=>e.selected=i===t)),this.updateCurrentItems(),this.index$.next(t))}get index(){return this.index_}constructor(t){t.tiles=Sn.mapTiles(t.tiles,t.flipAxes,t.invertAxes,t.asset?t.asset.folder:""),super(t),this.index_=0,this.index$=new i.Subject,this.tiles.forEach(((t,e)=>t.selected=0===e)),this.tiles.length&&(this.items=this.originalItems.concat(this.tiles[0].navs),this.asset=this.tiles[0].asset)}updateCurrentItems(){this.items=this.originalItems.concat(this.tiles[this.index_].navs)}getTileIndex(t,e){return this.tiles.reduce(((i,n,s)=>n.indices.x===t&&n.indices.y===e?s:i),-1)}hasTile(t,e){return-1!==this.getTileIndex(t,e)}getTile(t,e){const i=this.getTileIndex(t,e);if(-1!==i)return this.index=i,this.tiles[i]}}class bn extends En{constructor(t){super(t)}}class Tn extends En{constructor(t){super(t)}}class yn extends En{constructor(t){super(t)}}class wn{constructor(t){t&&Object.assign(this,t),this.path=!0;const e=this.links||(this.link?[this.link]:[]);this.links=e}get firstLink(){return this.links&&this.links.length?this.links[0]:null}get payload(){const t={};return Object.keys(this).forEach((e=>{-1!==wn.allowedProps.indexOf(e)&&(t[e]=this[e])})),!t.link||t.link.title&&t.link.href||delete t.link,t}get hasPanel(){return this.type.name===fn.Nav.name&&(this.title&&""!==this.title||this.abstract&&""!==this.abstract||this.asset||this.link)}}wn.allowedProps=["id","type","title","abstract","asset","link","links","viewId","hook","hookExtra","keepOrientation","important","transparent","position","rotation","scale","radius","height","arc"];class Cn extends wn{}class Rn{constructor(t){t&&Object.assign(this,t),this.navs=(this.navs||[]).map((t=>An(t))),this.originalItems=this.navs.slice()}get payload(){const t={};return Object.keys(this).forEach((e=>{if(-1!==Rn.allowedProps.indexOf(e))if("navs"===e)t[e]=this[e].map((t=>An(t).payload));else t[e]=this[e]})),t}}function In(t){switch(t.type.name){case gn.Panorama.name:t=new _n(t);break;case gn.PanoramaGrid.name:t=new Sn(t);break;case gn.Room3d.name:t=new bn(t);break;case gn.Model.name:t=new Tn(t);break;case gn.Media.name:t=new yn(t);break;default:t=new En(t)}return t}function An(t){if(t.type.name===fn.Nav.name)t=new Cn(t);else t=new wn(t);return t}function On(t){return new Rn(t)}function Nn(t){return t&&t.length>0}Rn.allowedProps=["id","asset","navs"];class kn{constructor(t){t&&Object.assign(this,t),this.items=this.items||[],this.originalItems=this.items.slice()}get payload(){const t={};return Object.keys(this).forEach((e=>{-1!==En.allowedProps.indexOf(e)&&(t[e]=this[e])})),t}}function Ln(t){return t=new kn(t)}kn.allowedProps=["id","name","items"];const Pn={id:null,name:"Principale",items:[]};class Dn{static set paths(t){this.paths$.next(t)}static get paths(){return this.paths$.getValue()}static set path(t){this.path$.next(t)}static get path(){return this.path$.getValue()}static getCurrentPath$(t){return void 0===t&&(t=null),this.pathGet$().pipe(n.switchMap((e=>{this.paths=e;let i=Pn;if(t){const n=e.find((e=>e.id===t));n&&(i=n)}return this.path=i,this.path$})))}static pathGet$(){return x.flags.usePaths?yi.get$("/api/path").pipe(n.map((t=>(t.paths=t.paths.map((t=>Ln(t))),t.paths.unshift(Pn),t.paths)))):i.of([])}static addPath(t){const e=this.paths.slice();e.push(t),this.paths=e,this.path=t}static editPath(t){const e=this.paths.slice(),i=e.reduce(((e,i,n)=>i.id===t.id?n:e),-1);if(i>0){let n=this.path;n.id===t.id&&(n=t),e.splice(i,1,t),this.paths=e,this.path=n}}static deletePath(t){const e=this.paths.slice(),i=e.indexOf(t);if(i>0){e.splice(i,1),this.paths=e;let n=this.path;n.id===t.id&&(n=e[0]),this.path=n}}static pathCreate$(t){return yi.post$("/api/path",t).pipe(n.map((t=>Ln(t))))}static pathUpdate$(t){return yi.put$(`/api/path/${t.id}`,t).pipe(n.map((t=>Ln(t))))}static pathDelete$(t){return yi.delete$(`/api/path/${t.id}`)}}Dn.paths$=new i.BehaviorSubject([Pn]),Dn.path$=new i.BehaviorSubject(Pn);class Mn extends t.Component{get selfServiceTourRoute(){const t=this.form.get("path").value,e=[Ee.transform(":lang.selfServiceTour")];return t&&e.push(re.validateParams({pathId:t})),e}onInit(){this.state={},this.paths=[],this.pathId=null,this.form=null,ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()})),x.flags.usePaths?Dn.getCurrentPath$().pipe(n.first(),n.tap(),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.paths=Dn.paths,this.pathId=t.id||"",this.onLoad()})):this.onLoad()}onLoad(){const t=this.form=new e.FormGroup({path:this.pathId,id:new e.FormControl(null,[e.Validators.PatternValidator(se),e.Validators.RequiredValidator()]),idAttendee:null,idStreamer:null,idViewer:null,idSmartDevice:null}),i=this.controls=t.controls,s=this.paths.map((t=>({id:t.id||"",name:t.name})));s.length>0&&s.unshift({id:null,name:"bhere_select_path"}),i.path.options=s,t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pathId!==t.path&&null!==t.id&&(this.pathId=t.path,this.onGenerateMeetingId()),this.pushChanges()}))}onGenerateMeetingId(t){let e=this.pathId?String(this.pathId):null;e=e&&e.length?e:null;const i=new oe({pathId:e}).toRoles();this.form.patch(i)}onInputDidChange(t){"publisher"===this.state.role&&setTimeout((()=>{if(this.form.get("id").valid){const t=this.form.get("id").value,e=new oe(t).toRoles();this.form.patch(e)}else this.form.get("idAttendee").reset(),this.form.get("idStreamer").reset(),this.form.get("idViewer").reset(),this.form.get("idSmartDevice").reset()}),1)}onCopyToClipBoard(t,e){void 0===e&&(e=!1);new re({link:t}).copyToClipBoard(e)}onNext(t){let e=this.controls.id.value;re.replaceWithLink(e),this.link.next(e)}isValid(){return this.form.valid}}Mn.meta={selector:"[agora-link]",outputs:["link"],template:'\n\t<div class="group--info" *if="form">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onNext($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t<div class="stagger--childs" *if="state.role !== \'publisher\'">\n\t\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.id.validators.length, \'addon\': controls.id.valid }">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_insert_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.id" [placeholder]="\'bhere_meeting_id\' | label" />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.id.value)" *if="controls.id.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="stagger--childs" *if="state.role === \'publisher\'">\n\t\t\t\t\t\x3c!-- PATH --\x3e\n\t\t\t\t\t<div control-custom-select [control]="controls.path" [label]="\'bhere_path\' | label" *if="(\'usePaths\' | flag) && paths.length"></div>\n\t\t\t\t\t\x3c!--IDS --\x3e\n\t\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.id.validators.length, \'addon\': controls.id.valid }">\n\t\t\t\t\t\t<label><svg class="lock" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#lock"></use></svg> <span [innerHTML]="\'bhere_insert_meeting_id\' | label"></span></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.id" [placeholder]="\'bhere_meeting_id\' | label" (change)="onInputDidChange($event)" />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.id.value)" *if="controls.id.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'attendee\' | flag) && controls.idAttendee.valid && controls.idAttendee.value !== null">\n\t\t\t\t\t\t<label><svg class="lock" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#lock"></use></svg> <span [innerHTML]="\'bhere_attendee_meeting_id\' | label"></span></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idAttendee" [placeholder]="\'bhere_attendee_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idAttendee.value)" *if="controls.idAttendee.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'streamer\' | flag) && controls.idStreamer.valid && controls.idStreamer.value !== null">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_streamer_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idStreamer" [placeholder]="\'bhere_streamer_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idStreamer.value)" *if="controls.idStreamer.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'viewer\' | flag) && controls.idViewer.valid && controls.idViewer.value !== null">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_viewer_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idViewer" [placeholder]="\'bhere_viewer_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idViewer.value)" *if="controls.idViewer.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--form group--form--addon addon" *if="(\'smartDevice\' | flag) && controls.idSmartDevice.valid && controls.idSmartDevice.value !== null">\n\t\t\t\t\t\t<label [innerHTML]="\'bhere_smart_device_meeting_id\' | label"></label>\n\t\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.idSmartDevice" [placeholder]="\'bhere_smart_device_meeting_id\' | label" readonly />\n\t\t\t\t\t\t<div class="control--addon" (click)="onCopyToClipBoard(controls.idSmartDevice.value, true)" *if="controls.idSmartDevice.valid">\n\t\t\t\t\t\t\t<svg class="copy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#copy"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="info" *if="controls.id.errors.required" [innerHTML]="\'bhere_insert_meeting_id\' | label"></div>\n\t\t\t\t<div class="info" *if="controls.id.errors.pattern" [innerHTML]="\'bhere_invalid_meeting_id\' | label"></div>\n\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="\'bhere_take_part_meeting\' | label"></div>\n\t\t\t\t<button type="button" class="btn--generate" *if="state.role == \'publisher\'" (click)="onGenerateMeetingId($event)">\n\t\t\t\t\t<span [innerHTML]="\'bhere_generate_meeting_id\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<span [innerHTML]="\'bhere_take_part\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<a [routerLink]="selfServiceTourRoute" class="btn--secondary" *if="state.role === \'publisher\'">\n\t\t\t\t\t<span [innerHTML]="\'bhere_self_service\' | label"></span>\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};class xn extends t.Component{onInit(){const t=this.form=new e.FormGroup({username:new e.FormControl(null,e.Validators.RequiredValidator()),password:new e.FormControl(null,e.Validators.RequiredValidator()),checkRequest:window.antiforgery||"",checkField:""});this.controls=t.controls,t.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),this.error=null}test(){this.form.patch({username:"publisher",password:"publisher",checkRequest:window.antiforgery||"",checkField:""})}reset(){this.form.reset()}onSubmit(){if(this.form.valid){const t=this.form.value;this.form.submitted=!0,this.error=null,this.pushChanges(),wi.login$(t).pipe(n.first()).subscribe((t=>{ee.state.role===t.type?(this.onNext(t),this.form.reset()):(this.error={friendlyMessage:ve.transform("error_credentials")},this.pushChanges())}),(t=>{console.log("AccessComponent.error",t),this.error=t,this.pushChanges()}))}else this.form.touched=!0}isValid(){return this.form.valid}onNext(t){re.replaceWithUser(t),this.login.next(t)}}xn.meta={selector:"[agora-login]",outputs:["login"],template:'\n\t<div class="group--info">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t<div class="title" [innerHTML]="\'bhere_login\' | label"></div>\n\t\t\t\t<input name="checkField" [formControl]="controls.checkField" value="" type="text" style="display:none !important;" />\n\t\t\t\t<div control-text [control]="controls.username" [label]="\'bhere_username\' | label"></div>\n\t\t\t\t<div control-password [control]="controls.password" [label]="\'bhere_password\' | label"></div>\n\t\t\t\t<div class="group--error" *if="error">\n\t\t\t\t\t<span class="status-code" [innerHTML]="error.statusCode"></span>\n\t\t\t\t\t<span class="status-message" [innerHTML]="error.statusMessage"></span>\n\t\t\t\t\t<span class="friendly-message" [innerHTML]="error.friendlyMessage"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="info" *if="isValid()" [innerHTML]="\'bhere_cta\' | label"></div>\n\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<span [innerHTML]="\'bhere_cta\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};class Un extends t.Component{onInit(){const t=new re;this.state={};const e=this.fields=[];if(x.flags.useExtendedUserInfo){const i=t.firstName,n=t.lastName,s=t.email;e.push({type:"text",name:"firstName",label:"access_first_name",required:!0,value:i,test:"Jhon"},{type:"text",name:"lastName",label:"access_last_name",required:!0,value:n,test:"Appleseed"},{type:"email",name:"email",label:"access_email",required:!0,value:s,test:"jhonappleseed@gmail.com"})}else{const i=t.name;e.push({type:"text",name:"name",label:"bhere_name_and_surname",pattern:/^\w{2,}\s\w{2,}/,required:!0,value:i,test:"Jhon Appleseed"})}e.push({type:"checkbox",name:"privacy",label:"access_privacy_disclaimer",required:!0,test:!0},{type:"hidden",name:"checkField",value:"",test:""},{type:"none",name:"checkRequest",value:x.antiforgery||"",test:x.antiforgery||""});const i=this.form=pe(e);this.controls=i.controls,i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()})),ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()}))}test(){me(this.fields,this.form)}isValid(){return this.form.valid}onNext(t){let e,i;x.flags.useExtendedUserInfo?(i={firstName:this.controls.firstName.value,lastName:this.controls.lastName.value,email:this.controls.email.value},e=`${i.firstName} ${i.lastName}`):(i={name:this.controls.name.value},e=i.name),re.replaceWithOptions(i),this.name.next(e)}}Un.meta={selector:"[agora-name]",outputs:["name"],template:'\n\t<div class="group--info" *if="form">\n\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onNext($event)" name="form" role="form" novalidate autocomplete="off">\n\t\t\t<div class="group--info__content stagger--childs">\n\t\t\t\t\x3c!-- controls --\x3e\n\t\t\t\t<div controls [formGroup]="form" [fields]="fields"></div>\n\t\t\t\t\x3c!-- NAME --\x3e\n\t\t\t\t\x3c!--\n\t\t\t\t<div class="group--form group--form--addon" [class]="{ required: controls.name.validators.length }">\n\t\t\t\t\t<label [innerHTML]="\'bhere_fill_fullname\' | label"></label>\n\t\t\t\t\t<input type="text" class="control--text" [formControl]="controls.name" [placeholder]="\'bhere_name_and_surname\' | label" />\n\t\t\t\t</div>\n\t\t\t\t<div class="info" *if="!controls.name.valid" [innerHTML]="\'bhere_fill_name_and_surname\' | label"></div>\n\t\t\t\t--\x3e\n\t\t\t\t<div class="info" *if="!isValid()"><span [innerHTML]="\'bhere_fill_name_and_surname\' | label"></span></div>\n\t\t\t\t<div class="info" *if="isValid()"><span [innerHTML]="\'bhere_proceed_as\' | label"></span> <span [innerHTML]="controls.name.value"></span></div>\n\t\t\t\t<button type="submit" class="btn--next" [class]="{ disabled: !isValid() }">\n\t\t\t\t\t<span [innerHTML]="\'bhere_proceed\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<test-component [form]="form" (test)="test($event)" (reset)="reset($event)"></test-component>\n\t\t\t</div>\n\t\t</form>\n\t</div>\n\t'};class Vn extends t.Component{set videoMuted(e){if(this.videoMuted_!==e){this.videoMuted_=e;const{node:i}=t.getContext(this);e?i.classList.add("video--muted"):i.classList.remove("video--muted")}}set audioMuted(e){if(this.audioMuted_!==e){this.audioMuted_=e;const{node:i}=t.getContext(this);e?i.classList.add("audio--muted"):i.classList.remove("audio--muted")}}get streamId(){return this.streamId_}set streamId(t){this.streamId_=t}get stream(){return this.stream_}set stream(e){try{if(this.stream_!==e){console.log("AgoraStreamComponent set stream",e);const{node:i}=t.getContext(this),n=this.player=i.querySelector(".agora-stream__player");this.stream_=e,e&&(this.videoMuted=e.userMuteVideo,this.audioMuted=e.userMuteAudio);const s=e?e.streamId:null;if(this.streamId=s,s){const t=`stream-${s}`;n.setAttribute("id",t);const i=this;if(e.isPlaying())e.resume(n);else{this.shouldUseResumeGesture=!1;try{e.play(n)}catch(t){Ki.error("Stream.videoTrack.play.error",t),t&&"aborted"!==t.status&&(i.shouldUseResumeGesture=!0,i.pushChanges())}}}else n.removeAttribute("id")}}catch(t){Ki.error("AgoraStreamComponent.stream.set.error",t)}}set vrContainer(t){this.vrContainer_!==t&&(this.vrContainer_=t,t?(this.stream_.vrContainer=t,this.player.appendChild(t)):this.stream_.vrContainer&&this.stream_.vrContainer.parentNode&&(this.stream_.vrContainer.parentNode.removeChild(this.stream_.vrContainer),this.stream_.vrContainer=null))}get videoNode(){let e=this.videoNode_;if(!e){const i=t.getContext(this).node.querySelector(".agora-stream__player");e=document.createElement("video"),this.onLoadedMetadata=this.onLoadedMetadata.bind(this),e.addEventListener("loadedmetadata",this.onLoadedMetadata),i.appendChild(e),this.videoNode_=e}return e}onInit(){this.videoMuted=!1,this.audioMuted=!1,this.shouldUseResumeGesture=!1,this.state={},ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.pushChanges()})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.type){case ke:{const e=t.event;this.streamId&&e.streamId===this.streamId&&(e instanceof Ei&&(this.videoMuted=!0),e instanceof _i&&(this.videoMuted=!1),e instanceof Si&&(this.audioMuted=!0),e instanceof bi&&(this.audioMuted=!1));break}case ri:this.streamId===t.clientId&&(this.vrContainer=t.container);break;case oi:this.streamId===t.clientId&&(this.vrContainer=null)}}))}setMediaStream(t){const e=this.videoNode;"srcObject"in e?e.srcObject=t:e.src=t?window.URL.createObjectURL(t):null}onLoadedMetadata(t){this.videoNode.play().then((t=>{}),(t=>{console.log("AgoraStreamComponent.play.error",t)}))}onToggleControl(t){this.toggleControl.next(t)}onToggleSpy(t){this.toggleSpy.next(t)}}Vn.meta={selector:"[agora-stream]",outputs:["toggleControl","toggleSpy"],inputs:["stream"]};class Bn{constructor(t){t&&Object.assign(this,t),this.items=(this.items||[]).map((t=>An(t))),this.originalItems=this.items.slice()}get payload(){const t={};return Object.keys(this).forEach((e=>{if(-1!==En.allowedProps.indexOf(e))if("items"===e)t[e]=this[e].map((t=>An(t).payload));else t[e]=this[e]})),t}}function jn(t){return t=new Bn(t)}Bn.allowedProps=["id","name","asset","items"];class Fn{static set active(t){this.active$.next(t)}static get active(){return this.active$.getValue()}static navmapGet$(){return yi.get$("/api/navmap").pipe(n.map((t=>(t.navmaps.map((t=>jn(t))),t.navmaps))))}static navmapCreate$(t){return yi.post$("/api/navmap",t).pipe(n.map((t=>jn(t))))}static navmapUpdate$(t){return yi.put$(`/api/navmap/${t.id}`,t).pipe(n.map((t=>jn(t))))}static navmapDelete$(t){return yi.delete$(`/api/navmap/${t.id}`)}static itemCreate$(t,e){return yi.post$(`/api/navmap/${t.id}/item`,e).pipe(n.map((t=>An(t))))}static itemUpdate$(t,e){return e=An(e),yi.put$(`/api/navmap/${t.id}/item/${e.id}`,e.payload).pipe(n.map((t=>An(t))))}static itemDelete$(t,e){return yi.delete$(`/api/navmap/${t.id}/item/${e.id}`)}}Fn.active$=new i.BehaviorSubject(!1);class Hn{static push(t){return function(t){(window.dataLayer||[]).push(t),console.log("GtmService.dataLayer",t)}(t)}}const Gn="info",$n="alert",Wn="dialog",zn="centered",Kn="bottom-right";class qn{constructor(t){this.toast=t}}class Yn extends qn{}class Jn extends qn{}class Xn{static open$(t){switch(t.id=(new Date).getTime(),t.type=t.type||Gn,t.position=t.position||zn,t.type){case $n:t.acceptMessage=t.acceptMessage||"Ok";break;case Wn:t.acceptMessage=t.acceptMessage||"Accept",t.rejectMessage=t.rejectMessage||"Reject"}return this.toast$.next(t),t.type===Gn&&setTimeout((()=>{this.resolve(t)}),t.duration||4e3),this.events$}static resolve(t){this.toast$.next(null),this.events$.next(new Yn(t))}static reject(t){this.toast$.next(null),this.events$.next(new Jn(t))}}Xn.toast$=new i.Subject,Xn.events$=new i.Subject;class Qn extends t.Component{get modal(){return this.modal_}set modal(e){const{module:i}=t.getContext(this);this.modal_&&this.modal_.node&&(i.remove(this.modal_.node,this),this.modalNode.removeChild(this.modal_.node)),e&&e.node&&(this.modal_=e,this.modalNode.appendChild(e.node),i.compile(e.node)),this.modal_=e,this.pushChanges()}get busy(){return this.busy_}set busy(t){this.busy_!==t&&(this.busy_=t,this.pushChanges())}onInit(){this.busy_=!1;const{node:e}=t.getContext(this);this.modalNode=e.querySelector(".modal-outlet__modal"),an.modal$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.modal=t)),an.busy$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.busy=t))}reject(t){an.reject()}}Qn.meta={selector:"[modal-outlet]",template:'\n\t<div class="modal-outlet__container" [class]="{ active: modal, busy: busy }">\n\t\t<div class="modal-outlet__background" (click)="reject($event)"></div>\n\t\t<div class="modal-outlet__modal"></div>\n\t\t\x3c!-- spinner --\x3e\n\t\t<div class="spinner spinner--contrasted" *if="busy"></div>\n\t</div>\n\t'};class Zn extends t.Component{onInit(){super.onInit();const{parentInstance:e,node:i}=t.getContext(this);if(e instanceof Qn){const t=this.data=e.modal.data;if(t&&t.ar){const e=Zn.getUrl(t);new QRious({element:i.querySelector(".qrcode"),value:e,size:256})}}}onClose(){an.reject()}static getUrl(t){const e=te.buildUrl(Ee.transform(":lang.tryInAr"),{viewId:t.id}),i=window.location.origin+e;return console.log("TryInARModalComponent.getUrl",i),i}static openInAR(t){const e=this.getUrl(t);window.open(e,"_blank")}}Zn.meta={selector:"[try-in-ar-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title" [innerHTML]="\'bhere_ar\' | label"></div>\n\t\t\t\t<div class="picture">\n\t\t\t\t\t<canvas class="qrcode"></canvas>\n\t\t\t\t</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onClose()">\n\t\t\t\t\t\t<span [innerHTML]="\'close\' | label"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},Zn.chunk=()=>'<div class="try-in-ar-modal" try-in-ar-modal></div>';const ts=["jpeg","jpg","png","hdr"],es=["mp4","webm"],is=["fbx","gltf","glb","usdz"],ns={Image:{id:1,name:"image"},Video:{id:2,name:"video"},Model:{id:3,name:"model"},PublisherStream:{id:4,name:"publisher-stream",file:"publisherStream"},AttendeeStream:{id:5,name:"next-attendee-stream",file:"nextAttendeeStream"},PublisherScreen:{id:6,name:"publisher-screen",file:"publisherScreen"},AttendeeScreen:{id:7,name:"attendee-screen",file:"attendeeScreen"},SmartDeviceStream:{id:8,name:"smart-device-stream",file:"smartDeviceStream"}},ss={ImageOrVideo:{id:1,name:"Image or Video",ids:[1,2]},Publisher:{id:3,name:"Publisher",ids:[4]},Attendee:{id:4,name:"Attendee",ids:[5]}};const os=[ns.PublisherStream.name,ns.AttendeeStream.name,ns.PublisherScreen.name,ns.AttendeeScreen.name,ns.SmartDeviceStream.name];function rs(t){return t&&-1!==os.indexOf(t.type.name)}function as(t){let e;return t&&t.asset&&(e=Object.keys(ss).find((e=>-1!==ss[e].ids.indexOf(t.asset.type.id)))),ss[e||"ImageOrVideo"]}function cs(t){const e=(i=t,Object.keys(ss).reduce(((t,e)=>{const n=ss[e];return n.id===i?n:t}),null));var i;const n=function(t){return Object.keys(ns).reduce(((e,i)=>{const n=ns[i];return n.id===t?n:e}),null)}(e.ids[0]),s=n.file;return new ds({type:n,folder:"",file:s})}function ls(t){const e=t.split(".").pop().toLowerCase();return-1!==ts.indexOf(e)?ns.Image:-1!==es.indexOf(e)?ns.Video:-1!==is.indexOf(e)?ns.Model:void 0}class ds{constructor(t){t&&Object.assign(this,t)}get payload(){const t={};return Object.keys(this).forEach((e=>{-1!==ds.allowedProps.indexOf(e)&&(t[e]=this[e])})),t}static fromUrl(t){const e=t.split("/"),i=e.pop(),n=e.join("/")+"/",s=ls(i);return new ds({type:s,folder:n,file:i})}static get defaultMediaAsset(){return{id:-1,type:{id:ns.Image,name:"image"},folder:"/textures/grid/",file:"grid.jpg"}}}function hs(t){return t.type.name,t=new ds(t)}ds.allowedProps=["id","type","folder","file","linkedPlayId","chromaKeyColor","autoplay","loop"];const us={id:"waiting-room",type:{id:1,name:"waiting-room"},name:"Waiting Room",likes:0,liked:!1,asset:{type:{id:1,name:"image"},folder:"/textures/waiting-room/",file:"waiting-room.jpg"},items:[],orientation:{latitude:0,longitude:0}};class ps{static get dataViews(){return this.data?this.data.views:[]}static get validViews(){return this.data?this.data.views.filter((t=>t.type.name!==gn.WaitingRoom.name)):[]}static get pathViews(){return this.validViews.filter((t=>t.path))}static get validPathViews(){return(this.editor?this.data.views:this.validViews).filter((t=>t.path))}static set action(t){this.action$_.next(t)}static get action(){return this.action$_.getValue()}static set viewId(t){this.action$_.next({viewId:t,keepOrientation:!1,useLastOrientation:!1})}static get viewId(){const t=this.action$_.getValue();return t?t.viewId:null}static getDataView(t){return this.dataViews.find((e=>e.id===t))||null}static get currentView(){const t=this.viewId;return null!==t?this.getDataView(t):null}static getValidPathId(t){if(!t)return null;return null==this.validPathViews.find((e=>e.id===t))?null:t}static getFirstPathId(){const t=this.editor&&null===this.path.id?this.dataViews:this.pathViews;return t.length?t[0].id:null}static data$(){if(!this.data$_){const t=(x.flags.production?"/api/view":`${x.assets}api/data.json`)+"?lang="+fe.lang;this.data$_=yi.get$(t).pipe(n.map((t=>(t.views=t.views.map((t=>In(t))),this.data=t,t))),n.shareReplay(1))}return this.data$_}static view$(){const t=new re,e=this.getValidPathId(t.viewId),i=this.getValidPathId(t.embedViewId)||e||this.getFirstPathId();return this.action$_.next({viewId:i}),this.action$_.pipe(n.distinctUntilChanged(((t,e)=>t.viewId===e.viewId)),n.map((t=>{let e=this.dataViews.find((e=>e.id===t.viewId));return e&&(e.keepOrientation=t.keepOrientation||!1,e.useLastOrientation=t.useLastOrientation||!1),e||this.getWaitingRoom()})))}static setDataAndPath(t,e){this.data=t,t.views.forEach((t=>{t.path=!e||-1===e.items.indexOf(t.id),t.items.forEach((t=>{let i=!0;e&&(t.type.name===fn.Nav.name&&(i=-1===e.items.indexOf(t.viewId)),t.path=i)}))})),this.path=e}static hostedView$(t,e){this.setDataAndPath(t,e),this.editor=!1;const s=this.getWaitingRoom();return i.combineLatest([this.view$(),this.hosted$()]).pipe(n.map((t=>{const e=t[0];return t[1]?e:s})),n.distinctUntilChanged(((t,e)=>t.id===e.id)),n.tap((t=>{if(t.id!==s.id){re.replaceWithOptions({viewId:t.id});const e=ps.getPrefetchAssets(t);t.prefetchAssets=e}})))}static editorView$(t,e){this.setDataAndPath(t,e),this.editor=!0;const i=this.getWaitingRoom();return this.view$().pipe(n.map((t=>{const n={pathId:null};return t.id!==i.id&&(n.viewId=t.id),e&&null!==e.id&&(n.pathId=e.id),re.replaceWithOptions(n),t})))}static hosted$(){return ee.state$.pipe(n.map((t=>t.hosted)),n.distinctUntilChanged())}static viewById$(t){return this.data$().pipe(n.map((e=>this.dataViews.find((e=>e.id===t)))))}static viewLike$(t){return t.liked?i.of(null):(t.liked=!0,x.flags.production?yi.get$(`/api/view/${t.id}/like`):(t.likes=t.likes||0,t.likes++,i.of(t)))}static setViewLike$(t){return this.viewById$(t.viewId).pipe(n.tap((e=>{e&&(e.likes=t.likes)})))}static getWaitingRoom(){return this.dataViews.find((t=>t.type.name===gn.WaitingRoom.name))||us}static getPrefetchAssets(t){const e=this.validPathViews;return t.items.filter((t=>t.type.name===fn.Nav.name&&null!=t.viewId)).map((t=>e.find((e=>e.id===t.viewId)))).filter((t=>t&&t.asset&&t.asset.type.name===ns.Image.name)).map((t=>x.getPath(t.asset.folder+t.asset.file)))}static addView(t){const e=this.data,i=e.views.slice();i.push(t),e.views=i,this.viewId=t.id}static deleteView(t){const e=this.data,i=e.views.slice(),n=i.reduce(((e,i,n)=>i.id===t.id?n:e),-1);if(n>0){i.splice(n,1),e.views=i;const t=this.dataViews;t.length>0&&(this.viewId=t[0].id)}}}ps.action$_=new i.BehaviorSubject(null);let ms=null;class vs{static get items$(){if(!ms){const t=cn.get("wishlist")||[];ms=new i.BehaviorSubject(t)}return ms}static getItems(){return this.items$.getValue()}static indexOf(t){return this.getItems().reduce(((e,i,n)=>-1===e&&i.viewId===t.viewId&&i.itemId===t.itemId?n:e),-1)}static has(t){return-1!==this.indexOf(t)}static add$(t){const e=this.getItems();return this.has(t)||(e.push(t),cn.set("wishlist",e),this.items$.next(e)),this.items$}static remove$(t){const e=this.getItems(),i=this.indexOf(t);return-1!==i&&(e.splice(i,1),cn.set("wishlist",e),this.items$.next(e)),this.items$}static toggle$(t){const e=this.getItems(),i=this.indexOf(t);return-1!==i?(e.splice(i,1),cn.set("wishlist",e),this.items$.next(e)):(e.push(t),cn.set("wishlist",e),this.items$.next(e)),this.items$}}class gs{constructor(t){this.loader=t}}class fs extends gs{}class Es extends gs{}class _s extends gs{}class Ss extends gs{}class bs extends gs{}class Ts{static getLoader(){return Ts.loader||(Ts.loader=new THREE.TextureLoader)}static getPath(t){return x.getPath(t.asset.folder+t.asset.file)}static loadTexture(t,e){const i=Ts.getPath(t);return Ts.getLoader().load(i,e)}static isVideo(t){return t.asset&&t.asset.file&&(-1!==t.asset.file.indexOf(".mp4")||-1!==t.asset.file.indexOf(".webm"))}static isStream(t){return rs(t.asset)}static isMutedStream(t){let e=!1;switch(t.asset.type.name){case ns.PublisherStream.name:e=ee.state.role===ie.Publisher;break;case ns.AttendeeStream.name:e=ee.state.role===ie.Attendee;break;case ns.PublisherScreen.name:case ns.AttendeeScreen.name:e=!0;break;case ns.SmartDeviceStream.name:e=ee.state.role===ie.SmartDevice}return e}static isPublisherStream(t){return t.asset&&t.asset.type.name===ns.PublisherStream.name}static isAttendeeStream(t){return t.asset&&t.asset.type.name===ns.AttendeeStream.name}static isSmartDeviceStream(t){return t.asset&&t.asset.type.name===ns.SmartDeviceStream.name}static isPublisherScreen(t){return t.asset&&t.asset.type.name===ns.PublisherScreen.name}static isAttendeeScreen(t){return t.asset&&t.asset.type.name===ns.AttendeeScreen.name}get isVideo(){return Ts.isVideo(this.item)}get isStream(){return Ts.isStream(this.item)}get isMutedStream(){return Ts.isMutedStream(this.item)}get isPublisherStream(){return Ts.isPublisherStream(this.item)}get isAttendeeStream(){return Ts.isAttendeeStream(this.item)}get isSmartDeviceStream(){return Ts.isSmartDeviceStream(this.item)}get isPublisherScreen(){return Ts.isPublisherScreen(this.item)}get isAttendeeScreen(){return Ts.isAttendeeScreen(this.item)}get isPlayableVideo(){return this.isVideo}get isAutoplayVideo(){return this.isStream}get muted(){return this.muted_}set muted(t){this.muted_=t,this.video&&this.isVideo&&(this.video.muted=!0===t)}constructor(t){this.item=t,this.toggle=this.toggle.bind(this),this.muted_=!1,this.subscription=ee.state$.subscribe((t=>this.muted=t.volumeMuted))}load(t){const e=this.item;let i;if(this.isStream&&e.streamId){const n=e.streamId,s=document.querySelector(`#stream-${n} video`);if(!s)return;const o=()=>{this.disposed||(s.removeEventListener("canplay",o),i=this.texture=new THREE.VideoTexture(s),i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter,i.mapping=THREE.UVMapping,i.needsUpdate=!0,"function"==typeof t&&t(i,this))},r=this.isMutedStream;s.crossOrigin="anonymous",s.volume=r?0:1,s.muted=r,s.readyState>=s.HAVE_FUTURE_DATA?o():s.addEventListener("canplay",o)}else if(this.isVideo){const n=e.asset&&e.asset.autoplay||!1,s=e.asset&&e.asset.loop||!1,o=this.video=document.createElement("video");o.crossOrigin="anonymous",o.preload="metadata",o.volume=.8,o.muted=n,o.playsInline=!0,o.loop=s;const r=()=>{this.disposed||(o.oncanplay=null,i=new THREE.VideoTexture(o),i.minFilter=THREE.LinearFilter,i.magFilter=THREE.LinearFilter,i.mapping=THREE.UVMapping,i.needsUpdate=!0,"function"==typeof t&&t(i,this),n?this.play(e.silent):o.pause())},a=()=>{this.disposed||Ts.events$.next(new Ss(this))},c=()=>{this.disposed||s||Ts.events$.next(new Es(this))};o.oncanplay=r,o.ontimeupdate=a,o.onended=c,o.src=Ts.getPath(e),o.load()}else e.asset?Ts.loadTexture(e,(e=>{this.disposed||(e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.mapping=THREE.UVMapping,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,"function"==typeof t&&t(e,this))})):t(null,this);return this}get progress(){return this.video?this.video.currentTime/this.video.duration:0}set progress(t){if(this.video){const e=this.video.duration*t;this.video.seekable.length>t&&this.video.currentTime!==e&&(this.video.currentTime=e,Ts.events$.next(new bs(this)))}}play(t){this.video&&(this.video.muted=this.muted_,this.video.play().then((()=>{t||Ts.events$.next(new fs(this))}),(t=>{console.log("MediaLoader.play.error",this.item.asset.file,t)})))}pause(t){this.video&&this.isVideo&&(this.video.muted=!0,this.video.pause(),t||Ts.events$.next(new Es(this)))}toggle(){if(this.video&&this.isVideo)return this.video.paused?(this.video.muted=this.muted_,this.play(),!0):(this.pause(),!1)}dispose(){this.subscription.unsubscribe(),this.pause(!0),this.isVideo&&this.video&&(this.video.ontimeupdate=null,this.video.onended=null,Ts.events$.next(new _s(this))),this.disposed=!0,delete this.video}}Ts.events$=new i.ReplaySubject(1);class ys{static get defaultGeometry(){return ys.defaultGeometry_||(ys.defaultGeometry_=new THREE.BoxBufferGeometry(1,1,1))}static get planeGeometry(){return ys.planeGeometry_||(ys.planeGeometry_=new THREE.PlaneBufferGeometry(1,1,2,2))}static get sphereGeometry(){return ys.sphereGeometry_||(ys.sphereGeometry_=new THREE.SphereBufferGeometry(3,12,12))}static get panoramaGeometry(){return ys.panoramaGeometry_||(ys.panoramaGeometry_=new THREE.SphereBufferGeometry(101,36,36))}}new THREE.Vector3;class ws{static get origin(){const t=this.host;if(t){const e=this.origin_;e.set(0,0,0);(t.renderer.xr.isPresenting?t.renderer.xr.getCamera(t.camera):t.camera).localToWorld(e)}return this.origin_}static getDistanceToCamera(t,e,i,n,s){void 0===s&&(s=.88);const o=2*Math.atan(Math.PI*e/360),r=n.y*t.zoom/o,a=n.x*t.zoom/o/i;return s*Math.max(r,a)}}ws.origin_=new THREE.Vector3;class Cs{}Cs.items=[],Cs.hittest=function(t,e,i){void 0===e&&(e=!1);let n=!1;this.down!==e&&(this.down=e,this.lock=!1,n=!0);const s=this.items.filter((t=>t.parent&&!t.freezed)),o=t.intersectObjects(s);let r,a;const c={};o.forEach(((t,e)=>{const i=t.object;r=i.uuid,0===e&&(this.lastIntersectedObject!==i||n?(this.lastIntersectedObject=i,a=i):i.intersection&&(Math.abs(i.intersection.point.x-t.point.x)>.01||Math.abs(i.intersection.point.y-t.point.y)>.01)&&(i.intersection=t,i.emit("move",i))),c[r]=t})),0===o.length&&(this.lastIntersectedObject=null);return s.forEach((t=>{t.intersection=c[t.uuid],t.over=t===this.lastIntersectedObject||t.intersection&&!t.depthTest&&(!this.lastIntersectedObject||this.lastIntersectedObject.depthTest),t.down=e&&t.over&&!this.lock,t.down&&(this.lock=!0)})),a}.bind(Cs),Cs.dispose=function(t){if(t){const e=this.items.indexOf(t);-1!==e&&this.items.splice(e,1)}}.bind(Cs);class Rs extends s.Mesh{get freezed(){return this.freezed_}set freezed(t){this.freezed_=t,this.children.filter((t=>t.__lookupGetter__("freezed"))).forEach((e=>e.freezed=t))}constructor(t,e){super(t=t||ys.defaultGeometry,e=e||new THREE.MeshBasicMaterial({color:16711935})),this.freezed=!1}freeze(){this.freezed=!0}unfreeze(){this.freezed=!1}}class Is extends Rs{constructor(t,e){super(t=t||ys.defaultGeometry,e=e||new THREE.MeshBasicMaterial({color:16711935})),this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}}class As extends Is{constructor(t,e){super(t,e),this.depthTest=!0,this.over_=!1,this.down_=!1,Cs.items.push(this)}get isInteractiveMesh(){return!0}get over(){return this.over_}set over(t){this.over_!=t&&(this.over_=t,t?this.emit("over",this):this.emit("out",this))}get down(){return this.down_}set down(t){t=t&&this.over,this.down_!=t&&(this.down_=t,t?this.emit("down",this):this.emit("up",this))}}class Os extends s.DataTextureLoader{constructor(t){super(t),this.type=s.HalfFloatType}parse(t){const e=function(t,e){switch(t){case 1:console.error("THREE.RGBELoader Read Error: "+(e||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(e||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(e||""));break;default:console.error("THREE.RGBELoader: Error: "+(e||""))}return-1},i=function(t,e,i){e=e||1024;let n=t.pos,s=-1,o=0,r="",a=String.fromCharCode.apply(null,new Uint16Array(t.subarray(n,n+128)));for(;0>(s=a.indexOf("\n"))&&o<e&&n<t.byteLength;)r+=a,o+=a.length,n+=128,a+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(n,n+128)));return-1<s&&(!1!==i&&(t.pos+=o+s+1),r+a.slice(0,s))},n=function(t,e,i,n){const s=t[e+3],o=Math.pow(2,s-128)/255;i[n+0]=t[e+0]*o,i[n+1]=t[e+1]*o,i[n+2]=t[e+2]*o,i[n+3]=1},o=function(t,e,i,n){const o=t[e+3],r=Math.pow(2,o-128)/255;i[n+0]=s.DataUtils.toHalfFloat(Math.min(t[e+0]*r,65504)),i[n+1]=s.DataUtils.toHalfFloat(Math.min(t[e+1]*r,65504)),i[n+2]=s.DataUtils.toHalfFloat(Math.min(t[e+2]*r,65504)),i[n+3]=s.DataUtils.toHalfFloat(1)},r=new Uint8Array(t);r.pos=0;const a=function(t){const n=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,o=/^\s*FORMAT=(\S+)\s*$/,r=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,a={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let c,l;if(t.pos>=t.byteLength||!(c=i(t)))return e(1,"no header found");if(!(l=c.match(/^#\?(\S+)/)))return e(3,"bad initial token");for(a.valid|=1,a.programtype=l[1],a.string+=c+"\n";c=i(t),!1!==c;)if(a.string+=c+"\n","#"!==c.charAt(0)){if((l=c.match(n))&&(a.gamma=parseFloat(l[1])),(l=c.match(s))&&(a.exposure=parseFloat(l[1])),(l=c.match(o))&&(a.valid|=2,a.format=l[1]),(l=c.match(r))&&(a.valid|=4,a.height=parseInt(l[1],10),a.width=parseInt(l[2],10)),2&a.valid&&4&a.valid)break}else a.comments+=c+"\n";return 2&a.valid?4&a.valid?a:e(3,"missing image size specifier"):e(3,"missing format specifier")}(r);if(-1!==a){const t=a.width,i=a.height,c=function(t,i,n){const s=i;if(s<8||s>32767||2!==t[0]||2!==t[1]||128&t[2])return new Uint8Array(t);if(s!==(t[2]<<8|t[3]))return e(3,"wrong scanline width");const o=new Uint8Array(4*i*n);if(!o.length)return e(4,"unable to allocate buffer space");let r=0,a=0;const c=4*s,l=new Uint8Array(4),d=new Uint8Array(c);let h=n;for(;h>0&&a<t.byteLength;){if(a+4>t.byteLength)return e(1);if(l[0]=t[a++],l[1]=t[a++],l[2]=t[a++],l[3]=t[a++],2!=l[0]||2!=l[1]||(l[2]<<8|l[3])!=s)return e(3,"bad rgbe scanline format");let i,n=0;for(;n<c&&a<t.byteLength;){i=t[a++];const s=i>128;if(s&&(i-=128),0===i||n+i>c)return e(3,"bad scanline data");if(s){const e=t[a++];for(let t=0;t<i;t++)d[n++]=e}else d.set(t.subarray(a,a+i),n),n+=i,a+=i}const u=s;for(let t=0;t<u;t++){let e=0;o[r]=d[t+e],e+=s,o[r+1]=d[t+e],e+=s,o[r+2]=d[t+e],e+=s,o[r+3]=d[t+e],r+=4}h--}return o}(r.subarray(r.pos),t,i);if(-1!==c){let e,r,l,d;switch(this.type){case s.FloatType:d=c.length/4;const t=new Float32Array(4*d);for(let e=0;e<d;e++)n(c,4*e,t,4*e);e=t,l=s.FloatType;break;case s.HalfFloatType:d=c.length/4;const i=new Uint16Array(4*d);for(let t=0;t<d;t++)o(c,4*t,i,4*t);e=i,l=s.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:t,height:i,data:e,header:a.string,gamma:a.gamma,exposure:a.exposure,format:r,type:l}}}return null}setDataType(t){return this.type=t,this}load(t,e,i,n){return super.load(t,(function(t,i){switch(t.type){case s.FloatType:case s.HalfFloatType:t.encoding=s.LinearEncoding,t.minFilter=s.LinearFilter,t.magFilter=s.LinearFilter,t.generateMipmaps=!1,t.flipY=!0}e&&e(t,i)}),i,n)}}class Ns{static keydown$(){return this.keydown$_||(this.keydown$_=i.fromEvent(window,"keydown").pipe(n.shareReplay(1))),this.keydown$_}static keyup$(){return this.keyup$_||(this.keyup$_=i.fromEvent(window,"keyup").pipe(n.shareReplay(1))),this.keyup$_}static keys$(){return this.keys$_||(this.keys$_=i.merge(this.keydown$(),this.keyup$()).pipe(n.map((t=>{const e=this.keys;return"keydown"===t.type?e[t.key]=!0:delete e[t.key],this.keys})),n.startWith(this.keys),n.shareReplay(1))),this.keys$_}static key$(){if(!this.key$_){const t=/\w/;this.key$_=this.keydown$().pipe(n.filter((e=>e.key&&e.key.match(t))),n.map((t=>t.key)),n.shareReplay(1))}return this.key$_}static typing$(){if(!this.typing$_){let t,e="";this.typing$_=this.key$().pipe(n.map((i=>(t&&clearTimeout(t),e+=i,t=setTimeout((()=>{e=""}),1500),e))),n.shareReplay(1))}return this.typing$_}}Ns.keys={};let ks=0;class Ls{static switchLoaders(){const t=Object.keys(this.items).map((t=>this.items[t])),e=t.length?i.combineLatest(t):i.of(t);this.progress$.next(e)}static getRef(){const t=++ks;return this.items[t]=new i.BehaviorSubject({loaded:0,total:1}),this.switchLoaders(),t}static setProgress(t,e,i){void 0===i&&(i=1);const n=this.items[t];n&&n.next({loaded:e,total:i}),e>=i&&setTimeout((()=>{delete this.items[t],this.switchLoaders()}),300),this.switchLoaders()}}Ls.progress={value:0,loaded:0,total:0,count:0,title:""},Ls.items={},Ls.progress$=new i.ReplaySubject(1).pipe(n.switchAll(),n.map((()=>{const t=Object.keys(Ls.items).map((t=>Ls.items[t])),e=t.reduce(((t,e,i,n)=>{const s=e.getValue(),o=s.loaded||0,r=s.total||1,a=o/r;return t.value+=a,t.loaded+=o,t.total+=r,t}),{value:0,loaded:0,total:0});return e.count=t.length,t.length&&(e.value/=e.count),e.title=`${Math.round(100*e.value)}%`,Ls.progress=e,e})));let Ps=0;const Ds="complete";class Ms{static worker(){return this.worker_||(this.worker_=new Worker(x.workers.prefetch)),this.worker_}static events$(t){if(!("Worker"in window))return i.of({type:Ds,data:t});const e=this.worker();e.postMessage({id:Ps});const s=++Ps;return e.postMessage({id:s,assets:t}),i.fromEvent(e,"message").pipe(n.map((t=>t.data)),n.filter((e=>e.assets===t)),n.tap((t=>{})),n.takeWhile((t=>t.type!==Ds),!0),n.finalize((()=>{e.postMessage({id:s})})))}static load$(t){return this.events$(t).pipe(n.filter((t=>t.type===Ds)),n.map((t=>t.data)))}static prefetch(t){x.flags.usePrefetch&&this.load$(t).pipe(n.first()).subscribe((t=>{}))}static cancel(){if(!("Worker"in window))return null;const t=this.worker();return t.postMessage({id:Ps}),t}}class xs{constructor(t){this.x=0,this.y=0,this.top=0,this.right=0,this.bottom=0,this.left=0,this.width=0,this.height=0,this.set(t)}static contains(t,e,i){return t.top<=i&&i<=t.bottom&&t.left<=e&&e<=t.right}static intersectRect(t,e){return!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)}static fromNode(t){if(!t)return;const e=t.rect_||(t.rect_=new xs);if(!t.getClientRects().length)return e;const i=t.getBoundingClientRect();return e.x=i.left,e.y=i.top,e.top=i.top,e.left=i.left,e.width=i.width,e.height=i.height,e.right=e.left+e.width,e.bottom=e.top+e.height,e.setCenter(),e}set(t){t&&(Object.assign(this,t),this.right=this.left+this.width,this.bottom=this.top+this.height),this.setCenter()}setSize(t,e){this.width=t,this.height=e,this.right=this.left+this.width,this.bottom=this.top+this.height,this.setCenter()}setCenter(){const t=this.center||(this.center={});t.top=this.top+this.height/2,t.left=this.left+this.width/2,t.x=t.left,t.y=t.top}contains(t,e){return xs.contains(this,t,e)}intersect(t){return xs.intersectRect(this,t)}intersection(t){const e=this.intersection_||(this.intersection_={left:0,top:0,width:0,height:0,x:0,y:0,pow:{x:-1,y:-1},offset:function(t){t=t||0;return(this.top-this.rect.height/2+t)/-this.height},scroll:function(t){t=t||0;return(this.top-this.rect.height/2+t)/-this.height}});e.left=this.left,e.top=this.top,e.width=this.width,e.height=this.height,e.x=this.left+this.width/2,e.y=this.top+this.height/2,e.rect=t;const i=e.offset(0);return e.pow.y=i,e}}const Us=[16763904,65484,52479,13434624,13369599,16777215];class Vs{static get headGeometry(){return this.headGeometry_||(this.headGeometry_=new THREE.SphereBufferGeometry(.2,36,24)),this.headGeometry_}constructor(t){const e=this.clientId=t.clientId,i=this.container=t.container,n=this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1,premultipliedAlpha:!0});n.setClearColor(0,1),n.setPixelRatio(window.devicePixelRatio),n.setSize(320,240),n.toneMapping=THREE.ACESFilmicToneMapping,n.toneMappingExposure=.8,n.outputEncoding=THREE.sRGBEncoding,i.appendChild(n.domElement);const s=this.camera=new THREE.PerspectiveCamera(70,320/240,.01,1e3);s.position.set(0,0,-.5),s.target=new THREE.Vector3,s.lookAt(s.target);const o=this.scene=new THREE.Scene,r=this.light=new THREE.PointLight(16777215,1,100);r.position.set(0,2,-2),o.add(r);const a=this.head=this.addHead();o.add(a),this.remote=Qi.getRemoteById(e)}addHead(){const t=Vs.headGeometry,e=this.canvas=document.createElement("canvas");e.width=1024,e.height=512,this.ctx=this.canvas.getContext("2d");const i=this.map=new THREE.CanvasTexture(e);i.offset.x=-.25;const n=Us[this.clientId%Us.length],s=new THREE.MeshStandardMaterial({map:i,color:n});return this.chalk(0),new THREE.Mesh(t,s)}render(){if(this.tick_?++this.tick_:this.tick_=1,this.remote){const t=12*this.remote.getAudioLevel();this.chalk(t)}const t=this.renderer,e=this.scene,i=this.camera;t.render(e,i)}update(t){const e=t.camera;this.head.quaternion.set(e[3],e[4],e[5],e[6])}dispose(){this.subscription&&this.subscription.unsubscribe()}chalk(t){t=(t+.5*Math.PI)%(2*Math.PI);const e=30*Math.sin(t),i=10*Math.cos(t),n=256,s=this.ctx;s.fillStyle="#888888",s.fillRect(0,0,1024,512),s.fillStyle="white",s.beginPath(),s.arc(472,206,7,0,2*Math.PI),s.arc(552,206,7,0,2*Math.PI),s.closePath(),s.fill(),s.beginPath(),s.moveTo(472-i,286),s.bezierCurveTo(472-i,316,552+i,316,552+i,286),s.bezierCurveTo(552+i,n+e,472-i,n+e,472-i,286),s.closePath(),s.fill(),this.map.needsUpdate=!0}}class Bs{static get defaultTexture(){return Bs.defaultTexture_||(Bs.defaultTexture_=(new THREE.TextureLoader).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyNpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDA2IDc5LjE2NDc1MywgMjAyMS8wMi8xNS0xMTo1MjoxMyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIyLjMgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjcyODFGQkE0QUMxODExRUJBQkRBQTEyMzUzMjUxRjg2IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjcyODFGQkE1QUMxODExRUJBQkRBQTEyMzUzMjUxRjg2Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzI4MUZCQTJBQzE4MTFFQkFCREFBMTIzNTMyNTFGODYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NzI4MUZCQTNBQzE4MTFFQkFCREFBMTIzNTMyNTFGODYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz55AlN+AAAAZUlEQVR42uzQAQEAAAQDMPTvfD3YIqyT1GdTzwkQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAAAECBAgQIECAgAtWgAEAVbYDfaostxgAAAAASUVORK5CYII="))}static get gridTexture(){return Bs.gridTexture_||(Bs.gridTexture_=(new THREE.TextureLoader).load(x.getPath(x.textures.grid)))}}class js extends As{static getLoader(){return js.loader||(js.loader=new THREE.TextureLoader)}static getTextureOff(){return js.textureOff||(js.textureOff=js.getLoader().load(x.getPath("textures/ui/play-off.png")))}static getTextureOn(){return js.textureOn||(js.textureOn=js.getLoader().load(x.getPath("textures/ui/play-on.png")))}static getMaterial(){return new THREE.MeshBasicMaterial({map:js.getTextureOff(),color:16777215,opacity:1,transparent:!0})}get playing(){return this.playing_}set playing(t){if(this.playing_!==t){this.playing_=t;this.material.map=t?js.getTextureOn():js.getTextureOff(),this.onOut()}}constructor(t){const e=ys.planeGeometry,i=js.getMaterial();super(e,i),this.playing_=!1,this.material=i,this.host=t,this.colorOff=new THREE.Color(i.color.getHex()),this.colorOn=new THREE.Color("#888888"),this.addEventListener()}update(t){const e=this.scale,i=t.scale.x/t.scale.y;e.set(.3/i,.3,1)}disposeMaterial(){this.material&&(this.material.map&&!1!==this.material.map.disposable&&this.material.map.dispose(),this.material.dispose())}dispose(){this.removeEventListener(),this.disposeMaterial()}onOver(){const t=this.material.color,e=this.colorOn,i=this.material;gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut}),gsap.to(i,{opacity:1,duration:.2,ease:Power2.easeInOut})}onOut(){const t=this.material.color,e=this.colorOff,i=this.material;gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut}),gsap.to(i,{opacity:this.playing?0:1,duration:.2,ease:Power2.easeInOut})}addEventListener(){this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this),this.on("over",this.onOver),this.on("out",this.onOut)}removeEventListener(){this.off("over",this.onOver),this.off("out",this.onOut)}}class Fs extends As{static getLoader(){return Fs.loader||(Fs.loader=new THREE.TextureLoader)}static getTextureOff(){return Fs.textureOff||(Fs.textureOff=Fs.getLoader().load(x.getPath("textures/ui/zoom-off.png")))}static getTextureOn(){return Fs.textureOn||(Fs.textureOn=Fs.getLoader().load(x.getPath("textures/ui/zoom-on.png")))}static getMaterial(){return new THREE.MeshBasicMaterial({map:Fs.getTextureOff(),color:16777215,opacity:1,transparent:!0})}get zoomed(){return this.zoomed_}set zoomed(t){if(this.zoomed_!==t){this.zoomed_=t;this.material.map=t?Fs.getTextureOn():Fs.getTextureOff()}}constructor(t){const e=ys.planeGeometry,i=Fs.getMaterial();super(e,i),this.zoomed_=!1,this.material=i,this.host=t,this.colorOff=new THREE.Color(i.color.getHex()),this.colorOn=new THREE.Color("#888888"),this.object=new THREE.Object3D,this.addEventListener()}disposeMaterial(){this.material&&(this.material.map&&!1!==this.material.map.disposable&&this.material.map.dispose(),this.material.dispose())}dispose(){this.removeEventListener(),this.disposeMaterial()}onOver(){const t=this.material.color,e=this.colorOn;this.material,gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut})}onOut(){const t=this.material.color,e=this.colorOff;this.material,gsap.to(t,{r:e.r,g:e.g,b:e.b,duration:.2,ease:Power2.easeInOut})}onToggle(){this.emit("zoomed",!this.zoomed)}addEventListener(){this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this),this.onToggle=this.onToggle.bind(this),this.on("over",this.onOver),this.on("out",this.onOut),this.on("down",this.onToggle)}removeEventListener(){this.off("over",this.onOver),this.off("out",this.onOut),this.off("down",this.onToggle)}}const Hs="\nvarying vec2 vUvShader;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\tvUvShader = uv;\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",Gs="\n#define USE_MAP\n#define threshold 0.55\n#define padding 0.05\nvarying vec2 vUvShader;\n\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\n// uniform sampler2D map;\nuniform sampler2D playMap;\nuniform vec2 mapResolution;\nuniform vec2 playMapResolution;\nuniform float mapTween;\nuniform float playMapTween;\nuniform vec3 playMapColor;\nuniform vec3 chromaKeyColor;\nuniform bool isVideo;\n\nvoid main() {\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\n\t// main\n\tvec4 mapRgba = texture2D(map, vUvShader);\n\tvec4 chromaKey = vec4(chromaKeyColor, 1.0);\n    vec3 chromaKeyDiff = mapRgba.rgb - chromaKey.rgb;\n    float chromaKeyValue = smoothstep(threshold - padding, threshold + padding, dot(chromaKeyDiff, chromaKeyDiff));\n\t/*\n\tif (isVideo) {\n\t\tvec4 playMapRgba = texture2D(playMap, vUvShader);\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2) + (playMapRgba.rgb * mapTween * playMapRgba.a), opacity * chromaKeyValue);\n\t} else {\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity * chromaKeyValue);\n\t}\n\t*/\n\t// diffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity * chromaKeyValue);\n\tdiffuseColor = vec4(mapRgba.rgb, opacity * chromaKeyValue);\n\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t// accumulation (baked indirect lighting only)\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t// modulation\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\n\t#include <envmap_fragment>\n\n\tgl_FragColor = vec4(outgoingLight, diffuseColor.a);\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n";class $s extends As{static getMaterial(t){return new THREE.ShaderMaterial({depthTest:!0,depthWrite:!0,transparent:!0,toneMapped:!1,vertexShader:Hs,fragmentShader:t?Gs:"\n#define USE_MAP\n\nvarying vec2 vUvShader;\n\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\n// uniform sampler2D map;\nuniform sampler2D playMap;\nuniform vec2 mapResolution;\nuniform vec2 playMapResolution;\nuniform float mapTween;\nuniform float playMapTween;\nuniform vec3 playMapColor;\nuniform bool isVideo;\n\nvoid main() {\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4(vec3(1.0), opacity);\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\n\t// main\n\tvec4 mapRgba = texture2D(map, vUvShader);\n\tif (isVideo) {\n\t\tvec4 playMapRgba = texture2D(playMap, vUvShader);\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2) + (playMapRgba.rgb * mapTween * playMapRgba.a), opacity);\n\t} else {\n\t\tdiffuseColor = vec4(mapRgba.rgb + (playMapColor * playMapTween * 0.2), opacity);\n\t}\n\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\n\tReflectedLight reflectedLight = ReflectedLight(vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0));\n\n\t// accumulation (baked indirect lighting only)\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",uniforms:{map:{type:"t",value:Bs.defaultTexture},mapResolution:{value:new THREE.Vector2},mapTween:{value:1},color:{value:new THREE.Color("#FFFFFF")},playMap:{type:"t",value:Bs.defaultTexture},playMapResolution:{value:new THREE.Vector2},playMapTween:{value:0},playMapColor:{value:new THREE.Color("#000000")},opacity:{value:0},isVideo:{value:!1}},extensions:{fragDepth:!0}})}static getChromaKeyMaterial(t){void 0===t&&(t=[0,1,0]);const e=new THREE.ShaderMaterial({depthTest:!0,depthWrite:!0,transparent:!0,toneMapped:!1,vertexShader:Hs,fragmentShader:Gs,uniforms:{map:{type:"t",value:null},mapResolution:{value:new THREE.Vector2},mapTween:{value:1},color:{value:new THREE.Color("#FFFFFF")},chromaKeyColor:{value:new THREE.Color(t[0],t[1],t[2])},playMap:{type:"t",value:Bs.defaultTexture},playMapResolution:{value:new THREE.Vector2},playMapTween:{value:0},playMapColor:{value:new THREE.Color("#000000")},opacity:{value:0},isVideo:{value:!1}},extensions:{fragDepth:!0}});return e.map=!0,e}static isPublisherStream(t){return t.clientInfo&&t.clientInfo.role===ie.Publisher&&t.clientInfo.uid===t.streamId}static isAttendeeStream(t){return t.clientInfo&&t.clientInfo.role===ie.Attendee&&t.clientInfo.uid===t.streamId}static isSmartDeviceStream(t){return t.clientInfo&&t.clientInfo.role===ie.SmartDevice&&t.clientInfo.uid===t.streamId}static isPublisherScreen(t){return t.clientInfo&&t.clientInfo.role===ie.Publisher&&t.clientInfo.screenUid===t.streamId}static isAttendeeScreen(t){return t.clientInfo&&t.clientInfo.role===ie.Attendee&&t.clientInfo.screenUid===t.streamId}static getTypeMatcher(t){let e;switch(t.name){case ns.PublisherStream.name:e=this.isPublisherStream;break;case ns.AttendeeStream.name:e=this.isAttendeeStream;break;case ns.SmartDeviceStream.name:e=this.isSmartDeviceStream;break;case ns.PublisherScreen.name:e=this.isPublisherScreen;break;case ns.AttendeeScreen.name:e=this.isAttendeeScreen;break;default:e=t=>!1}return e}static getStreamId$(t){if(!t.asset)return i.of(null);const e=t.asset.type,s=t.asset.file;return rs(t.asset)?Qi.streams$.pipe(n.map((i=>{let n,s=0;const o=this.getTypeMatcher(e);return i.forEach((e=>{o(e)&&(s===t.asset.index&&(n=e),s++)})),n?n.streamId:null}))):i.of(s)}static getMaterialByItem(t){let e;return e=t.asset&&t.asset.chromaKeyColor?$s.getChromaKeyMaterial(t.asset.chromaKeyColor):(t.asset,new THREE.MeshBasicMaterial({color:16777215,toneMapped:!1})),e}static getUniformsByItem(t){let e=null;return t.asset&&(e={mapTween:1,playMapTween:0,opacity:0}),e}get editing(){return this.editing_}set editing(t){this.editing_!==t&&(this.editing_=t,this.zoomed="media"===this.view.type.name||!t&&this.zoomed)}constructor(t,e,i,n){super(i,$s.getMaterialByItem(t)),this.zoomed_=!1,this.item=t,this.view=e,this.items=e.items,this.host=n,this.uniforms=$s.getUniformsByItem(t),this.object=new THREE.Object3D,this.tempPosition=new THREE.Vector3,this.tempRotation=new THREE.Vector3,t.silent=this.isAutoplayLoop,this.mediaLoader=new Ts(t),this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this),this.onToggle=this.onToggle.bind(this),this.onZoomed=this.onZoomed.bind(this),this.addPlayBtn(),this.addZoomBtn(),this.userData.render=(t,e)=>{this.render(this,t,e)}}load(t){if(this.playBtn&&this.remove(this.playBtn),this.zoomBtn&&this.remove(this.zoomBtn),!this.item.asset)return this.onAppear(),void("function"==typeof t&&t(this));const e=this.material;this.mediaLoader.load((i=>{const n=this.mediaLoader;n&&(i&&(e.map=i,e.uniforms&&(e.uniforms.map.value=i,e.uniforms.mapResolution.value=new THREE.Vector2(i.image.width||i.image.videoWidth,i.image.height||i.image.videoHeight),n.isPlayableVideo&&this.makePlayMap(i,(t=>{t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,e.uniforms.playMap.value=t,e.uniforms.playMapResolution.value=new THREE.Vector2(t.image.width,t.image.height),e.needsUpdate=!0})))),e.needsUpdate=!0,this.onAppear(),n.isPlayableVideo&&this.playBtn&&(e.uniforms&&(e.uniforms.isVideo.value=!0),this.on("over",this.onOver),this.on("out",this.onOut),this.on("down",this.onToggle),this.add(this.playBtn)),this.zoomBtn&&this.add(this.zoomBtn),"function"==typeof t&&t(this))}))}makePlayMap(t,e){const i=t.image.width||t.image.videoWidth,n=t.image.height||t.image.videoHeight,s=i/n,o=document.createElement("canvas");o.width=i,o.height=n;const r=o.getContext("2d");r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high";const a=new Image;a.onload=function(){const t=a.width/a.height;let c,l;s>t?(c=.32*n,l=c/t):(l=.32*i,c=l*t),r.drawImage(a,i/2-c/2,n/2-l/2,c,l);const d=new THREE.CanvasTexture(o);"function"==typeof e&&e(d)},a.crossOrigin="anonymous",a.src=x.getPath("textures/ui/play.png")}events$(){const t=this.item,e=this.items;return t.asset&&t.asset.linkedPlayId&&this.freeze(),Ts.events$.pipe(n.filter((e=>e.loader.item&&e.loader.item.id===t.id)),n.map((i=>{if(i instanceof fs?(this.playing=!0,this.isAutoplayLoop||(this.playBtn&&(this.playBtn.playing=!0),this.emit("playing",!0)),this.onOut()):i instanceof Es?(this.playing=!1,this.playBtn&&(this.playBtn.playing=!1),this.emit("playing",!1),this.onOut()):i instanceof bs&&this.emit("currentTime",i.loader.video.currentTime),t.asset&&t.asset.linkedPlayId){e.find((e=>e.asset&&-1!==i.src.indexOf(e.asset.file)&&i.id===t.asset.linkedPlayId))&&(i instanceof fs?this.play():i instanceof Es&&this.pause())}return i})))}onAppear(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,opacity:1,ease:Power2.easeInOut,onUpdate:()=>{e.uniforms.opacity.value=t.opacity}}),this.zoomed="media"===this.view.type.name||!this.editing&&this.zoomed}onDisappear(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,opacity:0,ease:Power2.easeInOut,onUpdate:()=>{e.uniforms.opacity.value=t.opacity}})}onOver(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,mapTween:this.playing?0:1,playMapTween:1,opacity:1,ease:Power2.easeInOut,overwrite:!0,onUpdate:()=>{e.uniforms.mapTween.value=t.mapTween,e.uniforms.playMapTween.value=t.playMapTween,e.uniforms.opacity.value=t.opacity}}),this.playBtn&&this.playBtn.onOver()}onOut(){const t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,mapTween:this.playing?0:1,playMapTween:0,opacity:1,ease:Power2.easeInOut,overwrite:!0,onUpdate:()=>{e.uniforms.mapTween.value=t.mapTween,e.uniforms.playMapTween.value=t.playMapTween,e.uniforms.opacity.value=t.opacity}}),this.playBtn&&this.playBtn.onOut()}onToggle(){this.playing=this.mediaLoader.toggle(),this.playBtn&&(this.playBtn.playing=this.playing),this.emit("playing",this.playing),this.onOut()}play(){this.mediaLoader.play()}pause(){this.mediaLoader.pause()}setPlayingState(t){this.playing!==t&&(this.playing=t,t?this.mediaLoader.play():this.mediaLoader.pause(),this.onOut(),this.playBtn&&(this.playBtn.playing=t))}setZoomedState(t){this.zoomed=t}setCurrentTime(t){this.mediaLoader.video&&(this.mediaLoader.video.currentTime=t)}disposeMaterial(){this.material&&(this.material.map&&!1!==this.material.map.disposable&&this.material.map.dispose(),this.material.dispose())}disposeMediaLoader(){const t=this.mediaLoader;t&&(t.isPlayableVideo&&(this.off("over",this.onOver),this.off("out",this.onOut),this.off("down",this.onToggle)),t.dispose(),this.mediaLoader=null)}dispose(){this.removePlayBtn(),this.removeZoomBtn(),this.disposeMediaLoader()}get isAutoplayLoop(){return"media"!==this.view.type.name&&this.item.asset&&this.item.asset.autoplay&&this.item.asset.loop}addPlayBtn(){if(this.removePlayBtn(),!this.isAutoplayLoop){const t=this.playBtn=new js(this.host);t.on("over",this.onOver),t.on("out",this.onOut),t.on("down",this.onToggle),t.position.z=.01}}removePlayBtn(){this.playBtn&&(this.remove(this.playBtn),this.playBtn.off("over",this.onOver),this.playBtn.off("out",this.onOut),this.playBtn.off("down",this.onToggle),this.playBtn.dispose(),delete this.playBtn)}onZoomed(t){this.zoomed=t,this.emit("zoomed",t)}addZoomBtn(){if(this.removeZoomBtn(),!("media"===this.view.type.name||this.item.asset&&this.item.asset.chromaKeyColor)){(this.zoomBtn=new Fs(this.host)).on("zoomed",this.onZoomed)}}removeZoomBtn(){this.zoomBtn&&(this.remove(this.zoomBtn),this.zoomBtn.off("zoomed",this.onZoomed),this.zoomBtn.dispose(),this.zoomBtn=null,delete this.zoomBtn)}updateByItem(t){this.disposeMaterial(),this.disposeMediaLoader(),this.material=$s.getMaterialByItem(t),this.uniforms=$s.getUniformsByItem(t),this.addPlayBtn(),this.addZoomBtn(),t.silent=this.isAutoplayLoop,this.mediaLoader=new Ts(t)}updateFromItem(t){t.position&&this.position.fromArray(t.position),t.rotation&&this.rotation.fromArray(t.rotation),t.scale&&this.scale.fromArray(t.scale),this.playBtn&&this.playBtn.update(this),this.updateZoom()}updateZoom(){if(this.originalPosition=this.position.clone(),this.originalScale=this.scale.clone(),this.originalQuaternion=this.quaternion.clone(),this.object.position.copy(this.originalPosition),this.object.scale.copy(this.originalScale),this.object.quaternion.copy(this.originalQuaternion),this.zoomBtn){const t=this.zoomBtn.scale,e=this.zoomBtn.position,i=this.scale.x/this.scale.y,n=.1;t.set(n/i,n,1),e.x=.5-n/i/2,e.y=n/2-.5,e.z=.01}}render(t,e){if(!this.editing){const t=this.object;this.zoomed&&!this.host.renderer.xr.isPresenting&&this.updateObjectMatrix(),this.position.copy(t.position),this.scale.copy(t.scale),this.quaternion.copy(t.quaternion)}}updateObjectMatrix(){const t=this.object,e=this.host;if(this.zoomed){const i=this.originalScale;let n,s=e.camera,o=s.fov,r=s.aspect;const a=this.tempPosition,c=this.tempRotation;n=.01;const l=e.renderer.xr;if(l.isPresenting){s=l.getCamera(s);const t=s.projectionMatrix.elements,e=t[0],i=t[5];r=i/e;o=57.29577951308232*(2*Math.atan(1/i)),n=1}t.scale.copy(i).multiplyScalar(n);const d=ws.getDistanceToCamera(s,o,r,t.scale);s.getWorldDirection(c),c.multiplyScalar(d),a.set(0,0,0),s.localToWorld(a),a.add(c),t.position.copy(a),t.lookAt(ws.origin),l.isPresenting&&(t.position.y-=t.scale.y/2)}}get zoomed(){return this.zoomed_}set zoomed(t){this.zoomed_!==t&&(this.zoomed_=t,t?(this.renderOrder=x.renderOrder.panel+5,this.material.depthTest=!0):(this.renderOrder=0,this.material.depthTest=!0,this.object.position.copy(this.originalPosition),this.object.scale.copy(this.originalScale),this.object.quaternion.copy(this.originalQuaternion)),this.material.needsUpdate=!0,this.updateObjectMatrix(),this.zoomBtn&&(this.zoomBtn.zoomed=t))}}class Ws{constructor(){this.x=0,this.y=0}}class zs{constructor(t){t&&Object.assign(this,t)}}class Ks extends zs{constructor(t){super(t),this.distance=new Ws,this.strength=new Ws,this.speed=new Ws}}class qs extends zs{constructor(t){super(t),this.distance=new Ws,this.strength=new Ws,this.speed=new Ws}}class Ys extends zs{constructor(t){super(t)}}let Js;class Xs{static getPosition(t,e){return t instanceof MouseEvent?e?(e.x=t.clientX,e.y=t.clientY):e={x:t.clientX,y:t.clientY}:window.TouchEvent&&t instanceof TouchEvent&&t.touches.length>0&&(e?(e.x=t.touches[0].pageX,e.y=t.touches[0].pageY):e={x:t.touches[0].pageX,y:t.touches[0].pageY}),e}static down$(t,e){let s;return i.merge(i.fromEvent(t,"mousedown").pipe(n.filter((t=>0===t.button))),i.fromEvent(t,"touchstart")).pipe(n.map((i=>{if(s=s||new Ks,s.node=t,s.target=i.target,s.originalEvent=i,s.down=this.getPosition(i,s.down),s.down)return s.distance=new Ws,s.strength=new Ws,s.speed=new Ws,e.next(s),s})),n.filter((t=>void 0!==t)))}static move$(t,e,s,o){let r;return i.fromEvent(document,o.originalEvent instanceof MouseEvent?"mousemove":"touchmove").pipe(n.startWith(o),n.map((i=>{r=r||new qs,r.node=t,r.target=i.target,r.originalEvent=i,r.position=this.getPosition(i,r.position);if(void 0!==o.down&&void 0!==r.position)return r.distance.x=r.position.x-o.down.x,r.distance.y=r.position.y-o.down.y,r.strength.x=r.distance.x/window.innerWidth*2,r.strength.y=r.distance.y/window.innerHeight*2,r.speed.x=o.speed.x+.1*(r.strength.x-o.strength.x),r.speed.y=o.speed.y+.1*(r.strength.y-o.strength.y),o.distance.x=r.distance.x,o.distance.y=r.distance.y,o.speed.x=r.speed.x,o.speed.y=r.speed.y,o.strength.x=r.strength.x,o.strength.y=r.strength.y,e.next(r),r})))}static dismissEvent(t,e,i,n){return Js=Js||new Ys,e.next(Js),i.next(),n&&Math.abs(n.distance.x)>10&&(t.preventDefault(),t.stopImmediatePropagation()),Js}static up$(t,e,s,o){return i.fromEvent(document,o.originalEvent instanceof MouseEvent?"mouseup":"touchend").pipe(n.map((t=>this.dismissEvent(t,e,s,o))))}static observe$(t){t=t||document;const e=Xs.events$,s=Xs.dismiss$;return this.down$(t,e).pipe(n.switchMap((o=>(Xs.downEvent=o,i.merge(this.move$(t,e,s,o),this.up$(t,e,s,o)).pipe(n.takeUntil(s))))),n.switchMap((()=>e)))}}Xs.events$=new i.ReplaySubject(1),Xs.dismiss$=new i.Subject;const Qs="panorama",Zs="model";class to{}class eo extends to{}const io=new eo,no=new class extends to{},so=new class extends to{};class oo{get dolly(){return this.dolly_}set dolly(t){const e=THREE.Math.clamp(t,1,75);this.dolly_!==e&&(this.dolly_=e,this.markAsDirty())}getDollyValue(){return 1-(this.dolly_-1)/74-.5}get zoom(){return this.zoom_}set zoom(t){const e=THREE.Math.clamp(t,1,75);this.zoom_!==e&&(this.zoom_=e,this.markAsDirty())}getZoomValue(){return 2-(this.zoom_-1)/74}get mode(){return this.mode_}set mode(t){this.mode_!==t&&(this.mode_=t,oo.mode=t,this.markAsDirty())}get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get isMediaView(){const t=ps.currentView;return t&&t.type.name===gn.Media.name}get locked(){return this.controlled||this.spying||this.isMediaView}constructor(t){this.mode_=oo.mode=Qs,this.dolly_=70,this.zoom_=70,this.longitude=0,this.latitude=0,this.direction=1,this.radius=101,this.position=new THREE.Vector3,this.inertia=new THREE.Vector2,this.rotation=new THREE.Euler(0,0,0,"XYZ"),this.target=new THREE.Vector3,this.updatePosition=new THREE.Vector3,this.updateTarget=new THREE.Vector3,this.camera=t,this.setLongitudeLatitude(0,0),this.events$=new i.ReplaySubject(1)}setOrientation(t){t&&(this.setLongitudeLatitude(t.longitude,t.latitude),this.markAsDirty())}getOrientation(){return{latitude:this.latitude,longitude:this.longitude}}setLongitudeLatitude(t,e){e=Math.max(-80,Math.min(80,e)),this.longitude=(t<0?360+t:t)%360,this.latitude=e;const i=THREE.Math.degToRad(90-e),n=THREE.Math.degToRad(t);this.phi=i,this.theta=n}observe$(t){let e,s;return i.combineLatest([Ns.keys$(),Xs.observe$(t)]).pipe(n.filter((t=>!this.locked)),n.map((t=>{const i=t[0],n=t[1];if(n instanceof Ks)e=this.latitude,s=this.longitude;else if(n instanceof qs)if(i.Shift)this.events$.next(no);else if(i.Control)this.events$.next(so);else{const t=this.mode_===Zs?-1:1;this.setLongitudeLatitude(s-.1*n.distance.x*t,e+.1*n.distance.y)}return n})),n.filter((t=>t instanceof qs)),n.startWith({latitude:this.latitude,longitude:this.longitude}),n.tap((t=>this.markAsDirty())),n.switchMap((t=>this.events$)))}walk(t,e){let i;if(this.mode_===Zs)i=3;else i=this.radius;const n=new THREE.Vector2(t.x,t.y).normalize().multiplyScalar(i),s=Math.atan2(n.y,n.x);let o=THREE.MathUtils.radToDeg(s);o=(o<0?360+o:o)%360;const r=this.latitude,a=this.longitude;let c=o-a;c=Math.abs(c)>180?c-c/Math.abs(c)*360:c;let l=0-r;l=Math.abs(l)>90?l-l/Math.abs(l)*90:l;const d={tween:0};gsap.to(d,{duration:.7,tween:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{this.setLongitudeLatitude(a+c*d.tween,r+l*d.tween),this.position.set(t.x*d.tween,0,t.y*d.tween),this.markAsDirty()},onComplete:()=>{"function"==typeof e&&e(o,0)}})}walkComplete(t,e){this.setLongitudeLatitude(t,e),this.position.set(0,0,0),this.markAsDirty()}lookAt(t){if(t){let e=t.position.clone();let i;if(e=this.camera.parent.worldToLocal(e),this.mode_===Zs)i=3;else i=this.radius;const n=new THREE.Vector3(e.x,e.z,e.y).normalize().multiplyScalar(i),s=Math.atan2(n.y,n.x),o=Math.acos(n.z/i);let r=THREE.MathUtils.radToDeg(s);r=(r<0?360+r:r)%360;let a=90-THREE.MathUtils.radToDeg(o);a=Math.max(-80,Math.min(80,a)),this.setLongitudeLatitude(r,a),this.markAsDirty()}}setVRCamera(t){if(t){const e=this.radius,i=new THREE.Vector3(0,0,-e),n=new THREE.Quaternion(t[3],t[4],t[5],t[6]);i.applyQuaternion(n);const s=new THREE.Vector3(i.x,i.z,i.y).normalize().multiplyScalar(e),o=Math.atan2(s.y,s.x),r=Math.acos(s.z/e);let a=THREE.MathUtils.radToDeg(o);a=(a<0?360+a:a)%360;let c=90-THREE.MathUtils.radToDeg(r);c=Math.max(-80,Math.min(80,c)),this.setLongitudeLatitude(a,c),this.markAsDirty()}}render(){ee.state.hosted||(this.longitude+=.025,this.isDirty=!0),this.isDirty&&(this.isDirty=!1,this.update())}markAsDirty(){this.isDirty=!0}update(){let t,e=this.updatePosition,i=this.updateTarget;const n=this.getZoomValue();this.getDollyValue();const s=THREE.MathUtils.degToRad(90-this.latitude),o=THREE.MathUtils.degToRad(this.longitude),r=this.camera,a=r.parent;if(this.mode_===Zs)t=3,e.copy(this.position),i.x=this.position.x+t*Math.sin(s)*Math.cos(o),i.y=this.position.y+t*Math.cos(s),i.z=this.position.z+t*Math.sin(s)*Math.sin(o),i=a.worldToLocal(i),r.target.copy(e),r.position.copy(i);else t=this.radius,i.x=this.position.x+t*Math.sin(s)*Math.cos(o),i.y=this.position.y+t*Math.cos(s),i.z=this.position.z+t*Math.sin(s)*Math.sin(o),e.copy(this.position),i=a.worldToLocal(i),r.target.copy(i),r.position.copy(e);r.zoom=n,r.lookAt(r.target),r.updateProjectionMatrix();const c=ps.currentView;c&&(c.lastOrientation.longitude=this.longitude,c.lastOrientation.latitude=this.latitude),this.events$.next(io)}}oo.orbitMoveEvent=io;let ro=0;const ao="progress",co="complete";class lo{static worker(){return this.worker_||(this.worker_=new Worker(x.workers.image)),this.worker_}static events$(t,e){if(!("Worker"in window)||this.isBlob(t)||this.isCors(t))return i.of({type:co,data:t});const s=++ro,o=this.worker();return o.postMessage({src:t,id:s,size:e}),i.fromEvent(o,"message").pipe(n.map((t=>t.data)),n.filter((e=>e.src===t)),n.auditTime(100),n.map((t=>{if(t.type===co&&t.data instanceof Blob){const e=URL.createObjectURL(t.data);t.data=e}return t})),n.takeWhile((t=>t.type!==co),!0),n.finalize((()=>{o.postMessage({id:s})})))}static load$(t,e){return this.events$(t,e).pipe(n.filter((t=>t.type===co)),n.map((t=>t.data)))}static isCors(t){return!1}static isBlob(t){return 0===t.indexOf("blob:")}}class ho{static get video(){return this.video_}static set video(t){if(this.video_&&(this.video_.muted=!0,this.video_.pause(),this.video_.parentNode&&this.video_.parentNode.removeChild(this.video_),this.video_=null),t){const t=this.video_=document.createElement("video");t.loop=!0,t.playsInline=!0,t.crossOrigin="anonymous"}}static get muted(){return this.muted_}static set muted(t){this.muted_=t,this.video&&(this.video.muted=!0===t)}static set cubeRenderTarget(t){this.cubeRenderTarget_&&(this.cubeRenderTarget_.texture.dispose(),this.cubeRenderTarget_.dispose()),this.cubeRenderTarget_=t}static set texture(t){this.texture_&&this.texture_.dispose(),this.texture_=t}static load(t,e,i){if(Ts.events$.next(new _s(this)),this.video=null,t)return t.type.name===ns.PublisherStream.name?this.loadPublisherStreamBackground(e,i):t.type.name===ns.AttendeeStream.name?this.loadAttendeeStreamBackground(e,i):-1!==t.file.indexOf(".mp4")||-1!==t.file.indexOf(".webm")?this.loadVideoBackground(x.getPath(t.folder),t.file,e,i):-1!==t.file.indexOf(".m3u8")?this.loadHlslVideoBackground(t.file,e,i):-1!==t.file.indexOf(".hdr")?this.loadRgbeBackground(x.getPath(t.folder),t.file,e,i):this.loadBackgroundImageService(x.getPath(t.folder),t.file,e,i)}static loadBackgroundImageService(t,e,s,o){const r=Ls.getRef(),a=new Image;lo.events$(t+e).pipe(n.tap((t=>{t.type===ao&&Ls.setProgress(r,t.data.loaded,t.data.total)})),n.filter((t=>t.type===co)),n.switchMap((t=>{const e=i.fromEvent(a,"load");return a.crossOrigin="anonymous",a.src=t.data,e})),n.takeWhile((t=>t.type!==co),!0)).subscribe((t=>{const e=new THREE.Texture(a);e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.mapping=THREE.UVMapping,e.toneMapped=!1,e.needsUpdate=!0,"function"==typeof o&&(o(e),URL.revokeObjectURL(t.data)),Ls.setProgress(r,1)}))}static loadBackground(t,e,i,n){const s=Ls.getRef(),o=new THREE.TextureLoader;return o.setPath(t).load(e,(t=>{t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof n&&n(t),Ls.setProgress(s,1)}),(t=>{Ls.setProgress(s,t.loaded,t.total)})),o}static loadRgbeBackground(t,e,i,n){const s=Ls.getRef(),o=new Os;return o.setDataType(THREE.UnsignedByteType).setPath(t).load(e,(t=>{"function"==typeof n&&n(t,!0),Ls.setProgress(s,1)}),(t=>{Ls.setProgress(s,t.loaded,t.total)})),o}static loadHlslVideoBackground(t,e,i){const n=Ls.getRef(),s=document.createElement("video");if(s.oncanplay=()=>{(()=>{s.oncanplay=null;const t=new THREE.VideoTexture(s);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof i&&i(t),Ls.setProgress(n,1)})()},Hls.isSupported()){var o=new Hls;o.attachMedia(s),o.on(Hls.Events.MEDIA_ATTACHED,(()=>{o.loadSource(t),o.on(Hls.Events.MANIFEST_PARSED,((t,e)=>{s.play()}))}))}}static get progress(){const t=this.video;return t?t.currentTime/t.duration:0}static set progress(t){const e=this.video;if(e){const i=e.duration*t;e.seekable.length>t&&e.currentTime!==i&&(e.currentTime=i,Ts.events$.next(new bs(this)))}}static play(t){const e=this.video;e&&(e.muted=this.muted_,e.play().then((()=>{t||Ts.events$.next(new fs(this))}),(t=>{console.log("PanoramaLoader.play.error",e.src,t)})))}static pause(t){const e=this.video;e&&(e.muted=!0,e.pause(),t||Ts.events$.next(new Es(this)))}static loadVideoBackground(t,e,i,n){const s=Ls.getRef();this.video=!0;const o=this.video;o.oncanplay=()=>{o.oncanplay=null;const t=new THREE.VideoTexture(o);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof n&&n(t),Ls.setProgress(s,1),this.play()},o.ontimeupdate=()=>{Ts.events$.next(new Ss(this))},o.onended=()=>{},o.crossOrigin="anonymous",o.src=t+e,o.load()}static loadPublisherStreamBackground(t,e){const i=t=>{const i=document.querySelector(`#stream-${t} video`);if(!i)return;const n=()=>{const t=this.texture=new THREE.VideoTexture(i);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};i.crossOrigin="anonymous",i.readyState>=i.HAVE_FUTURE_DATA?n():i.oncanplay=()=>{n()}};Qi.getPublisherStreamId$().pipe(n.first()).subscribe((t=>i(t)))}static loadAttendeeStreamBackground(t,e){const i=t=>{const i=document.querySelector(`#stream-${t} video`);if(!i)return;const n=()=>{const t=this.texture=new THREE.VideoTexture(i);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};i.crossOrigin="anonymous",i.readyState>=i.HAVE_FUTURE_DATA?n():i.oncanplay=()=>{n()}};Qi.getAttendeeStreamId$().pipe(n.first()).subscribe((t=>i(t)))}static loadStreamBackground(t,e,i){const s=t=>{const i=document.querySelector(`#stream-${t} video`);if(!i)return;const n=()=>{const t=this.texture=new THREE.VideoTexture(i);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};i.crossOrigin="anonymous",i.readyState>=i.HAVE_FUTURE_DATA?n():i.oncanplay=()=>{n()}};ho.getStreamId$(i).pipe(n.takeUntil(Ts.events$.pipe(n.filter((t=>t instanceof _s))))).subscribe((t=>{s(t)}))}static getStreamId$(t){const e=t.type;return Qi.streams$.pipe(n.map((i=>{let n,s=0;const o=$s.getTypeMatcher(e);return i.forEach((e=>{o(e)&&(s===t.index&&(n=e),s++)})),n?n.streamId:null})))}}class uo{constructor(t){this.muted_=!1,this.subscription=ee.state$.subscribe((t=>ho.muted=t.volumeMuted)),this.tween=0,this.create(t)}create(t){this.renderer=t,this.onCubeMapDispose=this.onCubeMapDispose.bind(this);const e=new THREE.BoxGeometry(202,202,202),i=this.getBlackMaterial(),n=new As(e,i);n.userData={render:(t,e,i,s,o)=>{n.matrixWorld.copyPosition(o.matrixWorld);const r=this.cubeMap,a=this.texture;r&&a&&a.isVideoTexture&&this.updateCubeMapEquirectangularTexture(r,i,a)}},n.name="[panorama]",this.mesh=n}getBlackMaterial(){return new THREE.MeshBasicMaterial({name:"PanoramaStandardMaterial",color:0,side:THREE.BackSide,depthTest:!1,depthWrite:!1,fog:!1})}getShaderMaterial(t){const e=new THREE.ShaderMaterial({name:"PanoramaCubeMaterial",uniforms:this.cloneUniforms(THREE.ShaderLib.cube.uniforms),vertexShader:THREE.ShaderLib.cube.vertexShader,fragmentShader:THREE.ShaderLib.cube.fragmentShader,side:THREE.BackSide,depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1});t.mapping=THREE.EquirectangularReflectionMapping;const i=this.toCubeMap(t,this.renderer);return e.map=i,e.uniforms.envMap.value=i,e.uniforms.flipEnvMap.value=i.isCubeTexture&&i._needsFlipEnvMap?-1:1,e.needsUpdate=!0,this.mesh.geometry.deleteAttribute("normal"),this.mesh.geometry.deleteAttribute("uv"),Object.defineProperty(e,"envMap",{get:function(){return this.uniforms.envMap.value},configurable:!0}),e}makeEnvMap(t){let e=this.mesh.material;if(e.uniforms){t.mapping=THREE.EquirectangularReflectionMapping;const i=this.toCubeMap(t,this.renderer);e.map=i,e.uniforms.envMap.value=i,e.uniforms.flipEnvMap.value=i.isCubeTexture&&i._needsFlipEnvMap?-1:1,e.needsUpdate=!0}else e.dispose(),e=this.getShaderMaterial(t),this.mesh.material=e}toCubeMap(t,e){this.cubeMap&&this.cubeMap.dispose();const i=t.image,n=i.height||i.videoHeight,s=new THREE.WebGLCubeRenderTarget(n/2,{generateMipmaps:!0,type:THREE.HalfFloatType,encoding:THREE.LinearEncoding,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,mapping:THREE.CubeUVReflectionMapping,format:THREE.RGBAFormat});return s.addEventListener("dispose",this.onCubeMapDispose),this.setCubeMapEquirectangularTexture(s,t),this.updateCubeMapEquirectangularTexture(s,e,t),this.cubeMap=s,this.texture=t,this.mapTextureMapping(s.texture,t.mapping)}setCubeMapEquirectangularTexture(t,e){t.texture.type=e.type,t.texture.format=THREE.RGBAFormat,t.texture.encoding=THREE.sRGBEncoding,t.texture.generateMipmaps=e.generateMipmaps,t.texture.minFilter=e.minFilter,t.texture.magFilter=e.magFilter,t.texture.needsUpdate=!0;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\t\t\t\t\tvarying vec3 vWorldDirection;\n\t\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\t\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\t\t\t\t\t}\n\t\t\t\t\tvoid main() {\n\t\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\t\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t\t#include <project_vertex>\n\t\t\t\t\t}\n\t\t\t\t",fragmentShader:"\n\t\t\t\t\tuniform sampler2D tEquirect;\n\t\t\t\t\tvarying vec3 vWorldDirection;\n\t\t\t\t\t#include <common>\n\t\t\t\t\tvoid main() {\n\t\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\t\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\t\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t\t\t\t\t}\n\t\t\t\t"},n=new THREE.BoxGeometry(5,5,5),s=new THREE.ShaderMaterial({name:"CubemapFromEquirect",uniforms:this.cloneUniforms(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:THREE.BackSide,blending:THREE.NoBlending});s.uniforms.tEquirect.value=e;const o=new THREE.Mesh(n,s),r=new THREE.CubeCamera(1,10,t);return t.camera=r,t.mesh=o,t}updateCubeMapEquirectangularTexture(t,e,i){const n=i.minFilter;i.minFilter===THREE.LinearMipmapLinearFilter&&(i.minFilter=THREE.LinearFilter),t.camera.update(e,t.mesh),i.minFilter=n}cloneUniforms(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const s=t[i][n];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?e[i][n]=s.clone():Array.isArray(s)?e[i][n]=s.slice():e[i][n]=s}}return e}mapTextureMapping(t,e){return e===THREE.EquirectangularReflectionMapping?t.mapping=THREE.CubeReflectionMapping:e===THREE.EquirectangularRefractionMapping&&(t.mapping=THREE.CubeRefractionMapping),t}onCubeMapDispose(){const t=this.cubeMap;t&&(t.removeEventListener("dispose",this.onCubeMapDispose),t.texture.dispose(),t.mesh.geometry.dispose(),t.mesh.material.dispose(),void 0!==t&&(this.cubeMap=null))}change(t,e,i,n){const s=t instanceof Sn?t.tiles[t.index_]:t,o=this.mesh.material;this.load(s,e,(e=>{"function"==typeof n&&n(t),o.uniforms&&o.uniforms.uTween&&(o.uniforms.uTween.value=1,o.needsUpdate=!0),"function"==typeof i&&i(e)}))}crossfade(t,e,i){const n=this.mesh.material;this.load(t,e,(t=>{n.uniforms&&n.uniforms.uTween&&(n.uniforms.uTween.value=1,n.needsUpdate=!0),"function"==typeof i&&i(t)}))}getLocalizedAsset(t){if(t&&t.locale){const e=t.locale[fe.lang];e&&(t=e)}return t}load(t,e,i){const n=t.type.name===gn.Media.name?ds.defaultMediaAsset:t.asset;if(!n)return;if(n.type.name===ns.Model.name)return void("function"==typeof i&&i(null));const s=this.getLocalizedAsset(n);this.currentAsset=s.folder+s.file,ho.load(s,e,((t,e)=>{if(s.folder+s.file!==this.currentAsset)return void t.dispose();const n=this.makeEnvMap(t);"function"==typeof i&&i(n)}))}dispose(){this.subscription.unsubscribe(),this.cubeMap&&this.cubeMap.dispose()}}const po=4/3,mo=[16777215,16763904,65484,52479,13434624,13369599];class vo{static get geometry(){return new THREE.PlaneBufferGeometry(.12,.09,2,2)}setRemote(t,e,i){this.remote=t;let n,s,o,r,a,c,l;i<4?(n=1,s=0,o=e,r=.12*n,a=r/po,c=0,l=a/2-i*a/2,this.plane.position.set(c,l+a*e,.005)):(n=.5,s=e%2,o=Math.floor(e/2),r=.12*n,a=r/po,c=-r/2,l=a/2-Math.ceil(i/2)*a/2,this.plane.position.set(c+s*r,l+o*a,.005)),this.plane.scale.set(n,n,n),"number"==typeof t?this.plane.material.color.set(mo[e%mo.length]):t.texture?(this.plane.material.map=t.texture,this.plane.material.needsUpdate=!0):this.addStreamTexture(t.streamId,(e=>{t.texture=e,this.plane.material.map=e,this.plane.material.needsUpdate=!0}))}addStreamTexture(t,e){const i=`#stream-${t}`,n=document.querySelector(`${i} video`);if(!n)return;const s=()=>{const t=new THREE.VideoTexture(n);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.needsUpdate=!0,"function"==typeof e&&e(t)};n.crossOrigin="anonymous",n.readyState>=n.HAVE_FUTURE_DATA?s():n.oncanplay=()=>{s()}}constructor(){const t=vo.geometry,e=new THREE.MeshBasicMaterial({color:16777215});this.plane=new THREE.Mesh(t,e)}}class go{set remotes(t){t.forEach(((e,i)=>{let n=this.streams[i];n||(n=new vo),n.setRemote(e,i,t.length),this.phone.add(n.plane),this.streams[i]=n}));for(let e=t.length;e<this.streams.length;e++)this.phone.remove(this.streams[e].plane);this.streams.length=t.length}constructor(){const t=this.mesh=new THREE.Group,e=this.phone=this.create();t.add(e),this.streams=[],Qi.remotes$.subscribe((t=>{this.remotes=t}))}create(){const t=new THREE.BoxBufferGeometry(.12,.27,.005,2,2,1),e=new THREE.MeshStandardMaterial({color:0,transparent:!0,opacity:.6}),i=new THREE.Mesh(t,e);return i.rotation.set(-Math.PI/4,0,0),i}}class fo{constructor(t){void 0===t&&(t="#ffffff"),this.position=new THREE.Vector3;const e=ys.planeGeometry,i=(new THREE.TextureLoader).load(x.getPath("textures/ui/nav-point.png")),n=new THREE.MeshBasicMaterial({color:new THREE.Color(t),depthTest:!1,depthWrite:!1,map:i,transparent:!0,opacity:.9}),s=this.mesh=new THREE.Mesh(e,n);s.renderOrder=x.renderOrder.pointer,s.position.set(-1e5,-1e5,-1e5)}update(t){if(Cs.lastIntersectedObject){const e=this.position;e.copy(Cs.lastIntersectedObject.intersection.point),e.multiplyScalar(.99);const i=this.mesh;i.position.set(e.x,e.y,e.z),e.sub(t.position);const n=e.length()/80;i.scale.set(n,n,n),i.lookAt(ws.origin)}}setPosition(t,e,i,n){const s=this.position;s.set(t,e,i).multiplyScalar(80);const o=this.mesh;o.position.copy(s),s.sub(n.position);const r=s.length()/80;o.scale.set(r,r,r),o.lookAt(ws.origin)}}class Eo{constructor(){this.gravity=new THREE.Vector3(0,-9.8,0),this.controllerPosition=new THREE.Vector3,this.controllerDirection=new THREE.Vector3,this.currentPosition=new THREE.Vector3,this.targetPosition=new THREE.Vector3;const t=new THREE.BufferGeometry,e=this.vertices=new Float32Array(33);e.fill(0);const i=new Float32Array(33);i.fill(.5),t.setAttribute("position",new THREE.BufferAttribute(e,3)),t.setAttribute("color",new THREE.BufferAttribute(i,3));const n=new THREE.LineBasicMaterial({vertexColors:!0,blending:THREE.AdditiveBlending});this.line=new THREE.Line(t,n);const s=(new THREE.TextureLoader).load(x.getPath("textures/ui/nav-point.png"));(this.target=new THREE.Mesh(new THREE.PlaneBufferGeometry(.3,.3,1,1),new THREE.MeshBasicMaterial({map:s,blending:THREE.AdditiveBlending,color:5592405,transparent:!0}))).rotation.x=-Math.PI/2}addToController(t,e){this.currentController=t,t.add(this.line),e.add(this.target)}removeFromController(t,e,i,n,s){const o=this.currentController;if(o===t){const t=this.gravity,r=this.currentPosition,a=this.controllerPosition,c=this.controllerDirection;i.xr.getCamera(n).getWorldPosition(r),r.y=0,o.getWorldPosition(a),o.getWorldDirection(c),c.multiplyScalar(6);const l=(-c.y+Math.sqrt(c.y**2-2*a.y*t.y))/t.y,d=this.getPositionT(this.targetPosition,l,a,c,t);d.addScaledVector(r,-1),s.position.add(d),this.currentController=null,o.remove(this.line),e.remove(this.target)}}update(){const t=this.currentController;if(t){const e=this.gravity,i=this.controllerPosition,n=this.controllerDirection,s=this.targetPosition;t.getWorldPosition(i),t.getWorldDirection(n),n.multiplyScalar(6);const o=(-n.y+Math.sqrt(n.y**2-2*i.y*e.y))/e.y,r=s.set(0,0,0);for(let s=1;s<=10;s++)this.getPositionT(r,s*o/10,i,n,e),t.worldToLocal(r),r.toArray(this.vertices,3*s);this.line.geometry.attributes.position.needsUpdate=!0,this.getPositionT(this.target.position,.98*o,i,n,e)}}getPositionT(t,e,i,n,s){return t.copy(i),t.addScaledVector(n,e),t.addScaledVector(s,.5*e**2),t}}const _o="waiting",So="enabled",bo="ended",To="started",yo="disabled",wo="needs-https",Co="unavailable";class Ro{static getService(){return this.service_||(this.service_=new Ro),this.service_}get status(){return this.status$.getValue()}get state(){return this.state$.getValue()}constructor(){if(Ro.service_)throw"VRService is a singleton class!";const t=this.state_={camera:{position:new THREE.Vector3,quaternion:new THREE.Quaternion,scale:new THREE.Vector3,array:new Array(10).fill(0)}};this.onSessionStarted=this.onSessionStarted.bind(this),this.onSessionEnded=this.onSessionEnded.bind(this),this.status$=new i.BehaviorSubject(_o),this.session$=new i.Subject,this.state$=new i.BehaviorSubject(t),this.currentSession=null,"xr"in navigator?navigator.xr.isSessionSupported("immersive-vr").then((t=>{t?this.status$.next(So):this.status$.next(yo)})):!1===window.isSecureContext?this.status$.next(wo):this.status$.next(Co)}onSessionStarted(t){t.addEventListener("end",this.onSessionEnded),this.currentSession=t,this.session$.next(t),this.status$.next(To)}onSessionEnded(){this.currentSession.removeEventListener("end",this.onSessionEnded),this.currentSession=null,this.session$.next(null),this.status$.next(bo)}toggleVR(t){if(null===this.currentSession){const t={optionalFeatures:["local-floor","bounded-floor"]};navigator.xr.requestSession("immersive-vr",t).then(this.onSessionStarted)}else this.currentSession.end()}isDisabled(){switch(this.status$.getValue()){case _o:case yo:case wo:case Co:return!0;default:return!1}}getLabel(){let t;switch(this.status$.getValue()){case _o:t="Waiting VR";break;case So:case bo:t="Enter VR";break;case To:t="Exit VR";break;case yo:t="VR Disabled";break;case wo:t="VR Needs Https";break;case Co:t="VR Unavailable"}return t}updateState(t){if(this.status===To){t.renderer,t.scene;const e=t.camera,i=this.state_;e.matrixWorld.decompose(i.camera.position,i.camera.quaternion,i.camera.scale),i.camera.array[0]=i.camera.position.x,i.camera.array[1]=i.camera.position.y,i.camera.array[2]=i.camera.position.z,i.camera.array[3]=i.camera.quaternion.x,i.camera.array[4]=i.camera.quaternion.y,i.camera.array[5]=i.camera.quaternion.z,i.camera.array[6]=i.camera.quaternion.w,i.camera.array[7]=i.camera.scale.x,i.camera.array[8]=i.camera.scale.y,i.camera.array[9]=i.camera.scale.z,this.state$.next(i)}}}class Io extends class{constructor(){this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}}{constructor(t){super(),this.gamepad=t,this.buttons={},this.axes={}}update(){this.updateButtons(),this.updateAxes()}updateButtons(){this.gamepad.buttons.forEach(((t,e)=>{const i=t.pressed,n=this.buttons[e]||(this.buttons[e]=new Ao(e,this));n.pressed!==i&&(n.pressed=i,i?this.emit("press",n):void 0!==status&&this.emit("release",n))}))}updateAxes(){const t=this.gamepad.axes;for(let e=0;e<t.length;e+=2){const i=Math.floor(e/2),n=this.axes[i]||(this.axes[i]=new Oo(i,this)),s=t[e],o=t[e+1];if(n.x!==s||n.y!==o){if(n.x=s,n.y=o,Math.abs(s)>Math.abs(o)){const t=s<-.85,e=s>.85;n.left!==t&&(n.left=t,this.emit(t?"left":"none",n)),n.right!==e&&(n.right=e,this.emit(e?"right":"none",n))}else{const t=o<-.85,e=o>.85;n.up!==t&&(n.up=t,this.emit(t?"up":"none",n)),n.down!==e&&(n.down=e,this.emit(e?"down":"none",n))}this.emit("axis",n)}}}feedback(t,e){void 0===t&&(t=.1),void 0===e&&(e=50);const i=this.gamepad.hapticActuators;return i&&i.length?i[0].pulse(t,e):Promise.reject()}}class Ao{constructor(t,e){this.index=t,this.gamepad=e,this.pressed=!1}}class Oo extends THREE.Vector2{constructor(t,e){super(),this.index=t,this.gamepad=e,this.left=this.right=this.up=this.down=!1}}class No extends s.Loader{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new Mo(t)})),this.register((function(t){return new Fo(t)})),this.register((function(t){return new Ho(t)})),this.register((function(t){return new xo(t)})),this.register((function(t){return new Uo(t)})),this.register((function(t){return new Vo(t)})),this.register((function(t){return new Bo(t)})),this.register((function(t){return new jo(t)})),this.register((function(t){return new Po(t)})),this.register((function(t){return new Go(t)}))}load(t,e,i,n){const o=this;let r;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:s.LoaderUtils.extractUrlBase(t),this.manager.itemStart(t);const a=function(e){n?n(e):console.error(e),o.manager.itemError(t),o.manager.itemEnd(t)},c=new s.FileLoader(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(t,(function(i){try{o.parse(i,r,(function(i){e(i),o.manager.itemEnd(t)}),a)}catch(t){a(t)}}),i,a)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this}unregister(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,i,n){let o;const r={},a={};if("string"==typeof t)o=t;else{if(s.LoaderUtils.decodeText(new Uint8Array(t,0,4))===$o){try{r[Lo.KHR_BINARY_GLTF]=new Ko(t)}catch(t){return void(n&&n(t))}o=r[Lo.KHR_BINARY_GLTF].content}else o=s.LoaderUtils.decodeText(new Uint8Array(t))}const c=JSON.parse(o);if(void 0===c.asset||c.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Cr(c,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let t=0;t<this.pluginCallbacks.length;t++){const e=this.pluginCallbacks[t](l);a[e.name]=e,r[e.name]=!0}if(c.extensionsUsed)for(let t=0;t<c.extensionsUsed.length;++t){const e=c.extensionsUsed[t],i=c.extensionsRequired||[];switch(e){case Lo.KHR_MATERIALS_UNLIT:r[e]=new Do;break;case Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:r[e]=new Xo;break;case Lo.KHR_DRACO_MESH_COMPRESSION:r[e]=new qo(c,this.dracoLoader);break;case Lo.KHR_TEXTURE_TRANSFORM:r[e]=new Yo;break;case Lo.KHR_MESH_QUANTIZATION:r[e]=new Qo;break;default:i.indexOf(e)>=0&&void 0===a[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}l.setExtensions(r),l.setPlugins(a),l.parse(i,n)}parseAsync(t,e){const i=this;return new Promise((function(n,s){i.parse(t,e,n,s)}))}}function ko(){let t={};return{get:function(e){return t[e]},add:function(e,i){t[e]=i},remove:function(e){delete t[e]},removeAll:function(){t={}}}}const Lo={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class Po{constructor(t){this.parser=t,this.name=Lo.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&t._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(t){const e=this.parser,i="light:"+t;let n=e.cache.get(i);if(n)return n;const o=e.json,r=((o.extensions&&o.extensions[this.name]||{}).lights||[])[t];let a;const c=new s.Color(16777215);void 0!==r.color&&c.fromArray(r.color);const l=void 0!==r.range?r.range:0;switch(r.type){case"directional":a=new s.DirectionalLight(c),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new s.PointLight(c),a.distance=l;break;case"spot":a=new s.SpotLight(c),a.distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,a.angle=r.spot.outerConeAngle,a.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return a.position.set(0,0,0),a.decay=2,void 0!==r.intensity&&(a.intensity=r.intensity),a.name=e.createUniqueName(r.name||"light_"+t),n=Promise.resolve(a),e.cache.add(i,n),n}createNodeAttachment(t){const e=this,i=this.parser,n=i.json.nodes[t],s=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then((function(t){return i._getNodeRef(e.cache,s,t)}))}}class Do{constructor(){this.name=Lo.KHR_MATERIALS_UNLIT}getMaterialType(){return s.MeshBasicMaterial}extendParams(t,e,i){const n=[];t.color=new s.Color(1,1,1),t.opacity=1;const o=e.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const e=o.baseColorFactor;t.color.fromArray(e),t.opacity=e[3]}void 0!==o.baseColorTexture&&n.push(i.assignTexture(t,"map",o.baseColorTexture))}return Promise.all(n)}}class Mo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(e.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&o.push(i.assignTexture(e,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(e.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&o.push(i.assignTexture(e,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(o.push(i.assignTexture(e,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const t=r.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new s.Vector2(t,t)}return Promise.all(o)}}class xo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_SHEEN}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[];e.sheenColor=new s.Color(0,0,0),e.sheenRoughness=0,e.sheen=1;const r=n.extensions[this.name];return void 0!==r.sheenColorFactor&&e.sheenColor.fromArray(r.sheenColorFactor),void 0!==r.sheenRoughnessFactor&&(e.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&o.push(i.assignTexture(e,"sheenColorMap",r.sheenColorTexture)),void 0!==r.sheenRoughnessTexture&&o.push(i.assignTexture(e,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(o)}}class Uo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(e.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&s.push(i.assignTexture(e,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class Vo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_VOLUME}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];e.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&o.push(i.assignTexture(e,"thicknessMap",r.thicknessTexture)),e.attenuationDistance=r.attenuationDistance||0;const a=r.attenuationColor||[1,1,1];return e.attenuationColor=new s.Color(a[0],a[1],a[2]),Promise.all(o)}}class Bo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_IOR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return e.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class jo{constructor(t){this.parser=t,this.name=Lo.KHR_MATERIALS_SPECULAR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?s.MeshPhysicalMaterial:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const o=[],r=n.extensions[this.name];e.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&o.push(i.assignTexture(e,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return e.specularColor=new s.Color(a[0],a[1],a[2]),void 0!==r.specularColorTexture&&o.push(i.assignTexture(e,"specularColorMap",r.specularColorTexture).then((function(t){t.encoding=s.sRGBEncoding}))),Promise.all(o)}}class Fo{constructor(t){this.parser=t,this.name=Lo.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,i=e.json,n=i.textures[t];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=e.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,s.source,o)}}class Ho{constructor(t){this.parser=t,this.name=Lo.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,i=this.parser,n=i.json,s=n.textures[t];if(!s.extensions||!s.extensions[e])return null;const o=s.extensions[e],r=n.images[o.source];let a=i.textureLoader;if(r.uri){const t=i.options.manager.getHandler(r.uri);null!==t&&(a=t)}return this.detectSupport().then((function(s){if(s)return i.loadTextureImage(t,r,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class Go{constructor(t){this.name=Lo.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,i=e.bufferViews[t];if(i.extensions&&i.extensions[this.name]){const t=i.extensions[this.name],n=this.parser.getDependency("buffer",t.buffer),s=this.parser.options.meshoptDecoder;if(!s||!s.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([n,s.ready]).then((function(e){const i=t.byteOffset||0,n=t.byteLength||0,o=t.count,r=t.byteStride,a=new ArrayBuffer(o*r),c=new Uint8Array(e[0],i,n);return s.decodeGltfBuffer(new Uint8Array(a),o,r,c,t.mode,t.filter),a}))}return null}}const $o="glTF",Wo=1313821514,zo=5130562;class Ko{constructor(t){this.name=Lo.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,12);if(this.header={magic:s.LoaderUtils.decodeText(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==$o)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,n=new DataView(t,12);let o=0;for(;o<i;){const e=n.getUint32(o,!0);o+=4;const i=n.getUint32(o,!0);if(o+=4,i===Wo){const i=new Uint8Array(t,12+o,e);this.content=s.LoaderUtils.decodeText(i)}else if(i===zo){const i=12+o;this.body=t.slice(i,i+e)}o+=e}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class qo{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Lo.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const i=this.json,n=this.dracoLoader,s=t.extensions[this.name].bufferView,o=t.extensions[this.name].attributes,r={},a={},c={};for(const t in o){const e=pr[t]||t.toLowerCase();r[e]=o[t]}for(const e in t.attributes){const n=pr[e]||e.toLowerCase();if(void 0!==o[e]){const s=i.accessors[t.attributes[e]],o=lr[s.componentType];c[n]=o,a[n]=!0===s.normalized}}return e.getDependency("bufferView",s).then((function(t){return new Promise((function(e){n.decodeDracoFile(t,(function(t){for(const e in t.attributes){const i=t.attributes[e],n=a[e];void 0!==n&&(i.normalized=n)}e(t)}),r,c)}))}))}}class Yo{constructor(){this.name=Lo.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return void 0!==e.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===e.offset&&void 0===e.rotation&&void 0===e.scale||(t=t.clone(),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),t.needsUpdate=!0),t}}class Jo extends s.MeshStandardMaterial{constructor(t){super(),this.isGLTFSpecularGlossinessMaterial=!0;const e=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new s.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(t){for(const e in a)t.uniforms[e]=a[e];t.fragmentShader=t.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",e).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",o).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(t){a.specular.value=t}},specularMap:{get:function(){return a.specularMap.value},set:function(t){a.specularMap.value=t,t?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(t){a.glossiness.value=t}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(t){a.glossinessMap.value=t,t?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(t)}copy(t){return super.copy(t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class Xo{constructor(){this.name=Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Jo}extendParams(t,e,i){const n=e.extensions[this.name];t.color=new s.Color(1,1,1),t.opacity=1;const o=[];if(Array.isArray(n.diffuseFactor)){const e=n.diffuseFactor;t.color.fromArray(e),t.opacity=e[3]}if(void 0!==n.diffuseTexture&&o.push(i.assignTexture(t,"map",n.diffuseTexture)),t.emissive=new s.Color(0,0,0),t.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,t.specular=new s.Color(1,1,1),Array.isArray(n.specularFactor)&&t.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){const e=n.specularGlossinessTexture;o.push(i.assignTexture(t,"glossinessMap",e)),o.push(i.assignTexture(t,"specularMap",e))}return Promise.all(o)}createMaterial(t){const e=new Jo(t);return e.fog=!0,e.color=t.color,e.map=void 0===t.map?null:t.map,e.lightMap=null,e.lightMapIntensity=1,e.aoMap=void 0===t.aoMap?null:t.aoMap,e.aoMapIntensity=1,e.emissive=t.emissive,e.emissiveIntensity=1,e.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,e.bumpMap=void 0===t.bumpMap?null:t.bumpMap,e.bumpScale=1,e.normalMap=void 0===t.normalMap?null:t.normalMap,e.normalMapType=s.TangentSpaceNormalMap,t.normalScale&&(e.normalScale=t.normalScale),e.displacementMap=null,e.displacementScale=1,e.displacementBias=0,e.specularMap=void 0===t.specularMap?null:t.specularMap,e.specular=t.specular,e.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,e.glossiness=t.glossiness,e.alphaMap=null,e.envMap=void 0===t.envMap?null:t.envMap,e.envMapIntensity=1,e.refractionRatio=.98,e}}class Qo{constructor(){this.name=Lo.KHR_MESH_QUANTIZATION}}class Zo extends s.Interpolant{constructor(t,e,i,n){super(t,e,i,n)}copySampleValue_(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=t*n*3+n;for(let t=0;t!==n;t++)e[t]=i[s+t];return e}}Zo.prototype.beforeStart_=Zo.prototype.copySampleValue_,Zo.prototype.afterEnd_=Zo.prototype.copySampleValue_,Zo.prototype.interpolate_=function(t,e,i,n){const s=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=2*r,c=3*r,l=n-e,d=(i-e)/l,h=d*d,u=h*d,p=t*c,m=p-c,v=-2*u+3*h,g=u-h,f=1-v,E=g-h+d;for(let t=0;t!==r;t++){const e=o[m+t+r],i=o[m+t+a]*l,n=o[p+t+r],c=o[p+t]*l;s[t]=f*e+E*i+v*n+g*c}return s};const tr=new s.Quaternion;class er extends Zo{interpolate_(t,e,i,n){const s=super.interpolate_(t,e,i,n);return tr.fromArray(s).normalize().toArray(s),s}}const ir=0,nr=1,sr=2,or=3,rr=4,ar=5,cr=6,lr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},dr={9728:s.NearestFilter,9729:s.LinearFilter,9984:s.NearestMipmapNearestFilter,9985:s.LinearMipmapNearestFilter,9986:s.NearestMipmapLinearFilter,9987:s.LinearMipmapLinearFilter},hr={33071:s.ClampToEdgeWrapping,33648:s.MirroredRepeatWrapping,10497:s.RepeatWrapping},ur={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},pr={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},mr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},vr={CUBICSPLINE:void 0,LINEAR:s.InterpolateLinear,STEP:s.InterpolateDiscrete},gr="OPAQUE",fr="MASK",Er="BLEND";function _r(t,e,i){for(const n in i.extensions)void 0===t[n]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=i.extensions[n])}function Sr(t,e){void 0!==e.extras&&("object"==typeof e.extras?Object.assign(t.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function br(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(let i=0,n=e.weights.length;i<n;i++)t.morphTargetInfluences[i]=e.weights[i];if(e.extras&&Array.isArray(e.extras.targetNames)){const i=e.extras.targetNames;if(t.morphTargetInfluences.length===i.length){t.morphTargetDictionary={};for(let e=0,n=i.length;e<n;e++)t.morphTargetDictionary[i[e]]=e}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Tr(t){const e=t.extensions&&t.extensions[Lo.KHR_DRACO_MESH_COMPRESSION];let i;return i=e?"draco:"+e.bufferView+":"+e.indices+":"+yr(e.attributes):t.indices+":"+yr(t.attributes)+":"+t.mode,i}function yr(t){let e="";const i=Object.keys(t).sort();for(let n=0,s=i.length;n<s;n++)e+=i[n]+":"+t[i[n]]+";";return e}function wr(t){switch(t){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Cr{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new ko,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox|^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.textureLoader=new s.ImageBitmapLoader(this.options.manager):this.textureLoader=new s.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new s.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all(this._invokeAll((function(t){return t.beforeRoot&&t.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(e){const o={scene:e[0][n.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:n.asset,parser:i,userData:{}};_r(s,o,n),Sr(o,n),Promise.all(i._invokeAll((function(t){return t.afterRoot&&t.afterRoot(o)}))).then((function(){t(o)}))})).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i].joints;for(let e=0,i=n.length;e<i;e++)t[n[e]].isBone=!0}for(let e=0,n=t.length;e<n;e++){const n=t[e];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(i[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,i){if(t.refs[e]<=1)return i;const n=i.clone(),s=(t,e)=>{const i=this.associations.get(t);null!=i&&this.associations.set(e,i);for(const[i,n]of t.children.entries())s(n,e.children[i])};return s(i,n),n.name+="_instance_"+t.uses[e]++,n}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let i=0;i<e.length;i++){const n=t(e[i]);if(n)return n}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const i=[];for(let n=0;n<e.length;n++){const s=t(e[n]);s&&i.push(s)}return i}getDependency(t,e){const i=t+":"+e;let n=this.cache.get(i);if(!n){switch(t){case"scene":n=this.loadScene(e);break;case"node":n=this.loadNode(e);break;case"mesh":n=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":n=this.loadAccessor(e);break;case"bufferView":n=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":n=this.loadBuffer(e);break;case"material":n=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":n=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":n=this.loadSkin(e);break;case"animation":n=this.loadAnimation(e);break;case"camera":n=this.loadCamera(e);break;default:throw new Error("Unknown type: "+t)}this.cache.add(i,n)}return n}getDependencies(t){let e=this.cache.get(t);if(!e){const i=this,n=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(n.map((function(e,n){return i.getDependency(t,n)}))),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],i=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[Lo.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(t,o){i.load(s.LoaderUtils.resolveURL(e.uri,n.path),t,void 0,(function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){const i=e.byteLength||0,n=e.byteOffset||0;return t.slice(n,n+i)}))}loadAccessor(t){const e=this,i=this.json,n=this.json.accessors[t];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);const o=[];return void 0!==n.bufferView?o.push(this.getDependency("bufferView",n.bufferView)):o.push(null),void 0!==n.sparse&&(o.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(o).then((function(t){const o=t[0],r=ur[n.type],a=lr[n.componentType],c=a.BYTES_PER_ELEMENT,l=c*r,d=n.byteOffset||0,h=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,u=!0===n.normalized;let p,m;if(h&&h!==l){const t=Math.floor(d/h),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+t+":"+n.count;let l=e.cache.get(i);l||(p=new a(o,t*h,n.count*h/c),l=new s.InterleavedBuffer(p,h/c),e.cache.add(i,l)),m=new s.InterleavedBufferAttribute(l,r,d%h/c,u)}else p=null===o?new a(n.count*r):new a(o,d,n.count*r),m=new s.BufferAttribute(p,r,u);if(void 0!==n.sparse){const e=ur.SCALAR,i=lr[n.sparse.indices.componentType],c=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,d=new i(t[1],c,n.sparse.count*e),h=new a(t[2],l,n.sparse.count*r);null!==o&&(m=new s.BufferAttribute(m.array.slice(),m.itemSize,m.normalized));for(let t=0,e=d.length;t<e;t++){const e=d[t];if(m.setX(e,h[t*r]),r>=2&&m.setY(e,h[t*r+1]),r>=3&&m.setZ(e,h[t*r+2]),r>=4&&m.setW(e,h[t*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(t){const e=this.json,i=this.options,n=e.textures[t].source,s=e.images[n];let o=this.textureLoader;if(s.uri){const t=i.manager.getHandler(s.uri);null!==t&&(o=t)}return this.loadTextureImage(t,n,o)}loadTextureImage(t,e,i){const n=this,o=this.json,r=o.textures[t],a=o.images[e],c=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[c])return this.textureCache[c];const l=this.loadImageSource(e,i).then((function(e){e.flipY=!1,r.name&&(e.name=r.name);const i=(o.samplers||{})[r.sampler]||{};return e.magFilter=dr[i.magFilter]||s.LinearFilter,e.minFilter=dr[i.minFilter]||s.LinearMipmapLinearFilter,e.wrapS=hr[i.wrapS]||s.RepeatWrapping,e.wrapT=hr[i.wrapT]||s.RepeatWrapping,n.associations.set(e,{textures:t}),e})).catch((function(){return null}));return this.textureCache[c]=l,l}loadImageSource(t,e){const i=this,n=this.json,o=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then((function(t){return t.clone()})).catch((function(t){throw t}));const r=n.images[t],a=self.URL||self.webkitURL;let c=r.uri||"",l=!1;if(void 0!==r.bufferView)c=i.getDependency("bufferView",r.bufferView).then((function(t){l=!0;const e=new Blob([t],{type:r.mimeType});return c=a.createObjectURL(e),c}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const d=Promise.resolve(c).then((function(t){return new Promise((function(i,n){let r=i;!0===e.isImageBitmapLoader&&(r=function(t){const e=new s.Texture(t);e.needsUpdate=!0,i(e)}),e.load(s.LoaderUtils.resolveURL(t,o.path),r,void 0,n)}))})).then((function(t){var e;return!0===l&&a.revokeObjectURL(c),t.userData.mimeType=r.mimeType||((e=r.uri).search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"),t})).catch((function(t){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),t}));return this.sourceCache[t]=d,d}assignTexture(t,e,i){const n=this;return this.getDependency("texture",i.index).then((function(s){if(void 0===i.texCoord||0==i.texCoord||"aoMap"===e&&1==i.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+i.texCoord+" for texture "+e+" not yet supported."),n.extensions[Lo.KHR_TEXTURE_TRANSFORM]){const t=void 0!==i.extensions?i.extensions[Lo.KHR_TEXTURE_TRANSFORM]:void 0;if(t){const e=n.associations.get(s);s=n.extensions[Lo.KHR_TEXTURE_TRANSFORM].extendTexture(s,t),n.associations.set(s,e)}}return t[e]=s,s}))}assignFinalMaterial(t){const e=t.geometry;let i=t.material;const n=void 0===e.attributes.tangent,o=void 0!==e.attributes.color,r=void 0===e.attributes.normal;if(t.isPoints){const t="PointsMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new s.PointsMaterial,s.Material.prototype.copy.call(e,i),e.color.copy(i.color),e.map=i.map,e.sizeAttenuation=!1,this.cache.add(t,e)),i=e}else if(t.isLine){const t="LineBasicMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new s.LineBasicMaterial,s.Material.prototype.copy.call(e,i),e.color.copy(i.color),this.cache.add(t,e)),i=e}if(n||o||r){let t="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(t+="specular-glossiness:"),n&&(t+="derivative-tangents:"),o&&(t+="vertex-colors:"),r&&(t+="flat-shading:");let e=this.cache.get(t);e||(e=i.clone(),o&&(e.vertexColors=!0),r&&(e.flatShading=!0),n&&(e.normalScale&&(e.normalScale.y*=-1),e.clearcoatNormalScale&&(e.clearcoatNormalScale.y*=-1)),this.cache.add(t,e),this.associations.set(e,this.associations.get(i))),i=e}i.aoMap&&void 0===e.attributes.uv2&&void 0!==e.attributes.uv&&e.setAttribute("uv2",e.attributes.uv),t.material=i}getMaterialType(){return s.MeshStandardMaterial}loadMaterial(t){const e=this,i=this.json,n=this.extensions,o=i.materials[t];let r;const a={},c=o.extensions||{},l=[];if(c[Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const t=n[Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];r=t.getMaterialType(),l.push(t.extendParams(a,o,e))}else if(c[Lo.KHR_MATERIALS_UNLIT]){const t=n[Lo.KHR_MATERIALS_UNLIT];r=t.getMaterialType(),l.push(t.extendParams(a,o,e))}else{const i=o.pbrMetallicRoughness||{};if(a.color=new s.Color(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;a.color.fromArray(t),a.opacity=t[3]}void 0!==i.baseColorTexture&&l.push(e.assignTexture(a,"map",i.baseColorTexture)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(l.push(e.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),l.push(e.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),r=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),l.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,a)}))))}!0===o.doubleSided&&(a.side=s.DoubleSide);const d=o.alphaMode||gr;if(d===Er?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,d===fr&&(a.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&r!==s.MeshBasicMaterial&&(l.push(e.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new s.Vector2(1,1),void 0!==o.normalTexture.scale)){const t=o.normalTexture.scale;a.normalScale.set(t,t)}return void 0!==o.occlusionTexture&&r!==s.MeshBasicMaterial&&(l.push(e.assignTexture(a,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(a.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&r!==s.MeshBasicMaterial&&(a.emissive=(new s.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&r!==s.MeshBasicMaterial&&l.push(e.assignTexture(a,"emissiveMap",o.emissiveTexture)),Promise.all(l).then((function(){let i;return i=r===Jo?n[Lo.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new r(a),o.name&&(i.name=o.name),i.map&&(i.map.encoding=s.sRGBEncoding),i.emissiveMap&&(i.emissiveMap.encoding=s.sRGBEncoding),i.sheenColorMap&&(i.sheenColorMap.encoding=s.sRGBEncoding),i.specularColorMap&&(i.specularColorMap.encoding=s.sRGBEncoding),i.specularMap&&(i.specularMap.encoding=s.sRGBEncoding),Sr(i,o),e.associations.set(i,{materials:t}),o.extensions&&_r(n,i,o),i}))}createUniqueName(t){const e=s.PropertyBinding.sanitizeNodeName(t||"");let i=e;for(let t=1;this.nodeNamesUsed[i];++t)i=e+"_"+t;return this.nodeNamesUsed[i]=!0,i}loadGeometries(t){const e=this,i=this.extensions,n=this.primitiveCache;function o(t){return i[Lo.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then((function(i){return Ir(i,t,e)}))}const r=[];for(let i=0,a=t.length;i<a;i++){const a=t[i],c=Tr(a),l=n[c];if(l)r.push(l.promise);else{let t;t=a.extensions&&a.extensions[Lo.KHR_DRACO_MESH_COMPRESSION]?o(a):Ir(new s.BufferGeometry,a,e),n[c]={primitive:a,promise:t},r.push(t)}}return Promise.all(r)}loadMesh(t){const e=this,i=this.json,n=this.extensions,o=i.meshes[t],r=o.primitives,a=[];for(let t=0,e=r.length;t<e;t++){const e=void 0===r[t].material?(void 0===(c=this.cache).DefaultMaterial&&(c.DefaultMaterial=new s.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:s.FrontSide})),c.DefaultMaterial):this.getDependency("material",r[t].material);a.push(e)}var c;return a.push(e.loadGeometries(r)),Promise.all(a).then((function(i){const a=i.slice(0,i.length-1),c=i[i.length-1],l=[];for(let i=0,d=c.length;i<d;i++){const d=c[i],h=r[i];let u;const p=a[i];if(h.mode===rr||h.mode===ar||h.mode===cr||void 0===h.mode)u=!0===o.isSkinnedMesh?new s.SkinnedMesh(d,p):new s.Mesh(d,p),!0!==u.isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),h.mode===ar?u.geometry=Ar(u.geometry,s.TriangleStripDrawMode):h.mode===cr&&(u.geometry=Ar(u.geometry,s.TriangleFanDrawMode));else if(h.mode===nr)u=new s.LineSegments(d,p);else if(h.mode===or)u=new s.Line(d,p);else if(h.mode===sr)u=new s.LineLoop(d,p);else{if(h.mode!==ir)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new s.Points(d,p)}Object.keys(u.geometry.morphAttributes).length>0&&br(u,o),u.name=e.createUniqueName(o.name||"mesh_"+t),Sr(u,o),h.extensions&&_r(n,u,h),e.assignFinalMaterial(u),l.push(u)}for(let i=0,n=l.length;i<n;i++)e.associations.set(l[i],{meshes:t,primitives:i});if(1===l.length)return l[0];const d=new s.Group;e.associations.set(d,{meshes:t});for(let t=0,e=l.length;t<e;t++)d.add(l[t]);return d}))}loadCamera(t){let e;const i=this.json.cameras[t],n=i[i.type];if(n)return"perspective"===i.type?e=new s.PerspectiveCamera(s.MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(e=new s.OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(e.name=this.createUniqueName(i.name)),Sr(e,i),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(t){const e=this.json.skins[t],i={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",e.inverseBindMatrices).then((function(t){return i.inverseBindMatrices=t,i}))}loadAnimation(t){const e=this.json.animations[t],i=[],n=[],o=[],r=[],a=[];for(let t=0,s=e.channels.length;t<s;t++){const s=e.channels[t],c=e.samplers[s.sampler],l=s.target,d=void 0!==l.node?l.node:l.id,h=void 0!==e.parameters?e.parameters[c.input]:c.input,u=void 0!==e.parameters?e.parameters[c.output]:c.output;i.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",h)),o.push(this.getDependency("accessor",u)),r.push(c),a.push(l)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(o),Promise.all(r),Promise.all(a)]).then((function(i){const n=i[0],o=i[1],r=i[2],a=i[3],c=i[4],l=[];for(let t=0,e=n.length;t<e;t++){const e=n[t],i=o[t],d=r[t],h=a[t],u=c[t];if(void 0===e)continue;let p;switch(e.updateMatrix(),e.matrixAutoUpdate=!0,mr[u.path]){case mr.weights:p=s.NumberKeyframeTrack;break;case mr.rotation:p=s.QuaternionKeyframeTrack;break;default:p=s.VectorKeyframeTrack}const m=e.name?e.name:e.uuid,v=void 0!==h.interpolation?vr[h.interpolation]:s.InterpolateLinear,g=[];mr[u.path]===mr.weights?e.traverse((function(t){t.morphTargetInfluences&&g.push(t.name?t.name:t.uuid)})):g.push(m);let f=d.array;if(d.normalized){const t=wr(f.constructor),e=new Float32Array(f.length);for(let i=0,n=f.length;i<n;i++)e[i]=f[i]*t;f=e}for(let t=0,e=g.length;t<e;t++){const e=new p(g[t]+"."+mr[u.path],i.array,f,v);"CUBICSPLINE"===h.interpolation&&(e.createInterpolant=function(t){return new(this instanceof s.QuaternionKeyframeTrack?er:Zo)(this.times,this.values,this.getValueSize()/3,t)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(e)}}const d=e.name?e.name:"animation_"+t;return new s.AnimationClip(d,void 0,l)}))}createNodeMesh(t){const e=this.json,i=this,n=e.nodes[t];return void 0===n.mesh?null:i.getDependency("mesh",n.mesh).then((function(t){const e=i._getNodeRef(i.meshCache,n.mesh,t);return void 0!==n.weights&&e.traverse((function(t){if(t.isMesh)for(let e=0,i=n.weights.length;e<i;e++)t.morphTargetInfluences[e]=n.weights[e]})),e}))}loadNode(t){const e=this.json,i=this.extensions,n=this,o=e.nodes[t],r=o.name?n.createUniqueName(o.name):"";return function(){const e=[],i=n._invokeOne((function(e){return e.createNodeMesh&&e.createNodeMesh(t)}));return i&&e.push(i),void 0!==o.camera&&e.push(n.getDependency("camera",o.camera).then((function(t){return n._getNodeRef(n.cameraCache,o.camera,t)}))),n._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){e.push(t)})),Promise.all(e)}().then((function(e){let a;if(a=!0===o.isBone?new s.Bone:e.length>1?new s.Group:1===e.length?e[0]:new s.Object3D,a!==e[0])for(let t=0,i=e.length;t<i;t++)a.add(e[t]);if(o.name&&(a.userData.name=o.name,a.name=r),Sr(a,o),o.extensions&&_r(i,a,o),void 0!==o.matrix){const t=new s.Matrix4;t.fromArray(o.matrix),a.applyMatrix4(t)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);return n.associations.has(a)||n.associations.set(a,{}),n.associations.get(a).nodes=t,a}))}loadScene(t){const e=this.json,i=this.extensions,n=this.json.scenes[t],o=this,r=new s.Group;n.name&&(r.name=o.createUniqueName(n.name)),Sr(r,n),n.extensions&&_r(i,r,n);const a=n.nodes||[],c=[];for(let t=0,i=a.length;t<i;t++)c.push(Rr(a[t],r,e,o));return Promise.all(c).then((function(){return o.associations=(t=>{const e=new Map;for(const[t,i]of o.associations)(t instanceof s.Material||t instanceof s.Texture)&&e.set(t,i);return t.traverse((t=>{const i=o.associations.get(t);null!=i&&e.set(t,i)})),e})(r),r}))}}function Rr(t,e,i,n){const o=i.nodes[t];return n.getDependency("node",t).then((function(t){if(void 0===o.skin)return t;let e;return n.getDependency("skin",o.skin).then((function(t){e=t;const i=[];for(let t=0,s=e.joints.length;t<s;t++)i.push(n.getDependency("node",e.joints[t]));return Promise.all(i)})).then((function(i){return t.traverse((function(t){if(!t.isMesh)return;const n=[],o=[];for(let t=0,r=i.length;t<r;t++){const r=i[t];if(r){n.push(r);const i=new s.Matrix4;void 0!==e.inverseBindMatrices&&i.fromArray(e.inverseBindMatrices.array,16*t),o.push(i)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[t])}t.bind(new s.Skeleton(n,o),t.matrixWorld)})),t}))})).then((function(t){e.add(t);const s=[];if(o.children){const e=o.children;for(let o=0,r=e.length;o<r;o++){const r=e[o];s.push(Rr(r,t,i,n))}}return Promise.all(s)}))}function Ir(t,e,i){const n=e.attributes,o=[];function r(e,n){return i.getDependency("accessor",e).then((function(e){t.setAttribute(n,e)}))}for(const e in n){const i=pr[e]||e.toLowerCase();i in t.attributes||o.push(r(n[e],i))}if(void 0!==e.indices&&!t.index){const n=i.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));o.push(n)}return Sr(t,e),function(t,e,i){const n=e.attributes,o=new s.Box3;if(void 0===n.POSITION)return;{const t=i.json.accessors[n.POSITION],e=t.min,r=t.max;if(void 0===e||void 0===r)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new s.Vector3(e[0],e[1],e[2]),new s.Vector3(r[0],r[1],r[2])),t.normalized){const e=wr(lr[t.componentType]);o.min.multiplyScalar(e),o.max.multiplyScalar(e)}}const r=e.targets;if(void 0!==r){const t=new s.Vector3,e=new s.Vector3;for(let n=0,s=r.length;n<s;n++){const s=r[n];if(void 0!==s.POSITION){const n=i.json.accessors[s.POSITION],o=n.min,r=n.max;if(void 0!==o&&void 0!==r){if(e.setX(Math.max(Math.abs(o[0]),Math.abs(r[0]))),e.setY(Math.max(Math.abs(o[1]),Math.abs(r[1]))),e.setZ(Math.max(Math.abs(o[2]),Math.abs(r[2]))),n.normalized){const t=wr(lr[n.componentType]);e.multiplyScalar(t)}t.max(e)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(t)}t.boundingBox=o;const a=new s.Sphere;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,t.boundingSphere=a}(t,e,i),Promise.all(o).then((function(){return void 0!==e.targets?function(t,e,i){let n=!1,s=!1,o=!1;for(let t=0,i=e.length;t<i;t++){const i=e[t];if(void 0!==i.POSITION&&(n=!0),void 0!==i.NORMAL&&(s=!0),void 0!==i.COLOR_0&&(o=!0),n&&s&&o)break}if(!n&&!s&&!o)return Promise.resolve(t);const r=[],a=[],c=[];for(let l=0,d=e.length;l<d;l++){const d=e[l];if(n){const e=void 0!==d.POSITION?i.getDependency("accessor",d.POSITION):t.attributes.position;r.push(e)}if(s){const e=void 0!==d.NORMAL?i.getDependency("accessor",d.NORMAL):t.attributes.normal;a.push(e)}if(o){const e=void 0!==d.COLOR_0?i.getDependency("accessor",d.COLOR_0):t.attributes.color;c.push(e)}}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(c)]).then((function(e){const i=e[0],r=e[1],a=e[2];return n&&(t.morphAttributes.position=i),s&&(t.morphAttributes.normal=r),o&&(t.morphAttributes.color=a),t.morphTargetsRelative=!0,t}))}(t,e.targets,i):t}))}function Ar(t,e){let i=t.getIndex();if(null===i){const e=[],n=t.getAttribute("position");if(void 0===n)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(let t=0;t<n.count;t++)e.push(t);t.setIndex(e),i=t.getIndex()}const n=i.count-2,o=[];if(e===s.TriangleFanDrawMode)for(let t=1;t<=n;t++)o.push(i.getX(0)),o.push(i.getX(t)),o.push(i.getX(t+1));else for(let t=0;t<n;t++)t%2==0?(o.push(i.getX(t)),o.push(i.getX(t+1)),o.push(i.getX(t+2))):(o.push(i.getX(t+2)),o.push(i.getX(t+1)),o.push(i.getX(t)));o.length/3!==n&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=t.clone();return r.setIndex(o),r}const Or={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})},Nr={xAxis:0,yAxis:0,button:0,state:Or.ComponentState.DEFAULT};async function kr(t){const e=await fetch(t);if(e.ok)return e.json();throw new Error(e.statusText)}async function Lr(t,e,i,n){if(void 0===i&&(i=null),void 0===n&&(n=!0),!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const s=await async function(t){if(!t)throw new Error("No basePath supplied");return await kr(`${t}/profilesList.json`)}(e);let o;if(t.profiles.some((t=>{const i=s[t];return i&&(o={profileId:t,profilePath:`${e}/${i.path}`,deprecated:!!i.deprecated}),!!o})),!o){if(!i)throw new Error("No matching profile name found");const t=s[i];if(!t)throw new Error(`No matching profile name found and default profile "${i}" missing.`);o={profileId:i,profilePath:`${e}/${t.path}`,deprecated:!!t.deprecated}}const r=await kr(o.profilePath);let a;if(n){let e;if(e="any"===t.handedness?r.layouts[Object.keys(r.layouts)[0]]:r.layouts[t.handedness],!e)throw new Error(`No matching handedness, ${t.handedness}, in profile ${o.profileId}`);e.assetPath&&(a=o.profilePath.replace("profile.json",e.assetPath))}return{profile:r,assetPath:a}}class Pr{constructor(t){this.componentProperty=t.componentProperty,this.states=t.states,this.valueNodeName=t.valueNodeName,this.valueNodeProperty=t.valueNodeProperty,this.valueNodeProperty===Or.VisualResponseProperty.TRANSFORM&&(this.minNodeName=t.minNodeName,this.maxNodeName=t.maxNodeName),this.value=0,this.updateFromComponent(Nr)}updateFromComponent(t){let{xAxis:e,yAxis:i,button:n,state:s}=t;const{normalizedXAxis:o,normalizedYAxis:r}=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);let i=t,n=e;if(Math.sqrt(t*t+e*e)>1){const s=Math.atan2(e,t);i=Math.cos(s),n=Math.sin(s)}return{normalizedXAxis:.5*i+.5,normalizedYAxis:.5*n+.5}}(e,i);switch(this.componentProperty){case Or.ComponentProperty.X_AXIS:this.value=this.states.includes(s)?o:.5;break;case Or.ComponentProperty.Y_AXIS:this.value=this.states.includes(s)?r:.5;break;case Or.ComponentProperty.BUTTON:this.value=this.states.includes(s)?n:0;break;case Or.ComponentProperty.STATE:this.valueNodeProperty===Or.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(s):this.value=this.states.includes(s)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class Dr{constructor(t,e){if(!(t&&e&&e.visualResponses&&e.gamepadIndices&&0!==Object.keys(e.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=t,this.type=e.type,this.rootNodeName=e.rootNodeName,this.touchPointNodeName=e.touchPointNodeName,this.visualResponses={},Object.keys(e.visualResponses).forEach((t=>{const i=new Pr(e.visualResponses[t]);this.visualResponses[t]=i})),this.gamepadIndices=Object.assign({},e.gamepadIndices),this.values={state:Or.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return de({id:this.id},this.values)}updateFromGamepad(t){if(this.values.state=Or.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&t.buttons.length>this.gamepadIndices.button){const e=t.buttons[this.gamepadIndices.button];this.values.button=e.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,e.pressed||1===this.values.button?this.values.state=Or.ComponentState.PRESSED:(e.touched||this.values.button>Or.ButtonTouchThreshold)&&(this.values.state=Or.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&t.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=t.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===Or.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>Or.AxisTouchThreshold&&(this.values.state=Or.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&t.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=t.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===Or.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>Or.AxisTouchThreshold&&(this.values.state=Or.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((t=>{t.updateFromComponent(this.values)}))}}class Mr{constructor(t,e,i){if(!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No profile supplied");this.xrInputSource=t,this.assetUrl=i,this.id=e.profileId,this.layoutDescription=e.layouts[t.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((t=>{const e=this.layoutDescription.components[t];this.components[t]=new Dr(t,e)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const t=[];return Object.values(this.components).forEach((e=>{t.push(e.data)})),t}updateFromGamepad(){Object.values(this.components).forEach((t=>{t.updateFromGamepad(this.xrInputSource.gamepad)}))}}class xr extends THREE.Object3D{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(t){return this.envMap==t||(this.envMap=t,this.traverse((t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}))),this}updateMatrixWorld(t){super.updateMatrixWorld(t),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((t=>{Object.values(t.visualResponses).forEach((t=>{const{valueNode:e,minNode:i,maxNode:n,value:s,valueNodeProperty:o}=t;e&&(o===Or.VisualResponseProperty.VISIBILITY?e.visible=s:o===Or.VisualResponseProperty.TRANSFORM&&(e.quaternion.slerpQuaternions(i.quaternion,n.quaternion,s),e.position.lerpVectors(i.position,n.position,s)))}))})))}}function Ur(t,e){!function(t,e){Object.values(t.components).forEach((t=>{const{type:i,touchPointNodeName:n,visualResponses:s}=t;if(i===Or.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(n),t.touchPointNode){const e=new THREE.SphereGeometry(.001),i=new THREE.MeshBasicMaterial({color:255}),n=new THREE.Mesh(e,i);t.touchPointNode.add(n)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(s).forEach((t=>{const{valueNodeName:i,minNodeName:n,maxNodeName:s,valueNodeProperty:o}=t;if(o===Or.VisualResponseProperty.TRANSFORM){if(t.minNode=e.getObjectByName(n),t.maxNode=e.getObjectByName(s),!t.minNode)return void console.warn(`Could not find ${n} in the model`);if(!t.maxNode)return void console.warn(`Could not find ${s} in the model`)}t.valueNode=e.getObjectByName(i),t.valueNode||console.warn(`Could not find ${i} in the model`)}))}))}(t.motionController,e),t.envMap&&e.traverse((e=>{e.isMesh&&(e.material.envMap=t.envMap,e.material.needsUpdate=!0)})),t.add(e)}class Vr{constructor(t){void 0===t&&(t=null),this.gltfLoader=t,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new No)}createControllerModel(t){const e=new xr;let i=null;return t.addEventListener("connected",(t=>{const n=t.data;"tracked-pointer"===n.targetRayMode&&n.gamepad&&Lr(n,this.path,"generic-trigger").then((t=>{let{profile:s,assetPath:o}=t;e.motionController=new Mr(n,s,o);const r=this._assetCache[e.motionController.assetUrl];if(r)i=r.scene.clone(),Ur(e,i);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(e.motionController.assetUrl,(t=>{this._assetCache[e.motionController.assetUrl]=t,i=t.scene.clone(),Ur(e,i)}),null,(()=>{throw new Error(`Asset ${e.motionController.assetUrl} missing or malformed.`)}))}})).catch((t=>{console.warn(t)}))})),t.addEventListener("disconnected",(()=>{e.motionController=null,e.remove(i),i=null})),e}}const Br=new THREE.Vector3,jr=new THREE.Vector3(0,-1,0),Fr={type:xe,orientation:{latitude:0,longitude:0},zoom:1,cameraGroup:{position:[0,0,0],rotation:[0,0,0]},pointer:[0,0,0]};class Hr extends t.Component{get error(){return this.error_}set error(t){this.error_!==t&&(this.error_=t,this.pushChanges())}get view(){return this.view_}set view(t){this.view_!==t&&(this.view_=t,this.setView())}get debugging(){return R}get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get locked(){return this.controlled||this.spying}get lockedOrXR(){return this.locked||this.renderer.xr.isPresenting}get showMenu(){return ee.state.hosted&&ee.state.navigable&&("embed"!==ee.state.mode||x.flags.menuEmbed)}get showPointer(){return null!=this.pointer.mesh.parent}set showPointer(t){this.showPointer!==t&&(t?this.scene.add(this.pointer.mesh):this.scene.remove(this.pointer.mesh))}set menu(t){this.menu_!==t&&(this.menu_=t,this.scene.traverse((e=>{(e instanceof $s||e instanceof js)&&(e.freezed=null!=t)})))}get menu(){return this.menu_}onInit(){ws.host=this,this.defaultTexture=Bs.gridTexture,this.index=0,this.error_=null,this.loading=null,this.waiting=null,this.avatars={},this.createScene(),this.addListeners(),this.animate(),Ns.keys$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.keys=t})),fe.lang$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.setView()}))}onDestroy(){this.removeListeners();this.renderer.setAnimationLoop((()=>{}))}createScene(){const{node:e}=t.getContext(this);this.size={left:0,top:0,width:0,height:0,aspect:0},this.mouse=new THREE.Vector2,this.controllerMatrix_=new THREE.Matrix4,this.controllerWorldPosition_=new THREE.Vector3,this.controllerWorldDirection_=new THREE.Vector3;const i=this.container=e;this.info=e.querySelector(".world__info"),this.worldRect=xs.fromNode(i),this.cameraRect=new xs;const s=this.cameraGroup=new THREE.Group,o=this.camera=new THREE.PerspectiveCamera(70,i.offsetWidth/i.offsetHeight,.01,1e3);o.target=new THREE.Vector3,s.add(o),this.orbitService=new oo(o);const r=this.renderer=new THREE.WebGLRenderer({antialias:x.flags.antialias||!1,alpha:x.flags.alpha||!1,premultipliedAlpha:x.flags.premultipliedAlpha||!1,logarithmicDepthBuffer:!0,powerPreference:"high-performance"});r.setClearColor(0,1),r.setPixelRatio(window.devicePixelRatio),r.setSize(i.offsetWidth,i.offsetHeight),r.xr.enabled=!0,r.outputEncoding=THREE.LinearEncoding,r.toneMapping=THREE.ACESFilmicToneMapping,r.toneMappingExposure=x.toneMappingExposure||1,i.childElementCount>0?i.insertBefore(r.domElement,i.children[0]):i.appendChild(r.domElement);(this.raycaster=new THREE.Raycaster).setFromCamera(this.mouse,o);const a=this.scene=new THREE.Scene;a.add(s),x.flags.useTextureEnvironment&&this.addEnvironment();const c=this.objects=new THREE.Group;c.name="[objects]",a.add(c);const l=this.panorama=new uo(r);this.panoramaIntersectObjects=[l.mesh],this.intersectObjects=this.panoramaIntersectObjects,c.add(l.mesh),this.indicator=new fo,this.pointer=new fo("#ff4332");const d=new THREE.PointLight(16777215,.8);d.position.set(-50,0,0),c.add(d);const h=new THREE.PointLight(16777215,.3);h.position.set(50,0,0),c.add(h);const u=new THREE.PointLight(16777215,.5);u.position.set(0,50,0),c.add(u);const p=new THREE.PointLight(16777215,.1);p.position.set(0,-50,0),c.add(p);const m=this.ambient=new THREE.AmbientLight(16777215,.25);c.add(m),this.addControllers(),this.resize(),Ls.progress$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{const e=0===t.count,i=this.view_;i.items&&i.items.forEach((t=>{t.visible=e}))}))}toggleLights(t){this.ambient&&(this.ambient.visible=t),this.direct&&(this.direct.visible=t)}addEnvironment(){const t=x.textures.envMap.split("/"),e=t.pop(),i=t.join("/")+"/",n=-1!==e.indexOf(".hdr");let s;n?(s=new Os,s.setDataType(THREE.HalfFloatType)):s=new THREE.TextureLoader,s.setPath(x.getPath(i)).load(e,(t=>{n&&t?(t.mapping=THREE.EquirectangularReflectionMapping,this.scene.background=t,this.scene.environment=t):this.setBackground(t)}))}addOffCanvasScene(t){const e=new Vs(t);this.avatars[t.clientId]=e}removeOffCanvasScene(t){this.avatars[t.clientId],delete this.avatars[t.clientId]}updateOffCanvasScene(t){const e=this.avatars[t.clientId];e&&e.update(t)}setBackground(t){let e=t||this.defaultTexture;e.mapping=THREE.EquirectangularReflectionMapping,e.encoding=THREE.sRGBEncoding,this.scene.environment=e}setView(){if(!this.renderer)return;if(!this.panorama)return;const e=this.view_;if(e){null!=ee.state.zoomedId&&ee.patchState({zoomedId:null}),this.views&&this.views.forEach((t=>delete t.onUpdateAsset));const i=this.requestInfoResult;i&&e instanceof Sn&&void 0!==i.gridIndex&&(e.index_=i.gridIndex),e.ready=!1,this.cameraGroup.position.set(0,0,0),this.cameraGroup.rotation.set(0,0,0),e.type.name===gn.Room3d.name?(this.renderer.setClearColor(0,1),this.objects.remove(this.panorama.mesh),this.toggleLights(!1)):(this.renderer.setClearColor(0,1),this.objects.add(this.panorama.mesh),this.toggleLights(!0)),this.pushChanges(),Ms.cancel(),this.panorama.change(e,this.renderer,(i=>{x.flags.useTextureEnvironment||this.setBackground(i),e.ready=!0,e.onUpdateAsset=()=>{this.onViewAssetDidChange()};t.getContext(this)&&this.pushChanges()}),(t=>{this.setViewOrientation(t),Ms.prefetch(t.prefetchAssets)}))}}onViewAssetDidChange(){this.panorama&&this.panorama.crossfade(this.view,this.renderer,(t=>{x.flags.useTextureEnvironment||this.setBackground(t)}))}setViewOrientation(t){const e=this.requestInfoResult;if(this.requestInfoResult=null,this.orbitService&&(this.orbitService.mode=t.type.name,!this.renderer.xr.isPresenting)){let i;e?(i=e.orientation,this.orbitService.setOrientation(i),this.orbitService.zoom=e.zoom,this.camera.updateProjectionMatrix()):t.keepOrientation||(i=t.useLastOrientation?t.lastOrientation:t.orientation,this.orbitService.setOrientation(i),this.orbitService.zoom=t.zoom,this.camera.updateProjectionMatrix())}}addControllers(){const t=this.controllerGroup=new THREE.Group;this.teleport=new Eo,this.controllers=[],this.controllerModelFactory=new Vr,this.addController(0),this.addController(1),this.cameraGroup.add(t)}addController(t){const e=ee.state.live,i=this.renderer,n=this.controllerGroup,s=i.xr.getController(t),o=this.controllerModelFactory,r=this.teleport,a=this.scene,c=this.camera,l=this.cameraGroup;s.name=`[controller${t+1}]`,n.add(s);const d=t=>{this.controller=t},h=t=>{switch(t.index){case 0:case 1:break;case 4:ki.send({type:Ve})}},u=t=>{this.onModelUp()},p=t=>{this.cameraGroup.rotation.y+=Math.PI/180*45},m=t=>{this.cameraGroup.rotation.y-=Math.PI/180*45},v=t=>{this.onModelDistance(t.y)};s.userData.update=()=>{},s.addEventListener("selectstart",(t=>{s.userData.isSelecting=!0,d(s)})),s.addEventListener("selectend",(t=>{s.userData.isSelecting=!1})),s.addEventListener("connected",(r=>{if(s.add(this.buildController(r.data)),e&&"left"===r.data.handedness){const t=this.phone=new go;s.add(t.mesh)}if(!e||"right"===r.data.handedness){const e=i.xr.getControllerGrip(t);e.name=`[controller-grip${t+1}]`;const r=o.createControllerModel(e);s.userData.model=r,e.add(r),n.add(e)}const a=new Io(r.data.gamepad);a.on("press",h),a.on("release",u),a.on("left",p),a.on("right",m),a.on("axis",v),s.userData.gamepad=a,s.userData.update=()=>{a.update()}})),s.addEventListener("disconnected",(e=>{for(;s.children.length;)s.remove(s.children[0]);const o=i.xr.getControllerGrip(t);for(;o.children.length;)o.remove(o.children[0]);n.remove(o),s.userData.update=()=>{};const d=s.userData.gamepad;d&&(d.off("press",h),d.off("release",u),d.off("left",p),d.off("right",m),d.off("axis",v),delete s.userData.gamepad),r.removeFromController(s,a,i,c,l)})),s.addEventListener("squeezestart",(t=>{this.view&&this.view.type.name===gn.Room3d.name&&(r.addToController(s,a),this.indicator.mesh.visible=!1,s.children[0].visible=!1)})),s.addEventListener("squeezeend",(t=>{r.removeFromController(s,a,i,c,l),this.indicator.mesh.visible=!0,s.children[0].visible=!0}));this.controllers.push(s)}buildController(t){let e,i;switch(t.targetRayMode){case"tracked-pointer":return e=new THREE.BufferGeometry,e.setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,-1],3)),e.setAttribute("color",new THREE.Float32BufferAttribute([.5,.5,.5,0,0,0],3)),i=new THREE.LineBasicMaterial({vertexColors:!0,blending:THREE.AdditiveBlending}),new THREE.Line(e,i);case"gaze":return e=new THREE.RingBufferGeometry(.02,.04,32).translate(0,0,-1),i=new THREE.MeshBasicMaterial({opacity:.5,transparent:!0}),new THREE.Mesh(e,i)}}updateRaycasterXR(t,e){if(t)return this.controllerMatrix_.identity().extractRotation(t.matrixWorld),e.ray.origin.setFromMatrixPosition(t.matrixWorld),e.ray.direction.set(0,0,-1).applyMatrix4(this.controllerMatrix_),e}repos(t,e){const i=this.worldRect;t.scale.set(.8,.8,.8);const n=(e.x+e.width/2-i.width/2)/i.width*2*this.camera.aspect,s=(e.y+e.height/2-i.height/2)/i.height*2*this.camera.aspect;t.position.set(n,-s,0)}render(t){try{const t=this.renderer,e=this.scene,i=this.camera,n=this.avatars,s=t.xr.isPresenting;if(!s&&ee.state.mode===di)return;s?(gsap.ticker.tick(),this.controllers.forEach((t=>t.userData.update())),this.teleport.update()):this.navWithKeys(),this.orbitService.render();const o=performance.now(),r=this.tick_?++this.tick_:this.tick_=1;e.traverse((n=>{const s=n.userData.render;"function"==typeof s&&s(o,r,t,e,i)})),Object.keys(n).forEach((t=>{n[t].render()})),this.vrService.updateState(this),this.raycasterXRHitTest(),t.render(e,i)}catch(t){this.error=t}}navWithKeys(){if(this.view&&this.view.type.name===gn.Room3d.name&&this.view.mesh&&!this.locked&&!an.hasModal){this.intersectObjects=this.view.intersectObjects;const t=this.velocity||(this.velocity=new THREE.Vector3),e=this.direction||(this.direction=new THREE.Vector3),i=this.camera,n=.1;if(this.keys.w||this.keys.ArrowUp)i.getWorldDirection(e),e.multiplyScalar(n),t.copy(e);else if(this.keys.s||this.keys.ArrowDown)i.getWorldDirection(e),e.multiplyScalar(-n),t.copy(e);else if(this.keys.d||this.keys.ArrowRight){i.getWorldDirection(e),e.multiplyScalar(n);const s=this.axisY||(this.direction=new THREE.Vector3(0,1,0)),o=-Math.PI/2;e.applyAxisAngle(s,o),t.copy(e)}else if(this.keys.a||this.keys.ArrowLeft){i.getWorldDirection(e),e.multiplyScalar(-n);const s=this.axisY||(this.direction=new THREE.Vector3(0,1,0)),o=-Math.PI/2;e.applyAxisAngle(s,o),t.copy(e)}if(t.manhattanLength()>1e-5){e.copy(this.cameraGroup.position),e.add(t),e.y=0;const i=this.raycaster;i.set(e,jr);i.intersectObjects(this.view.navIntersectObjects).length&&(this.cameraGroup.position.add(t),this.cameraGroup.position.y=0,this.orbitService.markAsDirty()),t.lerp(Br,.1)}else t.set(0,0,0)}else this.intersectObjects=this.panoramaIntersectObjects}animate(){this.renderer.setAnimationLoop(this.render)}resize(){try{const t=this.container,e=this.renderer,i=this.camera,n=this.size,s=t.getBoundingClientRect();n.left=Math.floor(s.left),n.top=Math.floor(s.top),n.width=Math.ceil(s.width),n.height=Math.ceil(s.height),n.aspect=n.width/n.height;if(this.worldRect.setSize(n.width,n.height),!e.xr.isPresenting&&(e.setSize(n.width,n.height),i)){i.aspect=n.width/n.height;const t=i.fov*Math.PI/180,e=Math.abs(i.position.z*Math.tan(t/2)*2),s=this.cameraRect;s.width=e*i.aspect,s.height=e,i.updateProjectionMatrix()}}catch(t){this.error=t}}updateRaycasterMouse(t){const e=this.size.width/2,i=this.size.height/2;this.mouse.x=(t.clientX-this.size.left-e)/e,this.mouse.y=-(t.clientY-this.size.top-i)/i;const n=this.raycaster;return n.setFromCamera(this.mouse,this.camera),n}raycasterXRHitTest(){if(this.renderer.xr.isPresenting&&!this.locked){const t=this.updateRaycasterXR(this.controller,this.raycaster);t&&(Cs.hittest(t,this.controller.userData.isSelecting),this.indicator.update(this.renderer.xr.getCamera(this.camera)))}}raycasterDesktopHitTest(t){const e=this.updateRaycasterMouse(t);if(!this.lockedOrXR)if(this.dragItem){if("function"==typeof this.dragItem.onDragMove){const t=e.intersectObjects(this.intersectObjects);if(t.length){const e=t[0],i=this.intersectionPoint||(this.intersectionPoint=new THREE.Vector3),n=this.intersectionNormal||(this.intersectionNormal=new THREE.Vector3),s=i.copy(e.point),o=n.copy(e.face.normal);this.dragItem.onDragMove(s,o,this.intersectObjects===this.panoramaIntersectObjects)}}}else this.resizeItem||(Cs.hittest(e),this.controlEvent$.next(Fr))}onMouseDown(t){try{if(this.locked)return;if(0!==t.button)return;const e=this.updateRaycasterMouse(t),i=Cs.hittest(e,!0);if(this.editor||R){if(!this.keys.Shift&&!this.keys.Control){this.select.next({item:null});const t=e.intersectObjects(this.intersectObjects);if(t.length){const e=t[0],i=this.intersectionPoint||(this.intersectionPoint=new THREE.Vector3),n=this.intersectionNormal||(this.intersectionNormal=new THREE.Vector3),s=i.copy(e.point),o=n.copy(e.face.normal);this.viewHit.next({position:s,normal:o,spherical:this.intersectObjects===this.panoramaIntersectObjects})}}}else if(this.isTouchDevice()&&i&&"[panorama]"===i.name){const t=this.view.items.find((t=>t.showPanel));t&&(t.showPanel=!1,this.pushChanges())}}catch(t){this.error=t}}onMouseMove(t){try{this.raycasterDesktopHitTest(t)}catch(t){this.error=t}}onMouseUp(t){try{if(this.lockedOrXR)return;this.dragItem&&"function"==typeof this.dragItem.onDragEnd&&(this.dragItem.onDragEnd(),this.dragEnd.next(this.dragItem)),this.dragItem=null,this.resizeItem&&"function"==typeof this.resizeItem.onResizeEnd&&(this.resizeItem.onResizeEnd(),this.resizeEnd.next(this.resizeItem)),this.resizeItem=null;const e=this.updateRaycasterMouse(t);Cs.hittest(e,!1);this.checkSelectedItem()}catch(t){this.error=t}}onMouseWheel(t){try{if(this.lockedOrXR)return;const e=t.deltaY*(void 0!==t.wheelDeltaY?1:37),i=this.orbitService;gsap.to(i,{duration:.5,zoom:i.zoom+.1*e,ease:Power4.easeOut,overwrite:!0})}catch(t){this.error=t}}onOrientationDidChange(){this.controlEvent$.next(Fr)}checkSelectedItem(){if(this.view){const t=this.view.items.find((t=>t.selected));t&&t.mesh&&"model"!==this.view.type.name&&this.orbitService.lookAt(t.mesh)}}onVRStarted(){this.objects.position.y=1.3,this.scene.add(this.indicator.mesh),ki.send({type:ri})}onVREnded(){this.objects.position.y=0,this.cameraGroup.rotation.y=0,this.cameraGroup.position.y=0,this.scene.remove(this.indicator.mesh),this.orbitService.markAsDirty(),ki.send({type:oi})}onVRStateDidChange(t){ki.send({type:ai,camera:t.camera.array})}onMenuNav(t){this.menu=void 0,this.navTo.next({viewId:t.id})}onMenuToggle(t){this.locked||(this.menu=t,this.view.items.forEach((t=>t.showPanel=!1)),this.pushChanges())}onNavOver(t){this.menu||(this.view.items.forEach((t=>t.showPanel=!1)),t.item.to&&clearTimeout(t.item.to),t.item.showPanel=t.shouldShowPanel(),this.pushChanges(),ki.send({type:ti,itemId:t.item.showPanel?t.item.id:null}))}onNavOut(t){this.isTouchDevice()||(t.item.to=setTimeout((()=>{t.item.showPanel=!1,this.pushChanges()}),6e3),this.pushChanges())}onNavDown(t){this.isTouchDevice()||(t.item.showPanel=!1),this.locked||(this.editor&&this.keys.Shift?(this.dragItem=t,this.select.next(t)):this.editor&&this.keys.Control?(this.resizeItem=t,this.select.next(t)):this.navTo.next(t.item))}onNavLink(t){this.locked||this.editor||(x.flags.useIframe?(ki.send({type:Fe,itemId:t.item.id,linkIndex:t.linkIndex}),this.navLink.next(t)):window.open(t.link.href,"_blank"))}isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}onModelDown(t){if(this.editor)return this.onObjectDown(t);const e=this.controller;if(e&&this.renderer.xr.isPresenting){const i=this.tempTarget=t.mesh;this.tempParent=i.parent;const n=new THREE.Vector3;i.localToWorld(n),e.worldToLocal(n),e.add(i),i.position.copy(n)}}onModelDistance(t){const e=this.controller,i=this.tempTarget;if(e&&i&&this.renderer.xr.isPresenting){let e=new THREE.Vector3;e=e.copy(i.position);const n=Math.max(1,Math.min(8,e.distanceTo(Br)+.02*t));e.normalize(),e=e.multiplyScalar(n),i.position.copy(e)}}onModelUp(){const t=this.tempTarget,e=this.tempParent;if(t&&e){const i=new THREE.Vector3;t.localToWorld(i),e.worldToLocal(i),e.add(t),t.position.copy(i),this.tempTarget=null,this.tempParent=null}}onObjectDown(t){this.lockedOrXR||(this.editor&&this.keys.Shift?(this.dragItem=t,this.select.next(t)):this.editor&&this.keys.Control&&(this.resizeItem=t,this.select.next(t)))}onPanelDown(t){this.locked||(x.flags.useIframe?(ki.send({type:Fe,itemId:t.item.id,linkIndex:t.linkIndex}),this.navLink.next(t)):window.open(t.link.href,"_blank"))}onPlayMedia(t){this.editor||ki.send({type:We,itemId:t.itemId,playing:t.playing})}onZoomMedia(t){t.zoomed&&this.view.items.forEach((e=>{e.mesh instanceof $s&&e.id!==t.itemId&&e.mesh.setZoomedState(!1)})),this.view.items.forEach((t=>t.showPanel=!1)),ee.patchState({zoomedId:t.zoomed?t.itemId:null}),ki.send({type:ci,itemId:t.itemId,zoomed:t.zoomed})}onCurrentTimeMedia(t){this.editor||ki.send({type:Ue,itemId:t.itemId,currentTime:t.currentTime})}onPlayModel(t){this.editor||ki.send({type:ze,itemId:t.itemId,actionIndex:t.actionIndex})}onGridMove(t){this.view.items=[],this.pushChanges(),this.orbitService.walk(t.position,((e,i)=>{const n=this.view.getTile(t.indices.x,t.indices.y);n&&this.panorama.crossfade(n,this.renderer,(t=>{x.flags.useTextureEnvironment||this.setBackground(t),this.orbitService.walkComplete(e,i),this.view.updateCurrentItems(),this.pushChanges()}))}))}onGridNav(t){this.locked||(ki.send({type:Ge,viewId:this.view.id,gridIndex:t}),this.pushChanges())}setSnapshot(t){ps.viewId!==t.viewId?(ps.viewId=t.viewId,this.requestInfoResult=t):(this.renderer.xr.isPresenting||(this.orbitService.setOrientation(t.orientation),this.orbitService.zoom=t.zoom,this.cameraGroup.position.set(t.cameraGroup.position[0],t.cameraGroup.position[1],t.cameraGroup.position[2]),this.cameraGroup.rotation.set(t.cameraGroup.rotation[0],t.cameraGroup.rotation[1],t.cameraGroup.rotation[2])),this.view instanceof Sn&&t.gridIndex&&(this.view.index=t.gridIndex),this.view&&this.view.ready||(this.requestInfoResult=t))}getSnapshot(){const t=de(de({},Fr),{},{viewId:this.view.id,type:Ze});return this.view instanceof Sn&&(t.gridIndex=this.view.index),t}sendSetSnapshot(){const t=this.getSnapshot();ki.send(t)}control$(){return this.controlEvent$.pipe(n.filter((()=>this.controlling||this.spyed||this.editor)),n.auditTime(Math.floor(1e3/15)),n.map((t=>{t.orientation.latitude=this.orbitService.latitude,t.orientation.longitude=this.orbitService.longitude,t.zoom=this.orbitService.zoom,t.cameraGroup={position:this.cameraGroup.position.toArray(),rotation:this.cameraGroup.rotation.toArray()};const e=this.raycaster.intersectObjects(this.intersectObjects),i=e.length?e[0].point.normalize():null;return i&&(t.pointer[0]=i.x,t.pointer[1]=i.y,t.pointer[2]=i.z),ki.send(t),t})),n.auditTime(4e3),n.tap((t=>{const e=this.getSnapshot();ki.send(e)})))}addListeners(){this.controlEvent$=new i.ReplaySubject(1),this.control$().pipe(n.takeUntil(this.unsubscribe$)).subscribe();const t=this.vrService=Ro.getService();t.session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.renderer.xr.setSession(t),t?this.onVRStarted():this.onVREnded()})),t.state$.pipe(n.takeUntil(this.unsubscribe$),n.auditTime(Math.floor(1e3/15))).subscribe((t=>{this.onVRStateDidChange(t)}));this.orbitService.observe$(this.container).pipe(n.shareReplay(1)).pipe(n.filter((t=>t instanceof eo)),n.auditTime(Math.floor(1e3/15))).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.onOrientationDidChange()})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(Ki.log("WorldComponent.addListeners","MessageService.out$",t),t.type){case qe:Ki.log("WorldComponent.MessageType.RequestControl",t.controllingId),ee.patchState({controlling:t.controllingId,spying:!1}),t.controllingId===ee.state.uid&&this.sendSetSnapshot();break;case Je:Ki.log("WorldComponent.MessageType.RequestSpy",t.spyingId),ee.patchState({spying:t.spyingId,controlling:!1}),t.spyingId===ee.state.uid&&this.sendSetSnapshot();break;case Ze:this.setSnapshot(t);break;case ti:this.menu&&this.menu.removeMenu(),this.view.items.forEach((e=>e.showPanel=e.id===t.itemId)),this.pushChanges();break;case Fe:{const e=this.view.items.find((e=>e.id===t.itemId));if(e){const i=e.links[t.linkIndex];this.navLink.next({item:e,link:i,linkIndex:t.linkIndex})}break}case He:this.view.items.find((e=>e.id===t.itemId))&&an.resolve();break;case We:{const e=this.view.items.find((e=>e.id===t.itemId));e&&e.mesh instanceof $s&&e.mesh.setPlayingState(t.playing);break}case ci:this.view.items.forEach((e=>{e.mesh instanceof $s&&(e.id===t.itemId?e.mesh.setZoomedState(t.zoomed):e.mesh.setZoomedState(!1))})),ee.patchState({zoomedId:t.zoomed?t.itemId:null});break;case Ue:{const e=this.view.items.find((e=>e.id===t.itemId));e&&e.mesh instanceof $s&&e.mesh.setCurrentTime(t.currentTime);break}case ze:{const e=this.view.items.find((e=>e.id===t.itemId));e&&e.onMessage(t);break}case Ge:this.view.id===t.viewId&&(this.view.index=t.gridIndex);break;case ri:this.addOffCanvasScene(t);break;case oi:this.removeOffCanvasScene(t);break;case ai:this.updateOffCanvasScene(t),ee.state.spying!==t.clientId&&ee.state.controlling!==t.clientId||this.orbitService.setVRCamera(t.camera);break;case xe:this.renderer.xr.isPresenting||(this.orbitService.setOrientation(t.orientation),this.orbitService.zoom=t.zoom,this.cameraGroup.position.set(t.cameraGroup.position[0],t.cameraGroup.position[1],t.cameraGroup.position[2]),this.cameraGroup.rotation.set(t.cameraGroup.rotation[0],t.cameraGroup.rotation[1],t.cameraGroup.rotation[2])),this.pointer.setPosition(t.pointer[0],t.pointer[1],t.pointer[2],this.camera)}})),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{if(t.type===Qe)this.checkSelectedItem()})),ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.showPointer=this.locked})),this.resize=this.resize.bind(this),this.render=this.render.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseWheel=this.onMouseWheel.bind(this),window.addEventListener("resize",this.resize,!1),this.container.addEventListener("wheel",this.onMouseWheel,!1),this.container.addEventListener("mousedown",this.onMouseDown,!1),this.container.addEventListener("mouseup",this.onMouseUp,!1),document.addEventListener("mousemove",this.onMouseMove,!1)}removeListeners(){window.removeEventListener("resize",this.resize,!1),window.removeEventListener("resize",this.resize,!1),document.removeEventListener("mousemove",this.onMouseMove,!1),document.removeEventListener("wheel",this.onMouseWheel,!1),this.container.removeEventListener("mousedown",this.onMouseDown,!1),this.container.removeEventListener("mouseup",this.onMouseUp,!1)}}Hr.meta={selector:"[world]",inputs:["view","views","editor"],outputs:["navTo","navLink","viewHit","dragEnd","resizeEnd","select"],template:'\n\t<div class="world__view" *if="view">\n\t\t<div class="grid" model-grid *if="view.type.name === \'panorama-grid\'" [view]="view" (move)="onGridMove($event)" (nav)="onGridNav($event)"></div>\n\t\t<div *if="view.ready">\n\t\t\t<div model-room [view]="view" *if="view.type.name === \'room-3d\'"></div>\n\t\t\t<div class="world__item" *for="let item of view.pathItems; let index = index;">\n\t\t\t\t<div model-nav [item]="item" [view]="view" (over)="onNavOver($event)" (out)="onNavOut($event)" (down)="onNavDown($event)" (link)="onNavLink($event)" *if="item.type.name == \'nav\'"></div>\n\t\t\t\t<div model-plane [item]="item" [view]="view" (play)="onPlayMedia($event)" (zoom)="onZoomMedia($event)" (down)="onObjectDown($event)" (currentTime)="onCurrentTimeMedia($event)" *if="item.type.name == \'plane\'"></div>\n\t\t\t\t<div model-curved-plane [item]="item" [view]="view" (play)="onPlayMedia($event)" (zoom)="onZoomMedia($event)" (down)="onObjectDown($event)" (currentTime)="onCurrentTimeMedia($event)" *if="item.type.name == \'curved-plane\'"></div>\n\t\t\t\t<div class="model-viewer__item" model-model [item]="item" [view]="view" (down)="onModelDown($event)" (play)="onPlayModel($event)" *if="item.type.name == \'model\'"></div>\n\t\t\t\t<div class="panel" [class]="{ \'panel--lg\': item.asset != null }" model-panel [item]="item" (down)="onPanelDown($event)" *if="item.showPanel"></div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="progress-indicator" model-progress [view]="view">\n\t\t<div class="inner"></div>\n\t</div>\n\t<div model-menu [views]="views" (nav)="onMenuNav($event)" (toggle)="onMenuToggle($event)" *if="showMenu"></div>\n\t<div model-debug *if="debugging"></div>\n\t<div class="world__info" *if="error" [innerHTML]="error"></div>\n\t'};class Gr extends t.Component{set renderOrder(t){this.group.renderOrder=t}onInit(){if(!this.host)throw"ModelComponent host is undefined";this.scale=new THREE.Vector3(1,1,1),this.position=new THREE.Vector3;const t=this.group=new THREE.Group;t.name=this.getName(),t.userData.render=(t,e)=>{this.render(this,t,e)},this.getContainer().add(t),this.onCreate(((t,e)=>this.onMount(t,e)),((t,e)=>this.onDismount(t,e)))}onDestroy(){const t=this.group;this.getContainer().remove(t),delete t.userData.render,this.disposeObject(t),this.group=null}getContainer(){return this.host.objects}getName(t){return`${this.constructor.meta.selector}-${this.rxcompId}${t?`-${t}`:""}`}onCreate(t,e){const i=new THREE.MeshStandardMaterial({color:new THREE.Color("#ffcc00"),roughness:.4,metalness:.01,flatShading:!0,transparent:!0,opacity:.9}),n=new THREE.Mesh(ys.defaultGeometry,i);return"function"==typeof t&&t(n),n}onMount(t,e){this.mesh&&this.onDismount(this.mesh),t.name=this.getName("mesh"),this.mesh=t,e&&(e.mesh=t,Object.defineProperty(e,"visible",{get:()=>t.visible,set:t=>{this.setVisible(t)},configurable:!0}),e.onUpdate=()=>{this.onUpdate(e,t)},e.onUpdateAsset=()=>{this.onUpdateAsset(e,t)},e.onMessage=t=>{this.onMessage(t)}),this.group&&this.group.add(t)}onDismount(t,e){this.group.remove(t),"function"==typeof t.dispose&&t.dispose(),this.disposeObject(t),this.mesh=null,e&&(delete e.mesh,delete e.onUpdate,delete e.onUpdateAsset,delete e.onMessage)}disposeObject(t){t.traverse((t=>{(t.isInteractiveMesh||t.isInteractiveSprite)&&Cs.dispose(t),t.isMesh?(t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose(),t.geometry.dispose()):t.isSprite&&(t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose())}))}calculateScaleAndPosition(){const{node:e}=t.getContext(this);this.host.repos(this,e.getBoundingClientRect())}render(t,e){}setVisible(t){this.mesh&&(this.mesh.visible=t)}getScroll(t){return this.intersection.scroll(t)}getTween(t){let e=Math.min(0,this.intersection.offset(t))+1;return e=Math.max(0,e),e-=1,e}onUpdate(t,e){}onUpdateAsset(t,e){}onMessage(t){}}Gr.meta={selector:"[model]",hosts:{host:Hr},inputs:["item"]};class $r extends Gr{get editing(){return this.editing_}set editing(t){this.editing_!==t&&(this.editing_=t,this.setHelper(t))}onInit(){super.onInit(),this.RADIUS=100}onDestroy(){this.editing=!1,super.onDestroy()}setHelper(t){t?(this.helper||(this.helper=new THREE.BoxHelper(this.mesh,65280)),this.host.scene.add(this.helper)):this.helper&&this.host.scene.remove(this.helper)}updateHelper(){this.helper&&this.helper.setFromObject(this.mesh)}}$r.meta={selector:"[model-editable]",hosts:{host:Hr},inputs:["item"]};const Wr="none",zr="move",Kr="info",qr="point",Yr="title",Jr="transparent",Xr="wishlist";class Qr extends $r{constructor(){super(...arguments),this.hidden_=!1,this.isMobile_=void 0}static getLoader(){return Qr.loader||(Qr.loader=new THREE.TextureLoader)}static getTexturePoint(){return Qr.texturePoint||(Qr.texturePoint=Qr.getLoader().load(x.getPath("textures/ui/nav-point.png")))}static getTexturePointImportant(){return Qr.texturePointImportant||(Qr.texturePointImportant=Qr.getLoader().load(x.getPath("textures/ui/nav-point-important.png")))}static getTextureMove(){return Qr.textureMove||(Qr.textureMove=Qr.getLoader().load(x.getPath("textures/ui/nav-more.png")))}static getTextureMoveImportant(){return Qr.textureMoveImportant||(Qr.textureMoveImportant=Qr.getLoader().load(x.getPath("textures/ui/nav-more-important.png")))}static getTextureInfo(){return Qr.textureInfo||(Qr.textureInfo=Qr.getLoader().load(x.getPath("textures/ui/nav-info.png")))}static getTextureInfoImportant(){return Qr.textureInfoImportant||(Qr.textureInfoImportant=Qr.getLoader().load(x.getPath("textures/ui/nav-info-important.png")))}static getTextureWishlist(){return Qr.textureWishlist||(Qr.textureWishlist=Qr.getLoader().load(x.getPath("textures/ui/nav-wishlist-off.png")))}static getTextureWishlistAdded(){return Qr.textureWishlistAdded||(Qr.textureWishlistAdded=Qr.getLoader().load(x.getPath("textures/ui/nav-wishlist-on.png")))}static getTexture(t,e){let i;switch(t){case zr:i=e.important?this.getTextureMoveImportant():this.getTextureMove();break;case Kr:i=e.important?this.getTextureInfoImportant():this.getTextureInfo();break;case qr:case Yr:i=e.important?this.getTexturePointImportant():this.getTexturePoint();break;case Xr:i=e.added?this.getTextureWishlistAdded():this.getTextureWishlist()}return i.disposable=!1,i.encoding=THREE.sRGBEncoding,i}static getTitleTexture(t,e){let i;if(e===Yr){const e=t.title,n=document.createElement("canvas");n.width=512,n.height=32;const s=n.getContext("2d");s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.font=`24px ${x.fontFamily}`;let o=s.measureText(e).width+8;o=Math.pow(2,Math.ceil(Math.log(o)/Math.log(2)));const r=o/2,a=16;n.width=o,s.font=`24px ${x.fontFamily}`,s.textAlign="center",s.textBaseline="middle",s.strokeStyle="rgba(0, 0, 0, 0.5)",s.lineWidth=6,s.lineJoin="round",s.miterLimit=2,s.strokeText(e,r,a),s.fillStyle="white",s.fillText(e,r,a),i=new THREE.CanvasTexture(n)}return i}static getNavMode(t,e){let i=Wr;return t.hook&&"ToggleWishlist"===t.hook?i=Xr:t.transparent?i=Jr:t.viewId!==e.id?(i=zr,this.isValidText(t.title)&&(i=Yr),(this.isValidText(t.abstract)||t.asset&&t.asset.id||t.link&&t.link.href)&&(i=qr)):(this.isValidText(t.title)||this.isValidText(t.abstract)||t.asset&&t.asset.id||t.link&&t.link.href)&&(i=Kr),i}static hasNavInfo(t){return null!=t.items.find((e=>this.getNavMode(e,t)===Kr))}static isValidText(t){return t&&t.length>0}get hidden(){return this.hidden_}set hidden(t){this.hidden_!==t&&(this.hidden_=t,this.updateVisibility(!t))}get isHidden(){return null!=ee.state.zoomedId||x.flags.hideNavInfo&&!this.host.editor&&!ee.state.showNavInfo&&!(this.host.renderer.xr.isPresenting||ee.state.role===ie.SelfService||ee.state.role===ie.Embed)&&this.mode===Kr}get isAnimated(){let t=!1;const e=this.mode,i=this.item.important;switch(e){case Kr:t=i?x.flags.navInfoImportantAnimated:x.flags.navInfoAnimated;break;case zr:t=i?x.flags.navMoveImportantAnimated:x.flags.navMoveAnimated;break;case qr:t=i?x.flags.navPointImportantAnimated:x.flags.navPointAnimated;break;case Yr:t=i?x.flags.navTitleImportantAnimated:x.flags.navTitleAnimated;break;case Jr:t=i?x.flags.navTransparentImportantAnimated:x.flags.navTransparentAnimated}return t}get iconMinScale(){return.03*(x.navs.iconMinScale||1)*(this.isMobile?1.6:1)}get iconMaxScale(){return.03*(x.navs.iconMaxScale||1.5)*(this.isMobile?1.6:1)}get isMobile(){return this.isMobile_}set isMobile(t){this.isMobile_!==t&&(this.isMobile_=t,this.setScale())}render(t,e){this.isMobile=this.host.worldRect.width<768}setScale(t){void 0===t&&(t=0);const e=this.icon;if(e){const i=this.iconMinScale+t*(this.iconMaxScale-this.iconMinScale);e.scale.set(i,i,i)}}shouldShowPanel(){return!this.editing&&this.mode!==zr&&this.mode!==Yr&&this.mode!==Xr&&(this.mode!==Jr||Qr.isValidText(this.item.title))}updateVisibility(t){this.mesh&&(this.mesh.visible=t),this.sphere&&(this.sphere.freezed=!t),!t&&this.item&&(this.item.showPanel=!1)}setVisible(t){this.mesh&&(this.mesh.visible=t&&!this.hidden_)}onInit(){super.onInit()}onChanges(){const t=this.view,e=this.item;(this.mode=Qr.getNavMode(e,this.view))===Xr&&(e.added=vs.has({viewId:t.id,itemId:e.id}),this.onCreateSprites(this.mesh,1)),this.editing=e.selected,this.hidden=this.isHidden}onCreate(t,e){const i=this.view,n=this.item,s=this.mode=Qr.getNavMode(n,this.view);if(s===Wr)return;s===Xr&&(n.added=vs.has({viewId:i.id,itemId:n.id}));const o=this.isAnimated,r=new THREE.Group;if(s===Jr){const t=this.host.editor?.1:0,e=.2,i=.3;r.position.fromArray(n.position),r.rotation.fromArray(n.rotation),r.scale.fromArray(n.scale);const s=ys.planeGeometry,a=this.plane=new As(s,new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,opacity:t,color:new THREE.Color(x.colors.menuOverBackground),toneMapped:!1}));if(a.name=`[nav] ${n.id}`,a.depthTest=!1,r.add(a),o){const t={pow:0};gsap.to(t,{pow:1,duration:.6,delay:.5+.1*n.index,ease:Power2.easeOut,repeat:-1,yoyo:!0,onUpdate:()=>{a.material.opacity=t.pow*i}})}a.on("over",(()=>{o||(a.material.opacity=e),this.over.next(this)})),a.on("out",(()=>{o||(a.material.opacity=t),this.out.next(this)})),a.on("down",(()=>{o||(a.material.opacity=i),this.down.next(this);const t=this.item.firstLink;!this.host.editor&&!this.shouldShowPanel()&&t&&t.href&&(this.shouldNavToLink=t.href),console.log("ModelNavComponent.down")})),a.on("up",(()=>{if(o||(a.material.opacity=t),null!=this.shouldNavToLink){this.shouldNavToLink=null;const t=this.item,e=t.firstLink;this.link.next({item:t,link:e})}}))}else{const t=new THREE.Vector3(n.position[0],n.position[1],n.position[2]),e=new THREE.Vector3(n.position[0],n.position[1],n.position[2]).normalize();t.distanceToSquared(e)<1e-4&&t.multiplyScalar(Qr.RADIUS),r.position.copy(t),this.onCreateSprites(r);const i=ys.sphereGeometry,s=this.sphere=new As(i,new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,opacity:0,color:65535,toneMapped:!1}));s.name=`[nav] ${n.id}`,s.depthTest=!1,r.add(s);const a={pow:0};gsap.to(a,{pow:1,duration:.7,delay:.5+.1*n.index,ease:Power2.easeInOut,overwrite:!0,onUpdate:()=>{this.materials.forEach((t=>{t.opacity=a.pow}))},onComplete:()=>{if(o){const t=this.icon;a.pow=0,gsap.to(a,{pow:1,duration:.6,delay:.5+.1*n.index,ease:Power2.easeOut,repeat:-1,yoyo:!0,onUpdate:()=>{this.setScale(a.pow),t.material.opacity=a.pow}})}}}),s.on("over",(()=>{if(this.over.next(this),!o){const t=this.icon,e={scale:t.scale.x};gsap.to(e,{duration:.35,scale:this.iconMaxScale,delay:0,ease:Power2.easeOut,overwrite:!0,onUpdate:()=>{t.scale.set(e.scale,e.scale,e.scale)}})}})),s.on("out",(()=>{if(this.out.next(this),!o){const t=this.icon,e={scale:t.scale.x};gsap.to(e,{duration:.35,scale:this.iconMinScale,delay:0,ease:Power2.easeOut,overwrite:!0,onUpdate:()=>{t.scale.set(e.scale,e.scale,e.scale)}})}})),s.on("down",(()=>{this.down.next(this)}))}"function"==typeof t&&t(r,n)}onCreateSprites(t,e){void 0===e&&(e=0),this.onRemoveSprite(this.icon),this.onRemoveSprite(this.title);const i=this.item,n=this.mode=Qr.getNavMode(i,this.view);if(n!==Wr)if(n===Jr)this.materials=[];else{const s=Qr.getTexture(n,i),o=new THREE.SpriteMaterial({map:s,depthTest:!1,depthWrite:!1,transparent:!0,sizeAttenuation:!1,opacity:e,toneMapped:!1}),r=[o],a=this.icon=new THREE.Sprite(o);let c;a.renderOrder=x.renderOrder.nav,this.setScale(),t.add(a);const l=Qr.getTitleTexture(i,n);if(l){c=new THREE.SpriteMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:l,sizeAttenuation:!1,opacity:e,toneMapped:!1});const i=l.image,n=this.title=new THREE.Sprite(c),s=this.iconMinScale;n.scale.set(s*i.width/i.height,s,s),n.position.set(0,-3.5,0),t.add(n),r.push(c)}this.materials=r}}onRemoveSprite(t){t&&(t.parent&&t.parent.remove(t),t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose())}onDestroy(){Cs.dispose(this.sphere),super.onDestroy()}onUpdate(t,e){this.item=t,this.onCreateSprites(e,1),this.mode===Jr?(t.position&&e.position.fromArray(t.position),t.rotation&&e.rotation.fromArray(t.rotation),t.scale&&e.scale.fromArray(t.scale)):(e.position.fromArray(t.position),e.rotation.set(0,0,0),e.scale.set(1,1,1)),this.updateHelper()}onDragMove(t,e,i){const n=this.item,s=this.mesh;this.editing=!0,n.showPanel=!1,this.mode===Jr?i?(t.normalize().multiplyScalar(Qr.RADIUS),s.position.set(t.x,t.y,t.z),s.lookAt(ws.origin)):(s.position.set(0,0,0),s.lookAt(e),s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))):i?(t.normalize().multiplyScalar(Qr.RADIUS),s.position.set(t.x,t.y,t.z)):(s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))),this.updateHelper()}onDragEnd(){const t=this.item,e=this.mesh;this.mode===Jr?(t.position=e.position.toArray(),t.rotation=e.rotation.toArray(),t.scale=e.scale.toArray()):t.position=e.position.toArray(),this.editing=!1}}Qr.RADIUS=100,Qr.meta={selector:"[model-nav]",hosts:{host:Hr},outputs:["over","out","down","link"],inputs:["item","view"]};class Zr extends t.Component{get meetingUrl(){return this.meetingUrl_||(this.meetingUrl_=new re),this.meetingUrl_}get isVirtualTourUser(){return-1!==[ie.Publisher,ie.Attendee,ie.Streamer,ie.Viewer].indexOf(ee.state.role)}get isEmbed(){return this.route&&"embed"===this.route.params.mode}get isSelfServiceTour(){return this.route&&"selfServiceTour"===this.route.params.mode}get isNavigable(){return null==this.meetingUrl.embedViewId}get isBackButtonVisible(){return this.view&&(this.view.type.name===gn.Media.name||this.view.type.name===gn.Model.name)}get isSelfServiceProposition(){return ee.state.role===ie.SelfService&&x.flags.selfServiceProposition}get isSelfServiceSupport(){return ee.state.role===ie.Publisher&&x.flags.selfServiceProposition&&this.meetingUrl.support}get showNavInfoToggler(){return x.flags.hideNavInfo&&this.state.mode!==di&&this.view&&Qr.hasNavInfo(this.view)}get uiClass(){const t={};return t[this.state.role]=!0,t.chat=this.state.chat,t.remotes=this.state.mode===di,t.remoteScreen=null!=this.remoteScreen&&!this.hasScreenViewItem,t.locked=this.locked,t}get remoteClass(){return`group--remote--${Math.min(9,this.remotes.length)}`}get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get locked(){return this.controlled||this.spying}get remoteScreen(){return this.remoteScreen_}set remoteScreen(t){this.remoteScreen_!==t&&(this.remoteScreen_=t,setTimeout((()=>{window.dispatchEvent(new Event("resize"))}),1))}get pathViews(){return ps.pathViews}onInit(){const{node:e}=t.getContext(this);e.classList.remove("hidden"),this.platform=Fi.platform,this.route=this.host?this.host.route:null,this.state={},this.hosted=null,this.view=null,this.previousView=null,this.form=null,this.local=null,this.screen=null,this.remoteScreen_=null,this.navmaps=[],this.navmap=null,this.hasScreenViewItem=!1,this.remotes=[];(this.vrService=Ro.getService()).status$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.pushChanges())),this.resolveUser()}getName(t){return ee.state.name||re.getName(t)}getLinkRole(){let t=null;if(this.isSelfServiceTour)return t=ie.SelfService,t;const e=((new re).link||"").match(/\d{9}-(\d{4})-\d{13}/);if(e){const i=parseInt(e[1]);t=Object.keys(ie).reduce(((t,e,n)=>n===i?ie[e]:t),null)}return t}resolveUser(){this.isEmbed?wi.temporaryUser$(ie.Embed).pipe(n.first()).subscribe((t=>{this.initWithUser(t)})):this.isSelfServiceTour?wi.overrideUser$(ie.SelfService).pipe(n.first()).subscribe((t=>{this.initWithUser(t)})):wi.me$().pipe(n.first()).subscribe((t=>{this.initWithUser(t)}))}userGuard(t){const e=this.getLinkRole();!t||e&&t.type!==e?this.initWithUser({type:e}):this.initWithUser(t)}userGuardRedirect(t){const e=this.getLinkRole();!t||e&&e!==t.type?e===ie.Publisher||e===ie.Attendee?te.setRouterLink(Ee.transform(":lang.access")):this.initWithUser({type:e}):this.initWithUser(t)}setNextStatus(){let t=be;const e=ee.state;return e.role===ie.SmartDevice&&(e.name=e.name||"Smart Device"),t=e.checklist?e.link?e.user.id||e.role!==ie.Publisher&&e.role!==ie.Attendee?e.name?e.role!==ie.Viewer&&e.role!==ie.SmartDevice?Re:Ie:Ce:we:ye:Te,ee.patchState({status:t}),t}getPathId(){const t=new re;let e=t.pathId;if(e)return parseInt(e);const i=t.link;if(i){e=new oe(i).pathId}return e}initWithUser(t){const e=(new re).link,i=this.getPathId(),s=this.getLinkRole()||(t?t.type:null);if(s===ie.SelfService){if(!t||t.type!==ie.SelfService&&t.type!==ie.Publisher)return void te.setRouterLink(Ee.transform(":lang.access"));t=Object.assign({},t,{type:ie.SelfService})}else s!==(t=t||{type:s}).type&&(t={type:s});const o=wi.getMode(s),r=this.getMeetingName(t),a=s===ie.Publisher,c=s!==ie.SelfService&&s!==ie.Embed&&!R,l=this.isNavigable,d={user:t,role:s,mode:o,name:r,checklist:null,pathId:i,link:e,channelName:x.channelName,uid:null,status:be,connecting:!1,connected:!1,controlling:!1,spying:!1,silencing:!1,hosted:a,live:c,navigable:l,cameraMuted:!1,audioMuted:!1,showNavInfo:!0};ee.state=d,ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.hosted=t.hosted,this.pushChanges(),this.locked?document.body.classList.add("locked"):document.body.classList.remove("locked")})),this.initAgora()}getMeetingName(t){const e=new re;let i=null;return i=x.flags.useExtendedUserInfo?e.firstName&&e.lastName?`${e.firstName} ${e.lastName}`:null:e.name?e.name:null,!i&&t.firstName&&t.lastName&&(i=`${t.firstName} ${t.lastName}`),i}viewObserver$(){return ps.data$().pipe(n.switchMap((t=>Dn.getCurrentPath$(ee.state.pathId).pipe(n.switchMap((e=>ps.hostedView$(t,e)))))),n.map((t=>{this.agora&&this.agora.navToView(t.id,t.keepOrientation,t.useLastOrientation),this.previousView=this.view,this.view=t,this.setNavmap(t),this.hasScreenViewItem=null!=t.items.find((t=>Ts.isPublisherScreen(t)||Ts.isAttendeeScreen(t))),this.pushChanges();const e=this.state;return Hn.push({action:"b-here-view",viewId:t.id,userType:e.role}),t})))}load(t){this.loadNavmaps(),this.viewObserver$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((e=>{"function"==typeof t&&(t(),t=null)}))}loadNavmaps(){x.flags.navmaps&&Fn.navmapGet$().pipe(n.first()).subscribe((t=>{this.navmaps=t}))}setNavmap(t){const e=(this.navmaps||[]).find((e=>null!=(e.items||[]).find((e=>e.viewId===t.id))))||null;this.navmap=e}toggleNavmap(){ee.patchState({showNavmap:!ee.state.showNavmap})}onNavmapItem(t){ee.patchState({showNavmap:!1}),this.onNavTo(t)}loadAndConnect(t){this.load((()=>{this.connect(t)}))}initAgora(){this.state.role===ie.SelfService||this.state.role===ie.Embed||R?(this.load((()=>{ee.patchState({status:Oe,hosted:!0})})),this.checkSelfServiceProposition(),this.checkSelfServiceAudio()):dn.isChecked$().pipe(n.first()).subscribe((t=>{ee.patchState({checklist:t}),this.agora=Zi.getSingleton(),this.getLinkRole(),this.setNextStatus()})),Qi.local$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.local=t,this.pushChanges()})),Qi.screen$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.screen===this.remoteScreen&&(this.remoteScreen=null),this.screen=t,this.remoteScreen=t||this.remoteScreen,this.pushChanges()})),Qi.orderedRemotes$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.remotes=[],this.remoteScreen=this.screen,t.forEach((t=>{t.clientInfo&&t.clientInfo.screenUid===t.streamId?this.remoteScreen=t:this.remotes.push(t)})),this.pushChanges()})),ki.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(t.type){case Le:if(this.isSelfServiceSupport){t.members.length>0?(Xn.open$({message:ve.transform("bhere_support_request_sent"),type:$n,position:Kn}),ki.send({type:ii})):Xn.open$({message:ve.transform("bhere_support_request_leaved"),type:$n,position:Kn})}break;case ii:this.isSelfServiceProposition&&this.openSupportRequestDialog(t.clientInfo);break;case ni:Xn.open$({message:ve.transform("bhere_support_request_accepted"),type:$n,position:Kn});break;case si:Xn.open$({message:ve.transform("bhere_support_request_rejected"),type:$n,position:Kn});break;case Ke:ee.patchState({silencing:t.silencing}),this.setAudio(t.silencing);break;case $e:this.onRemoteNavTo(t);break;case Be:ee.patchState({mode:t.mode}),window.dispatchEvent(new Event("resize"));break;case je:this.hidePanels(),ee.patchState({showNavInfo:t.showNavInfo});break;case Ne:ps.setViewLike$(t).pipe(n.first()).subscribe((t=>this.showLove(t)));break;case Pe:ee.state.chat||ee.patchState({chatDirty:!0})}})),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.agora&&this.agora.sendMessage(t)})),this.fullscreen$().pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.agora&&ee.state.status===Ie&&this.loadAndConnect()}onChecked(t){ee.patchState({checklist:!0}),this.setNextStatus()}onLink(t){const e=new oe(t).pathId,i=this.getLinkRole(),n=wi.getMode(i),s=ee.state.user;i!==ie.Publisher&&i!==ie.Attendee||s.id&&s.type===i?ee.state.name?i===ie.Viewer||i===ie.SmartDevice?(ee.patchState({link:t,pathId:e,role:i,mode:n}),this.loadAndConnect()):ee.patchState({link:t,pathId:e,role:i,mode:n,status:Re}):ee.patchState({link:t,pathId:e,role:i,mode:n,status:Ce}):ee.patchState({link:t,pathId:e,role:i,mode:n,status:we})}onLogin(t){const e=this.getName(t);e?ee.patchState({user:t,name:e,status:Re}):ee.patchState({user:t,status:Ce})}onName(t){ee.state.role===ie.Viewer||ee.state.role===ie.SmartDevice?(ee.patchState({name:t}),this.loadAndConnect()):ee.patchState({name:t,status:Re})}onEnter(t){this.loadAndConnect(t)}connect(t){this.agora.connect$(t).pipe(n.takeUntil(this.unsubscribe$)).subscribe();const e=this.state;if(e.role===ie.SelfService)Hn.push({action:"b-here-tour",userType:e.role});else if(e.role===ie.Embed)Hn.push({action:"b-here-embed",userType:e.role});else{const t=new re,i=e.link.replace(/-\d+-/,"-"),s={meetingId:e.link,sharedMeetingId:i,userType:e.role};x.flags.useExtendedUserInfo?(s.firstName=t.firstName,s.lastName=t.lastName,s.email=t.email):s.fullName=e.name,wi.log$(s).pipe(n.first()).subscribe(),Hn.push({action:"b-here-meeting",meetingId:e.link,sharedMeetingId:i,userType:e.role})}}disconnect(){this.agora?this.agora.leaveChannel().then((()=>{window.location.reload()}),console.log):this.patchState({connecting:!1,connected:!1})}onNavTo(t){const e=t.viewId,i=this.pathViews.find((t=>t.id===e));i&&(ps.action={viewId:e,keepOrientation:t.keepOrientation,useLastOrientation:t.useLastOrientation},this.onHandleHook(i,t))}onNavLink(t){an.open$({iframe:t.link.href}).pipe(n.first()).subscribe((e=>{ki.send({type:He,itemId:t.item.id})}))}onRemoteNavTo(t){const e=t.viewId,i=t.gridIndex;if(e&&ps.viewId!==e){const n=this.pathViews.find((t=>t.id===e));n&&(ps.action={viewId:e,keepOrientation:t.keepOrientation,useLastOrientation:t.useLastOrientation},null!=i&&n instanceof Sn&&(n.index=i))}}onHandleHook(t,e){switch(e.hook){case"ToggleWishlist":{const i={viewId:t.id,itemId:e.id};vs.toggle$(i).pipe(n.switchMap((t=>(i.added=vs.has(i),Ii.send$(e.hook,i,e.extra)))),n.first()).subscribe((t=>{Ki.log("AgoraComponent.onHandleHook",t),e.added=i.added,this.pushChanges()}));break}}}patchState(t){this.state=Object.assign({},this.state,t),this.pushChanges()}toggleCamera(){this.agora?this.agora.toggleCamera():this.patchState({cameraMuted:!this.state.cameraMuted})}toggleAudio(){this.agora?this.agora.toggleAudio():this.patchState({audioMuted:!this.state.audioMuted})}setAudio(t){this.agora?this.agora.setAudio(t):this.patchState({audioMuted:t})}toggleScreen(){this.agora?this.agora.toggleScreen():this.patchState({screen:!this.state.screen}),window.dispatchEvent(new Event("resize"))}toggleVolume(){const t=!this.state.volumeMuted;ee.patchState({volumeMuted:t});const e=this.selfServiceAudio;e&&(e.volume=t?0:.5)}toggleMode(){if(this.agora&&ee.state.role===ie.Publisher)this.agora.toggleMode();else{const t=this.state.mode===li?di:li;ee.patchState({mode:t})}window.dispatchEvent(new Event("resize"))}toggleFullScreen(){const{node:e}=t.getContext(this);!this.state.fullScreen?e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}fullscreen$(){return i.fromEvent(document,"fullscreenchange").pipe(n.tap((t=>{const e=null!=document.fullscreenElement;ee.patchState({fullScreen:e})})))}toggleChat(){ee.patchState({chat:!ee.state.chat,chatDirty:!1}),window.dispatchEvent(new Event("resize"))}onChatClose(){ee.patchState({chat:!1}),window.dispatchEvent(new Event("resize"))}toggleNavInfo(){this.hidePanels(),this.agora?this.agora.toggleNavInfo():this.patchState({showNavInfo:!this.state.showNavInfo})}onBack(){this.previousView&&this.view&&this.previousView.id!==this.view.id&&(ps.action={viewId:this.previousView.id,useLastOrientation:!0})}hidePanels(){this.view.items.forEach((t=>t.showPanel=!1))}onToggleControl(t){if(this.agora)this.agora.toggleControl(t);else{const e=this.state.controlling===t?null:t;this.patchState({controlling:e,spying:!1})}}onToggleSilence(){this.agora?this.agora.toggleSilence():this.patchState({silencing:!this.state.silencing})}onToggleSpy(t){if(this.agora)this.agora.toggleSpy(t);else{const e=this.state.spying===t?null:t;this.patchState({spying:e,controlling:!1})}}addLike(){ps.viewLike$(this.view).pipe(n.first()).subscribe((t=>{t&&(this.view.liked=!0,this.showLove(t),ki.send({type:Ne,viewId:this.view.id,likes:this.view.likes}))}))}showLove(t){if(t&&this.view.id===t.id){const e=this.view.showLove;this.view.likes=t.likes,this.view.showLove=!0,this.pushChanges(),e||setTimeout((()=>{this.view.showLove=!1,this.pushChanges()}),3100)}}tryInAr(){this.platform===Ui||this.platform===Vi?Zn.openInAR(this.view):an.open$({template:Zn.chunk(),data:this.view}).pipe(n.first()).subscribe((t=>{}))}checkSelfServiceProposition(){this.isSelfServiceProposition&&dn.check$().pipe(n.first()).subscribe((t=>{const e=new oe({pathId:ee.state.pathId}).toRoles(),i=new re({link:e.id,support:!0}),s=window.location.origin+i.toGuidedTourUrl();Ki.log("AgoraComponent.checkSelfServiceProposition",s),wi.selfServiceSupportRequest$(ee.state.user,e.id,s).pipe(n.first()).subscribe((t=>{const i=this.getName(ee.state.user);ee.patchState({checklist:!0,link:e.idSelfService,name:i}),this.agora=Zi.getSingleton(),this.connect()}))}),(t=>{Ki.error("AgoraComponent.checkSelfServiceProposition.error",t)}))}checkSelfServiceAudio(){if(ee.state.role===ie.SelfService&&x.selfServiceAudio){const e=document.createElement("audio");e.setAttribute("playsinline","true"),e.setAttribute("autoplay","true"),e.setAttribute("loop","true"),e.volume=.5,e.src=x.getPath(x.selfServiceAudio);const{node:i}=t.getContext(this);i.parentNode.appendChild(e),this.selfServiceAudio=e,Ts.events$.pipe(n.tap((t=>{t instanceof fs?e.pause():(t instanceof Es||t instanceof _s)&&e.play()})),n.takeUntil(this.unsubscribe$)).subscribe()}}openSupportRequestDialog(t){Xn.open$({message:ve.transform("bhere_support_request_dialog"),acceptMessage:ve.transform("bhere_support_request_dialog_accept"),rejectMessage:ve.transform("bhere_support_request_dialog_reject"),type:Wn,position:Kn}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{if(t instanceof Yn){ki.send({type:ni});const t=ee.state.name,e=new oe(ee.state.link);e.role=ie.Streamer;const i={link:e.toString()};if(x.flags.useExtendedUserInfo){const t=ee.state.user;i.firstName=t.firstName,i.lastName=t.lastName,i.email=t.email}else i.name=t;const n=new re(i).toGuidedTourUrl();setTimeout((()=>{window.location.href=n}),1e3)}else ki.send({type:si})}))}}Zr.meta={selector:"[agora-component]",hosts:{host:ae},template:`\n\t<div class="page page--agora">\n\t\t${g}\n\t\t\x3c!-- Status Checklist --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'checklist'" [agora-checklist] (checked)="onChecked($event)"></div>\n\t\t\x3c!-- Status Link --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'link'" [agora-link] (link)="onLink($event)"></div>\n\t\t\x3c!-- Status Login --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'login'" [agora-login] (login)="onLogin($event)"></div>\n\t\t\x3c!-- Status Name --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'name' || (state.status == 'disconnected' && state.role === 'viewer')" [agora-name] (name)="onName($event)"></div>\n\t\t\x3c!-- Status Device --\x3e\n\t\t<div class="ui ui--info" *if="state.status == 'device' || (state.status == 'disconnected' && state.role !== 'viewer')" [agora-device] (enter)="onEnter($event)"></div>\n\t\t${b}\n\t\t\n\x3c!-- Smart Device --\x3e\n<div class="ui remotes" [class]="uiClass" *if="state.status == 'connected' && state.role == 'smart-device'">\n\t<div class="ui__body"></div>\n\t\x3c!-- remote sidebar --\x3e\n\t<div class="group--remote" [class]="'group--remote--' + remotes.length" *if="state.live">\n\t\t<div class="agora-stream" (toggleSpy)="onToggleSpy($event)" agora-stream [stream]="remote" type="remote" *for="let remote of remotes">\n\t\t\t<div class="agora-stream__player"></div>\n\t\t\t<div class="agora-stream__info">\n\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t\x3c!-- remote screen --\x3e\n\t<div class="group--remote-screen" *if="remoteScreen && !hasScreenViewItem">\n\t\t<div class="agora-stream" agora-stream [stream]="remoteScreen" type="remote">\n\t\t\t<div class="agora-stream__player"></div>\n\t\t\t<div class="agora-stream__info">\n\t\t\t\t<div class="id" [innerHTML]="stream.clientInfo.name || streamId" *if="stream.clientInfo"></div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="group--header">\n\t\t\n\x3c!-- local streams --\x3e\n<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t<div class="agora-stream" agora-stream [stream]="local" type="local" *if="local">\n\t\t<div class="agora-stream__player"></div>\n\t\t<div class="agora-stream__info">\n\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t</div>\n\t</div>\n</div>\n\n\t</div>\n\t<div class="group--footer">\n\t\t\n\x3c!-- controls --\x3e\n<div class="group--controls" *if="state.live">\n\t<div class="group--actions">\n\t\t<button type="button" class="btn--call" [title]="'title_disconnect' | label" (click)="disconnect()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--cam" [title]="'title_mute_camera' | label" [class]="{ muted: state.cameraMuted, disabled: !local }" (click)="toggleCamera()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam"></use></svg>\n\t\t</button>\n\t\t<button type="button" class="btn--mic" [title]="'title_mute_mic' | label" [class]="{ muted: state.audioMuted, disabled: !local || silenced }" (click)="toggleAudio()">\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic"></use></svg>\n\t\t</button>\n\t</div>\n</div>\n\n\t</div>\n\t\n\x3c!-- members --\x3e\n<div class="group--members">\n\t<div class="members" *if="state.role === 'publisher'">\n\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t</div>\n\t<div class="credits">\n\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t</div>\n</div>\n\n</div>\n\n\t\t${T}\n\t\t${y}\n\t\t<header>\n\t\t\t${f}\n\t\t\t${S}\n\t\t</header>\n\t\t<footer *if="state.status != 'connected'">\n\t\t\t<span class="group--colophon">\n\t\t\t\t${E}\n\t\t\t\t${_}\n\t\t\t</span>\n\t\t\t<a [routerLink]="':lang.editor' | route" class="btn--absolute" *if="('editor' | flag) && !('deployed' | flag) && state.role == 'publisher' && (state.status == 'checklist' || state.status == 'link')">\n\t\t\t\t<span [innerHTML]="'bhere_editor' | label"></span> <svg class="edit" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#edit"></use></svg>\n\t\t\t</a>\n\t\t</footer>\n\t</div>\n\t`};class ta{static assetCreate$(t){return yi.post$("/api/asset",t).pipe(n.map((t=>hs(t))))}static assetUpdate$(t){return yi.put$(`/api/asset/${t.id}`,t).pipe(n.map((t=>hs(t))))}static assetDelete$(t){return t&&t.id?yi.delete$(`/api/asset/${t.id}`).pipe(n.map((()=>null))):i.of(null)}static localizedAssetCreate$(t,e){return yi.post$(`/api/${t}/asset`,e).pipe(n.map((t=>hs(t))))}static localizedAssetUpdate$(t,e){return yi.put$(`/api/${t}/asset/${e.id}`,e).pipe(n.map((t=>hs(t))))}static upload$(t){const e=new FormData;t.forEach((t=>e.append("file",t,t.name)));const s=new XMLHttpRequest,o=i.merge(i.fromEvent(s.upload,"loadstart"),i.fromEvent(s.upload,"progress"),i.fromEvent(s.upload,"load"),i.fromEvent(s,"readystatechange")).pipe(n.map((t=>"readystatechange"===t.type&&4===s.readyState?JSON.parse(s.responseText):null)),n.filter((t=>null!==t)));return s.open("POST","/api/upload/",!0),s.send(e),o}static createOrUpdateAsset$(t,e){const i=t[0],n=ds.fromUrl(i.url);return e.value&&e.value.id?(n.id=e.value.id,ta.assetUpdate$(n)):ta.assetCreate$(n)}static createOrUpdateLocalizedAsset$(t,e,i){const n=t[0],s=ds.fromUrl(n.url);return e.value&&e.value.id?(s.id=e.value.id,ta.localizedAssetUpdate$(i,s)):ta.localizedAssetCreate$(i,s)}static assetDidChange(t,e){let i=null,n=null,s=null,o=null;return t&&(i=t.id,n=t.file),e&&(s=e.id,o=e.file),i!==s||n!==o}}class ea{static data$(){return this.data$_||(this.data$_=yi.get$("/api/view").pipe(n.map((t=>(t.views=t.views.map((t=>In(t))),t))),n.shareReplay(1))),this.data$_}static viewIdOptions$(){return this.data$().pipe(n.map((t=>{const e=t.views.filter((t=>t.type.name!==gn.WaitingRoom.name)).map((t=>({id:t.id,name:t.name})));return e.unshift({id:null,name:"select"}),e})))}static viewCreate$(t){return yi.post$("/api/view",t).pipe(n.map((t=>In(t))))}static viewUpdate$(t){return yi.put$(`/api/view/${t.id}`,t.payload).pipe(n.map((t=>In(t))))}static viewDelete$(t){return yi.delete$(`/api/view/${t.id}`)}static getTile(t){let e;return t.type.name===gn.PanoramaGrid.name&&(e=t.tiles[t.index]),e}static inferItemCreate$(t,e){const i=this.getTile(t);return i?this.tileItemCreate$(t,i,e):this.itemCreate$(t,e)}static inferItemUpdate$(t,e){const i=this.getTile(t);return i?this.tileItemUpdate$(t,i,e):this.itemUpdate$(t,e)}static inferItemDelete$(t,e){const i=this.getTile(t);return i?this.tileItemDelete$(t,i,e):this.itemDelete$(t,e)}static inferItemUpdateResult$(t,e){const i=this.getTile(t);let n;n=i?i.navs.find((t=>t.id===e.id)):t.items.find((t=>t.id===e.id)),n&&Object.assign(n,e)}static inferItemDeleteResult$(t,e){const i=this.getTile(t);let n;if(n=i?i.navs:t.items,n){const s=n.indexOf(e);-1!==s&&n.splice(s,1),i&&t.updateCurrentItems()}}static itemCreate$(t,e){return yi.post$(`/api/view/${t.id}/item`,e).pipe(n.map((t=>An(t))))}static itemUpdate$(t,e){return yi.put$(`/api/view/${t.id}/item/${e.id}`,e.payload).pipe(n.map((t=>An(t))))}static itemDelete$(t,e){return yi.delete$(`/api/view/${t.id}/item/${e.id}`)}static tileItemCreate$(t,e,i){return yi.post$(`/api/view/${t.id}/tile/${e.id}/item`,i).pipe(n.map((t=>An(t))))}static tileItemUpdate$(t,e,i){return yi.put$(`/api/view/${t.id}/tile/${e.id}/item/${i.id}`,i.payload).pipe(n.map((t=>An(t))))}static tileItemDelete$(t,e,i){return yi.delete$(`/api/view/${t.id}/tile/${e.id}/item/${i.id}`)}}class ia extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Qn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(20),t.position.copy(i),t.lookAt(ws.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object,i=this.form=new e.FormGroup({type:fn.CurvedPlane,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl(t.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([1,1,1],e.RequiredValidator()),radius:new e.FormControl(35,e.RequiredValidator()),height:new e.FormControl(20,e.RequiredValidator()),arc:new e.FormControl(90,e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){const t=Object.assign({},this.form.value);ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>console.log("CurvedPlaneModalComponent.onSubmit.error",t)))}else this.form.touched=!0}onClose(){an.reject()}}ia.meta={selector:"[curved-plane-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Curved Plane.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t\x3c!-- <div control-text [control]="controls.title" label="Title"></div> --\x3e\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t\x3c!--\n\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-number [control]="controls.radius" label="Radius" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-number [control]="controls.height" label="Height" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-number [control]="controls.arc" label="Arc" [precision]="0" [disabled]="true"></div>\n\t\t\t\t\t\t--\x3e\n\t\t\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ia.chunk=()=>'<div class="curved-plane-modal" curved-plane-modal></div>';class na extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Qn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(4),t.position.copy(i),t.lookAt(ws.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object,i=this.form=new e.FormGroup({type:fn.Model,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl([0,0,0],e.RequiredValidator()),scale:new e.FormControl([1,1,1],e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){const t=Object.assign({},this.form.value);ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>console.log("ItemModelModalComponent.onSubmit.error",t)))}else this.form.touched=!0}onClose(){an.reject()}}na.meta={selector:"[item-model-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Model Item.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},na.chunk=()=>'<div class="item-model-modal" item-model-modal></div>';class sa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:gn.Media,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.switchMap((e=>{const i={type:fn.Plane,position:[20,0,0],rotation:[0,-Math.PI/2,0],scale:[12,6.75,1],asset:t.asset};return ea.itemCreate$(e,i).pipe(n.map((t=>(e.items=[t],e))))})),n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("MediaModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}sa.meta={selector:"[media-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Media.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},sa.chunk=()=>'<div class="media-modal" media-modal></div>';class oa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:gn.Model,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator()),model:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.switchMap((e=>{const i={type:fn.Model,asset:t.model};return ea.itemCreate$(e,i).pipe(n.map((t=>(e.items=[t],e))))})),n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("ModelModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}oa.meta={selector:"[model-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Model View.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t\t\t<div control-model [control]="controls.model" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},oa.chunk=()=>'<div class="model-modal" model-modal></div>';class ra extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Qn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get position(){let t=null;const e=this.data;return e&&(t=e.hit.position),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(Qr.RADIUS),t.position.copy(i),t.lookAt(ws.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object;this.error=null,this.useHooks=Ii.enabled;const i=this.form=new e.FormGroup({type:fn.Nav,title:null,abstract:null,viewId:null,hook:null,hookExtra:null,keepOrientation:!1,important:!1,transparent:!1,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl(t.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([20,5,1],e.RequiredValidator()),asset:null,link:new e.FormGroup({title:new e.FormControl(null),href:new e.FormControl(null),target:"_blank"})});if(this.controls=i.controls,Ii.enabled){const t=x.webhook.methods.nav.map((t=>({id:t,name:t})));t.unshift({id:null,name:"select"}),this.controls.hook.options=t}i.changes$.subscribe((t=>{this.pushChanges()})),ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{this.controls.viewId.options=t,this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=Object.assign({},this.form.value);t.viewId=t.viewId?parseInt(t.viewId):this.view.id,!t.link||t.link.title&&t.link.href||(t.link=null),ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("NavModalComponent.onSubmit.error",t),this.error=t,this.form.submitted=!1}))}else this.form.touched=!0}onViewIdDidChange(t){if(null!=t&&x.flags.navAutoUpdateTitle){const e=this.controls.viewId.options,i=e.find((e=>e.id===t));if(null!=i){const t=i.name,n=this.form.value.title;n&&!e.find((t=>t.name===n))||this.form.patch({title:t})}}}onClose(){an.reject()}}ra.meta={selector:"[nav-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Nav.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.title" label="Title"></div>\n\t\t\t\t\t\t<div control-textarea [control]="controls.abstract" label="Abstract"></div>\n\t\t\t\t\t\t<div control-custom-select [control]="controls.viewId" label="NavToView" (change)="onViewIdDidChange($event)"></div>\n\t\t\t\t\t\t<div control-checkbox [control]="controls.keepOrientation" label="Keep Orientation"></div>\n\t\t\t\t\t\t<div control-checkbox [control]="controls.important" label="Important"></div>\n\t\t\t\t\t\t<div control-checkbox [control]="controls.transparent" label="Transparent"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="3" [disabled]="true"></div>\n\t\t\t\t\t\t<div *if="controls.transparent.value == true">\n\t\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/png, image/jpeg"></div>\n\t\t\t\t\t\t<div control-text [control]="controls.link.controls.title" label="Link Title"></div>\n\t\t\t\t\t\t<div control-text [control]="controls.link.controls.href" label="Link Url"></div>\n\t\t\t\t\t\t<div control-custom-select [control]="controls.hook" label="Hook" *if="useHooks"></div>\n\t\t\t\t\t\t<div control-text [control]="controls.hookExtra" label="Hook Extra" *if="useHooks"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ra.chunk=()=>'<div class="nav-modal" nav-modal></div>';class aa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:gn.PanoramaGrid,name:new e.FormControl(null,e.RequiredValidator()),assets:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value.assets,e=Sn.mapTiles(t.map((t=>({asset:t,navs:[]}))),!1,!0);e.sort(((t,e)=>1e4*t.indices.x+t.indices.y-(1e4*e.indices.x+e.indices.y)));const i=e[0].asset,s={type:this.form.value.type,name:this.form.value.name,asset:i,tiles:e,invertAxes:!0,flipAxes:!1,orientation:{latitude:0,longitude:0},zoom:75};ea.viewCreate$(s).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PanoramaGridModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}else this.form.touched=!0}onClose(){an.reject()}}aa.meta={selector:"[panorama-grid-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Panorama Grid.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-assets [control]="controls.assets" label="Image" accept="image/jpeg"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},aa.chunk=()=>'<div class="panorama-grid-modal" panorama-grid-modal></div>';class ca extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:gn.Panorama,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PanoramaModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}ca.meta={selector:"[panorama-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Panorama.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t\x3c!--\n\t\t\t\t\t<div class="group--form group--form--fixed">\n\t\t\t\t\t\t<code [innerHTML]="form.value | json"></code>\n\t\t\t\t\t\t<button type="button" class="btn--test" (click)="test()"><span>test</span></button>\n\t\t\t\t\t</div>\n\t\t\t\t\t--\x3e\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ca.chunk=()=>'<div class="panorama-modal" panorama-modal></div>';class la extends t.Component{onInit(){const{parentInstance:i}=t.getContext(this);i instanceof Qn&&(this.data=i.modal.data),this.error=null;const n=this.form=new e.FormGroup({name:new e.FormControl(null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t={name:this.form.value.name,items:this.data?this.data.item.items:[]};return Dn.pathCreate$(t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PathAddModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}la.meta={selector:"[path-add-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Add Path.</div>\n\t\t\t\t<div class="description">Aggiungi un percorso</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},la.chunk=()=>'<div class="panorama-modal" path-add-modal></div>';class da extends t.Component{onInit(){this.item=null,this.views=null;const{parentInstance:i}=t.getContext(this);if(i instanceof Qn){const t=i.modal.data;t&&(this.item=t.item?t.item:null,this.views=this.parseViews(t.views,this.item))}this.error=null;const n=this.form=new e.FormGroup({name:new e.FormControl(this.item?this.item.name:null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((t=>{this.pushChanges()}))}parseViews(t,e){return t&&e?t.map((t=>({id:t.id,name:t.name,type:t.type,active:-1===e.items.indexOf(t.id)}))):[]}onToggleView(t){t.active=!t.active,this.pushChanges()}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={id:this.item.id,name:t.name,items:this.views.filter((t=>!t.active)).map((t=>t.id))};return Dn.pathUpdate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("PathEditModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onSelectAll(){this.views.forEach((t=>t.active=!0)),this.pushChanges()}onSelectNone(){this.views.forEach((t=>t.active=!1)),this.pushChanges()}onClose(){an.reject()}}da.meta={selector:"[path-edit-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Edit Path <span *if="item">&ldquo;<span [innerHTML]="item.title || item.name"></span>&rdquo;</span>.</div>\n\t\t\t\t<div class="description">Modifica il percorso</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ul class="nav--flag" *if="views">\n\t\t\t\t\t\t<li class="nav__item" *for="let view of views">\n\t\t\t\t\t\t\t<button type="button" class="btn--flag" [class]="{ active: view.active }" [title]="view.name" (click)="onToggleView(view)">\n\t\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t\t<svg-icon [name]="view.type.name"></svg-icon>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<span class="name" [innerHTML]="view.name"></span>\n\t\t\t\t\t\t\t\t<span class="flag">\n\t\t\t\t\t\t\t\t\t<svg class="check" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#check"></use></svg>\n\t\t\t\t\t\t\t\t\t<svg class="close" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<div class="group--options">\n\t\t\t\t\t\t\t<button type="button" class="btn--link" (click)="onSelectAll()">\n\t\t\t\t\t\t\t\t<span>Select all</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button type="button" class="btn--link" (click)="onSelectNone()">\n\t\t\t\t\t\t\t\t<span>Select none</span>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Save</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},da.chunk=()=>'<div class="path-edit-modal" path-edit-modal></div>';class ha extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Qn&&(e=i.modal.data),e}get view(){let t=null;const e=this.data;return e&&(t=e.view),t}get object(){const t=new THREE.Object3D,e=this.data;if(e){const i=e.hit.position.clone(),n=e.hit.normal.clone();e.hit.spherical?(i.normalize().multiplyScalar(20),t.position.copy(i),t.lookAt(ws.origin)):(t.lookAt(n),t.position.set(i.x,i.y,i.z),t.position.add(n.multiplyScalar(.01)))}return t}onInit(){const t=this.object,i=this.form=new e.FormGroup({type:fn.Plane,position:new e.FormControl(t.position.toArray(),e.RequiredValidator()),rotation:new e.FormControl(t.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([12,6.75,1],e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){const t=Object.assign({},this.form.value);ea.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>console.log("PlaneModalComponent.onSubmit.error",t)))}else this.form.touched=!0}onClose(){an.reject()}}ha.meta={selector:"[plane-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Plane.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t\x3c!-- <div control-text [control]="controls.title" label="Title"></div> --\x3e\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div>\n\t\t\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ha.chunk=()=>'<div class="plane-modal" plane-modal></div>';class ua extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Qn&&(e=i.modal.data),e}get item(){let t=null;const e=this.data;return e&&(t=e.item),t}onRemove(){an.resolve()}onCancel(){an.reject()}onClose(){an.reject()}}ua.meta={selector:"[remove-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Remove <span *if="item">&ldquo;<span [innerHTML]="item.title || item.name"></span>&rdquo;</span>.</div>\n\t\t\t\t<div class="abstract">are you sure?</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t\t<span>Remove</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onCancel($event)">\n\t\t\t\t\t\t<span>Cancel</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},ua.chunk=()=>'<div class="remove-modal" remove-modal></div>';class pa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({type:gn.Room3d,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={type:t.type,name:t.name,asset:t.asset,orientation:{latitude:0,longitude:0},zoom:75};return ea.viewCreate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("Room3DModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}pa.meta={selector:"[room-3d-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Room 3D View.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t\x3c!--\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t\t\t<div control-model [control]="controls.model" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t\t--\x3e\n\t\t\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},pa.chunk=()=>'<div class="room-3d-modal" room-3d-modal></div>';const ma={menu:[{id:"menu",title:"editor_menu",active:!0},{id:"navmaps",title:"editor_navmaps",active:!0}],current:null,active:!1};class va extends t.Component{get dataViews(){return ps.dataViews}get pathViews(){return ps.pathViews}onInit(){const{node:e}=t.getContext(this);e.classList.remove("hidden"),this.settings=this.getSettings(),this.aside=!1,this.state={},this.view=null,this.paths=null,this.path=null,this.form=null,this.local=null,this.remotes=[],this.viewHit=new i.Subject;(this.vrService=Ro.getService()).status$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.pushChanges())),this.resolveUser()}resolveUser(){wi.me$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t&&t.type===ie.Publisher?(this.user=t,this.initState()):te.setRouterLink(Ee.transform(":lang.access"))}))}initState(){const t=this.user,e={user:t,role:t.type,name:t.firstName&&t.lastName?`${t.firstName} ${t.lastName}`:null,mode:li,link:null,channelName:x.channelName,uid:null,status:Oe,connecting:!1,connected:!0,controlling:!1,spying:!1,silencing:!1,hosted:!0,live:!1,navigable:!0,cameraMuted:!1,audioMuted:!1,showNavInfo:!0};ee.state=e,ee.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.state=t,this.hosted=t.hosted,this.pushChanges()})),this.viewObserver$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{})),Qi.mode=Xi}viewObserver$(){return ea.data$().pipe(n.switchMap((t=>{const e=(new re).pathId;return Dn.getCurrentPath$(e).pipe(n.switchMap((e=>(this.paths=Dn.paths,this.path=e,ps.editorView$(t,e)))))})),n.tap((t=>{this.view=null,this.pushChanges()})),n.delay(1),n.tap((t=>{this.view=t,this.pushChanges()})))}onAddPath(){an.open$({template:la.chunk()}).pipe(n.first()).subscribe((t=>{t instanceof on&&Dn.addPath(t.data)}))}onEditPath(t){an.open$({template:da.chunk(),data:{item:t,views:ps.validViews}}).pipe(n.first()).subscribe((t=>{t instanceof on&&Dn.editPath(t.data)}))}onDuplicatePath(t){an.open$({template:la.chunk(),data:{item:t}}).pipe(n.first()).subscribe((t=>{t instanceof on&&Dn.addPath(t.data)}))}onDeletePath(t){an.open$({template:ua.chunk(),data:{item:t}}).pipe(n.first()).subscribe((e=>{e instanceof on&&Dn.pathDelete$(t).pipe(n.first()).subscribe((e=>{Dn.deletePath(t)}))}))}onSelectPath(t){Dn.path=t}isPathSelected(t){return Dn.path.id===t.id}onNavTo(t){const e=t.viewId;ps.pathViews.find((t=>t.id===e))&&(ps.action={viewId:e,keepOrientation:t.keepOrientation,useLastOrientation:t.useLastOrientation})}onNavLink(t){an.open$({iframe:t.link.href}).pipe(n.first()).subscribe((e=>{ki.send({type:He,itemId:t.item.id})}))}patchState(t){this.state=Object.assign({},this.state,t),this.pushChanges()}tryInAr(){an.open$({template:Zn.chunk(),data:this.view}).pipe(n.first()).subscribe((t=>{}))}onToggleAside(){this.aside=!this.aside,this.pushChanges(),window.dispatchEvent(new Event("resize"))}getSettings(){const t=Object.assign({},ma);return t.menu=t.menu.filter((t=>x.flags[t.id])),t.current=t.menu.length?t.menu[0].id:null,t}onToggleSettings(){const t=this.settings;t.active=!t.active,this.pushChanges()}onSelectSetting(t){this.settings.current=t.id,this.pushChanges()}onViewHit(t){this.viewHit.next(t)}onViewHitted(t){this.viewHitSubscription&&(this.viewHitSubscription.unsubscribe(),this.viewHitSubscription=null),"function"==typeof t&&(this.viewHitSubscription=this.viewHit.pipe(n.first()).subscribe((e=>t(e))))}onDragEnd(t){ea.inferItemUpdate$(this.view,t.item).pipe(n.first()).subscribe((t=>{this.pushChanges()}),(e=>console.log("EditorComponent.onDragEnd.inferItemUpdate$.error",e,this.view,t.item,t.item.payload)))}onResizeEnd(t){}onWorldSelect(t){if(this.view){let e;this.view.items.forEach((t=>t.showPanel=!1)),this.view.items.forEach((i=>{i.selected=i===t.item,e=i.selected?i:e})),this.view.selected=!e,this.pushChanges(),e&&(this.aside=!0,this.pushChanges(),window.dispatchEvent(new Event("resize")))}}onOpenModal(t,e){let i=null;switch(t.type){case"view":switch(t.value){case gn.Panorama.name:i=ca.chunk();break;case gn.PanoramaGrid.name:i=aa.chunk();break;case gn.Model.name:i=oa.chunk();break;case gn.Room3d.name:i=pa.chunk();break;case gn.Media.name:i=sa.chunk()}break;case"viewItem":switch(t.value){case fn.Nav.name:i=ra.chunk();break;case fn.Plane.name:i=ha.chunk();break;case fn.CurvedPlane.name:i=ia.chunk();break;case fn.Model.name:i=na.chunk()}}i&&an.open$({template:i,data:e}).pipe(n.first()).subscribe((e=>{if(e instanceof on)switch(t.type){case"view":switch(t.value){case gn.Panorama.name:case gn.PanoramaGrid.name:case gn.Model.name:case gn.Room3d.name:case gn.Media.name:ps.addView(e.data)}break;case"viewItem":switch(t.value){case fn.Nav.name:case fn.Plane.name:case fn.CurvedPlane.name:case fn.Model.name:{const t=e.data,i=ea.getTile(this.view);if(i){const e=i.navs||[];e.push(t),i.navs=e,this.view.updateCurrentItems()}else{t.path=!0;const e=this.view.items||[];e.push(t),this.view.items=e}this.pushChanges();break}}}this.pushChanges()}))}onAsideSelect(t){if(t.value)switch(t.value){case fn.Nav.name:case fn.Plane.name:case fn.CurvedPlane.name:this.onViewHitted((e=>{this.onOpenModal(t,{view:this.view,hit:e})})),Xn.open$({message:"Click a point on the view"});break;case fn.Model.name:if("viewItem"===t.type){if(this.view.type.name===gn.Model.name)return;this.onViewHitted((e=>{this.onOpenModal(t,{view:this.view,hit:e})})),Xn.open$({message:"Click a point on the view"})}else this.onOpenModal(t,{view:this.view});break;default:this.onOpenModal(t,{view:this.view})}else if(t.view&&(t.item||null===t.item))t.view.selected=!1,t.view.items.forEach((e=>e.selected=e===t.item)),ki.send({type:Qe}),this.pushChanges();else if(t.view&&(t.tile||null===t.tile))t.view.selected=!1,t.view.tiles.forEach((e=>e.selected=e===t.tile)),ki.send({type:Qe}),this.pushChanges();else if(t.view||null===t.view){this.view.selected=this.view===t.view,this.view.items.forEach((t=>t.selected=!1));const e=ea.getTile(this.view);e&&this.view.tiles.forEach((t=>t.selected=t===e)),ki.send({type:Qe}),this.pushChanges()}}onAsideUpdate(t){if(t.item&&t.view)this.pushChanges();else if(t.tile&&t.view);else if(t.view)if(ps.viewId!==t.view.id)ps.viewId=t.view.id;else{const e=ta.assetDidChange(this.view.asset,t.view.asset);Object.assign(this.view,t.view),e&&"function"==typeof this.view.onUpdateAsset&&this.view.onUpdateAsset(),this.pushChanges()}}onAsideDelete(t){t.item&&t.view?ea.inferItemDelete$(t.view,t.item).pipe(n.first()).subscribe((e=>{ea.inferItemDeleteResult$(t.view,t.item),this.pushChanges()}),(t=>console.log("EditorComponent.onAsideDelete.inferItemDelete$.error",t))):t.view&&ea.viewDelete$(t.view).pipe(n.first()).subscribe((e=>{ps.deleteView(t.view)}),(t=>console.log("EditorComponent.onAsideDelete.viewDelete$.error",t)))}}va.meta={selector:"[editor-component]",hosts:{host:ae},template:'\n\t<div class="page page--editor">\n\t\t<div class="ui" [class]="{ open: aside }" *if="dataViews.length">\n\t\t\t<div class="ui__navbar">\n\t\t\t\t<div class="btn--settings" [class]="{ active: settings.active }" (click)="onToggleSettings($event)" *if="settings.menu.length > 0">\n\t\t\t\t\t<svg class="settings" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#settings-full"></use></svg>\n\t\t\t\t</div>\n\t\t\t\t<div class="headline" *if="view">\n\t\t\t\t\t<div class="headline__id" [innerHTML]="view.id"></div>\n\t\t\t\t\t<div class="headline__icon">\n\t\t\t\t\t\t<svg-icon [name]="view.type.name"></svg-icon>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="headline__name" [innerHTML]="view.name"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="group--path" *if="(\'usePaths\' | flag) && path">\n\t\t\t\t\t<div class="group--path__select">\n\t\t\t\t\t\t<div class="group--form--select" [dropdown]="\'path\'">\n\t\t\t\t\t\t\t<label>Percorso</label>\n\t\t\t\t\t\t\t<span class="control--custom-select" [innerHTML]="path.name"></span>\n\t\t\t\t\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="dropdown dropdown-item" [dropdown-item]="\'path\'">\n\t\t\t\t\t\t\t<div class="category">Percorso</div>\n\t\t\t\t\t\t\t<ul class="nav--dropdown">\n\t\t\t\t\t\t\t\t<li [class]="{ active: isPathSelected(item) }" *for="let item of paths">\n\t\t\t\t\t\t\t\t\t<span [innerHTML]="item.name" (click)="onSelectPath(item)"></span>\n\t\t\t\t\t\t\t\t\t<div class="check">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#check"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="btn--flags" (click)="onEditPath(item)" title="Edit" *if="item.id">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#flags"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="btn--duplicate" (click)="onDuplicatePath(item)" title="Duplicate" *if="item.id">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#duplicate"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="btn--trash" (click)="onDeletePath(item)" title="Delete" *if="item.id">\n\t\t\t\t\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#trash"></use></svg>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t<div class="btn--mode" (click)="onAddPath()">Aggiungi un percorso</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="btn--edit" [class]="{ active: aside }" (click)="onToggleAside($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#edit"></use></svg>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world" world [view]="view" [views]="pathViews" [editor]="true" (navTo)="onNavTo($event)" (viewHit)="onViewHit($event)" (dragEnd)="onDragEnd($event)" (select)="onWorldSelect($event)"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- footer --\x3e\n\t\t\t<div class="group--footer">\n\t\t\t\t<div class="group--ar-vr">\n\t\t\t\t\t<button type="button" class="btn--ar" [href]="view?.ar" (click)="tryInAr()" *if="view?.ar">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#ar"></use></svg> <span>Try in AR</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--vr" [class]="{ disabled: vrService.isDisabled() }" (click)="vrService.toggleVR()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#vr"></use></svg> <span [innerHTML]="vrService.getLabel()"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui__settings" *if="settings.active">\n\t\t\t\t\x3c!-- settings navs --\x3e\n\t\t\t\t<div class="group--nav">\n\t\t\t\t\t<ul class="nav--menu">\n\t\t\t\t\t\t<li class="nav__item" *for="let item of settings.menu" [class]="{ active: settings.current === item.id }" (click)="onSelectSetting(item)"><span class="title" [innerHTML]="item.title | label"></span></li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- menu --\x3e\n\t\t\t\t<div class="group--content" menu-builder [views]="dataViews" *if="settings.current === \'menu\'"></div>\n\t\t\t\t\x3c!-- navmaps --\x3e\n\t\t\t\t<div class="group--content" navmap-builder [views]="dataViews" *if="settings.current === \'navmaps\'"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="aside" [class]="{ active: aside }" aside [view]="view" (select)="onAsideSelect($event)" (update)="onAsideUpdate($event)" (delete)="onAsideDelete($event)" *if="view && aside"></div>\n\t</div>\n\t'};class ga{static currentLanguagePage$(t){return fe.lang$.pipe(n.switchMap((e=>this.page$(e,t))))}static page$(t,e){const i=x.flags.production?`/api/${t}/pages/${e}/`:`./api/${t}/pages/${e}.json`;return yi.get$(i)}}class fa extends t.Component{onInit(){this.route=this.host?this.host.route:null,this.state={status:"generic"},this.page=null,ga.currentLanguagePage$(this.route.params.mode).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.page=t,this.pushChanges()}))}}fa.meta={selector:"[generic-component]",hosts:{host:ae},template:`\n\t\t<div class="page page--generic">\n\t\t\t\x3c!-- generic --\x3e\n\t\t\t<div class="ui ui--generic" *if="page">\n\t\t\t\t<div class="group--generic">\n\t\t\t\t\t<div class="group--generic__content stagger--childs">\n\t\t\t\t\t\t<h1 class="title" [innerHTML]="page.title"></h1>\n\t\t\t\t\t\t<div class="description" [innerHTML]="page.description"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<header>\n\t\t\t\t${f}\n\t\t\t\t${S}\n\t\t\t</header>\n\t\t\t<footer>\n\t\t\t\t<span class="group--colophon" *if="state.status != 'connected'">\n\t\t\t\t\t${E}\n\t\t\t\t\t${_}\n\t\t\t\t</span>\n\t\t\t</footer>\n\t\t</div>\n\t`};class Ea extends t.Component{get meetingUrl(){return this.meetingUrl_||(this.meetingUrl_=new re),this.meetingUrl_}get isVirtualTourUser(){return-1!==[ie.Publisher,ie.Attendee,ie.Streamer,ie.Viewer].indexOf(this.state.role)}get isEmbed(){return this.route&&"embed"===this.route.params.mode}get isSelfServiceTour(){return this.route&&"selfServiceTour"===this.route.params.mode}get isNavigable(){return null==this.meetingUrl.embedViewId}get isBackButtonVisible(){return this.view&&(this.view.type.name===gn.Media.name||this.view.type.name===gn.Model.name)}get showNavInfoToggler(){return x.flags.hideNavInfo&&this.state.mode!==di}get uiClass(){const t={};return t[this.state.role]=!0,t.chat=this.state.chat,t.remotes=this.state.mode===di,t.remoteScreen=null!=this.remoteScreen&&!this.hasScreenViewItem,t.media=!t.remotes&&this.media,t.locked=this.locked,t}get remoteClass(){return`group--remote--${Math.min(9,this.remotes.length)}`}get controlled(){return this.state.controlling&&this.state.controlling!==this.state.uid}get controlling(){return this.state.controlling&&this.state.controlling===this.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return this.state.spying&&this.state.spying===this.state.uid}get spying(){return this.state.spying&&this.state.spying!==this.state.uid}get locked(){return this.controlled||this.spying}get remoteScreen(){return this.remoteScreen_}set remoteScreen(t){this.remoteScreen_!==t&&(this.remoteScreen_=t,window.dispatchEvent(new Event("resize")))}onInit(){const t=this.meetingUrl.embedViewId;this.state={status:ge.get("status")||Oe,role:ge.get("role")||ie.Publisher,membersCount:3,controlling:!1,spying:!1,silencing:!1,hosted:!0,chat:!1,chatDirty:!0,name:"Jhon Appleseed",uid:"7341614597544882",showNavInfo:!0},this.state.live=this.state.role!==ie.SelfService&&this.state.role!==ie.Embed&&!R,this.state.navigable=null==t,this.state.mode=wi.getMode(this.state.role),this.view={likes:41,type:{id:2,name:"panorama"}},this.local={},this.screen=null,this.remoteScreen_=null,this.media=null,this.hasScreenViewItem=!1,this.media=!0,this.remotes=new Array(8).fill(0).map(((t,e)=>({id:e+1}))),this.languageService=fe,this.showLanguages=!1,ee.patchState(this.state),this.fullscreen$().pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.vrService=Ro.getService(),console.log("LayoutComponent",this),setTimeout((()=>{const t=Wn;switch(t){case Gn:Xn.open$({message:ve.transform("bhere_support_request_sent")}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof Yn&&console.log("ToastResolveEvent",t)}));break;case $n:Xn.open$({message:ve.transform("bhere_support_request_sent"),type:t,position:Kn}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof Yn?console.log("ToastResolveEvent",t):t instanceof Jn&&console.log("ToastRejectEvent",t)}));break;case Wn:Xn.open$({message:ve.transform("bhere_support_request_dialog"),acceptMessage:ve.transform("bhere_support_request_dialog_accept"),rejectMessage:ve.transform("bhere_support_request_dialog_reject"),type:t,position:Kn}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof Yn?console.log("ToastResolveEvent",t):t instanceof Jn&&console.log("ToastRejectEvent",t)}))}}),3e3)}setLanguage(t){this.languageService.setLanguage$(t).pipe(n.first()).subscribe((t=>{this.showLanguages=!1,this.pushChanges()}))}toggleLanguages(){this.showLanguages=!this.showLanguages,this.pushChanges()}patchState(t){this.state=Object.assign({},this.state,t),this.screen=this.state.screen||null,this.remoteScreen=this.screen,this.pushChanges()}toggleCamera(){this.patchState({cameraMuted:!this.state.cameraMuted})}toggleAudio(){this.patchState({audioMuted:!this.state.audioMuted})}toggleScreen(){this.patchState({screen:!this.state.screen}),window.dispatchEvent(new Event("resize"))}toggleVolume(){this.patchState({volumeMuted:!this.state.volumeMuted})}toggleMode(){const t=this.state.mode===li?di:li;this.patchState({mode:t})}toggleFullScreen(){const{node:e}=t.getContext(this);!this.state.fullScreen?e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}fullscreen$(){return i.fromEvent(document,"fullscreenchange").pipe(n.tap((t=>{const e=null!=document.fullscreenElement;this.patchState({fullScreen:e})})))}toggleChat(){this.patchState({chat:!this.state.chat,chatDirty:!1}),window.dispatchEvent(new Event("resize"))}toggleNavInfo(){this.patchState({showNavInfo:!this.state.showNavInfo})}onBack(){console.log("LayoutComponent.onBack")}onChatClose(){this.patchState({chat:!1}),window.dispatchEvent(new Event("resize"))}onToggleControl(t){const e=this.state.controlling===t?null:t;this.patchState({controlling:e,spying:!1})}onToggleSilence(){this.patchState({silencing:!this.state.silencing})}onToggleSpy(t){const e=this.state.spying===t?null:t;this.patchState({spying:e,controlling:!1})}addLike(){this.view.liked=!0,this.showLove(this.view)}showLove(t){if(t&&this.view.id===t.id){const e=this.view.showLove;this.view.likes=t.likes,this.view.showLove=!0,this.pushChanges(),e||setTimeout((()=>{this.view.showLove=!1,this.pushChanges()}),3100)}}disconnect(){}}Ea.meta={selector:"[layout-component]",hosts:{host:ae},template:`\n\t<div class="page page--agora">\n\t\t${g}\n\t\t\x3c!-- Status Checklist --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'checklist'" [agora-checklist] (checked)="onChecked($event)"></div>\n\t\t\x3c!-- Status Link --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'link'" [agora-link] (link)="onLink($event)"></div>\n\t\t\x3c!-- Status Login --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'login'" [agora-login] (login)="onLogin($event)"></div>\n\t\t\x3c!-- Status Name --\x3e\n\t\t<div class="ui ui--info ui--info-centered" *if="state.status == 'name' || (state.status == 'disconnected' && state.role === 'viewer')" [agora-name] (name)="onName($event)"></div>\n\t\t\x3c!-- Status Device --\x3e\n\t\t<div class="ui ui--info" *if="state.status == 'device' || (state.status == 'disconnected' && state.role !== 'viewer')" [agora-device] (enter)="onEnter($event)"></div>\n\t\t\x3c!-- Virtual Tour --\x3e\n\t\t<div class="ui virtual-tour" [class]="uiClass" *if="state.status == 'connected' && isVirtualTourUser">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- remote sidebar --\x3e\n\t\t\t<div class="group--remote" [class]="remoteClass" *if="state.live">\n\t\t\t\t<div class="agora-stream" *for="let remote of remotes">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info" [class]="{ spyed: state.spying == remote.streamId, controlling: state.controlling == remote.streamId }">\n\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t\t<button type="button" class="btn--control" [title]="'title_control' | label" (click)="onToggleControl(remote.streamId)" *if="state.role === 'publisher'">\n\t\t\t\t\t\t\t<svg class="control" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button type="button" class="btn--spy" [title]="'title_spy' | label" (click)="onToggleSpy(remote.streamId)" *if="state.role === 'publisher'">\n\t\t\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#spy"></use></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="group--members" *if="state.mode == 'virtual-tour'">\n\t\t\t\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="credits">\n\t\t\t\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- remote screen --\x3e\n\t\t\t<div class="group--remote-screen" *if="remoteScreen">\n\t\t\t\t<div class="agora-stream">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--header">\n\t\t\t\t\x3c!-- service --\x3e\n\t\t\t\t<div class="group--service">\n\t\t\t\t\t<button type="button" class="btn--back" [title]="'title_back' | label" (click)="onBack($event)" *if="isBackButtonVisible">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#arrow-prev"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--view-mode" [title]="'title_view_mode' | label" (click)="toggleMode($event)" *if="state.mode != 'embed'">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == 'virtual-tour'"><use xlink:href="#live-meeting"></use></svg>\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.mode == 'live-meeting'"><use xlink:href="#virtual-tour"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--volume" [title]="'title_volume' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--fullscreen" [title]="'title_fullscreen' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--navmap" [title]="'title_navmap' | label" [class]="{ active: state.showNavmap }" (click)="toggleNavmap($event)" *if="navmap && state.mode != 'live-meeting'">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navmap"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- local streams --\x3e\n\t\t\t\t<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t\t\t\t\t<button type="button" class="btn--silence" [title]="'title_silence' | label" [class]="{ active: state.silencing }" (click)="onToggleSilence()" *if="state.role === 'publisher'">\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--control" [title]="'title_control' | label" [class]="{ active: state.controlling == state.uid }" (click)="onToggleControl(state.uid)" *if="state.role == 'publisher'">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#control"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<div class="agora-stream" *if="!local"></div>\n\t\t\t\t\t<div class="agora-stream" *if="local">\n\t\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="agora-stream agora-stream--screen" *if="screen">\n\t\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--footer">\n\t\t\t\t${l}\n\t\t\t\t${d}\n\t\t\t\t${h}\n\t\t\t\t${u}\n\t\t\t</div>\n\t\t\t\x3c!-- members --\x3e\n\t\t\t<div class="group--members" *if="state.mode == 'live-meeting'">\n\t\t\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="credits">\n\t\t\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t${p}\n\t\t\t${m}\n\t\t\t${v}\n\t\t</div>\n\t\t\x3c!-- Smart Device --\x3e\n\t\t<div class="ui remotes" [class]="uiClass" *if="state.status == 'connected' && state.role == 'smart-device'">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t</div>\n\t\t\t\x3c!-- remote sidebar --\x3e\n\t\t\t<div class="group--remote" [class]="remoteClass" *if="state.live">\n\t\t\t\t<div class="agora-stream" *for="let remote of remotes">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t\t<button type="button" class="btn--spy" [title]="'title_spy' | label" *if="state.role === 'publisher'" (click)="onToggleSpy(remote.streamId)">\n\t\t\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#spy"></use></svg>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- remote screen --\x3e\n\t\t\t<div class="group--remote-screen" *if="remoteScreen">\n\t\t\t\t<div class="agora-stream">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<div class="id">name</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- local streams --\x3e\n\t\t\t<div class="group--local" [class]="{ publisher: state.role == 'publisher', viewer: state.role == 'viewer' }" *if="state.live">\n\t\t\t\t<div class="agora-stream" *if="local">\n\t\t\t\t\t<div class="agora-stream__player"></div>\n\t\t\t\t\t<div class="agora-stream__info">\n\t\t\t\t\t\t<svg class="cam-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam-muted"></use></svg>\n\t\t\t\t\t\t<svg class="mic-muted" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic-muted"></use></svg>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- controls --\x3e\n\t\t\t<div class="group--controls" *if="state.live">\n\t\t\t\t<div class="group--actions">\n\t\t\t\t\t<button type="button" class="btn--call" [title]="'title_disconnect' | label" (click)="disconnect()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#call"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--cam" [title]="'title_mute_camera' | label" [class]="{ muted: state.cameraMuted, disabled: !local }" (click)="toggleCamera()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#cam"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--mic" [title]="'title_mute_mic' | label" [class]="{ muted: state.audioMuted, disabled: !local || silenced }" (click)="toggleAudio()">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#mic"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--screen" [title]="'title_share_screen' | label" [class]="{ active: screen }" (click)="toggleScreen()" *if="('screenShare' | flag) && (state.role == 'publisher' || state.role == 'attendee' || controlling)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#screen"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--chat" [title]="'title_chat' | label" [class]="{ active: state.chatDirty }" (click)="toggleChat()" *if="('chat' | flag)">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#chat"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--navinfo" [title]="'title_navinfo' | label" [class]="{ active: state.showNavInfo }" (click)="toggleNavInfo()" *if="showNavInfoToggler">\n\t\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#navinfo"></use></svg>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t\x3c!-- members --\x3e\n\t\t\t<div class="group--members">\n\t\t\t\t<div class="members" *if="state.role === 'publisher'">\n\t\t\t\t\t<svg class="spy" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#users"></use></svg>\n\t\t\t\t\t<span class="members__count" [innerHTML]="state.membersCount"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="credits">\n\t\t\t\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener">\n\t\t\t\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t\x3c!-- Self Service Tour --\x3e\n\t\t<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'self-service-tour'">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- service --\x3e\n\t\t\t<div class="group--service">\n\t\t\t\t<button type="button" class="btn--volume" [title]="'title_volume' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--fullscreen" [title]="'title_fullscreen' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t${h}\n\t\t\t${u}\n\t\t</div>\n\t\t\x3c!-- Embed --\x3e\n\t\t<div class="ui" [class]="uiClass" *if="state.status == 'connected' && state.mode == 'embed'">\n\t\t\t\x3c!-- world --\x3e\n\t\t\t<div class="ui__body">\n\t\t\t\t<div class="world"></div>\n\t\t\t</div>\n\t\t\t\x3c!-- service --\x3e\n\t\t\t<div class="group--service">\n\t\t\t\t<button type="button" class="btn--volume" [title]="'title_volume' | label" [class]="{ muted: state.volumeMuted }" (click)="toggleVolume($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.volumeMuted"><use xlink:href="#volume-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.volumeMuted"><use xlink:href="#volume-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--fullscreen" [title]="'title_fullscreen' | label" [class]="{ muted: state.fullScreen }" (click)="toggleFullScreen($event)">\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="!state.fullScreen"><use xlink:href="#fullscreen-on"></use></svg>\n\t\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" *if="state.fullScreen"><use xlink:href="#fullscreen-off"></use></svg>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t${h}\n\t\t\t${u}\n\t\t</div>\n\t\t<a class="btn--logo" [routerLink]="':lang.access' | route" *if="state.status != 'connected'">\n\t\t\t<img [src]="'logo' | env" *if="'logo' | env" />\n\t\t\t<svg viewBox="0 0 270 98" *if="!('logo' | env)"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t\t<a class="btn--credits" href="https://www.websolute.com/" target="_blank" rel="noopener" *if="state.status != 'connected'">\n\t\t\t<svg viewBox="0 0 270 98"><use xlink:href="#b-here"></use></svg>\n\t\t</a>\n\t\t<div class="group--language" language *if="state.status != 'connected'"></div>\n\t</div>\n\t`};class _a extends t.Component{get viewId(){const t=this.route?this.route.params.viewId:void 0;return t?parseInt(t):null}onInit(){this.platform=Fi.platform,this.route=this.host?this.host.route:null,this.missingAr=!1,this.missingUsdz=!1,this.missingGltf=!1;const e=this.viewId;e&&ps.viewById$(e).pipe(n.first()).subscribe((e=>{if(!e.ar)return this.missingAr=!0,void this.pushChanges();if(this.platform===Ui){const t=this.getUsdzSrc(e);t?window.location.href=t:(this.missingUsdz=!0,this.pushChanges())}else if(null!==this.getGltfSrc(e)){const i=this.getModelViewerNode(e),{node:n}=t.getContext(this);n.appendChild(i),this.addARScripts()}else this.missingGltf=!0,this.pushChanges()}))}addARScripts(){let t=document.createElement("script");t.setAttribute("type","module"),t.setAttribute("src","https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"),document.head.appendChild(t),t=document.createElement("script"),t.setAttribute("nomodule",""),t.setAttribute("src","https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"),document.head.appendChild(t)}getUsdzSrc(t){return t.ar&&t.ar.usdz?x.getPath(t.ar.usdz.folder+t.ar.usdz.file):null}getGltfSrc(t){return t.ar&&t.ar.gltf?x.getPath(t.ar.gltf.folder+t.ar.gltf.file):null}getViewId(){const t=new re;let e=null;return t.viewId&&(e=parseInt(t.viewId)),e}getModelViewerNode(t){const e=x.getPath(x.textures.envMap),i=x.getPath(t.asset.folder+t.asset.file),n=this.getUsdzSrc(t),s=this.getGltfSrc(t),o=`\n\t\t\t<model-viewer alt="${t.name}" environment-image="${e}" skybox-image="${i}" ios-src="${n}" src="${s}" ar ar-modes="webxr scene-viewer quick-look" ar-scale="auto" camera-controls></model-viewer>\n\t\t`,r=document.createElement("div");r.innerHTML=o;return r.firstElementChild}}_a.meta={selector:"[try-in-ar]",hosts:{host:ae},template:'\n\t\t<div class="page page--try-in-ar">\n\t\t\t\x3c!--\n\t\t\t<div *if="platform != \'ios\'">\n\t\t\t\t<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"><\/script>\n\t\t\t\t<script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"><\/script>\n\t\t\t</div>\n\t\t\t--\x3e\n\t\t\t<div class="ui" *if="!viewId">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Not found.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui" *if="missingAr">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Missing AR in view.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui" *if="missingUsdz">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Missing .usdz in ar.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui" *if="missingGltf">\n\t\t\t\t<div class="group--info">\n\t\t\t\t\t<div class="group--info__content">\n\t\t\t\t\t\t<div class="info">Missing .gltf in ar.</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},console.log("environment.defaultLanguage",x.defaultLanguage);class Sa extends t.Component{onInit(){const e=[{name:"index",path:"/",forwardTo:x.defaultLanguage||"it"},{name:"it",path:"/it",defaultParams:{lang:"it",mode:"access"},factory:Ai},{name:"it.access",path:"/accesso",defaultParams:{lang:"it",mode:"access"},factory:Ai},{name:"it.accessCode",path:"/codice-di-accesso?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"it",mode:"accessCode"},factory:ce},{name:"it.guidedTour",path:"/tour-guidato?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"it",mode:"guidedTour"},factory:Zr},{name:"it.selfServiceTour",path:"/tour-self-service?:p&:viewId&:pathId",defaultParams:{lang:"it",mode:"selfServiceTour"},factory:Zr},{name:"it.embed",path:"/embed",defaultParams:{lang:"it",mode:"embed"},factory:Zr},{name:"it.tryInAr",path:"/prova-in-ar?:p&:viewId",defaultParams:{lang:"it",mode:"tryInAr"},factory:_a},{name:"it.editor",path:"/editor?:p&:viewId",defaultParams:{lang:"it",mode:"editor"},factory:va},{name:"it.layout",path:"/layout",defaultParams:{lang:"it",mode:"layout"},factory:Ea},{name:"it.privacy",path:"/informativa-sulla-privacy",defaultParams:{lang:"it",mode:"privacy_policy"},factory:fa},{name:"it.terms",path:"/termini-di-utilizzo",defaultParams:{lang:"it",mode:"terms"},factory:fa},{name:"en",path:"/en",defaultParams:{lang:"en",mode:"access"},factory:Ai},{name:"en.access",path:"/access",defaultParams:{lang:"en",mode:"access"},factory:Ai},{name:"en.accessCode",path:"/accesso-code?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"en",mode:"accessCode"},factory:ce},{name:"en.guidedTour",path:"/guided-tour?:p&:link&:name&:role&:viewId&:pathId&:support",defaultParams:{lang:"en",mode:"guidedTour"},factory:Zr},{name:"en.selfServiceTour",path:"/self-service-tour?:p&:viewId&:pathId",defaultParams:{lang:"en",mode:"selfServiceTour"},factory:Zr},{name:"en.embed",path:"/embed",defaultParams:{lang:"en",mode:"embed"},factory:Zr},{name:"en.tryInAr",path:"/try-in-ar?:p&:viewId",defaultParams:{lang:"en",mode:"tryInAr"},factory:_a},{name:"en.editor",path:"/editor?:p&:viewId",defaultParams:{lang:"en",mode:"editor"},factory:va},{name:"en.layout",path:"/layout",defaultParams:{lang:"en",mode:"layout"},factory:Ea},{name:"en.privacy",path:"/privacy-policy",defaultParams:{lang:"en",mode:"privacy_policy"},factory:fa},{name:"en.terms",path:"/terms-of-service",defaultParams:{lang:"en",mode:"terms"},factory:fa}];te.useBrowser(e),x.flags.editorAssetScreen&&(ss.PublisherScreen={id:5,name:"PublisherScreen",ids:[6]},ss.AttendeeScreen={id:6,name:"AttendeeScreen",ids:[7]}),ss.SmartDevice={id:7,name:"Smart Device",ids:[8]},te.event$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{const i=t.route;i&&"embed"===i.params.mode&&(x.flags.like=!1),fe.setRoute(i,e)})),fe.lang$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.pushChanges()}));const{node:i}=t.getContext(this);i.classList.remove("hidden")}}Sa.meta={selector:"[b-here-component]",template:'\n\t\t\x3c!-- svg --\x3e\n\t\t\n\t\t<svg width="0" height="0" class="hidden" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true">\n\t\t\t<symbol id="arrow-down" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 7.33l2.829-2.83 9.175 9.339 9.167-9.339 2.829 2.83-11.996 12.17z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="arrow-next" viewBox="0 0 24 24">\n\t\t\t\t<path d="M7.33 24l-2.83-2.829 9.339-9.175-9.339-9.167 2.83-2.829 12.17 11.996z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="arrow-prev" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16.67 0l2.83 2.829-9.339 9.175 9.339 9.167-2.83 2.829-12.17-11.996z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="call" viewBox="0 0 24 24">\n\t\t\t\t<path d="M20 22.621l-3.521-6.795c-.008.004-1.974.97-2.064 1.011-2.24 1.086-6.799-7.82-4.609-8.994l2.083-1.026-3.493-6.817-2.106 1.039c-7.202 3.755 4.233 25.982 11.6 22.615.121-.055 2.102-1.029 2.11-1.033z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="heart" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 4.435c-1.989-5.399-12-4.597-12 3.568 0 4.068 3.06 9.481 12 14.997 8.94-5.516 12-10.929 12-14.997 0-8.118-10-8.999-12-3.568z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="heart-outline" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 9.229c.234-1.12 1.547-6.229 5.382-6.229 2.22 0 4.618 1.551 4.618 5.003 0 3.907-3.627 8.47-10 12.629-6.373-4.159-10-8.722-10-12.629 0-3.484 2.369-5.005 4.577-5.005 3.923 0 5.145 5.126 5.423 6.231zm-12-1.226c0 4.068 3.06 9.481 12 14.997 8.94-5.516 12-10.929 12-14.997 0-7.962-9.648-9.028-12-3.737-2.338-5.262-12-4.27-12 3.737z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="cam" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16 18c0 1.104-.896 2-2 2h-12c-1.105 0-2-.896-2-2v-12c0-1.104.895-2 2-2h12c1.104 0 2 .896 2 2v12zm8-14l-6 6.223v3.554l6 6.223v-16z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="cam-muted" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0.7,19.5L15.5,4.7C15.1,4.3,14.6,4,14,4H2C0.9,4,0,4.9,0,6v12C0,18.6,0.3,19.1,0.7,19.5z"></path>\n\t\t\t\t<path d="M18 13.8L24 20 24 4 18 10.2z"></path>\n\t\t\t\t<path d="M7.8,20H14c1.1,0,2-0.9,2-2v-6.2L7.8,20z"></path>\n\t\t\t\t<path d="M-3.4 11.2H27.400000000000002V12.7H-3.4z" transform="rotate(-45.001 12 12)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="mic" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16 11c0 2.209-1.791 4-4 4s-4-1.791-4-4v-7c0-2.209 1.791-4 4-4s4 1.791 4 4v7zm4-2v2c0 4.418-3.582 8-8 8s-8-3.582-8-8v-2h2v2c0 3.309 2.691 6 6 6s6-2.691 6-6v-2h2zm-7 13v-2h-2v2h-4v2h10v-2h-4z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="mic-muted" viewBox="0 0 24 24">\n\t\t\t\t<path d="M16,11.4L12.4,15C14.3,14.8,15.8,13.3,16,11.4z"></path>\n\t\t\t\t<path d="M16,4.6V4c0-2.2-1.8-4-4-4S8,1.8,8,4v7c0,0.5,0.1,0.9,0.3,1.4L16,4.6z"></path>\n\t\t\t\t<path d="M13 20L11 20 11 22 7 22 7 24 17 24 17 22 13 22z"></path>\n\t\t\t\t<path d="M18,11c0,3.3-2.7,6-6,6c-0.5,0-1-0.1-1.4-0.2L9,18.4c0.9,0.4,2,0.6,3,0.6c4.4,0,8-3.6,8-8V9h-2V11z"></path>\n\t\t\t\t<path d="M6.7,13.9C6.3,13,6,12,6,11V9H4v2c0,1.6,0.5,3.1,1.3,4.3L6.7,13.9z"></path>\n\t\t\t\t<path d="M-3.4 11.2H27.400000000000002V12.7H-3.4z" transform="rotate(-45.001 12 12)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="gamepad" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17.622 3c-1.913 0-2.558 1.382-5.623 1.382-3.009 0-3.746-1.382-5.623-1.382-5.209 0-6.376 10.375-6.376 14.348 0 2.145.817 3.652 2.469 3.652 3.458 0 2.926-5 6.915-5h5.23c3.989 0 3.457 5 6.915 5 1.652 0 2.471-1.506 2.471-3.651 0-3.973-1.169-14.349-6.378-14.349zm-10.622 10c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3zm10-6c.552 0 1 .447 1 1 0 .553-.448 1-1 1s-1-.447-1-1c0-.553.448-1 1-1zm-2 4c-.552 0-1-.447-1-1 0-.553.448-1 1-1s1 .447 1 1c0 .553-.448 1-1 1zm2 2c-.552 0-1-.447-1-1 0-.553.448-1 1-1s1 .447 1 1c0 .553-.448 1-1 1zm2-2c-.552 0-1-.447-1-1 0-.553.448-1 1-1s1 .447 1 1c0 .553-.448 1-1 1zm-10.25-1c0 .965-.785 1.75-1.75 1.75s-1.75-.785-1.75-1.75.785-1.75 1.75-1.75 1.75.785 1.75 1.75z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="ar" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 0l-11 6v12.131l11 5.869 11-5.869v-12.066l-11-6.065zm7.91 6.646l-7.905 4.218-7.872-4.294 7.862-4.289 7.915 4.365zm-16.91 1.584l8 4.363v8.607l-8-4.268v-8.702zm10 12.97v-8.6l8-4.269v8.6l-8 4.269zm6.678-5.315c.007.332-.256.605-.588.612-.332.007-.604-.256-.611-.588-.006-.331.256-.605.588-.612.331-.007.605.256.611.588zm-2.71-1.677c-.332.006-.595.28-.588.611.006.332.279.595.611.588s.594-.28.588-.612c-.007-.331-.279-.594-.611-.587zm-2.132-1.095c-.332.007-.595.281-.588.612.006.332.279.594.611.588.332-.007.594-.28.588-.612-.007-.331-.279-.594-.611-.588zm-9.902 2.183c.332.007.594.281.588.612-.007.332-.279.595-.611.588-.332-.006-.595-.28-.588-.612.005-.331.279-.594.611-.588zm1.487-.5c-.006.332.256.605.588.612s.605-.257.611-.588c.007-.332-.256-.605-.588-.611-.332-.008-.604.255-.611.587zm2.132-1.094c-.006.332.256.605.588.612.332.006.605-.256.611-.588.007-.332-.256-.605-.588-.612-.332-.007-.604.256-.611.588zm3.447-5.749c-.331 0-.6.269-.6.6s.269.6.6.6.6-.269.6-.6-.269-.6-.6-.6zm0-2.225c-.331 0-.6.269-.6.6s.269.6.6.6.6-.269.6-.6-.269-.6-.6-.6zm0-2.031c-.331 0-.6.269-.6.6s.269.6.6.6.6-.269.6-.6-.269-.6-.6-.6z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="close" viewBox="0 0 24 24">\n\t\t\t\t<path d="M23 20.168l-8.185-8.187 8.185-8.174-2.832-2.807-8.182 8.179-8.176-8.179-2.81 2.81 8.186 8.196-8.186 8.184 2.81 2.81 8.203-8.192 8.18 8.192z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="vr" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22.3,4.3H1.7C0.8,4.3,0,5.1,0,6v12c0,0.9,0.8,1.7,1.7,1.7h5.6c0.7,0,1.4-0.5,1.6-1.2l1.4-4.2c0.5-1.6,2.7-1.6,3.3,0 l1.4,4.2c0.2,0.7,0.9,1.2,1.6,1.2h5.6c0.9,0,1.7-0.8,1.7-1.7V6C24,5.1,23.2,4.3,22.3,4.3z M6,14.6c-1.4,0-2.6-1.2-2.6-2.6 S4.6,9.4,6,9.4s2.6,1.2,2.6,2.6S7.4,14.6,6,14.6z M18,14.6c-1.4,0-2.6-1.2-2.6-2.6s1.2-2.6,2.6-2.6s2.6,1.2,2.6,2.6 S19.4,14.6,18,14.6z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="vr-02" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22.5,8.6c-0.3,0-0.6,0.1-0.8,0.3c-0.3-1.9-1.9-3.4-3.9-3.4H6.2c-2,0-3.6,1.5-3.9,3.4C2,8.7,1.7,8.6,1.4,8.6 C0.6,8.6,0,9.3,0,10.1v3.9c0,0.8,0.6,1.4,1.4,1.4c0.3,0,0.6-0.1,0.8-0.3c0.3,1.9,1.9,3.4,3.9,3.4h11.6c2,0,3.6-1.5,3.9-3.4 c0.2,0.2,0.5,0.3,0.8,0.3c0.8,0,1.4-0.6,1.4-1.4v-3.9C24,9.3,23.3,8.6,22.5,8.6z M20.7,14.6c0,1.6-1.3,2.8-2.8,2.8H6.2 c-1.6,0-2.8-1.3-2.8-2.8V9.4c0-1.6,1.3-2.8,2.8-2.8h11.6c1.6,0,2.8,1.3,2.8,2.8V14.6z"></path><circle cx="5.7" cy="8.7" r=".8"></circle><circle cx="18.3" cy="8.6" r=".8"></circle><circle cx="5.7" cy="15.4" r=".8"></circle><circle cx="18.3" cy="15.3" r=".8"></circle>\n\t\t\t</symbol>\n\t\t\t<symbol id="the-spy" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17,14c-1.8,0-3.3,1.3-3.7,3h-2.5c-0.5-2.1-2.5-3.4-4.6-2.9c-2.1,0.5-3.4,2.5-2.9,4.6s2.5,3.4,4.6,2.9 c1.4-0.3,2.6-1.5,2.9-2.9h2.5c0.5,2.1,2.5,3.4,4.6,2.9s3.4-2.5,2.9-4.6C20.4,15.3,18.8,14,17,14z"></path>\n\t\t\t\t<path d="M23.2,11.5h-2.6V6c0-0.7-0.5-1.4-1.2-1.6l-5.5-1.8c-1.2-0.4-2.6-0.4-3.8,0L4.6,4.4C3.9,4.6,3.4,5.3,3.4,6v5.4H0.8 c-0.5,0-0.8,0.4-0.8,0.8s0.4,0.8,0.8,0.8h22.3c0.5,0,0.8-0.4,0.8-0.8S23.6,11.5,23.2,11.5z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="spy-eye" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12,19.6c-4.6,0-8.9-3.5-11.7-6.8c-0.4-0.5-0.4-1.2,0-1.6C3.1,7.9,7.4,4.4,12,4.4s8.9,3.5,11.7,6.8 c0.4,0.5,0.4,1.2,0,1.6C20.9,16.1,16.6,19.6,12,19.6z M12,7.5c2.5,0,4.4,1.9,4.4,4.4s-1.9,4.4-4.4,4.4s-4.4-1.9-4.4-4.4 S9.5,7.5,12,7.5z" clip-rule="evenodd"></path>\n\t\t\t\t<path d="M12,9.3c1.4,0,2.6,1.2,2.6,2.6s-1.2,2.6-2.6,2.6s-2.6-1.2-2.6-2.6S10.6,9.3,12,9.3z" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="copy" viewBox="0 0 24 24">\n\t\t\t\t<path d="M7 16h10v1h-10v-1zm0-1h10v-1h-10v1zm15-13v22h-20v-22h3c1.229 0 2.18-1.084 3-2h8c.82.916 1.771 2 3 2h3zm-11 1c0 .552.448 1 1 1s1-.448 1-1-.448-1-1-1-1 .448-1 1zm9 1h-4l-2 2h-3.898l-2.102-2h-4v18h16v-18zm-13 9h10v-1h-10v1zm0-2h10v-1h-10v1z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="menu" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 18c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3zm0-9c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3zm0-9c1.657 0 3 1.343 3 3s-1.343 3-3 3-3-1.343-3-3 1.343-3 3-3z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="menu-light" viewBox="0 0 24 24">\n\t\t\t\t<path d="M14 19h-14v-1h14v1zm9.247-8.609l-3.247 4.049-3.263-4.062-.737.622 4 5 4-5-.753-.609zm-9.247 2.609h-14v-1h14v1zm0-6h-14v-1h14v1z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="settings" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 14.187v-4.374c-2.148-.766-2.726-.802-3.027-1.529-.303-.729.083-1.169 1.059-3.223l-3.093-3.093c-2.026.963-2.488 1.364-3.224 1.059-.727-.302-.768-.889-1.527-3.027h-4.375c-.764 2.144-.8 2.725-1.529 3.027-.752.313-1.203-.1-3.223-1.059l-3.093 3.093c.977 2.055 1.362 2.493 1.059 3.224-.302.727-.881.764-3.027 1.528v4.375c2.139.76 2.725.8 3.027 1.528.304.734-.081 1.167-1.059 3.223l3.093 3.093c1.999-.95 2.47-1.373 3.223-1.059.728.302.764.88 1.529 3.027h4.374c.758-2.131.799-2.723 1.537-3.031.745-.308 1.186.099 3.215 1.062l3.093-3.093c-.975-2.05-1.362-2.492-1.059-3.223.3-.726.88-.763 3.027-1.528zm-4.875.764c-.577 1.394-.068 2.458.488 3.578l-1.084 1.084c-1.093-.543-2.161-1.076-3.573-.49-1.396.581-1.79 1.693-2.188 2.877h-1.534c-.398-1.185-.791-2.297-2.183-2.875-1.419-.588-2.507-.045-3.579.488l-1.083-1.084c.557-1.118 1.066-2.18.487-3.58-.579-1.391-1.691-1.784-2.876-2.182v-1.533c1.185-.398 2.297-.791 2.875-2.184.578-1.394.068-2.459-.488-3.579l1.084-1.084c1.082.538 2.162 1.077 3.58.488 1.392-.577 1.785-1.69 2.183-2.875h1.534c.398 1.185.792 2.297 2.184 2.875 1.419.588 2.506.045 3.579-.488l1.084 1.084c-.556 1.121-1.065 2.187-.488 3.58.577 1.391 1.689 1.784 2.875 2.183v1.534c-1.188.398-2.302.791-2.877 2.183zm-7.125-5.951c1.654 0 3 1.346 3 3s-1.346 3-3 3-3-1.346-3-3 1.346-3 3-3zm0-2c-2.762 0-5 2.238-5 5s2.238 5 5 5 5-2.238 5-5-2.238-5-5-5z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="settings-full" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 13.616v-3.232l-2.869-1.02c-.198-.687-.472-1.342-.811-1.955l1.308-2.751-2.285-2.285-2.751 1.307c-.613-.339-1.269-.613-1.955-.811l-1.021-2.869h-3.232l-1.021 2.869c-.686.198-1.342.471-1.955.811l-2.751-1.308-2.285 2.285 1.308 2.752c-.339.613-.614 1.268-.811 1.955l-2.869 1.02v3.232l2.869 1.02c.197.687.472 1.342.811 1.955l-1.308 2.751 2.285 2.286 2.751-1.308c.613.339 1.269.613 1.955.811l1.021 2.869h3.232l1.021-2.869c.687-.198 1.342-.472 1.955-.811l2.751 1.308 2.285-2.286-1.308-2.751c.339-.613.613-1.268.811-1.955l2.869-1.02zm-12 2.384c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="emoji" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12,2c5.5,0,10,4.5,10,10s-4.5,10-10,10S2,17.5,2,12S6.5,2,12,2z M12,0C5.4,0,0,5.4,0,12s5.4,12,12,12s12-5.4,12-12 S18.6,0,12,0z M18,14H6c0.3,1.5,2.8,4,6,4C15.1,18,17.7,15.5,18,14z M8.5,8C7.7,8,7,8.7,7,9.5S7.7,11,8.5,11S10,10.3,10,9.5 S9.3,8,8.5,8z M15.5,8C14.7,8,14,8.7,14,9.5s0.7,1.5,1.5,1.5c0.8,0,1.5-0.7,1.5-1.5S16.3,8,15.5,8z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="pencil" viewBox="0 0 24 24">\n\t\t\t\t<path d="M19.769 9.923l-12.642 12.639-7.127 1.438 1.438-7.128 12.641-12.64 5.69 5.691zm1.414-1.414l2.817-2.82-5.691-5.689-2.816 2.817 5.69 5.692z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="erase" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5.662 23l-5.369-5.365c-.195-.195-.293-.45-.293-.707 0-.256.098-.512.293-.707l14.929-14.928c.195-.194.451-.293.707-.293.255 0 .512.099.707.293l7.071 7.073c.196.195.293.451.293.708 0 .256-.097.511-.293.707l-11.216 11.219h5.514v2h-12.343zm3.657-2l-5.486-5.486-1.419 1.414 4.076 4.072h2.829zm.456-11.429l-4.528 4.528 5.658 5.659 4.527-4.53-5.657-5.657z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="move" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12 10c1.104 0 2 .896 2 2s-.896 2-2 2-2-.896-2-2 .896-2 2-2zm-3.857 3c-.084-.321-.143-.652-.143-1s.059-.679.143-1h-2.143v-4l-6 5 6 5v-4h2.143zm7.714-2c.084.321.143.652.143 1s-.059.679-.143 1h2.143v4l6-5-6-5v4h-2.143zm-2.857 4.857c-.321.084-.652.143-1 .143s-.679-.059-1-.143v2.143h-4l5 6 5-6h-4v-2.143zm-2-7.714c.321-.084.652-.143 1-.143s.679.059 1 .143v-2.143h4l-5-6-5 6h4v2.143z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="caret-down" viewBox="0 0 8 5">\n\t\t\t\t<path d="M0 0h8L4 5 0 0z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="caret-right" viewBox="0 0 8 12">\n\t\t\t\t<path d="M0 12V0l8 6-8 6z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="websolute" viewBox="0 0 20 20">\n\t\t\t\t<path d="M20 10c0 5.5-4.5 10-10 10S0 15.5 0 10 4.5 0 10 0s10 4.5 10 10m-10 2.3c.5.5 1.3.8 2.1.8s1.5-.3 2.1-.8c.5-.5.8-1.2.8-2V7.5h-1.7v2.8c0 .3-.1.6-.4.8-.1.1-.3.2-.4.3-.2.1-.3.1-.5.1s-.3 0-.5-.1c-.1-.1-.3-.2-.4-.3-.2-.2-.4-.5-.4-.8V7.6H9.2v2.8c0 .3-.1.6-.4.9-.2.2-.5.4-.8.4-.3 0-.7-.1-.9-.3-.2-.2-.4-.5-.3-.8V7.5H5v2.8c0 .7.3 1.5.8 2 .6.5 1.3.8 2.1.8.8.1 1.6-.2 2.1-.8z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="search" viewBox="0 0 21 23">\n\t\t\t\t<path d="M20.6 20.3l-4.9-5.2c1.2-1.7 1.8-3.7 1.8-5.7 0-5.2-3.9-9.4-8.7-9.4S0 4.2 0 9.4s3.7 7.8 6.3 8.4c1.8.4 3.9.6 7.1-.7l5.1 5.4c.5.6 1.4.6 2 .1l.1-.1c.5-.6.5-1.6 0-2.2zM15 9.4c-.2 3.5-3.2 6.1-6.7 5.8S2.2 12 2.5 8.5c.2-3.3 3-5.8 6.3-5.8 3.5.1 6.3 3.1 6.2 6.7z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="result-indicator" viewBox="0 0 24 24">\n\t\t\t\t<path d="M11 21.883l-6.235-7.527-.765.644 7.521 9 7.479-9-.764-.645-6.236 7.529v-21.884h-1v21.883z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="bullet" viewBox="0 0 18 18">\n\t\t\t\t<path d="M9 2c3.9 0 7 3.1 7 7s-3.1 7-7 7-7-3.1-7-7 3.1-7 7-7m0-2C4 0 0 4 0 9s4 9 9 9 9-4 9-9-4-9-9-9z" opacity=".15" fill="#17265a"></path>\n\t\t\t\t<circle cx="9" cy="9" r="4" fill="#17265a"></circle>\n\t\t\t</symbol>\n\t\t\t<symbol id="play" viewBox="0 0 16 20">\n\t\t\t\t<path d="M0,0v19.8l15.4-11L0,0z" fill-rule="evenodd" clip-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="play-progress" viewBox="0 0 196 196">\n\t\t\t\t<path d="M195.5,98c0,53.8-43.7,97.5-97.5,97.5S0.5,151.8,0.5,98S44.2,0.5,98,0.5S195.5,44.2,195.5,98z" stroke-width="2px" stroke-linecap="square" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="pause" viewBox="0 0 16 20">\n\t\t\t\t<path d="M0 0.9H4V18.9H0z"></path>\n\t\t\t\t<path d="M11.4 0.9H15.4V18.9H11.4z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="wishlist-add" viewBox="0 0 25 20">\n\t\t\t\t<path d="M12.5,20.8c-0.3,0-0.5-0.1-0.8-0.3c-0.3-0.2-0.6-0.4-0.9-0.6c-0.7-0.5-1.4-0.9-2.1-1.5 c-1.1-0.8-2.1-1.6-3.1-2.4C4.2,15,3,13.8,1.9,12.4c-0.9-1.1-1.4-2.3-1.7-3.7C0.1,8.5,0.1,8.2,0,7.9l0-0.2l0.1-1.4 c0-0.1,0.1-0.3,0.1-0.4c0.1-0.3,0.1-0.7,0.3-1c0.6-1.7,1.8-3.2,3.4-4c1.5-0.8,3.3-1.1,5-0.8c1.4,0.2,2.6,0.8,3.7,1.7 c2.9-2.4,7.2-2.4,10,0.1c1.1,0.9,1.9,2.2,2.2,3.5c0.1,0.3,0.1,0.6,0.2,0.8L25,6.7l-0.1,1.4c-0.2,1.2-0.6,2.4-1.2,3.4 c-0.5,0.8-1.1,1.6-1.8,2.3c-0.8,0.9-1.7,1.7-2.6,2.5c-0.7,0.6-1.6,1.3-2.6,2c-0.8,0.5-1.5,1.1-2.3,1.6c-0.4,0.3-0.8,0.5-1.2,0.8 C13.1,20.8,12.8,20.8,12.5,20.8z M2.1,7.6c0,0.2,0.1,0.4,0.1,0.6c0.2,1.1,0.7,2,1.4,2.9c1,1.2,2.1,2.3,3.3,3.3c1,0.8,2,1.6,3,2.4 c0.7,0.5,1.4,0.9,2.1,1.4l0.5,0.3c0.2-0.2,0.5-0.3,0.7-0.5c0.8-0.5,1.5-1,2.3-1.6c0.9-0.7,1.8-1.4,2.5-1.9c0.9-0.7,1.7-1.5,2.4-2.3 c0.6-0.6,1.1-1.2,1.5-1.9c0.5-0.8,0.8-1.7,0.9-2.6c0-0.1,0-0.1,0-0.2l0-0.9c0-0.2-0.1-0.4-0.1-0.6c-0.3-1-0.8-1.9-1.6-2.5 c-2.1-1.8-5.2-1.8-7.3,0c-0.1,0.1-0.3,0.2-0.4,0.4l-0.9,1.2l-1-1.3c-0.8-0.8-1.9-1.4-3-1.6C7.2,2,5.9,2.2,4.9,2.8 c-1.1,0.6-2,1.6-2.4,2.8C2.4,5.9,2.3,6.1,2.3,6.4c0,0.1-0.1,0.3-0.1,0.4l0,0L2.1,7.6L2.1,7.6z" clip-rule="evenodd" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="wishlist-added" viewBox="0 0 25 20">\n\t\t\t\t<path d="M12.5,20.8c-0.3,0-0.5-0.1-0.8-0.3c-0.3-0.2-0.6-0.4-0.9-0.6c-0.7-0.5-1.4-0.9-2.1-1.5 c-1.1-0.8-2.1-1.6-3.1-2.4c-1.4-1-2.6-2.2-3.7-3.6C1,11.3,0.5,10.1,0.2,8.7C0.1,8.5,0.1,8.2,0,7.9V7.7l0.1-1.4 c0-0.1,0.1-0.3,0.1-0.4c0.1-0.3,0.1-0.7,0.3-1c0.6-1.7,1.8-3.2,3.4-4c1.5-0.8,3.3-1.1,5-0.8c1.4,0.2,2.6,0.8,3.7,1.7 c2.9-2.4,7.2-2.4,10,0.1c1.1,0.9,1.9,2.2,2.2,3.5C24.9,5.7,24.9,6,25,6.2v0.5l-0.1,1.4c-0.2,1.2-0.6,2.4-1.2,3.4 c-0.5,0.8-1.1,1.6-1.8,2.3c-0.8,0.9-1.7,1.7-2.6,2.5c-0.7,0.6-1.6,1.3-2.6,2c-0.8,0.5-1.5,1.1-2.3,1.6c-0.4,0.3-0.8,0.5-1.2,0.8 C13.1,20.8,12.8,20.8,12.5,20.8z" clip-rule="evenodd" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="wishlist" viewBox="0 0 16 14">\n\t\t\t\t<path d="M8,14c-0.2,0-0.3-0.1-0.5-0.2l-0.6-0.4c-0.5-0.3-0.9-0.6-1.4-1c-0.7-0.5-1.4-1.1-2-1.6 c-0.9-0.7-1.6-1.6-2.3-2.5C0.7,7.6,0.3,6.8,0.1,5.9c0-0.2-0.1-0.4-0.1-0.5l0-0.1l0-1c0-0.1,0-0.2,0.1-0.3c0.1-0.2,0.1-0.4,0.2-0.7 c0.4-1.1,1.2-2.1,2.2-2.7c1.8-1,4-0.8,5.5,0.6c1.8-1.6,4.6-1.6,6.4,0.1c0.7,0.6,1.2,1.5,1.4,2.4C15.9,3.8,15.9,4,16,4.2l0,0.3l0,0.9 c-0.1,0.8-0.4,1.6-0.8,2.3c-0.3,0.5-0.7,1-1.1,1.5c-0.5,0.6-1.1,1.1-1.7,1.7c-0.4,0.4-1,0.9-1.7,1.3c-0.5,0.4-1,0.7-1.5,1.1 c-0.2,0.2-0.5,0.3-0.7,0.5C8.4,13.9,8.2,14,8,14z M1.4,5.1c0,0.1,0.1,0.3,0.1,0.4c0.1,0.7,0.4,1.4,0.9,1.9C2.9,8.3,3.6,9,4.4,9.7 c0.6,0.5,1.3,1.1,1.9,1.6c0.4,0.3,0.9,0.6,1.3,0.9c0.1,0.1,0.2,0.2,0.3,0.2c0.2-0.1,0.3-0.2,0.5-0.3c0.5-0.3,1-0.7,1.5-1 c0.6-0.4,1.2-0.9,1.6-1.3c0.5-0.5,1.1-1,1.5-1.5c0.4-0.4,0.7-0.8,1-1.3c0.3-0.5,0.5-1.1,0.6-1.7c0,0,0-0.1,0-0.1l0-0.6 c0-0.1,0-0.3-0.1-0.4c-0.2-0.7-0.5-1.2-1-1.7c-1.3-1.2-3.4-1.2-4.7,0C8.7,2.4,8.6,2.5,8.5,2.6L8,3.4L7.3,2.5 C6.3,1.4,4.5,1.1,3.1,1.9C2.4,2.3,1.8,3,1.6,3.8C1.5,3.9,1.5,4.1,1.4,4.3L1.4,4.6l0,0L1.4,5.1L1.4,5.1z" clip-rule="evenodd" fill-rule="evenodd" ></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="expand" viewBox="0 0 29 30">\n\t\t\t\t<path d="M26 16.3V5.9L2.2 29.7.1 27.6 24 3.3H13v-3h16v16h-3z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="download" viewBox="0 0 9 13">\n\t\t\t\t<path d="M8.5 7.9c-.3-.4-.8-.4-1.2-.1l-.1.1-2 2V1.2c0-.2-.1-.4-.2-.6-.2-.3-.7-.3-1 0-.2.2-.3.4-.3.6v8.6l-2-2c-.2-.1-.4-.2-.7-.2-.2 0-.4.1-.6.3-.1.2-.1.4-.1.6 0 .2.1.4.2.5l3.4 3.4c.2.2.4.2.6.2.2 0 .4-.1.6-.2L8.4 9c.2-.1.2-.3.3-.6 0-.1-.1-.4-.2-.5z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="upload" viewBox="0 0 24 24">\n\t\t\t\t<path d="M10 9H4l8-9 8 9h-6v11h-4V9zm11 11v2H3v-2H1v4h22v-4h-2z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="user" viewBox="0 0 24 24">\n\t\t\t\t<path d="M20.822 18.096c-3.439-.794-6.64-1.49-5.09-4.418C20.452 4.766 16.983 0 12 0 6.918 0 3.536 4.949 8.268 13.678c1.597 2.945-1.725 3.641-5.09 4.418C.105 18.806-.01 20.332 0 23l.004 1h23.99l.004-.969c.012-2.688-.092-4.222-3.176-4.935z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="back" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2.117 12l7.527 6.235L9 19l-9-7.521L9 4l.645.764L2.116 11H24v1H2.117z" fill-rule="evenodd" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="add" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 10h-10v-10h-4v10h-10v4h10v10h4v-10h10z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="remove" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 10h24v4h-24z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="link" viewBox="0 0 24 24">\n\t\t\t\t<path d="M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="up" viewBox="0 0 24 24">\n\t\t\t\t<path d="M7 11h-6l11-11 11 11h-6v13h-10z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="down" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17,13h6L12,24L1,13h6V0h10V13z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="waiting-room" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2,6c0-2.2,1.8-4,4-4h12c2.2,0,4,1.8,4,4v12c0,2.2-1.8,4-4,4H6c-2.2,0-4-1.8-4-4V6z" opacity=".2"></path>\n\t\t\t\t<path d="M17.8,10.7c0.7,0,1.3,0.6,1.3,1.3s-0.6,1.3-1.3,1.3H6.2c-0.7,0-1.3-0.6-1.3-1.3s0.6-1.3,1.3-1.3H17.8z M19.7,12 c0-1.1-0.9-1.9-1.9-1.9H6.2c-1.1,0-1.9,0.9-1.9,1.9s0.9,1.9,1.9,1.9h11.6C18.9,13.9,19.7,13.1,19.7,12z M13.9,11.4H6.2 c-0.4,0-0.6,0.3-0.6,0.6s0.3,0.6,0.6,0.6h7.7c0.4,0,0.6-0.3,0.6-0.6S14.3,11.4,13.9,11.4z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="panorama" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 9 15 C 9 14.448 9.448 14 10 14 L 14 14 C 14.552 14 15 14.448 15 15 L 15 16 C 15 16.552 14.552 17 14 17 L 10 17 C 9.448 17 9 16.552 9 16 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t\t<path d="M 7 8 C 7 7.448 7.448 7 8 7 L 16 7 C 16.552 7 17 7.448 17 8 L 17 12 C 17 12.552 16.552 13 16 13 L 8 13 C 7.448 13 7 12.552 7 12 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="panorama-grid" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 10.333 7.333 C 10.886 7.333 11.333 7.781 11.333 8.333 L 11.333 10.333 C 11.333 10.886 10.886 11.333 10.333 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t\t<path d="M 12.333 8.333 C 12.333 7.781 12.781 7.333 13.333 7.333 L 15.333 7.333 C 15.886 7.333 16.333 7.781 16.333 8.333 L 16.333 10.333 C 16.333 10.886 15.886 11.333 15.333 11.333 L 13.333 11.333 C 12.781 11.333 12.333 10.886 12.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t\t<path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 10.333 12.667 C 10.886 12.667 11.333 13.114 11.333 13.667 L 11.333 15.667 C 11.333 16.219 10.886 16.667 10.333 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t\t<path d="M 12.333 13.667 C 12.333 13.114 12.781 12.667 13.333 12.667 L 15.333 12.667 C 15.886 12.667 16.333 13.114 16.333 13.667 L 16.333 15.667 C 16.333 16.219 15.886 16.667 15.333 16.667 L 13.333 16.667 C 12.781 16.667 12.333 16.219 12.333 15.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="room-3d" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 6.6 9.056 C 6.6 8.533 6.905 8.059 7.381 7.842 L 8.995 7.108 C 9.436 6.907 9.938 7.23 9.938 7.715 L 9.938 16.272 C 9.938 16.757 9.436 17.08 8.995 16.879 L 7.381 16.145 C 6.905 15.928 6.6 15.454 6.6 14.931 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 10.754 7.453 C 10.754 6.795 11.378 6.316 12.014 6.487 L 16.32 7.647 C 17.193 7.882 17.8 8.674 17.8 9.578 L 17.8 14.105 C 17.8 15.009 17.193 15.801 16.32 16.036 L 12.014 17.196 C 11.378 17.367 10.754 16.889 10.754 16.231 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="model" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M 11.298 7.283 C 11.602 6.729 12.398 6.729 12.702 7.283 L 14.009 9.673 C 14.082 9.807 14.193 9.918 14.327 9.991 L 16.717 11.298 C 17.271 11.602 17.271 12.398 16.717 12.702 L 14.327 14.009 C 14.193 14.082 14.082 14.193 14.009 14.327 L 12.702 16.717 C 12.398 17.271 11.602 17.271 11.298 16.717 L 9.991 14.327 C 9.918 14.193 9.807 14.082 9.673 14.009 L 7.283 12.702 C 6.729 12.398 6.729 11.602 7.283 11.298 L 9.673 9.991 C 9.807 9.918 9.918 9.807 9.991 9.673 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="media" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2,6c0-2.2,1.8-4,4-4h12c2.2,0,4,1.8,4,4v12c0,2.2-1.8,4-4,4H6c-2.2,0-4-1.8-4-4V6z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M12,19c-2.2,0-4.3-1-5.6-2.7L7,15.9c1.2,1.5,3,2.4,5,2.4c1.9,0,3.8-0.9,5-2.4l0.6,0.4C16.3,18,14.2,19,12,19z M5.5,14.7C5.2,13.8,5,12.8,5,12c0-3.5,2.7-6.5,6.2-7v0.6C8,6.1,5.7,8.8,5.7,12c0,0.8,0.1,1.5,0.4,2.4L5.5,14.7z M18,14.4 c0.3-0.8,0.4-1.6,0.4-2.4c0-3.2-2.3-5.9-5.5-6.4c0-0.2,0-0.5,0-0.6c3.5,0.4,6.2,3.4,6.2,7c0,0.8-0.2,1.8-0.5,2.7L18,14.4z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M10.2,15V8.9l5.5,3.1L10.2,15z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="nav" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 6.5 8.667 C 6.5 8.114 6.948 7.667 7.5 7.667 L 16.5 7.667 C 17.052 7.667 17.5 8.114 17.5 8.667 L 17.5 14.495 C 17.5 15.046 17.053 15.494 16.502 15.495 L 14.189 15.499 C 13.959 15.5 13.736 15.58 13.558 15.725 L 12.211 16.827 C 12.088 16.928 11.912 16.928 11.789 16.827 L 10.442 15.725 C 10.264 15.58 10.041 15.5 9.811 15.499 L 7.498 15.495 C 6.947 15.494 6.5 15.046 6.5 14.495 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="plane" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(4.667 11.5) rotate(-90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(17.333 11.5) rotate(90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 8 9 C 8 8.448 8.448 8 9 8 L 15 8 C 15.552 8 16 8.448 16 9 L 16 15 C 16 15.552 15.552 16 15 16 L 9 16 C 8.448 16 8 15.552 8 15 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="curved-plane" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(4.667 11.5) rotate(-90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 2 1 L 1 0 L 0 1" transform="translate(17.333 11.5) rotate(90 1 0.5)" fill="transparent" opacity="0.4" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path>\n\t\t\t\t<path d="M 8 9 C 8 8.448 8.448 8 9 8 L 15 8 C 15.552 8 16 8.448 16 9 L 16 15 C 16 15.552 15.552 16 15 16 L 9 16 C 8.448 16 8 15.552 8 15 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="texture" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 7.333 8.95 C 7.333 8.274 7.839 7.705 8.511 7.626 L 14.805 6.886 C 15.796 6.769 16.667 7.543 16.667 8.541 L 16.667 15.49 C 16.667 16.477 15.814 17.247 14.833 17.148 L 8.533 16.513 C 7.852 16.444 7.333 15.871 7.333 15.187 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="gltf" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path>\n\t\t\t\t<path d="M 11.298 7.283 C 11.602 6.729 12.398 6.729 12.702 7.283 L 14.009 9.673 C 14.082 9.807 14.193 9.918 14.327 9.991 L 16.717 11.298 C 17.271 11.602 17.271 12.398 16.717 12.702 L 14.327 14.009 C 14.193 14.082 14.082 14.193 14.009 14.327 L 12.702 16.717 C 12.398 17.271 11.602 17.271 11.298 16.717 L 9.991 14.327 C 9.918 14.193 9.807 14.082 9.673 14.009 L 7.283 12.702 C 6.729 12.398 6.729 11.602 7.283 11.298 L 9.673 9.991 C 9.807 9.918 9.918 9.807 9.991 9.673 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="tile" viewBox="0 0 24 24">\n\t\t\t\t<path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path>\n\t\t\t\t<path d="M 15.667 13 C 17.139 13 18.333 14.194 18.333 15.667 C 18.333 17.139 17.139 18.333 15.667 18.333 C 14.194 18.333 13 17.139 13 15.667 C 13 14.194 14.194 13 15.667 13 Z" fill="var(--svg-icon-tint)"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="image" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5 8.5c0-.828.672-1.5 1.5-1.5s1.5.672 1.5 1.5c0 .829-.672 1.5-1.5 1.5s-1.5-.671-1.5-1.5zm9 .5l-2.519 4-2.481-1.96-4 5.96h14l-5-8zm8-4v14h-20v-14h20zm2-2h-24v18h24v-18z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="video" viewBox="0 0 24 24">\n\t\t\t\t<path d="M2.184 7.874l-2.184-.918 2.967-2.956.933 2.164-1.716 1.71zm21.816 2.126l-3 2v4l3 2v-8zm-7-2h-7.018l.79.787c.356.355.629.769.831 1.213h4.897c.276 0 .5.224.5.5v7c0 .276-.224.5-.5.5h-11c-.276 0-.5-.224-.5-.5v-2.909l-.018-.014-1.982-1.975v5.398c0 1.104.896 2 2 2h12c1.104 0 2-.896 2-2v-8c0-1.104-.896-2-2-2zm-14.65 1.13l2.967-2.956 4.044 4.029c.819.816.819 2.14 0 2.956-.819.816-2.147.815-2.967 0l-4.044-4.029z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="stream" viewBox="0 0 24 24">\n\t\t\t\t<path d="M6.613 18.581m9.387-9.581c0 2.209-1.791 4-4 4s-4-1.791-4-4 1.791-4 4-4 4 1.791 4 4zm-2 0c0-1.103-.896-2-2-2s-2 .897-2 2 .896 2 2 2 2-.897 2-2zm-9 0c0 3.86 3.141 7 7 7s7-3.14 7-7-3.141-7-7-7-7 3.14-7 7zm16 0c0 4.97-4.029 9-9 9s-9-4.03-9-9 4.029-9 9-9 9 4.03 9 9zm-.404 12.501c1.007 1.142-.014 2.679-1.448 2.481-1.795-.245-3.236-1.702-7.147-1.702-3.91 0-5.352 1.458-7.146 1.702-1.436.198-2.456-1.34-1.449-2.481l2.898-3.289c.559.388 1.156.725 1.79.994l-2.025 2.298c1.295-.524 3.065-1.225 5.933-1.225s4.638.7 5.933 1.224l-2.025-2.298c.634-.27 1.231-.606 1.79-.994l2.896 3.29z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="spinner" viewBox="0 0 24 24">\n\t\t\t\t<path d="M8.175 7.377l-3.042-5.27 1.732-1 3.045 5.273c-.635.238-1.222.573-1.735.997zm-.799.8l-5.27-3.042-1 1.732 5.274 3.045c.237-.635.572-1.223.996-1.735zm-1.376 3.823c0-.341.035-.673.09-.999h-6.09v1.999h6.09c-.055-.326-.09-.659-.09-1zm11.351-2.705l5.208-3.007-.333-.577-5.206 3.007c.121.185.23.379.331.577zm-5.351-3.295c.341 0 .673.035.999.09v-6.09h-1.999v6.09c.326-.055.659-.09 1-.09zm3.14.894l3.004-5.204-.288-.166-3 5.197.284.173zm1.685 8.662l5.234 3.022.666-1.154-5.229-3.019c-.181.41-.408.794-.671 1.151zm-10.444-1.467l-5.274 3.046 1 1.732 5.27-3.042c-.424-.513-.759-1.1-.996-1.736zm11.594-2.589l.025.5-.025.5h6.025v-1h-6.025zm-3.727 6.061l3.03 5.249 1.442-.833-3.031-5.25c-.437.34-.92.623-1.441.834zm-2.248.439c-.341 0-.674-.035-1-.09v6.09h1.999v-6.09c-.326.055-.658.09-.999.09zm-3.824-1.376l-3.042 5.27 1.732 1 3.045-5.274c-.635-.237-1.222-.572-1.735-.996z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="update" viewBox="0 0 24 24">\n\t\t\t\t<path d="M23 12c0 1.042-.154 2.045-.425 3h-2.101c.335-.94.526-1.947.526-3 0-4.962-4.037-9-9-9-1.706 0-3.296.484-4.655 1.314l1.858 2.686h-6.994l2.152-7 1.849 2.673c1.684-1.049 3.659-1.673 5.79-1.673 6.074 0 11 4.925 11 11zm-6.354 7.692c-1.357.826-2.944 1.308-4.646 1.308-4.962 0-9-4.038-9-9 0-1.053.191-2.06.525-3h-2.1c-.271.955-.425 1.958-.425 3 0 6.075 4.925 11 11 11 2.127 0 4.099-.621 5.78-1.667l1.853 2.667 2.152-6.989h-6.994l1.855 2.681z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="edit" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 1h24v2h-24v-2zm11 7h13v-2h-13v2zm0 5h13v-2h-13v2zm0 5h13v-2h-13v2zm-11 5h24v-2h-24v2zm8-17l-8 6 8 6v-12z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="lock" viewBox="0 0 24 24">\n\t\t\t\t<path d="M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4h-3v14h18v-14h-3zm-10 0v-4c0-2.206 1.794-4 4-4s4 1.794 4 4v4h-8z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="volume-off" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5 17h-5v-10h5v10zm2-10v10l9 5v-20l-9 5zm15.324 4.993l1.646-1.659-1.324-1.324-1.651 1.67-1.665-1.648-1.316 1.318 1.67 1.657-1.65 1.669 1.318 1.317 1.658-1.672 1.666 1.653 1.324-1.325-1.676-1.656z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="volume-on" viewBox="0 0 24 24">\n\t\t\t\t<path d="M5 17h-5v-10h5v10zm2-10v10l9 5v-20l-9 5zm11.008 2.093c.742.743 1.2 1.77 1.198 2.903-.002 1.133-.462 2.158-1.205 2.9l1.219 1.223c1.057-1.053 1.712-2.511 1.715-4.121.002-1.611-.648-3.068-1.702-4.125l-1.225 1.22zm2.142-2.135c1.288 1.292 2.082 3.073 2.079 5.041s-.804 3.75-2.096 5.039l1.25 1.254c1.612-1.608 2.613-3.834 2.616-6.291.005-2.457-.986-4.681-2.595-6.293l-1.254 1.25z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="fullscreen-off" viewBox="0 0 24 24">\n\t\t\t\t<path d="M15 2h2v5h7v2h-9v-7zm9 13v2h-7v5h-2v-7h9zm-15 7h-2v-5h-7v-2h9v7zm-9-13v-2h7v-5h2v7h-9z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="fullscreen-on" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 9h-2v-7h-7v-2h9v9zm-9 15v-2h7v-7h2v9h-9zm-15-9h2v7h7v2h-9v-9zm9-15v2h-7v7h-2v-9h9z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="navmap" viewBox="0 0 24 24">\n\t\t\t\t<path d="M24 22.586l-2.823-2.823c.526-.792.836-1.74.836-2.763 0-2.762-2.238-5-5-5s-5 2.238-5 5 2.238 5 5 5c1.016 0 1.957-.307 2.746-.827l2.827 2.827 1.414-1.414zm-9.987-5.586c0-1.654 1.346-3 3-3s3 1.346 3 3-1.346 3-3 3-3-1.346-3-3zm-4 0l.002-.034-3.015 2.175v-13.068l4-2.886v10.247c.508-.854 1.189-1.591 2-2.161v-8.086l4 2.886v3.927h.013c.336 0 .664.032.987.078v-4.007l4-2.479v8.504c1.188 1.208 1.936 2.844 2 4.653v-16.749l-6.455 4-5.545-4-5.545 4-6.455-4v18l6.455 4 3.91-2.82c-.226-.687-.352-1.419-.352-2.18zm-4.013 2.365l-4-2.479v-13.294l4 2.479v13.294z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="screen" viewBox="0 0 24 24">\n\t\t\t\t<path d="M0 0v19h24v-19h-24zm22 14h-20v-12h20v12zm-6.599 7l2.599 3h-12l2.599-3h6.802z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="chat" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22 3v13h-11.643l-4.357 3.105v-3.105h-4v-13h20zm2-2h-24v16.981h4v5.019l7-5.019h13v-16.981z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="send" viewBox="0 0 24 24">\n\t\t\t\t<path d="M22 12l-20 12 5-12-5-12z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="users" viewBox="0 0 24 24">\n\t\t\t\t<path d="M10.644 17.08c2.866-.662 4.539-1.241 3.246-3.682-3.932-7.427-1.042-11.398 3.111-11.398 4.235 0 7.054 4.124 3.11 11.398-1.332 2.455.437 3.034 3.242 3.682 2.483.574 2.647 1.787 2.647 3.889v1.031h-18c0-2.745-.22-4.258 2.644-4.92zm-12.644 4.92h7.809c-.035-8.177 3.436-5.313 3.436-11.127 0-2.511-1.639-3.873-3.748-3.873-3.115 0-5.282 2.979-2.333 8.549.969 1.83-1.031 2.265-3.181 2.761-1.862.43-1.983 1.34-1.983 2.917v.773z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="virtual-tour" viewBox="0 0 24 24">\n\t\t\t\t<path d="M17 17h-10v-10h10v10zm7 3l-5-3v-10l5-3v16zm-24-16l5 3v10l-5 3v-16z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="live-meeting" viewBox="0 0 24 24">\n\t\t\t\t<path d="M18 18h6v6h-6v-6zm-9 6h6v-6h-6v6zm-9 0h6v-6h-6v6zm0-8h24v-16h-24v16z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="control" viewBox="0 0 24 24">\n\t\t\t\t<circle cx="7" cy="10" r="1"></circle>\n\t\t\t\t<path d="M17,3H7c-3.9,0-7,3.1-7,7v6c0,2.8,2.2,5,5,5c2.4,0,4.4-1.7,4.9-4h4.2c0.5,2.7,3.2,4.5,5.9,3.9c2.3-0.5,4-2.5,4-4.9v-6 C24,6.1,20.9,3,17,3z M17,7c0.6,0,1,0.4,1,1s-0.4,1-1,1s-1-0.4-1-1S16.4,7,17,7z M7,13c-1.7,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3 S8.7,13,7,13z M15,11c-0.6,0-1-0.4-1-1s0.4-1,1-1s1,0.4,1,1S15.6,11,15,11z M17,13c-0.6,0-1-0.4-1-1c0-0.6,0.4-1,1-1s1,0.4,1,1 C18,12.5,17.6,13,17,13z M19,11c-0.6,0-1-0.4-1-1s0.4-1,1-1s1,0.4,1,1S19.6,11,19,11z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="spy" viewBox="0 0 24 24">\n\t\t\t\t<path fill-rule="evenodd" d="M0.2,11.4c5.2-8.6,18.3-8.5,23.6,0c0.2,0.3,0.2,0.8,0,1.2c-5.3,8.4-18.4,8.6-23.6,0 C-0.1,12.2-0.1,11.7,0.2,11.4z M12,7.8c2.3,0,4.2,1.9,4.2,4.3s-1.9,4.2-4.2,4.2S7.8,14.3,7.8,12S9.7,7.8,12,7.8z" clip-rule="evenodd"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="joystick" viewBox="0 0 24 24">\n\t\t\t\t<path d="M10.7,10.5V16H9.3C8.6,16,8,16.6,8,17.3h8c0-0.7-0.6-1.3-1.3-1.3h-1.3v-5.5c2.8-0.7,4.5-3.6,3.8-6.5 c-0.7-2.8-3.6-4.5-6.5-3.8S6.1,3.9,6.9,6.7C7.3,8.6,8.8,10,10.7,10.5z"></path>\n\t\t\t\t<path d="M1.4,18.6h21.2c0.7,0,1.3,0.6,1.3,1.3v2.7c0,0.7-0.6,1.3-1.3,1.3H1.4c-0.7,0-1.3-0.6-1.3-1.3V20 C0.1,19.2,0.7,18.6,1.4,18.6z"></path>\n\t\t\t</symbol>\n\t\t\t<symbol id="navinfo" viewBox="0 0 24 24">\n\t\t\t\t<path d="M12,2c5.5,0,10,4.5,10,10s-4.5,10-10,10S2,17.5,2,12S6.5,2,12,2z M12,0C5.4,0,0,5.4,0,12s5.4,12,12,12s12-5.4,12-12 S18.6,0,12,0z"/>\n\t\t\t\t<path d="M13,18h-2v-8h2V18z M12,5.8c0.7,0,1.2,0.6,1.2,1.2S12.7,8.2,12,8.2S10.8,7.7,10.8,7S11.3,5.8,12,5.8z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="check" viewBox="0 0 24 24">\n\t\t\t\t<path d="M9,21l-9-8.6l2.8-2.9l6.2,5.9L21.2,3L24,5.8L9,21z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="duplicate" viewBox="0 0 24 24">\n\t\t\t\t<path d="M18,6V0H0v18h6v6h18V6H18z M6,16H2V2h14v4H6V16z M22,22H8V8h14V22z M19,14h-3v-3h-2v3h-3v2h3v3h2v-3h3V14z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="trash" viewBox="0 0 24 24">\n\t\t\t\t<path fill-rule="evenodd" d="M19,24H5c-1.1,0-2-0.9-2-2V5H2V3h6V1.5C8,0.7,8.7,0,9.5,0h5C15.3,0,16,0.7,16,1.5V3h6v2h-1v17 C21,23.1,20.1,24,19,24z M19,5H5v16.5C5,21.8,5.2,22,5.5,22h13c0.3,0,0.5-0.2,0.5-0.5V5z M10,9c0-0.6-0.4-1-1-1S8,8.4,8,9v9 c0,0.6,0.4,1,1,1s1-0.4,1-1V9z M16,9c0-0.6-0.4-1-1-1s-1,0.4-1,1v9c0,0.6,0.4,1,1,1s1-0.4,1-1V9z M14,2h-4v1h4V2z" clip-rule="evenodd"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="flags" viewBox="0 0 24 24">\n\t\t\t\t<path d="M19,18c0,1.1-0.9,2-2,2s-2-0.9-2-2s0.9-2,2-2S19,16.9,19,18z M5,15c-1.7,0-3,1.3-3,3s1.3,3,3,3h14c1.7,0,3-1.3,3-3 s-1.3-3-3-3H5z M24,18c0,2.8-2.2,5-5,5H5c-2.8,0-5-2.2-5-5s2.2-5,5-5h14C21.8,13,24,15.2,24,18z M7,4C5.9,4,5,4.9,5,6s0.9,2,2,2 s2-0.9,2-2S8.1,4,7,4z M5,3C3.3,3,2,4.3,2,6s1.3,3,3,3h14c1.7,0,3-1.3,3-3s-1.3-3-3-3H5z M24,6c0,2.8-2.2,5-5,5H5c-2.8,0-5-2.2-5-5 s2.2-5,5-5h14C21.8,1,24,3.2,24,6z"/>\n\t\t\t</symbol>\n\t\t\t<symbol id="b-here" viewBox="0 0 270 98">\n\t\t\t\t<path d="M61.5,87.9c0-2.7,0.9-5,2.8-6.9c1.9-1.9,4.2-2.8,7-2.8c1.4,0,2.7,0.2,3.9,0.8c1.2,0.5,2.2,1.2,3.2,2 c0.9,0.9,1.6,1.9,2.1,3.1s0.8,2.5,0.8,3.8s-0.2,2.6-0.8,3.8c-0.5,1.2-1.2,2.2-2.1,3.1s-1.9,1.6-3.2,2.1c-1.2,0.5-2.5,0.8-3.9,0.8 s-2.7-0.2-3.9-0.8c-1.2-0.5-2.2-1.2-3.1-2.1s-1.6-1.9-2.1-3.1S61.5,89.2,61.5,87.9z"></path>\n\t\t\t\t<path d="M16,70.2H0.7v-70H16V29c0.6-1.1,1.4-2.1,2.4-3.1s2.2-1.9,3.5-2.6s2.8-1.3,4.2-1.8c1.5-0.4,3-0.6,4.6-0.6 c3.5,0,6.7,0.6,9.6,1.9s5.4,3.1,7.4,5.3c2.1,2.2,3.7,4.9,4.8,8s1.7,6.4,1.7,10.1c0,3.6-0.6,6.9-1.7,10c-1.1,3.1-2.7,5.8-4.8,8 c-2.1,2.2-4.5,4-7.4,5.3s-6.1,2-9.6,2c-1.6,0-3.1-0.2-4.6-0.7c-1.5-0.4-2.9-1-4.2-1.7c-1.3-0.7-2.5-1.5-3.5-2.5s-1.8-2-2.4-3.1 C16,63.5,16,70.2,16,70.2z M27.6,58.5c1.7,0,3.2-0.3,4.6-1c1.4-0.7,2.6-1.5,3.6-2.7c1-1.1,1.8-2.4,2.4-3.9c0.6-1.5,0.8-3.1,0.8-4.8 s-0.3-3.2-0.8-4.7c-0.6-1.5-1.4-2.8-2.4-3.9c-1-1.1-2.2-2-3.6-2.7c-1.4-0.7-2.9-1-4.6-1s-3.3,0.3-4.8,1c-1.4,0.7-2.7,1.6-3.7,2.7 c-1,1.1-1.8,2.4-2.3,3.9c-0.6,1.5-0.8,3-0.8,4.7s0.3,3.2,0.8,4.8s1.3,2.8,2.3,3.9c1,1.1,2.2,2,3.7,2.7 C24.3,58.2,25.9,58.5,27.6,58.5z"></path>\n\t\t\t\t<path d="M64.1,0.2h14.8V29c1.3-2.5,3.3-4.5,6-6s5.9-2.2,9.6-2.2c3.1,0,5.8,0.5,7.9,1.4c2.1,1,3.9,2.3,5.2,4.1 c1.5,1.9,2.6,4,3.1,6.5s0.8,5.4,0.8,8.9v28.5H96.7V45.5c0-3.5-0.6-6.3-1.8-8.5c-1.2-2.2-3.5-3.2-6.7-3.2c-3.1,0-5.5,1.1-7,3.3 s-2.3,5.2-2.3,8.9v24.2H64.1V0.2z"></path>\n\t\t\t\t<path d="M135.9,49.8c0.1,1.5,0.3,2.9,0.7,4.2s1,2.4,1.8,3.4s1.9,1.7,3.2,2.3s3,0.8,5,0.8c2.7,0,4.7-0.5,6-1.6 c1.4-1.1,2.3-2.4,2.9-3.9h15c-0.3,2.3-1.1,4.4-2.4,6.4c-1.2,2-2.9,3.8-4.9,5.2c-2,1.5-4.4,2.7-7.2,3.5c-2.8,0.9-5.9,1.3-9.3,1.3 c-4.2,0-7.9-0.6-11.2-1.8c-3.2-1.2-6-3-8.2-5.2c-2.2-2.3-3.9-5-5-8c-1.1-3.1-1.7-6.5-1.7-10.2c0-3.5,0.5-6.8,1.6-9.9s2.7-5.8,4.9-8 c2.2-2.3,4.8-4.1,8-5.5c3.2-1.3,6.8-2,11-2c3.8,0,7.2,0.6,10.2,1.8c3,1.2,5.6,2.8,7.8,4.8s3.8,4.3,5,7s1.8,5.5,1.8,8.4 c0,1,0,2.1,0,3.2c0,1.1-0.2,2.4-0.5,3.9h-34.5V49.8z M146.2,31c-3,0-5.5,0.9-7.4,2.6c-1.9,1.7-2.9,4.2-2.9,7.5h20.2 c0-3.1-0.9-5.6-2.8-7.4C151.5,31.9,149.1,31,146.2,31z"></path>\n\t\t\t\t<path d="M216.1,36c-1.1-0.3-2-0.5-2.7-0.6c-0.7-0.1-1.6-0.1-2.7-0.1c-4.2,0-7.6,1.2-10.1,3.7s-3.8,6.6-3.8,12.5v18.8h-15.3V22h15.3 v7.8c1.1-2.3,3-4.3,5.7-6c2.6-1.7,5.6-2.6,9-2.6c1.8,0,3.3,0.3,4.6,0.8V36z"></path>\n\t\t\t\t<path d="M234.3,49.8c0.1,1.5,0.3,2.9,0.7,4.2s1,2.4,1.8,3.4s1.9,1.7,3.2,2.3s3,0.8,5,0.8c2.7,0,4.7-0.5,6-1.6 c1.4-1.1,2.3-2.4,2.9-3.9h15c-0.3,2.3-1.1,4.4-2.4,6.4c-1.2,2-2.9,3.8-4.9,5.2c-2,1.5-4.4,2.7-7.2,3.5c-2.8,0.9-5.9,1.3-9.3,1.3 c-4.2,0-7.9-0.6-11.2-1.8c-3.2-1.2-6-3-8.2-5.2c-2.2-2.3-3.9-5-5-8c-1.1-3.1-1.7-6.5-1.7-10.2c0-3.5,0.5-6.8,1.6-9.9s2.7-5.8,4.9-8 c2.2-2.3,4.8-4.1,8-5.5c3.2-1.3,6.8-2,11-2c3.8,0,7.2,0.6,10.2,1.8c3,1.2,5.6,2.8,7.8,4.8c2.2,2,3.8,4.3,5,7s1.8,5.5,1.8,8.4 c0,1,0,2.1,0,3.2c0,1.1-0.2,2.4-0.5,3.9h-34.5V49.8z M244.6,31c-3,0-5.5,0.9-7.4,2.6c-1.9,1.7-2.9,4.2-2.9,7.5h20.2 c0-3.1-0.9-5.6-2.8-7.4C249.9,31.9,247.5,31,244.6,31z"></path>\n\t\t\t</symbol>\n\t\t</svg>\n\t\n\t\t\x3c!-- header --\x3e\n\t\t<router-outlet></router-outlet>\n\t\t\x3c!-- footer --\x3e\n\t\t<div class="toast-outlet" toast-outlet></div>\n\t\t<div class="modal-outlet" modal-outlet></div>\n\t'};const ba=["bmp","gif","ico","jpeg","jpg","png","svg","tif","tiff","webp","hdr"],Ta=["mp4","avi","mpeg","ogv","ts","webm","3gp","3g2"],ya=["fbx","gltf","glb","obj","usdz"],wa=["publisherStream","nextAttendeeStream","publisherScreen","attendeeScreen"];class Ca extends t.Pipe{static transform(t,e){if(void 0===e&&(e=null),null!=e&&(t=t.type.name===e?t:null),t){if("string"==typeof t)return x.getPath(t);switch(t.type.name){case ns.Image.name:case ns.Video.name:case ns.Model.name:t=t.folder+t.file,t=x.getPath(t);break;case ns.PublisherStream.name:case ns.AttendeeStream.name:case ns.PublisherScreen.name:case ns.AttendeeScreen.name:case ns.SmartDeviceStream.name:t=x.getPath(t.file);break;default:i=t.file,new RegExp(`/.(${ba.join("|")})$/i`).test(i)||function(t){return new RegExp(`/.(${Ta.join("|")})$/i`).test(t)}(t.file)?(t=t.folder+t.file,t=x.getPath(t)):!function(t){return new RegExp(`/.(${ya.join("|")})$/i`).test(t)}(t.file)?function(t){return-1!==wa.indexOf(t)}(t.file)&&(t=t.file):(t=t.folder+t.file,t=x.getPath(t))}}else t=null;var i;return t}}Ca.meta={name:"asset"};class Ra extends t.Component{onInit(){super.onInit();const{parentInstance:e}=t.getContext(this);e instanceof Qn&&(this.data=e.modal.data)}onAccept(t){an.resolve()}onReject(t){an.reject()}onClose(){an.reject()}}Ra.meta={selector:"[control-request-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">L\'utente ha richiesto il controllo della navigazione. Accetti?</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--cancel" (click)="onReject()">\n\t\t\t\t\t\t<span>Rifiuta</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onAccept()">\n\t\t\t\t\t\t<span>Accetta</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},Ra.chunk=()=>'<div class="control-request-modal" control-request-modal></div>';class Ia extends t.Directive{onInit(){const{module:e,node:s,parentInstance:o,selector:r}=t.getContext(this),a="drop",c=i.fromEvent(s,a).pipe(n.shareReplay(1)),l=s.getAttribute("(drop)");if(l){const t=e.makeFunction(l,["$event"]);c.pipe(n.takeUntil(this.unsubscribe$)).subscribe((i=>{e.resolve(t,o,i)})),i.fromEvent(s,"dragover").pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>t.preventDefault()))}else o.drop$=c}}Ia.meta={selector:"[(drop)]"};let Aa=1e6;class Oa extends t.Directive{get id(){return this.dropdown||this.id_||(this.id_=Oa.nextId())}onInit(){const{node:e}=t.getContext(this),i=e.getAttribute("dropdown-trigger");this.trigger=i?e.querySelector(i):e,this.opened=null,this.onClick=this.onClick.bind(this),this.onDocumentClick=this.onDocumentClick.bind(this),this.openDropdown=this.openDropdown.bind(this),this.closeDropdown=this.closeDropdown.bind(this),this.addListeners(),Oa.dropdown$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.id===t?e.classList.add("dropped"):e.classList.remove("dropped")}))}onClick(e){const{node:i}=t.getContext(this);if(null===this.opened)this.openDropdown();else{i.querySelector("[dropdown-item]")||this.closeDropdown()}}onDocumentClick(e){const{node:i}=t.getContext(this);i===e.target||i.contains(e.target)||this.closeDropdown()}openDropdown(){null===this.opened&&(this.opened=!0,this.addDocumentListeners(),Oa.dropdown$.next(this.id),this.dropped.next(this.id))}closeDropdown(){null!==this.opened&&(this.removeDocumentListeners(),this.opened=null,Oa.dropdown$.getValue()===this.id&&(Oa.dropdown$.next(null),this.dropped.next(null)))}addListeners(){this.trigger.addEventListener("click",this.onClick)}addDocumentListeners(){document.addEventListener("click",this.onDocumentClick)}removeListeners(){this.trigger.removeEventListener("click",this.onClick)}removeDocumentListeners(){document.removeEventListener("click",this.onDocumentClick)}onDestroy(){this.removeListeners(),this.removeDocumentListeners()}static nextId(){return Aa++}}Oa.meta={selector:"[dropdown]",inputs:["dropdown","dropdown-trigger"],outputs:["dropped"]},Oa.dropdown$=new i.BehaviorSubject(null);class Na extends t.Directive{get id(){return this["dropdown-item"]}onInit(){const{node:e}=t.getContext(this);e.classList.add("dropdown-item"),Oa.dropdown$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.id===t?e.classList.add("dropped"):e.classList.remove("dropped")}))}}Na.meta={selector:"[dropdown-item], [[dropdown-item]]",inputs:["dropdown-item"]};class ka extends t.Component{onInit(){this.toast=null,this.lastToast=null,Xn.toast$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t&&(this.lastToast=t),this.toast=t,this.pushChanges()}))}getClass(){const t={};return this.toast&&(t.active=!0),this.lastToast&&(t[this.lastToast.type]=!0,t[this.lastToast.position]=!0),t}onClose(){Xn.reject(this.toast)}onAccept(){Xn.resolve(this.toast)}onReject(){Xn.reject(this.toast)}}ka.meta={selector:"[toast-outlet]",template:'\n\t<div class="toast-outlet__container" [class]="getClass()">\n\t\t<div class="toast-outlet__toast" *if="lastToast">\n\t\t\t<span class="toast-outlet__message" [innerHTML]="lastToast.message"></span>\n\t\t\t<div class="group--cta" *if="lastToast.type != \'info\'">\n\t\t\t\t<button type="button" class="btn--accept" (click)="onAccept()">\n\t\t\t\t\t<span [innerHTML]="lastToast.acceptMessage"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--cancel" (click)="onReject()" *if="lastToast.type == \'dialog\'">\n\t\t\t\t\t<span [innerHTML]="lastToast.rejectMessage"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t<button type="button" class="btn--close" (click)="onClose()" *if="lastToast.type != \'info\'">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t</div>\n\t'};class La extends t.Component{onInit(){this.mode=1,this.viewTypes=Object.keys(gn).map((t=>{const e=gn[t];return{type:e,name:ve.getKeys("editor",e.name),disabled:-1!==x.editor.disabledViewTypes.indexOf(e.name)}})),this.viewItemTypes=Object.keys(fn).map((t=>{const e=fn[t];return{type:e,name:ve.getKeys("editor",e.name),disabled:-1!==x.editor.disabledViewItemTypes.indexOf(e.name)}})),this.setSupportedViewTypes(),this.setSupportedViewItemTypes()}onChanges(){this.setSupportedViewTypes(),this.setSupportedViewItemTypes()}setSupportedViewTypes(){this.supportedViewTypes=this.viewTypes.filter((t=>this.supportedViewType(t.type.name))).sort(((t,e)=>t.disabled===e.disabled?0:t.disabled?1:-1))}setSupportedViewItemTypes(){this.view?this.supportedViewItemTypes=this.viewItemTypes.filter((t=>this.supportedViewItemType(this.view.type.name,t.type.name))).sort(((t,e)=>t.disabled===e.disabled?0:t.disabled?1:-1)):this.supportedViewItemTypes=[]}setMode(t){this.mode!==t&&(this.mode=t,this.pushChanges())}supportedViewType(t){return-1!==[gn.Panorama.name,gn.PanoramaGrid.name,gn.Room3d.name,gn.Model.name,gn.Media.name].indexOf(t)}supportedViewItemType(t,e){let i;switch(t){case gn.WaitingRoom.name:i=!1;break;case gn.Panorama.name:case gn.PanoramaGrid.name:i=-1!==[fn.Nav.name,fn.Model.name,fn.Plane.name,fn.CurvedPlane.name].indexOf(e);break;case gn.Room3d.name:i=-1!==[fn.Nav.name,fn.Model.name,fn.Plane.name,fn.Texture.name].indexOf(e);break;case gn.Model.name:i=-1!==[fn.Nav.name,fn.Model.name,fn.Plane.name,fn.CurvedPlane.name].indexOf(e);break;case gn.Media.name:i=-1!==[].indexOf(e)}return i}onSelect(t){this.select.next(t)}onUpdate(t){this.update.next(t)}onDelete(t){this.delete.next(t)}}La.meta={selector:"[aside]",outputs:["select","update","delete"],inputs:["view"],template:'\n\t<div class="headline">\n\t\t<ul class="nav--tab">\n\t\t\t<li [class]="{ active: mode === 1 }" (click)="setMode(1)" [innerHTML]="\'editor_properties\' | label"></li>\n\t\t\t<li [class]="{ active: mode === 2 }" (click)="setMode(2)" [innerHTML]="\'editor_views\' | label"></li>\n\t\t\t<li [class]="{ active: mode === 3 }" (click)="setMode(3)" [innerHTML]="\'editor_view_items\' | label"></li>\n\t\t</ul>\n\t\t\x3c!--\n\t\t<div class="btn--mode" [class]="{ active: mode === 1 }" (click)="setMode(1)" [innerHTML]="\'editor_properties\' | label"></div>\n\t\t<div class="btn--mode" [class]="{ active: mode === 2 }" (click)="setMode(2)" [innerHTML]="\'editor_views\' | label"></div>\n\t\t<div class="btn--mode" [class]="{ active: mode === 3 }" (click)="setMode(3)" [innerHTML]="\'editor_view_items\' | label"></div>\n\t\t--\x3e\n\t</div>\n\t<div class="scrollable">\n\t\t<ul class="nav--editor" *if="mode === 1">\n\t\t\t<li>\n\t\t\t\t<div class="title" [innerHTML]="\'editor_properties\' | label"></div>\n\t\t\t\t<update-view [view]="view" (select)="onSelect($event)" (update)="onUpdate($event)" (delete)="onDelete($event)"></update-view>\n\t\t\t</li>\n\t\t\t<li *if="view.type.name != \'panorama-grid\'">\n\t\t\t\t<div class="title" [innerHTML]="\'editor_items\' | label"></div>\n\t\t\t\t<update-view-item [view]="view" [item]="item" (select)="onSelect($event)" (update)="onUpdate($event)" (delete)="onDelete($event)" *for="let item of view.pathItems"></update-view-item>\n\t\t\t\t<div class="abstract" *if="view.pathItems.length == 0" [innerHTML]="\'editor_no_items\' | label"></div>\n\t\t\t\t<div class="btn--mode" (click)="setMode(3)" [innerHTML]="\'editor_add_item\' | label"></div>\n\t\t\t</li>\n\t\t\t<li *if="view.type.name == \'panorama-grid\'">\n\t\t\t\t<div class="title" [innerHTML]="\'editor_tiles\' | label"></div>\n\t\t\t\t<div *for="let tile of view.tiles">\n\t\t\t\t\t<div *if="tile.selected">\n\t\t\t\t\t\t<update-view-tile [view]="view" [tile]="tile" (update)="onUpdate($event)" (delete)="onDelete($event)"></update-view-tile>\n\t\t\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<update-view-item [view]="view" [item]="item" (select)="onSelect($event)" (update)="onUpdate($event)" (delete)="onDelete($event)" *for="let item of tile.navs"></update-view-item>\n\t\t\t\t\t\t\t\t<div class="abstract" *if="tile.navs.length == 0" [innerHTML]="\'editor_no_navs\' | label"></div>\n\t\t\t\t\t\t\t\t<div class="btn--mode" (click)="onSelect({ type:\'viewItem\', value: \'nav\', tile: tile })" [innerHTML]="\'editor_add_nav\' | label"></div>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\x3c!--\n\t\t\t\t\t\t\t<li>\n\t\t\t\t\t\t\t\t<div class="btn" (click)="onSelect({ type:\'viewItem\', value: \'nav\', tile: tile })">\n\t\t\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t\t\t<svg-icon name="nav"></svg-icon>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="title" [innerHTML]="\'editor_add_nav\' | label"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t--\x3e\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="abstract" *if="view.tiles.length == 0" [innerHTML]="\'editor_no_tiles\' | label"></div>\n\t\t\t\t\x3c!-- <div class="btn--mode" (click)="setMode(3)">Add Tile</div> --\x3e\n\t\t\t</li>\n\t\t\t\x3c!--\n\t\t\t<li *if="false">\n\t\t\t\t<div class="title">Icons</div>\n\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'animated-tabs\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 2 8.4 L 12 8.4 L 12 2 L 6 2 C 3.791 2 2 3.791 2 6 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 8.4 L 22 8.4 L 22 6 C 22 3.791 20.209 2 18 2 L 12 2 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Animated Tabs</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'card-list\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 6.8 13.6 C 6.8 13.158 7.158 12.8 7.6 12.8 L 16.8 12.8 C 17.242 12.8 17.6 13.158 17.6 13.6 L 17.6 16.8 C 17.6 17.242 17.242 17.6 16.8 17.6 L 7.6 17.6 C 7.158 17.6 6.8 17.242 6.8 16.8 Z" fill="var(--svg-icon-tint)"></path><path d="M 6.8 7.2 C 6.8 6.758 7.158 6.4 7.6 6.4 L 16.8 6.4 C 17.242 6.4 17.6 6.758 17.6 7.2 L 17.6 10.4 C 17.6 10.842 17.242 11.2 16.8 11.2 L 7.6 11.2 C 7.158 11.2 6.8 10.842 6.8 10.4 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Card List</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'container-transitions\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 15.667 13 C 17.139 13 18.333 14.194 18.333 15.667 C 18.333 17.139 17.139 18.333 15.667 18.333 C 14.194 18.333 13 17.139 13 15.667 C 13 14.194 14.194 13 15.667 13 Z" fill="var(--svg-icon-tint)"></path></svg></svg></div>\n\t\t\t\t\t\t\t<div class="title">Container Transitions</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'dynamic-grid\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><g transform="translate(6.6 6.6)"><path d="M 6.048 0.8 C 6.048 0.358 6.406 0 6.848 0 L 10 0 C 10.442 0 10.8 0.358 10.8 0.8 L 10.8 3.952 C 10.8 4.394 10.442 4.752 10 4.752 L 6.848 4.752 C 6.406 4.752 6.048 4.394 6.048 3.952 Z" fill="var(--svg-icon-tint)" opacity="0.5"></path><path d="M 6.048 6.848 C 6.048 6.406 6.406 6.048 6.848 6.048 L 10 6.048 C 10.442 6.048 10.8 6.406 10.8 6.848 L 10.8 10 C 10.8 10.442 10.442 10.8 10 10.8 L 6.848 10.8 C 6.406 10.8 6.048 10.442 6.048 10 Z" fill="var(--svg-icon-tint)"></path><path d="M 0 0.8 C 0 0.358 0.358 0 0.8 0 L 3.952 0 C 4.394 0 4.752 0.358 4.752 0.8 L 4.752 3.952 C 4.752 4.394 4.394 4.752 3.952 4.752 L 0.8 4.752 C 0.358 4.752 0 4.394 0 3.952 Z" fill="var(--svg-icon-tint)"></path><path d="M 0 6.848 C 0 6.406 0.358 6.048 0.8 6.048 L 3.952 6.048 C 4.394 6.048 4.752 6.406 4.752 6.848 L 4.752 10 C 4.752 10.442 4.394 10.8 3.952 10.8 L 0.8 10.8 C 0.358 10.8 0 10.442 0 10 Z" fill="var(--svg-icon-tint)" opacity="0.5"></path></g></svg></div>\n\t\t\t\t\t\t\t<div class="title">Dynamic Grid</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'expand-on-tap\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 0 0 L 7.833 0" transform="translate(8.583 11.583) rotate(270 3.917 0.5)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 14.667 9.333 L 12 6.667 L 9.333 9.333" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 14.667 14.667 L 12 17.333 L 9.333 14.667" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round"></path> </svg></div>\n\t\t\t\t\t\t\t<div class="title">Expand on Tap</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'image-gallery-2\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 10.333 7.333 C 10.886 7.333 11.333 7.781 11.333 8.333 L 11.333 10.333 C 11.333 10.886 10.886 11.333 10.333 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12.333 8.333 C 12.333 7.781 12.781 7.333 13.333 7.333 L 15.333 7.333 C 15.886 7.333 16.333 7.781 16.333 8.333 L 16.333 10.333 C 16.333 10.886 15.886 11.333 15.333 11.333 L 13.333 11.333 C 12.781 11.333 12.333 10.886 12.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.333 12.667 C 15.886 12.667 16.333 13.114 16.333 13.667 L 16.333 15.667 C 16.333 16.219 15.886 16.667 15.333 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Image Gallery 2</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'stories-ui\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 6.8 4.8 C 7.905 4.8 8.8 5.695 8.8 6.8 C 8.8 7.905 7.905 8.8 6.8 8.8 C 5.695 8.8 4.8 7.905 4.8 6.8 C 4.8 5.695 5.695 4.8 6.8 4.8 Z" fill="var(--svg-icon-tint)"></path><path d="M 12 4.8 C 13.105 4.8 14 5.695 14 6.8 C 14 7.905 13.105 8.8 12 8.8 C 10.895 8.8 10 7.905 10 6.8 C 10 5.695 10.895 4.8 12 4.8 Z" fill="var(--svg-icon-tint)"></path><path d="M 17.2 4.8 C 18.305 4.8 19.2 5.695 19.2 6.8 C 19.2 7.905 18.305 8.8 17.2 8.8 C 16.095 8.8 15.2 7.905 15.2 6.8 C 15.2 5.695 16.095 4.8 17.2 4.8 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Stories UI</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'todo-list\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8 12.333 L 10.5 14.833 L 16 9.333" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">To-Do List</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'toggle-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 17.333 15.333 C 18.438 15.333 19.333 16.229 19.333 17.333 C 19.333 18.438 18.438 19.333 17.333 19.333 C 16.229 19.333 15.333 18.438 15.333 17.333 C 15.333 16.229 16.229 15.333 17.333 15.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 17.333 10 C 18.438 10 19.333 10.895 19.333 12 C 19.333 13.105 18.438 14 17.333 14 C 16.229 14 15.333 13.105 15.333 12 C 15.333 10.895 16.229 10 17.333 10 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 17.333 4.667 C 18.438 4.667 19.333 5.562 19.333 6.667 C 19.333 7.771 18.438 8.667 17.333 8.667 C 16.229 8.667 15.333 7.771 15.333 6.667 C 15.333 5.562 16.229 4.667 17.333 4.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Toggle Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'bottom-sheet\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 10.333 C 22 10.886 21.552 11.333 21 11.333 L 3 11.333 C 2.448 11.333 2 10.886 2 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 2 13.333 C 2 12.781 2.448 12.333 3 12.333 L 21 12.333 C 21.552 12.333 22 12.781 22 13.333 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Bottom Sheet</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'draggable-sheet\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 2 14 C 2 12.895 2.895 12 4 12 L 20 12 C 21.105 12 22 12.895 22 14 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z M 10.667 15.333 L 13.333 15.333 C 13.702 15.333 14 15.035 14 14.667 C 14 14.298 13.702 14 13.333 14 L 10.667 14 C 10.298 14 10 14.298 10 14.667 C 10 15.035 10.298 15.333 10.667 15.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Draggable Sheet</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'modal-box\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 9.333 C 7.333 8.229 8.229 7.333 9.333 7.333 L 14.667 7.333 C 15.771 7.333 16.667 8.229 16.667 9.333 L 16.667 14.667 C 16.667 15.771 15.771 16.667 14.667 16.667 L 9.333 16.667 C 8.229 16.667 7.333 15.771 7.333 14.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Modal Box</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'side-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 11 2 C 11.552 2 12 2.448 12 3 L 12 21 C 12 21.552 11.552 22 11 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Side Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'input-form\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 11.667 7.333 C 11.667 7.333 11.667 7.333 11.667 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 9 C 16.667 9.552 16.219 10 15.667 10 L 13.333 10 L 13.333 15.667 C 13.333 16.219 12.886 16.667 12.333 16.667 L 11.667 16.667 C 11.114 16.667 10.667 16.219 10.667 15.667 L 10.667 10 L 8.333 10 C 7.781 10 7.333 9.552 7.333 9 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Input Form</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'loading-indicator\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 16.4 10.4 C 17.284 10.4 18 11.116 18 12 C 18 12.884 17.284 13.6 16.4 13.6 C 15.516 13.6 14.8 12.884 14.8 12 C 14.8 11.116 15.516 10.4 16.4 10.4 Z" fill="var(--svg-icon-tint)"></path><path d="M 12 10.4 C 12.884 10.4 13.6 11.116 13.6 12 C 13.6 12.884 12.884 13.6 12 13.6 C 11.116 13.6 10.4 12.884 10.4 12 C 10.4 11.116 11.116 10.4 12 10.4 Z" fill="var(--svg-icon-tint)"></path><path d="M 7.6 10.4 C 8.484 10.4 9.2 11.116 9.2 12 C 9.2 12.884 8.484 13.6 7.6 13.6 C 6.716 13.6 6 12.884 6 12 C 6 11.116 6.716 10.4 7.6 10.4 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Loading Indicator</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'radio-button-form\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 9.833 8.167 L 14.167 8.167 C 16.284 8.167 18 9.883 18 12 C 18 14.117 16.284 15.833 14.167 15.833 L 9.833 15.833 C 7.716 15.833 6 14.117 6 12 C 6 9.883 7.716 8.167 9.833 8.167 Z M 11.333 12 C 11.333 13.473 12.527 14.667 14 14.667 C 15.473 14.667 16.667 13.473 16.667 12 C 16.667 10.527 15.473 9.333 14 9.333 C 12.527 9.333 11.333 10.527 11.333 12 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Radio Button Form</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'checkbox-form\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8.651 6.931 C 7.911 6.738 7.238 7.411 7.431 8.151 L 9.363 15.558 C 9.592 16.435 10.775 16.58 11.208 15.784 L 13 12.5 L 16.284 10.708 C 17.08 10.275 16.935 9.092 16.058 8.863 Z" fill="var(--svg-icon-tint)"></path><path d="M 16 15.5 L 11 10.5" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Checkbox Form</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'splash-screen\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.757 13.414 C 6.976 12.633 6.976 11.367 7.757 10.586 L 10.586 7.757 C 11.367 6.976 12.633 6.976 13.414 7.757 L 16.243 10.586 C 17.024 11.367 17.024 12.633 16.243 13.414 L 13.414 16.243 C 12.633 17.024 11.367 17.024 10.586 16.243 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Splash Screen</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'timeout-transition\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1 5.8 C 1 3.149 3.149 1 5.8 1 L 18.2 1 C 20.851 1 23 3.149 23 5.8 L 23 18.2 C 23 20.851 20.851 23 18.2 23 L 5.8 23 C 3.149 23 1 20.851 1 18.2 Z" fill="var(--svg-icon-tint)" opacity="0.3"></path><path d="M 12 6.72 C 14.916 6.72 17.28 9.084 17.28 12 C 17.28 14.916 14.916 17.28 12 17.28 C 9.084 17.28 6.72 14.916 6.72 12 C 6.72 9.084 9.084 6.72 12 6.72 Z M 11.34 12 C 11.34 12.365 11.635 12.66 12 12.66 L 14.2 12.66 C 14.565 12.66 14.86 12.365 14.86 12 C 14.86 11.635 14.565 11.34 14.2 11.34 L 12.66 11.34 L 12.66 9.8 C 12.66 9.435 12.365 9.14 12 9.14 C 11.635 9.14 11.34 9.435 11.34 9.8 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Timeout Transition</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'accordion-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 16 10.667 L 12 14.667 L 8 10.667" fill="transparent" stroke-width="2" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Accordion Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'drop-on-scroll\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 0 0 L 8 0" transform="translate(8.5 11.5) rotate(270 4 0.5)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 15.333 11.333 L 12 8 L 8.667 11.333" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Drop on Scroll</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'nested-scroll\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 7 C 21.82 7.552 21.372 8 20.82 8 L 2.82 8 C 2.267 8 1.82 7.552 1.82 7 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 1.82 17 C 1.82 16.448 2.267 16 2.82 16 L 20.82 16 C 21.372 16 21.82 16.448 21.82 17 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 8.82 10 C 8.82 9.448 9.267 9 9.82 9 L 20.82 9 C 21.372 9 21.82 9.448 21.82 10 L 21.82 14 C 21.82 14.552 21.372 15 20.82 15 L 9.82 15 C 9.267 15 8.82 14.552 8.82 14 Z" fill="var(--svg-icon-tint)"></path><path d="M 1.82 10 C 1.82 9.448 2.267 9 2.82 9 L 6.82 9 C 7.372 9 7.82 9.448 7.82 10 L 7.82 14 C 7.82 14.552 7.372 15 6.82 15 L 2.82 15 C 2.267 15 1.82 14.552 1.82 14 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Nested Scroll</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'star-rating\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 11.399 6.884 C 11.645 6.386 12.355 6.386 12.601 6.884 L 13.705 9.122 C 13.803 9.32 13.992 9.457 14.21 9.489 L 16.68 9.848 C 17.229 9.928 17.449 10.603 17.051 10.99 L 15.264 12.733 C 15.106 12.887 15.034 13.108 15.071 13.326 L 15.493 15.786 C 15.587 16.333 15.013 16.75 14.521 16.492 L 12.312 15.331 C 12.117 15.228 11.883 15.228 11.688 15.331 L 9.479 16.492 C 8.987 16.75 8.413 16.333 8.507 15.786 L 8.929 13.326 C 8.966 13.108 8.894 12.887 8.736 12.733 L 6.949 10.99 C 6.551 10.603 6.771 9.928 7.32 9.848 L 9.79 9.489 C 10.008 9.457 10.197 9.32 10.295 9.122 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Star Rating</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'swipe-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 17.33 C 2 16.595 2.595 16 3.33 16 L 21 16 C 21.552 16 22 16.448 22 17 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 2 10 C 2 9.448 2.448 9 3 9 L 14 9 C 14.552 9 15 9.448 15 10 L 15 14 C 15 14.552 14.552 15 14 15 L 3 15 C 2.448 15 2 14.552 2 14 Z M 19 9 C 20.657 9 22 10.343 22 12 C 22 13.657 20.657 15 19 15 C 17.343 15 16 13.657 16 12 C 16 10.343 17.343 9 19 9 Z" fill="var(--svg-icon-tint)"></path><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 7 C 22 7.552 21.552 8 21 8 L 3 8 C 2.448 8 2 7.552 2 7 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Swipe Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'switch-sheet\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 15.667 13.333 C 17.139 13.333 18.333 14.527 18.333 16 C 18.333 17.473 17.139 18.667 15.667 18.667 C 14.194 18.667 13 17.473 13 16 C 13 14.527 14.194 13.333 15.667 13.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 8.333 13.333 C 9.806 13.333 11 14.527 11 16 C 11 17.473 9.806 18.667 8.333 18.667 C 6.861 18.667 5.667 17.473 5.667 16 C 5.667 14.527 6.861 13.333 8.333 13.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Switch Sheet</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'tab-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 10 15.333 L 14 15.333 L 14 18.667 L 10 18.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 5.333 16.333 C 5.333 15.781 5.781 15.333 6.333 15.333 L 9.333 15.333 L 9.333 18.667 L 6.333 18.667 C 5.781 18.667 5.333 18.219 5.333 17.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 18.667 16.333 C 18.667 15.781 18.219 15.333 17.667 15.333 L 14.667 15.333 L 14.667 18.667 L 17.667 18.667 C 18.219 18.667 18.667 18.219 18.667 17.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Tab Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'wheel-picker\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 3.667 6 C 3.667 3.791 5.458 2 7.667 2 L 16.333 2 C 18.542 2 20.333 3.791 20.333 6 L 20.333 7 C 20.333 7.552 19.886 8 19.333 8 L 4.667 8 C 4.114 8 3.667 7.552 3.667 7 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 2 11 C 2 9.895 2.895 9 4 9 L 20 9 C 21.105 9 22 9.895 22 11 L 22 13 C 22 14.105 21.105 15 20 15 L 4 15 C 2.895 15 2 14.105 2 13 Z" fill="var(--svg-icon-tint)"></path><path d="M 3.667 17 C 3.667 16.448 4.114 16 4.667 16 L 19.333 16 C 19.886 16 20.333 16.448 20.333 17 L 20.333 18 C 20.333 20.209 18.542 22 16.333 22 L 7.667 22 C 5.458 22 3.667 20.209 3.667 18 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Wheel Picker</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'cover-flow\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 11.333 17.962 C 11.333 18.385 11.068 18.762 10.67 18.904 L 4.673 21.045 C 3.37 21.511 2 20.545 2 19.162 L 2 4.838 C 2 3.455 3.37 2.489 4.673 2.955 L 10.67 5.096 C 11.068 5.238 11.333 5.615 11.333 6.038 Z" fill="var(--svg-icon-tint)"></path><path d="M 22 4.838 C 22 3.455 20.63 2.489 19.327 2.955 L 13.33 5.096 C 12.932 5.238 12.667 5.615 12.667 6.038 L 12.667 17.962 C 12.667 18.385 12.932 18.762 13.33 18.904 L 19.327 21.045 C 20.63 21.511 22 20.545 22 19.162 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Cover Flow</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'cube-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6.743 C 2 5.898 2.531 5.144 3.327 4.859 L 9.997 2.477 C 10.648 2.245 11.333 2.727 11.333 3.419 L 11.333 20.581 C 11.333 21.273 10.648 21.755 9.997 21.523 L 3.327 19.141 C 2.531 18.856 2 18.102 2 17.257 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12.667 3.419 C 12.667 2.727 13.352 2.245 14.003 2.477 L 20.673 4.859 C 21.469 5.144 22 5.898 22 6.743 L 22 17.257 C 22 18.102 21.469 18.856 20.673 19.141 L 14.003 21.523 C 13.352 21.755 12.667 21.273 12.667 20.581 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Cube Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'flip-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 11.333 4.667 C 11.333 4.114 10.886 3.667 10.333 3.667 L 4 3.667 C 2.895 3.667 2 4.562 2 5.667 L 2 18.333 C 2 19.438 2.895 20.333 4 20.333 L 10.333 20.333 C 10.886 20.333 11.333 19.886 11.333 19.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 20 4.167 C 20 3.891 20.224 3.667 20.5 3.667 L 20.5 3.667 C 21.328 3.667 22 4.338 22 5.167 L 22 18.833 C 22 19.662 21.328 20.333 20.5 20.333 L 20.5 20.333 C 20.224 20.333 20 20.109 20 19.833 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 18.667 4.631 C 18.667 3.309 17.406 2.35 16.131 2.704 L 13.399 3.463 C 12.966 3.583 12.667 3.978 12.667 4.427 L 12.667 19.573 C 12.667 20.022 12.966 20.417 13.399 20.537 L 16.131 21.296 C 17.406 21.65 18.667 20.691 18.667 19.369 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Flip Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'parallax-scroll\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 6.667 C 12 5.562 12.895 4.667 14 4.667 L 17.333 4.667 C 18.438 4.667 19.333 5.562 19.333 6.667 L 19.333 10 C 19.333 11.105 18.438 12 17.333 12 L 14 12 C 12.895 12 12 11.105 12 10 Z" fill="var(--svg-icon-tint)"></path><path d="M 4.667 14 C 4.667 12.895 5.562 12 6.667 12 L 10 12 C 11.105 12 12 12.895 12 14 L 12 17.333 C 12 18.438 11.105 19.333 10 19.333 L 6.667 19.333 C 5.562 19.333 4.667 18.438 4.667 17.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Parallax Scroll</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'pile-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 6.5 4 C 6.224 4 6 3.776 6 3.5 L 6 3.5 C 6 2.672 6.672 2 7.5 2 L 16.5 2 C 17.328 2 18 2.672 18 3.5 L 18 3.5 C 18 3.776 17.776 4 17.5 4 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 4.5 7 C 4.224 7 4 6.776 4 6.5 L 4 6.5 C 4 5.672 4.672 5 5.5 5 L 18.5 5 C 19.328 5 20 5.672 20 6.5 L 20 6.5 C 20 6.776 19.776 7 19.5 7 Z" fill="var(--svg-icon-tint)" opacity="0.7"></path><path d="M 0 2.67 C 0 1.195 1.195 0 2.67 0 L 11.33 0 C 12.805 0 14 1.195 14 2.67 L 14 17.33 C 14 18.805 12.805 20 11.33 20 L 2.67 20 C 1.195 20 0 18.805 0 17.33 Z" transform="translate(5 5) rotate(-90 7 10)" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Pile Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'shuffle\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 15.174 10.452 L 16.708 9.06 L 15.174 7.667" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 15.174 16.333 L 16.708 14.94 L 15.174 13.548" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 16.145 9.06 C 16.145 9.06 13.982 8.542 12.617 9.679 C 11.252 10.815 11.829 12.213 10.776 13.548 C 9.724 14.882 7.708 14.94 7.708 14.94" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 16.145 14.823 C 16.145 14.823 13.982 15.34 12.617 14.204 C 11.252 13.068 11.829 11.669 10.776 10.335 C 9.724 9.001 7.708 8.942 7.708 8.942" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Shuffle</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'svg-animation\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8 12.333 L 10.5 14.833 L 16 9.333" stroke="var(--svg-icon-tint)" fill="transparent" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">SVG Animation</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'google-sheets\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7 8.667 C 7 8.206 7.373 7.833 7.833 7.833 L 7.833 7.833 C 8.294 7.833 8.667 8.206 8.667 8.667 L 8.667 8.667 C 8.667 9.127 8.294 9.5 7.833 9.5 L 7.833 9.5 C 7.373 9.5 7 9.127 7 8.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 7 12 C 7 11.54 7.373 11.167 7.833 11.167 L 7.833 11.167 C 8.294 11.167 8.667 11.54 8.667 12 L 8.667 12 C 8.667 12.46 8.294 12.833 7.833 12.833 L 7.833 12.833 C 7.373 12.833 7 12.46 7 12 Z" fill="var(--svg-icon-tint)"></path><path d="M 7 15.333 C 7 14.873 7.373 14.5 7.833 14.5 L 7.833 14.5 C 8.294 14.5 8.667 14.873 8.667 15.333 L 8.667 15.333 C 8.667 15.794 8.294 16.167 7.833 16.167 L 7.833 16.167 C 7.373 16.167 7 15.794 7 15.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 9.778 8.667 C 9.778 8.206 10.151 7.833 10.611 7.833 L 16.167 7.833 C 16.627 7.833 17 8.206 17 8.667 L 17 8.667 C 17 9.127 16.627 9.5 16.167 9.5 L 10.611 9.5 C 10.151 9.5 9.778 9.127 9.778 8.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 9.778 12 C 9.778 11.54 10.151 11.167 10.611 11.167 L 16.167 11.167 C 16.627 11.167 17 11.54 17 12 L 17 12 C 17 12.46 16.627 12.833 16.167 12.833 L 10.611 12.833 C 10.151 12.833 9.778 12.46 9.778 12 Z" fill="var(--svg-icon-tint)"></path><path d="M 9.778 15.333 C 9.778 14.873 10.151 14.5 10.611 14.5 L 16.167 14.5 C 16.627 14.5 17 14.873 17 15.333 L 17 15.333 C 17 15.794 16.627 16.167 16.167 16.167 L 10.611 16.167 C 10.151 16.167 9.778 15.794 9.778 15.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Google Sheets</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'map\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 11.82 6.504 C 14.029 6.504 15.82 8.282 15.82 10.476 C 15.82 10.698 15.801 10.915 15.766 11.127 C 15.359 14.488 13.033 16.581 12.155 17.261 C 12.051 17.341 11.976 17.437 11.82 17.437 C 11.663 17.437 11.586 17.34 11.481 17.258 C 10.6 16.576 8.28 14.483 7.873 11.127 C 7.838 10.915 7.82 10.698 7.82 10.476 C 7.82 8.282 9.61 6.504 11.82 6.504 Z M 9.486 10.644 C 9.486 11.933 10.531 12.977 11.82 12.977 C 13.108 12.977 14.153 11.933 14.153 10.644 C 14.153 9.355 13.108 8.311 11.82 8.311 C 10.531 8.311 9.486 9.355 9.486 10.644 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Map</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'signature-pad\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 8.82 13.068 C 8.56 12.807 8.56 12.385 8.82 12.125 L 13.733 7.212 C 13.993 6.952 14.415 6.952 14.676 7.212 L 16.788 9.324 C 17.048 9.585 17.048 10.007 16.788 10.267 L 11.875 15.18 C 11.615 15.44 11.193 15.44 10.932 15.18 Z" fill="var(--svg-icon-tint)"></path><path d="M 3.096 0.303 C 3.318 0.17 3.6 0.33 3.6 0.589 L 3.6 3.732 C 3.6 3.991 3.318 4.151 3.096 4.018 L 0.953 2.732 C 0.521 2.473 0.521 1.848 0.953 1.589 Z" transform="translate(6.24 13.8) rotate(-45 1.8 2.16)" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Signature Pad</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'sound-effects\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 14.225 10.793 C 14.471 11.102 14.623 11.529 14.623 12 C 14.623 12.471 14.471 12.898 14.225 13.207" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 16.224 9.185 C 16.96 9.911 17.417 10.905 17.417 12 C 17.417 13.095 16.96 14.09 16.224 14.816" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 6.083 10.656 C 6.083 10.288 6.382 9.989 6.75 9.989 L 7.674 9.989 L 11.021 7.835 C 11.464 7.549 12.048 7.868 12.048 8.396 L 12.048 15.604 C 12.048 16.132 11.464 16.451 11.021 16.165 L 7.674 14.011 L 6.75 14.011 C 6.382 14.011 6.083 13.712 6.083 13.344 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Sound Effects</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'card-swipe\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 3.423 7.423 C 3.423 5.214 5.214 3.423 7.423 3.423 L 16.756 3.423 C 18.965 3.423 20.756 5.214 20.756 7.423 L 20.756 16.756 C 20.756 18.965 18.965 20.756 16.756 20.756 L 7.423 20.756 C 5.214 20.756 3.423 18.965 3.423 16.756 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 9.172 3.377 C 10.734 1.815 13.266 1.815 14.828 3.377 L 20.721 9.269 C 22.283 10.831 22.283 13.364 20.721 14.926 L 14.828 20.819 C 13.266 22.381 10.734 22.381 9.172 20.819 L 3.279 14.926 C 1.717 13.364 1.717 10.831 3.279 9.269 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Card Swipe</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'custom-effect\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6.2 C 2 5.673 2.31 5.195 2.792 4.981 L 7.063 3.083 C 7.503 2.887 8 3.21 8 3.693 L 8 20.307 C 8 20.79 7.503 21.113 7.063 20.917 L 2.792 19.019 C 2.31 18.805 2 18.327 2 17.8 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 9.333 3.297 C 9.333 2.642 9.954 2.163 10.588 2.33 L 20.509 4.941 C 21.388 5.172 22 5.967 22 6.875 L 22 17.125 C 22 18.033 21.388 18.828 20.509 19.059 L 10.588 21.67 C 9.954 21.837 9.333 21.358 9.333 20.703 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Custom Effect</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'drag-handle\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.333 2.667 L 2.667 0 L 0 2.667" transform="translate(5.667 10.667) rotate(-90 2.667 1.333)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 5.333 0 L 2.667 2.667 L 0 0" transform="translate(13 10.667) rotate(-90 2.667 1.333)" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Drag Handle</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'dynamic-header\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 8 L 2 8 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Dynamic Header</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'image-panning\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 14 C 12 12.895 12.895 12 14 12 L 20 12 C 21.105 12 22 12.895 22 14 L 22 18 C 22 20.209 20.209 22 18 22 L 14 22 C 12.895 22 12 21.105 12 20 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Image Panning</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'input-data\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 10.333 C 16.667 10.886 16.219 11.333 15.667 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)"></path><path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.667 12.667 C 16.219 12.667 16.667 13.114 16.667 13.667 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Input Data</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'input-validation\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 8.333 C 7.333 7.781 7.781 7.333 8.333 7.333 L 15.667 7.333 C 16.219 7.333 16.667 7.781 16.667 8.333 L 16.667 10.333 C 16.667 10.886 16.219 11.333 15.667 11.333 L 8.333 11.333 C 7.781 11.333 7.333 10.886 7.333 10.333 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 13.667 C 7.333 13.114 7.781 12.667 8.333 12.667 L 15.667 12.667 C 16.219 12.667 16.667 13.114 16.667 13.667 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Input Validation</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'like-animation\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.28 0 C 7.017 0 7.747 2.366 6.357 3.755 C 4.968 5.144 3.543 5.905 3.543 5.905 C 3.543 5.905 2.118 5.144 0.728 3.755 C -0.661 2.365 0.069 -0 1.806 0 C 3.543 0 3.543 1.701 3.543 1.701 C 3.543 1.701 3.543 0 5.28 0 Z" transform="translate(11.213 11.787) rotate(15 3.543 2.953)" fill="var(--svg-icon-tint)"></path><path d="M 5.28 0 C 7.017 -0 7.747 2.365 6.357 3.755 C 4.968 5.144 3.543 5.905 3.543 5.905 C 3.543 5.905 2.118 5.144 0.728 3.755 C -0.661 2.366 0.069 0 1.806 0 C 3.543 0 3.543 1.701 3.543 1.701 C 3.543 1.701 3.543 0 5.28 0 Z" transform="translate(5.701 6.669) rotate(-15 3.543 2.953)" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Like Animation</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'like-counter\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 14.778 7.333 C 17.556 7.333 18.724 11.072 16.502 13.268 C 14.279 15.464 12 16.667 12 16.667 C 12 16.667 9.721 15.464 7.498 13.268 C 5.276 11.072 6.444 7.333 9.222 7.333 C 12 7.333 12 10.022 12 10.022 C 12 10.022 12 7.333 14.778 7.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Like Counter</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'lock-screen\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 11 C 7.333 10.448 7.781 10 8.333 10 L 15.667 10 C 16.219 10 16.667 10.448 16.667 11 L 16.667 15.667 C 16.667 16.219 16.219 16.667 15.667 16.667 L 8.333 16.667 C 7.781 16.667 7.333 16.219 7.333 15.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 12 7.333 C 13.289 7.333 14.333 8.378 14.333 9.667 C 14.333 10.955 13.289 12 12 12 C 10.711 12 9.667 10.955 9.667 9.667 C 9.667 8.378 10.711 7.333 12 7.333 Z" fill="transparent" stroke-width="1.67" stroke="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Lock Screen</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'long-press-menu\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 16.667 10.667 C 17.771 10.667 18.667 11.562 18.667 12.667 C 18.667 13.771 17.771 14.667 16.667 14.667 C 15.562 14.667 14.667 13.771 14.667 12.667 C 14.667 11.562 15.562 10.667 16.667 10.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12 8 C 13.105 8 14 8.895 14 10 C 14 11.105 13.105 12 12 12 C 10.895 12 10 11.105 10 10 C 10 8.895 10.895 8 12 8 Z" fill="var(--svg-icon-tint)"></path><path d="M 7.333 10.667 C 8.438 10.667 9.333 11.562 9.333 12.667 C 9.333 13.771 8.438 14.667 7.333 14.667 C 6.229 14.667 5.333 13.771 5.333 12.667 C 5.333 11.562 6.229 10.667 7.333 10.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Long Press Menu</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'perspective-3d\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 6.913 22 C 5.987 22 5.182 21.364 4.967 20.463 L 2.586 10.463 C 2.287 9.206 3.24 8 4.532 8 L 19.468 8 C 20.76 8 21.713 9.206 21.414 10.463 L 19.033 20.463 C 18.818 21.364 18.013 22 17.087 22 Z" fill="var(--svg-icon-tint)"></path><path d="M 3.833 7 C 3.557 7 3.333 6.776 3.333 6.5 L 3.333 6.5 C 3.333 5.672 4.005 5 4.833 5 L 19.167 5 C 19.995 5 20.667 5.672 20.667 6.5 L 20.667 6.5 C 20.667 6.776 20.443 7 20.167 7 Z" fill="var(--svg-icon-tint)" opacity="0.7"></path><path d="M 5.167 4 C 4.891 4 4.667 3.776 4.667 3.5 L 4.667 3.5 C 4.667 2.672 5.338 2 6.167 2 L 17.833 2 C 18.662 2 19.333 2.672 19.333 3.5 L 19.333 3.5 C 19.333 3.776 19.109 4 18.833 4 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Perspective 3D</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'progress-bar\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 1.82 6 C 1.82 3.791 3.61 2 5.82 2 L 17.82 2 C 20.029 2 21.82 3.791 21.82 6 L 21.82 18 C 21.82 20.209 20.029 22 17.82 22 L 5.82 22 C 3.61 22 1.82 20.209 1.82 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.153 17 C 5.153 16.08 5.899 15.333 6.82 15.333 L 16.82 15.333 C 17.74 15.333 18.486 16.08 18.486 17 L 18.486 17 C 18.486 17.92 17.74 18.667 16.82 18.667 L 6.82 18.667 C 5.899 18.667 5.153 17.92 5.153 17 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 5.153 17 C 5.153 16.08 5.899 15.333 6.82 15.333 L 11.486 15.333 C 12.407 15.333 13.153 16.08 13.153 17 L 13.153 17 C 13.153 17.92 12.407 18.667 11.486 18.667 L 6.82 18.667 C 5.899 18.667 5.153 17.92 5.153 17 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Progress Bar</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'scroll-progress\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 7.333 10.333 C 7.333 9.781 7.781 9.333 8.333 9.333 L 15.667 9.333 C 16.219 9.333 16.667 9.781 16.667 10.333 L 16.667 11.667 C 16.667 12.219 16.219 12.667 15.667 12.667 L 8.333 12.667 C 7.781 12.667 7.333 12.219 7.333 11.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 14.667 C 7.333 14.114 7.781 13.667 8.333 13.667 L 15.667 13.667 C 16.219 13.667 16.667 14.114 16.667 14.667 L 16.667 16 C 16.667 16.552 16.219 17 15.667 17 L 8.333 17 C 7.781 17 7.333 16.552 7.333 16 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 7.667 C 7.333 7.298 7.632 7 8 7 L 16 7 C 16.368 7 16.667 7.298 16.667 7.667 L 16.667 7.667 C 16.667 8.035 16.368 8.333 16 8.333 L 8 8.333 C 7.632 8.333 7.333 8.035 7.333 7.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 7.333 7.667 C 7.333 7.298 7.632 7 8 7 L 12.667 7 C 13.035 7 13.333 7.298 13.333 7.667 L 13.333 7.667 C 13.333 8.035 13.035 8.333 12.667 8.333 L 8 8.333 C 7.632 8.333 7.333 8.035 7.333 7.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Scroll Progress</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'show-password\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 10.6 12 C 10.6 11.227 11.227 10.6 12 10.6 L 12 10.6 C 12.773 10.6 13.4 11.227 13.4 12 L 13.4 12 C 13.4 12.773 12.773 13.4 12 13.4 L 12 13.4 C 11.227 13.4 10.6 12.773 10.6 12 Z" fill="var(--svg-icon-tint)"></path><path d="M 12.166 7.833 C 14.892 7.833 17.161 9.42 17.811 12 C 17.161 14.58 14.892 16.167 12.166 16.167 C 9.44 16.167 7.127 14.58 6.478 12 C 7.127 9.42 9.44 7.833 12.166 7.833 Z M 9.333 12 C 9.333 13.473 10.527 14.667 12 14.667 C 13.473 14.667 14.667 13.473 14.667 12 C 14.667 10.527 13.473 9.333 12 9.333 C 10.527 9.333 9.333 10.527 9.333 12 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Show Password</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'slider\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.667 12 L 18.333 12" stroke="var(--svg-icon-tint)" fill="transparent" opacity="0.4" stroke-width="2.67" stroke-linecap="round" stroke-linejoin="round"></path><path d="M 12 8.333 C 14.025 8.333 15.667 9.975 15.667 12 C 15.667 14.025 14.025 15.667 12 15.667 C 9.975 15.667 8.333 14.025 8.333 12 C 8.333 9.975 9.975 8.333 12 8.333 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Slider</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'stories-drag\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.333 6.667 C 5.333 5.93 5.93 5.333 6.667 5.333 L 10 5.333 C 10.736 5.333 11.333 5.93 11.333 6.667 L 11.333 6.667 C 11.333 7.403 10.736 8 10 8 L 6.667 8 C 5.93 8 5.333 7.403 5.333 6.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path><path d="M 12.667 6.667 C 12.667 5.93 13.264 5.333 14 5.333 L 17.333 5.333 C 18.07 5.333 18.667 5.93 18.667 6.667 L 18.667 6.667 C 18.667 7.403 18.07 8 17.333 8 L 14 8 C 13.264 8 12.667 7.403 12.667 6.667 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Stories: Drag</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'stories-tap\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18 C 22 20.209 20.209 22 18 22 L 6 22 C 3.791 22 2 20.209 2 18 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 5.333 6.667 C 5.333 5.93 5.93 5.333 6.667 5.333 L 10 5.333 C 10.736 5.333 11.333 5.93 11.333 6.667 L 11.333 6.667 C 11.333 7.403 10.736 8 10 8 L 6.667 8 C 5.93 8 5.333 7.403 5.333 6.667 Z" fill="var(--svg-icon-tint)"></path><path d="M 12.667 6.667 C 12.667 5.93 13.264 5.333 14 5.333 L 17.333 5.333 C 18.07 5.333 18.667 5.93 18.667 6.667 L 18.667 6.667 C 18.667 7.403 18.07 8 17.333 8 L 14 8 C 13.264 8 12.667 7.403 12.667 6.667 Z" fill="var(--svg-icon-tint)" opacity="0.4"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Stories: Tap</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<div class="btn" (click)="onSelect(\'toast-prompt\')">\n\t\t\t\t\t\t\t<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M 2 6 C 2 3.791 3.791 2 6 2 L 18 2 C 20.209 2 22 3.791 22 6 L 22 18.333 C 22 20.542 20.209 22.333 18 22.333 L 6 22.333 C 3.791 22.333 2 20.542 2 18.333 Z" fill="var(--svg-icon-tint)" opacity="0.2"></path><path d="M 12 6.333 C 15.13 6.333 17.667 8.87 17.667 12 C 17.667 15.13 15.13 17.667 12 17.667 C 8.87 17.667 6.333 15.13 6.333 12 C 6.333 8.87 8.87 6.333 12 6.333 Z" fill="transparent" stroke-width="1.33" stroke="var(--svg-icon-tint)"></path><path d="M 12 13 C 12.552 13 13 13.448 13 14 C 13 14.552 12.552 15 12 15 C 11.448 15 11 14.552 11 14 C 11 13.448 11.448 13 12 13 Z" fill="var(--svg-icon-tint)"></path><path d="M 11.06 9.998 C 11.027 9.457 11.458 9 12 9 L 12 9 C 12.542 9 12.973 9.457 12.94 9.998 L 12.848 11.535 C 12.821 11.983 12.449 12.333 12 12.333 L 12 12.333 C 11.551 12.333 11.179 11.983 11.152 11.535 Z" fill="var(--svg-icon-tint)"></path></svg></div>\n\t\t\t\t\t\t\t<div class="title">Toast Prompt</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</li>\n\t\t\t--\x3e\n\t\t</ul>\n\t\t<ul class="nav--editor" *if="mode === 2">\n\t\t\t<li>\n\t\t\t\t<div class="title" [innerHTML]="\'editor_views\' | label"></div>\n\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t<li *for="let item of supportedViewTypes">\n\t\t\t\t\t\t<div class="btn" [class]="{ disabled: item.disabled }" (click)="onSelect({ type:\'view\', value: item.type.name })">\n\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t<svg-icon [name]="item.type.name"></svg-icon>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="item.name"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</li>\n\t\t</ul>\n\t\t<ul class="nav--editor" *if="mode === 3">\n\t\t\t<li>\n\t\t\t\t<div class="title" [innerHTML]="\'editor_view_items\' | label"></div>\n\t\t\t\t<ul class="nav--editor">\n\t\t\t\t\t<li *for="let item of supportedViewItemTypes">\n\t\t\t\t\t\t<div class="btn" [class]="{ disabled: item.disabled }" (click)="onSelect({ type:\'viewItem\', value: item.type.name })" [title]="item.id">\n\t\t\t\t\t\t\t<div class="icon">\n\t\t\t\t\t\t\t\t<svg-icon [name]="item.type.name"></svg-icon>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="item.name"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t\t<div class="abstract" *if="supportedViewItemTypes.length == 0" [innerHTML]="\'editor_type_no_items\' | label"></div>\n\t\t\t</li>\n\t\t</ul>\n\t</div>\n\t'};let Pa=0;class Da{static set active(t){this.active$.next(t)}static get active(){return this.active$.getValue()}static menu$(){return this.getMenu$().pipe(n.switchMap((t=>(this.menu$_.next(t),this.menu$_))))}static getMenu$(){return yi.get$("/api/menu").pipe(n.map((t=>(t.menu.sort(((t,e)=>t.order-e.order)),t.menu))))}static updateMenu$(t){return yi.put$("/api/menu",t)}static createMenuItem$(t,e){void 0===t&&(t=null),void 0===e&&(e=0);const i={parentId:t,viewId:null,order:10*e,name:"Folder "+ ++Pa};return yi.post$("/api/menu",i)}static updateMenuItem$(t){return yi.put$(`/api/menu/${t.id}`,t)}static deleteMenuItem$(t){return yi.delete$(`/api/menu/${t.id}`)}static getModelMenu$(t,e){return void 0===e&&(e=!1),this.menu$().pipe(n.map((i=>{if(i&&i.length)return i=i.filter((e=>null==e.viewId||0==e.viewId||null!=t.find((t=>t.id===e.viewId)))),this.mapMenuItems(i);{const i={};t.forEach((t=>{if(t.type.name!==gn.WaitingRoom.name&&(!t.hidden||e)){let e=i[t.type.name];e||(e=i[t.type.name]=[]),e.push(t)}}));return Object.keys(i).map((i=>{let n="Button";switch(i){case gn.WaitingRoom.name:n="Waiting Room";break;case gn.Panorama.name:n="Experience";break;case gn.PanoramaGrid.name:n="Virtual Tour";break;case gn.Room3d.name:n="Stanze 3D";break;case gn.Model.name:n="Modelli 3D";break;case gn.Media.name:n="Media"}return{name:n,type:{name:"menu-group"},items:t.filter((t=>t.type.name===i&&(!t.hidden||e)))}}))}})))}static mapMenuItem(t,e){return t.viewId?{id:t.viewId,name:t.name,type:{name:"panorama"}}:{name:t.name,type:{name:"menu-group"},items:this.mapMenuItems(e,t.id)}}static mapMenuItems(t,e){return void 0===e&&(e=null),t.filter((t=>(t.parentId||null)===e)).map((e=>this.mapMenuItem(e,t))).filter((t=>null!=t.id||t.items.length>0))}}Da.active$=new i.BehaviorSubject(!1),Da.menu$_=new i.BehaviorSubject([]);class Ma{static drop$(e){if(t.isPlatformBrowser&&e){const t=document.querySelector("body");return i.merge(i.fromEvent(t,"drop"),i.fromEvent(t,"dragover")).pipe(n.map((t=>{t.preventDefault(),t.target===e&&(e.files=t.dataTransfer.files)})))}return i.EMPTY}static change$(e){return t.isPlatformBrowser&&e?i.fromEvent(e,"change").pipe(n.filter((t=>e.files&&e.files.length)),n.map((t=>Array.from(e.files)))):i.EMPTY}static asset$(t,e){return void 0===e&&(e=[]),this.change$(t).pipe(n.switchMap((t=>{e.length=t.length,e.fill(null);const s=t.map(((t,i)=>this.read$(t,i,e).pipe(n.map((()=>t)),n.switchMap((t=>ta.upload$([t]))),n.switchMap((t=>{const e=t[0],i=ds.fromUrl(e.url);return ta.assetCreate$(i)})))));return i.combineLatest(s)})))}static read$(t,e,s){void 0===s&&(s=[]);const o=new FileReader,r=i.fromEvent(o,"load").pipe(n.switchMap((t=>{const e=t.target.result;return this.resize$(e)})),n.tap((t=>{s[e]=t})));return o.readAsDataURL(t),r}static resize$(t){return i.from(this.resize_(t))}static resize_(t){return new Promise(((e,i)=>{const n=document.createElement("img");n.onload=function(){const t=document.createElement("canvas"),i=t.getContext("2d");let s=n.width,o=n.height;s>o?s>320&&(o*=320/s,s=320):o>240&&(s*=240/o,o=240),t.width=s,t.height=o,i.drawImage(n,0,0,s,o);const r=t.toDataURL("image/jpeg",.9);e(r)},n.onerror=function(){i(t)},n.src=t}))}}class xa extends t.Component{onChanges(){const{node:e}=t.getContext(this),i=this.control.flags;Object.keys(i).forEach((t=>{i[t]?e.classList.add(t):e.classList.remove(t)}))}}xa.meta={selector:"[control]",inputs:["control"]};class Ua extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||"image/png, image/jpeg";const{node:e}=t.getContext(this),s=e.querySelector("input");s.setAttribute("accept",this.accept),Ma.drop$(s).pipe(n.takeUntil(this.unsubscribe$)).subscribe(),Ma.change$(s).pipe(n.switchMap((t=>{const e=t.map(((t,e)=>ta.upload$([t]).pipe(n.switchMap((t=>ta.createOrUpdateAsset$(t,this.control))))));return i.combineLatest(e)})),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.control.value=t[0]}))}}Ua.meta={selector:"[control-asset]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--picture">\n\t\t\t\t<div class="group--picture__info">\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t</div>\n\t\t\t\t<img [lazy]="control.value | asset" [size]="{ width: 320, height: 240 }" *if="control.value && control.value.type.name === \'image\'" />\n\t\t\t\t<video [src]="control.value | asset" *if="control.value && control.value.type.name === \'video\'"></video>\n\t\t\t\t<input type="file">\n\t\t\t</div>\n\t\t\t<div class="file-name" *if="control.value" [innerHTML]="control.value.file"></div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Va extends Ua{static itemToFormGroup(t){return new e.FormGroup({id:t.id,parentId:t.parentId,viewId:t.viewId,name:t.name,items:new e.FormArray})}onInit(){this.dropdownId=Oa.nextId(),this.controls=this.control.controls,ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{this.controls.viewId.options=t}))}onAddItem(){Da.createMenuItem$(this.controls.id.value,this.controls.items.length).pipe(n.first()).subscribe((t=>{this.controls.items.push(Va.itemToFormGroup(t))}))}onRemoveItem(){this.remove.next(this.control)}onRemoveControl(t){Da.deleteMenuItem$(t.value).pipe(n.first()).subscribe((()=>{this.controls.items.remove(t)}))}onLinkItem(){this.link.next(this.control)}onLinkControl(t){this.link.next(t)}onItemUp(){this.up.next(this.control)}onItemDown(){this.down.next(this.control)}onUpControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n>0?n--:n=i-1,e.insert(t,n)}onDownControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n<i-1?n++:n=0,e.insert(t,n)}setView(t){const e=Object.assign({},this.control.value);e.viewId=t.id,t.id&&(e.name=t.name),Da.updateMenuItem$(e).pipe(n.first()).subscribe((()=>{this.controls.viewId.value=t.id,t.id&&(this.controls.name.value=t.name,this.controls.items.controls=[],this.controls.items.switchSubjects_())}))}onTextDidChange(t){Da.updateMenuItem$(this.control.value).pipe(n.first()).subscribe()}hasOption(t){return this.controls.viewId.value===t.id}onDropped(t){}}Va.meta={selector:"[control-menu]",outputs:["remove","link","up","down"],inputs:["control"],template:'\n\t\t<div class="group--form">\n\t\t\t<button type="button" class="control-menu__link" [class]="{ active: control.controls.viewId.value }" (click)="onLinkItem($event)" [dropdown]="dropdownId" (dropped)="onDropped($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#link"></use></svg>\n\t\t\t\t<div class="dropdown" [dropdown-item]="dropdownId">\n\t\t\t\t\t<div class="category">View</div>\n\t\t\t\t\t<ul class="nav--dropdown">\n\t\t\t\t\t\t<li (click)="setView(item)" [class]="{ empty: item.id == null }" *for="let item of control.controls.viewId.options">\n\t\t\t\t\t\t\t<span [class]="{ active: hasOption(item) }" [innerHTML]="item.name"></span>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</button>\n\t\t\t<input type="text" class="control--text" [formControl]="control.controls.name" placeholder="Name" (change)="onTextDidChange($event)" />\n\t\t\t\x3c!--\n\t\t\t<button type="button" class="control-menu__add" (click)="onAddItem($event)">\n\t\t\t\t<span [innerHTML]="control.controls.viewId.value"></span>\n\t\t\t</button>\n\t\t\t--\x3e\n\t\t\t\x3c!--\n\t\t\t<select class="control--select" [formControl]="control.controls.viewId">\n\t\t\t\t<option [value]="item.id" *for="let item of control.controls.viewId.options" [innerHTML]="item.name"></option>\n\t\t\t</select>\n\t\t\t--\x3e\n\t\t\t<button type="button" class="control-menu__up" (click)="onItemUp($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#up"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__down" (click)="onItemDown($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#down"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__add" (click)="onAddItem($event)" *if="!control.controls.viewId.value">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#add"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__remove" (click)="onRemoveItem($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#remove"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="group--items">\n\t\t\t<div control-menu *for="let sub of control.controls.items.controls" [control]="sub" (remove)="onRemoveControl($event)" (link)="onLinkControl($event)" (up)="onUpControl($event)" (down)="onDownControl($event)"></div>\n\t\t</div>\n\t'};class Ba extends t.Component{onInit(){this.changes=0,this.form=null,Da.getMenu$().pipe(n.first()).subscribe((t=>this.initForm(t)))}initForm(t){void 0===t&&(t=[]);const i=this.menuToControls(t),s=this.form=new e.FormGroup({items:i});this.controls=s.controls,s.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.changes++,this.pushChanges()}))}onLinkControl(t){}onUpControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n>0?n--:n=i-1,e.insert(t,n)}onDownControl(t){const e=this.controls.items,i=e.controls.length;let n=e.controls.indexOf(t);e.controls.splice(n,1),n<i-1?n++:n=0,e.insert(t,n)}onAddItem(){Da.createMenuItem$(null,this.controls.items.length).pipe(n.first()).subscribe((t=>{this.controls.items.push(Va.itemToFormGroup(t))}))}onRemoveControl(t){Da.deleteMenuItem$(t.value).pipe(n.first()).subscribe((()=>{this.controls.items.remove(t)}))}isValid(){return this.form.valid}onSubmit(t){if(this.form.valid){const t=this.form.value,e=this.controlsToMenu(t);Da.updateMenu$(e)}else this.form.touched=!0}menuToControls(t,i){void 0===i&&(i=null);return new e.FormArray(t.filter((t=>(t.parentId||null)===i)).map((i=>{const n=this.menuToControls(t,i.id);return new e.FormGroup({id:i.id,parentId:i.parentId,viewId:i.viewId,name:i.name,items:n})})))}controlsToMenu(t){const e=[],i=t=>{t&&t.forEach(((t,n)=>{const s=Object.assign({},t);s.order=10*n,delete s.items,e.push(s),i(t.items)}))};return i(t.items),e}}Ba.meta={selector:"[menu-builder]",inputs:["views"],template:'\n\t<div class="group--head">\n\t\t<div class="title" [innerHTML]="\'editor_menu\' | label"></div>\n\t</div>\n\t<div class="group--main">\n\t\t<div class="nav--tree" *if="form">\n\t\t\t<form class="form" [formGroup]="form" (submit)="isValid() && onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t<div class="abstract" *if="controls.items.controls.length == 0" [innerHTML]="\'editor_add_item\' | label"></div>\n\t\t\t\t<div *for="let control of controls.items.controls">\n\t\t\t\t\t<div control-menu [control]="control" (remove)="onRemoveControl($event)" (link)="onLinkControl($event)" (up)="onUpControl($event)" (down)="onDownControl($event)"></div>\n\t\t\t\t</div>\n\t\t\t</form>\n\t\t</div>\n\t</div>\n\t<div class="group--foot">\n\t\t<button type="button" class="btn--mode" (click)="onAddItem($event)" [innerHTML]="\'editor_add\' | label"></button>\n\t\t<button type="button" class="btn--mode" (click)="isValid() && onSubmit()" *if="changes > 1" [innerHTML]="\'editor_save\' | label"></button>\n\t</div>\n\t'};class ja extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Qn&&(e=i.modal.data),e}get navmap(){let t=null;const e=this.data;return e&&(t=e.navmap),t}get position(){let t=[0,0,0];const e=this.data;return e&&(t=[e.hit.x,e.hit.y,0]),t}onInit(){const t=this.position;this.error=null;const i=this.form=new e.FormGroup({type:fn.Nav,title:null,abstract:null,viewId:new e.FormControl(null,e.RequiredValidator()),keepOrientation:!1,important:!1,transparent:!1,position:new e.FormControl(t,e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()})),ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{this.controls.viewId.options=t,this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=Object.assign({},this.form.value);t.viewId=parseInt(t.viewId),Fn.itemCreate$(this.navmap,t).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("NavmapItemModalComponent.onSubmit.error",t),this.error=t,this.form.submitted=!1}))}else this.form.touched=!0}onClose(){an.reject()}}ja.meta={selector:"[navmap-item-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Map Nav.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.title" label="Title"></div>\n\t\t\t\t\t\t<div control-textarea [control]="controls.abstract" label="Abstract"></div>\n\t\t\t\t\t\t<div control-custom-select [control]="controls.viewId" label="NavToView"></div>\n\t\t\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="3" [disabled]="true"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},ja.chunk=()=>'<div class="nav-modal" navmap-item-modal></div>';class Fa extends t.Component{onInit(){this.error=null;const t=this.form=new e.FormGroup({name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e={name:t.name,asset:t.asset};return Fn.navmapCreate$(e).pipe(n.first()).subscribe((t=>{an.resolve(t)}),(t=>{console.log("NavmapModalComponent.onSubmit.error",t),this.error=t,this.form.reset()}))}this.form.touched=!0}onClose(){an.reject()}}Fa.meta={selector:"[navmap-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Create Map.</div>\n\t\t\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t\t<div class="form-controls">\n\t\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/png"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="description">Formato immagine .png con trasparenza (2048x1024 o 1024x512)</div>\n\t\t\t\t\t<div class="group--cta">\n\t\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t\t<span>Create</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t'},Fa.chunk=()=>'<div class="panorama-modal" navmap-modal></div>';class Ha extends t.Component{onInit(){this.navmap=null,this.navmaps=[],Fn.navmapGet$().pipe(n.first()).subscribe((t=>{this.navmaps=t,this.pushChanges()}))}onBack(t){this.navmap=null,this.pushChanges()}onAdd(){an.open$({template:Fa.chunk()}).pipe(n.first()).subscribe((t=>{t instanceof on&&(this.navmaps.push(t.data),this.navmap=t.data,this.pushChanges())}))}onSet(t){this.navmap=this.navmaps.find((e=>e.id===t.id)),this.pushChanges()}onAddItem(t,e){an.open$({template:ja.chunk(),data:{navmap:t,hit:e}}).pipe(n.first()).subscribe((e=>{if(e instanceof on){const i=t.items||[];i.push(e.data),Object.assign(t,{items:i}),this.pushChanges()}}))}onDelete(t){const e=this.navmaps.indexOf(t);-1!==e&&this.navmaps.splice(e,1),this.navmap=null,this.pushChanges()}}Ha.meta={selector:"[navmap-builder]",inputs:["views"],template:'\n\t<div class="group--head">\n\t\t<div class="title" [innerHTML]="\'editor_navmaps\' | label"></div>\n\t</div>\n\t<div class="group--main">\n\t\t\x3c!-- listing navmaps --\x3e\n\t\t<div class="listing--navmaps" *if="!navmap">\n\t\t\t<div class="abstract" *if="navmaps.length == 0" [innerHTML]="\'editor_add_item\' | label"></div>\n\t\t\t<div class="listing__item" *for="let item of navmaps">\n\t\t\t\t<div class="card--navmap" (click)="onSet(item)">\n\t\t\t\t\t<div class="card__picture">\n\t\t\t\t\t\t<img [src]="item.asset | asset" *if="item.asset" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="card__content">\n\t\t\t\t\t\t<div class="card__name" [innerHTML]="item.name"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t\x3c!-- navmap edit --\x3e\n\t\t<div class="navmap" navmap-edit [navmap]="navmap" (delete)="onDelete($event)" *if="navmap">\n\t\t\t<form class="form" [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off">\n\t\t\t\t<div class="title"><span [innerHTML]="navmap.name"></span> <span [innerHTML]="navmap.id"></span></div>\n\t\t\t\t<div class="form-controls">\n\t\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t\t\t\x3c!--\n\t\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/png"></div>\n\t\t\t\t\t--\x3e\n\t\t\t\t</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="submit" class="btn--accept">\n\t\t\t\t\t\t<span [innerHTML]="\'editor_save\' | label"></span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t\t<span [innerHTML]="\'editor_remove\' | label"></span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="navmap-control" [class]="mode">\n\t\t\t\t\t<div class="navmap-control__image">\n\t\t\t\t\t\t<img draggable="false" [src]="navmap.asset | asset" *if="navmap.asset" />\n\t\t\t\t\t\t<div class="navmap__item" [style]="{ left: item.position[0] * 100 + \'%\', top: item.position[1] * 100 + \'%\' }" (mousedown)="onMoveItem($event, item)" (click)="onRemoveItem(item)" *for="let item of navmap.items">\n\t\t\t\t\t\t\t<img draggable="false" [src]="\'textures/ui/nav-point.png\' | asset" />\n\t\t\t\t\t\t\t<div class="title" [innerHTML]="item.title" *if="item.title"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<ul class="navmap-control__toolbar">\n\t\t\t\t\t\t<li class="nav__item"><span [class]="{ active: mode === \'insert\' }" (click)="onToggleMode(\'insert\')"><svg class="pencil" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#pencil"></use></svg></span></li>\n\t\t\t\t\t\t<li class="nav__item"><span [class]="{ active: mode === \'move\' }" (click)="onToggleMode(\'move\')"><svg class="move" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#move"></use></svg></span></li>\n\t\t\t\t\t\t<li class="nav__item"><span [class]="{ active: mode === \'remove\' }" (click)="onToggleMode(\'remove\')"><svg class="erase" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#erase"></use></svg></span></li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</form>\n\t\t</div>\n\t</div>\n\t<div class="group--foot">\n\t\t<button type="button" class="btn--mode" (click)="onAdd($event)" [innerHTML]="\'editor_add\' | label" *if="!navmap"></button>\n\t\t<button type="button" class="btn--mode" (click)="onBack($event)" [innerHTML]="\'editor_back\' | label" *if="navmap"></button>\n\t</div>\n\t'};const Ga="idle",$a="insert",Wa="remove",za="move";class Ka{constructor(t,e){const i=t.getBoundingClientRect();this.x=(e.clientX-i.x)/i.width,this.y=(e.clientY-i.y)/i.height}}class qa extends Ka{}class Ya extends Ka{}class Ja extends Ka{}class Xa extends t.Component{onInit(){this.mode=Ga,this.error=null;const t=this.navmap,i=this.form=new e.FormGroup({name:new e.FormControl(t.name,e.RequiredValidator()),asset:new e.FormControl(t.asset,e.RequiredValidator())});this.controls=i.controls,i.changes$.subscribe((t=>{this.pushChanges()})),this.insert$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((e=>{const i=e;an.open$({template:ja.chunk(),data:{navmap:t,hit:i}}).pipe(n.first()).subscribe((e=>{if(e instanceof on){const i=t.items||[];i.push(e.data),Object.assign(t,{items:i}),this.pushChanges()}}))}))}insert$(){const{node:e}=t.getContext(this),s=e.querySelector(".navmap-control__image");return i.fromEvent(s,"pointerdown").pipe(n.filter((t=>this.mode===$a)),n.map((t=>new qa(s,t))))}onToggleMode(t){this.mode=this.mode===t?Ga:t,this.pushChanges()}onMoveItem(e,s){const o=this.navmap;switch(this.mode){case za:{const{node:r}=t.getContext(this),a=r.querySelector(".navmap-control__image"),c=s.position.slice(),l=new qa(a,e),d=i.fromEvent(a,"mousemove").pipe(n.map((t=>new Ya(a,t))),n.tap((t=>{const e=t.x-l.x,i=t.y-l.y;s.position=[Math.max(0,Math.min(1,c[0]+e)),Math.max(0,Math.min(1,c[1]+i)),0],this.pushChanges()}))),h=i.fromEvent(a,"mouseup").pipe(n.map((t=>new Ja(a,t))),n.tap((t=>{const e=t.x-l.x,i=t.y-l.y;s.position=[Math.max(0,Math.min(1,c[0]+e)),Math.max(0,Math.min(1,c[1]+i)),0],Fn.itemUpdate$(o,s).pipe(n.first()).subscribe((t=>{Object.assign(s,t),this.pushChanges()}))})));d.pipe(n.takeUntil(h)).subscribe();break}}}onRemoveItem(t){const e=this.navmap;if(this.mode===Wa)Fn.itemDelete$(e,t).pipe(n.first()).subscribe((i=>{const n=e.items||[],s=n.indexOf(t);-1!==s&&n.splice(s,1),Object.assign(e,{items:n}),this.pushChanges()}))}onSubmit(){if(this.form.valid){this.form.submitted=!0;const t=this.form.value,e=Object.assign({items:[]},this.navmap,{name:t.name});Fn.navmapUpdate$(e).pipe(n.first()).subscribe((t=>{Object.assign(this.navmap,t),this.pushChanges()}),(t=>{this.error=t,this.form.reset()}))}else this.form.touched=!0}onRemove(){const t=this.navmap;an.open$({template:ua.chunk(),data:{item:t}}).pipe(n.first()).subscribe((e=>{e instanceof on&&Fn.navmapDelete$(t).pipe(n.first()).subscribe((e=>{this.delete.next(t)}))}))}}Xa.meta={selector:"[navmap-edit]",outputs:["delete"],inputs:["navmap"]};class Qa extends t.Component{onInit(){this.busy=!1,this.active=!1,this.useHooks=Ii.enabled;const t=this.form=new e.FormGroup;this.controls=t.controls;const i=this.item;this.originalItem=Object.assign({},i),i.hasChromaKeyColor=!(!i.asset||!i.asset.chromaKeyColor),i.autoplay=i.asset&&i.asset.type.name===ns.Video.name?i.asset.autoplay:void 0,i.loop=i.asset&&i.asset.type.name===ns.Video.name?i.asset.loop:void 0,i.assetType=as(i).id,this.doUpdateForm(),t.changes$.subscribe((t=>{this.doUpdateItem(t),this.pushChanges()}))}getFlagsDidChange(t,e){return["hasChromaKeyColor","autoplay","loop"].reduce(((i,n)=>{const s=e[n]||!1,o=t[n]||!1;return i||s!==o}),!1)}getAssetDidChange(t,e){return ta.assetDidChange(t.asset,e.asset)}doUpdateItem(t){const e=this.item,s=this.getAssetDidChange(e,t),o=this.getFlagsDidChange(e,t);if(Object.assign(e,t),e.asset&&(e.asset.chromaKeyColor=e.hasChromaKeyColor?[0,1,0]:null,e.asset.autoplay=e.autoplay,e.asset.loop=e.loop),s||o){(e.asset?ta.assetUpdate$(e.asset):i.of(null)).pipe(n.switchMap((()=>ea.inferItemUpdate$(this.view,e))),n.first()).subscribe(),this.view.updateIndices(this.view.items),"function"==typeof e.onUpdateAsset&&e.onUpdateAsset()}"function"==typeof e.onUpdate&&e.onUpdate()}doUpdateForm(){const t=this.item,i=this.form;if(this.type&&this.type.name===t.type.name)Object.keys(this.controls).forEach((i=>{switch(i){case"link":break;case"links":{const n=t.links.map((t=>({title:t.title||null,href:t.href||null,target:"_blank"}))),s=this.controls[i];for(;s.controls.length>n.length;)s.remove(s.controls[s.controls.length-1]);for(;s.controls.length<n.length;)s.push(new e.FormGroup({title:new e.FormControl(null),href:new e.FormControl(null),target:"_blank"}));s.patch(n);break}case"hasChromaKeyColor":this.controls[i].value=!(!t.asset||!t.asset.chromaKeyColor);break;case"autoplay":this.controls[i].value=!(!t.asset||!t.asset.autoplay);break;case"loop":this.controls[i].value=!(!t.asset||!t.asset.loop);break;case"assetType":this.controls[i].value=as(t).id;break;default:this.controls[i].value=null!=t[i]?t[i]:null}}));else{let s;switch(this.type=t.type,Object.keys(this.controls).forEach((t=>{i.removeKey(t)})),t.type.name){case fn.Nav.name:s=this.useHooks?["id","type","title?","abstract?","viewId?","hook?","hookExtra?","keepOrientation?","important?","transparent?","position","rotation","scale","asset?","link?","links?"]:["id","type","title?","abstract?","viewId?","keepOrientation?","important?","transparent?","position","rotation","scale","asset?","link?","links?"];break;case fn.Plane.name:s=["id","type","position","rotation","scale","assetType?","asset?","hasChromaKeyColor?","autoplay?","loop?"];break;case fn.CurvedPlane.name:s=["id","type","position","rotation","scale","radius","height","arc","assetType?","asset?","hasChromaKeyColor?","autoplay?","loop?"];break;case fn.Texture.name:s=["id","type","assetType?","asset?","hasChromaKeyColor?","autoplay?","loop?"];break;case fn.Model.name:s=this.view.type.name===gn.Model?["id","type","asset?"]:["id","type","position","rotation","asset?"];break;default:s=["id","type"]}s.forEach((s=>{const o=-1!==s.indexOf("?");s=s.replace("?","");const r=null!=t[s]?t[s]:null;let a;switch(s){case"viewId":a=new e.FormControl(r,o?void 0:e.RequiredValidator()),ea.viewIdOptions$().pipe(n.first()).subscribe((t=>{a.options=t,a.value=a.value||null,this.pushChanges()}));break;case"hook":if(a=new e.FormControl(r,o?void 0:e.RequiredValidator()),Ii.enabled){const t=x.webhook.methods.nav.map((t=>({id:t,name:t})));t.unshift({id:null,name:"select"}),a.options=t}a.value=a.value||null,this.pushChanges();break;case"assetType":a=new e.FormControl(r,o?void 0:e.RequiredValidator()),a.options=Object.keys(ss).map((t=>ss[t]));break;case"link":break;case"links":{const i=t.links;a=new e.FormArray(i.map((t=>new e.FormGroup({title:new e.FormControl(t.title),href:new e.FormControl(t.href),target:"_blank"}))));break}default:a=new e.FormControl(r,o?void 0:e.RequiredValidator())}i.add(a,s)})),this.controls=i.controls}}onAssetTypeDidChange(t){const e=this.item,s=as(e).id;if(t!==s){e.assetType=t;let s=i.of(null);t!==ss.ImageOrVideo.id&&(s=s.pipe(n.switchMap((()=>{const e=cs(t);return ta.assetCreate$(e)})))),s.pipe(n.first()).subscribe((t=>{this.controls.asset.value=t}))}}onChanges(t){this.doUpdateForm()}onSubmit(){if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();const t=this.form.value,e=Object.assign({},t);this.item.type.name===fn.Nav.name&&(e.viewId=e.viewId||this.view.id);const i=this.view,s=new wn(e);ea.inferItemUpdate$(i,s).pipe(n.first()).subscribe((t=>{ea.inferItemUpdateResult$(i,s),this.update.next({view:i,item:s}),this.setTimeout((()=>{this.busy=!1,this.pushChanges()}))}),(t=>console.log("UpdateViewItemComponent.onSubmit.inferItemUpdate$.error",t)))}else this.form.touched=!0}onRemove(t){an.open$({template:ua.chunk(),data:{item:this.item}}).pipe(n.first()).subscribe((t=>{t instanceof on&&this.delete.next({view:this.view,item:this.item})}))}onSelect(t){this.select.next({view:this.view,item:this.item.selected?null:this.item})}getTitle(t){return ve.getKeys("editor",t.type.name)}onAddLink(t){this.controls.links.push(new e.FormGroup({title:new e.FormControl(null),href:new e.FormControl(null),target:"_blank"}))}onRemoveLink(t){this.controls.links.remove(t)}clearTimeout(){this.to&&clearTimeout(this.to)}setTimeout(t,e){void 0===e&&(e=300),this.clearTimeout(),"function"==typeof t&&(this.to=setTimeout(t,e))}onDestroy(){this.clearTimeout()}}Qa.meta={selector:"update-view-item",outputs:["select","update","delete"],inputs:["view","item"],template:'\n\t\t<div class="group--headline" [class]="{ active: item.selected }" (click)="onSelect($event)">\n\t\t\t\x3c!-- <div class="id" [innerHTML]="item.id"></div> --\x3e\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon [name]="item.type.name"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title" [innerHTML]="getTitle(item)"></div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="item.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t\x3c!-- <div control-text [control]="controls.type" label="Type" [disabled]="true"></div> --\x3e\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'nav\'">\n\t\t\t\t<div control-text [control]="controls.title" label="Title"></div>\n\t\t\t\t<div control-textarea [control]="controls.abstract" label="Abstract"></div>\n\t\t\t\t<div control-custom-select [control]="controls.viewId" label="NavToView"></div>\n\t\t\t\t<div control-checkbox [control]="controls.keepOrientation" label="Keep Orientation"></div>\n\t\t\t\t<div control-checkbox [control]="controls.important" label="Important"></div>\n\t\t\t\t<div control-checkbox [control]="controls.transparent" label="Transparent"></div>\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="3"></div>\n\t\t\t\t<div *if="controls.transparent.value == true">\n\t\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2"></div>\n\t\t\t\t</div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image" accept="image/jpeg, image/png"></div>\n\n\t\t\t\t<div class="group--link" *for="let link of controls.links.controls">\n\t\t\t\t\t<div class="group--controls">\n\t\t\t\t\t\t<div control-text [control]="link.controls.title" label="Link Title"></div>\n\t\t\t\t\t\t<div control-text [control]="link.controls.href" label="Link Url"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button type="button" class="btn--remove" (click)="onRemoveLink(link)"><svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#remove"></use></svg></button>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--update" (click)="onAddLink($event)">\n\t\t\t\t\t\t<span>Add Link</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\n\t\t\t\t<div *if="useHooks">\n\t\t\t\t\t<div control-custom-select [control]="controls.hook" label="Hook"></div>\n\t\t\t\t\t<div control-text [control]="controls.hookExtra" label="Hook Extra"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'plane\' && view.type.name != \'media\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2"></div>\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Localized Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'plane\' && view.type.name == \'media\'">\n\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Localized Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'curved-plane\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t\x3c!-- <div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div> --\x3e\n\t\t\t\t<div control-number [control]="controls.radius" label="Radius" [precision]="2"></div>\n\t\t\t\t<div control-number [control]="controls.height" label="Height" [precision]="2"></div>\n\t\t\t\t<div control-number [control]="controls.arc" label="Arc" [precision]="0"></div>\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'texture\'">\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t\t<div control-checkbox [control]="controls.autoplay" label="Autoplay" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t\t<div control-checkbox [control]="controls.loop" label="Loop" *if="item.asset && item.asset.type.name === \'video\'"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'model\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="2" *if="view.type.name !== \'model\'"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" *if="view.type.name !== \'model\'"></div>\n\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t'};class Za extends t.Component{onInit(){this.busy=!1,this.active=!1;const t=this.form=new e.FormGroup({id:new e.FormControl(this.tile.id,e.RequiredValidator()),asset:new e.FormControl(this.tile.asset,e.RequiredValidator()),navs:new e.FormControl(this.tile.navs,e.RequiredValidator())});this.controls=t.controls,t.changes$.subscribe((t=>{const e=this.tile;Object.assign(e,t),"function"==typeof e.onUpdate&&e.onUpdate(),this.pushChanges()}))}onSubmit(){if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();const t=Object.assign({},this.form.value),e=this.view,i=t;this.update.next({view:e,tile:i}),this.setTimeout((()=>{this.busy=!1,this.pushChanges()}))}else this.form.touched=!0}onRemove(t){an.open$({template:ua.chunk(),data:{tile:this.tile}}).pipe(n.first()).subscribe((t=>{t instanceof on&&this.delete.next({view:this.view,tile:this.tile})}))}onSelect(t){this.select.next({view:this.view,tile:this.tile.selected?null:this.tile})}clearTimeout(){this.to&&clearTimeout(this.to)}setTimeout(t,e){void 0===e&&(e=300),this.clearTimeout(),"function"==typeof t&&(this.to=setTimeout(t,e))}onDestroy(){this.clearTimeout()}}Za.meta={selector:"update-view-tile",outputs:["select","update","delete"],inputs:["view","tile"],template:'\n\t\t<div class="group--headline" [class]="{ active: tile.selected }" (click)="onSelect($event)">\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon name="tile"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title">Tile {{tile.id}}</div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="tile.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg, image/png"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t\x3c!--\n\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t--\x3e\n\t\t\t</div>\n\t\t</form>\n\t'};class tc extends t.Component{onInit(){this.busy=!1;const t=this.form=new e.FormGroup;this.controls=t.controls,this.doUpdateForm(),t.changes$.subscribe((t=>{this.doUpdateView(t),this.pushChanges()})),this.orbit$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{switch(this.view.type.name){case gn.WaitingRoom.name:case gn.Panorama.name:case gn.PanoramaGrid.name:case gn.Room3d.name:case gn.Model.name:case gn.Media.name:this.form.patch({latitude:t.orientation.latitude,longitude:t.orientation.longitude,zoom:t.zoom})}}))}orbit$(){let t,e,i=null;return ki.in$.pipe(n.filter((t=>t.type===xe)),n.auditTime(Math.floor(1e3/15)),n.distinctUntilChanged(((n,s)=>{const o=t!==s.orientation.latitude||e!==s.orientation.longitude||i!==s.zoom;return t=s.orientation.latitude,e=s.orientation.longitude,i=s.zoom,!o})))}getAssetDidChange(t){const e=this.view;if(e.type.name===gn.PanoramaGrid.name)return!1;const i=ta.assetDidChange(e.asset,t.asset),n=ta.assetDidChange(e.ar?e.ar.usdz:null,t.usdz),s=ta.assetDidChange(e.ar?e.ar.gltf:null,t.gltf);return!!(i||n||s)}doUpdateView(t){this.getAssetDidChange(t)&&this.onSubmit()}doUpdateForm(){const t=this.view;if(!this.type||this.type.name!==t.type.name){this.type=t.type;const i=this.form;let n;switch(Object.keys(this.controls).forEach((t=>{i.removeKey(t)})),t.type.name){case gn.WaitingRoom.name:n=["id","type","name","latitude","longitude","zoom","asset"];break;case gn.Panorama.name:n=["id","type","name","hidden?","latitude","longitude","zoom","asset"];break;case gn.PanoramaGrid.name:n=["id","type","name","hidden?","latitude","longitude","zoom"];break;case gn.Room3d.name:case gn.Model.name:n=["id","type","name","hidden?","latitude","longitude","zoom","asset"];break;case gn.Media.name:n=["id","type","name","hidden?","asset"];break;default:n=["id","type","name"]}t.type.name!==gn.WaitingRoom.name&&x.flags.ar&&(n.push("usdz?"),n.push("gltf?")),n.forEach((n=>{const s=-1!==n.indexOf("?");switch(n=n.replace("?","")){case"latitude":case"longitude":{const s=t.orientation||{latitude:0,longitude:0};i.add(new e.FormControl(s[n],e.RequiredValidator()),n);break}case"usdz":case"gltf":i.add(new e.FormControl(t.ar&&t.ar[n]||null,s?void 0:e.RequiredValidator()),n);break;default:i.add(new e.FormControl(null!=t[n]?t[n]:null,s?void 0:e.RequiredValidator()),n)}})),this.controls=i.controls}}onChanges(t){this.doUpdateForm()}onSubmit(){if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();const t=Object.assign({},this.form.value);null!=t.latitude&&(t.orientation={latitude:t.latitude,longitude:t.longitude},delete t.latitude,delete t.longitude);const e=t.usdz||null,i=t.gltf||null;delete t.usdz,delete t.gltf,t.ar=e||i?{usdz:e,gltf:i}:null;const s=new En(Object.assign({},this.view,t));ea.viewUpdate$(s).pipe(n.first()).subscribe((t=>{this.update.next({view:s}),this.setTimeout((()=>{this.busy=!1,this.pushChanges()}))}),(t=>console.log("UpdateViewComponent.onSubmit.viewUpdate$.error",t)))}else this.form.touched=!0}onRemove(t){an.open$({template:ua.chunk(),data:{item:this.item}}).pipe(n.first()).subscribe((t=>{t instanceof on&&this.delete.next({view:this.view})}))}onSelect(t){this.select.next({view:this.view.selected?null:this.view})}getTitle(t){return ve.getKeys("editor",t.type.name)}clearTimeout(){this.to&&clearTimeout(this.to)}setTimeout(t,e){void 0===e&&(e=300),this.clearTimeout(),"function"==typeof t&&(this.to=setTimeout(t,e))}onDestroy(){this.clearTimeout()}}tc.meta={selector:"update-view",outputs:["select","update","delete"],inputs:["view"],template:'\n\t\t<div class="group--headline" [class]="{ active: view.selected }" (click)="onSelect($event)">\n\t\t\t\x3c!-- <div class="id" [innerHTML]="view.id"></div> --\x3e\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon [name]="view.type.name"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title" [innerHTML]="getTitle(view)"></div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="view.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t\x3c!-- <div control-text [control]="controls.type" label="Type" [disabled]="true"></div> --\x3e\n\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'waiting-room\'">\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'panorama\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'panorama-grid\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'room-3d\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'model\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-localized-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name != \'waiting-room\' && (\'ar\' | flag)">\n\t\t\t\t<div control-model [control]="controls.usdz" label="AR IOS (.usdz)" accept=".usdz"></div>\n\t\t\t\t<div control-model [control]="controls.gltf" label="AR Android (.glb)" accept=".glb"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--remove" *if="view.type.name != \'waiting-room\'" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t'};const ec=[La,ia,va,na,Ha,Xa,Fa,ja,sa,Ba,oa,ra,ca,aa,la,da,ha,ua,pa,ka,Qa,Za,tc],ic=[];class nc extends t.Module{}nc.meta={imports:[],declarations:[...ec,...ic],exports:[...ec,...ic]};class sc extends t.Component{onClose(){an.reject()}}sc.meta={selector:"[iframe-modal]",inputs:["src"],template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="modal__content">\n\t\t\t<iframe [src]="src"></iframe>\n\t\t</div>\n\t'},sc.chunk=t=>`<div class="iframe-modal" iframe-modal src="${t}"></div>`;class oc extends t.Pipe{static transform(t){let e=x;const i=t.split(".");let n=i.shift();for(;i.length>0&&e[n];)e=e[n],n=i.shift();return e[n]||null}}oc.meta={name:"env"};class rc extends t.Pipe{static transform(t){return x.flags[t]||!1}}rc.meta={name:"flag"};class ac{constructor(t){this.file=t,this.name=t.name,this.type=ls(t.name),this.progress=0,this.size=t.size,this.uploading=!1,this.paused=!1,this.success=!1,this.complete=!1,this.error=null,this.preview=null}}class cc{constructor(t){t&&Object.assign(this,t)}}class lc extends cc{}class dc extends cc{}class hc extends cc{}class uc{constructor(){this.concurrent$=new i.BehaviorSubject(0),this.items$=new i.BehaviorSubject([]),this.events$=new i.ReplaySubject(1)}upload$(){const t=this.items$.getValue().filter((t=>!t.uploading));return i.combineLatest(t.map((t=>this.uploadItem$(t))))}uploadItem$(t){t.uploading=!0,this.events$.next(new lc({item:t}));const e=[t.file];return i.of(e).pipe(n.delayWhen((()=>this.concurrent$.pipe(n.filter((t=>t<4))))),n.tap((()=>this.concurrent$.next(this.concurrent$.getValue()+1))),n.first(),n.switchMap((t=>ta.upload$(t))),n.switchMap((e=>{const i=e[0];t.uploading=!1,t.complete=!0;const s=ds.fromUrl(i.url);return this.events$.next(new dc({item:t,asset:s})),ta.assetCreate$(s).pipe(n.tap((e=>{this.remove(t),this.events$.next(new hc({item:t,asset:e})),this.concurrent$.next(this.concurrent$.getValue()-1)})))})))}addItems(t){if(t&&t.length){const e=this.items$.getValue(),i=Array.from(t).map((t=>new ac(t)));e.push(...i),this.items$.next(e)}}remove(t){const e=this.items$.getValue(),i=e.indexOf(t);-1!==i&&e.splice(i,1),this.items$.next(e)}removeAll(){this.items$.next([])}drop$(e,s){if(t.isPlatformBrowser&&e){s=s||e;const t=document.querySelector("body");return i.merge(i.fromEvent(t,"drop"),i.fromEvent(t,"dragover")).pipe(n.map((t=>(t.preventDefault(),t.target===s&&this.addItems(t.dataTransfer.files),this.items$))))}return i.EMPTY}change$(e){return t.isPlatformBrowser&&e?i.fromEvent(e,"change").pipe(n.switchMap((t=>(e.files.length&&(this.addItems(e.files),e.value=""),this.items$)))):i.EMPTY}files$(t){return i.combineLatest(Array.from(t).map(((t,e)=>this.file$(t,e))))}file$(t,e){return this.read$(t,e).pipe(n.switchMap((()=>this.uploadFile$(t))))}read$(t,e){const s=new FileReader,o=i.fromEvent(s,"load").pipe(n.tap((t=>{const i=t.target.result;this.resize(i,(t=>{this.previews[e]=t,this.pushChanges()}))})));return s.readAsDataURL(t),o}uploadFile$(t){return ta.upload$([t]).pipe(n.switchMap((t=>{const e=t[0],i=ds.fromUrl(e.url);return ta.assetCreate$(i)})))}resize(t,e){if("function"==typeof e){const i=document.createElement("img");i.onload=function(){const t=document.createElement("canvas"),n=t.getContext("2d");let s=i.width,o=i.height;s>o?s>320&&(o*=320/s,s=320):o>240&&(s*=240/o,o=240),t.width=s,t.height=o,n.drawImage(i,0,0,s,o);const r=t.toDataURL("image/jpeg",.9);e(r)},i.src=t}}supported(){return(e=document.createElement("input")).type="file","files"in e&&!!((t=new XMLHttpRequest)&&"upload"in t&&"onprogress"in t.upload)&&!!window.FormData;var t,e}}class pc extends xa{get items(){return this.items_}set items(t){this.items_=t,this.uploadCount=t.reduce(((t,e)=>t+(e.uploading||e.completed?0:1)),0)}onInit(){this.label=this.label||"label",this.accept=this.accept||"image/png, image/jpeg",this.multiple=!1!==this.multiple,this.items=[],this.assets=this.control.value||[],this.hasFiles=!1;const{node:e}=t.getContext(this),i=e.querySelector("input");i.setAttribute("accept",this.accept);const s=e.querySelector(".upload-drop"),o=this.service=new uc;o.drop$(i,s).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.items=t,this.pushChanges()})),o.change$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.items=t,this.pushChanges()})),o.events$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t instanceof hc&&(this.assets.push(t.asset),this.control.value=this.assets),this.items=this.items_,this.pushChanges()}))}onUpload(){this.service.upload$().pipe(n.first()).subscribe()}onCancel(){this.service.removeAll()}onItemPause(t){}onItemResume(t){}onItemCancel(t){}onItemRemove(t){this.service.remove(t)}}pc.meta={selector:"[control-assets]",inputs:["control","label","multiple"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="listing--assets">\n\t\t\t\t<div class="listing__item" *for="let item of assets">\n\t\t\t\t\t<div class="upload-item">\n\t\t\t\t\t\t<div class="picture">\n\t\t\t\t\t\t\t<img [lazy]="item | asset" [size]="{ width: 320, height: 240 }" *if="item.type.name === \'image\'" />\n\t\t\t\t\t\t\t<video [src]="item | asset" *if="item.type.name === \'video\'"></video>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="name" [innerHTML]="item.file"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="listing__item" *for="let item of items">\n\t\t\t\t\t<div upload-item [item]="item" (pause)="onItemPause($event)" (resume)="onItemResume($event)" (cancel)="onItemCancel($event)" (remove)="onItemRemove($event)"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<div class="btn--browse">\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t\t<input type="file" accept="image/jpeg" multiple />\n\t\t\t\t</div>\n\t\t\t\t<div class="btn--upload" (click)="onUpload()" *if="uploadCount > 0" [innerHTML]="\'upload\' | label"></div>\n\t\t\t\t<div class="btn--cancel" (click)="onCancel()" *if="uploadCount > 0" [innerHTML]="\'cancel\' | label"></div>\n\t\t\t</div>\n\t\t\t<div class="upload-drop">\n    \t\t\t<span [innerHTML]="\'drag_and_drop_images\' | label"></span>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class mc extends t.Component{get data(){let e=null;const{parentInstance:i}=t.getContext(this);return i instanceof Qn&&(e=i.modal.data),e}onInit(){console.log(this.data),this.page=null,ga.currentLanguagePage$(this.data.mode).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.page=t,this.pushChanges()}))}onClose(){an.reject()}}mc.meta={selector:"[generic-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container" *if="page">\n\t\t\t<h1 class="title" [innerHTML]="page.title"></h1>\n\t\t\t<div class="description" [innerHTML]="page.description"></div>\n\t\t</div>\n\t\t<div class="modal__footer">\n\t\t\t<button type="button" class="btn--accept" (click)="onClose()">\n\t\t\t\t<span [innerHTML]="\'title_close\' | label"></span>\n\t\t\t</button>\n\t\t</div>\n\t'},mc.chunk=()=>'<div class="generic-modal" generic-modal></div>';class vc extends xa{onInit(){this.label=this.label||"label",this.linksSubject=new i.ReplaySubject,this.links$().pipe(n.takeUntil(this.unsubscribe$)).subscribe()}onChanges(){const{node:e}=t.getContext(this),n=Array.prototype.slice.call(e.querySelectorAll("a"));this.linksSubject.next(n.length?i.fromEvent(n,"click"):i.EMPTY)}links$(){return this.linksSubject.pipe(n.switchAll(),n.tap((t=>{if(x.flags.gdprRoutes){const e=mc.chunk();an.open$({template:e,data:{mode:"privacy_policy"}}).pipe(n.first()).subscribe(),t.preventDefault()}})))}}vc.meta={selector:"[control-checkbox]",inputs:["control","label"],template:'\n\t\t<div class="group--form--checkbox" [class]="{ required: control.validators.length }">\n\t\t\t<label>\n\t\t\t\t<input type="checkbox" class="control--checkbox" [formControl]="control" [value]="true" />\n\t\t\t\t<span [innerHTML]="label | html"></span>\n\t\t\t</label>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class gc extends xa{onInit(){this.label=this.label||"label",this.dropped=!1,this.dropdownId=Oa.nextId(),Ns.typing$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.scrollToWord(t)}))}scrollToWord(e){const i=this.control.options||[];let n=-1;for(let t=0;t<i.length;t++){if(0===i[t].name.toLowerCase().indexOf(e.toLowerCase())){n=t;break}}if(-1!==n){const{node:e}=t.getContext(this),i=e.querySelector(".dropdown"),s=e.querySelector(".nav--dropdown").children[n];s&&i.scrollTo(0,s.offsetTop)}}setOption(t){let e;if(this.isMultiple){e=this.control.value||[];const i=e.indexOf(t.id);-1!==i?e.splice(i,1):e.push(t.id),e=e.length?e.slice():null}else e=t.id;this.control.value=e,this.change.next(e)}hasOption(t){if(this.isMultiple){return-1!==(this.control.value||[]).indexOf(t.id)}return this.control.value===t.id}getLabel(){let t=this.control.value;const e=this.control.options||[];if(this.isMultiple)return t=t||[],t.length?t.map((t=>{const i=e.find((e=>e.id===t||e.name===t));return i?i.name:""})).join(", "):"select";{const i=e.find((e=>e.id===t||e.name===t));return i?i.name:"select"}}onDropped(t){this.dropped&&null===t&&(this.control.touched=!0),this.dropped=t===this.dropdownId}get isMultiple(){return this.multiple&&!1!==this.multiple&&"false"!==this.multiple}}gc.meta={selector:"[control-custom-select]",outputs:["change"],inputs:["control","label","multiple"],template:'\n\t\t<div class="group--form--select" [class]="{ required: control.validators.length, multiple: isMultiple }" [dropdown]="dropdownId" (dropped)="onDropped($event)">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<span class="control--custom-select" [innerHTML]="getLabel() | label"></span>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t\t<div class="dropdown" [dropdown-item]="dropdownId">\n\t\t\t<div class="category" [innerHTML]="label"></div>\n\t\t\t<ul class="nav--dropdown" [class]="{ multiple: isMultiple }">\n\t\t\t\t<li (click)="setOption(item)" [class]="{ empty: item.id == null }" *for="let item of control.options">\n\t\t\t\t\t<span [class]="{ active: hasOption(item) }" [innerHTML]="item.name | label"></span>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</div>\n\t'};class fc extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1;const{node:e}=t.getContext(this),s=this.input=e.querySelector("input");i.merge(i.fromEvent(s,"input")).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidChange(t))),i.fromEvent(s,"blur").pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidBlur(t)))}onInputDidChange(t){}onInputDidBlur(t){this.control.touched=!0,this.value=this.input.value}}fc.meta={selector:"[control-link]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<input type="text" class="control--text" [formControl]="control" [placeholder]="label" [disabled]="disabled" />\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Ec extends xa{get localizedValue(){let t=this.control.value;if(t&&t.locale){const e=t.locale[this.currentLanguage];e&&(t=e)}return t}onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||"image/png, image/jpeg",this.languages=x.languages,this.currentLanguage=fe.lang;const{node:e}=t.getContext(this),s=e.querySelector("input");s.setAttribute("accept",this.accept),Ma.drop$(s).pipe(n.takeUntil(this.unsubscribe$)).subscribe(),Ma.change$(s).pipe(n.switchMap((t=>{const e=t.map(((t,e)=>ta.upload$([t]).pipe(n.switchMap((t=>(this.languages.length>1?ta.createOrUpdateLocalizedAsset$:ta.createOrUpdateAsset$)(t,this.control,this.currentLanguage))))));return i.combineLatest(e)})),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.control.value=t[0]}))}setLanguage(t){fe.setLanguage$(t).pipe(n.first()).subscribe((e=>{this.currentLanguage=t,this.pushChanges()}))}}Ec.meta={selector:"[control-localized-asset]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--picture">\n\t\t\t\t<div class="group--picture__info">\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t</div>\n\t\t\t\t<img [lazy]="localizedValue | asset" [size]="{ width: 320, height: 240 }" *if="localizedValue && localizedValue.type.name === \'image\'" />\n\t\t\t\t<video [src]="localizedValue | asset" *if="localizedValue && localizedValue.type.name === \'video\'"></video>\n\t\t\t\t<input type="file">\n\t\t\t</div>\n\t\t\t<div class="file-name" *if="localizedValue" [innerHTML]="localizedValue.file"></div>\n\t\t\t<ul class="nav--languages" *if="languages.length > 1">\n\t\t\t\t<li class="nav__item" [class]="{ active: lang == currentLanguage }" (click)="setLanguage(lang)" [innerHTML]="lang" *for="let lang of languages"></li>\n\t\t\t</ul>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class _c extends Ua{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||".glb";const{node:e}=t.getContext(this),s=this.input=e.querySelector("input");s.setAttribute("accept",this.accept),Ma.change$(s).pipe(n.switchMap((t=>{const e=t.map(((t,e)=>ta.upload$([t]).pipe(n.switchMap((t=>ta.createOrUpdateAsset$(t,this.control))))));return i.combineLatest(e)})),n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.control.value=t[0]}))}onRemove(t){ta.assetDelete$(this.control.value).pipe(n.first()).subscribe((()=>{this.control.value=null,this.input.value=null,this.control.touched=!0}))}read$(t,e){return i.of(t)}}_c.meta={selector:"[control-model]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--model">\n\t\t\t\t<div class="file-name" *if="!control.value" [innerHTML]="\'select_file\' | label"></div>\n\t\t\t\t<div class="file-name" *if="control.value" [innerHTML]="control.value.file"></div>\n\t\t\t\t<div class="btn--upload"><input type="file"><span [innerHTML]="\'browse\' | label"></span></div>\n\t\t\t\t<div class="btn--remove" *if="control.value" (click)="onRemove($event)"><span [innerHTML]="\'remove\' | label"></span></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Sc extends xa{onInit(){this.label=this.label||"label",this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1}updateValue(t){this.control.value=t}}Sc.meta={selector:"[control-number]",inputs:["control","label","precision","increment","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="control--content control--number">\n\t\t\t\t<input-value label="" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value" (update)="updateValue($event)"></input-value>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class bc extends xa{onInit(){this.label=this.label||"label"}}bc.meta={selector:"[control-password]",inputs:["control","label"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<input type="password" class="control--text" [formControl]="control" [placeholder]="label" />\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Tc extends xa{onInit(){this.label=this.label||"label"}}Tc.meta={selector:"[control-select]",inputs:["control","label"],template:'\n\t\t<div class="group--form--select" [class]="{ required: control.validators.length }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<select class="control--select" [formControl]="control" required>\n\t\t\t\t<option [value]="null" [innerHTML]="\'select\' | label"></option>\n\t\t\t\t<option [value]="item.id" *for="let item of control.options" [innerHTML]="item.name"></option>\n\t\t\t</select>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class yc extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1}}yc.meta={selector:"[control-text]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t<input type="text" class="control--text" [formControl]="control" [placeholder]="label" [disabled]="disabled" />\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class wc extends xa{onInit(){this.label=this.label||"label",this.disabled=this.disabled||!1}}wc.meta={selector:"[control-textarea]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form--textarea" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<textarea class="control--text" [formControl]="control" [placeholder]="label" [innerHTML]="label" rows="4" [disabled]="disabled"></textarea>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Cc extends xa{onInit(){this.label=this.label||"label",this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1}updateValue(t,e){const i=this.control.value;i[t]=e,this.control.value=i.slice()}}Cc.meta={selector:"[control-vector]",inputs:["control","label","precision","increment","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="control--content control--vector">\n\t\t\t\t<input-value label="x" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[0]" (update)="updateValue(0, $event)"></input-value>\n\t\t\t\t<input-value label="y" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[1]" (update)="updateValue(1, $event)"></input-value>\n\t\t\t\t<input-value label="z" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[2]" (update)="updateValue(2, $event)"></input-value>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};class Rc extends t.Directive{onChanges(){const{node:e}=t.getContext(this);!0===this.disabled?(e.disabled=this.disabled,e.setAttribute("disabled",this.disabled)):(delete e.disabled,e.removeAttribute("disabled"))}}Rc.meta={selector:"input[disabled],textarea[disabled]",inputs:["disabled"]};class Ic extends xa{getLabel(t,e){return ve.transform(`error_${t}`)}}Ic.meta={selector:"errors-component",inputs:["control"],template:'\n\t<div class="inner" [style]="{ display: control.invalid && control.touched ? \'block\' : \'none\' }">\n\t\t<div class="error" *for="let [key, value] of control.errors">\n\t\t\t<span [innerHTML]="getLabel(key, value)"></span>\n\t\t\t\x3c!-- <span class="key" [innerHTML]="key"></span> <span class="value" [innerHTML]="value | json"></span> --\x3e\n\t\t</div>\n\t</div>\n\t'};class Ac extends t.Component{onInit(){this.label=this.label||"label",this.value=this.value||0,this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1,this.increment$(".btn--more",1).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.value+=t,this.update.next(this.value),this.pushChanges()})),this.increment$(".btn--less",-1).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.value+=t,this.update.next(this.value),this.pushChanges()}));const{node:e}=t.getContext(this),s=this.input=e.querySelector("input");i.merge(i.fromEvent(s,"input")).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidChange(t))),i.merge(i.fromEvent(s,"blur"),i.fromEvent(s,"keydown").pipe(n.filter((t=>"Enter"===t.key||13===t.keyCode)))).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.onInputDidBlur(t)))}onInputDidChange(t){t.target.value=t.target.value.replace(/[^\d|\.|-]/g,"")}onInputDidBlur(t){const e=parseFloat(this.input.value);this.value!==e&&(isNaN(e)?this.input.value=this.getValue():(this.value=e,this.update.next(this.value)))}increment$(e,s){const{node:o}=t.getContext(this),r=o.querySelector(e);let a,c;return i.race(i.fromEvent(r,"mousedown"),i.fromEvent(r,"touchstart")).pipe(n.tap((()=>{c=this.increment,a=16})),n.switchMap((t=>i.interval(30).pipe(n.filter((t=>t%a==0)),n.map((()=>{const t=c*s;return a=Math.max(1,Math.floor(.85*a)),t})),n.takeUntil(i.race(i.fromEvent(r,"mouseup"),i.fromEvent(r,"touchend")))))))}getValue(){return this.value.toFixed(this.precision)}setValue(t){this.value+=this.increment*t,this.update.next(this.value),this.pushChanges()}}Ac.meta={selector:"input-value",outputs:["update"],inputs:["value","label","precision","increment","disabled"],template:'\n\t\t<div class="group--control" [class]="{ disabled: disabled }">\n\t\t\t<input type="text" class="control--text" [placeholder]="label" [value]="getValue()" [disabled]="disabled" />\n\t\t\t<div class="control--trigger">\n\t\t\t\t<div class="btn--more" (click)="setValue(1)">+</div>\n\t\t\t\t<div class="btn--less" (click)="setValue(-1)">-</div>\n\t\t\t</div>\n\t\t</div>\n\t'};class Oc extends t.Component{onInit(){this.env=L}onTest(t){this.test.next(t)}onReset(t){this.reset.next(t)}}Oc.meta={selector:"test-component",inputs:["form"],outputs:["test","reset"],template:'\n\t<div class="group--form--results" *if="env.DEVELOPMENT">\n\t\t<code [innerHTML]="form.value | json"></code>\n\t\t<button type="button" class="btn--mode" (click)="onReset($event)"><span>reset</span></button>\n\t\t<button type="button" class="btn--mode" (click)="onTest($event)"><span>test</span></button>\n\t</div>\n\t'};class Nc extends t.Directive{onChanges(e){const{node:i}=t.getContext(this);i.value=this.value,i.setAttribute("value",this.value)}}Nc.meta={selector:"[value]",inputs:["value"]};class kc extends t.Pipe{static transform(t){if(t){t=t.replace(/&#(\d+);/g,(function(t,e){return String.fromCharCode(parseInt(e))}));const e=['"',"&","'","<",">"," ","¡","¢","£","¤","¥","¦","§","¨","©","ª","«","¬","­","®","¯","°","±","²","³","´","µ","¶","·","¸","¹","º","»","¼","½","¾","¿","À","Á","Â","Ã","Ä","Å","Æ","Ç","È","É","Ê","Ë","Ì","Í","Î","Ï","Ð","Ñ","Ò","Ó","Ô","Õ","Ö","×","Ø","Ù","Ú","Û","Ü","Ý","Þ","ß","à","á","ã","ä","å","æ","ç","è","é","ê","ë","ì","í","î","ï","ð","ñ","ò","ó","ô","õ","ö","÷","ø","ù","ú","û","ü","ý","þ","ÿ","&","•","°","∞","‰","⋅","±","†","—","¬","µ","⊥","∥","€","£","¥","¢","©","®","™","α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","τ","υ","φ","χ","ψ","ω","Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω"],i=new RegExp(`(&${["quot","amp","apos","lt","gt","nbsp","iexcl","cent","pound","curren","yen","brvbar","sect","uml","copy","ordf","laquo","not","shy","reg","macr","deg","plusmn","sup2","sup3","acute","micro","para","middot","cedil","sup1","ordm","raquo","frac14","frac12","frac34","iquest","Agrave","Aacute","Acirc","Atilde","Auml","Aring","AElig","Ccedil","Egrave","Eacute","Ecirc","Euml","Igrave","Iacute","Icirc","Iuml","ETH","Ntilde","Ograve","Oacute","Ocirc","Otilde","Ouml","times","Oslash","Ugrave","Uacute","Ucirc","Uuml","Yacute","THORN","szlig","agrave","aacute","atilde","auml","aring","aelig","ccedil","egrave","eacute","ecirc","euml","igrave","iacute","icirc","iuml","eth","ntilde","ograve","oacute","ocirc","otilde","ouml","divide","oslash","ugrave","uacute","ucirc","uuml","yacute","thorn","yuml","amp","bull","deg","infin","permil","sdot","plusmn","dagger","mdash","not","micro","perp","par","euro","pound","yen","cent","copy","reg","trade","alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","omicron","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega","Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"].join(";)|(&")};)`,"g");return t=t.replace(i,(function(){for(let t=1;t<arguments.length;t++)if(arguments[t])return e[t-1]})),t}}}kc.meta={name:"html"};class Lc extends t.Directive{onChanges(){const{node:e}=t.getContext(this);e.setAttribute("id",this.id)}}Lc.meta={selector:"[id]",inputs:["id"]};class Pc extends t.Component{onInit(){this.showLanguages=!1,this.languageService=fe}setLanguage(t){this.languageService.setLanguage$(t).pipe(n.first()).subscribe((t=>{this.showLanguages=!1,this.pushChanges(),this.set.next()}))}toggleLanguages(){this.showLanguages=!this.showLanguages,this.pushChanges()}}Pc.meta={selector:"[language]",outputs:["set"],template:'\n\t\t<button type="button" class="btn--language" (click)="toggleLanguages()" *if="languageService.hasLanguages"><span [innerHTML]="languageService.activeLanguage.title"></span> <svg viewBox="0 0 8 5"><use xlink:href="#caret-down"></use></svg></button>\n\t\t<ul class="nav--language" *if="showLanguages">\n\t\t\t<li (click)="setLanguage(language)" *for="let language of languageService.languages"><span [innerHTML]="language.title"></span></li>\n\t\t</ul>\n\t'};class Dc{static get cache(){return this.cache_||(this.cache_={}),this.cache_}static get(t){return this.cache[t]}static set(t,e){this.cache[t]=e;const i=Object.keys(this.cache);i.length>100&&this.remove(i[0])}static remove(t){delete this.cache[t]}}class Mc extends t.Directive{onInit(){const{node:e}=t.getContext(this);e.classList.add("lazy"),this.input$=(new i.Subject).pipe(n.distinctUntilChanged(),n.switchMap((t=>{const n=Dc.get(t);return n?i.of(n):(e.classList.remove("lazyed"),this.lazy$(t))})),n.takeUntil(this.unsubscribe$)),this.input$.subscribe((t=>{Dc.set(this.lazy,t),e.setAttribute("src",t),e.classList.add("lazyed")}))}onChanges(){this.input$.next(this.lazy)}lazy$(e){const{node:s}=t.getContext(this);return class{static observer(){return this.observer_||(this.readySubject_=new i.BehaviorSubject(!1),this.observerSubject_=new i.Subject,this.observer_=new IntersectionObserver((t=>{this.observerSubject_.next(t)}))),this.observer_}static intersection$(t){if("IntersectionObserver"in window){const e=this.observer();return e.observe(t),this.observerSubject_.pipe(n.map((e=>e.find((e=>e.target===t)))),n.filter((t=>void 0!==t&&t.isIntersecting)),n.first(),n.finalize((()=>e.unobserve(t))))}return i.of({target:t})}}.intersection$(s).pipe(n.switchMap((()=>lo.load$(e,this.size))),n.first())}}Mc.meta={selector:"[lazy],[[lazy]]",inputs:["lazy","size"]};class xc extends t.Pipe{static transform(t){let e=xc.urlify(t);return e=xc.breakLines(e),e}static urlify(t){return t.replace(/(?:(?:https?|ftp):\/\/|\b(?:[a-z\d]+\.))(?:(?:[^\s()<>]+|\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))?\))+(?:\((?:[^\s()<>]+|(?:\(?:[^\s()<>]+\)))?\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))?/gim,(t=>`<a href="${t}" target="_blank">${t}</a>`))}static breakLines(t){return t.replace(/\n/gm,(t=>"<br>"))}}xc.meta={name:"message"};class Uc extends t.Component{onInit(){const{parentInstance:e}=t.getContext(this);e instanceof Qn&&(this.data=e.modal.data)}onClose(){an.reject()}}Uc.meta={selector:"[modal]"};class Vc extends t.Directive{constructor(){super(...arguments),this.path=void 0,this.segments=void 0,this.routerLink_=void 0}get routerLink(){return this.routerLink_}set routerLink(t){this.routerLink_=Array.isArray(t)?t:[t]}onInit(){this.routerLink$().pipe(n.takeUntil(this.unsubscribe$)).subscribe()}onChanges(){const{node:e}=t.getContext(this),i=this.routerLink;if(i.length){const t=te.buildUrl(...i);e.setAttribute("href",t)}else e.setAttribute("href","")}routerLink$(){const{node:e}=t.getContext(this);return i.fromEvent(e,"click").pipe(n.map((t=>(te.setRouterLink(...this.routerLink),t.preventDefault(),!1))))}getSegments(t){const e=[];return t.forEach((t=>{if("string"==typeof t){const e=/([^:]+)|\:([^\/]+)/g,i=t.matchAll(e);for(let t of i){const e=t[1],i=t[2];if(e);else if(i){({})[i]=null}}}else e.push(new RouteSegment("",{}))})),e}}Vc.meta={selector:"[routerLink]",inputs:["routerLink"]};class Bc extends t.Component{onInit(){super.onInit();const{parentInstance:e}=t.getContext(this);e instanceof Qn&&(this.data=e.modal.data)}onAccept(t){an.resolve()}onReject(t){an.reject()}onClose(){an.reject()}}Bc.meta={selector:"[support-request-modal]",template:'\n\t\t<div class="modal__header">\n\t\t\t<button type="button" class="btn--close" (click)="onClose()">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#close"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="container">\n\t\t\t<div class="form">\n\t\t\t\t<div class="title">Un operatore è disponibile per un tour guidato.<br>Desideri Accettare?</div>\n\t\t\t\t<div class="group--cta">\n\t\t\t\t\t<button type="button" class="btn--accept" (click)="onAccept()">\n\t\t\t\t\t\t<span>Accetta</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button type="button" class="btn--cancel" (click)="onReject()">\n\t\t\t\t\t\t<span>Rifiuta</span>\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'},Bc.chunk=()=>'<div class="support-request-modal" support-request-modal></div>';class jc extends t.Structure{onInit(){this.update()}onChanges(){this.update()}update(){if(this.name_!==this.name){this.name_=this.name;const{node:e}=t.getContext(this);if(e.parentNode){const t="http://www.w3.org/2000/svg",i=document.createElementNS(t,"svg"),n=this.width||24,s=this.height||24;i.setAttribute("class",`icon--${this.name}`),i.setAttributeNS(null,"viewBox",`0 0 ${n} ${s}`),i.innerHTML=`<use xlink:href="#${this.name}"></use>`,i.rxcompId=e.rxcompId,i.classList.add(...e.classList),e.parentNode.replaceChild(i,e)}}}}jc.meta={selector:"svg-icon",inputs:["name","width","height"]};class Fc extends t.Directive{set title(e){if(this.title_!==e){this.title_=e;const{node:i}=t.getContext(this);e?i.setAttribute("title",e):i.removeAttribute("title")}}get title(){return this.title_}}Fc.meta={selector:"[[title]]",inputs:["title"]};class Hc extends t.Component{onInit(){null===this.item.preview&&this.read$(this.item.file).pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.item.preview=t,this.pushChanges()}))}read$(t){const e=new FileReader,s=i.fromEvent(e,"load").pipe(n.switchMap((t=>{const e=t.target.result;return this.item.type.name===ns.Image.name?this.resize$(e):i.of(e)})));return e.readAsDataURL(t),s}resize$(t){return new Promise(((e,i)=>{const n=document.createElement("img");n.onload=function(){const t=document.createElement("canvas"),i=t.getContext("2d");let s=n.width,o=n.height;s>o?s>320&&(o*=320/s,s=320):o>240&&(s*=240/o,o=240),t.width=s,t.height=o,i.drawImage(n,0,0,s,o);const r=t.toDataURL("image/jpeg",.9);e(r)},n.onerror=function(t){i(t)},n.src=t}))}onPause(){this.pause.next(this.item)}onResume(){this.resume.next(this.item)}onCancel(){this.cancel.next(this.item)}onRemove(){this.remove.next(this.item)}}Hc.meta={selector:"[upload-item]",outputs:["pause","resume","cancel","remove"],inputs:["item"],template:'\n\t<div class="upload-item" [class]="{ \'error\': item.error, \'success\': item.success }">\n\t\t<div class="picture">\n\t\t\t<img [lazy]="item.preview" [size]="{ width: 320, height: 240 }" *if="item.preview && item.type.name === \'image\'" />\n\t\t\t<video [src]="item.preview" *if="item.preview && item.type.name === \'video\'"></video>\n\t\t\t<svg class="spinner" width="24" height="24" viewBox="0 0 24 24" [class]="{ uploading: item.uploading }" *if="item.uploading"><use xlink:href="#spinner"></use></svg>\n\t\t</div>\n\t\t<div class="name">{{item.name}}</div>\n\t\t\x3c!--\n\t\t<div class="group--info">\n\t\t\t<div>progress: {{item.progress}}</div>\n\t\t\t<div>size: {{item.size}} bytes</div>\n\t\t\t<div>current speed: {{item.currentSpeed}} bytes/s</div>\n\t\t\t<div>average speed: {{item.averageSpeed}} bytes/s</div>\n\t\t\t<div>time ramining: {{item.timeRemaining}}s</div>\n\t\t\t<div>paused: {{item.paused}}</div>\n\t\t\t<div>success: {{item.success}}</div>\n\t\t\t<div>complete: {{item.complete}}</div>\n\t\t\t<div>error: {{item.error}}</div>\n\t\t</div>\n\t\t--\x3e\n\t\t\x3c!--\n\t\t<div class="group--cta" *if="!item.complete && item.uploading">\n\t\t\t<div class="btn--pause" (click)="onPause()">pause</div>\n\t\t\t<div class="btn--resume" (click)="onResume()">resume</div>\n\t\t\t<div class="btn--cancel" (click)="onCancel()">cancel</div>\n\t\t</div>\n\t\t--\x3e\n\t\t<div class="group--cta">\n\t\t\t<div class="btn--remove" (click)="onRemove()" *if="!item.complete">remove</div>\n\t\t</div>\n\t</div>\n\t'};class Gc extends t.Directive{set hls(t){this.hls_!==t&&(this.hls_=t,this.play(t))}get hls(){return this.hls_}play(e){const{node:i}=t.getContext(this);if(Hls.isSupported()){var n=new Hls;n.attachMedia(i),n.on(Hls.Events.MEDIA_ATTACHED,(()=>{n.loadSource(e),n.on(Hls.Events.MANIFEST_PARSED,((t,e)=>{i.play()}))}))}}}Gc.meta={selector:"[[hls]]",inputs:["hls"]};class $c extends t.Context{constructor(t,e,i,n,s,o,r){super(r),this[t]=e,this[i]=n,this.index=s,this.count=o}get first(){return 0===this.index}get last(){return this.index===this.count-1}get even(){return this.index%2==0}get odd(){return!this.even}}const Wc=1,zc=2,Kc=3;class qc extends t.Structure{onInit(){const{module:e,node:s}=t.getContext(this),o=s.firstElementChild,r=s.getAttribute("*virtual");s.removeAttribute("*virtual"),s.removeChild(o);const a=this.tokens=this.getExpressionTokens(r);this.virtualFunction=e.makeFunction(a.iterable),this.container=s,this.template=o,this.mode=this.mode||1,this.width=this.width||250,this.gutter=void 0!==this.gutter?this.gutter:20,this.reverse=!0===this.reverse,this.options={width:this.width,gutter:this.gutter,reverse:this.reverse,containerWidth:0,containerHeight:0,top:0,cols:[0]},this.cachedRects={},this.cachedInstances=[],this.cacheNodes=[],this.items$=new i.BehaviorSubject([]),this.update$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{}))}onChanges(e){const i=t.getContext(this),n=i.module.resolve(this.virtualFunction,i.parentInstance,this)||[];this.mode=this.mode||1,this.width=this.width||250,this.gutter=void 0!==this.gutter?this.gutter:20,this.options.width=this.width,this.updateView(!0),this.items$.next(n)}update$(){return this.updateView(!0),i.merge(this.scroll$(),this.resize$(),this.items$.pipe(n.distinctUntilChanged())).pipe(n.map((t=>this.updateForward())))}updateForward(){const t=this.options,e=this.items$.getValue(),i=e.length;this.container.position="relative";let n=0;const s=this.getWidth(),o=this.getGutter(s),r=[];for(let a=0,c=e.length;a<c;a++){const c=e[a];let l,d,h,u,p,m=this.cachedRects[a];if(m?(l=m.col,d=m.height,u=m.left):(l=this.getCol(),d=this.getHeight(s,c)),h=t.cols[l],this.intersect(h+t.top,h+d+t.top,0,t.containerHeight)){m||(u=this.getLeft(l,s,o));const e=this.cachedNode(a,a,c,i);e.style.position="absolute",e.style.top=h+"px",e.style.left=u+"px",e.style.width=s+"px",d!==e.offsetHeight&&(d=e.offsetHeight),p=h+d+t.gutter,n=Math.max(n,p),t.cols[l]=p,m?(m.height=d,m.bottom=p):this.cachedRects[a]={col:l,width:s,height:d,left:u,top:h,bottom:p},r.push(c)}else this.removeNode(a),p=h+d+t.gutter,t.cols[l]=p,n=Math.max(n,p)}let a=e.length;for(;a<this.cacheNodes.length;)this.removeNode(a),a++;this.cacheNodes.length=e.length;const c=this.container.parentNode;if(this.reverse&&n<c.offsetHeight-1){const t=c.offsetHeight-1-n;e.forEach(((e,n)=>{if(-1!==r.indexOf(e)){const s=this.cachedRects[n];this.cachedNode(n,n,e,i).style.top=s.top+t+"px"}})),this.container.style.height=c.offsetHeight-1+"px"}else this.container.style.height=`${n}px`;return r}getCols(){const t=this.options,e=Math.floor((t.containerWidth+t.gutter)/(t.width+t.gutter))||1;return new Array(e).fill(0)}getCol(){const t=this.options;let e;switch(this.mode){case zc:case Kc:case Wc:e=t.cols.reduce(((t,e,i,n)=>e<n[t]?i:t),0);break;default:e=0}return e}getWidth(){const t=this.options;let e;switch(this.mode){case zc:case Kc:e=t.width;break;case Wc:e=(t.containerWidth-(t.cols.length-1)*t.gutter)/t.cols.length;break;default:e=t.containerWidth}return e}getHeight(t,e){const i=this.options;let n;switch(this.mode){case zc:case Kc:case Wc:n=i.width;break;default:n=80}return n}getGutter(t){const e=this.options;let i;switch(this.mode){case zc:case Kc:i=e.gutter;break;case Wc:i=(e.containerWidth-e.cols.length*t)/(e.cols.length-1);break;default:i=0}return i}getLeft(t,e,i){const n=this.options;let s;switch(this.mode){case zc:case Wc:s=t*(e+i);break;case Kc:s=(n.containerWidth-n.cols.length*(e+i)+i)/2+t*(e+i);break;default:s=0}return s}cachedNode(t,e,i,n){return this.cacheNodes[t]?this.updateNode(t,e,i):this.createNode(t,e,i,n)}createNode(e,i,n,s){const o=this.template.cloneNode(!0);delete o.rxcompId,this.container.appendChild(o),this.cacheNodes[e]=o;const r=t.getContext(this),a=r.module,c=this.tokens,l=[c.key,i,c.value,n,i,s,r.parentInstance],d=a.makeInstance(o,$c,r.selector,r.parentInstance,l),h=t.getContext(d);return a.compile(o,h.instance),this.cachedInstances[e]=d,o}updateNode(t,e,i){const n=this.cachedInstances[t],s=this.tokens;return n[s.key]!==e&&(n[s.key]=e,n[s.value]=i,n.pushChanges()),this.cacheNodes[t]}removeNode(e){this.cachedInstances[e]=void 0;const i=this.cacheNodes[e];if(i){const e=t.getContext(this).module;i.parentNode.removeChild(i),e.remove(i)}return this.cacheNodes[e]=void 0,i}intersect(t,e,i,n){return i<e&&n>t}resize$(){return i.fromEvent(window,"resize").pipe(n.startWith((t=>null)),n.auditTime(100),n.tap((()=>this.updateView(!0))))}scroll$(){const{node:e}=t.getContext(this);return e.parentNode&&"auto"===getComputedStyle(e.parentNode).overflowY?i.fromEvent(e.parentNode,"scroll").pipe(n.tap((()=>{this.updateView()}))):i.fromEvent(window,"scroll").pipe(n.tap((()=>this.updateView())))}updateView(t){const e=this.container.getBoundingClientRect(),i=this.options;i.top=e.top,i.containerWidth=e.width,i.containerHeight=this.container.parentNode.offsetHeight,i.cols=this.getCols(),t&&(this.cachedRects={})}getExpressionTokens(t){if(null===t)throw new Error("invalid virtual");if(-1===t.trim().indexOf("let ")||-1===t.trim().indexOf(" of "))throw new Error("invalid virtual");const e=t.split(";").map((t=>t.trim())).filter((t=>""!==t)),i=e[0].split(" of ").map((t=>t.trim()));let n=i[0].replace(/\s*let\s*/,"");const s=i[1];let o="index";const r=n.match(/\[(.+)\s*,\s*(.+)\]/);if(r&&(o=r[1],n=r[2]),e.length>1){const t=e[1].split(/\s*let\s*|\s*=\s*index/).map((t=>t.trim()));3===t.length&&(o=t[1])}return{key:o,value:n,iterable:s}}}qc.meta={selector:"[*virtual]",inputs:["mode","width","gutter","reverse"]};class Yc extends t.Component{onInit(){this.playing=!1,this.progress=0,this.media$().pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.drag$().pipe(n.takeUntil(this.unsubscribe$)).subscribe()}media$(){const{node:e}=t.getContext(this),i=document.querySelector(".page");return Ts.events$.pipe(n.tap((t=>{t instanceof fs?(this.media=t.loader,this.playing=!0,e.classList.add("active"),i.classList.add("media-player-active"),this.pushChanges()):this.media===t.loader&&(t instanceof Es?(this.playing=!1,this.pushChanges()):t instanceof Ss?this.dragging||(this.progress=this.media.progress,this.pushChanges()):t instanceof _s&&(this.media=null,e.classList.remove("active"),i.classList.remove("media-player-active"),this.pushChanges()))})))}drag$(){const{node:e}=t.getContext(this),i=e.querySelector(".track");let s;return Xs.observe$(i).pipe(n.filter((t=>this.media)),n.tap((t=>{if(t instanceof Ks){const e=i.getBoundingClientRect();s=Math.max(0,Math.min(1,(t.down.x-e.left)/e.width)),this.dragging=!0}else if(t instanceof qs){const e=i.getBoundingClientRect(),n=Math.max(0,Math.min(1,s+t.distance.x/e.width));this.progress=n,this.pushChanges()}else t instanceof Ys&&(this.media.progress=this.progress,this.dragging=!1)})))}onPlay(){this.media.play()}onPause(){this.media.pause()}onTrack(t){const e=t.currentTarget.getBoundingClientRect(),i=(t.screenX-e.left)/e.width;this.media.progress=i}}Yc.meta={selector:"[media-player]"};const Jc=100.99;class Xc extends Gr{get title(){return this.title_}set title(t){if(this.title_!==t){const e=null!=this.title_;this.title_=t,e?this.updateBanner():this.createBanner()}}onChanges(){this.title=this.item.title}createBanner(){this.getCanvasTexture().then((t=>{const e=t.texture;e.wrapS=e.wrapY=THREE.RepeatWrapping,e.repeat.x=24,e.encoding=THREE.sRGBEncoding;const i=24*t.width/t.height,n=Math.PI/180*360,s=Jc*n/i,o=new THREE.CylinderBufferGeometry(Jc,Jc,s,80,2,!0,0,n);o.scale(-1,1,1);const r=new THREE.MeshBasicMaterial({map:e,transparent:!0,opacity:0,toneMapped:!1}),a=this.mesh;(this.banners=new Array(1).fill(0).map((t=>new THREE.Mesh(o,r)))).forEach(((t,e)=>{t.rotation.y=Math.PI/2*e}));const c={value:0};gsap.to(c,{duration:.5,value:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{r.opacity=c.value,r.needsUpdate=!0}}),a.userData={render:()=>{a.rotation.y+=Math.PI/180*.02,r.needsUpdate=!0}}}))}updateBanner(){this.getCanvasTexture().then((t=>{}))}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}getCanvasTexture(){return new Promise(((t,e)=>{let i=512,n=128;const s=Math.floor(102.4),o=Math.floor(9.6);let r;r=this.canvas?this.canvas:this.canvas=document.createElement("canvas"),r.width=i,r.height=n;const a=this.item.title,c=r.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.font=`${s}px ${x.fontFamily}`;let l;i=c.measureText(a).width+8,i=Math.max(512,Math.pow(2,Math.ceil(Math.log(i)/Math.log(2)))),r.width=i,c.clearRect(0,0,i,n),c.fillStyle="#0000005A",c.fillRect(0,0,i,n),c.font=`${s}px ${x.fontFamily}`,c.textAlign="center",c.textBaseline="middle",c.strokeStyle="rgba(0, 0, 0, 0.5)",c.lineWidth=o,c.lineJoin="round",c.miterLimit=2,c.strokeText(a,i/2,64),c.fillStyle="white",c.fillText(a,i/2,64,i),this.texture?(l=this.texture,l.needsUpdate=!0):l=this.texture=new THREE.CanvasTexture(r),t({texture:l,width:i,height:n})}))}}Xc.meta={selector:"[model-banner]",hosts:{host:Hr},inputs:["item"]};class Qc extends $r{onInit(){super.onInit()}onChanges(){const t=this.item.selected;this.editing=t,this.mesh&&(this.mesh.editing=t)}onCreate(t,e){const i=this.item,s=this.view;s.items;const o=this.getCurvedPanelGeometry(i);let r,a;this.onMeshDown=this.onMeshDown.bind(this),this.onMeshPlaying=this.onMeshPlaying.bind(this),this.onMeshZoomed=this.onMeshZoomed.bind(this),this.onMeshCurrentTime=this.onMeshCurrentTime.bind(this),$s.getStreamId$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe((c=>{this.streamId!==c&&(this.streamId=c,a&&(a.unsubscribe(),a=null),c||!i.asset?(i.streamId=c,r=this.disposableMesh=new $s(i,s,o,this.host),r.updateFromItem(i),r.name="curved-plane",r.load((()=>{this.disposableMesh=null,"function"==typeof t&&t(r,i),a=r.events$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((()=>{}))})),this.addMeshListeners(r)):this.mesh&&e(this.mesh,i))}))}addMeshListeners(t){t.on("down",this.onMeshDown),t.on("playing",this.onMeshPlaying),t.on("zoomed",this.onMeshZoomed),t.on("currentTime",this.onMeshCurrentTime)}removeMeshListeners(t){t.off("down",this.onMeshDown),t.off("playing",this.onMeshPlaying),t.off("zoomed",this.onMeshZoomed),t.off("currentTime",this.onMeshCurrentTime)}onMeshDown(){this.down.next(this)}onMeshPlaying(t){this.play.next({itemId:this.item.id,playing:t})}onMeshZoomed(t){this.zoom.next({itemId:this.item.id,zoomed:t})}onMeshCurrentTime(t){this.currentTime.next({itemId:this.item.id,currentTime:t})}onDestroy(){super.onDestroy(),this.disposableMesh&&(this.removeMeshListeners(this.disposableMesh),this.disposableMesh.dispose()),this.mesh&&(this.removeMeshListeners(this.mesh),this.mesh.dispose())}onUpdate(t,e){if(t.radius!==this.radius_||t.height!==this.height_||t.arc!==this.arc_){e.geometry.dispose();const i=this.getCurvedPanelGeometry(t);e.geometry=i}e.updateFromItem(t),this.updateHelper()}onUpdateAsset(t,e){e.updateByItem(t),$s.getStreamId$(t).pipe(n.filter((t=>null!==t)),n.take(1)).subscribe((i=>{t.streamId=i,e.load((()=>{}))}))}onDragMove(t,e,i){const n=this.item,s=this.mesh;n.showPanel=!1,this.editing=!0,s.position.set(t.x,t.y,t.z),i?(t.normalize().multiplyScalar(20),s.lookAt(ws.origin)):(s.position.set(0,0,0),s.lookAt(e),s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))),this.updateHelper()}onDragEnd(){const t=this.item,e=this.mesh;t.position=e.position.toArray(),t.rotation=e.rotation.toArray(),t.scale=e.scale.toArray(),e.updateFromItem(t),this.editing=!1}getCurvedPanelGeometry(t){this.radius_=t.radius,this.height_=t.height,this.arc_=t.arc;const e=Math.PI/180*t.arc,i=new THREE.CylinderBufferGeometry(t.radius,t.radius,t.height,36,2,!0,0,e);return i.rotateY(-Math.PI-e/2),i.scale(-1,1,1),i}}Qc.textures={},Qc.meta={selector:"[model-curved-plane]",hosts:{host:Hr},outputs:["down","play","zoom","currentTime"],inputs:["item","view"]};class Zc{static getService(){return this.service_||(this.service_=new Zc),this.service_}get message(){return this.message$.getValue()}constructor(){if(Zc.service_)throw"DebugService is a singleton class!";this.message$=new i.BehaviorSubject(null)}setMessage(t){this.message!==t&&this.message$.next(t)}}class tl extends Gr{static getLoader(){return tl.loader||(tl.loader=new THREE.FontLoader)}static getFontLoader(t){return tl.fontLoader||(tl.fontLoader=tl.getLoader().load(x.getPath("fonts/helvetiker/helvetiker_regular.typeface.json"),t))}get message(){return this.message_}set message(t){t=t&&""!==t?t:null,this.message_!==t&&(this.message_=t,this.setText(t))}onInit(){super.onInit();(this.vrService=Ro.getService()).session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t?this.text&&this.textGroup.add(this.text):this.text&&this.text.parent.remove(this.text)}));(this.debugService=Zc.getService()).message$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.message=t))}createText(){const t=document.createElement("canvas");t.width=tl.W,t.height=tl.H;const e=new THREE.CanvasTexture(t);e.encoding=THREE.sRGBEncoding,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.mapping=THREE.UVMapping,e.needsUpdate=!0;const i=new THREE.PlaneBufferGeometry(4,1,2,2),n=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,map:e,color:16777215,transparent:!0,opacity:1,toneMapped:!1}),s=new THREE.Mesh(i,n);return s.renderOrder=x.renderOrder.debug,s.position.y=0,s}loadFont(){this.fontLoader=tl.getFontLoader((t=>{this.font=t,this.message_&&this.setText(this.message_)}))}onCreate(t,e){const i=this.textGroup=new THREE.Group;this.material=new THREE.MeshBasicMaterial({depthTest:!1,color:16777215,transparent:!0,opacity:1,side:THREE.DoubleSide}),this.text=this.createText(),"function"==typeof t&&t(i)}render(t,e){const i=this.group;let n=this.host.camera;const s=this.position;this.host.renderer.xr.isPresenting&&(n=this.host.renderer.xr.getCamera(n)),n.getWorldDirection(s),s.multiplyScalar(3),i.position.copy(s),i.lookAt(ws.origin)}setText(t){const e=this.text;if(e)if(this.host.renderer.xr.isPresenting&&null!=t){const i=e.material.map.image.getContext("2d");i.clearRect(0,0,tl.W,tl.H),i.font=`30px ${x.fontFamily}`,i.textBaseline="middle",i.textAlign="center",i.fillStyle="#FFFFFF",i.strokeStyle="#000000",i.lineWidth=5,i.fillText(t,tl.W/2,tl.H/2,tl.W-20),e.material.map.needsUpdate=!0,this.textGroup.add(e)}else e.parent&&e.parent.remove(e)}}tl.W=1024,tl.H=256,tl.meta={selector:"[model-debug]",hosts:{host:Hr}};class el extends Gr{static getLoader(){return el.loader||(el.loader=new THREE.TextureLoader)}static getTexture(){return el.texture||(el.texture=el.getLoader().load(x.getPath("textures/ui/floor-nav.png")))}static getOverTexture(){return el.textureOver||(el.textureOver=el.getLoader().load(x.getPath("textures/ui/floor-nav-over.png")))}set coords(t){if(!t&&this.coords_!==t||!this.coords_||t.x!==this.coords_.x||t.y!==this.coords_.y){const e=this.tileMap;if(this.coords_){const t=e[`${this.coords_.x}_${this.coords_.y}`],i=t.uniforms;gsap.to(i,{tween:0,duration:.4,delay:0,ease:Power2.easeInOut,onUpdate:()=>{t.material.uniforms.tween.value=i.tween,t.material.needsUpdate=!0}})}if(t){const i=this.currentTile=e[`${t.x}_${t.y}`],n=i.uniforms;gsap.to(n,{tween:1,duration:.4,delay:0,ease:Power2.easeInOut,onUpdate:()=>{i.material.uniforms.tween.value=n.tween,i.material.needsUpdate=!0}})}this.coords_=t}}set coords__(t){if(!t&&this.coords_!==t||!this.coords_||t.x!==this.coords_.x||t.y!==this.coords_.y){const e=this.tileMap;if(this.coords_){const t=e[`${this.coords_.x}_${this.coords_.y}`],i={tween:1};gsap.to(i,{duration:.4,tween:0,delay:0,ease:Power2.easeInOut,onUpdate:()=>{t.material.opacity=i.tween}})}if(t){const i=this.currentTile=e[`${t.x}_${t.y}`],n={tween:0};gsap.to(n,{duration:.4,tween:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{i.material.opacity=n.tween}})}this.coords_=t}}getCoords(t){const e=el.RADIUS/10,i=Math.ceil((t.x+e/2)/e)-1,n=Math.ceil((t.z+e/2)/e)-1,s=Math.floor(el.COLS/2),o=Math.floor(el.ROWS/2),r=Math.min(s,Math.abs(i))*(i?Math.abs(i)/i:1),a=Math.min(o,Math.abs(n))*(n?Math.abs(n)/n:1);if(this.view.hasTile(this.indices.x+r,this.indices.y+a))return new THREE.Vector2(r,a)}onInit(){super.onInit(),this.indices=new THREE.Vector2,this.view.index$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.moveToIndex(t)}))}addTiles(t){const e=el.RADIUS/10,i=.9*e,n=new THREE.PlaneBufferGeometry(i,i,2,2);n.rotateX(-Math.PI/2);const s=el.getTexture();s.disposable=!1,s.encoding=THREE.sRGBEncoding;const o=el.getOverTexture();o.disposable=!1,o.encoding=THREE.sRGBEncoding;const r=this.tileMap={};this.tiles=new Array(el.COLS*el.ROWS).fill(0).map(((i,a)=>{const c=new THREE.ShaderMaterial({depthTest:!1,depthWrite:!1,transparent:!0,toneMapped:!1,vertexShader:"\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"\nvarying vec2 vUv;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform float opacity;\nuniform float tween;\n\nvoid main() {\n\tvec4 colorA = texture2D(textureA, vUv);\n\tvec4 colorB = texture2D(textureB, vUv);\n\tvec4 color = mix(colorA, colorB, tween);\n\tcolor.a = clamp(color.a * opacity, 0.0, 1.0);\n\tcolor.rgb /= color.a;\n\tgl_FragColor = color;\n}\n",uniforms:{textureA:{type:"t",value:s},textureB:{type:"t",value:o},tween:{value:0},opacity:{value:0}},extensions:{fragDepth:!0}}),l=new THREE.Mesh(n,c),d=Math.floor(el.COLS/2),h=Math.floor(el.ROWS/2),u=Math.floor(a/el.COLS),p=-d+a%el.COLS,m=-h+u;return l.position.set(p*e,.15*-el.RADIUS,m*e),l.name=this.getName(`tile_${p}_${m}`),l.uniforms={tween:0,opacity:0,ci:p,ri:m},r[`${p}_${m}`]=l,t.add(l),l})),this.showTiles()}showTiles(){this.tiles.forEach(((t,e)=>{const i=this.indices?this.indices.x:0,n=this.indices?this.indices.y:0,s=this.view.hasTile(i+t.uniforms.ci,n+t.uniforms.ri),o=t.uniforms;gsap.to(o,{opacity:s?1:0,duration:.4,ease:Power2.easeInOut,onUpdate:()=>{t.material.uniforms.opacity.value=o.opacity,t.material.needsUpdate=!0}})}))}addHitArea(t){this.onGroundOver=this.onGroundOver.bind(this),this.onGroundMove=this.onGroundMove.bind(this),this.onGroundDown=this.onGroundDown.bind(this),this.onGroundOut=this.onGroundOut.bind(this),el.RADIUS;const e=new THREE.PlaneBufferGeometry(el.RADIUS,el.RADIUS,8,8);e.rotateX(-Math.PI/2);const i=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,toneMapped:!1,opacity:0}),n=this.ground=new As(e,i);n.name=this.getName("ground"),n.position.set(0,.15*-el.RADIUS,0),n.on("over",this.onGroundOver),n.on("move",this.onGroundMove),n.on("out",this.onGroundOut),n.on("down",this.onGroundDown),t.add(n)}onGroundOver(){const t=this.ground,e=this.getCoords(t.intersection.point);this.coords=e}onGroundMove(){const t=this.ground,e=this.getCoords(t.intersection.point);this.coords=e}onGroundDown(){const t=this.ground,e=this.getCoords(t.intersection.point);if(this.coords=e,e){const t=this.view.getTileIndex(this.indices.x+e.x,this.indices.y+e.y);this.view.index=t,this.nav.next(t)}}onGroundOut(){this.coords=null}moveToIndex(t){this.coords=null;const e=this.view.tiles[t],i=new THREE.Vector2(e.indices.x-this.indices.x,e.indices.y-this.indices.y);this.indices.x=e.indices.x,this.indices.y=e.indices.y,this.showTiles();const n=el.RADIUS/10;this.move.next({indices:this.indices,coords:i,position:i.clone().multiplyScalar(n)})}onCreate(t,e){const i=new THREE.Group;this.addTiles(i),this.addHitArea(i),"function"==typeof t&&t(i)}onDestroy(){super.onDestroy();const t=this.ground;t.off("over",this.onGroundOver),t.off("move",this.onGroundMove),t.off("down",this.onGroundDown),t.off("out",this.onGroundOut)}}el.RADIUS=101,el.COLS=11,el.ROWS=11,el.meta={selector:"[model-grid]",hosts:{host:Hr},outputs:["move","nav"],inputs:["view"]};class il extends As{static getGrid(t){const e=Math.ceil(t/il.ROWS);return[Math.ceil(t/e),e]}static getX(t,e){const i=Math.ceil(e/il.ROWS),n=t%i,s=1/il.W*(il.W+il.G);return s/2-i*s/2+n*s}static getY(t,e){const i=Math.ceil(e/il.ROWS),n=Math.ceil(e/i),s=Math.floor(t/i),o=1/il.W*(il.H+il.G);return n*o/2-o/2+s*-o}static get geometry(){if(this.geometry_)return this.geometry_;const t=new THREE.PlaneBufferGeometry(1,1/il.W*il.H,2,2);return this.geometry_=t,t}static get material(){return new THREE.ShaderMaterial({depthTest:!1,transparent:!0,toneMapped:!1,vertexShader:sl.VERTEX_SHADER,fragmentShader:sl.FRAGMENT_SHADER,uniforms:{textureA:{type:"t",value:null},textureB:{type:"t",value:null},resolutionA:{value:new THREE.Vector2},resolutionB:{value:new THREE.Vector2},tween:{value:0},opacity:{value:0}},extensions:{fragDepth:!0}})}constructor(t,e,i){const n=il.geometry,s=il.material;super(n,s),this.renderOrder=x.renderOrder.menu,this.name=t.name,this.item=t,this.index=e,this.total=i,this.tween=0,this.opacity=0;const o=this.textureA=this.getTextureA(t.name);s.uniforms.textureA.value=o,s.uniforms.resolutionA.value=new THREE.Vector2(o.width,o.height);const r=this.textureB=this.getTextureB(t.name);s.uniforms.textureB.value=r,s.uniforms.resolutionA.value=new THREE.Vector2(r.width,r.height),s.uniforms.tween.value=this.tween,s.uniforms.opacity.value=this.opacity,s.needsUpdate=!0,this.position.set(il.getX(e,i),il.getY(e,i),0),this.onOver=this.onOver.bind(this),this.onOut=this.onOut.bind(this)}getTextureA(t){const e=il.W,i=il.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuForeground,this.writeText(s,t,e,i);const o=new THREE.CanvasTexture(n);return o.minFilter=THREE.LinearFilter,o.magFilter=THREE.LinearFilter,o.mapping=THREE.UVMapping,o.needsUpdate=!0,o}getTextureB(t){const e=il.W,i=il.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuOverBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuOverForeground,this.writeText(s,t,e,i);const o=new THREE.CanvasTexture(n);return o.magFilter=THREE.LinearFilter,o.needsUpdate=!0,o}writeText(t,e,i,n){this.setFont(t);const s=il.FONT_SIZE*il.LINE_HEIGHT,o=this.getLines(t,e,i),r=o.length;this.setFont(t,r-1),o.forEach(((e,o)=>{t.fillText(e,10,.5*(n-r*s)+(.5+o)*s,i-20)}))}setFont(t,e){void 0===e&&(e=0),t.textBaseline="middle",t.font=`${il.FONT_SIZE-2*e}px ${x.fontFamily}`}getLines(t,e,i){const n=e.split(" "),s=[];let o=n[0];for(let e=1;e<n.length;e++){const r=n[e];t.measureText(o+" "+r).width<i?o+=" "+r:(s.push(o),o=r)}return s.push(o),s}onOver(){gsap.to(this,{duration:.4,tween:1,ease:Power2.easeOut,onUpdate:()=>{this.position.z=.1*this.tween,this.material.uniforms.tween.value=this.tween,this.material.needsUpdate=!0}})}onOut(){gsap.to(this,{duration:.4,tween:0,ease:Power2.easeOut,onUpdate:()=>{this.position.z=.1*this.tween,this.material.uniforms.tween.value=this.tween,this.material.needsUpdate=!0}})}dispose(){Cs.dispose(this),this.textureA.dispose(),this.textureB.dispose(),this.material.dispose(),this.geometry.dispose()}}il.FONT_SIZE=19,il.LINE_HEIGHT=.9,il.W=256,il.H=64,il.G=2,il.ROWS=6;class nl extends il{constructor(t,e,i){super(t,e,i)}getTextureA(t){const e=il.W,i=il.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuBackBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuBackForeground,s.font=`${il.FONT_SIZE}px ${x.fontFamily}`,s.fillText(t,10,50,e-20);const o=new THREE.CanvasTexture(n);return o.minFilter=THREE.LinearFilter,o.magFilter=THREE.LinearFilter,o.mapping=THREE.UVMapping,o.needsUpdate=!0,o}getTextureB(t){const e=il.W,i=il.H,n=document.createElement("canvas");n.width=e,n.height=i;const s=n.getContext("2d");s.fillStyle=x.colors.menuBackOverBackground,s.fillRect(0,0,e,i),s.fillStyle=x.colors.menuBackOverForeground,s.font=`${il.FONT_SIZE}px ${x.fontFamily}`,s.fillText(t,10,50,e-20);const o=new THREE.CanvasTexture(n);return o.magFilter=THREE.LinearFilter,o.needsUpdate=!0,o}}class sl extends Gr{get controlled(){return ee.state.controlling&&ee.state.controlling!==ee.state.uid}get controlling(){return ee.state.controlling&&ee.state.controlling===ee.state.uid}get silencing(){return ee.state.silencing}get silenced(){return ee.state.silencing&&ee.state.role===ie.Streamer}get spyed(){return ee.state.spying&&ee.state.spying===ee.state.uid}get spying(){return ee.state.spying&&ee.state.spying!==ee.state.uid}get locked(){return this.controlled||this.spying}get loading(){return this.loading_}set loading(e){if(this.loading_!==e){this.loading_=e;const{node:i}=t.getContext(this);i.querySelector(".btn--menu").classList.toggle("loading",e)}}onInit(){super.onInit(),this.onDown=this.onDown.bind(this),this.onToggle=this.onToggle.bind(this);const{node:e}=t.getContext(this);this.progressIndicator=e.querySelector(".progress circle"),Ls.progress$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{this.loading=t.count>0;let e=144.51;t.count&&(e=144.51*(1-t.value)),gsap.set(this.progressIndicator,{strokeDashoffset:e})})),ki.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{if(t.type===Ve)this.onToggle()}))}onDestroy(){this.buttons&&this.buttons.forEach((t=>Cs.dispose(t))),super.onDestroy()}getContainer(){return this.host.cameraGroup}onCreate(t,e){const i=this.menuGroup=new THREE.Group;"function"==typeof t&&t(i)}render(t,e){const i=this.group;this.host.cameraGroup;let n=this.host.camera;const s=this.position;if(this.host.renderer.xr.isPresenting)n=this.host.renderer.xr.getCamera(n),n.getWorldDirection(s),s.y+=.5,s.multiplyScalar(3),this.host.cameraGroup.worldToLocal(s),s.y+=this.host.cameraGroup.position.y,i.position.copy(s),i.scale.set(1,1,1),i.lookAt(ws.origin);else{n.getWorldDirection(s),oo.mode===Zs?s.multiplyScalar(.01):s.multiplyScalar(3),i.position.copy(s);const t=1/n.zoom;i.scale.set(t,t,t),i.lookAt(ws.origin)}}items$(t){return void 0===t&&(t=null),t?i.of(t.items):this.rootItems?i.of(this.rootItems):Da.getModelMenu$(this.views,this.host.editor).pipe(n.first(),n.tap((t=>{this.host.editor||(this.rootItems=t)})))}addMenu(t){void 0===t&&(t=null),this.removeMenu(),t&&"menu-group"!==t.type.name?this.nav.next(t):(Da.active=!0,this.items$(t).pipe(n.first()).subscribe((e=>{if(e){e=e.slice();const i={type:{name:"back"},name:t?"Back":"Close",backItem:t};e.push(i);const n=this.buttons=e.map(((e,i,n)=>(e.backItem=t,"back"===e.type.name?new nl(e,i,n.length):new il(e,i,n.length))));n.forEach((t=>{t.depthTest=!1,t.on("over",t.onOver),t.on("out",t.onOut),t.on("down",this.onDown),this.menuGroup.add(t)})),gsap.to(n,{duration:.3,opacity:.8,ease:Power2.easeOut,stagger:{grid:il.getGrid(n.length),from:0,amount:.02*n.length},onUpdate:()=>{n.forEach((t=>{t.material.uniforms.opacity.value=t.opacity*(t.item.hidden?.5:1)}))}})}})))}removeMenu(){Da.active=!1,this.removeButtons(),this.removeToggler()}removeButtons(){const t=this.buttons;t&&t.forEach((t=>{this.menuGroup.remove(t),t.off("over",t.onOver),t.off("out",t.onOut),t.off("down",this.onDown),t.dispose()})),this.buttons=null}addToggler(){this.removeMenu();const t=this.toggler=new il({type:{name:"menu"},name:"Menu"},0,1);t.opacity=.8,t.material.uniforms.opacity.value=t.opacity,t.material.needsUpdate=!0,t.on("over",t.onOver),t.on("out",t.onOut),t.on("down",this.onToggle),this.menuGroup.add(t)}removeToggler(){const t=this.toggler;t&&(this.menuGroup.remove(t),t.off("over",t.onOver),t.off("out",t.onOut),t.off("down",this.onToggle),t.dispose()),this.toggler=null}onDown(t){t.item&&"back"===t.item.type.name?(this.removeMenu(),t.item.backItem?this.addMenu(t.item.backItem.backItem):this.toggle.next()):this.addMenu(t.item)}onToggle(t){t&&(t.preventDefault(),t.stopImmediatePropagation()),this.locked||(Da.active?(this.removeMenu(),this.toggle.next()):(this.addMenu(),this.toggle.next(this)))}}sl.VERTEX_SHADER="\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",sl.FRAGMENT_SHADER="\nvarying vec2 vUv;\nuniform float opacity;\nuniform float tween;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform vec2 resolutionA;\nuniform vec2 resolutionB;\n\nvoid main() {\n\tvec4 colorA = texture2D(textureA, vUv);\n\tvec4 colorB = texture2D(textureB, vUv);\n\tvec4 color = vec4(mix(colorA.rgb, colorB.rgb, tween), opacity);\n\tgl_FragColor = color;\n}\n",sl.meta={selector:"[model-menu]",hosts:{host:Hr},outputs:["nav","toggle"],inputs:["views"],template:'\n\t<div class="btn--menu" (mousedown)="onToggle($event)">\n\t\t<svg class="menu-light" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#menu-light"></use></svg>\n\t\t<div class="btn--menu__spinner"></div>\n\t\t<svg class="bullets" width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#menu"></use></svg>\n\t\t<svg class="progress" width="50" height="50" viewBox="0 0 50 50">\n\t\t\t<circle id="circle" r="23" cx="25" cy="25" fill="transparent"></circle>\n\t\t</svg>\n\t</div>\n\t'};const ol=new WeakMap;class rl extends s.Loader{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,e,i,n){const o=new s.FileLoader(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,(t=>{const i={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(t,i).then(e).catch(n)}),i,n)}decodeDracoFile(t,e,i,n){const s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(t,s).then(e)}decodeGeometry(t,e){for(const t in e.attributeTypes){const i=e.attributeTypes[t];void 0!==i.BYTES_PER_ELEMENT&&(e.attributeTypes[t]=i.name)}const i=JSON.stringify(e);if(ol.has(t)){const e=ol.get(t);if(e.key===i)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const s=this.workerNextTaskID++,o=t.byteLength,r=this._getWorker(s,o).then((i=>(n=i,new Promise(((i,o)=>{n._callbacks[s]={resolve:i,reject:o},n.postMessage({type:"decode",id:s,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return r.catch((()=>!0)).then((()=>{n&&s&&this._releaseTask(n,s)})),ol.set(t,{key:i,promise:r}),r}_createGeometry(t){const e=new s.BufferGeometry;t.index&&e.setIndex(new s.BufferAttribute(t.index.array,1));for(let i=0;i<t.attributes.length;i++){const n=t.attributes[i],o=n.name,r=n.array,a=n.itemSize;e.setAttribute(o,new s.BufferAttribute(r,a))}return e}_loadLibrary(t,e){const i=new s.FileLoader(this.manager);return i.setPath(this.decoderPath),i.setResponseType(e),i.setWithCredentials(this.withCredentials),new Promise(((e,n)=>{i.load(t,e,void 0,n)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then((e=>{const i=e[0];t||(this.decoderConfig.wasmBinary=e[1]);const n=al.toString(),s=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([s]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const i=e.data;switch(i.type){case"decode":t._callbacks[i.id].resolve(i);break;case"error":t._callbacks[i.id].reject(i);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+i.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[t]=e,i._taskLoad+=e,i}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this}}function al(){let t,e;function i(t,e,i,n,s,o){const r=o.num_components(),a=i.num_points()*r,c=a*s.BYTES_PER_ELEMENT,l=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,s),d=t._malloc(c);e.GetAttributeDataArrayForAllPoints(i,o,l,c,d);const h=new s(t.HEAPF32.buffer,d,a).slice();return t._free(d),{name:n,array:h,itemSize:r}}onmessage=function(n){const s=n.data;switch(s.type){case"init":t=s.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const n=s.buffer,o=s.taskConfig;e.then((t=>{const e=t.draco,r=new e.Decoder,a=new e.DecoderBuffer;a.Init(new Int8Array(n),n.byteLength);try{const t=function(t,e,n,s){const o=s.attributeIDs,r=s.attributeTypes;let a,c;const l=e.GetEncodedGeometryType(n);if(l===t.TRIANGULAR_MESH)a=new t.Mesh,c=e.DecodeBufferToMesh(n,a);else{if(l!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");a=new t.PointCloud,c=e.DecodeBufferToPointCloud(n,a)}if(!c.ok()||0===a.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+c.error_msg());const d={index:null,attributes:[]};for(const n in o){const c=self[r[n]];let l,h;if(s.useUniqueIDs)h=o[n],l=e.GetAttributeByUniqueId(a,h);else{if(h=e.GetAttributeId(a,t[o[n]]),-1===h)continue;l=e.GetAttribute(a,h)}d.attributes.push(i(t,e,a,n,c,l))}l===t.TRIANGULAR_MESH&&(d.index=function(t,e,i){const n=3*i.num_faces(),s=4*n,o=t._malloc(s);e.GetTrianglesUInt32Array(i,s,o);const r=new Uint32Array(t.HEAPF32.buffer,o,n).slice();return t._free(o),{array:r,itemSize:1}}(t,e,a));return t.destroy(a),d}(e,r,a,o),n=t.attributes.map((t=>t.array.buffer));t.index&&n.push(t.index.array.buffer),self.postMessage({type:"decode",id:s.id,geometry:t},n)}catch(t){console.error(t),self.postMessage({type:"error",id:s.id,error:t.message})}finally{e.destroy(a),e.destroy(r)}}))}}}class cl extends $r{get freezed(){return this.freezed_}set freezed(t){if(this.freezed_!==t){this.freezed_=t;const e=this.mesh;e&&e.traverse((e=>{e.isInteractiveMesh&&(e.freezed=t)}))}}onInit(){super.onInit(),this.isPresenting=!1,Da.active$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.freezed=t))}onChanges(){this.editing=this.item.selected}onCreate(t,e){this.loadGlb(x.getPath(this.item.asset.folder),this.item.asset.file,((i,n)=>{this.onGlbLoaded(i,n,t,e)}))}loadGlb(t,e,i){this.host.renderer;const n=Ls.getRef(),s=(new No).setPath(t),o=`${x.dist}js/draco/`,r=new rl;r.setDecoderPath(o),s.setDRACOLoader(r),s.load(e,(t=>{"function"==typeof i&&i(t.scene,t.animations),Ls.setProgress(n,1)}),(t=>{Ls.setProgress(n,t.loaded,t.total)}))}onGlbLoaded(t,e,i,n){this.parseAnimations(t,e);const s=(new THREE.Box3).setFromObject(t),o=s.max.clone().sub(s.min),r=1.7/Math.max(o.x,o.y,o.z);let a;t.scale.set(r,r,r);const c=this.view,l=this.item;if(c.type.name===gn.Model.name){a=new THREE.Group,a.add(t),s.setFromObject(a);const e=s.getCenter(new THREE.Vector3);a.position.set(t.position.x-e.x,t.position.y-e.y,t.position.z-e.z+(this.host.renderer.xr.isPresenting?-2:0));const i=a.position.y,n={tween:1},o=()=>{a.position.y=i+3*n.tween,a.rotation.y=0+Math.PI*n.tween};o(),this.makeInteractive(t),gsap.to(n,{duration:1.5,tween:0,delay:.1,ease:Power2.easeInOut,onUpdate:o,onComplete:()=>{this.updateHelper()}})}else{s.setFromObject(t);const e=s.getCenter(new THREE.Vector3);t.position.set(-e.x,-e.y,-e.z),a=new THREE.Group,a.add(t),l.position&&a.position.fromArray(l.position),l.rotation&&a.rotation.fromArray(l.rotation),l.scale&&a.scale.fromArray(l.scale),this.makeInteractive(t),this.updateHelper()}"function"==typeof i&&(i(a,this.item),this.freezed=Da.active)}parseAnimations(t,e){this.actionIndex=-1;const i=this.actions=[];if(e&&e.length){this.clock=new THREE.Clock;const n=this.mixer=new THREE.AnimationMixer(t);n.timeScale=1,e.forEach((t=>{const e=n.clipAction(t);e.enabled=!0,e.setEffectiveTimeScale(1),e.setEffectiveWeight(1),e.setLoop(THREE.LoopRepeat),i.push(e)}))}}onClipToggle(){let t;const e=this.actions;1===e.length?(t=-1===this.actionIndex?0:-1,this.setSingleAction(t)):e.length>1&&(t=this.actionIndex+1,t===e.length&&(t=-1),this.setMultiAction(t)),this.play.next({itemId:this.item.id,actionIndex:t})}setSingleAction(t){if(this.actionIndex!==t){this.actionIndex=t;const e=this.actions[0];0===t?e.paused||0===e.timeScale?e.paused=!1:e.play():-1===t&&e.halt(.3)}}setMultiAction(t){if(this.actionIndex!==t){const e=this.actions,i=this.actionIndex>-1?e[this.actionIndex]:null;if(this.actionIndex=t,i&&i.halt(.3),t>-1){const i=e[t];i.paused&&(i.paused=!1),0===i.timeScale&&(i.timeScale=1),i.play()}}}onMessage(t){switch(t.type){case ze:{const e=this.actions;1===e.length?this.setSingleAction(t.actionIndex):e.length>1&&this.setMultiAction(t.actionIndex);break}}}render(t,e){const i=this.view;this.item;const n=this.mesh,s=this.host.renderer.xr.isPresenting;this.group,n&&(i.type.name===gn.Model.name?(this.isPresenting!==s&&(this.isPresenting=s,s?(n.position.x=0,n.position.y=0,n.position.z=-2,n.rotation.y=0):(n.position.x=0,n.position.y=0,n.position.z=0,n.rotation.y=0)),s&&(n.rotation.y-=Math.PI/180/60*5)):s&&(n.rotation.y-=Math.PI/180/60*5));const o=this.mixer,r=this.clock;if(o){const t=r.getDelta();o.update(t)}}onUpdate(t,e){this.view.type.name!==gn.Model.name&&(t.position&&e.position.fromArray(t.position),t.rotation&&e.rotation.fromArray(t.rotation),t.scale&&e.scale.fromArray(t.scale)),this.updateHelper()}onUpdateAsset(t,e){this.loadGlb(x.getPath(t.asset.folder),t.asset.file,((t,e)=>{this.onGlbLoaded(t,e,((t,e)=>this.onMount(t,e)),((t,e)=>this.onDismount(t,e)))}))}onDragMove(t,e,i){i&&t.normalize().multiplyScalar(4),this.editing=!0;this.view.type.name!==gn.Model.name&&this.mesh.position.set(t.x,t.y,t.z),this.updateHelper()}onDragEnd(){this.view.type.name!==gn.Model.name&&(this.item.position=this.mesh.position.toArray(),this.item.rotation=this.mesh.rotation.toArray(),this.item.scale=this.mesh.scale.toArray()),this.editing=!1}static getInteractiveDescriptors(){let t=cl.interactiveDescriptors;if(!t){const e=Object.getOwnPropertyDescriptors(Rs.prototype),i=Object.getOwnPropertyDescriptors(Is.prototype),n=Object.getOwnPropertyDescriptors(As.prototype);t=Object.assign({},e,i,n),cl.interactiveDescriptors=t}return t}makeInteractive(t){const e=cl.getInteractiveDescriptors();t.traverse((t=>{t.isMesh&&(Object.keys(e).forEach((i=>{"constructor"!==i&&Object.defineProperty(t,i,e[i])})),t.freezed=!1,t.events={},t.depthTest=!0,t.over_=!1,t.down_=!1,Cs.items.push(t),t.on("down",(()=>{this.onClipToggle(),this.down.next(this)})))}))}}cl.meta={selector:"[model-model]",hosts:{host:Hr},outputs:["down","play"],inputs:["item","view"]};class ll extends THREE.Sprite{get freezed(){return this.freezed_}set freezed(t){this.freezed_=t,this.children.filter((t=>t.__lookupGetter__("freezed"))).forEach((e=>e.freezed=t))}constructor(t){super(t=t||new THREE.SpriteMaterial({color:16711935})),this.freezed=!1}freeze(){this.freezed=!0}unfreeze(){this.freezed=!1}}class dl extends ll{constructor(t){super(t=t||new THREE.SpriteMaterial({color:16711935})),this.events={}}on(t,e){const i=this.events[t]=this.events[t]||[];return i.push(e),()=>{this.events[t]=i.filter((t=>t!==e))}}off(t,e){const i=this.events[t];i&&(this.events[t]=i.filter((t=>t!==e)))}emit(t,e){const i=this.events[t];i&&i.forEach((t=>{t(e)}));const n=this.events.broadcast;n&&n.forEach((i=>{i(t,e)}))}}class hl extends dl{constructor(t){super(t),this.depthTest=!0,this.over_=!1,this.down_=!1,Cs.items.push(this)}get isInteractiveSprite(){return!0}get over(){return this.over_}set over(t){this.over_!=t&&(this.over_=t,t?this.emit("over",this):this.emit("out",this))}get down(){return this.down_}set down(t){t=t&&this.over,this.down_!=t&&(this.down_=t,t?this.emit("down",this):this.emit("up",this))}}class ul extends Gr{constructor(){super(...arguments),this.isMobile_=void 0}get isMobile(){return this.isMobile_}set isMobile(t){this.isMobile_!==t&&(this.isMobile_=t,this.setScale())}render(t,e){this.isMobile=this.host.worldRect.width<768}setScale(t){void 0===t&&(t=0);const e=this.textureWidth,i=this.textureHeight,n=this.item,s=this.panel;if(s){const o=.2*(n.asset?1.5:1)*(this.isMobile?1.6:1),r=e/i,a=ul.PANEL_RADIUS*o,c=ul.PANEL_RADIUS*o/r,l=.25*a,d=n.mesh.position.normalize().multiplyScalar(ul.PANEL_RADIUS);s.position.set(d.x,d.y+(c+2*l)-l*(1-t),d.z),s.scale.set(.02*a,.02*c,1)}}onInit(){super.onInit(),this.textureWidth=0,this.textureHeight=0}onView(){if(this.viewed)return;this.viewed=!0;const{node:e}=t.getContext(this);this.getCanvasTexture(e).then((t=>{if(this.textureWidth=t.width,this.textureHeight=t.height,this.mesh&&this.item){const i=new THREE.SpriteMaterial({depthTest:!1,transparent:!0,opacity:0,map:t.map,sizeAttenuation:!1,toneMapped:!1}),n=this.item,s=this.panel=new hl(i);s.renderOrder=x.renderOrder.panel,this.setScale(1),s.on("down",(t=>{const i={x:parseInt(t.intersection.uv.x*e.offsetWidth),y:parseInt((1-t.intersection.uv.y)*e.offsetHeight)},s=Array.prototype.slice.call(e.querySelectorAll(".panel__link")),o=s.find((t=>i.x>=t.offsetLeft&&i.y>=t.offsetTop&&i.x<=t.offsetLeft+t.offsetWidth&&i.y<=t.offsetTop+t.offsetHeight));if(o){const t=s.indexOf(o),r=n.links[t];this.down.next({item:n,link:r,linkIndex:t});const a=e.getBoundingClientRect(),c={button:0,buttons:0,clientX:i.x+a.left,clientY:i.y+a.top,movementX:0,movementY:0,relatedTarget:o,screenX:i.x,screenY:i.y},l=new MouseEvent("mouseup",c);o.dispatchEvent(l),setTimeout((()=>{Xs.dismissEvent(l,Xs.events$,Xs.dismiss$,Xs.downEvent)}),1)}})),this.mesh.add(s);const o={value:0};gsap.to(o,{duration:.5,value:1,delay:0,ease:Power2.easeInOut,onUpdate:()=>{this.setScale(1-o.value),s.lookAt(ws.origin),s.material.opacity=o.value,s.material.needsUpdate=!0}})}}),(t=>{console.log("ModelPanelComponent.getCanvasTexture.error",t)}))}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}onDestroy(){super.onDestroy()}imagesLoaded(){const{node:e}=t.getContext(this);if(e){const t=Array.prototype.slice.call(e.querySelectorAll("img")).map((t=>new Promise((function(e,i){const n=t.src&&-1===t.src.indexOf(location.origin);if(t.complete)return setTimeout((()=>{e(n)}),10);function s(){r(),setTimeout((()=>{e(n)}),10)}function o(){r(),e(!1)}function r(){t.removeEventListener("load",s),t.removeEventListener("error",o)}t.addEventListener("load",s),t.addEventListener("error",o)}))));return t.length?Promise.all(t):Promise.resolve()}}getCanvasTexture(e){return new Promise(((i,n)=>{setTimeout((()=>{this.item.panelTexture?i(this.item.panelTexture):this.imagesLoaded().then((s=>{const o=t.getContext(this);if(o&&o.node){e=o.node;const t=s&&null!=s.find((t=>!0===t));a.default(e,{backgroundColor:"#ffffff00",scale:1,useCORS:t}).then((t=>{const e=new THREE.CanvasTexture(t);this.item.panelTexture={map:e,width:t.width,height:t.height},i(this.item.panelTexture)}),(t=>{n(t)}))}}))}),1)}))}}ul.PANEL_RADIUS=99,ul.meta={selector:"[model-panel]",hosts:{host:Hr},outputs:["over","out","down"],inputs:["item"],template:'\n\t\t<div class="panel__title"><span [innerHTML]="item.title"></span></div>\n\t\t<div class="panel__abstract"><span [innerHTML]="item.abstract"></span></div>\n\t\t<img class="panel__picture" [src]="item.asset | asset" *if="item.asset">\n\t\t<a class="panel__link" [href]="link.href" target="_blank" rel="noopener" *for="let link of item.links">\n\t\t\t<span [innerHTML]="link.title"></span>\n\t\t</a>\n\t'};class pl extends Gr{onInit(){super.onInit()}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}}pl.meta={selector:"[model-picture]",hosts:{host:Hr},inputs:["item"]};class ml extends $r{onInit(){super.onInit()}onChanges(){const t=this.item.selected;this.editing=t,this.mesh&&(this.mesh.editing=t)}onCreate(t,e){const i=this.item,s=this.view;s.items;const o=ys.planeGeometry;let r,a;this.onMeshDown=this.onMeshDown.bind(this),this.onMeshPlaying=this.onMeshPlaying.bind(this),this.onMeshZoomed=this.onMeshZoomed.bind(this),this.onMeshCurrentTime=this.onMeshCurrentTime.bind(this),$s.getStreamId$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe((c=>{this.streamId!==c&&(this.streamId=c,a&&(a.unsubscribe(),a=null),c||!i.asset?(i.streamId=c,r=this.disposableMesh=new $s(i,s,o,this.host),r.updateFromItem(i),r.name="plane",r.load((()=>{this.disposableMesh=null,"function"==typeof t&&t(r,i),a=r.events$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((()=>{}))})),this.addMeshListeners(r)):this.mesh&&e(this.mesh,i))}))}addMeshListeners(t){t.on("down",this.onMeshDown),t.on("playing",this.onMeshPlaying),t.on("zoomed",this.onMeshZoomed),t.on("currentTime",this.onMeshCurrentTime)}removeMeshListeners(t){t.off("down",this.onMeshDown),t.off("playing",this.onMeshPlaying),t.off("zoomed",this.onMeshZoomed),t.off("currentTime",this.onMeshCurrentTime)}onMeshDown(){this.down.next(this)}onMeshPlaying(t){this.play.next({itemId:this.item.id,playing:t})}onMeshZoomed(t){this.zoom.next({itemId:this.item.id,zoomed:t})}onMeshCurrentTime(t){this.currentTime.next({itemId:this.item.id,currentTime:t})}onDestroy(){super.onDestroy(),this.disposableMesh&&(this.removeMeshListeners(this.disposableMesh),this.disposableMesh.dispose()),this.mesh&&(this.removeMeshListeners(this.mesh),this.mesh.dispose())}onUpdate(t,e){e.updateFromItem(t),this.updateHelper()}onUpdateAsset(t,e){e.updateByItem(t),$s.getStreamId$(t).pipe(n.filter((t=>null!==t)),n.take(1)).subscribe((i=>{t.streamId=i,e.load((()=>{}))}))}onDragMove(t,e,i){const n=this.item,s=this.mesh;n.showPanel=!1,this.editing=!0,i?(t.normalize().multiplyScalar(20),s.position.set(t.x,t.y,t.z),s.lookAt(ws.origin)):(s.position.set(0,0,0),s.lookAt(e),s.position.set(t.x,t.y,t.z),s.position.add(e.multiplyScalar(.01))),this.updateHelper()}onDragEnd(){const t=this.item,e=this.mesh;t.position=e.position.toArray(),t.rotation=e.rotation.toArray(),t.scale=e.scale.toArray(),e.updateFromItem(t),this.editing=!1}}ml.textures={},ml.meta={selector:"[model-plane]",hosts:{host:Hr},outputs:["down","play","zoom","currentTime"],inputs:["item","view"]};const vl=100.99;class gl extends Gr{get title(){return this.title_}set title(t){this.title_!==t&&(this.title_=t,t===ve.transform("waiting_host")||""!==t&&this.visible_?(this.updateProgress(),this.show()):this.hide())}get visible(){return this.visible_}set visible(t){this.visible_!==t&&(this.visible_=t,t&&""!==this.title_?(this.updateProgress(),this.show()):this.hide())}onInit(){this.title_="",this.visible_=this.host.renderer.xr.isPresenting,super.onInit();(this.vrService=Ro.getService()).session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.visible=null!=t))}onCreate(e,i){const{node:s}=t.getContext(this),o=s.querySelector(".inner");this.getCanvasTexture().then((t=>{const i=this.createMesh(t);"function"==typeof e&&e(i),Ls.progress$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>{t.count>0?s.classList.add("active"):s.classList.remove("active"),o.style.width=100*t.value+"%",t.count?this.title=0===t.value?ve.transform("loading"):t.title:this.title=this.getTitle()}))}))}getTitle(){return this.view&&this.view.type.name===gn.WaitingRoom.name?ve.transform("waiting_host"):""}show(){this.mesh.add(this.banner),this.material.opacity=1,this.material.needsUpdate=!0}hide(){this.mesh.remove(this.banner),this.material.opacity=0,this.material.needsUpdate=!0}createMesh(t){const e=new THREE.Group,i=Math.PI/180*360,n=vl*i,s=n/360*2.4,o=n/(t.width*s/t.height),r=new THREE.CylinderBufferGeometry(vl,vl,s,80,2,!0,0,i);r.scale(-1,1,1);const a=t.texture;a.wrapS=a.wrapY=THREE.RepeatWrapping,a.repeat.x=o,a.encoding=THREE.sRGBEncoding;const c=this.material=new THREE.MeshBasicMaterial({map:a,transparent:!0,opacity:0,toneMapped:!1});return this.banner=new THREE.Mesh(r,c),e.userData={render:()=>{e.rotation.y+=Math.PI/180*.02}},e}updateProgress(){this.getCanvasTexture().then((t=>{const e=Math.PI/180*360,i=vl*e,n=i/360*2.4,s=i/(t.width*n/t.height);this.texture.repeat.x=s}))}getCanvasTexture(){return new Promise(((t,e)=>{let i=512,n=64;const s=Math.floor(48),o=Math.floor(3.2);let r;r=this.canvas?this.canvas:this.canvas=document.createElement("canvas"),r.width=i,r.height=n;const a=this.title_,c=r.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.font=`300 ${s}px ${x.fontFamily}`;let l;i=c.measureText(a).width+8,i=Math.max(512,Math.pow(2,Math.ceil(Math.log(i)/Math.log(2)))),r.width=i,c.clearRect(0,0,i,n),c.fillStyle="#0000005A",c.fillRect(0,0,i,n),c.font=`300 ${s}px ${x.fontFamily}`,c.textAlign="center",c.textBaseline="middle",c.strokeStyle="rgba(0, 0, 0, 0.35)",c.lineWidth=o,c.lineJoin="round",c.miterLimit=2,c.strokeText(a,i/2,32),c.fillStyle="white",c.fillText(a,i/2,32,i),this.texture?(l=this.texture,l.needsUpdate=!0):l=this.texture=new THREE.CanvasTexture(r),t({texture:l,width:i,height:n})}))}}gl.meta={selector:"[model-progress]",hosts:{host:Hr},inputs:["view"]};class fl extends Gr{static get transparentMaterial(){return this.transparentMaterial_||(this.transparentMaterial_=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:0})),this.transparentMaterial_}get freezed(){return this.freezed_}set freezed(t){if(this.freezed_!==t){this.freezed_=t;const e=this.mesh;e&&e.traverse((e=>{e.isInteractiveMesh&&(e.freezed=t)}))}}onInit(){super.onInit(),this.isPresenting=!1,Da.active$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((t=>this.freezed=t))}onChanges(){this.editing=this.view.selected}onCreate(t,e){this.loadGlb(x.getPath(this.view.asset.folder),this.view.asset.file,((i,n)=>{this.onGlbLoaded(i,n,t,e)}))}loadGlb(t,e,i){this.host.renderer;const n=Ls.getRef(),s=(new No).setPath(t),o=`${x.dist}js/draco/`,r=new rl;r.setDecoderPath(o),s.setDRACOLoader(r),s.load(e,(t=>{"function"==typeof i&&i(t.scene,t.animations),Ls.setProgress(n,1)}),(t=>{Ls.setProgress(n,t.loaded,t.total)}))}onGlbLoaded(t,e,i,n){const s=this.view;t.position.set(0,-1.76,0);const o=[];let r;t.traverse((t=>{t.isMesh&&o.push(t),"nav"===t.name&&(s.navIntersectObjects=[t],this.makeTransparent(t))})),s.intersectObjects=o,r=new THREE.Group,r.add(t),"function"==typeof i&&i(r,this.view)}makeTransparent(t){t.isMesh&&(t.material=fl.transparentMaterial),t.traverse((t=>{t.isMesh&&(t.material=fl.transparentMaterial)}))}onUpdateAsset(t,e){this.loadGlb(x.getPath(t.asset.folder),t.asset.file,((t,e)=>{this.onGlbLoaded(t,e,((t,e)=>this.onMount(t,e)),((t,e)=>this.onDismount(t,e)))}))}}fl.meta={selector:"[model-room]",hosts:{host:Hr},inputs:["view"]};class El extends Gr{onInit(){super.onInit()}onCreate(t,e){const i=new THREE.Group;"function"==typeof t&&t(i)}}El.meta={selector:"[model-text]",hosts:{host:Hr},inputs:["item"]};class _l extends t.Module{}_l.meta={imports:[t.CoreModule,e.FormModule,nc],declarations:[ce,Ai,en,Ni,nn,un,Zr,hn,vn,mn,Mn,xn,Un,Vn,Ca,Ua,pc,vc,gc,fc,Ec,Va,_c,Sc,bc,Ra,ue,Tc,wc,yc,Cc,Rc,Ia,Oa,Na,oc,Ic,rc,fa,mc,Gc,kc,sc,Lc,Ac,ve,Pc,Ea,Mc,Yc,xc,Uc,Qn,Xc,Gr,Qc,tl,el,sl,cl,Qr,ul,pl,ml,gl,fl,El,Ee,Bc,jc,Oc,Fc,_a,Zn,Hc,Nc,qc,Hr,ae,Vc],bootstrap:Sa},t.Browser.bootstrap(_l)}));
//# sourceMappingURL=main.min.js.map