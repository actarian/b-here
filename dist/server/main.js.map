{"version":3,"file":"server/main.js","sources":["../../server/upload/upload.js","../../server/static/static.js","../../server/api/api.js","../../server/main.js"],"sourcesContent":["const fs = require('fs'),\r\n\tpath = require('path'),\r\n\tmv = require('mv');\r\n\r\nfunction upload(temporaryFolder) {\r\n\tconst this_ = this;\r\n\tthis_.temporaryFolder = temporaryFolder;\r\n\tthis_.maxFileSize = null;\r\n\tthis_.fileParameterName = 'file';\r\n\ttry {\r\n\t\tfs.mkdirSync(this_.temporaryFolder);\r\n\t} catch (e) { }\r\n\tfunction cleanIdentifier(identifier) {\r\n\t\treturn identifier.replace(/[^0-9A-Za-z_-]/g, '');\r\n\t}\r\n\tfunction getChunkFilename(chunkNumber, identifier) {\r\n\t\t// Clean up the identifier\r\n\t\tidentifier = cleanIdentifier(identifier);\r\n\t\t// What would the file name be?\r\n\t\treturn path.resolve(this_.temporaryFolder, './chunk-' + identifier + '.' + chunkNumber);\r\n\t}\r\n\tfunction validateRequest(chunkNumber, chunkSize, totalSize, identifier, filename, fileSize) {\r\n\t\t// Clean up the identifier\r\n\t\tidentifier = cleanIdentifier(identifier);\r\n\t\t// Check if the request is sane\r\n\t\tif (chunkNumber == 0 || chunkSize == 0 || totalSize == 0 || identifier.length == 0 || filename.length == 0) {\r\n\t\t\treturn 'non_flow_request';\r\n\t\t}\r\n\t\tconst numberOfChunks = Math.max(Math.floor(totalSize / (chunkSize * 1.0)), 1);\r\n\t\tif (chunkNumber > numberOfChunks) {\r\n\t\t\treturn 'invalid_flow_request1';\r\n\t\t}\r\n\t\t// Is the file too big?\r\n\t\tif (this_.maxFileSize && totalSize > this_.maxFileSize) {\r\n\t\t\treturn 'invalid_flow_request2';\r\n\t\t}\r\n\t\tif (typeof (fileSize) != 'undefined') {\r\n\t\t\tif (chunkNumber < numberOfChunks && fileSize != chunkSize) {\r\n\t\t\t\t// The chunk in the POST request isn't the correct size\r\n\t\t\t\treturn 'invalid_flow_request3';\r\n\t\t\t}\r\n\t\t\tif (numberOfChunks > 1 && chunkNumber == numberOfChunks && fileSize != ((totalSize % chunkSize) + parseInt(chunkSize))) {\r\n\t\t\t\t// The chunks in the POST is the last one, and the fil is not the correct size\r\n\t\t\t\treturn 'invalid_flow_request4';\r\n\t\t\t}\r\n\t\t\tif (numberOfChunks == 1 && fileSize != totalSize) {\r\n\t\t\t\t// The file is only a single chunk, and the data size does not fit\r\n\t\t\t\treturn 'invalid_flow_request5';\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn 'valid';\r\n\t}\r\n\t//'found', filename, original_filename, identifier\r\n\t//'not_found', null, null, null\r\n\tthis_.get = function(req, callback) {\r\n\t\tconst chunkNumber = req.param('flowChunkNumber', 0);\r\n\t\tconst chunkSize = req.param('flowChunkSize', 0);\r\n\t\tconst totalSize = req.param('flowTotalSize', 0);\r\n\t\tconst identifier = req.param('flowIdentifier', \"\");\r\n\t\tconst filename = req.param('flowFilename', \"\");\r\n\t\tif (validateRequest(chunkNumber, chunkSize, totalSize, identifier, filename) == 'valid') {\r\n\t\t\tconst chunkFilename = getChunkFilename(chunkNumber, identifier);\r\n\t\t\t// console.log('test chunkFilename', chunkFilename);\r\n\t\t\tfs.access(chunkFilename, fs.constants.F_OK, (error) => {\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\tcallback('not_found', null, null, null);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcallback('found', chunkFilename, filename, identifier);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tcallback('not_found', null, null, null);\r\n\t\t}\r\n\t};\r\n\t//'partly_done', filename, original_filename, identifier\r\n\t//'done', filename, original_filename, identifier\r\n\t//'invalid_flow_request', null, null, null\r\n\t//'non_flow_request', null, null, null\r\n\tthis_.post = function(req, callback) {\r\n\t\tconst fields = req.body;\r\n\t\tconst files = req.files;\r\n\t\tconst chunkNumber = fields['flowChunkNumber'];\r\n\t\tconst chunkSize = fields['flowChunkSize'];\r\n\t\tconst totalSize = fields['flowTotalSize'];\r\n\t\tconst identifier = cleanIdentifier(fields['flowIdentifier']);\r\n\t\tconst filename = fields['flowFilename'];\r\n\t\tif (!files[this_.fileParameterName] || !files[this_.fileParameterName].size) {\r\n\t\t\tcallback('invalid_flow_request', null, null, null);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst original_filename = files[this_.fileParameterName]['originalFilename'];\r\n\t\tconst validation = validateRequest(chunkNumber, chunkSize, totalSize, identifier, filename, files[this_.fileParameterName].size);\r\n\t\tif (validation == 'valid') {\r\n\t\t\tconst chunkFilename = getChunkFilename(chunkNumber, identifier);\r\n\t\t\t// Save the chunk (TODO: OVERWRITE)\r\n\t\t\tmv(files[this_.fileParameterName].path, chunkFilename, function() {\r\n\t\t\t\t// Do we have all the chunks?\r\n\t\t\t\tlet currentTestChunk = 1;\r\n\t\t\t\tconst numberOfChunks = Math.max(Math.floor(totalSize / (chunkSize * 1.0)), 1);\r\n\t\t\t\tconst testChunkExists = function() {\r\n\t\t\t\t\tconst chunkFilename = getChunkFilename(currentTestChunk, identifier);\r\n\t\t\t\t\t// console.log('test chunkFilename', chunkFilename);\r\n\t\t\t\t\tfs.access(chunkFilename, fs.constants.F_OK, (error) => {\r\n\t\t\t\t\t\tif (error) {\r\n\t\t\t\t\t\t\tcallback('partly_done', filename, original_filename, identifier);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tcurrentTestChunk++;\r\n\t\t\t\t\t\t\tif (currentTestChunk > numberOfChunks) {\r\n\t\t\t\t\t\t\t\tcallback('done', filename, original_filename, identifier);\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t// Recursion\r\n\t\t\t\t\t\t\t\ttestChunkExists();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t};\r\n\t\t\t\ttestChunkExists();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tcallback(validation, filename, original_filename, identifier);\r\n\t\t}\r\n\t};\r\n\t// Pipe chunks directly in to an existsing WritableStream\r\n\t//   r.write(identifier, response);\r\n\t//   r.write(identifier, response, {end:false});\r\n\t//\r\n\t//   const stream = fs.createWriteStream(filename);\r\n\t//   r.write(identifier, stream);\r\n\t//   stream.on('data', function(data){...});\r\n\t//   stream.on('finish', function(){...});\r\n\tthis_.write = function(identifier, stream, options) {\r\n\t\toptions = options || {};\r\n\t\toptions.end = (typeof options['end'] == 'undefined' ? true : options['end']);\r\n\t\t// Iterate over each chunk\r\n\t\tconst pipeChunk = function(number) {\r\n\t\t\tconst chunkFilename = getChunkFilename(number, identifier);\r\n\t\t\tfs.access(chunkFilename, fs.constants.F_OK, (error) => {\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\t// When all the chunks have been piped, end the stream\r\n\t\t\t\t\tif (options.end) {\r\n\t\t\t\t\t\tstream.end();\r\n\t\t\t\t\t\tthis_.clean(identifier, options);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// if (options.onDone) options.onDone();\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// If the chunk with the current number exists,\r\n\t\t\t\t\t// then create a ReadStream from the file\r\n\t\t\t\t\t// and pipe it to the specified stream.\r\n\t\t\t\t\tconst source = fs.createReadStream(chunkFilename);\r\n\t\t\t\t\tsource.pipe(stream, {\r\n\t\t\t\t\t\tend: false\r\n\t\t\t\t\t});\r\n\t\t\t\t\tsource.on('end', function() {\r\n\t\t\t\t\t\t// When the chunk is fully streamed,\r\n\t\t\t\t\t\t// jump to the next one\r\n\t\t\t\t\t\tpipeChunk(number + 1);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t};\r\n\t\tpipeChunk(1);\r\n\t};\r\n\tthis_.clean = function(identifier, options) {\r\n\t\toptions = options || {};\r\n\t\t// Iterate over each chunk\r\n\t\tconst pipeChunkRm = function(number) {\r\n\t\t\tconst chunkFilename = getChunkFilename(number, identifier);\r\n\t\t\t//console.log('removing pipeChunkRm ', number, 'chunkFilename', chunkFilename);\r\n\t\t\tfs.access(chunkFilename, fs.constants.F_OK, (error) => {\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\tif (options.onDone) options.onDone();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.log('exist removing ', chunkFilename);\r\n\t\t\t\t\tfs.unlink(chunkFilename, function(err) {\r\n\t\t\t\t\t\tif (err && options.onError) options.onError(err);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tpipeChunkRm(number + 1);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t};\r\n\t\tpipeChunkRm(1);\r\n\t};\r\n\treturn this_;\r\n}\r\n\r\nmodule.exports = {\r\n\tupload: upload,\r\n};\r\n","const path = require('path');\r\nconst fs = require('fs');\r\n// const router = express.Router();\r\n// const serveStatic = require('serve-static');\r\n\r\nconst MIME_CONTENT_TYPES = {\r\n\t\"css\": \"text/css\", // Cascading Style Sheets (CSS)\r\n\t\"csv\": \"text/csv\", // Comma-separated values (CSV)\r\n\t\"htm\": \"text/html\", // HyperText Markup Language (HTML)\r\n\t\"html\": \"text/html\", // HyperText Markup Language (HTML)\r\n\t\"ics\": \"text/calendar\", // iCalendar format\r\n\t\"js\": \"text/javascript\", // per the following specifications: https://html.spec.whatwg.org/multipage/#scriptingLanguages, https://html.spec.whatwg.org/multipage/#dependencies:willful-violation, https://datatracker.ietf.org/doc/draft-ietf-dispatch-javascript-mjs/ JavaScript\r\n\t\"mjs\": \"text/javascript\", // JavaScript module\r\n\t\"txt\": \"text/plain\", // Text, (generally ASCII or ISO 8859-n)\r\n\t\"xml\": \"text/xml\", // if readable from casual users (RFC 3023, section 3) \"application/xml\" if not readable from casual users (RFC 3023, section 3)\", // XML\r\n\t\"bmp\": \"image/bmp\", // Windows OS/2 Bitmap Graphics\r\n\t\"gif\": \"image/gif\", // Graphics Interchange Format (GIF)\r\n\t\"ico\": \"image/vnd.microsoft.icon\", // Icon format\r\n\t\"jpeg\": \"image/jpeg\", // JPEG images\r\n\t\"jpg\": \"image/jpeg\", // JPEG images\r\n\t\"png\": \"image/png\", // Portable Network Graphics\r\n\t\"svg\": \"image/svg+xml\", // Scalable Vector Graphics (SVG)\r\n\t\"tif\": \"image/tiff\", // Tagged Image File Format (TIFF)\r\n\t\"tiff\": \"image/tiff\", // Tagged Image File Format (TIFF)\r\n\t\"webp\": \"image/webp\", // WEBP image\r\n\t\"otf\": \"font/otf\", // OpenType font\r\n\t\"ttf\": \"font/ttf\", // TrueType Font\r\n\t\"woff\": \"font/woff\", // Web Open Font Format (WOFF)\r\n\t\"woff2\": \"font/woff2\", // Web Open Font Format (WOFF)\r\n\t\"aac\": \"audio/aac\", // AAC audio\r\n\t\"mid\": \"audio/midi audio/x-midi\", // Musical Instrument Digital Interface (MIDI)\r\n\t\"midi\": \"audio/midi audio/x-midi\", // Musical Instrument Digital Interface (MIDI)\r\n\t\"mp3\": \"audio/mpeg\", // MP3 audio\r\n\t\"oga\": \"audio/ogg\", // OGG audio\r\n\t\"opus\": \"audio/opus\", // Opus audio\r\n\t\"wav\": \"audio/wav\", // Waveform Audio Format\r\n\t\"weba\": \"audio/webm\", // WEBM audio\r\n\t\"avi\": \"video/x-msvideo\", // AVI: Audio Video Interleave\r\n\t\"mpeg\": \"video/mpeg\", // MPEG Video\r\n\t\"ogv\": \"video/ogg\", // OGG video\r\n\t\"ts\": \"video/mp2t\", // MPEG transport stream\r\n\t\"webm\": \"video/webm\", // WEBM video\r\n\t\"3gp\": \"video/3gpp\", //\taudio/3gpp if it doesn't contain video\", // 3GPP audio/video container\r\n\t\"3g2\": \"video/3gpp2\", // audio/3gpp2 if it doesn't contain video\", // 3GPP2 audio/video container\r\n\t\"abw\": \"application/x-abiword\", // AbiWord document\r\n\t\"arc\": \"application/x-freearc\", // Archive document (multiple files embedded)\r\n\t\"azw\": \"application/vnd.amazon.ebook\", // Amazon Kindle eBook format\r\n\t\"bin\": \"application/octet-stream\", // Any kind of binary data\r\n\t\"bz\": \"application/x-bzip\", // BZip archive\r\n\t\"bz2\": \"application/x-bzip2\", // BZip2 archive\r\n\t\"csh\": \"application/x-csh\", // C-Shell script\r\n\t\"doc\": \"application/msword\", // Microsoft Word\r\n\t\"docx\": \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\", // Microsoft Word (OpenXML)\r\n\t\"eot\": \"application/vnd.ms-fontobject\", // MS Embedded OpenType fonts\r\n\t\"epub\": \"application/epub+zip\", // Electronic publication (EPUB)\r\n\t\"gz\": \"application/gzip\", // GZip Compressed Archive\r\n\t\"jar\": \"application/java-archive\", // Java Archive (JAR)\r\n\t\"json\": \"application/json\", // JSON format\r\n\t\"jsonld\": \"application/ld+json\", // JSON-LD format\r\n\t\"map\": \"application/ld+json\", // sourcemaps\r\n\t\"mpkg\": \"application/vnd.apple.installer+xml\", // Apple Installer Package\r\n\t\"odp\": \"application/vnd.oasis.opendocument.presentation\", // OpenDocument presentation document\r\n\t\"ods\": \"application/vnd.oasis.opendocument.spreadsheet\", // OpenDocument spreadsheet document\r\n\t\"odt\": \"application/vnd.oasis.opendocument.text\", // OpenDocument text document\r\n\t\"ogx\": \"application/ogg\", // OGG\r\n\t\"pdf\": \"application/pdf\", // Adobe Portable Document Format (PDF)\r\n\t\"php\": \"application/x-httpd-php\", // Hypertext Preprocessor (Personal Home Page)\r\n\t\"ppt\": \"application/vnd.ms-powerpoint\", // Microsoft PowerPoint\r\n\t\"pptx\": \"application/vnd.openxmlformats-officedocument.presentationml.presentation\", // Microsoft PowerPoint (OpenXML)\r\n\t\"rar\": \"application/vnd.rar\", // RAR archive\r\n\t\"rtf\": \"application/rtf\", // Rich Text Format (RTF)\r\n\t\"sh\": \"application/x-sh\", // Bourne shell script\r\n\t\"swf\": \"application/x-shockwave-flash\", // Small web format (SWF) or Adobe Flash document\r\n\t\"tar\": \"application/x-tar\", // Tape Archive (TAR)\r\n\t\"vsd\": \"application/vnd.visio\", // Microsoft Visio\r\n\t\"webmanifest\": \"application/json\", // webmanifest\r\n\t\"xhtml\": \"application/xhtml+xml\", // XHTML\r\n\t\"xls\": \"application/vnd.ms-excel\", // Microsoft Excel\r\n\t\"xlsx\": \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\", // Microsoft Excel (OpenXML)\r\n\t\"xul\": \"application/vnd.mozilla.xul+xml\", // XUL\r\n\t\"zip\": \"application/zip\", // ZIP archive\r\n\t\"7z\": \"application/x-7z-compressed\", // 7-zip archive\r\n};\r\nconst MIME_TEXT = [\r\n\t'css', 'csv', 'htm', 'html', 'ics', 'js', 'mjs', 'txt', 'xml',\r\n];\r\nconst MIME_IMAGE = [\r\n\t'bmp', 'gif', 'ico', 'jpeg', 'jpg', 'png', 'svg', 'tif', 'tiff', 'webp',\r\n];\r\nconst MIME_FONTS = [\r\n\t'otf', 'ttf', 'woff', 'woff2',\r\n];\r\nconst MIME_AUDIO = [\r\n\t'aac', 'mid', 'midi', 'mp3', 'oga', 'opus', 'wav', 'weba',\r\n];\r\nconst MIME_VIDEO = [\r\n\t'avi', 'mpeg', 'ogv', 'ts', 'webm', '3gp', '3g2',\r\n];\r\nconst MIME_APPLICATION = [\r\n\t'abw', 'arc', 'azw', 'bin', 'bz', 'bz2', 'csh', 'doc', 'docx', 'eot', 'epub', 'gz', 'jar', 'json', 'jsonld', 'map', 'mpkg', 'odp', 'ods', 'odt', 'ogx', 'pdf', 'php', 'ppt', 'pptx', 'rar', 'rtf', 'sh', 'swf', 'tar', 'vsd', 'webmanifest', 'xhtml', 'xls', 'xlsx', 'xul', 'zip', '7z',\r\n];\r\nconst MIME_TYPES = [\r\n\t...MIME_TEXT,\r\n\t...MIME_IMAGE,\r\n\t...MIME_FONTS,\r\n\t...MIME_AUDIO,\r\n\t...MIME_VIDEO,\r\n\t...MIME_APPLICATION,\r\n];\r\n\r\nfunction staticMiddleware(vars) {\r\n\tif (!vars.root) {\r\n\t\tthrow new Error('missing Vars.root!');\r\n\t}\r\n\tif (!vars.baseHref) {\r\n\t\tthrow new Error('missing Vars.baseHref!');\r\n\t}\r\n\treturn (request, response, next) => {\r\n\t\tconst url = request.baseUrl.replace(/\\\\/g, '/');\r\n\t\tconst baseHref = vars.baseHref.substr(0, vars.baseHref.length - 1).replace(/\\\\/g, '/');\r\n\t\tconst regExpText = `^(${baseHref})?(\\\\/[^\\\\?\\\\#]+)(\\\\.(${MIME_TYPES.join('|')}))(\\\\?.+)?(\\\\#.+)?$`;\r\n\t\t// console.log('regExpText', url, regExpText);\r\n\t\tconst regExp = new RegExp(regExpText);\r\n\t\t// console.log('NodeJs.regExp', regExp);\r\n\t\tconst matches = regExp.exec(url);\r\n\t\t// console.log(request.url, request.baseUrl, request.originalUrl, match);\r\n\t\tif (matches) {\r\n\t\t\tconst extension = matches[4];\r\n\t\t\tconst file = path.join(matches[2] + '.' + extension);\r\n\t\t\tconst filePath = path.join(__dirname, '../', vars.root, file);\r\n\t\t\tfs.readFile(filePath, {}, (error, data) => {\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\tconsole.log('NodeJs.staticMiddleware.notFound', file);\r\n\t\t\t\t\treturn next();\r\n\t\t\t\t}\r\n\t\t\t\tconsole.log('NodeJs.staticMiddleware.serving', file);\r\n\t\t\t\tresponse.set('Content-Type', MIME_CONTENT_TYPES[extension]);\r\n\t\t\t\tresponse.send(data);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\t// console.log('NodeJs.staticMiddleware.unmatch', file);\r\n\t\t\tnext();\r\n\t\t}\r\n\t};\r\n};\r\n\r\n// app.use(express.static(BASE_HREF, { index: false, extensions: MIME_TYPES }));\r\n// app.use(express.static('/', { index: false, extensions: MIME_TYPES }));\r\n// app.use(STATIC_REGEXP, serveStatic(path.join(__dirname, `${ROOT}`)));\r\n// app.use('/', serveStatic(path.join(__dirname, `${ROOT}`)));\r\n// app.use(express.static(path.join(__dirname, ROOT)));\r\n\r\nmodule.exports = {\r\n\tmimeContentTypes: MIME_CONTENT_TYPES,\r\n\tmimeText: MIME_TEXT,\r\n\tmimeImage: MIME_IMAGE,\r\n\tmimeFonts: MIME_FONTS,\r\n\tmimeAudio: MIME_AUDIO,\r\n\tmimeVideo: MIME_VIDEO,\r\n\tmimeApplication: MIME_APPLICATION,\r\n\tstaticMiddleware: staticMiddleware,\r\n};\r\n","const fs = require('fs');\r\nconst path = require('path');\r\n\r\n/*\r\nconst { RtcTokenBuilder, RtmTokenBuilder, RtcRole, RtmRole } = require('agora-access-token');\r\n\r\napp.post('/api/token/rtc', function(request, response) {\r\n\tconst payload = request.body || {};\r\n\tconst duration = 3600;\r\n\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\tconst expirationTime = timestamp + duration;\r\n\tconst uid = payload.uid ? String(payload.uid) : timestamp.toString();\r\n\tconst role = RtcRole.PUBLISHER;\r\n\tconst token = RtcTokenBuilder.buildTokenWithUid(environment.appKey, environment.appCertificate, environment.channelName, uid, role, expirationTime);\r\n\tresponse.send(JSON.stringify({\r\n\t\ttoken: token,\r\n\t}));\r\n});\r\n\r\napp.post('/api/token/rtm', function(request, response) {\r\n\tconst payload = request.body || {};\r\n\tconst duration = 3600;\r\n\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\tconst expirationTime = timestamp + duration;\r\n\tconst uid = payload.uid ? String(payload.uid) : timestamp.toString();\r\n\tconst role = RtmRole.PUBLISHER;\r\n\tconst token = RtmTokenBuilder.buildToken(environment.appKey, environment.appCertificate, uid, role, expirationTime);\r\n\tresponse.send(JSON.stringify({\r\n\t\ttoken: token,\r\n\t}));\r\n});\r\n*/\r\n\r\nlet db = { views: [], assets: [] };\r\n\r\nconst pathname = path.join(__dirname, `../../docs/api/editor.json`);\r\nreadStore();\r\n\r\nfunction useApi() {\r\n\treturn null;\r\n}\r\n\r\nfunction readStore() {\r\n\tfs.readFile(pathname, 'utf8', (error, data) => {\r\n\t\tif (error) {\r\n\t\t\tconsole.log('NodeJs.Api.readStore.error', error, pathname);\r\n\t\t} else {\r\n\t\t\ttry {\r\n\t\t\t\tdb = JSON.parse(data);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('NodeJs.Api.readStore.error', error, pathname);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction saveStore() {\r\n\tconst data = JSON.stringify(db, null, 2);\r\n\tfs.writeFile(pathname, data, 'utf8', (error, data) => {\r\n\t\tif (error) {\r\n\t\t\tconsole.log('NodeJs.Api.saveStore.error', error, pathname);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction doCreate(request, response, params, items) {\r\n\tconst body = request.body;\r\n\tconst id = new Date().getTime();\r\n\tconst item = Object.assign({}, body, { id });\r\n\titems.push(item);\r\n\tsaveStore();\r\n\tresponse.send(JSON.stringify(item));\r\n}\r\n\r\nfunction doUpdate(request, response, params, items) {\r\n\tconst body = request.body;\r\n\tconst item = items.find(x => x.id === body.id);\r\n\tif (item) {\r\n\t\tObject.assign(item, body);\r\n\t\tsaveStore();\r\n\t\tresponse.send(JSON.stringify(item));\r\n\t} else {\r\n\t\tresponse.status(404).error('Not Found');\r\n\t}\r\n}\r\n\r\nfunction doDelete(request, response, params, items) {\r\n\tconst index = items.reduce((p, x, i) => x.id === params.id ? i : p, -1);\r\n\tif (index !== -1) {\r\n\t\tconst item = items[index];\r\n\t\titems.splice(index, 1);\r\n\t\tsaveStore();\r\n\t\tresponse.send(JSON.stringify(item));\r\n\t} else {\r\n\t\tresponse.status(404).error('Not Found');\r\n\t}\r\n}\r\n\r\n// /api/upload\r\nconst ROUTES = [{\r\n\tpath: '/api/view', method: 'POST', callback: function(request, response, params) {\r\n\t\tdoCreate(request, response, params, db.views);\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId', method: 'UPDATE', callback: function(request, response, params) {\r\n\t\tdoUpdate(request, response, { id: params.viewId }, db.views);\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId', method: 'DELETE', callback: function(request, response, params) {\r\n\t\tdoDelete(request, response, { id: params.viewId }, db.views);\r\n\t}\r\n}, {\r\n\tpath: '/api/asset', method: 'POST', callback: function(request, response, params) {\r\n\t\tdoCreate(request, response, params, db.assets);\r\n\t}\r\n}];\r\nROUTES.forEach(route => {\r\n\tconst segments = [];\r\n\tif (route.path === '**') {\r\n\t\tsegments.push(route.path);\r\n\t\troute.matcher = new RegExp('^.*$');\r\n\t} else {\r\n\t\tconst matchers = [`^`];\r\n\t\tconst regExp = /(^\\.\\.\\/|\\.\\/|\\/\\/|\\/)|([^:|\\/]+)\\/?|\\:([^\\/]+)\\/?/g;\r\n\t\tconst matches = route.path.matchAll(regExp);\r\n\t\tfor (let match of matches) {\r\n\t\t\tconst g1 = match[1];\r\n\t\t\tconst g2 = match[2];\r\n\t\t\tconst g3 = match[3];\r\n\t\t\tif (g1) {\r\n\t\t\t\tthis.relative = !(g1 === '//' || g1 === '/');\r\n\t\t\t} else if (g2) {\r\n\t\t\t\tmatchers.push('\\/' + g2);\r\n\t\t\t\tsegments.push(g2);\r\n\t\t\t} else if (g3) {\r\n\t\t\t\tmatchers.push('(\\/[^\\/]+)');\r\n\t\t\t\tconst params = {};\r\n\t\t\t\tparams[g3] = null;\r\n\t\t\t\troute.params = params;\r\n\t\t\t\tsegments.push('');\r\n\t\t\t}\r\n\t\t}\r\n\t\tmatchers.push('$');\r\n\t\tconst regexp = matchers.join('');\r\n\t\tconsole.log(regexp)\r\n\t\troute.matcher = new RegExp(regexp);\r\n\t}\r\n\troute.segments = segments;\r\n})\r\n\r\nfunction apiMiddleware(vars) {\r\n\tif (!vars.root) {\r\n\t\tthrow new Error('missing Vars.root!');\r\n\t}\r\n\tif (!vars.baseHref) {\r\n\t\tthrow new Error('missing Vars.baseHref!');\r\n\t}\r\n\treturn (request, response, next) => {\r\n\t\tconst url = request.baseUrl.replace(/\\\\/g, '/');\r\n\t\tconsole.log('apiMiddleware.url', url);\r\n\t\tconst params = {};\r\n\t\tconst method = ROUTES.find(route => {\r\n\t\t\tif (route.method.toLowerCase() === request.method.toLowerCase()) {\r\n\t\t\t\tconst match = url.match(route.matcher);\r\n\t\t\t\tif (match) {\r\n\t\t\t\t\tconsole.log('match', match);\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (method) {\r\n\t\t\tmethod.callback(request, response, params);\r\n\t\t} else {\r\n\t\t\tnext();\r\n\t\t}\r\n\t};\r\n};\r\n\r\nmodule.exports = {\r\n\tapiMiddleware: apiMiddleware,\r\n\tuseApi: useApi,\r\n};\r\n","const https = require('https');\r\nconst fs = require('fs');\r\nconst serveStatic = require('serve-static');\r\nconst express = require('express');\r\nconst bodyParser = require('body-parser');\r\nconst path = require('path');\r\nconst multipart = require('connect-multiparty');\r\nconst multipartMiddleware = multipart();\r\nconst { upload } = require('./upload/upload.js');\r\nconst uploader = upload(path.join(__dirname, '../docs/temp/'));\r\nconst { staticMiddleware } = require('./static/static.js');\r\n// const { spaMiddleware } = require('./spa/spa.js');\r\nconst { apiMiddleware, useApi } = require('./api/api.js');\r\n// const router = express.Router();\r\n// const https = require('https');\r\nconst BASE_HREF = '/b-here/';\r\nconst ASSETS = `assets/`;\r\nconst ROOT = `../docs/`;\r\nconst PORT = process.env.PORT || 5000;\r\n\r\nconst Vars = {\r\n\tport: PORT,\r\n\thost: `http://localhost:${PORT}`,\r\n\tcharset: 'utf8',\r\n\tassets: ASSETS,\r\n\tbaseHref: BASE_HREF,\r\n\tcacheMode: 'file',\r\n\tcache: path.join(__dirname, `../cache/`),\r\n\troot: ROOT,\r\n\ttemplate: path.join(__dirname, `${ROOT}index.html`),\r\n\taccessControlAllowOrigin: true,\r\n};\r\n\r\nconst staticMiddleware_ = staticMiddleware(Vars);\r\nconst apiMiddleware_ = apiMiddleware(Vars);\r\n// const spaMiddleware_ = spaMiddleware(Vars);\r\nconst app = express();\r\napp.disable('x-powered-by');\r\napp.use(bodyParser.urlencoded({ extended: true }));\r\napp.use(bodyParser.json());\r\napp.use(bodyParser.raw());\r\napp.use('*', staticMiddleware_);\r\napp.use('*', apiMiddleware_);\r\n// Handle uploads through Flow.js\r\napp.post('/api/upload', multipartMiddleware, function(request, response) {\r\n\tuploader.post(request, function(status, filename, original_filename, identifier) {\r\n\t\tconsole.log('POST', status, original_filename, identifier);\r\n\t\tif (Vars.accessControlAllowOrigin) {\r\n\t\t\tresponse.header('Access-Control-Allow-Origin', '*');\r\n\t\t}\r\n\t\tif (status === 'done') {\r\n\t\t\tfilename = identifier + '_' + filename;\r\n\t\t\tconst stream = fs.createWriteStream(path.join(__dirname, '../docs/uploads/', filename));\r\n\t\t\tstream.on('finish', function() {\r\n\t\t\t\tresponse.status(200).send(JSON.stringify({\r\n\t\t\t\t\tfilename,\r\n\t\t\t\t\turl: `/uploads/${filename}`,\r\n\t\t\t\t}));\r\n\t\t\t});\r\n\t\t\tuploader.write(identifier, stream, { end: true });\r\n\t\t} else {\r\n\t\t\tresponse.status(/^(partly_done|done)$/.test(status) ? 200 : 500).send();\r\n\t\t}\r\n\t});\r\n});\r\napp.options('/api/upload', function(request, response) {\r\n\tconsole.log('OPTIONS');\r\n\tif (Vars.accessControlAllowOrigin) {\r\n\t\tresponse.header('Access-Control-Allow-Origin', '*');\r\n\t}\r\n\tresponse.status(200).send();\r\n});\r\n// Handle status checks on chunks through Flow.js\r\napp.get('/api/upload', function(request, response) {\r\n\tuploader.get(request, function(status, filename, original_filename, identifier) {\r\n\t\tconsole.log('GET', status);\r\n\t\tif (Vars.accessControlAllowOrigin) {\r\n\t\t\tresponse.header('Access-Control-Allow-Origin', '*');\r\n\t\t}\r\n\t\tif (status == 'found') {\r\n\t\t\tstatus = 200;\r\n\t\t} else {\r\n\t\t\tstatus = 204;\r\n\t\t}\r\n\t\tresponse.status(status).send();\r\n\t});\r\n});\r\napp.get('/api/download/:identifier', function(request, response) {\r\n\tuploader.write(request.params.identifier, response);\r\n});\r\n// Handle uploads through Flow.js\r\n// app.get('*', spaMiddleware_);\r\napp.get('/', function(request, response) {\r\n\tresponse.sendFile(path.join(__dirname, '../docs/index.html'));\r\n\t// response.render('docs/index');\r\n});\r\napp.listen(Vars.port, () => {\r\n\tconsole.log(`NodeJs Running server at ${Vars.host}`);\r\n});\r\n"],"names":["upload","temporaryFolder","this_","maxFileSize","fileParameterName","fs","mkdirSync","e","cleanIdentifier","identifier","replace","getChunkFilename","chunkNumber","path","resolve","validateRequest","chunkSize","totalSize","filename","fileSize","length","numberOfChunks","Math","max","floor","parseInt","get","req","callback","param","chunkFilename","access","constants","F_OK","error","post","fields","body","files","size","original_filename","validation","mv","currentTestChunk","testChunkExists","write","stream","options","end","pipeChunk","number","clean","source","createReadStream","pipe","on","pipeChunkRm","onDone","console","log","unlink","err","onError","MIME_CONTENT_TYPES","MIME_TEXT","MIME_IMAGE","MIME_FONTS","MIME_AUDIO","MIME_VIDEO","MIME_APPLICATION","MIME_TYPES","staticMiddleware","vars","root","Error","baseHref","request","response","next","url","baseUrl","substr","regExpText","join","regExp","RegExp","matches","exec","extension","file","filePath","__dirname","readFile","data","set","send","mimeContentTypes","mimeText","mimeImage","mimeFonts","mimeAudio","mimeVideo","mimeApplication","db","views","assets","pathname","readStore","useApi","JSON","parse","saveStore","stringify","writeFile","doCreate","params","items","id","Date","getTime","item","Object","assign","push","doUpdate","find","x","status","doDelete","index","reduce","p","i","splice","ROUTES","method","viewId","forEach","route","segments","matcher","matchers","matchAll","match","g1","g2","g3","relative","regexp","apiMiddleware","toLowerCase","multipartMiddleware","multipart","require$$0","uploader","require$$1","require$$2","BASE_HREF","ASSETS","ROOT","PORT","process","env","Vars","port","host","charset","cacheMode","cache","template","accessControlAllowOrigin","staticMiddleware_","apiMiddleware_","app","express","disable","use","bodyParser","urlencoded","extended","json","raw","header","createWriteStream","test","sendFile","listen"],"mappings":"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"}