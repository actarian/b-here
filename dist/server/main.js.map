{"version":3,"file":"server/main.js","sources":["../../server/static/static.js","../../server/api/api.js","../../server/main.js"],"sourcesContent":["const path = require('path');\r\nconst fs = require('fs');\r\n// const router = express.Router();\r\n// const serveStatic = require('serve-static');\r\n\r\nconst MIME_CONTENT_TYPES = {\r\n\t\"css\": \"text/css\", // Cascading Style Sheets (CSS)\r\n\t\"csv\": \"text/csv\", // Comma-separated values (CSV)\r\n\t\"htm\": \"text/html\", // HyperText Markup Language (HTML)\r\n\t\"html\": \"text/html\", // HyperText Markup Language (HTML)\r\n\t\"ics\": \"text/calendar\", // iCalendar format\r\n\t\"js\": \"text/javascript\", // per the following specifications: https://html.spec.whatwg.org/multipage/#scriptingLanguages, https://html.spec.whatwg.org/multipage/#dependencies:willful-violation, https://datatracker.ietf.org/doc/draft-ietf-dispatch-javascript-mjs/ JavaScript\r\n\t\"mjs\": \"text/javascript\", // JavaScript module\r\n\t\"txt\": \"text/plain\", // Text, (generally ASCII or ISO 8859-n)\r\n\t\"xml\": \"text/xml\", // if readable from casual users (RFC 3023, section 3) \"application/xml\" if not readable from casual users (RFC 3023, section 3)\", // XML\r\n\t\"bmp\": \"image/bmp\", // Windows OS/2 Bitmap Graphics\r\n\t\"gif\": \"image/gif\", // Graphics Interchange Format (GIF)\r\n\t\"ico\": \"image/vnd.microsoft.icon\", // Icon format\r\n\t\"jpeg\": \"image/jpeg\", // JPEG images\r\n\t\"jpg\": \"image/jpeg\", // JPEG images\r\n\t\"png\": \"image/png\", // Portable Network Graphics\r\n\t\"svg\": \"image/svg+xml\", // Scalable Vector Graphics (SVG)\r\n\t\"tif\": \"image/tiff\", // Tagged Image File Format (TIFF)\r\n\t\"tiff\": \"image/tiff\", // Tagged Image File Format (TIFF)\r\n\t\"webp\": \"image/webp\", // WEBP image\r\n\t\"otf\": \"font/otf\", // OpenType font\r\n\t\"ttf\": \"font/ttf\", // TrueType Font\r\n\t\"woff\": \"font/woff\", // Web Open Font Format (WOFF)\r\n\t\"woff2\": \"font/woff2\", // Web Open Font Format (WOFF)\r\n\t\"aac\": \"audio/aac\", // AAC audio\r\n\t\"mid\": \"audio/midi audio/x-midi\", // Musical Instrument Digital Interface (MIDI)\r\n\t\"midi\": \"audio/midi audio/x-midi\", // Musical Instrument Digital Interface (MIDI)\r\n\t\"mp3\": \"audio/mpeg\", // MP3 audio\r\n\t\"mp4\": \"audio/mp4\", // MP4 video\r\n\t\"oga\": \"audio/ogg\", // OGG audio\r\n\t\"opus\": \"audio/opus\", // Opus audio\r\n\t\"wav\": \"audio/wav\", // Waveform Audio Format\r\n\t\"weba\": \"audio/webm\", // WEBM audio\r\n\t\"avi\": \"video/x-msvideo\", // AVI: Audio Video Interleave\r\n\t\"mpeg\": \"video/mpeg\", // MPEG Video\r\n\t\"ogv\": \"video/ogg\", // OGG video\r\n\t\"ts\": \"video/mp2t\", // MPEG transport stream\r\n\t\"webm\": \"video/webm\", // WEBM video\r\n\t\"3gp\": \"video/3gpp\", //\taudio/3gpp if it doesn't contain video\", // 3GPP audio/video container\r\n\t\"3g2\": \"video/3gpp2\", // audio/3gpp2 if it doesn't contain video\", // 3GPP2 audio/video container\r\n\t\"abw\": \"application/x-abiword\", // AbiWord document\r\n\t\"arc\": \"application/x-freearc\", // Archive document (multiple files embedded)\r\n\t\"azw\": \"application/vnd.amazon.ebook\", // Amazon Kindle eBook format\r\n\t\"bin\": \"application/octet-stream\", // Any kind of binary data\r\n\t\"bz\": \"application/x-bzip\", // BZip archive\r\n\t\"bz2\": \"application/x-bzip2\", // BZip2 archive\r\n\t\"csh\": \"application/x-csh\", // C-Shell script\r\n\t\"doc\": \"application/msword\", // Microsoft Word\r\n\t\"docx\": \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\", // Microsoft Word (OpenXML)\r\n\t\"eot\": \"application/vnd.ms-fontobject\", // MS Embedded OpenType fonts\r\n\t\"epub\": \"application/epub+zip\", // Electronic publication (EPUB)\r\n\t\"gz\": \"application/gzip\", // GZip Compressed Archive\r\n\t\"jar\": \"application/java-archive\", // Java Archive (JAR)\r\n\t\"json\": \"application/json\", // JSON format\r\n\t\"jsonld\": \"application/ld+json\", // JSON-LD format\r\n\t\"map\": \"application/ld+json\", // sourcemaps\r\n\t\"mpkg\": \"application/vnd.apple.installer+xml\", // Apple Installer Package\r\n\t\"odp\": \"application/vnd.oasis.opendocument.presentation\", // OpenDocument presentation document\r\n\t\"ods\": \"application/vnd.oasis.opendocument.spreadsheet\", // OpenDocument spreadsheet document\r\n\t\"odt\": \"application/vnd.oasis.opendocument.text\", // OpenDocument text document\r\n\t\"ogx\": \"application/ogg\", // OGG\r\n\t\"pdf\": \"application/pdf\", // Adobe Portable Document Format (PDF)\r\n\t\"php\": \"application/x-httpd-php\", // Hypertext Preprocessor (Personal Home Page)\r\n\t\"ppt\": \"application/vnd.ms-powerpoint\", // Microsoft PowerPoint\r\n\t\"pptx\": \"application/vnd.openxmlformats-officedocument.presentationml.presentation\", // Microsoft PowerPoint (OpenXML)\r\n\t\"rar\": \"application/vnd.rar\", // RAR archive\r\n\t\"rtf\": \"application/rtf\", // Rich Text Format (RTF)\r\n\t\"sh\": \"application/x-sh\", // Bourne shell script\r\n\t\"swf\": \"application/x-shockwave-flash\", // Small web format (SWF) or Adobe Flash document\r\n\t\"tar\": \"application/x-tar\", // Tape Archive (TAR)\r\n\t\"vsd\": \"application/vnd.visio\", // Microsoft Visio\r\n\t\"webmanifest\": \"application/json\", // webmanifest\r\n\t\"xhtml\": \"application/xhtml+xml\", // XHTML\r\n\t\"xls\": \"application/vnd.ms-excel\", // Microsoft Excel\r\n\t\"xlsx\": \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\", // Microsoft Excel (OpenXML)\r\n\t\"xul\": \"application/vnd.mozilla.xul+xml\", // XUL\r\n\t\"zip\": \"application/zip\", // ZIP archive\r\n\t\"7z\": \"application/x-7z-compressed\", // 7-zip archive,\r\n\t\"glb\": \"application/octet-stream\", // Glb\r\n\t\"gltf\": \"application/octet-stream\", // Gltf\r\n\t\"fbx\": \"application/octet-stream\", // Fbx\r\n\t\"usdz\": \"application/octet-stream\", // Usdz\r\n};\r\nconst MIME_TEXT = [\r\n\t'css', 'csv', 'htm', 'html', 'ics', 'js', 'mjs', 'txt', 'xml',\r\n];\r\nconst MIME_IMAGE = [\r\n\t'bmp', 'gif', 'ico', 'jpeg', 'jpg', 'png', 'svg', 'tif', 'tiff', 'webp',\r\n];\r\nconst MIME_FONTS = [\r\n\t'otf', 'ttf', 'woff', 'woff2',\r\n];\r\nconst MIME_AUDIO = [\r\n\t'aac', 'mid', 'midi', 'mp3', 'oga', 'opus', 'wav', 'weba',\r\n];\r\nconst MIME_VIDEO = [\r\n\t'mp4', 'avi', 'mpeg', 'ogv', 'ts', 'webm', '3gp', '3g2',\r\n];\r\nconst MIME_APPLICATION = [\r\n\t'abw', 'arc', 'azw', 'bin', 'bz', 'bz2', 'csh', 'doc', 'docx', 'eot', 'epub', 'gz', 'jar', 'json', 'jsonld', 'map', 'mpkg', 'odp', 'ods', 'odt', 'ogx', 'pdf', 'php', 'ppt', 'pptx', 'rar', 'rtf', 'sh', 'swf', 'tar', 'vsd', 'webmanifest', 'xhtml', 'xls', 'xlsx', 'xul', 'zip', '7z',\r\n\t'glb', 'gltf', 'fbx', 'usdz',\r\n];\r\nconst MIME_TYPES = [\r\n\t...MIME_TEXT,\r\n\t...MIME_IMAGE,\r\n\t...MIME_FONTS,\r\n\t...MIME_AUDIO,\r\n\t...MIME_VIDEO,\r\n\t...MIME_APPLICATION,\r\n];\r\n\r\nfunction staticMiddleware(vars) {\r\n\tif (!vars.root) {\r\n\t\tthrow new Error('missing Vars.root!');\r\n\t}\r\n\tif (!vars.baseHref) {\r\n\t\tthrow new Error('missing Vars.baseHref!');\r\n\t}\r\n\treturn (request, response, next) => {\r\n\t\tconst url = unescape(request.baseUrl.replace(/\\\\/g, '/'));\r\n\t\tconst baseHref = vars.baseHref.substr(0, vars.baseHref.length - 1).replace(/\\\\/g, '/');\r\n\t\tconst regExpText = `^(${baseHref})?(\\\\/[^\\\\?\\\\#]+)(\\\\.(${MIME_TYPES.join('|')}))(\\\\?.+)?(\\\\#.+)?$`;\r\n\t\t// console.log('regExpText', url, regExpText);\r\n\t\tconst regExp = new RegExp(regExpText);\r\n\t\t// console.log('NodeJs.regExp', regExp);\r\n\t\tconst matches = regExp.exec(url);\r\n\t\t// console.log(request.url, request.baseUrl, request.originalUrl, match);\r\n\t\tif (matches) {\r\n\t\t\tconst extension = matches[4];\r\n\t\t\tconst file = path.join(matches[2] + '.' + extension);\r\n\t\t\tconst filePath = path.join(__dirname, '../', vars.root, file);\r\n\t\t\tfs.readFile(filePath, {}, (error, data) => {\r\n\t\t\t\tif (error) {\r\n\t\t\t\t\tconsole.log('NodeJs.staticMiddleware.notFound', file);\r\n\t\t\t\t\treturn next();\r\n\t\t\t\t}\r\n\t\t\t\tconsole.log('NodeJs.staticMiddleware.serving', file);\r\n\t\t\t\tresponse.set('Content-Type', MIME_CONTENT_TYPES[extension]);\r\n\t\t\t\tresponse.send(data);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\t// console.log('NodeJs.staticMiddleware.unmatch', file);\r\n\t\t\tnext();\r\n\t\t}\r\n\t};\r\n};\r\n\r\n// app.use(express.static(BASE_HREF, { index: false, extensions: MIME_TYPES }));\r\n// app.use(express.static('/', { index: false, extensions: MIME_TYPES }));\r\n// app.use(STATIC_REGEXP, serveStatic(path.join(__dirname, `${ROOT}`)));\r\n// app.use('/', serveStatic(path.join(__dirname, `${ROOT}`)));\r\n// app.use(express.static(path.join(__dirname, ROOT)));\r\n\r\nmodule.exports = {\r\n\tmimeContentTypes: MIME_CONTENT_TYPES,\r\n\tmimeText: MIME_TEXT,\r\n\tmimeImage: MIME_IMAGE,\r\n\tmimeFonts: MIME_FONTS,\r\n\tmimeAudio: MIME_AUDIO,\r\n\tmimeVideo: MIME_VIDEO,\r\n\tmimeApplication: MIME_APPLICATION,\r\n\tstaticMiddleware: staticMiddleware,\r\n};\r\n","const fs = require('fs');\r\nconst path = require('path');\r\n\r\nconst RoleType = {\r\n\tPublisher: 'publisher',\r\n\tAttendee: 'attendee',\r\n\tStreamer: 'streamer',\r\n\tViewer: 'viewer',\r\n\tSelfService: 'self-service',\r\n};\r\n\r\n/*\r\nconst { RtcTokenBuilder, RtmTokenBuilder, RtcRole, RtmRole } = require('agora-access-token');\r\nconst appCertificate = '';\r\n\r\napp.post('/api/token/rtc', function(request, response) {\r\n\tconst payload = request.body || {};\r\n\tconst duration = 3600;\r\n\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\tconst expirationTime = timestamp + duration;\r\n\tconst uid = payload.uid ? String(payload.uid) : timestamp.toString();\r\n\tconst role = RtcRole.PUBLISHER;\r\n\tconst token = RtcTokenBuilder.buildTokenWithUid(environment.appKey, appCertificate, environment.channelName, uid, role, expirationTime);\r\n\tresponse.send(JSON.stringify({\r\n\t\ttoken: token,\r\n\t}));\r\n});\r\n\r\napp.post('/api/token/rtm', function(request, response) {\r\n\tconst payload = request.body || {};\r\n\tconst duration = 3600;\r\n\tconst timestamp = Math.floor(Date.now() / 1000);\r\n\tconst expirationTime = timestamp + duration;\r\n\tconst uid = payload.uid ? String(payload.uid) : timestamp.toString();\r\n\tconst role = RtmRole.PUBLISHER;\r\n\tconst token = RtmTokenBuilder.buildToken(environment.appKey, appCertificate, uid, role, expirationTime);\r\n\tresponse.send(JSON.stringify({\r\n\t\ttoken: token,\r\n\t}));\r\n});\r\n*/\r\n\r\nlet db = {\r\n\tviews: [], assets: [], users: [\r\n\t\t{\r\n\t\t\tid: '1601892639985',\r\n\t\t\tusername: 'publisher',\r\n\t\t\tpassword: 'publisher',\r\n\t\t\ttype: 'publisher',\r\n\t\t\tfirstName: 'Jhon',\r\n\t\t\tlastName: 'Appleseed',\r\n\t\t}, {\r\n\t\t\tid: '1601892639986',\r\n\t\t\tusername: 'attendee',\r\n\t\t\tpassword: 'attendee',\r\n\t\t\ttype: 'attendee',\r\n\t\t\tfirstName: 'Jhon',\r\n\t\t\tlastName: 'Appleseed',\r\n\t\t}\r\n\t]\r\n};\r\n\r\nconst pathname = path.join(__dirname, `../../docs/api/editor.json`);\r\nreadStore();\r\n\r\nfunction uuid() {\r\n\t// return new Date().getTime();\r\n\treturn parseInt(process.hrtime.bigint().toString());\r\n}\r\n\r\nfunction useApi() {\r\n\treturn null;\r\n}\r\n\r\nfunction readStore() {\r\n\tfs.readFile(pathname, 'utf8', (error, data) => {\r\n\t\tif (error) {\r\n\t\t\tconsole.log('NodeJs.Api.readStore.error', error, pathname);\r\n\t\t} else {\r\n\t\t\ttry {\r\n\t\t\t\tdb = Object.assign(db, JSON.parse(data));\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.log('NodeJs.Api.readStore.error', error, pathname);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction saveStore() {\r\n\tconst data = JSON.stringify(db, null, 2);\r\n\tfs.writeFile(pathname, data, 'utf8', (error, data) => {\r\n\t\tif (error) {\r\n\t\t\tconsole.log('NodeJs.Api.saveStore.error', error, pathname);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction sendError(response, status, message) {\r\n\tresponse.status(status).set('Content-Type', 'application/json').send(JSON.stringify({ status, message }));\r\n}\r\n\r\nfunction sendOk(response, data) {\r\n\tif (data) {\r\n\t\tresponse.status(200).set('Content-Type', 'application/json').send(JSON.stringify(data));\r\n\t} else {\r\n\t\tresponse.status(200).set('Content-Type', 'text/plain').send();\r\n\t}\r\n}\r\n\r\nfunction doCreate(request, response, params, items) {\r\n\tconst body = request.body;\r\n\tconst id = uuid();\r\n\tconst item = Object.assign({}, body, { id });\r\n\tif (item.items) {\r\n\t\titem.items.forEach(x => x.id = uuid());\r\n\t}\r\n\tif (item.tiles) {\r\n\t\titem.tiles.forEach(x => x.id = uuid());\r\n\t}\r\n\tif (item.navs) {\r\n\t\titem.navs.forEach(x => x.id = uuid());\r\n\t}\r\n\titems.push(item);\r\n\tsaveStore();\r\n\tsendOk(response, item);\r\n}\r\n\r\nfunction doUpdate(request, response, params, items) {\r\n\tconst body = request.body;\r\n\tconst item = items.find(x => x.id === body.id);\r\n\tif (item) {\r\n\t\tObject.assign(item, body);\r\n\t\tsaveStore();\r\n\t\tsendOk(response, item);\r\n\t} else {\r\n\t\tsendError(response, 404, 'Not Found');\r\n\t}\r\n}\r\n\r\nfunction doDelete(request, response, params, items) {\r\n\tconst index = items.reduce((p, x, i) => x.id === params.id ? i : p, -1);\r\n\tif (index !== -1) {\r\n\t\t// const item = items[index];\r\n\t\titems.splice(index, 1);\r\n\t\tsaveStore();\r\n\t\t// sendOk(response, item);\r\n\t\tsendOk(response);\r\n\t} else {\r\n\t\tsendError(response, 404, 'Not Found');\r\n\t}\r\n}\r\n\r\nfunction doGet(request, response, params, items) {\r\n\tlet item = items.find(x => x.id === params.id);\r\n\tif (!item) {\r\n\t\tsendError(response, 404, 'Not Found');\r\n\t}\r\n\treturn item;\r\n}\r\n\r\n// /api/upload\r\nconst ROUTES = [{\r\n\tpath: '/api/view', method: 'GET', callback: function(request, response, params) {\r\n\t\tsendOk(response, db);\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId', method: 'GET', callback: function(request, response, params) {\r\n\t\tconst view = doGet(request, response, { id: params.viewId }, db.views);\r\n\t\tif (view) {\r\n\t\t\tsendOk(response, view);\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/view', method: 'POST', callback: function(request, response, params) {\r\n\t\tdoCreate(request, response, params, db.views);\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId', method: 'PUT', callback: function(request, response, params) {\r\n\t\tdoUpdate(request, response, params, db.views);\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId', method: 'DELETE', callback: function(request, response, params) {\r\n\t\tdoDelete(request, response, { id: params.viewId }, db.views);\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId/item', method: 'POST', callback: function(request, response, params) {\r\n\t\tconst view = doGet(request, response, { id: params.viewId }, db.views);\r\n\t\tif (view) {\r\n\t\t\tview.items = view.items || [];\r\n\t\t\tdoCreate(request, response, params, view.items);\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId/item/:viewItemId', method: 'PUT', callback: function(request, response, params) {\r\n\t\tconst view = doGet(request, response, { id: params.viewId }, db.views);\r\n\t\tif (view) {\r\n\t\t\tview.items = view.items || [];\r\n\t\t\tdoUpdate(request, response, params, view.items);\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId/item/:viewItemId', method: 'DELETE', callback: function(request, response, params) {\r\n\t\tconst view = doGet(request, response, { id: params.viewId }, db.views);\r\n\t\tif (view) {\r\n\t\t\tdoDelete(request, response, { id: params.viewItemId }, view.items);\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId/tile/:tileId/item', method: 'POST', callback: function(request, response, params) {\r\n\t\tconst view = doGet(request, response, { id: params.viewId }, db.views);\r\n\t\tif (view) {\r\n\t\t\tconst tile = view.tiles.find(x => x.id === params.tileId);\r\n\t\t\tif (tile) {\r\n\t\t\t\ttile.navs = tile.navs || [];\r\n\t\t\t\tdoCreate(request, response, params, tile.navs);\r\n\t\t\t} else {\r\n\t\t\t\tsendError(response, 404, 'Not Found');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId/tile/:tileId/item/:viewItemId', method: 'PUT', callback: function(request, response, params) {\r\n\t\tconst view = doGet(request, response, { id: params.viewId }, db.views);\r\n\t\tif (view) {\r\n\t\t\tconst tile = view.tiles.find(x => x.id === params.tileId);\r\n\t\t\tif (tile) {\r\n\t\t\t\ttile.navs = tile.navs || [];\r\n\t\t\t\tdoUpdate(request, response, params, tile.navs);\r\n\t\t\t} else {\r\n\t\t\t\tsendError(response, 404, 'Not Found');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/view/:viewId/tile/:tileId/item/:viewItemId', method: 'DELETE', callback: function(request, response, params) {\r\n\t\tconst view = doGet(request, response, { id: params.viewId }, db.views);\r\n\t\tif (view) {\r\n\t\t\tconst tile = view.tiles.find(x => x.id === params.tileId);\r\n\t\t\tif (tile) {\r\n\t\t\t\ttile.navs = tile.navs || [];\r\n\t\t\t\tdoDelete(request, response, { id: params.viewItemId }, tile.navs);\r\n\t\t\t} else {\r\n\t\t\t\tsendError(response, 404, 'Not Found');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/asset', method: 'POST', callback: function(request, response, params) {\r\n\t\tdoCreate(request, response, params, db.assets);\r\n\t}\r\n}, {\r\n\tpath: '/api/asset/:assetId', method: 'PUT', callback: function(request, response, params) {\r\n\t\tdoUpdate(request, response, params, db.assets);\r\n\t}\r\n}, {\r\n\tpath: '/api/asset/:assetId', method: 'DELETE', callback: function(request, response, params) {\r\n\t\tdoDelete(request, response, { id: params.assetId }, db.assets);\r\n\t}\r\n}, {\r\n\tpath: '/api/user/me', method: 'GET', callback: function(request, response, params) {\r\n\t\tconst user = request.session.user;\r\n\t\tif (!user) {\r\n\t\t\tsendError(response, 404, 'Not Found');\r\n\t\t} else {\r\n\t\t\tsendOk(response, user);\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/user/login', method: 'POST', callback: function(request, response, params) {\r\n\t\tconst body = request.body;\r\n\t\tconst user = db.users.find(x => x.username === body.username && x.password === body.password);\r\n\t\tif (!user) {\r\n\t\t\tsendError(response, 404, 'Not Found');\r\n\t\t} else {\r\n\t\t\trequest.session.user = user;\r\n\t\t\tsendOk(response, user);\r\n\t\t}\r\n\t}\r\n}, {\r\n\tpath: '/api/user/logout', method: 'GET', callback: function(request, response, params) {\r\n\t\tconst user = request.session.user;\r\n\t\trequest.session.user = null;\r\n\t\tsendOk(response);\r\n\t}\r\n}, {\r\n\tpath: '/api/user/guided-tour', method: 'POST', callback: function(request, response, params) {\r\n\t\tconst body = request.body;\r\n\t\tconst id = uuid();\r\n\t\tconst user = Object.assign({ type: RoleType.Streamer }, body, { id });\r\n\t\trequest.session.user = null;\r\n\t\tdb.users.push(user);\r\n\t\tsaveStore();\r\n\t\tsendOk(response, user);\r\n\t}\r\n}, {\r\n\tpath: '/api/user/self-service-tour', method: 'POST', callback: function(request, response, params) {\r\n\t\tconst body = request.body;\r\n\t\tconst id = uuid();\r\n\t\tconst user = Object.assign({ type: RoleType.SelfService }, body, { id });\r\n\t\trequest.session.user = user;\r\n\t\tdb.users.push(user);\r\n\t\tsaveStore();\r\n\t\tsendOk(response, user);\r\n\t}\r\n}];\r\nROUTES.forEach(route => {\r\n\tconst segments = [];\r\n\tif (route.path === '**') {\r\n\t\tsegments.push(route.path);\r\n\t\troute.matcher = new RegExp('^.*$');\r\n\t} else {\r\n\t\tconst matchers = [`^`];\r\n\t\tconst regExp = /(^\\.\\.\\/|\\.\\/|\\/\\/|\\/)|([^:|\\/]+)\\/?|\\:([^\\/]+)\\/?/g;\r\n\t\tlet relative;\r\n\t\tlet match;\r\n\t\twhile ((match = regExp.exec(route.path)) !== null) {\r\n\t\t\tconst g1 = match[1];\r\n\t\t\tconst g2 = match[2];\r\n\t\t\tconst g3 = match[3];\r\n\t\t\tif (g1) {\r\n\t\t\t\trelative = !(g1 === '//' || g1 === '/');\r\n\t\t\t} else if (g2) {\r\n\t\t\t\tmatchers.push(`\\/(${g2})`);\r\n\t\t\t\tsegments.push({ name: g2, param: null, value: null });\r\n\t\t\t} else if (g3) {\r\n\t\t\t\tmatchers.push('\\/([^\\/]+)');\r\n\t\t\t\tconst params = {};\r\n\t\t\t\tparams[g3] = null;\r\n\t\t\t\troute.params = params;\r\n\t\t\t\tsegments.push({ name: '', param: g3, value: null });\r\n\t\t\t}\r\n\t\t}\r\n\t\t/*\r\n\t\tconst matches = route.path.matchAll(regExp);\r\n\t\tfor (let match of matches) {\r\n\t\t\tconst g1 = match[1];\r\n\t\t\tconst g2 = match[2];\r\n\t\t\tconst g3 = match[3];\r\n\t\t\tif (g1) {\r\n\t\t\t\trelative = !(g1 === '//' || g1 === '/');\r\n\t\t\t} else if (g2) {\r\n\t\t\t\tmatchers.push(`\\/(${g2})`);\r\n\t\t\t\tsegments.push({ name: g2, param: null, value: null });\r\n\t\t\t} else if (g3) {\r\n\t\t\t\tmatchers.push('\\/([^\\/]+)');\r\n\t\t\t\tconst params = {};\r\n\t\t\t\tparams[g3] = null;\r\n\t\t\t\troute.params = params;\r\n\t\t\t\tsegments.push({ name: '', param: g3, value: null });\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t\tmatchers.push('$');\r\n\t\tconst regexp = matchers.join('');\r\n\t\tconsole.log(regexp)\r\n\t\troute.matcher = new RegExp(regexp);\r\n\t}\r\n\troute.segments = segments;\r\n})\r\n\r\nfunction apiMiddleware(vars) {\r\n\tif (!vars.root) {\r\n\t\tthrow new Error('missing Vars.root!');\r\n\t}\r\n\tif (!vars.baseHref) {\r\n\t\tthrow new Error('missing Vars.baseHref!');\r\n\t}\r\n\treturn (request, response, next) => {\r\n\t\tconst url = request.baseUrl.replace(/\\\\/g, '/');\r\n\t\tconst params = {};\r\n\t\tconst method = ROUTES.find(route => {\r\n\t\t\tif (route.method.toLowerCase() === request.method.toLowerCase()) {\r\n\t\t\t\tconst match = url.match(route.matcher);\r\n\t\t\t\tif (match) {\r\n\t\t\t\t\troute.segments.forEach((x, i) => {\r\n\t\t\t\t\t\tif (x.param) {\r\n\t\t\t\t\t\t\tlet value = match[i + 1];\r\n\t\t\t\t\t\t\tif (parseInt(value).toString() === value) {\r\n\t\t\t\t\t\t\t\tvalue = parseInt(value);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tparams[x.param] = value;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('match', match, route);\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (method) {\r\n\t\t\tconsole.log('apiMiddleware.url', url, method.path, method.method, params);\r\n\t\t\tmethod.callback(request, response, params);\r\n\t\t} else {\r\n\t\t\tnext();\r\n\t\t}\r\n\t};\r\n};\r\n\r\nmodule.exports = {\r\n\tapiMiddleware: apiMiddleware,\r\n\tuseApi: useApi,\r\n\tuuid: uuid,\r\n};\r\n","const https = require('https');\r\nconst fs = require('fs');\r\nconst express = require('express');\r\nconst session = require('express-session');\r\nconst bodyParser = require('body-parser');\r\nconst path = require('path');\r\nconst { staticMiddleware } = require('./static/static.js');\r\nconst { apiMiddleware, useApi, uuid } = require('./api/api.js');\r\nconst multipart = require('connect-multiparty');\r\nconst multipartMiddleware = multipart({ uploadDir: path.join(__dirname, '../docs/temp/') });\r\n// const serveStatic = require('serve-static');\r\n// const { upload } = require('./upload/upload.js');\r\n// const uploader = upload(path.join(__dirname, '../docs/temp/'));\r\n// const { spaMiddleware } = require('./spa/spa.js');\r\n// const router = express.Router();\r\nconst BASE_HREF = '/b-here/';\r\nconst ASSETS = `assets/`;\r\nconst ROOT = `../docs/`;\r\nconst PORT = process.env.PORT || 5000;\r\nconst PORT_HTTPS = 6443;\r\n\r\nconst Vars = {\r\n\tport: PORT,\r\n\tportHttps: PORT_HTTPS,\r\n\thost: `http://localhost:${PORT}`,\r\n\thostHttps: `https://localhost:${PORT_HTTPS}`,\r\n\tcharset: 'utf8',\r\n\tassets: ASSETS,\r\n\tbaseHref: BASE_HREF,\r\n\tcacheMode: 'file',\r\n\tcache: path.join(__dirname, `../cache/`),\r\n\troot: ROOT,\r\n\ttemplate: path.join(__dirname, `${ROOT}index.html`),\r\n\taccessControlAllowOrigin: true,\r\n};\r\n\r\nconst staticMiddleware_ = staticMiddleware(Vars);\r\nconst apiMiddleware_ = apiMiddleware(Vars);\r\n\r\nconst app = express();\r\napp.use(session({\r\n\tsecret: 'b-here-secret-keyword',\r\n\tsaveUninitialized: true,\r\n\tresave: true\r\n}));\r\napp.disable('x-powered-by');\r\napp.use(bodyParser.urlencoded({ extended: true }));\r\napp.use(bodyParser.json());\r\napp.use(bodyParser.raw());\r\napp.use('*', staticMiddleware_);\r\napp.use('*', apiMiddleware_);\r\n\r\napp.post('/api/upload', multipartMiddleware, function(request, response) {\r\n\tif (Vars.accessControlAllowOrigin) {\r\n\t\tresponse.header('Access-Control-Allow-Origin', '*');\r\n\t}\r\n\tconsole.log(request.body, request.files);\r\n\tconst file = request.files.file;\r\n\tconst id = uuid();\r\n\tconst fileName = `${id}_${file.name}`;\r\n\tconst folder = `/uploads/`;\r\n\tconst input = file.path;\r\n\tconst output = path.join(__dirname, Vars.root, folder, fileName);\r\n\tconst upload = {\r\n\t\tid,\r\n\t\tfileName,\r\n\t\ttype: file.type,\r\n\t\toriginalFileName: file.name,\r\n\t\turl: `${folder}${fileName}`,\r\n\t};\r\n\tconst uploads = [upload];\r\n\tfs.copyFile(input, output, (error) => {\r\n\t\tfs.unlink(input, () => { });\r\n\t\tif (error) {\r\n\t\t\tthrow error;\r\n\t\t} else {\r\n\t\t\tresponse.status(200).send(JSON.stringify(uploads));\r\n\t\t}\r\n\t});\r\n});\r\napp.options('/api/upload', function(request, response) {\r\n\tconsole.log('OPTIONS');\r\n\tif (Vars.accessControlAllowOrigin) {\r\n\t\tresponse.header('Access-Control-Allow-Origin', '*');\r\n\t}\r\n\tresponse.status(200).send();\r\n});\r\n\r\napp.get('/', function(request, response) {\r\n\tresponse.sendFile(path.join(__dirname, '../docs/access.html'));\r\n});\r\napp.get('/self-service-tour', function(request, response) {\r\n\tresponse.sendFile(path.join(__dirname, '../docs/b-here.html'));\r\n});\r\napp.get('/guided-tour', function(request, response) {\r\n\tresponse.sendFile(path.join(__dirname, '../docs/b-here.html'));\r\n});\r\napp.get('/b-here', function(request, response) {\r\n\tresponse.sendFile(path.join(__dirname, '../docs/b-here.html'));\r\n});\r\napp.get('/editor', function(request, response) {\r\n\tresponse.sendFile(path.join(__dirname, '../docs/editor.html'));\r\n});\r\n\r\napp.listen(Vars.port, () => {\r\n\tconsole.log(`NodeJs Running server at ${Vars.host}`);\r\n});\r\n\r\nconst heroku = (process.env._ && process.env._.indexOf('heroku'));\r\nif (!heroku) {\r\n\tconst privateKey = fs.readFileSync('certs/server.key', 'utf8');\r\n\tconst certificate = fs.readFileSync('certs/server.crt', 'utf8');\r\n\tconst credentials = { key: privateKey, cert: certificate };\r\n\tconst serverHttps = https.createServer(credentials, app);\r\n\tserverHttps.listen(Vars.portHttps, () => {\r\n\t\tconsole.log(`NodeJs Running server at ${Vars.hostHttps}`);\r\n\t});\r\n}\r\n"],"names":["MIME_CONTENT_TYPES","MIME_TEXT","MIME_IMAGE","MIME_FONTS","MIME_AUDIO","MIME_VIDEO","MIME_APPLICATION","MIME_TYPES","staticMiddleware","vars","root","Error","baseHref","request","response","next","url","unescape","baseUrl","replace","substr","length","regExpText","join","regExp","RegExp","matches","exec","extension","file","path","filePath","__dirname","fs","readFile","error","data","console","log","set","send","mimeContentTypes","mimeText","mimeImage","mimeFonts","mimeAudio","mimeVideo","mimeApplication","RoleType","Publisher","Attendee","Streamer","Viewer","SelfService","db","views","assets","users","id","username","password","type","firstName","lastName","pathname","readStore","uuid","parseInt","process","hrtime","bigint","toString","useApi","Object","assign","JSON","parse","saveStore","stringify","writeFile","sendError","status","message","sendOk","doCreate","params","items","body","item","forEach","x","tiles","navs","push","doUpdate","find","doDelete","index","reduce","p","i","splice","doGet","ROUTES","method","callback","view","viewId","viewItemId","tile","tileId","assetId","user","session","route","segments","matcher","matchers","match","g1","g2","g3","name","param","value","regexp","apiMiddleware","toLowerCase","require$$0","require$$1","multipartMiddleware","multipart","uploadDir","BASE_HREF","ASSETS","ROOT","PORT","env","PORT_HTTPS","Vars","port","portHttps","host","hostHttps","charset","cacheMode","cache","template","accessControlAllowOrigin","staticMiddleware_","apiMiddleware_","app","express","use","secret","saveUninitialized","resave","disable","bodyParser","urlencoded","extended","json","raw","post","header","files","fileName","folder","input","output","upload","originalFileName","uploads","copyFile","unlink","options","get","sendFile","listen","heroku","_","indexOf","privateKey","readFileSync","certificate","credentials","key","cert","serverHttps","https","createServer"],"mappings":"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"}